<div id="PAC_More_Poly">
<div class="head">
<h1>Theory PAC_More_Poly</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:         PAC_More_Poly.thy
  Author:       Mathias Fleury, Daniela Kaufmann, JKU
  Maintainer:   Mathias Fleury, JKU
*)</span>
<span class="keyword1"><span class="command">theory</span></span> PAC_More_Poly
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Poly_Mapping.html">HOL-Library.Poly_Mapping</a>"</span> <span class="quoted">"<a href="../../HOL/HOL-Algebra/Polynomials.html">HOL-Algebra.Polynomials</a>"</span> <span class="quoted">"<a href="../Polynomials/MPoly_Type_Class.html">Polynomials.MPoly_Type_Class</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Algebra/Module.html">HOL-Algebra.Module</a>"</span> <span class="quoted">"<a href="../../HOL/HOL-Library/Countable_Set.html">HOL-Library.Countable_Set</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚ÄπOverview‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ

One solution to check circuit of multipliers is to use algebraic method, like producing proofs on
polynomials.  We are here interested in checking PAC proofs on the Boolean ring. The idea is the
following: each variable represents an input or the output of a gate and we want to prove the
bitwise multiplication of the input bits yields the output, namely the bitwise representation of the
multiplication of the input (modulo <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">(</span></span><span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">::</span></span>nat<span class="main"><span class="main">)</span></span><span class="main"><span class="main">^</span></span><span class="free"><span class="free">n</span></span>‚Ä∫</span></span></span></span> where <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">n</span></span><span class="main"><span class="main">::</span></span>nat‚Ä∫</span></span></span></span> is the number of bits of the
circuit).

Algebraic proof systems typically reason over polynomials in a ring $\set K[X]$,
where the variables $X$ represent Boolean values.
The aim of an algebraic proof is to derive whether a polynomial $f$ can be derived from a given set of polynomials
$G = \{g_1,\dots,g_l\} \subseteq \set K[X]$ together with the Boolean value constraints
$B(X) = \{x^2_i-x_i \mid x_i \in X\}$. In algebraic terms this means to show that the polynomial <span class="hidden">\&lt;^</span><span class="control">latex</span><span class="hidden">&gt;</span>‚Äπ\(f \in \langle G \cup B(X)\rangle\)‚Ä∫.

In our setting we set $\set K = \set Z$ and we treat the Boolean value constraints implicitly, i.e.,
we consider proofs in the ring <span class="hidden">\&lt;^</span><span class="control">latex</span><span class="hidden">&gt;</span>‚Äπ\(\set Z[X]/\langle B(X)\rangle\)‚Ä∫ to admit shorter proofs



The checker takes as input 3 files:
  <span class="antiquoted"><span class="antiquoted">‚ñ∏</span></span> an input file containing all polynomials that are initially present;
  <span class="antiquoted"><span class="antiquoted">‚ñ∏</span></span> a target (or specification) polynomial ;
  <span class="antiquoted"><span class="antiquoted">‚ñ∏</span></span> a ``proof'' file to check that contains the proof in PAC format that shows that the specification
  is in the ideal generated by the polynomials present initially.


Each step of the proof is either an addition of two polynomials previously derived, a multiplication
from a previously derived polynomial and an arbitrary polynomial, and the deletion a derived
polynomial.

One restriction on the proofs compared to generic PAC proofs is that <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">(</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">::</span></span>nat<span class="main"><span class="main">)</span></span><span class="main"><span class="main">^</span></span><span class="numeral"><span class="numeral">2</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">x</span></span>‚Ä∫</span></span></span></span> in the
Boolean ring we are considering.

The checker can produce two outputs: valid (meaning that each derived polynomial in the proof has
been correctly derived and the specification polynomial was also derived at some point [either in
the proof or as input]) or invalid (without proven information what went wrong).


The development is organised as follows:
  <span class="antiquoted"><span class="antiquoted">‚ñ™</span></span> <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">üóè</span></span>‚ÄπPAC_Specification.thy‚Ä∫</span></span> (this file) contains the specification as described above on ideals
  without any peculiarities on the PAC proof format
  <span class="antiquoted"><span class="antiquoted">‚ñ™</span></span> <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">üóè</span></span>‚ÄπPAC_Checker_Specification.thy‚Ä∫</span></span> specialises to the PAC format and enters the nondeterminism
  monad to prepare the subsequent refinements.
  <span class="antiquoted"><span class="antiquoted">‚ñ™</span></span> <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">üóè</span></span>‚ÄπPAC_Checker.thy‚Ä∫</span></span> contains the refined version where polynomials are represented as lists.
  <span class="antiquoted"><span class="antiquoted">‚ñ™</span></span> <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">üóè</span></span>‚ÄπPAC_Checker_Synthesis.thy‚Ä∫</span></span> contains the efficient implementation with imperative data
  structure like a hash set.
  <span class="antiquoted"><span class="antiquoted">‚ñ™</span></span> <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">üóè</span></span>‚ÄπPAC_Checker_MLton.thy‚Ä∫</span></span> contains the code generation and the command to compile the file with
  the ML compiler MLton.


Here is an example of a proof and an input file (taken from the appendix of our FMCAD
paper~\cite{KaufmannFleuryBiere-FMCAD20}, available at <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">üåê</span></span>‚Äπhttp://fmv.jku.at/pacheck_pasteque‚Ä∫</span></span>):
<span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">‚ñ©</span></span><span class="raw_text"><span class="raw_text">‚Äπ
&lt;res.input&gt;      &lt;res.proof&gt;
 1 x*y;           3  = fz, -z+1;
 2 y*z-y-z+1;     4  *  3,  y-1, -fz*y+fz-y*z+y+z-1;
                  5  +  2,    4, -fz*y+fz;
                  2  d;
                  4  d;
&lt;res.target&gt;      6  *  1,   fz, fz*x*y;
 -x*z+x;          1  d;
                  7  *  5,    x, -fz*x*y+fz*x;
                  8  +  6,    7, fz*x;
                  9  *  3,    x, -fz*x-x*z+x;
                 10  +  8,    9, -x*z+x;
‚Ä∫</span></span></span></span>

Each line starts with a number that is used to index the (conclusion) polynomial. In the proof,
there are four kind of steps:
  <span class="antiquoted"><span class="antiquoted">‚ñ∏</span></span> <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">‚ñ©</span></span><span class="raw_text"><span class="raw_text">‚Äπ3 = fz, -z+1;‚Ä∫</span></span></span></span> is an extension that introduces a new variable (in this case <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">‚ñ©</span></span><span class="raw_text"><span class="raw_text">‚Äπfz‚Ä∫</span></span></span></span>);
  <span class="antiquoted"><span class="antiquoted">‚ñ∏</span></span> <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">‚ñ©</span></span><span class="raw_text"><span class="raw_text">‚Äπ4  *  3,  y-1, -fz*y+fz-y*z+y+z-1;‚Ä∫</span></span></span></span> is a multiplication of the existing polynomial with
  index 3 by the arbitrary polynomial <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">‚ñ©</span></span><span class="raw_text"><span class="raw_text">‚Äπy-1‚Ä∫</span></span></span></span> and generates the new polynomial
  <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">‚ñ©</span></span><span class="raw_text"><span class="raw_text">‚Äπ-fz*y+fz-y*z+y+z-1‚Ä∫</span></span></span></span> with index 4;
  <span class="antiquoted"><span class="antiquoted">‚ñ∏</span></span> <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">‚ñ©</span></span><span class="raw_text"><span class="raw_text">‚Äπ5  +  2,    4, -fz*y+fz;‚Ä∫</span></span></span></span> is an addition of the existing polynomials with
  index 2 and 4 and generates the new polynomial <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">‚ñ©</span></span><span class="raw_text"><span class="raw_text">‚Äπ-fz*y+fz‚Ä∫</span></span></span></span> with index 5;
  <span class="antiquoted"><span class="antiquoted">‚ñ∏</span></span> <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">‚ñ©</span></span><span class="raw_text"><span class="raw_text">‚Äπ1  d;‚Ä∫</span></span></span></span> deletes the polynomial with index 1 and it cannot be reused in subsequent steps.



Remark that unlike DRAT checker, we do forward checking and check every derived polynomial. The
target polynomial can also be part of the input file.
‚Ä∫</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚ÄπLibraries‚Ä∫</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπMore Polynomials‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ

  Here are more theorems on polynomials. Most of these facts are
  extremely trivial and should probably be generalised and moved to
  the Isabelle distribution.
‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Const<span class="hidden">‚á©</span><sub>0</sub>_add<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπConst<span class="hidden">‚á©</span><sub>0</sub> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> Const<span class="hidden">‚á©</span><sub>0</sub> <span class="free">a</span> <span class="main">+</span> Const<span class="hidden">‚á©</span><sub>0</sub> <span class="free">b</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span>
   <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Const<span class="hidden">‚á©</span><sub>0</sub>_def single_add<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Const_mult<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπConst <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> Const <span class="free">a</span> <span class="main">*</span> Const <span class="free">b</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Const<span class="hidden">‚á©</span><sub>0</sub>_def times_monomial_monomial<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Const<span class="hidden">‚á©</span><sub>0</sub>_mult<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπConst<span class="hidden">‚á©</span><sub>0</sub> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> Const<span class="hidden">‚á©</span><sub>0</sub> <span class="free">a</span> <span class="main">*</span> Const<span class="hidden">‚á©</span><sub>0</sub> <span class="free">b</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Const<span class="hidden">‚á©</span><sub>0</sub>_def times_monomial_monomial<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Const0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπConst <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Const<span class="hidden">‚á©</span><sub>0</sub>_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> Const_uminus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπConst <span class="main">(</span><span class="main">-</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> Const <span class="free">n</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Const<span class="hidden">‚á©</span><sub>0</sub>_def monomial_uminus<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚ÄπConst<span class="hidden">‚á©</span><sub>0</sub> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚ÄπMPoly <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Const<span class="hidden">‚á©</span><sub>0</sub>_def zero_mpoly_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Const_add<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπConst <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> Const <span class="free">a</span> <span class="main">+</span> Const <span class="free">b</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Const<span class="hidden">‚á©</span><sub>0</sub>_def single_add<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> mpoly <span class="main">::</span> <span class="main">(</span><span class="quoted">comm_semiring_1</span><span class="main">)</span> <span class="quoted">comm_semiring_1</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>

<span class="keyword1"><span class="command">lemma</span></span> degree_uminus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπdegree <span class="main">(</span><span class="main">-</span><span class="free">A</span><span class="main">)</span> <span class="free">x'</span> <span class="main">=</span> degree <span class="free">A</span> <span class="free">x'</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degree_def uminus_mpoly.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> degree_sum_notin<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="free">B</span> <span class="main">‚üπ</span> degree <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="free">x'</span> <span class="main">=</span> degree <span class="free">A</span> <span class="free">x'</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degree_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">Max</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> plus_mpoly.rep_eq UN_I UnE image_iff in_keys_iff subsetD vars_def lookup_add
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> keys_add <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> in_keys_plusI1 <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> ball_cong_simp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> degree_notin_vars<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">x</span> <span class="main">‚àâ</span> <span class="main">(</span>vars <span class="free">B</span><span class="main">)</span> <span class="main">‚üπ</span> degree <span class="main">(</span><span class="free">B</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>monoid_add<span class="main">}</span> mpoly<span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> degree_sum_notin<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> not_in_vars_coeff0<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">x</span> <span class="main">‚àâ</span> vars <span class="free">p</span> <span class="main">‚üπ</span> MPoly_Type.coeff <span class="free">p</span> <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> not_not<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> coeff_keys<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> keys_add'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">‚àà</span> keys <span class="main">(</span><span class="free">f</span> <span class="main">+</span> <span class="free">g</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">p</span> <span class="main">‚àà</span> keys <span class="free">f</span> <span class="main">‚à™</span> keys <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> keys_mapping_sum_add<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπfinite <span class="free">A</span> <span class="main">‚üπ</span> keys <span class="main">(</span>mapping_of <span class="main">(</span><span class="main">‚àë</span><span class="bound">v</span> <span class="main">‚àà</span> <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="main">‚ãÉ</span><span class="main">(</span>keys <span class="main">`</span> mapping_of <span class="main">`</span> <span class="free">f</span> <span class="main">`</span> UNIV<span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_mpoly.rep_eq plus_mpoly.rep_eq
     keys_plus_ninv_comm_monoid_add <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> keys_add'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_sum_vars_union<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint mpoly <span class="main">‚áí</span> int mpoly‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπfinite <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">‚â†</span> <span class="main">0</span><span class="main">}</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπvars <span class="main">(</span><span class="main">‚àë</span><span class="bound"><span class="bound">v</span></span> <span class="main">|</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">‚â†</span> <span class="main">0</span><span class="main">.</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">*</span> <span class="bound">v</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="main">‚ãÉ</span><span class="main">(</span>vars <span class="main">`</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">‚â†</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">‚à™</span> <span class="main">‚ãÉ</span><span class="main">(</span>vars <span class="main">`</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">‚â†</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?A</span> <span class="main">‚äÜ</span> <span class="var">?B</span>‚Ä∫</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">p</span> <span class="main">‚àà</span> vars <span class="main">(</span><span class="main">‚àë</span><span class="bound"><span class="bound">v</span></span> <span class="main">|</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">‚â†</span> <span class="main">0</span><span class="main">.</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">*</span> <span class="bound">v</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x</span> <span class="main">‚àà</span> keys <span class="main">(</span>mapping_of <span class="main">(</span><span class="main">‚àë</span><span class="bound"><span class="bound">v</span></span> <span class="main">|</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">‚â†</span> <span class="main">0</span><span class="main">.</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">*</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    p<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">p</span> <span class="main">‚àà</span> keys <span class="skolem">x</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_def times_mpoly.rep_eq <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> keys_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x</span> <span class="main">‚àà</span> <span class="main">(</span><span class="main">‚ãÉ</span><span class="bound">x</span><span class="main">.</span> keys <span class="main">(</span>mapping_of <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> mapping_of <span class="bound">x</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> keys_mapping_sum_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">‚â†</span> <span class="main">0</span><span class="main">}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span>‚Ä∫</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_def times_mpoly.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x</span> <span class="main">‚àà</span> <span class="main">(</span><span class="main">‚ãÉ</span><span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="bound">a</span><span class="main">+</span><span class="bound">b</span><span class="main">|</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">‚àà</span> keys <span class="main">(</span>mapping_of <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àß</span> <span class="bound">b</span> <span class="main">‚àà</span> keys <span class="main">(</span>mapping_of <span class="bound">x</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> Union_mono<span class="main">[</span><span class="operator">OF</span> <span class="main">]</span> keys_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">p</span> <span class="main">‚àà</span> <span class="var">?B</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_def zero_mpoly.rep_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> keys_add'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> vars_in_right_only<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àà</span> vars <span class="free">q</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àâ</span> vars <span class="free">p</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àà</span> vars <span class="main">(</span><span class="free">p</span><span class="main">+</span><span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span>  vars_def keys_def plus_mpoly.rep_eq lookup_plus_fun
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> xa
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_def keys_def plus_mpoly.rep_eq
      lookup_plus_fun <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">xa</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">xa</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπvars <span class="main">0</span> <span class="main">=</span> <span class="main">{}</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vars_def zero_mpoly.rep_eq<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> vars_Un_nointer<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπkeys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span> <span class="main">‚à©</span>  keys <span class="main">(</span>mapping_of <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> vars <span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> vars <span class="free">p</span> <span class="main">‚à™</span> vars <span class="free">q</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_def plus_mpoly.rep_eq <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> More_MPoly_Type.keys_add <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> keys_add'<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> zero_mpoly.rep_eq

<span class="keyword1"><span class="command">lemma</span></span> polynomial_sum_monoms<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>comm_monoid_add<span class="main">,</span>cancel_comm_monoid_add<span class="main">}</span> mpoly‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
     <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">x</span><span class="main">‚àà</span>keys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span><span class="main">.</span> MPoly_Type.monom <span class="bound">x</span> <span class="main">(</span>MPoly_Type.coeff <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
     <span class="quoted"><span class="quoted">‚Äπkeys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="free">I</span> <span class="main">‚üπ</span> finite <span class="free">I</span> <span class="main">‚üπ</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">x</span><span class="main">‚àà</span><span class="free">I</span><span class="main">.</span> MPoly_Type.monom <span class="bound">x</span> <span class="main">(</span>MPoly_Type.coeff <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">J</span> <span class="main">‚â°</span> keys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">a</span> <span class="skolem">x</span> <span class="main">‚â°</span> coeff <span class="free">p</span> <span class="skolem">x</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπfinite <span class="main">(</span>keys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">x</span><span class="main">‚àà</span><span class="skolem">I</span><span class="main">.</span> MPoly_Type.monom <span class="bound">x</span> <span class="main">(</span>MPoly_Type.coeff <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‚Äπfinite <span class="skolem">I</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπkeys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="skolem">I</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">I</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">unfolding</span></span> a_def
   <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">I</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> empty
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">p</span> <span class="main">=</span> <span class="main">0</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">using</span></span> empty coeff_all_0 coeff_keys <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> empty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_mpoly.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> fin <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> xF <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> IH <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
        incl <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">p</span> <span class="main">-</span> MPoly_Type.monom <span class="skolem">x</span> <span class="main">(</span>MPoly_Type.coeff <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">xa</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">‚àâ</span> <span class="skolem">F</span> <span class="main">‚üπ</span> <span class="bound">xa</span> <span class="main">‚àà</span> <span class="skolem">F</span> <span class="main">‚üπ</span>
        MPoly_Type.monom <span class="bound">xa</span> <span class="main">(</span>MPoly_Type.coeff <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> MPoly_Type.monom <span class="skolem">x</span> <span class="main">(</span>MPoly_Type.coeff <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">=</span>
         MPoly_Type.monom <span class="bound">xa</span> <span class="main">(</span>MPoly_Type.coeff <span class="skolem">p</span> <span class="bound">xa</span><span class="main">)</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> add_diff_cancel_right' remove_term_coeff
          remove_term_sum when_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?p</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">xa</span><span class="main">‚àà</span><span class="skolem">F</span><span class="main">.</span> MPoly_Type.monom <span class="bound">xa</span> <span class="main">(</span>MPoly_Type.coeff <span class="var">?p</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> IH<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> incl <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">smt</span> Diff_iff Diff_insert_absorb add_diff_cancel_right'
          remove_term_keys remove_term_sum subsetD xF<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">xa</span><span class="main">‚àà</span><span class="skolem">F</span><span class="main">.</span> MPoly_Type.monom <span class="bound">xa</span> <span class="main">(</span>MPoly_Type.coeff <span class="skolem">p</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">use</span> xF <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‚Äπ<span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main">!</span><span class="main">:</span> sum.cong <span class="quasi_keyword">simp</span><span class="main">:</span> H‚Ä∫</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> remove_term_sum<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> remove_term_sum<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> xF fin <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">J</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span>
     <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">x</span><span class="main">‚àà</span>keys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span><span class="main">.</span> MPoly_Type.monom <span class="bound">x</span> <span class="main">(</span>MPoly_Type.coeff <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
     <span class="quoted"><span class="quoted">‚Äπkeys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="free">I</span> <span class="main">‚üπ</span> finite <span class="free">I</span> <span class="main">‚üπ</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">x</span><span class="main">‚àà</span><span class="free">I</span><span class="main">.</span> MPoly_Type.monom <span class="bound">x</span> <span class="main">(</span>MPoly_Type.coeff <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> J_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> vars_mult_monom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint mpoly‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπvars <span class="main">(</span><span class="free">p</span> <span class="main">*</span> <span class="main">(</span>monom <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> insert <span class="free">x'</span> <span class="main">(</span>vars <span class="free">p</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‚Äπmonom <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">1</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span>
    p<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">x</span><span class="main">‚àà</span>keys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span><span class="main">.</span> MPoly_Type.monom <span class="bound">x</span> <span class="main">(</span>MPoly_Type.coeff <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">x</span> <span class="main">‚àà</span> <span class="var">?I</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> polynomial_sum_monoms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> pv<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">*</span> <span class="var">?v</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">x</span> <span class="main">‚àà</span> <span class="var">?I</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span> <span class="main">*</span> <span class="var">?v</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> p<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>  <span class="dynamic"><span class="dynamic">field_simps</span></span> sum_distrib_left<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">I</span> <span class="main">‚â°</span> <span class="var">?I</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span> in_keysD<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x</span> <span class="main">‚àà</span> keys <span class="main">(</span>mapping_of <span class="main">(</span><span class="main">‚àë</span><span class="bound">x</span><span class="main">‚àà</span><span class="skolem">I</span><span class="main">.</span> MPoly_Type.monom <span class="bound">x</span> <span class="main">(</span><span class="skolem">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>  <span class="main">‚üπ</span> <span class="skolem">x</span> <span class="main">‚àà</span> <span class="skolem">I</span>‚Ä∫</span></span>
   <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‚Äπfinite <span class="skolem">I</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">I</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">‚áí</span> int‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span>
   <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> monom.rep_eq empty_iff insert_iff keys_single coeff_monom
     <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_keys <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> coeff_add
     <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> coeff_add<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> in_keys<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπkeys <span class="main">(</span>mapping_of <span class="main">(</span><span class="main">‚àë</span><span class="bound">x</span><span class="main">‚àà</span><span class="skolem">I</span><span class="main">.</span> MPoly_Type.monom <span class="bound">x</span> <span class="main">(</span><span class="skolem">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚ãÉ</span><span class="bound">x</span> <span class="main">‚àà</span> <span class="skolem">I</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">h</span> <span class="bound">x</span>  <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
   <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‚Äπfinite <span class="skolem">I</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">I</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">‚áí</span> int‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> in_keysD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span>
   <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> plus_mpoly.rep_eq MPoly_Type_Class.keys_plus_eqI<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> H<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπvars <span class="main">(</span><span class="main">(</span><span class="main">‚àë</span><span class="bound">x</span><span class="main">‚àà</span><span class="skolem">I</span><span class="main">.</span> MPoly_Type.monom <span class="bound">x</span> <span class="main">(</span><span class="skolem">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚ãÉ</span><span class="bound">x</span><span class="main">‚àà</span><span class="skolem">I</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">h</span> <span class="bound">x</span>  <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> keys <span class="bound">x</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
   <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‚Äπfinite <span class="skolem">I</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">I</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">‚áí</span> int‚Ä∫</span></span>
   <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_def in_keys<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> sums<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚àë</span><span class="bound">x</span><span class="main">‚àà</span><span class="skolem">I</span><span class="main">.</span>
        MPoly_Type.monom <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="skolem">a'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       <span class="main">(</span><span class="main">‚àë</span><span class="bound">x</span><span class="main">‚àà</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="skolem">a'</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">I</span><span class="main">.</span>
        MPoly_Type.monom <span class="bound">x</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="skolem">a'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‚Äπfinite <span class="skolem">I</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">I</span> <span class="skolem">a'</span> <span class="skolem">c</span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> image_insert <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.insert<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> non_zero_keysEx<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">p</span> <span class="main">‚â†</span> <span class="main">0</span> <span class="main">‚üπ</span> <span class="main">‚àÉ</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">‚àà</span> keys <span class="main">(</span>mapping_of <span class="skolem">p</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint mpoly‚Ä∫</span></span>
     <span class="keyword1"><span class="command">using</span></span> mapping_of_inject <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ex_in_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπfinite <span class="skolem">I</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπkeys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="skolem">I</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">‚Äπvars <span class="main">(</span><span class="free">p</span> <span class="main">*</span> <span class="main">(</span>monom <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> insert <span class="free">x'</span> <span class="main">(</span>vars <span class="free">p</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> pv<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> I_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> mult_monom<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult_monom sums I_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Poly_Mapping.keys_add vars_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> non_zero_keysEx<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="improper">a</span> <span class="main">+</span> monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_keys<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_keys_iff lookup_add<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="improper">xa</span> <span class="main">+</span> monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_keys<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_keys_iff lookup_add<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">x'</span><span class="main">,</span> <span class="free">u</span><span class="main">,</span> lookup <span class="free">u</span> <span class="free">x'</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> in_mapping_mult_single<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">x</span> <span class="main">‚àà</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> lookup <span class="bound">x</span> <span class="free">x'</span><span class="main">)</span> <span class="main">`</span> keys <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="main">(</span>Var<span class="hidden">‚á©</span><sub>0</sub> <span class="free">x'</span> <span class="main">::</span> <span class="main">(</span>nat <span class="main">‚áí<span class="hidden">‚á©</span><sub>0</sub></span> nat<span class="main">)</span> <span class="main">‚áí<span class="hidden">‚á©</span><sub>0</sub></span> <span class="tfree">'b</span> <span class="main">::</span> <span class="main">{</span>monoid_mult<span class="main">,</span>zero_neq_one<span class="main">,</span>semiring_0<span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">‚ü∑</span>
  <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">‚àß</span> <span class="free">x</span> <span class="main">-</span> <span class="main">1</span> <span class="main">‚àà</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> lookup <span class="bound">x</span> <span class="free">x'</span><span class="main">)</span> <span class="main">`</span> keys <span class="main">(</span><span class="free">A</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_keys_timesE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lookup_add<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> keys_def lookup_times_monomial_right Var<span class="hidden">‚á©</span><sub>0</sub>_def lookup_single image_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_keys_timesE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lookup_add<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> keys_def lookup_times_monomial_right Var<span class="hidden">‚á©</span><sub>0</sub>_def lookup_single image_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span>  xa
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_keys_timesE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lookup_add<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> keys_def lookup_times_monomial_right Var<span class="hidden">‚á©</span><sub>0</sub>_def lookup_single image_iff lookup_add
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">xa</span> <span class="main">+</span> Poly_Mapping.single <span class="free">x'</span> <span class="main">1</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Max_Suc_Suc_Max<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπfinite <span class="free">A</span> <span class="main">‚üπ</span> <span class="free">A</span> <span class="main">‚â†</span> <span class="main">{}</span> <span class="main">‚üπ</span> Max <span class="main">(</span>insert <span class="main">0</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    Suc <span class="main">(</span>Max <span class="main">(</span>insert <span class="main">0</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hom_Max_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπkeys <span class="main">(</span>Var<span class="hidden">‚á©</span><sub>0</sub> <span class="free">x'</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí<span class="hidden">‚á©</span><sub>0</sub></span> nat<span class="main">)</span> <span class="main">‚áí<span class="hidden">‚á©</span><sub>0</sub></span> <span class="tfree">'b</span> <span class="main">::</span> <span class="main">{</span>zero_neq_one<span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Poly_Mapping.single <span class="free">x'</span> <span class="main">1</span><span class="main">}</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Var<span class="hidden">‚á©</span><sub>0</sub>_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> degree_mult_Var<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπdegree <span class="main">(</span><span class="free">A</span> <span class="main">*</span> Var <span class="free">x'</span><span class="main">)</span> <span class="free">x'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">A</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="main">(</span>degree <span class="free">A</span> <span class="free">x'</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint mpoly‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">A</span> <span class="main">‚â†</span> <span class="main">0</span> <span class="main">‚üπ</span>
    Max <span class="main">(</span>insert <span class="main">0</span> <span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> Suc <span class="main">(</span>lookup <span class="bound">x</span> <span class="free">x'</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> keys <span class="main">(</span>mapping_of <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    Max <span class="main">(</span>insert <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> Suc <span class="main">(</span>lookup <span class="bound">x</span> <span class="free">x'</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> keys <span class="main">(</span>mapping_of <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> image_image<span class="main">[</span><span class="operator">of</span> <span class="quoted">Suc</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> lookup <span class="bound">x</span> <span class="free">x'</span>‚Ä∫</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> image_insert<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Max_Suc_Suc_Max<span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> mapping_of_inject <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> mapping_of_inject <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Max.hom_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">A</span> <span class="main">‚â†</span> <span class="main">0</span> <span class="main">‚üπ</span>
    Max <span class="main">(</span>insert <span class="main">0</span>
    <span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> lookup <span class="bound">x</span> <span class="free">x'</span><span class="main">)</span> <span class="main">`</span>
    keys <span class="main">(</span>mapping_of <span class="free">A</span> <span class="main">*</span> mapping_of <span class="main">(</span>Var <span class="free">x'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    Suc <span class="main">(</span>Max <span class="main">(</span>insert <span class="main">0</span> <span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="bound">m</span><span class="main">.</span> lookup <span class="bound">m</span> <span class="free">x'</span><span class="main">)</span> <span class="main">`</span> keys <span class="main">(</span>mapping_of <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‚Äπinsert <span class="main"><span class="main"><span class="main">0</span></span></span>
      <span class="main"><span class="main"><span class="main">(</span></span></span>Suc <span class="main"><span class="main"><span class="main">`</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">Œª</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> lookup <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="free"><span class="free"><span class="free">x'</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">`</span></span></span> keys <span class="main"><span class="main"><span class="main">(</span></span></span>mapping_of <span class="free"><span class="free"><span class="free">A</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>‚Ä∫</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">Max</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_image Var.rep_eq lookup_plus_fun in_mapping_mult_single
      hom_Max_commute Max_Suc_Suc_Max
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_keys_timesE  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degree_def times_mpoly.rep_eq
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπinsert <span class="main">0</span>
      <span class="main">(</span>Suc <span class="main">`</span> <span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> lookup <span class="bound">x</span> <span class="free">x'</span><span class="main">)</span> <span class="main">`</span> keys <span class="main">(</span>mapping_of <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> <span class="quoted">Max</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> degree_mult_Var'<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπdegree <span class="main">(</span>Var <span class="free">x'</span> <span class="main">*</span> <span class="free">A</span><span class="main">)</span> <span class="free">x'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">A</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="main">(</span>degree <span class="free">A</span> <span class="free">x'</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint mpoly‚Ä∫</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> degree_mult_Var semiring_normalization_rules<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> degree_times_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπdegree <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="free">x</span> <span class="main">‚â§</span> degree <span class="free">A</span> <span class="free">x</span> <span class="main">+</span> degree <span class="free">B</span> <span class="free">x</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degree_def times_mpoly.rep_eq
       max_def lookup_add add_mono
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_rev_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Poly_Mapping.keys_add<span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_keys_timesE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> monomial_inj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"monomial <span class="free">c</span> <span class="free">s</span> <span class="main">=</span> monomial <span class="main">(</span><span class="free">d</span><span class="main">::</span><span class="tfree">'b</span><span class="main">::</span>zero_neq_one<span class="main">)</span> <span class="free">t</span> <span class="main">‚ü∑</span> <span class="main">(</span><span class="free">c</span> <span class="main">=</span> <span class="main">0</span> <span class="main">‚àß</span> <span class="free">d</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">‚à®</span> <span class="main">(</span><span class="free">c</span> <span class="main">=</span> <span class="free">d</span> <span class="main">‚àß</span> <span class="free">s</span> <span class="main">=</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monomial_inj Poly_Mapping.single_def
    poly_mapping.Abs_poly_mapping_inject when_def fun_eq_iff
    <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong
    <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> MPoly_monomial_power'<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπMPoly <span class="main">(</span>monomial <span class="main">1</span> <span class="free">x'</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span>  MPoly <span class="main">(</span>monomial <span class="main">(</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">x'</span><span class="main">)</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> times_mpoly.abs_eq mult_single <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> MPoly_monomial_power<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">‚üπ</span> MPoly <span class="main">(</span>monomial <span class="main">1</span> <span class="free">x'</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span>  MPoly <span class="main">(</span>monomial <span class="main">(</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">x'</span><span class="main">)</span> <span class="main">^^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> MPoly_monomial_power'<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">n</span><span class="main">-</span><span class="main">1</span>‚Ä∫</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> vars_uminus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπvars <span class="main">(</span><span class="main">-</span><span class="free">p</span><span class="main">)</span> <span class="main">=</span> vars <span class="free">p</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_def uminus_mpoly.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_uminus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπMPoly_Type.coeff <span class="main">(</span><span class="main">-</span><span class="free">p</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">-</span>MPoly_Type.coeff <span class="free">p</span> <span class="free">x</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_def uminus_mpoly.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">decrease_key</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí<span class="hidden">‚á©</span><sub>0</sub></span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>monoid_add<span class="main">,</span> minus<span class="main">,</span>one<span class="main">}</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí<span class="hidden">‚á©</span><sub>0</sub></span> <span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">decrease_key</span> <span class="free"><span class="bound"><span class="entity">k0</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Abs_poly_mapping <span class="main">(</span><span class="main">Œª</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k0</span></span></span> <span class="main">‚àß</span> lookup <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">k</span> <span class="main">‚â†</span> <span class="main">0</span> <span class="keyword1">then</span> lookup <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">k</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">else</span> lookup <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">k</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> remove_key_lookup<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>decrease_key <span class="free">k0</span> <span class="free">f</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">=</span> <span class="free">k0</span> <span class="main">‚àß</span> lookup <span class="free">f</span> <span class="free">k</span> <span class="main">‚â†</span> <span class="main">0</span> <span class="keyword1">then</span> lookup <span class="free">f</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">else</span> lookup <span class="free">f</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> decrease_key_def <span class="keyword1"><span class="command">using</span></span> finite_subset <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lookup_Abs_poly_mapping<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{</span><span class="bound">x</span><span class="main">.</span> lookup <span class="free">f</span> <span class="bound">x</span> <span class="main">‚â†</span> <span class="main">0</span><span class="main">}</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lookup_Abs_poly_mapping<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{</span><span class="bound">x</span><span class="main">.</span> lookup <span class="free">f</span> <span class="bound">x</span> <span class="main">‚â†</span> <span class="main">0</span><span class="main">}</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> polynomial_split_on_var<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>comm_monoid_add<span class="main">,</span>cancel_comm_monoid_add<span class="main">,</span>semiring_0<span class="main">,</span>comm_semiring_1<span class="main">}</span> mpoly‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">q</span> <span class="free">r</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">=</span> monom <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">1</span> <span class="main">*</span> <span class="free">q</span> <span class="main">+</span> <span class="free">r</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="free">r</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">‚àà</span> keys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span><span class="main">.</span> <span class="free">x'</span> <span class="main">‚àà</span> keys <span class="bound">x</span><span class="main">}</span> <span class="main">‚à™</span>
        <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">‚àà</span> keys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span><span class="main">.</span> <span class="free">x'</span> <span class="main">‚àâ</span> keys <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> keys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">x</span><span class="main">‚àà</span>keys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span><span class="main">.</span> MPoly_Type.monom <span class="bound">x</span> <span class="main">(</span>MPoly_Type.coeff <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">x</span> <span class="main">‚àà</span> <span class="var">?I</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> polynomial_sum_monoms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">x</span><span class="main">‚àà</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">‚àà</span> <span class="var">?I</span><span class="main">.</span> <span class="free">x'</span> <span class="main">‚àà</span> keys <span class="bound">x</span><span class="main">}</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">x</span><span class="main">‚àà</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">‚àà</span> <span class="var">?I</span><span class="main">.</span> <span class="free">x'</span> <span class="main">‚àâ</span> keys <span class="bound">x</span><span class="main">}</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">=</span> <span class="var">?pX</span> <span class="main">+</span> <span class="var">?qX</span>‚Ä∫</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> comm_monoid_add_class.sum.union_disjoint<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">=</span> <span class="var">?pX</span> <span class="main">+</span> <span class="var">?qX</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">0</span> <span class="main">&lt;</span> lookup <span class="skolem">x</span> <span class="skolem">x'</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x'</span> <span class="main">=</span> <span class="bound">k</span> <span class="keyword1">then</span> Suc <span class="main">0</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">+</span>
          <span class="main">(</span><span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">x'</span> <span class="main">‚àß</span> <span class="main">0</span> <span class="main">&lt;</span> lookup <span class="skolem">x</span> <span class="bound">k</span> <span class="keyword1">then</span> lookup <span class="skolem">x</span> <span class="bound">k</span> <span class="main">-</span> <span class="main">1</span>
           <span class="keyword1">else</span> lookup <span class="skolem">x</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lookup <span class="skolem">x</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">x'</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπfinite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span>Suc <span class="main">0</span> <span class="keyword1">when</span> <span class="skolem">x'</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x'</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> bounded_nat_set_is_finite lessI mem_Collect_eq neq0_conv when_cong when_neq_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x'</span> <span class="main">‚àà</span> keys <span class="skolem">x</span> <span class="main">‚üπ</span> monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="skolem">x'</span> <span class="main">+</span> Abs_poly_mapping <span class="main">(</span><span class="main">Œª</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">x'</span> <span class="main">‚àß</span> <span class="main">0</span> <span class="main">&lt;</span> lookup <span class="skolem">x</span> <span class="bound">k</span> <span class="keyword1">then</span> lookup <span class="skolem">x</span> <span class="bound">k</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">else</span> lookup <span class="skolem">x</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x'</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> keys_def single.abs_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> plus_poly_mapping.abs_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_onp_def when_def H
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{</span><span class="bound">xa</span><span class="main">.</span> <span class="main">(</span><span class="bound">xa</span> <span class="main">=</span> <span class="skolem">x'</span> <span class="main">‚àß</span> <span class="main">0</span> <span class="main">&lt;</span> lookup <span class="skolem">x</span> <span class="bound">xa</span> <span class="main">‚ü∂</span> Suc <span class="main">0</span> <span class="main">&lt;</span> lookup <span class="skolem">x</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">‚àß</span>
           <span class="main">(</span><span class="bound">xa</span> <span class="main">‚â†</span> <span class="skolem">x'</span> <span class="main">‚ü∂</span> <span class="main">0</span> <span class="main">&lt;</span> lookup <span class="skolem">x</span> <span class="bound">xa</span><span class="main">)</span><span class="main">}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{</span><span class="bound">xa</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> lookup <span class="skolem">x</span> <span class="bound">xa</span><span class="main">}</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x'</span> <span class="main">‚àà</span> keys <span class="skolem">x</span> <span class="main">‚üπ</span>
        MPoly_Type.monom <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="skolem">x'</span> <span class="main">+</span> decrease_key <span class="skolem">x'</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">=</span>
        MPoly_Type.monom <span class="skolem">x</span> <span class="skolem">n</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x'</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> mpoly.mapping_of_inject<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> poly_mapping.lookup_inject<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> mapping_of_monom lookup_single
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> decrease_key_def when_def H<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> pX<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?pX</span> <span class="main">=</span> monom <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">1</span> <span class="main">*</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">x</span><span class="main">‚àà</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">‚àà</span> <span class="var">?I</span><span class="main">.</span> <span class="free">x'</span> <span class="main">‚àà</span> keys <span class="bound">x</span><span class="main">}</span><span class="main">.</span> MPoly_Type.monom <span class="main">(</span>decrease_key <span class="free">x'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>MPoly_Type.coeff <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">*</span> <span class="var">?pX'</span>‚Ä∫</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_distrib_left<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> mult_monom<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="var">?qX</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> vars_setsum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà</span> keys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span> <span class="main">‚àß</span> <span class="free">x'</span> <span class="main">‚àâ</span> keys <span class="bound">x</span><span class="main">}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?f</span>‚Ä∫</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> vars_monom_subset<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> subset_eq Ball_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?pX'</span></span></span> <span class="var"><span class="quoted"><span class="var">?qX</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> pX<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 1<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> polynomial_split_on_var2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint mpoly‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="free">s</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">q</span> <span class="free">r</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">=</span> <span class="main">(</span>monom <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">1</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">*</span> <span class="free">q</span> <span class="main">+</span> <span class="free">r</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="free">r</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmonom <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">1</span> <span class="main">=</span> Var <span class="free">x'</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Var.abs_eq Var<span class="hidden">‚á©</span><sub>0</sub>_def monom.abs_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÄ</span><span class="bound"><span class="bound">m</span></span> <span class="main">‚â§</span> <span class="skolem">n</span><span class="main">.</span> <span class="main">‚àÄ</span><span class="bound">P</span><span class="main">::</span>int mpoly<span class="main">.</span> degree <span class="bound">P</span> <span class="free">x'</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">‚ü∂</span> <span class="main">(</span><span class="main">‚àÉ</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">P</span> <span class="main">=</span> <span class="main">(</span>Var <span class="free">x'</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">*</span> <span class="bound">A</span> <span class="main">+</span> <span class="bound">B</span> <span class="main">‚àß</span> <span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="bound">B</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">m</span><span class="main">‚â§</span><span class="skolem">n</span> <span class="main">‚üπ</span> MPoly_Type.degree <span class="skolem">P</span> <span class="free">x'</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="main">‚üπ</span>
              <span class="main">(</span><span class="main">‚àÉ</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="skolem">P</span> <span class="main">=</span> <span class="main">(</span>Var <span class="free">x'</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">*</span> <span class="bound">A</span> <span class="main">+</span> <span class="bound">B</span> <span class="main">‚àß</span> <span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="bound">B</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span> <span class="skolem">P</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
     <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint mpoly‚Ä∫</span></span>
     <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">m</span> <span class="main">‚â§</span> Suc <span class="skolem">n</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">‚ÄπMPoly_Type.degree <span class="skolem">P</span> <span class="free">x'</span> <span class="main">&lt;</span> <span class="skolem">m</span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command">consider</span></span>
       <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">m</span> <span class="main">‚â§</span> <span class="skolem">n</span>‚Ä∫</span></span> <span class="main">|</span>
       <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">m</span> <span class="main">=</span> Suc <span class="skolem">n</span>‚Ä∫</span></span>
       <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">m</span> <span class="main">‚â§</span> Suc <span class="skolem">n</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÉ</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="skolem">P</span> <span class="main">=</span> <span class="main">(</span>Var <span class="free">x'</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">*</span> <span class="bound">A</span> <span class="main">+</span> <span class="bound">B</span> <span class="main">‚àß</span> <span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="bound">B</span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
       <span class="keyword3"><span class="command">case</span></span> 1
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?thesis</span>‚Ä∫</span></span>
         <span class="keyword1"><span class="command">using</span></span> Suc deg <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">next</span></span>
       <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 2
       <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span>
         P<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">P</span> <span class="main">=</span> Var <span class="free">x'</span> <span class="main">*</span> <span class="skolem">A</span> <span class="main">+</span> <span class="skolem">B</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="skolem">B</span>‚Ä∫</span></span>
         <span class="keyword1"><span class="command">using</span></span> polynomial_split_on_var<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">P</span></span> <span class="quoted"><span class="free">x'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
       <span class="keyword1"><span class="command">have</span></span> P'<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">P</span> <span class="main">=</span> <span class="main">(</span>Var <span class="free">x'</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">A</span> <span class="main">+</span> <span class="main">(</span><span class="free">s</span> <span class="main">*</span> <span class="skolem">A</span> <span class="main">+</span> <span class="skolem">B</span><span class="main">)</span>‚Ä∫</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> P<span class="main">)</span>
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">A</span> <span class="main">=</span> <span class="main">0</span> <span class="main">‚à®</span> degree <span class="main">(</span><span class="free">s</span> <span class="main">*</span> <span class="skolem">A</span><span class="main">)</span> <span class="free">x'</span> <span class="main">&lt;</span> degree <span class="skolem">P</span> <span class="free">x'</span>‚Ä∫</span></span>
         <span class="keyword1"><span class="command">using</span></span> deg <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="skolem">B</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="free">s</span>‚Ä∫</span></span> degree_times_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="free">x'</span></span><span class="main">]</span> deg
         <span class="keyword1"><span class="command">unfolding</span></span> P
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degree_sum_notin degree_mult_Var' degree_mult_Var degree_notin_vars
           <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
         sA<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">s</span><span class="main">*</span><span class="skolem">A</span> <span class="main">=</span> <span class="main">(</span>Var <span class="free">x'</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">A'</span> <span class="main">+</span> <span class="skolem">B'</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="skolem">B'</span>‚Ä∫</span></span>
         <span class="keyword1"><span class="command">using</span></span> IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">m</span><span class="main">-</span><span class="main">1</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">s</span><span class="main">*</span><span class="skolem">A</span>‚Ä∫</span></span><span class="main">]</span> deg <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="skolem">B</span>‚Ä∫</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">n</span>‚Ä∫</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> vars_in_right_only<span class="main">)</span>
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">P</span> <span class="main">=</span> <span class="main">(</span>Var <span class="free">x'</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">+</span> <span class="skolem">A'</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">B'</span> <span class="main">+</span> <span class="skolem">B</span><span class="main">)</span>‚Ä∫</span></span>
         <span class="keyword1"><span class="command">unfolding</span></span> P' sA <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="main">(</span><span class="skolem">B'</span> <span class="main">+</span> <span class="skolem">B</span><span class="main">)</span>‚Ä∫</span></span>
         <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="skolem">B'</span>‚Ä∫</span></span>  <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="skolem">B</span>‚Ä∫</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> UnE subset_iff vars_add<span class="main">)</span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
     <span class="keyword1"><span class="command">qed</span></span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finit_whenI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπfinite  <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">y</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span> <span class="main">‚üπ</span> finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">y</span> <span class="bound">x</span> <span class="keyword1">when</span> <span class="bound">x</span> <span class="main">‚â†</span> <span class="free">x'</span><span class="main">)</span><span class="main">}</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> when_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> polynomial_split_on_var_diff_sq2<span class="main">:</span>
 <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint mpoly‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">q</span> <span class="free">r</span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">=</span> monom <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">1</span> <span class="main">*</span> <span class="free">q</span> <span class="main">+</span> <span class="free">r</span> <span class="main">+</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>monom <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">1</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> monom <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">1</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="free">r</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="free">q</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‚Äπmonom <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">1</span> <span class="main">::</span> int mpoly‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="main">‚üπ</span> <span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">‚üπ</span> <span class="main">‚àÉ</span><span class="bound">q</span><span class="main">.</span> <span class="var">?v</span><span class="main">^</span><span class="skolem">n</span> <span class="main">=</span> <span class="var">?v</span> <span class="main">+</span> <span class="bound">q</span> <span class="main">*</span> <span class="main">(</span><span class="var">?v</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="var">?v</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="skolem">m</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span> <span class="skolem">n</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this<span class="main">(</span>1-<span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">m</span>‚Ä∫</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">n</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">1</span>‚Ä∫</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">m</span>‚Ä∫</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?v</span><span class="main">^</span><span class="main">(</span><span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="var">?v</span> <span class="main">::</span> int mpoly<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?v</span><span class="main">^</span><span class="numeral">2</span><span class="main">-</span><span class="var">?v</span><span class="main">)</span> <span class="main">+</span> <span class="var">?v</span><span class="main">^</span><span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> power_eq_if
          ideal.scale_right_diff_distrib<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        q<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?v</span><span class="main">^</span><span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?v</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">*</span> <span class="main">(</span><span class="var">?v</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="var">?v</span><span class="main">)</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">n</span><span class="main">-</span><span class="main">1</span>‚Ä∫</span></span><span class="main">]</span> 2
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> q <span class="keyword1"><span class="command">unfolding</span></span> eq
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?v</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">q</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distrib_right<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?thesis</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">n</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">‚üπ</span> <span class="main">‚àÉ</span><span class="bound">q</span><span class="main">.</span> <span class="var">?v</span><span class="main">^</span><span class="skolem">n</span> <span class="main">=</span> <span class="var">?v</span> <span class="main">+</span> <span class="bound">q</span> <span class="main">*</span> <span class="main">(</span><span class="var">?v</span><span class="main">^</span><span class="numeral">2</span><span class="main">-</span><span class="var">?v</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> H<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">n</span><span class="main">+</span><span class="main">1</span>‚Ä∫</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qr</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπnat <span class="main">‚áí</span> int mpoly‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
     qr<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">‚üπ</span> <span class="var">?v</span><span class="main">^</span><span class="skolem">n</span> <span class="main">=</span> <span class="var">?v</span> <span class="main">+</span> <span class="skolem">qr</span> <span class="skolem">n</span> <span class="main">*</span> <span class="main">(</span><span class="var">?v</span><span class="main">^</span><span class="numeral">2</span><span class="main">-</span><span class="var">?v</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
   <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> vn<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="keyword1">if</span> lookup <span class="skolem">x</span> <span class="free">x'</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> Var <span class="free">x'</span> <span class="main">^</span> lookup <span class="skolem">x</span> <span class="free">x'</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> lookup <span class="skolem">x</span> <span class="free">x'</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="var">?v</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> lookup <span class="skolem">x</span> <span class="free">x'</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">qr</span> <span class="main">(</span>lookup <span class="skolem">x</span> <span class="free">x'</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?v</span><span class="main">^</span><span class="numeral">2</span><span class="main">-</span><span class="var">?v</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Var_def Var<span class="hidden">‚á©</span><sub>0</sub>_def monom.abs_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">x</span><span class="main">‚àà</span>keys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span><span class="main">.</span> MPoly_Type.monom <span class="bound">x</span> <span class="main">(</span>MPoly_Type.coeff <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> polynomial_sum_monoms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπlookup <span class="skolem">x</span> <span class="free">x'</span> <span class="main">=</span> <span class="main">0</span> <span class="main">‚üπ</span>
    Abs_poly_mapping <span class="main">(</span><span class="main">Œª</span><span class="bound">k</span><span class="main">.</span> lookup <span class="skolem">x</span> <span class="bound">k</span> <span class="keyword1">when</span> <span class="bound">k</span> <span class="main">‚â†</span> <span class="free">x'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_mapping.Abs_poly_mapping_inject<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> when_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπfinite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">when</span> <span class="free">x'</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> infinite_nat_iff_unbounded less_not_refl lookup_single lookup_single_not_eq mem_Collect_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">^^</span> <span class="main">(</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">=</span> Abs_poly_mapping <span class="main">(</span><span class="main">Œª</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">x'</span> <span class="keyword1">then</span> <span class="skolem">n</span><span class="main">+</span><span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> single_def Abs_poly_mapping_inject plus_poly_mapping.abs_eq eq_onp_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span>if_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">0</span> <span class="main">&lt;</span> lookup <span class="skolem">x</span> <span class="free">x'</span> <span class="main">‚üπ</span>
    Abs_poly_mapping <span class="main">(</span><span class="main">Œª</span><span class="bound">k</span><span class="main">.</span> lookup <span class="skolem">x</span> <span class="bound">k</span> <span class="keyword1">when</span> <span class="bound">k</span> <span class="main">‚â†</span> <span class="free">x'</span><span class="main">)</span> <span class="main">+</span>
    Abs_poly_mapping <span class="main">(</span><span class="main">Œª</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">x'</span> <span class="keyword1">then</span> lookup <span class="skolem">x</span> <span class="free">x'</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">+</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span>
    <span class="skolem">x</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_mapping.Abs_poly_mapping_inject plus_poly_mapping.abs_eq eq_onp_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> plus_poly_mapping.abs_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_mapping.Abs_poly_mapping_inject plus_poly_mapping.abs_eq eq_onp_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Abs_poly_mapping_inject<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span>MPoly_Type.monom <span class="main">(</span>remove_key <span class="free">x'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>MPoly_Type.coeff <span class="free">p</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
      <span class="main">(</span><span class="keyword1">if</span> lookup <span class="skolem">x</span> <span class="free">x'</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> Var <span class="free">x'</span> <span class="main">^</span> <span class="main">(</span>lookup <span class="skolem">x</span> <span class="free">x'</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">have</span></span> f_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> MPoly_Type.monom <span class="skolem">x</span> <span class="main">(</span>MPoly_Type.coeff <span class="free">p</span> <span class="skolem">x</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def monom_def remove_key_def Var_def MPoly_monomial_power Var<span class="hidden">‚á©</span><sub>0</sub>_def
      mpoly.MPoly_inject monomial_inj times_mpoly.abs_eq
      times_mpoly.abs_eq mult_single<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">x</span><span class="main">‚àà</span>keys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span><span class="main">.</span>
       MPoly_Type.monom <span class="main">(</span>remove_key <span class="free">x'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>MPoly_Type.coeff <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span>
       <span class="main">(</span><span class="keyword1">if</span> lookup <span class="bound">x</span> <span class="free">x'</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="var">?v</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
          <span class="main">(</span><span class="main">‚àë</span><span class="bound">x</span><span class="main">‚àà</span>keys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span><span class="main">.</span>
       MPoly_Type.monom <span class="main">(</span>remove_key <span class="free">x'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>MPoly_Type.coeff <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span>
       <span class="main">(</span><span class="keyword1">if</span> lookup <span class="bound">x</span> <span class="free">x'</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span>
        <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">qr</span> <span class="main">(</span>lookup <span class="bound">x</span> <span class="free">x'</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
             <span class="main">(</span><span class="var">?v</span><span class="main"><span class="hidden">‚áß</span><sup>2</sup></span> <span class="main">-</span> <span class="var">?v</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">=</span> <span class="var">?a</span> <span class="main">+</span> <span class="var">?v2v</span>‚Ä∫</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> q<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> f_alt_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">abs_def</span><span class="main">]</span> f_def vn semiring_class.distrib_left
      comm_semiring_1_class.semiring_normalization_rules<span class="main">(</span>18<span class="main">)</span> semiring_0_class.sum_distrib_right
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> semiring_class.distrib_left
      sum.distrib<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπkeys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">‚àà</span> keys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span><span class="main">.</span> lookup <span class="bound">x</span> <span class="free">x'</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">‚à™</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">‚àà</span> keys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span><span class="main">.</span> lookup <span class="bound">x</span> <span class="free">x'</span> <span class="main">‚â†</span> <span class="main">0</span><span class="main">}</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound"><span class="bound">x</span></span> <span class="main">|</span> <span class="bound">x</span> <span class="main">‚àà</span> keys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span> <span class="main">‚àß</span> lookup <span class="bound">x</span> <span class="free">x'</span> <span class="main">=</span> <span class="main">0</span><span class="main">.</span>
       MPoly_Type.monom <span class="bound">x</span> <span class="main">(</span>MPoly_Type.coeff <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
    <span class="main">(</span><span class="main">‚àë</span><span class="bound"><span class="bound">x</span></span> <span class="main">|</span> <span class="bound">x</span> <span class="main">‚àà</span> keys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span> <span class="main">‚àß</span> lookup <span class="bound">x</span> <span class="free">x'</span> <span class="main">‚â†</span> <span class="main">0</span><span class="main">.</span>
       MPoly_Type.monom <span class="main">(</span>remove_key <span class="free">x'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>MPoly_Type.coeff <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
       <span class="main">(</span>MPoly_Type.monom <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span>
     <span class="main">(</span><span class="main">‚àë</span><span class="bound"><span class="bound">x</span></span> <span class="main">|</span> <span class="bound">x</span> <span class="main">‚àà</span> keys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span> <span class="main">‚àß</span> lookup <span class="bound">x</span> <span class="free">x'</span> <span class="main">‚â†</span> <span class="main">0</span><span class="main">.</span>
        MPoly_Type.monom <span class="main">(</span>remove_key <span class="free">x'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>MPoly_Type.coeff <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span>
        <span class="skolem">qr</span> <span class="main">(</span>lookup <span class="bound">x</span> <span class="free">x'</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
             <span class="main">(</span><span class="var">?v</span><span class="main"><span class="hidden">‚áß</span><sup>2</sup></span> <span class="main">-</span> <span class="var">?v</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">=</span> <span class="var">?A</span> <span class="main">+</span> <span class="var">?B</span> <span class="main">*</span> <span class="main">_</span> <span class="main">+</span> <span class="var">?C</span> <span class="main">*</span> <span class="main">_</span>‚Ä∫</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> semiring_0_class.sum_distrib_right<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>MPoly_Type.monom <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">1</span><span class="main">)</span>‚Ä∫</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> p<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>I<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> I<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> comm_monoid_add_class.sum.union_disjoint<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> comm_monoid_add_class.sum.union_disjoint<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">Œª</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> MPoly_Type.monom <span class="main"><span class="main">(</span></span>remove_key <span class="free"><span class="free">x'</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>MPoly_Type.coeff <span class="free"><span class="free">p</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">*</span></span>
        <span class="skolem"><span class="skolem">qr</span></span> <span class="main"><span class="main">(</span></span>lookup <span class="bound"><span class="bound">x</span></span> <span class="free"><span class="free">x'</span></span><span class="main"><span class="main">)</span></span>‚Ä∫</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">Œª</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">0</span></span>‚Ä∫</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">Œª</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> MPoly_Type.monom <span class="main"><span class="main">(</span></span>remove_key <span class="free"><span class="free">x'</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>MPoly_Type.coeff <span class="free"><span class="free">p</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">*</span></span>
       <span class="main"><span class="main">(</span></span>MPoly_Type.monom <span class="main"><span class="main">(</span></span>monomial <span class="main"><span class="main">(</span></span>Suc <span class="main"><span class="main">0</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">x'</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span>‚Ä∫</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">Œª</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> MPoly_Type.monom <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">(</span></span>MPoly_Type.coeff <span class="free"><span class="free">p</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span>‚Ä∫</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> f_alt_def<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="var">?A</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> vars_setsum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">‚àà</span> keys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span><span class="main">.</span> lookup <span class="bound">x</span> <span class="free">x'</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>‚Ä∫</span></span>
      <span class="quoted"><span class="quoted">‚Äπ<span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> MPoly_Type.monom <span class="bound">x</span> <span class="main">(</span>MPoly_Type.coeff <span class="free">p</span> <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> set_rev_mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lookup_eq_zero_in_keys_contradict<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> lookup_eq_zero_in_keys_contradict subsetD vars_monom_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="var">?B</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> vars_setsum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">‚àà</span> keys <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span><span class="main">.</span> lookup <span class="bound">x</span> <span class="free">x'</span> <span class="main">‚â†</span> <span class="main">0</span><span class="main">}</span>‚Ä∫</span></span>
      <span class="quoted"><span class="quoted">‚Äπ<span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> MPoly_Type.monom <span class="main">(</span>remove_key <span class="free">x'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>MPoly_Type.coeff <span class="free">p</span> <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> set_rev_mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lookup_eq_zero_in_keys_contradict<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_monom_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> remove_key_keys<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?B</span></span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?A</span></span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?C</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> polynomial_decomp_alien_var<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">q</span> <span class="free">A</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint mpoly‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    q<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">q</span> <span class="main">=</span> <span class="free">A</span> <span class="main">*</span> <span class="main">(</span>monom <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">b</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    x<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="free">q</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="free">b</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">A</span> <span class="main">=</span> <span class="main">0</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">q</span> <span class="main">=</span> <span class="free">b</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">A</span> <span class="main">*</span> <span class="main">(</span>monom <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">1</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?A</span> <span class="main">=</span> <span class="free">q</span> <span class="main">-</span> <span class="free">b</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> q<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">Œª</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">-</span> <span class="free">b</span>‚Ä∫</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> x vars_in_right_only
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="main">(</span><span class="var">?A</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?A</span> <span class="main">=</span> <span class="main">0</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_mult_monom <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?A</span> <span class="main">=</span> <span class="main">0</span> <span class="main">‚üπ</span> <span class="free">A</span> <span class="main">=</span> <span class="main">0</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_not_insert mult_zero_left vars_mult_monom<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">A</span> <span class="main">=</span> <span class="main">0</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">q</span> <span class="main">=</span> <span class="free">b</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> polynomial_decomp_alien_var2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">q</span> <span class="free">A</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint mpoly‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    q<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">q</span> <span class="main">=</span> <span class="free">A</span> <span class="main">*</span> <span class="main">(</span>monom <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">1</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span> <span class="main">+</span> <span class="free">b</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    x<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="free">q</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="free">b</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="free">p</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">A</span> <span class="main">=</span> <span class="main">0</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">q</span> <span class="main">=</span> <span class="free">b</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‚Äπmonom <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">1</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span> x'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?x</span> <span class="main">=</span> Var <span class="free">x'</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Var.abs_eq Var<span class="hidden">‚á©</span><sub>0</sub>_def monom.abs_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÉ</span><span class="bound">n</span> <span class="bound">Ax</span> <span class="bound">A'</span><span class="main">.</span> <span class="free">A</span> <span class="main">=</span> <span class="var">?x</span> <span class="main">*</span> <span class="bound">Ax</span> <span class="main">+</span> <span class="bound">A'</span> <span class="main">‚àß</span> <span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="bound">A'</span> <span class="main">‚àß</span> degree <span class="bound">Ax</span> <span class="free">x'</span> <span class="main">=</span> <span class="bound">n</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> polynomial_split_on_var<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">x'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">from</span></span> wellorder_class.exists_least_iff<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ax</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">A</span> <span class="main">=</span> <span class="skolem">Ax</span> <span class="main">*</span> <span class="var">?x</span> <span class="main">+</span> <span class="skolem">A'</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="skolem">A'</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    n<span class="main">:</span> <span class="quoted"><span class="quoted">‚ÄπMPoly_Type.degree <span class="skolem">Ax</span> <span class="free">x'</span> <span class="main">=</span> <span class="skolem">n</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    H<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">m</span> <span class="bound">Ax</span> <span class="bound">A'</span><span class="main">.</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">‚ü∂</span>
                   <span class="free">A</span> <span class="main">‚â†</span> <span class="bound">Ax</span> <span class="main">*</span> MPoly_Type.monom <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">1</span> <span class="main">+</span> <span class="bound">A'</span> <span class="main">‚à®</span>
                   <span class="free">x'</span> <span class="main">‚àà</span> vars <span class="bound">A'</span> <span class="main">‚à®</span> MPoly_Type.degree <span class="bound">Ax</span> <span class="free">x'</span> <span class="main">‚â†</span> <span class="bound">m</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wellorder_class.exists_least_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">Œª</span><span class="bound">n</span><span class="main">.</span> <span class="main">‚àÉ</span><span class="bound">Ax</span> <span class="bound">A'</span><span class="main">.</span> <span class="free">A</span> <span class="main">=</span> <span class="bound">Ax</span> <span class="main">*</span> <span class="var">?x</span> <span class="main">+</span> <span class="bound">A'</span> <span class="main">‚àß</span> <span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="bound">A'</span> <span class="main">‚àß</span>
      degree <span class="bound">Ax</span> <span class="free">x'</span> <span class="main">=</span> <span class="bound">n</span>‚Ä∫</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="skolem">Ax</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">*</span> monom <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="free">p</span> <span class="main">*</span> <span class="skolem">A'</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> q A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="free">q</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="main">(</span><span class="free">p</span> <span class="main">*</span> <span class="skolem">A'</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> x <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="skolem">A'</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> UnE add.assoc add.commute calculation subset_iff vars_in_right_only vars_mult<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">A</span> <span class="main">+</span> <span class="skolem">Ax</span> <span class="main">*</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">q</span> <span class="main">=</span> <span class="free">p</span> <span class="main">*</span> <span class="skolem">A'</span> <span class="main">+</span> <span class="free">b</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> polynomial_decomp_alien_var<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">A'</span> <span class="main">=</span> <span class="main">-</span><span class="skolem">Ax</span> <span class="main">*</span> <span class="var">?x</span> <span class="main">-</span> <span class="skolem">Ax</span> <span class="main">*</span> <span class="free">p</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">A</span> <span class="main">+</span> <span class="skolem">Ax</span> <span class="main">*</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add_uminus_conv_diff eq_neg_iff_add_eq_0 minus_add_cancel
        mult_minus_left<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">A</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">Ax</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">unfolding</span></span> A'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Axx</span></span> <span class="skolem"><span class="skolem">Ax'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    Ax<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">Ax</span> <span class="main">=</span> <span class="var">?x</span> <span class="main">*</span> <span class="skolem">Axx</span> <span class="main">+</span> <span class="skolem">Ax'</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="skolem">Ax'</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> polynomial_split_on_var<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Ax</span></span> <span class="quoted"><span class="free">x'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">A</span> <span class="main">=</span> <span class="var">?x</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">Axx</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">Ax'</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">A</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">Ax</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span>‚Ä∫</span></span> Ax
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="main">(</span><span class="main">-</span><span class="skolem">Ax'</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="skolem">Ax'</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> UnE add.right_neutral
      add_minus_cancel assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> subsetD vars_in_right_only vars_mult<span class="main">)</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">Axx</span> <span class="main">‚â†</span> <span class="main">0</span> <span class="main">‚üπ</span> MPoly_Type.degree <span class="main">(</span><span class="main">-</span> <span class="skolem">Axx</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="free">x'</span> <span class="main">&lt;</span> degree <span class="skolem">Ax</span> <span class="free">x'</span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command">using</span></span> degree_times_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Axx</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">x'</span></span><span class="main">]</span> x
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ax degree_sum_notin <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="skolem">Ax'</span>‚Ä∫</span></span> degree_mult_Var'
       degree_notin_vars<span class="main">)</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">Axx</span> <span class="main">=</span> <span class="main">0</span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command">using</span></span> H<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚ÄπMPoly_Type.degree <span class="main">(</span><span class="main">-</span> <span class="skolem">Axx</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="free">x'</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">-</span> <span class="skolem">Axx</span> <span class="main">*</span> <span class="free">p</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">-</span> <span class="skolem">Ax'</span> <span class="main">*</span> <span class="free">p</span>‚Ä∫</span></span><span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">Ax'</span> <span class="main">=</span> <span class="skolem">Ax</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> Ax <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">A</span> <span class="main">=</span> <span class="main">0</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="quoted"><span class="quoted">‚Äπ<span class="free">A</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">Ax</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="main">(</span><span class="main">-</span> <span class="skolem">Ax'</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="skolem">A'</span>‚Ä∫</span></span> polynomial_decomp_alien_var<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">q</span> <span class="main">=</span> <span class="free">b</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vars_unE<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x</span> <span class="main">‚àà</span> vars <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">x</span> <span class="main">‚àà</span> vars <span class="free">a</span> <span class="main">‚üπ</span> <span class="free">thesis</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">x</span> <span class="main">‚àà</span> vars <span class="free">b</span> <span class="main">‚üπ</span> <span class="free">thesis</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">thesis</span>‚Ä∫</span></span>
   <span class="keyword1"><span class="command">using</span></span> vars_mult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> in_keys_minusI1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">‚àà</span> keys <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">‚àâ</span> keys <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">‚àà</span> keys <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> in_keys_iff lookup_minus <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> in_keys_minusI2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="tfree">'a</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="tfree">'a</span> <span class="main">‚áí<span class="hidden">‚á©</span><sub>0</sub></span> <span class="tfree">'b</span> <span class="main">::</span> <span class="main">{</span>cancel_comm_monoid_add<span class="main">,</span>group_add<span class="main">}</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">‚àà</span> keys <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">‚àâ</span> keys <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">‚àà</span> keys <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> in_keys_iff lookup_minus <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">lemma</span></span> in_vars_addE<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">x</span> <span class="main">‚àà</span> vars <span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="free">q</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">x</span> <span class="main">‚àà</span> vars <span class="free">p</span> <span class="main">‚üπ</span> <span class="free">thesis</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">x</span> <span class="main">‚àà</span> vars <span class="free">q</span> <span class="main">‚üπ</span> <span class="free">thesis</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">thesis</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> UnE in_mono vars_add<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lookup_monomial_If<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπlookup <span class="main">(</span>monomial <span class="free">v</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">k'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">k</span> <span class="main">=</span> <span class="bound">k'</span> <span class="keyword1">then</span> <span class="free">v</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lookup_single_not_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_mult_Var<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπvars <span class="main">(</span>Var <span class="free">x</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> insert <span class="free">x</span> <span class="main">(</span>vars <span class="free">p</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint mpoly‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">‚â†</span> <span class="main">0</span> <span class="main">‚üπ</span>
    <span class="main">‚àÉ</span><span class="bound">xa</span><span class="main">.</span> <span class="main">(</span><span class="main">‚àÉ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">=</span> monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span> <span class="main">‚àß</span>
         lookup <span class="main">(</span>mapping_of <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">xa</span> <span class="main">-</span> monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">‚â†</span> <span class="main">0</span> <span class="main">‚àß</span>
         <span class="main">0</span> <span class="main">&lt;</span> lookup <span class="bound">xa</span> <span class="free">x</span>‚Ä∫</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> One_nat_def ab_semigroup_add_class.add.commute
     add_diff_cancel_right' aux lookup_add lookup_single_eq mapping_of_inject
     neq0_conv one_neq_zero plus_eq_zero_2 zero_mpoly.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_def times_mpoly.rep_eq Var.rep_eq
    <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_keys_timesE <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> keys_add'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> keys_def lookup_times_monomial_left Var.rep_eq Var<span class="hidden">‚á©</span><sub>0</sub>_def adds_def
      lookup_add eq_diff_eq'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> keys_mult_monomial<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπkeys <span class="main">(</span>monomial <span class="main">(</span><span class="free">n</span> <span class="main">::</span> int<span class="main">)</span> <span class="free">k</span> <span class="main">*</span> mapping_of <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">(+)</span> <span class="free">k</span><span class="main">)</span> <span class="main">`</span> keys <span class="main">(</span>mapping_of <span class="free">a</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚àë</span><span class="bound">aa</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">=</span> <span class="bound">aa</span> <span class="keyword1">then</span> <span class="free">n</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span>
               <span class="main">(</span><span class="main">‚àë</span><span class="bound">q</span><span class="main">.</span> lookup <span class="main">(</span>mapping_of <span class="free">a</span><span class="main">)</span> <span class="bound">q</span> <span class="keyword1">when</span> <span class="free">k</span> <span class="main">+</span> <span class="skolem">xa</span> <span class="main">=</span> <span class="bound">aa</span> <span class="main">+</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">‚àë</span><span class="bound">aa</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">=</span> <span class="bound">aa</span> <span class="keyword1">then</span> <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">q</span><span class="main">.</span> lookup <span class="main">(</span>mapping_of <span class="free">a</span><span class="main">)</span> <span class="bound">q</span> <span class="keyword1">when</span> <span class="free">k</span> <span class="main">+</span> <span class="skolem">xa</span> <span class="main">=</span> <span class="bound">aa</span> <span class="main">+</span> <span class="bound">q</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xa</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Sum_any.cong mult_not_zero<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_def times_mpoly.rep_eq Const.rep_eq times_poly_mapping.rep_eq
      Const<span class="hidden">‚á©</span><sub>0</sub>_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_keys_timesE <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lookup_monomial_If prod_fun_def
      keys_def times_poly_mapping.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vars_mult_Const<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπvars <span class="main">(</span>Const <span class="free">n</span> <span class="main">*</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> vars <span class="free">a</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint mpoly‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_def times_mpoly.rep_eq Const.rep_eq keys_mult_monomial
    Const<span class="hidden">‚á©</span><sub>0</sub>_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_keys_timesE <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="free">m</span> <span class="main">-</span> coeff <span class="free">q</span> <span class="free">m</span> <span class="main">=</span> coeff <span class="main">(</span><span class="free">p</span><span class="main">-</span><span class="free">q</span><span class="main">)</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_def lookup_minus minus_mpoly.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Const_1_eq_1<span class="main">:</span> <span class="quoted"><span class="quoted">‚ÄπConst <span class="main">(</span><span class="main">1</span> <span class="main">::</span> int<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> int mpoly<span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Const.abs_eq Const<span class="hidden">‚á©</span><sub>0</sub>_one one_mpoly.abs_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπvars <span class="main">(</span><span class="main">1</span> <span class="main">::</span> int mpoly<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_def one_mpoly.rep_eq Const_1_eq_1<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπMore Ideals‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(</span><span class="tfree">'x</span> <span class="main">‚áí<span class="hidden">‚á©</span><sub>0</sub></span> nat<span class="main">)</span> <span class="main">‚áí<span class="hidden">‚á©</span><sub>0</sub></span> <span class="tfree">'a</span><span class="main">::</span>comm_ring_1<span class="main">)</span> set‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">‚àà</span> ideal <span class="free">A</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">*</span> <span class="free">q</span> <span class="main">‚àà</span> ideal <span class="free">A</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms ideal.span_scale semiring_normalization_rules<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThe following theorem is very close to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> ideal.span_insert<span class="antiquote"><span class="antiquote">}</span></span></span></span>, except that it
is more useful if we need to take an element of <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚ÄπMore_Modules.ideal <span class="main"><span class="main">(</span></span>insert <span class="free"><span class="free">a</span></span> <span class="free"><span class="free">S</span></span><span class="main"><span class="main">)</span></span>‚Ä∫</span></span></span></span>.‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> ideal_insert'<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπMore_Modules.ideal <span class="main">(</span>insert <span class="free">a</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">‚àÉ</span><span class="bound">x</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">k</span> <span class="main">*</span> <span class="free">a</span> <span class="main">‚àß</span> <span class="bound">x</span> <span class="main">‚àà</span> More_Modules.ideal <span class="free">S</span><span class="main">}</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ideal.span_insert
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">-</span> <span class="free">k</span> <span class="main">*</span> <span class="free">a</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="improper">x</span> <span class="main">-</span> <span class="improper">k</span> <span class="main">*</span> <span class="free">a</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="improper">k</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> ideal_mult_right_in<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">a</span> <span class="main">‚àà</span> ideal <span class="free">A</span> <span class="main">‚üπ</span> <span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">‚àà</span> More_Modules.ideal <span class="free">A</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ideal.span_scale mult.commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ideal_mult_right_in2<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">a</span> <span class="main">‚àà</span> ideal <span class="free">A</span> <span class="main">‚üπ</span> <span class="free">b</span> <span class="main">*</span> <span class="free">a</span> <span class="main">‚àà</span> More_Modules.ideal <span class="free">A</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ideal.span_scale<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπvars <span class="main">(</span>Var <span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>zero_neq_one<span class="main">}</span> mpoly<span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_def Var.rep_eq  Var<span class="hidden">‚á©</span><sub>0</sub>_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_minus_Var_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπvars <span class="main">(</span><span class="free">p'</span> <span class="main">-</span> Var <span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>ab_group_add<span class="main">,</span>one<span class="main">,</span>zero_neq_one<span class="main">}</span> mpoly<span class="main">)</span> <span class="main">‚äÜ</span>  <span class="free">ùí±</span> <span class="main">‚üπ</span> vars <span class="free">p'</span> <span class="main">‚äÜ</span> insert <span class="free">x</span> <span class="free">ùí±</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> vars_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p'</span> <span class="main">-</span> Var <span class="free">x</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚ÄπVar <span class="free">x</span>‚Ä∫</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_add_Var_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπvars <span class="main">(</span><span class="free">p'</span> <span class="main">+</span> Var <span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>ab_group_add<span class="main">,</span>one<span class="main">,</span>zero_neq_one<span class="main">}</span> mpoly<span class="main">)</span> <span class="main">‚äÜ</span>  <span class="free">ùí±</span> <span class="main">‚üπ</span> vars <span class="free">p'</span> <span class="main">‚äÜ</span> insert <span class="free">x</span> <span class="free">ùí±</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> vars_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p'</span> <span class="main">+</span> Var <span class="free">x</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">-</span>Var <span class="free">x</span>‚Ä∫</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_monomila_in_varsD<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπcoeff <span class="free">p</span> <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">‚â†</span> <span class="main">0</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àà</span> vars <span class="main">(</span><span class="free">p</span> <span class="main">::</span> int mpoly<span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_def vars_def keys_def
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπmonomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_MPoly_monomial<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>MPoly_Type.coeff <span class="main">(</span>MPoly <span class="main">(</span>monomial <span class="free">a</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> MPoly_Type.coeff_def lookup_single_eq monom.abs_eq monom.rep_eq<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Duplicate_Free_Multiset">
<div class="head">
<h1>Theory Duplicate_Free_Multiset</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:         Duplicate_Free_Multiset.thy
  Author:       Mathias Fleury, Daniela Kaufmann, JKU
  Maintainer:   Mathias Fleury, JKU
*)</span>
<span class="keyword1"><span class="command">theory</span></span> Duplicate_Free_Multiset
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Nested_Multisets_Ordinals/Multiset_More.html">Nested_Multisets_Ordinals.Multiset_More</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚ÄπDuplicate Free Multisets‚Ä∫</span></span>

<span class="comment1">(* TODO Move Multiset_More *)</span>
<span class="keyword1"><span class="command">lemma</span></span> remove_diff_multiset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x13</span> <span class="main">‚àâ#</span> <span class="free">A</span> <span class="main">‚üπ</span> <span class="free">A</span> <span class="main">-</span> add_mset <span class="free">x13</span> <span class="free">B</span> <span class="main">=</span> <span class="free">A</span> <span class="main">-</span> <span class="free">B</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_intersect_left_idem inter_add_right1<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπDuplicate free multisets are isomorphic to finite sets, but it can be useful to reason about
  duplication to speak about intermediate execution steps in the refinements.
‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_remdups_mset_id<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπdistinct_mset <span class="free">C</span> <span class="main">‚üπ</span> remdups_mset <span class="free">C</span> <span class="main">=</span> <span class="free">C</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span>  <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> notin_add_mset_remdups_mset<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">a</span> <span class="main">‚àâ#</span> <span class="free">A</span> <span class="main">‚üπ</span> add_mset <span class="free">a</span> <span class="main">(</span>remdups_mset <span class="free">A</span><span class="main">)</span> <span class="main">=</span> remdups_mset <span class="main">(</span>add_mset <span class="free">a</span> <span class="free">A</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_image_mset<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπdistinct_mset <span class="main">(</span>image_mset <span class="free">f</span> <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">‚ü∑</span> distinct <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> mset_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> distinct_mset_mset_distinct<span class="main">)</span>
  <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_mono<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">D'</span> <span class="main">‚äÜ#</span> <span class="free">D</span> <span class="main">‚üπ</span> distinct_mset <span class="free">D</span> <span class="main">‚üπ</span> distinct_mset <span class="free">D'</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct_mset_union subset_mset.le_iff_add<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_mono_strict<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">D'</span> <span class="main">‚äÇ#</span> <span class="free">D</span> <span class="main">‚üπ</span> distinct_mset <span class="free">D</span> <span class="main">‚üπ</span> distinct_mset <span class="free">D'</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> distinct_mset_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_set_mset_eq_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπdistinct_mset <span class="free">M</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπdistinct_mset <span class="free">N</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπset_mset <span class="free">M</span> <span class="main">=</span> set_mset <span class="free">N</span> <span class="main">‚ü∑</span> <span class="free">M</span> <span class="main">=</span> <span class="free">N</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms distinct_mset_set_mset_ident <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_union2<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπdistinct_mset <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚üπ</span> distinct_mset <span class="free">B</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> distinct_mset_union<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_mset_set<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπdistinct_mset <span class="main">(</span>mset_set <span class="free">A</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> distinct_mset_def count_mset_set_if <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_in_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_inter_remdups_mset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπdistinct_mset <span class="free">A</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">A</span> <span class="main">‚à©#</span> remdups_mset <span class="free">B</span> <span class="main">=</span> <span class="free">A</span> <span class="main">‚à©#</span> <span class="free">B</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">A'</span> <span class="main">‚à©#</span> remove1_mset <span class="skolem">a</span> <span class="main">(</span>remdups_mset <span class="skolem">Aa</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">A'</span> <span class="main">‚à©#</span> <span class="skolem">Aa</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">if</span></span>
      <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">A'</span> <span class="main">‚à©#</span> remdups_mset <span class="skolem">Aa</span> <span class="main">=</span> <span class="skolem">A'</span> <span class="main">‚à©#</span> <span class="skolem">Aa</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">a</span> <span class="main">‚àâ#</span> <span class="skolem">A'</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">a</span> <span class="main">‚àà#</span> <span class="skolem">Aa</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A'</span> <span class="skolem">Aa</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="tfree">'a</span> multiset‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_DiffM inter_add_right1 set_mset_remdups_mset that<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> dist
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a A'
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">a</span> <span class="main">‚àà#</span> <span class="free">B</span>‚Ä∫</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">use</span> multi_member_split<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free"><span class="free">B</span></span></span>‚Ä∫</span></span></span></span><span class="main"><span class="main">]</span></span>  multi_member_split<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free"><span class="free">A</span></span></span>‚Ä∫</span></span></span></span><span class="main"><span class="main">]</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span>
           <span class="quoted">‚Äπ<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> mset_set.insert_remove‚Ä∫</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_mset_set_inter<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπfinite <span class="free">A</span> <span class="main">‚üπ</span> finite <span class="free">B</span> <span class="main">‚üπ</span> mset_set <span class="main">(</span><span class="free">A</span> <span class="main">‚à©</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> mset_set <span class="free">A</span> <span class="main">‚à©#</span> mset_set <span class="free">B</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a A
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">a</span> <span class="main">‚àà</span> <span class="free">B</span>‚Ä∫</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">a</span> <span class="main">‚àà#</span> mset_set <span class="free">B</span>‚Ä∫</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">use</span> multi_member_split<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‚Äπmset_set <span class="free"><span class="free"><span class="free">B</span></span></span>‚Ä∫</span></span></span></span><span class="main"><span class="main">]</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span>
        <span class="quoted">‚Äπ<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> mset_set.insert_remove‚Ä∫</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> removeAll_notin<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">a</span> <span class="main">‚àâ#</span> <span class="free">A</span> <span class="main">‚üπ</span> removeAll_mset <span class="free">a</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> count_inI <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> same_mset_distinct_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπmset <span class="free">M</span> <span class="main">=</span> mset <span class="free">M'</span> <span class="main">‚üπ</span> distinct <span class="free">M</span> <span class="main">‚ü∑</span> distinct <span class="free">M'</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_mset_mset_distinct<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> distinct_mset_mset_distinct<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπMore Lists‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> in_set_conv_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">x</span> <span class="main">‚àà</span> set <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">‚ü∑</span> <span class="main">(</span><span class="main">‚àÉ</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚àß</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> n
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚ÄπSuc <span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth less_Suc_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_takeD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rename_tac</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">i</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_takeD<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rename_tac</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_set_take_conv_nth<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">x</span> <span class="main">‚àà</span> set <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">‚ü∑</span> <span class="main">(</span><span class="main">‚àÉ</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span>min <span class="free">n</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">m</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth length_take min.commute min.strict_boundedE nth_take<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_set_remove1D<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">a</span> <span class="main">‚àà</span> set <span class="main">(</span>remove1 <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">a</span> <span class="main">‚àà</span> set <span class="free">xs</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> notin_set_remove1<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπGeneric Multiset‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mset_drop_upto<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="main">(</span>drop <span class="free">a</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#</span><span class="free">N</span><span class="main">!</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">‚àà#</span> mset_set <span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span>length <span class="free">N</span><span class="main">}</span><span class="main">#}</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">N</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">c</span> <span class="skolem">N</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> upt<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>length <span class="skolem">N</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> insert <span class="main">0</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span>Suc <span class="main">(</span>length <span class="skolem">N</span><span class="main">)</span><span class="main">}</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset_set <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>length <span class="skolem">N</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> add_mset <span class="main">0</span> <span class="main">(</span>mset_set <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span>Suc <span class="main">(</span>length <span class="skolem">N</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> upt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> mset_case_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{#</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">‚áí</span> <span class="skolem">c</span> <span class="main">|</span> Suc <span class="bound">x</span> <span class="main">‚áí</span> <span class="skolem">N</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà#</span> mset_set <span class="main">{</span>Suc <span class="skolem">a</span><span class="main">..&lt;</span>Suc <span class="skolem">b</span><span class="main">}</span><span class="main">#}</span> <span class="main">=</span>
    <span class="main">{#</span><span class="skolem">N</span> <span class="main">!</span> <span class="main">(</span><span class="bound">x</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà#</span> mset_set <span class="main">{</span>Suc <span class="skolem">a</span><span class="main">..&lt;</span>Suc <span class="skolem">b</span><span class="main">}</span><span class="main">#}</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_mset_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Suc_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{</span>Suc <span class="skolem">a</span><span class="main">..&lt;</span>Suc <span class="skolem">b</span><span class="main">}</span> <span class="main">=</span> Suc <span class="main">`</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..&lt;</span><span class="skolem">b</span><span class="main">}</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mset_set_Suc_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset_set <span class="main">{</span>Suc <span class="skolem">a</span><span class="main">..&lt;</span>Suc <span class="skolem">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">{#</span>Suc <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">‚àà#</span> mset_set <span class="main">{</span><span class="skolem">a</span><span class="main">..&lt;</span><span class="skolem">b</span><span class="main">}</span><span class="main">#}</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">unfolding</span></span> Suc_Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> image_mset_mset_set<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{#</span><span class="skolem">N</span> <span class="main">!</span> <span class="main">(</span><span class="bound">x</span><span class="main">-</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà#</span> mset_set <span class="main">{</span>Suc <span class="skolem">a</span><span class="main">..&lt;</span>Suc <span class="skolem">b</span><span class="main">}</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span><span class="skolem">N</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà#</span> mset_set <span class="main">{</span><span class="skolem">a</span><span class="main">..&lt;</span><span class="skolem">b</span><span class="main">}</span><span class="main">#}</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_set_Suc_Suc<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons drop_Cons H mset_case_Suc *<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπOther‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπI believe this should be added to the simplifier by default...‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> Collect_eq_comp'<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span> <span class="keyword1">O</span> <span class="main">{</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="bound">c</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">a</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span><span class="main">}</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Finite_Map_Multiset">
<div class="head">
<h1>Theory Finite_Map_Multiset</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:         Finite_Map_Multiset.thy
  Author:       Mathias Fleury, Daniela Kaufmann, JKU
  Maintainer:   Mathias Fleury, JKU
*)</span>
<span class="keyword1"><span class="command">theory</span></span> Finite_Map_Multiset
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Finite_Map.html">HOL-Library.Finite_Map</a>"</span> <a href="Duplicate_Free_Multiset.html">Duplicate_Free_Multiset</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">notation</span></span> image_mset <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">`#</span>"</span> 90<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚ÄπFinite maps and multisets‚Ä∫</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπFinite sets and multisets‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">mset_fset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="tfree">'a</span> fset <span class="main">‚áí</span> <span class="tfree">'a</span> multiset‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">mset_fset</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">‚â°</span> mset_set <span class="main">(</span>fset <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fset_mset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="tfree">'a</span> multiset <span class="main">‚áí</span> <span class="tfree">'a</span> fset‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">fset_mset</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">‚â°</span> Abs_fset <span class="main">(</span>set_mset <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fset_mset_mset_fset<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπfset_mset <span class="main">(</span>mset_fset <span class="free">N</span><span class="main">)</span> <span class="main">=</span> <span class="free">N</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset.fset_inverse fset_mset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_fset_fset_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπmset_fset <span class="main">(</span>fset_mset <span class="free">N</span><span class="main">)</span> <span class="main">=</span> remdups_mset <span class="free">N</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset.fset_inverse fset_mset_def Abs_fset_inverse remdups_mset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_mset_fset_fmember<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x</span> <span class="main">‚àà#</span> mset_fset <span class="free">N</span> <span class="main">‚ü∑</span> <span class="free">x</span> <span class="main">|‚àà|</span> <span class="free">N</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmember.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_fset_mset_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x</span> <span class="main">|‚àà|</span> fset_mset <span class="free">N</span> <span class="main">‚ü∑</span> <span class="free">x</span> <span class="main">‚àà#</span> <span class="free">N</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmember.rep_eq fset_mset_def Abs_fset_inverse<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπFinite map and multisets‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπRoughly the same as <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπran‚Ä∫</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπdom‚Ä∫</span></span></span></span>, but with duplication in the content (unlike their
  finite sets counterpart) while still working on finite domains (unlike a function mapping).
  Remark that <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">dom_m</span></span>‚Ä∫</span></span></span></span> (the keys) does not contain duplicates, but we keep for symmetry (and for
  easier use of multiset operators as in the definition of <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">ran_m</span></span>‚Ä∫</span></span></span></span>).
‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dom_m</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">dom_m</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> mset_fset <span class="main">(</span>fmdom <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ran_m</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">ran_m</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> the <span class="main">`#</span> fmlookup <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">`#</span> dom_m <span class="free"><span class="bound"><span class="entity">N</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dom_m_fmdrop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπdom_m <span class="main">(</span>fmdrop <span class="free">C</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> remove1_mset <span class="free">C</span> <span class="main">(</span>dom_m <span class="free">N</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dom_m_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">C</span> <span class="main">|‚àà|</span> fmdom <span class="free">N</span>‚Ä∫</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_set.remove fmember.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dom_m_fmdrop_All<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπdom_m <span class="main">(</span>fmdrop <span class="free">C</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> removeAll_mset <span class="free">C</span> <span class="main">(</span>dom_m <span class="free">N</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dom_m_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">C</span> <span class="main">|‚àà|</span> fmdom <span class="free">N</span>‚Ä∫</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_set.remove fmember.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dom_m_fmupd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπdom_m <span class="main">(</span>fmupd <span class="free">k</span> <span class="free">C</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> add_mset <span class="free">k</span> <span class="main">(</span>remove1_mset <span class="free">k</span> <span class="main">(</span>dom_m <span class="free">N</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dom_m_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">k</span> <span class="main">|‚àà|</span> fmdom <span class="free">N</span>‚Ä∫</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_set.remove fmember.rep_eq mset_set.insert_remove<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mset_dom<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπdistinct_mset <span class="main">(</span>dom_m <span class="free">N</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_mset_mset_set dom_m_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_dom_m_lookup_iff<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">C</span> <span class="main">‚àà#</span> dom_m <span class="free">N'</span> <span class="main">‚ü∑</span> fmlookup <span class="free">N'</span> <span class="free">C</span> <span class="main">‚â†</span> None‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dom_m_def fmdom.rep_eq fmlookup_dom'_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_dom_in_ran_m<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">i</span> <span class="main">‚àà#</span> dom_m <span class="free">N</span> <span class="main">‚üπ</span> the <span class="main">(</span>fmlookup <span class="free">N</span> <span class="free">i</span><span class="main">)</span> <span class="main">‚àà#</span> ran_m <span class="free">N</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_m_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmupd_same<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">x1</span> <span class="main">‚àà#</span> dom_m <span class="free">x1aa</span> <span class="main">‚üπ</span> fmupd <span class="free">x1</span> <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">x1aa</span> <span class="free">x1</span><span class="main">)</span><span class="main">)</span> <span class="free">x1aa</span> <span class="main">=</span> <span class="free">x1aa</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fmap_ext fmupd_lookup in_dom_m_lookup_iff option.collapse<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ran_m_fmempty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπran_m fmempty <span class="main">=</span> <span class="main">{#}</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    dom_m_fmempty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπdom_m fmempty <span class="main">=</span> <span class="main">{#}</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_m_def dom_m_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmrestrict_set_fmupd<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">a</span> <span class="main">‚àà</span> <span class="free">xs</span> <span class="main">‚üπ</span> fmrestrict_set <span class="free">xs</span> <span class="main">(</span>fmupd <span class="free">a</span> <span class="free">C</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> fmupd <span class="free">a</span> <span class="free">C</span> <span class="main">(</span>fmrestrict_set <span class="free">xs</span> <span class="free">N</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">a</span> <span class="main">‚àâ</span> <span class="free">xs</span> <span class="main">‚üπ</span> fmrestrict_set <span class="free">xs</span> <span class="main">(</span>fmupd <span class="free">a</span> <span class="free">C</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> fmrestrict_set <span class="free">xs</span> <span class="free">N</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmfilter_alt_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fset_fmdom_fmrestrict_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπfset <span class="main">(</span>fmdom <span class="main">(</span>fmrestrict_set <span class="free">xs</span> <span class="free">N</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fset <span class="main">(</span>fmdom <span class="free">N</span><span class="main">)</span> <span class="main">‚à©</span> <span class="free">xs</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmfilter_alt_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dom_m_fmrestrict_set<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπdom_m <span class="main">(</span>fmrestrict_set <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span> <span class="main">‚à©#</span> dom_m <span class="free">N</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> fset_fmdom_fmrestrict_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπset <span class="free">xs</span>‚Ä∫</span></span> <span class="quoted"><span class="free">N</span></span><span class="main">]</span> distinct_mset_dom<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">N</span></span><span class="main">]</span>
  distinct_mset_inter_remdups_mset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπmset_fset <span class="main">(</span>fmdom <span class="free">N</span><span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs</span>‚Ä∫</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dom_m_def fset_mset_mset_fset finite_mset_set_inter multiset_inter_commute
    remdups_mset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dom_m_fmrestrict_set'<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπdom_m <span class="main">(</span>fmrestrict_set <span class="free">xs</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> mset_set <span class="main">(</span><span class="free">xs</span> <span class="main">‚à©</span> set_mset <span class="main">(</span>dom_m <span class="free">N</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> fset_fmdom_fmrestrict_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs</span>‚Ä∫</span></span> <span class="quoted"><span class="free">N</span></span><span class="main">]</span> distinct_mset_dom<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">N</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dom_m_def fset_mset_mset_fset finite_mset_set_inter multiset_inter_commute
    remdups_mset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> indom_mI<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπfmlookup <span class="free">m</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àà#</span> dom_m <span class="free">m</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> fmdomI<span class="main">)</span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dom_m_def fmember.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmupd_fmdrop_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">k</span> <span class="main">|‚àà|</span> fmdom <span class="free">N'</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπfmupd <span class="free">k</span> <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">N'</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fmdrop <span class="free">k</span> <span class="free">N'</span><span class="main">)</span> <span class="main">=</span> <span class="free">N'</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmap_upd <span class="free">k</span> <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">N'</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">‚â†</span> <span class="free">k</span> <span class="keyword1">then</span> fmlookup <span class="free">N'</span> <span class="bound">x</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">=</span>
     map_upd <span class="free">k</span> <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">N'</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span>fmlookup <span class="free">N'</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_upd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmap_upd <span class="free">k</span> <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">N'</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="free">N'</span><span class="main">)</span> <span class="main">=</span> fmlookup <span class="free">N'</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_upd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπfinite <span class="main">(</span>dom <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> fmlookup <span class="free">N'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> dom_if<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmupd_def fmupd.abs_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> fmlookup_drop
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmlookup_inverse<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fm_member_split<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">k</span> <span class="main">|‚àà|</span> fmdom <span class="free">N'</span> <span class="main">‚üπ</span> <span class="main">‚àÉ</span><span class="bound">N''</span> <span class="bound">v</span><span class="main">.</span> <span class="free">N'</span> <span class="main">=</span> fmupd <span class="free">k</span> <span class="bound">v</span> <span class="bound">N''</span> <span class="main">‚àß</span> the <span class="main">(</span>fmlookup <span class="free">N'</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="bound">v</span> <span class="main">‚àß</span>
    <span class="free">k</span> <span class="main">|‚àâ|</span> fmdom <span class="bound">N''</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‚Äπfmdrop <span class="free"><span class="free"><span class="free">k</span></span></span> <span class="free"><span class="free"><span class="free">N'</span></span></span>‚Ä∫</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmupd_fmdrop_id<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">‚Äπfmdrop <span class="free">k</span> <span class="main">(</span>fmupd <span class="free">k</span> <span class="free">va</span> <span class="free">N''</span><span class="main">)</span> <span class="main">=</span> fmdrop <span class="free">k</span> <span class="free">N''</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmap_ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmap_ext_fmdom<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>fmdom <span class="free">N</span> <span class="main">=</span> fmdom <span class="free">N'</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="main">‚ãÄ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">|‚àà|</span> fmdom <span class="free">N</span> <span class="main">‚üπ</span> fmlookup <span class="free">N</span> <span class="bound">x</span> <span class="main">=</span> fmlookup <span class="free">N'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">‚üπ</span>
       <span class="free">N</span> <span class="main">=</span> <span class="free">N'</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fmap_ext<span class="main">)</span>
    <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">‚Äπ<span class="improper">x</span> <span class="main">|‚àà|</span> fmdom <span class="free">N</span>‚Ä∫</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmdom_notD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmrestrict_set_insert_in<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">xa</span>  <span class="main">‚àà</span> fset <span class="main">(</span>fmdom <span class="free">N</span><span class="main">)</span> <span class="main">‚üπ</span>
    fmrestrict_set <span class="main">(</span>insert <span class="free">xa</span> <span class="free">l1</span><span class="main">)</span> <span class="free">N</span> <span class="main">=</span> fmupd <span class="free">xa</span> <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">N</span> <span class="free">xa</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fmrestrict_set <span class="free">l1</span> <span class="free">N</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmap_ext_fmdom<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_fmdom_fmrestrict_set fmember.rep_eq notin_fset<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmlookup_dom_iff<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> fmrestrict_set_insert_notin<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">xa</span>  <span class="main">‚àâ</span> fset <span class="main">(</span>fmdom <span class="free">N</span><span class="main">)</span> <span class="main">‚üπ</span>
    fmrestrict_set <span class="main">(</span>insert <span class="free">xa</span> <span class="free">l1</span><span class="main">)</span> <span class="free">N</span> <span class="main">=</span> fmrestrict_set <span class="free">l1</span> <span class="free">N</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fmap_ext_fmdom<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_fmdom_fmrestrict_set fmember.rep_eq notin_fset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmrestrict_set_insert_in_dom_m<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">xa</span>  <span class="main">‚àà#</span> dom_m <span class="free">N</span> <span class="main">‚üπ</span>
    fmrestrict_set <span class="main">(</span>insert <span class="free">xa</span> <span class="free">l1</span><span class="main">)</span> <span class="free">N</span> <span class="main">=</span> fmupd <span class="free">xa</span> <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">N</span> <span class="free">xa</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fmrestrict_set <span class="free">l1</span> <span class="free">N</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmrestrict_set_insert_in dom_m_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmrestrict_set_insert_notin_dom_m<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">xa</span>  <span class="main">‚àâ#</span> dom_m <span class="free">N</span> <span class="main">‚üπ</span>
    fmrestrict_set <span class="main">(</span>insert <span class="free">xa</span> <span class="free">l1</span><span class="main">)</span> <span class="free">N</span> <span class="main">=</span> fmrestrict_set <span class="free">l1</span> <span class="free">N</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmrestrict_set_insert_notin dom_m_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmlookup_restrict_set_id<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπfset <span class="main">(</span>fmdom <span class="free">N</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="free">A</span> <span class="main">‚üπ</span> fmrestrict_set <span class="free">A</span> <span class="free">N</span> <span class="main">=</span> <span class="free">N</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fmap_ext fmdom'_alt_def fmdom'_notD fmlookup_restrict_set subset_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmlookup_restrict_set_id'<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπset_mset <span class="main">(</span>dom_m <span class="free">N</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="free">A</span> <span class="main">‚üπ</span> fmrestrict_set <span class="free">A</span> <span class="free">N</span> <span class="main">=</span> <span class="free">N</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fmlookup_restrict_set_id<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dom_m_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ran_m_mapsto_upd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    NC<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">C</span> <span class="main">‚àà#</span> dom_m <span class="free">N</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπran_m <span class="main">(</span>fmupd <span class="free">C</span> <span class="free">C'</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> add_mset <span class="free">C'</span> <span class="main">(</span>remove1_mset <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">N</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ran_m <span class="free">N</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">N'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">N'</span> <span class="main">=</span> fmdrop <span class="free">C</span> <span class="free">N</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span> N_N'<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπdom_m <span class="free">N</span> <span class="main">=</span> add_mset <span class="free">C</span> <span class="main">(</span>dom_m <span class="skolem">N'</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> NC <span class="keyword1"><span class="command">unfolding</span></span> N'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">C</span> <span class="main">‚àâ#</span> dom_m <span class="skolem">N'</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> NC distinct_mset_dom<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">N</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> N_N' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> N_N' ran_m_def mset_set.insert_remove image_mset_remove1_mset_if
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_mset_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ran_m_mapsto_upd_notin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> NC<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">C</span> <span class="main">‚àâ#</span> dom_m <span class="free">N</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπran_m <span class="main">(</span>fmupd <span class="free">C</span> <span class="free">C'</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> add_mset <span class="free">C'</span> <span class="main">(</span>ran_m <span class="free">N</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> NC
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_m_def mset_set.insert_remove image_mset_remove1_mset_if
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_mset_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> image_mset_If_eq_notin<span class="main">:</span>
   <span class="quoted"><span class="quoted">‚Äπ<span class="free">C</span> <span class="main">‚àâ#</span> <span class="free">A</span> <span class="main">‚üπ</span> <span class="main">{#</span><span class="free">f</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">C</span> <span class="keyword1">then</span> <span class="free">a</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">b</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà#</span> <span class="free">A</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span> <span class="free">f</span><span class="main">(</span><span class="free">b</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà#</span> <span class="free">A</span> <span class="main">#}</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_mset_cong2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">‚ãÄ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà#</span> <span class="free">M</span> <span class="main">‚üπ</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">M</span> <span class="main">=</span> <span class="free">N</span> <span class="main">‚üπ</span> filter_mset <span class="free">f</span> <span class="free">M</span> <span class="main">=</span> filter_mset <span class="free">g</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">hypsubst</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> filter_mset_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ran_m_fmdrop<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">C</span> <span class="main">‚àà#</span> dom_m <span class="free">N</span> <span class="main">‚üπ</span>  ran_m <span class="main">(</span>fmdrop <span class="free">C</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> remove1_mset <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">N</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ran_m <span class="free">N</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> distinct_mset_dom<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">N</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπfmlookup <span class="free">N</span> <span class="free">C</span>‚Ä∫</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_m_def image_mset_If_eq_notin<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> fst <span class="main">(</span>the <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span>
     <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split
     <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> filter_mset_cong2 image_mset_cong2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ran_m_fmdrop_notin<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">C</span> <span class="main">‚àâ#</span> dom_m <span class="free">N</span> <span class="main">‚üπ</span> ran_m <span class="main">(</span>fmdrop <span class="free">C</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> ran_m <span class="free">N</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> distinct_mset_dom<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">N</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_m_def image_mset_If_eq_notin<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> fst <span class="main">(</span>the <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> filter_mset_cong2 image_mset_cong2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ran_m_fmdrop_If<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπran_m <span class="main">(</span>fmdrop <span class="free">C</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">C</span> <span class="main">‚àà#</span> dom_m <span class="free">N</span> <span class="keyword1">then</span> remove1_mset <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">N</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ran_m <span class="free">N</span><span class="main">)</span> <span class="keyword1">else</span> ran_m <span class="free">N</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> distinct_mset_dom<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">N</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_m_def image_mset_If_eq_notin<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> fst <span class="main">(</span>the <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> filter_mset_cong2 image_mset_cong2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dom_m_empty_iff<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπdom_m <span class="free">NU</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">‚ü∑</span> <span class="free">NU</span> <span class="main">=</span> fmempty‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">NU</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dom_m_def mset_set.insert_remove<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="WB_Sort">
<div class="head">
<h1>Theory WB_Sort</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:         WB_Sort.thy
  Author:       Mathias Fleury, Daniela Kaufmann, JKU
  Author:       Maximilian Wuttke, Saarland University
  Maintainer:   Mathias Fleury, JKU

Correctness proof contributed by Maximilian Wuttke *)</span>
<span class="keyword1"><span class="command">theory</span></span> WB_Sort
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../Refine_Imperative_HOL/IICF.html">Refine_Imperative_HOL.IICF</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Rewrite.html">HOL-Library.Rewrite</a>"</span> <a href="Duplicate_Free_Multiset.html">Duplicate_Free_Multiset</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThis a complete copy-paste of the IsaFoL version because sharing is too hard.‚Ä∫</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπEvery element between <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">lo</span></span>‚Ä∫</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">hi</span></span>‚Ä∫</span></span></span></span> can be chosen as pivot element.‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">choose_pivot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> bool<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">choose_pivot</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="main">=</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">‚â•</span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="main">‚àß</span> <span class="bound">k</span> <span class="main">‚â§</span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThe element at index <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‚Äπ</span></span>p‚Ä∫</span></span></span></span> partitions the subarray <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‚Äπ</span></span>lo..hi‚Ä∫</span></span></span></span>. This means that every element ‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isPartition_wrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> bool<span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'b</span> list <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> bool‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">isPartition_wrt</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="main">‚àÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">‚â•</span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="main">‚àß</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="main">‚àÄ</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚àß</span> <span class="bound">j</span> <span class="main">‚â§</span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> isPartition_wrtI<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="bound">i</span> <span class="main">‚â•</span> <span class="free">lo</span><span class="main">;</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="main">‚ãÄ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="bound">j</span> <span class="main">&gt;</span> <span class="free">p</span><span class="main">;</span> <span class="bound">j</span> <span class="main">‚â§</span> <span class="free">hi</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span> isPartition_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">p</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isPartition_wrt_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isPartition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="tfree">'a</span> <span class="main">::</span> order list <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> bool‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">isPartition</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚â°</span> isPartition_wrt <span class="main">(‚â§)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">isPartition_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> bool<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> bool‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">isPartition_map</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">‚â°</span> isPartition_wrt <span class="main">(</span><span class="main">Œª</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> isPartition_map_def'<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">p</span> <span class="main">‚üπ</span> <span class="free">p</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span> isPartition_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">p</span> <span class="main">=</span> isPartition_wrt <span class="free">R</span> <span class="main">(</span>map <span class="free">h</span> <span class="free">xs</span><span class="main">)</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">p</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isPartition_wrt_def conjI<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπExample: 6 is the pivot element (with index 4); <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="numeral"><span class="numeral">7</span></span>‚Ä∫</span></span></span></span> is equal to the <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπlength <span class="free"><span class="free">xs</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">1</span></span>‚Ä∫</span></span></span></span>.‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">‚ÄπisPartition <span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">6</span><span class="main">,</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">8</span><span class="main">,</span><span class="numeral">10</span><span class="main">::</span>nat<span class="main">]</span> <span class="main">0</span> <span class="numeral">7</span> <span class="numeral">4</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isPartition_def isPartition_wrt_def nth_Cons'<span class="main">)</span>



<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sublist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="tfree">'a</span> list <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> <span class="tfree">'a</span> list‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">sublist</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">‚â°</span> take <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>drop <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="comment1">(*take from HashMap *)</span>
<span class="keyword1"><span class="command">lemma</span></span> take_Suc0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">‚â†</span><span class="main">[]</span> <span class="main">‚üπ</span> take <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> <span class="main">[</span><span class="free">l</span><span class="main">!</span><span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">‚üπ</span> take <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> <span class="main">[</span><span class="free">l</span><span class="main">!</span><span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="quoted"><span class="quoted">"Suc <span class="free">n</span> <span class="main">‚â§</span> length <span class="free">l</span> <span class="main">‚üπ</span> take <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> <span class="main">[</span><span class="free">l</span><span class="main">!</span><span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sublist_single<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span> sublist <span class="free">xs</span> <span class="free">i</span> <span class="free">i</span> <span class="main">=</span> <span class="main">[</span><span class="free">xs</span><span class="main">!</span><span class="free">i</span><span class="main">]</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_def take_Suc0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_eq<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπinsert <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="free">b</span> <span class="main">‚à™</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sublist_nth<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ü¶</span><span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span><span class="main">;</span> <span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">;</span> <span class="free">k</span><span class="main">+</span><span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="main">(</span>sublist <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span><span class="main">)</span><span class="main">!</span><span class="free">k</span> <span class="main">=</span> <span class="free">xs</span><span class="main">!</span><span class="main">(</span><span class="free">lo</span><span class="main">+</span><span class="free">k</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sublist_length<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ü¶</span><span class="free">i</span> <span class="main">‚â§</span> <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">‚üß</span> <span class="main">‚üπ</span> length <span class="main">(</span>sublist <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">j</span> <span class="main">-</span> <span class="free">i</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sublist_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ü¶</span><span class="free">i</span> <span class="main">‚â§</span> <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">;</span> <span class="free">xs</span> <span class="main">‚â†</span> <span class="main">[]</span><span class="main">‚üß</span> <span class="main">‚üπ</span> sublist <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span> <span class="main">‚â†</span> <span class="main">[]</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> List.length_greater_0_conv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> sublist_length<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>



<span class="keyword1"><span class="command">lemma</span></span> sublist_app<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ü¶</span><span class="free">i1</span> <span class="main">‚â§</span> <span class="free">i2</span><span class="main">;</span> <span class="free">i2</span> <span class="main">‚â§</span> <span class="free">i3</span><span class="main">‚üß</span> <span class="main">‚üπ</span> sublist <span class="free">xs</span> <span class="free">i1</span> <span class="free">i2</span> <span class="main">@</span> sublist <span class="free">xs</span> <span class="main">(</span>Suc <span class="free">i2</span><span class="main">)</span> <span class="free">i3</span> <span class="main">=</span> sublist <span class="free">xs</span> <span class="free">i1</span> <span class="free">i3</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sublist_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Suc_eq_plus1_left Suc_le_mono append.assoc le_SucI le_add_diff_inverse le_trans same_append_eq take_add<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sorted_sublist_wrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> bool<span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'b</span> list <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> bool‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">sorted_sublist_wrt</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="main">=</span> sorted_wrt <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>sublist <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sorted_sublist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="tfree">'a</span> <span class="main">::</span> linorder list <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> bool‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">sorted_sublist</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="main">=</span> sorted_sublist_wrt <span class="main">(‚â§)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sorted_sublist_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> bool<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> bool‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">sorted_sublist_map</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="main">‚â°</span> sorted_sublist_wrt <span class="main">(</span><span class="main">Œª</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_sublist_map_def'<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span> sorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="main">‚â°</span> sorted_sublist_wrt <span class="free">R</span> <span class="main">(</span>map <span class="free">h</span> <span class="free">xs</span><span class="main">)</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_sublist_wrt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_map sorted_wrt_map sublist_def take_map<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_sublist_wrt_refl<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span> sorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">i</span> <span class="free">i</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_sublist_wrt_def sublist_single<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_sublist_refl<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span> sorted_sublist <span class="free">xs</span> <span class="free">i</span> <span class="free">i</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_sublist_def sorted_sublist_wrt_refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sublist_map<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπsublist <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">(</span>sublist <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_map take_map<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> take_set<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">j</span> <span class="main">‚â§</span> length <span class="free">xs</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àà</span> set <span class="main">(</span>take <span class="free">j</span> <span class="free">xs</span><span class="main">)</span> <span class="main">‚â°</span> <span class="main">(</span><span class="main">‚àÉ</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">‚àß</span> <span class="free">xs</span><span class="main">!</span><span class="bound">k</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_set_conv_iff less_le_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> drop_set<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">j</span> <span class="main">‚â§</span> length <span class="free">xs</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àà</span> set <span class="main">(</span>drop <span class="free">j</span> <span class="free">xs</span><span class="main">)</span> <span class="main">‚â°</span> <span class="main">(</span><span class="main">‚àÉ</span><span class="bound">k</span><span class="main">.</span> <span class="free">j</span><span class="main">‚â§</span><span class="bound">k</span><span class="main">‚àß</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="free">xs</span> <span class="main">‚àß</span> <span class="free">xs</span><span class="main">!</span><span class="bound">k</span><span class="main">=</span><span class="free">x</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Misc.in_set_drop_conv_nth<span class="main">)</span> <span class="comment1">(* lemma found by sledgehammer *)</span>

<span class="keyword1"><span class="command">lemma</span></span> sublist_el<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">i</span> <span class="main">‚â§</span> <span class="free">j</span> <span class="main">‚üπ</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àà</span> set <span class="main">(</span>sublist <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">‚â°</span> <span class="main">(</span><span class="main">‚àÉ</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> Suc <span class="free">j</span><span class="main">-</span><span class="free">i</span> <span class="main">‚àß</span> <span class="free">xs</span><span class="main">!</span><span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="bound">k</span><span class="main">)</span><span class="main">=</span><span class="free">x</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_set sublist_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sublist_el'<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">i</span> <span class="main">‚â§</span> <span class="free">j</span> <span class="main">‚üπ</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àà</span> set <span class="main">(</span>sublist <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">‚â°</span> <span class="main">(</span><span class="main">‚àÉ</span> <span class="bound">k</span><span class="main">.</span> <span class="free">i</span><span class="main">‚â§</span><span class="bound">k</span><span class="main">‚àß</span><span class="bound">k</span><span class="main">‚â§</span><span class="free">j</span> <span class="main">‚àß</span> <span class="free">xs</span><span class="main">!</span><span class="bound">k</span><span class="main">=</span><span class="free">x</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sublist_el<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Groups.add_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> le_add1 le_add_diff_inverse less_Suc_eq less_diff_conv nat_less_le order_refl<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> sublist_lt<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> <span class="free">lo</span> <span class="main">‚üπ</span> sublist <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="main">=</span> <span class="main">[]</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nat_le_eq_or_lt<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">‚â§</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">‚à®</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>


<span class="keyword1"><span class="command">lemma</span></span> sorted_sublist_wrt_le<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">‚â§</span> <span class="free">lo</span> <span class="main">‚üπ</span> <span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span> sorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_le_eq_or_lt<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> sorted_sublist_wrt_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> sublist_single<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_lt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπElements in a sorted sublists are actually sorted‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> sorted_sublist_wrt_nth_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">i</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">j</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">R</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="free">j</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">i</span> <span class="main">=</span> <span class="free">lo</span> <span class="main">+</span> <span class="skolem">i'</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> le_Suc_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">j</span> <span class="main">=</span> <span class="free">lo</span> <span class="main">+</span> <span class="skolem">j'</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> dual_order.trans le_iff_add less_imp_le_nat<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_sublist_wrt_def I J<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> sublist_nth<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> k<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">i'</span></span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> lo<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">lo</span></span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> hi<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">hi</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> sublist_nth<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> k<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">j'</span></span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> lo<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">lo</span></span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> hi<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">hi</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sorted_wrt_nth_less<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> I J nat_add_left_cancel_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_length<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπWe can make the assumption <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">i</span></span> <span class="main"><span class="main">&lt;</span></span> <span class="free"><span class="free">j</span></span>‚Ä∫</span></span></span></span> weaker if we have a reflexivie relation.‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> sorted_sublist_wrt_nth_le'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ref<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">x</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">i</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">i</span> <span class="main">‚â§</span> <span class="free">j</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">j</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">R</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="free">j</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">‚à®</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">i</span> <span class="main">‚â§</span> <span class="free">j</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>a<span class="main">)</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>‚Ä∫</span></span> <span class="main">|</span>
                <span class="main">(</span>b<span class="main">)</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">i</span> <span class="main">=</span> <span class="free">j</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> a
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-5<span class="main">,</span>7<span class="main">)</span> sorted_sublist_wrt_nth_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> b
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="comment1">(*
lemma sorted_sublist_map_nth_le:
  assumes ‚Äπsorted_sublist_map R h xs lo hi‚Ä∫ and ‚Äπlo ‚â§ hi‚Ä∫ and ‚Äπhi &lt; length xs‚Ä∫ and
    ‚Äπlo ‚â§ i‚Ä∫ and ‚Äπi &lt; j‚Ä∫ and ‚Äπj ‚â§ hi‚Ä∫
  shows ‚ÄπR (h (xs!i)) (h (xs!j))‚Ä∫
proof -
  show ?thesis
    using assms by (rule sorted_sublist_wrt_nth_le)
qed
*)</span>



<span class="keyword1"><span class="command">lemma</span></span> sorted_sublist_le<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">‚â§</span> <span class="free">lo</span> <span class="main">‚üπ</span> <span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span> sorted_sublist <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_sublist_def sorted_sublist_wrt_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_sublist_map_le<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">‚â§</span> <span class="free">lo</span> <span class="main">‚üπ</span> <span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span> sorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_sublist_wrt_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sublist_cons<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">&lt;</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span> sublist <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="main">=</span> <span class="free">xs</span><span class="main">!</span><span class="free">lo</span> <span class="main">#</span> sublist <span class="free">xs</span> <span class="main">(</span>Suc <span class="free">lo</span><span class="main">)</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons_eq_appendI append_self_conv2 less_imp_le_nat less_or_eq_imp_le less_trans
      sublist_app sublist_single<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_sublist_wrt_cons'<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπsorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="main">(</span><span class="free">lo</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">j</span><span class="main">.</span> <span class="free">lo</span><span class="main">&lt;</span><span class="bound">j</span><span class="main">‚àß</span><span class="bound">j</span><span class="main">‚â§</span><span class="free">hi</span> <span class="main">‚ü∂</span> <span class="free">R</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="free">lo</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span> sorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_le_eq_or_lt sorted_sublist_wrt_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 5 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_cons sublist_el less_diff_conv add.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">lo</span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Suc_lessI sublist_single<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_sublist_wrt_cons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚ãÄ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span> <span class="free">R</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπsorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="main">(</span><span class="free">lo</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span> ‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">R</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="free">lo</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="main">(</span><span class="free">lo</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sorted_sublist_wrt_cons'<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> assms' <span class="keyword2"><span class="keyword">for</span></span> j
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">j</span><span class="main">=</span><span class="free">lo</span><span class="main">+</span><span class="main">1</span> <span class="main">‚à®</span> <span class="skolem">j</span><span class="main">&gt;</span><span class="free">lo</span><span class="main">+</span><span class="main">1</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">using</span></span> assms'<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">j</span><span class="main">=</span><span class="free">lo</span><span class="main">+</span><span class="main">1</span>‚Ä∫</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A assms'<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">j</span><span class="main">&gt;</span><span class="free">lo</span><span class="main">+</span><span class="main">1</span>‚Ä∫</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sorted_sublist_wrt_nth_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span><span class="main">+</span><span class="main">1</span>‚Ä∫</span></span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> A assms'<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms'<span class="main">(</span>3<span class="main">)</span> less_imp_diff_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms'<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms'<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_sublist_map_cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚ãÄ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span><span class="main">;</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span>
    sorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="main">(</span><span class="free">lo</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="free">lo</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="main">(</span><span class="free">lo</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span> sorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sorted_sublist_wrt_cons<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> sublist_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">&lt;</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span> sublist <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="main">=</span> sublist <span class="free">xs</span> <span class="free">lo</span> <span class="main">(</span><span class="free">hi</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">xs</span><span class="main">!</span><span class="free">hi</span><span class="main">]</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_def<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lo</span> <span class="main">&lt;</span> <span class="free">hi</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="free">lo</span> <span class="free">xs</span> <span class="main">@</span> take <span class="main">(</span>Suc <span class="free">hi</span> <span class="main">-</span> <span class="free">lo</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">lo</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>take <span class="free">lo</span> <span class="free">xs</span> <span class="main">@</span> take <span class="main">(</span><span class="free">hi</span> <span class="main">-</span> <span class="free">lo</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">lo</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">xs</span> <span class="main">!</span> <span class="free">hi</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc_diff_le add_Suc_right hd_drop_conv_nth le_add_diff_inverse less_imp_le_nat take_add take_hd_drop<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="free">hi</span> <span class="main">-</span> <span class="free">lo</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">lo</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span><span class="free">hi</span> <span class="main">-</span> <span class="free">lo</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">lo</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">xs</span> <span class="main">!</span> <span class="free">hi</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_sublist_wrt_snoc'<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπsorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="main">(</span><span class="free">hi</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">j</span><span class="main">.</span> <span class="free">lo</span><span class="main">‚â§</span><span class="bound">j</span><span class="main">‚àß</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">hi</span> <span class="main">‚ü∂</span> <span class="free">R</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="free">hi</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span> sorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_sublist_wrt_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_le_eq_or_lt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_single<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_snoc sublist_el sorted_wrt_append add.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">lo</span></span><span class="main"><span class="main">]</span></span> less_diff_conv
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> leI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span>nat_le_eq_or_lt<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> sorted_sublist_wrt_snoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚ãÄ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span> <span class="free">R</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπsorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="main">(</span><span class="free">hi</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">R</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="main">(</span><span class="free">hi</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="free">hi</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sorted_sublist_wrt_snoc'<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> assms' <span class="keyword2"><span class="keyword">for</span></span> j
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">j</span><span class="main">=</span><span class="free">hi</span><span class="main">-</span><span class="main">1</span> <span class="main">‚à®</span> <span class="skolem">j</span><span class="main">&lt;</span><span class="free">hi</span><span class="main">-</span><span class="main">1</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">using</span></span> assms'<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">j</span><span class="main">=</span><span class="free">hi</span><span class="main">-</span><span class="main">1</span>‚Ä∫</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A assms'<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">j</span><span class="main">&lt;</span><span class="free">hi</span><span class="main">-</span><span class="main">1</span>‚Ä∫</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sorted_sublist_wrt_nth_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span><span class="main">-</span><span class="main">1</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 6
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> A assms'<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms'<span class="main">(</span>3<span class="main">)</span> less_imp_diff_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms'<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sublist_split<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">lo</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">‚üπ</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span> sublist <span class="free">xs</span> <span class="free">lo</span> <span class="free">p</span> <span class="main">@</span> sublist <span class="free">xs</span> <span class="main">(</span><span class="free">p</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">hi</span> <span class="main">=</span> sublist <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_app<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sublist_split_part<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">lo</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">‚üπ</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span> sublist <span class="free">xs</span> <span class="free">lo</span> <span class="main">(</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">@</span> <span class="free">xs</span><span class="main">!</span><span class="free">p</span> <span class="main">#</span> sublist <span class="free">xs</span> <span class="main">(</span><span class="free">p</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">hi</span> <span class="main">=</span> sublist <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_split<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sublist_snoc<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">xs</span></span><span class="main"><span class="main">,</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> lo<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">lo</span></span><span class="main"><span class="main">,</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> hi<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">p</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπA property for partitions (we always assume that <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">R</span></span>‚Ä∫</span></span></span></span> is transitive.‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> isPartition_wrt_trans<span class="main">:</span>
<span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚ãÄ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span> <span class="free">R</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">)</span> <span class="main">‚üπ</span>
  isPartition_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">p</span> <span class="main">‚üπ</span>
  <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">lo</span> <span class="main">‚â§</span> <span class="bound">i</span> <span class="main">‚àß</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">‚àß</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">‚àß</span> <span class="bound">j</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚ü∂</span> <span class="free">R</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isPartition_wrt_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> isPartition_map_trans<span class="main">:</span>
<span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚ãÄ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span><span class="main">;</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span>
  <span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span>
  isPartition_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">p</span> <span class="main">‚üπ</span>
  <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">lo</span> <span class="main">‚â§</span> <span class="bound">i</span> <span class="main">‚àß</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">‚àß</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">‚àß</span> <span class="bound">j</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚ü∂</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isPartition_wrt_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> merge_sorted_wrt_partitions_between'<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">lo</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">‚üπ</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span>
    isPartition_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">p</span> <span class="main">‚üπ</span>
    sorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="main">(</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">‚üπ</span> sorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="main">(</span><span class="free">p</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">hi</span> <span class="main">‚üπ</span>
    <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">lo</span> <span class="main">‚â§</span> <span class="bound">i</span> <span class="main">‚àß</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">‚àß</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">‚àß</span> <span class="bound">j</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚ü∂</span> <span class="free">R</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span>
    sorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isPartition_def isPartition_wrt_def sorted_sublist_def sorted_sublist_wrt_def sublist_map<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_split_part<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> List.sorted_wrt_append<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_el<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_el<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_el'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> merge_sorted_wrt_partitions_between<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚ãÄ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span> <span class="free">R</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">)</span> <span class="main">‚üπ</span>
    isPartition_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">p</span> <span class="main">‚üπ</span>
    sorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="main">(</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">‚üπ</span> sorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="main">(</span><span class="free">p</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">hi</span> <span class="main">‚üπ</span>
    <span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span> <span class="free">lo</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">‚üπ</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span>
    sorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_sorted_wrt_partitions_between' isPartition_wrt_trans<span class="main">)</span>


<span class="comment1">(*
lemma merge_sorted_map_partitions_between:
  ‚Äπ(‚ãÄ x y z. ‚ü¶R (h x) (h y); R (h y) (h z)‚üß ‚üπ R (h x) (h z)) ‚üπ
    isPartition_map R h xs lo hi p ‚üπ
    sorted_sublist_map R h xs lo (p-1) ‚üπ sorted_sublist_map R h xs (p+1) hi ‚üπ
    lo ‚â§ hi ‚üπ hi &lt; length xs ‚üπ lo &lt; p ‚üπ p &lt; hi ‚üπ hi &lt; length xs ‚üπ
    sorted_sublist_map R h xs lo hi‚Ä∫
  by (simp add: merge_sorted_wrt_partitions_between' isPartition_map_trans)
*)</span>




<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThe main theorem to merge sorted lists‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> merge_sorted_wrt_partitions<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπisPartition_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">p</span> <span class="main">‚üπ</span>
    sorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">‚üπ</span> sorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="main">(</span>Suc <span class="free">p</span><span class="main">)</span> <span class="free">hi</span> <span class="main">‚üπ</span>
    <span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">lo</span> <span class="main">‚â§</span> <span class="free">p</span> <span class="main">‚üπ</span> <span class="free">p</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span>
    <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">lo</span> <span class="main">‚â§</span> <span class="bound">i</span> <span class="main">‚àß</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">‚àß</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">‚àß</span> <span class="bound">j</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚ü∂</span> <span class="free">R</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span>
    sorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span><span class="main">=</span><span class="free">p</span><span class="main">‚àß</span><span class="free">p</span><span class="main">=</span><span class="free">hi</span> <span class="main">‚à®</span> <span class="free">lo</span><span class="main">=</span><span class="free">p</span><span class="main">‚àß</span><span class="free">p</span><span class="main">&lt;</span><span class="free">hi</span> <span class="main">‚à®</span> <span class="free">lo</span><span class="main">&lt;</span><span class="free">p</span><span class="main">‚àß</span><span class="free">p</span><span class="main">=</span><span class="free">hi</span> <span class="main">‚à®</span> <span class="free">lo</span><span class="main">&lt;</span><span class="free">p</span><span class="main">‚àß</span><span class="free">p</span><span class="main">&lt;</span><span class="free">hi</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="comment1">‚Äï ‚Äπlo=p=hi‚Ä∫</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sorted_sublist_wrt_refl<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="comment1">‚Äï ‚Äπlo=p&lt;hi‚Ä∫</span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isPartition_def isPartition_wrt_def sorted_sublist_wrt_cons'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="comment1">‚Äï ‚Äπlo&lt;p=hi‚Ä∫</span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isPartition_def isPartition_wrt_def sorted_sublist_wrt_snoc'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="comment1">‚Äï ‚Äπlo&lt;p&lt;hi‚Ä∫</span>
        <span class="keyword1"><span class="command">using</span></span> assms
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> merge_sorted_wrt_partitions_between'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">p</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> merge_sorted_map_partitions<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚ãÄ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span><span class="main">;</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span>
    isPartition_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">p</span> <span class="main">‚üπ</span>
    sorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="free">lo</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">‚üπ</span> sorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="main">(</span>Suc <span class="free">p</span><span class="main">)</span> <span class="free">hi</span> <span class="main">‚üπ</span>
    <span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">lo</span> <span class="main">‚â§</span> <span class="free">p</span> <span class="main">‚üπ</span> <span class="free">p</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span>
    sorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> merge_sorted_wrt_partitions<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_sorted_wrt_partitions isPartition_map_trans<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> partition_wrt_extend<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπisPartition_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo'</span> <span class="free">hi'</span> <span class="free">p</span> <span class="main">‚üπ</span>
  <span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span>
  <span class="free">lo</span> <span class="main">‚â§</span> <span class="free">lo'</span> <span class="main">‚üπ</span> <span class="free">lo'</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">hi'</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚üπ</span>
  <span class="free">lo'</span> <span class="main">‚â§</span> <span class="free">p</span> <span class="main">‚üπ</span> <span class="free">p</span> <span class="main">‚â§</span> <span class="free">hi'</span> <span class="main">‚üπ</span>
  <span class="main">(</span><span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">lo</span><span class="main">‚â§</span><span class="bound">i</span> <span class="main">‚üπ</span> <span class="bound">i</span> <span class="main">&lt;</span><span class="free">lo'</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span>
  <span class="main">(</span><span class="main">‚ãÄ</span> <span class="bound">j</span><span class="main">.</span> <span class="free">hi'</span><span class="main">&lt;</span><span class="bound">j</span> <span class="main">‚üπ</span> <span class="bound">j</span><span class="main">‚â§</span><span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span>
  isPartition_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">p</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> isPartition_wrt_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> leI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> partition_map_extend<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπisPartition_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="free">lo'</span> <span class="free">hi'</span> <span class="free">p</span> <span class="main">‚üπ</span>
  <span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span>
  <span class="free">lo</span> <span class="main">‚â§</span> <span class="free">lo'</span> <span class="main">‚üπ</span> <span class="free">lo'</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">hi'</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚üπ</span>
  <span class="free">lo'</span> <span class="main">‚â§</span> <span class="free">p</span> <span class="main">‚üπ</span> <span class="free">p</span> <span class="main">‚â§</span> <span class="free">hi'</span> <span class="main">‚üπ</span>
  <span class="main">(</span><span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">lo</span><span class="main">‚â§</span><span class="bound">i</span> <span class="main">‚üπ</span> <span class="bound">i</span> <span class="main">&lt;</span><span class="free">lo'</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span>
  <span class="main">(</span><span class="main">‚ãÄ</span> <span class="bound">j</span><span class="main">.</span> <span class="free">hi'</span><span class="main">&lt;</span><span class="bound">j</span> <span class="main">‚üπ</span> <span class="bound">j</span><span class="main">‚â§</span><span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span>
  isPartition_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">p</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_wrt_extend<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> isPartition_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚ãÄ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">lo</span> <span class="main">&lt;</span> <span class="bound">j</span><span class="main">;</span> <span class="bound">j</span> <span class="main">‚â§</span> <span class="free">hi</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">lo</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span>
  isPartition_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">lo</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isPartition_wrt_def<span class="main">)</span>



<span class="keyword1"><span class="command">lemma</span></span> take_ext<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚àÄ</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">‚üπ</span>
  <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span> <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">xs'</span> <span class="main">‚üπ</span>
  take <span class="free">k</span> <span class="free">xs'</span> <span class="main">=</span> take <span class="free">k</span> <span class="free">xs</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_take_lemma<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> drop_ext'<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚àÄ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">‚â•</span><span class="free">k</span> <span class="main">‚àß</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">xs</span> <span class="main">‚ü∂</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">‚üπ</span>
   <span class="main">0</span><span class="main">&lt;</span><span class="free">k</span> <span class="main">‚üπ</span> <span class="free">xs</span><span class="main">‚â†</span><span class="main">[]</span> <span class="main">‚üπ</span> <span class="comment1">‚Äï ‚ÄπThese corner cases will be dealt with in the next lemma‚Ä∫</span>
   length <span class="free">xs'</span><span class="main">=</span>length <span class="free">xs</span> <span class="main">‚üπ</span>
   drop <span class="free">k</span> <span class="free">xs'</span> <span class="main">=</span> drop <span class="free">k</span> <span class="free">xs</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">‚Äπdrop <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>‚Ä∫</span></span></span> List.rev_rev_ident<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> drop <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>‚Ä∫</span></span></span> List.rev_rev_ident<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">‚åë</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>‚Ä∫</span></span></span> List.drop_rev<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>‚Ä∫</span></span></span> List.drop_rev<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> take_ext<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> drop_ext<span class="main">:</span>
<span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚àÄ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">‚â•</span><span class="free">k</span> <span class="main">‚àß</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">xs</span> <span class="main">‚ü∂</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">‚üπ</span>
   length <span class="free">xs'</span><span class="main">=</span>length <span class="free">xs</span> <span class="main">‚üπ</span>
   drop <span class="free">k</span> <span class="free">xs'</span> <span class="main">=</span> drop <span class="free">k</span> <span class="free">xs</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> drop_ext'<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> sublist_ext'<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚àÄ</span><span class="bound">i</span><span class="main">.</span> <span class="free">lo</span><span class="main">‚â§</span><span class="bound">i</span><span class="main">‚àß</span><span class="bound">i</span><span class="main">‚â§</span><span class="free">hi</span> <span class="main">‚ü∂</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">‚üπ</span>
   length <span class="free">xs'</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">‚üπ</span>
   <span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚üπ</span> Suc <span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span>
   sublist <span class="free">xs'</span> <span class="free">lo</span> <span class="free">hi</span> <span class="main">=</span> sublist <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> take_ext<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> lt_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">‚à®</span> Suc <span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sublist_until_end_eq_drop<span class="main">:</span> <span class="quoted"><span class="quoted">‚ÄπSuc <span class="free">hi</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">‚üπ</span> sublist <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="main">=</span> drop <span class="free">lo</span> <span class="free">xs</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sublist_ext<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚àÄ</span><span class="bound">i</span><span class="main">.</span> <span class="free">lo</span><span class="main">‚â§</span><span class="bound">i</span><span class="main">‚àß</span><span class="bound">i</span><span class="main">‚â§</span><span class="free">hi</span> <span class="main">‚ü∂</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">‚üπ</span>
   length <span class="free">xs'</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">‚üπ</span>
   <span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚üπ</span> <span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span>
   sublist <span class="free">xs'</span> <span class="free">lo</span> <span class="free">hi</span> <span class="main">=</span> sublist <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lt_Suc<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">hi</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_until_end_eq_drop drop_ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_ext'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_wrt_lower_sublist_still_sorted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="free">lo</span> <span class="main">(</span><span class="free">lo'</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">lo'</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo'</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚àÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">lo</span><span class="main">‚â§</span><span class="bound">i</span><span class="main">‚àß</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">lo'</span> <span class="main">‚ü∂</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπlength <span class="free">xs'</span> <span class="main">=</span> length <span class="free">xs</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_wrt <span class="free">R</span> <span class="free">xs'</span> <span class="free">lo</span> <span class="main">(</span><span class="free">lo'</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">&lt;</span> <span class="free">lo'</span> <span class="main">-</span> <span class="main">1</span> <span class="main">‚à®</span> <span class="free">lo</span> <span class="main">‚â•</span> <span class="free">lo'</span><span class="main">-</span><span class="main">1</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="comment1">‚Äï ‚Äπlo &lt; lo' - 1‚Ä∫</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_sublist_wrt_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> sublist_ext<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">xs</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_sublist_wrt_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="comment1">‚Äï ‚Äπlo &gt;= lo' - 1‚Ä∫</span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_sublist_wrt_le<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_map_lower_sublist_still_sorted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="free">lo</span> <span class="main">(</span><span class="free">lo'</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">lo'</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo'</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚àÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">lo</span><span class="main">‚â§</span><span class="bound">i</span><span class="main">‚àß</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">lo'</span> <span class="main">‚ü∂</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπlength <span class="free">xs'</span> <span class="main">=</span> length <span class="free">xs</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs'</span> <span class="free">lo</span> <span class="main">(</span><span class="free">lo'</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_wrt_lower_sublist_still_sorted<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_wrt_upper_sublist_still_sorted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="main">(</span><span class="free">hi'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">lo'</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÄ</span> <span class="bound">j</span><span class="main">.</span> <span class="free">hi'</span><span class="main">&lt;</span><span class="bound">j</span><span class="main">‚àß</span><span class="bound">j</span><span class="main">‚â§</span><span class="free">hi</span> <span class="main">‚ü∂</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">j</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">j</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπlength <span class="free">xs'</span> <span class="main">=</span> length <span class="free">xs</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_wrt <span class="free">R</span> <span class="free">xs'</span> <span class="main">(</span><span class="free">hi'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">hi</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi'</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">hi</span> <span class="main">‚à®</span> <span class="free">hi'</span> <span class="main">+</span> <span class="main">1</span> <span class="main">‚â•</span> <span class="free">hi</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="comment1">‚Äï ‚Äπhi' + 1 &lt; h‚Ä∫</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_sublist_wrt_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> sublist_ext<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">xs</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_sublist_wrt_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="comment1">‚Äï ‚Äπ<span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span><span class="quoted">‚Äπ<span class="free">hi'</span> <span class="main">+</span> <span class="main">1</span> <span class="main">‚â•</span> <span class="free">hi</span>‚Ä∫</span></span>‚Ä∫</span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_sublist_wrt_le<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_map_upper_sublist_still_sorted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="main">(</span><span class="free">hi'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">lo'</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÄ</span> <span class="bound">j</span><span class="main">.</span> <span class="free">hi'</span><span class="main">&lt;</span><span class="bound">j</span><span class="main">‚àß</span><span class="bound">j</span><span class="main">‚â§</span><span class="free">hi</span> <span class="main">‚ü∂</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">j</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">j</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπlength <span class="free">xs'</span> <span class="main">=</span> length <span class="free">xs</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs'</span> <span class="main">(</span><span class="free">hi'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_wrt_upper_sublist_still_sorted<span class="main">)</span>







<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThe specification of the partition function‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">partition_spec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> bool<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> nat <span class="main">‚áí</span> bool‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">partition_spec</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚â°</span>
    mset <span class="free"><span class="bound"><span class="entity">xs'</span></span></span> <span class="main">=</span> mset <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">‚àß</span> <span class="comment1">‚Äï ‚ÄπThe list is a permutation‚Ä∫</span>
    isPartition_map <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚àß</span> <span class="comment1">‚Äï ‚ÄπWe have a valid partition on the resulting list‚Ä∫</span>
    <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="main">‚â§</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚â§</span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="main">‚àß</span> <span class="comment1">‚Äï ‚ÄπThe partition index is in bounds‚Ä∫</span>
    <span class="main">(</span><span class="main">‚àÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="main">‚àÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">&lt;</span><span class="bound">i</span><span class="main">‚àß</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">xs'</span></span></span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>‚Ä∫</span></span> <span class="comment1">‚Äï ‚ÄπEverything else is unchanged.‚Ä∫</span>

<span class="keyword1"><span class="command">lemma</span></span> in_set_take_conv_nth<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">x</span> <span class="main">‚àà</span> set <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">‚ü∑</span> <span class="main">(</span><span class="main">‚àÉ</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span>min <span class="free">n</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">m</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth length_take min.commute min.strict_boundedE nth_take<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_drop_upto<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="main">(</span>drop <span class="free">a</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#</span><span class="free">N</span><span class="main">!</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">‚àà#</span> mset_set <span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span>length <span class="free">N</span><span class="main">}</span><span class="main">#}</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">N</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">c</span> <span class="skolem">N</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> upt<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>length <span class="skolem">N</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> insert <span class="main">0</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span>Suc <span class="main">(</span>length <span class="skolem">N</span><span class="main">)</span><span class="main">}</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset_set <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>length <span class="skolem">N</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> add_mset <span class="main">0</span> <span class="main">(</span>mset_set <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span>Suc <span class="main">(</span>length <span class="skolem">N</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> upt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> mset_case_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{#</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">‚áí</span> <span class="skolem">c</span> <span class="main">|</span> Suc <span class="bound">x</span> <span class="main">‚áí</span> <span class="skolem">N</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà#</span> mset_set <span class="main">{</span>Suc <span class="skolem">a</span><span class="main">..&lt;</span>Suc <span class="skolem">b</span><span class="main">}</span><span class="main">#}</span> <span class="main">=</span>
    <span class="main">{#</span><span class="skolem">N</span> <span class="main">!</span> <span class="main">(</span><span class="bound">x</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà#</span> mset_set <span class="main">{</span>Suc <span class="skolem">a</span><span class="main">..&lt;</span>Suc <span class="skolem">b</span><span class="main">}</span><span class="main">#}</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_mset_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Suc_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{</span>Suc <span class="skolem">a</span><span class="main">..&lt;</span>Suc <span class="skolem">b</span><span class="main">}</span> <span class="main">=</span> Suc <span class="main">`</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..&lt;</span><span class="skolem">b</span><span class="main">}</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mset_set_Suc_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset_set <span class="main">{</span>Suc <span class="skolem">a</span><span class="main">..&lt;</span>Suc <span class="skolem">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">{#</span>Suc <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">‚àà#</span> mset_set <span class="main">{</span><span class="skolem">a</span><span class="main">..&lt;</span><span class="skolem">b</span><span class="main">}</span><span class="main">#}</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">unfolding</span></span> Suc_Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> image_mset_mset_set<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{#</span><span class="skolem">N</span> <span class="main">!</span> <span class="main">(</span><span class="bound">x</span><span class="main">-</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà#</span> mset_set <span class="main">{</span>Suc <span class="skolem">a</span><span class="main">..&lt;</span>Suc <span class="skolem">b</span><span class="main">}</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span><span class="skolem">N</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà#</span> mset_set <span class="main">{</span><span class="skolem">a</span><span class="main">..&lt;</span><span class="skolem">b</span><span class="main">}</span><span class="main">#}</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_set_Suc_Suc multiset.map_comp comp_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons drop_Cons H mset_case_Suc *<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Actually, I only need that ‚Äπset (sublist xs' lo hi) = set (sublist xs lo hi)‚Ä∫ *)</span>
<span class="keyword1"><span class="command">lemma</span></span> mathias<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
        Perm<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs'</span> <span class="main">=</span> mset <span class="free">xs</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span><span class="main">‚â§</span><span class="free">i</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">i</span><span class="main">‚â§</span><span class="free">hi</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs'</span><span class="main">!</span><span class="free">i</span><span class="main">=</span><span class="free">x</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Bounds<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Fix<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">lo</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">xs</span><span class="main">!</span><span class="bound">i</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">hi</span><span class="main">&lt;</span><span class="bound">j</span><span class="main">;</span> <span class="bound">j</span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> <span class="free">xs</span><span class="main">!</span><span class="bound">j</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÉ</span><span class="bound">j</span><span class="main">.</span> <span class="free">lo</span><span class="main">‚â§</span><span class="bound">j</span><span class="main">‚àß</span><span class="bound">j</span><span class="main">‚â§</span><span class="free">hi</span> <span class="main">‚àß</span> <span class="free">xs</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> <span class="free">x</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs1</span></span> <span class="skolem"><span class="skolem">xs2</span></span> <span class="skolem"><span class="skolem">xs3</span></span> <span class="skolem"><span class="skolem">xs1'</span></span> <span class="skolem"><span class="skolem">xs2'</span></span> <span class="skolem"><span class="skolem">xs3'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
     <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">xs1</span> <span class="main">=</span> take <span class="free">lo</span> <span class="free">xs</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
     <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">xs2</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="free">hi</span> <span class="main">-</span> <span class="free">lo</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">lo</span> <span class="free">xs</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
     <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">xs3</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="free">hi</span><span class="main">)</span> <span class="free">xs</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
     <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">xs1'</span> <span class="main">=</span> take <span class="free">lo</span> <span class="free">xs'</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
     <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">xs2'</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="free">hi</span> <span class="main">-</span> <span class="free">lo</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">lo</span> <span class="free">xs'</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
     <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">xs3'</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="free">hi</span><span class="main">)</span> <span class="free">xs'</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπlength <span class="free">xs'</span> <span class="main">=</span> length <span class="free">xs</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> Perm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_length<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="skolem">xs1</span> <span class="main">=</span> mset <span class="skolem">xs1'</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> Fix<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> xs1_def xs1'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Perm le_cases mset_eq_length nth_take_lemma take_all<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="skolem">xs3</span> <span class="main">=</span> mset <span class="skolem">xs3'</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> Fix<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> xs3_def xs3'_def mset_drop_upto
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> image_mset_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs</span> <span class="main">=</span> <span class="skolem">xs1</span> <span class="main">@</span> <span class="skolem">xs2</span> <span class="main">@</span> <span class="skolem">xs3</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs'</span> <span class="main">=</span> <span class="skolem">xs1'</span> <span class="main">@</span> <span class="skolem">xs2'</span> <span class="main">@</span> <span class="skolem">xs3'</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">unfolding</span></span> xs1_def xs2_def xs3_def xs1'_def xs2'_def xs3'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append.assoc append_take_drop_id le_SucI le_add_diff_inverse order_trans take_add<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="skolem">xs2</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="free">lo</span><span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">i</span> <span class="main">‚â•</span> length <span class="skolem">xs1</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> I Bounds <span class="keyword1"><span class="command">unfolding</span></span> xs2_def xs1_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_take min_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">‚Äπ<span class="free">x</span> <span class="main">‚àà</span> set <span class="skolem">xs2'</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> I Bounds <span class="keyword1"><span class="command">unfolding</span></span> xs2'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_take_conv_nth
       <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">i</span> <span class="main">-</span> <span class="free">lo</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x</span> <span class="main">‚àà</span> set <span class="skolem">xs2</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> Perm I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_setD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs</span> <span class="main">!</span> <span class="main">(</span><span class="free">lo</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">j</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">-</span> <span class="free">lo</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> in_set_conv_nth xs2_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Bounds I
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span><span class="main">+</span><span class="skolem">j</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπIf we fix the left and right rest of two permutated lists, then the sublists are also permutations.‚Ä∫</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπBut we only need that the sets are equal.‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> mset_sublist_incl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Perm<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs'</span> <span class="main">=</span> mset <span class="free">xs</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Fix<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">lo</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">xs</span><span class="main">!</span><span class="bound">i</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">hi</span><span class="main">&lt;</span><span class="bound">j</span><span class="main">;</span> <span class="bound">j</span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> <span class="free">xs</span><span class="main">!</span><span class="bound">j</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bounds<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπset <span class="main">(</span>sublist <span class="free">xs'</span> <span class="free">lo</span> <span class="free">hi</span><span class="main">)</span> <span class="main">‚äÜ</span> set <span class="main">(</span>sublist <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x</span> <span class="main">‚àà</span> set <span class="main">(</span>sublist <span class="free">xs'</span> <span class="free">lo</span> <span class="free">hi</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÉ</span><span class="bound">i</span><span class="main">.</span> <span class="free">lo</span><span class="main">‚â§</span><span class="bound">i</span><span class="main">‚àß</span><span class="bound">i</span><span class="main">‚â§</span><span class="free">hi</span> <span class="main">‚àß</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="skolem">x</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bounds<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bounds<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> size_mset sublist_el'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span><span class="main">‚â§</span><span class="skolem">i</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">i</span><span class="main">‚â§</span><span class="free">hi</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs'</span><span class="main">!</span><span class="skolem">i</span><span class="main">=</span><span class="skolem">x</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÉ</span><span class="bound">j</span><span class="main">.</span> <span class="free">lo</span><span class="main">‚â§</span><span class="bound">j</span><span class="main">‚àß</span><span class="bound">j</span><span class="main">‚â§</span><span class="free">hi</span> <span class="main">‚àß</span> <span class="free">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">=</span><span class="skolem">x</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> Perm I bounds<span class="main">(</span>2<span class="main">)</span> Fix <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mathias<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x</span> <span class="main">‚àà</span> set <span class="main">(</span>sublist <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bounds<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bounds<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sublist_el'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> mset_sublist_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs'</span> <span class="main">=</span> mset <span class="free">xs</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">lo</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">xs</span><span class="main">!</span><span class="bound">i</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">hi</span><span class="main">&lt;</span><span class="bound">j</span><span class="main">;</span> <span class="bound">j</span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> <span class="free">xs</span><span class="main">!</span><span class="bound">j</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bounds<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπset <span class="main">(</span>sublist <span class="free">xs'</span> <span class="free">lo</span> <span class="free">hi</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>sublist <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπset <span class="main">(</span>sublist <span class="free">xs'</span> <span class="free">lo</span> <span class="free">hi</span><span class="main">)</span> <span class="main">‚äÜ</span> set <span class="main">(</span>sublist <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mset_sublist_incl<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπset <span class="main">(</span>sublist <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span><span class="main">)</span> <span class="main">‚äÜ</span> set <span class="main">(</span>sublist <span class="free">xs'</span> <span class="free">lo</span> <span class="free">hi</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mset_sublist_incl<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> assms size_mset<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπOur abstract recursive quicksort procedure. We abstract over a partition procedure.‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">quicksort</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> bool<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> nat <span class="main">√ó</span> nat <span class="main">√ó</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> list nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">quicksort</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">lo</span><span class="main">,</span><span class="bound">hi</span><span class="main">,</span><span class="bound">xs0</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
  RECT <span class="main">(</span><span class="main">Œª</span><span class="bound">f</span> <span class="main">(</span><span class="bound">lo</span><span class="main">,</span><span class="bound">hi</span><span class="main">,</span><span class="bound">xs</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      ASSERT<span class="main">(</span><span class="bound">lo</span> <span class="main">‚â§</span> <span class="bound">hi</span> <span class="main">‚àß</span> <span class="bound">hi</span> <span class="main">&lt;</span> length <span class="bound">xs</span> <span class="main">‚àß</span> mset <span class="bound">xs</span> <span class="main">=</span> mset <span class="bound">xs0</span><span class="main">)</span><span class="main">;</span> <span class="comment1">‚Äï ‚ÄπPremise for a partition function‚Ä∫</span>
      <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">‚Üê</span> SPEC<span class="main">(</span>uncurry <span class="main">(</span>partition_spec <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="bound">xs</span> <span class="bound">lo</span> <span class="bound">hi</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="comment1">‚Äï ‚ÄπAbstract partition function‚Ä∫</span>
      ASSERT<span class="main">(</span>mset <span class="bound">xs</span> <span class="main">=</span> mset <span class="bound">xs0</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">xs</span> <span class="main">‚Üê</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">p</span><span class="main">-</span><span class="main">1</span><span class="main">‚â§</span><span class="bound">lo</span> <span class="keyword1">then</span> RETURN <span class="bound">xs</span> <span class="keyword1">else</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">lo</span><span class="main">,</span> <span class="bound">p</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      ASSERT<span class="main">(</span>mset <span class="bound">xs</span> <span class="main">=</span> mset <span class="bound">xs0</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">if</span> <span class="bound">hi</span><span class="main">‚â§</span><span class="bound">p</span><span class="main">+</span><span class="main">1</span> <span class="keyword1">then</span> RETURN <span class="bound">xs</span> <span class="keyword1">else</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">p</span><span class="main">+</span><span class="main">1</span><span class="main">,</span> <span class="bound">hi</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span>
    <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="bound">lo</span><span class="main">,</span><span class="bound">hi</span><span class="main">,</span><span class="bound">xs0</span><span class="main">)</span>
  <span class="main">}</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπAs premise for quicksor, we only need that the indices are ok.‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">quicksort_pre</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> bool<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span>  nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> bool‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">quicksort_pre</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">xs0</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="main">‚â§</span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">‚àß</span> mset <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> mset <span class="free"><span class="bound"><span class="entity">xs0</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">quicksort_post</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> bool<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> bool‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">quicksort_post</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span> <span class="main">‚â°</span>
    mset <span class="free"><span class="bound"><span class="entity">xs'</span></span></span> <span class="main">=</span> mset <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">‚àß</span>
    sorted_sublist_map <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="main">‚àß</span>
    <span class="main">(</span><span class="main">‚àÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">‚àß</span>
    <span class="main">(</span><span class="main">‚àÄ</span> <span class="bound">j</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">&lt;</span><span class="bound">j</span><span class="main">‚àß</span><span class="bound">j</span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">!</span><span class="bound">j</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπConvert Pure to HOL‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> quicksort_postI<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ü¶</span>mset <span class="free">xs'</span> <span class="main">=</span> mset <span class="free">xs</span><span class="main">;</span> sorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs'</span> <span class="free">lo</span> <span class="free">hi</span><span class="main">;</span> <span class="main">(</span><span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">lo</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="main">‚ãÄ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">hi</span><span class="main">&lt;</span><span class="bound">j</span><span class="main">;</span> <span class="bound">j</span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> <span class="free">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">‚üß</span> <span class="main">‚üπ</span> quicksort_post <span class="free">R</span> <span class="free">h</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs</span> <span class="free">xs'</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_post_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThe first case for the correctness proof of (abstract) quicksort: We assume that we called the partition function, and we have <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">p</span></span><span class="main"><span class="main">-</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">‚â§</span></span><span class="free"><span class="free">lo</span></span>‚Ä∫</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">hi</span></span><span class="main"><span class="main">‚â§</span></span><span class="free"><span class="free">p</span></span><span class="main"><span class="main">+</span></span><span class="main"><span class="main">1</span></span>‚Ä∫</span></span></span></span>.‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> quicksort_correct_case1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span><span class="main">;</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> lin<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">‚â†</span> <span class="bound">y</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">‚à®</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπquicksort_pre <span class="free">R</span> <span class="free">h</span> <span class="free">xs0</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπpartition_spec <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs'</span> <span class="free">p</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ifs<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span><span class="main">-</span><span class="main">1</span> <span class="main">‚â§</span> <span class="free">lo</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">‚â§</span> <span class="free">p</span><span class="main">+</span><span class="main">1</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπquicksort_post <span class="free">R</span> <span class="free">h</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs</span> <span class="free">xs'</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπFirst boilerplate code step: 'unfold' the HOL definitions in the assumptions and convert them to Pure‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> pre <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_pre_def<span class="main">)</span>
<span class="comment1">(*
  have part_perm: ‚Äπset (sublist xs' lo hi) = set (sublist xs lo hi)‚Ä∫
    using part partition_spec_set_sublist pre(1) pre(2) by blast
*)</span>
  <span class="keyword1"><span class="command">have</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs'</span> <span class="main">=</span> mset <span class="free">xs</span>‚Ä∫</span></span> <span class="quoted">True</span>
    <span class="quoted"><span class="quoted">‚ÄπisPartition_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs'</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">p</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">p</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">lo</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">hi</span><span class="main">&lt;</span><span class="bound">i</span><span class="main">;</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">xs'</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> part <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_spec_def<span class="main">)</span>


  <span class="keyword1"><span class="command">have</span></span> sorted_lower<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs'</span> <span class="free">lo</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sorted_sublist_wrt_le<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> ifs<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> ifs<span class="main">(</span>1<span class="main">)</span> mset_eq_length part<span class="main">(</span>1<span class="main">)</span> pre<span class="main">(</span>1<span class="main">)</span> pre<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> sorted_upper<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs'</span> <span class="main">(</span>Suc <span class="free">p</span><span class="main">)</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sorted_sublist_wrt_le<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> ifs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> ifs<span class="main">(</span>1<span class="main">)</span> mset_eq_length part<span class="main">(</span>1<span class="main">)</span> pre<span class="main">(</span>1<span class="main">)</span> pre<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> sorted_middle<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs'</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> merge_sorted_map_partitions<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">p</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> part<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_lower<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_upper<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> pre<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> part<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> part<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pre<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> size_mset<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> quicksort_postI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs'</span> <span class="main">=</span> mset <span class="free">xs</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs'</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_middle<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">lo</span> <span class="main">‚üπ</span> <span class="free">xs'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> part<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">j</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">hi</span> <span class="main">&lt;</span> <span class="bound">j</span><span class="main">;</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">xs'</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> size_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπIn the second case, we have to show that the precondition still holds for (p+1, hi, x') after the partition.‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> quicksort_correct_case2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
        pre<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπquicksort_pre <span class="free">R</span> <span class="free">h</span> <span class="free">xs0</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπpartition_spec <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs'</span> <span class="free">p</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ifs<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">¬¨</span> <span class="free">hi</span> <span class="main">‚â§</span> <span class="free">p</span> <span class="main">+</span> <span class="main">1</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπquicksort_pre <span class="free">R</span> <span class="free">h</span> <span class="free">xs0</span> <span class="main">(</span>Suc <span class="free">p</span><span class="main">)</span> <span class="free">hi</span> <span class="free">xs'</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπFirst boilerplate code step: 'unfold' the HOL definitions in the assumptions and convert them to Pure‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs</span> <span class="main">=</span> mset <span class="free">xs0</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> pre <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_pre_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs'</span> <span class="main">=</span> mset <span class="free">xs</span>‚Ä∫</span></span> <span class="quoted">True</span>
    <span class="quoted"><span class="quoted">‚ÄπisPartition_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs'</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">p</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">p</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">lo</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">hi</span><span class="main">&lt;</span><span class="bound">i</span><span class="main">;</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">xs'</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> part <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_spec_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> quicksort_pre_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚ÄπSuc <span class="free">p</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> ifs <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs'</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pre<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> size_mset<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs'</span> <span class="main">=</span> mset <span class="free">xs0</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> pre<span class="main">(</span>3<span class="main">)</span> part<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_setD<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">lemma</span></span> quicksort_post_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπquicksort_post <span class="free">R</span> <span class="free">h</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs</span> <span class="free">xs'</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bounds<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπset <span class="main">(</span>sublist <span class="free">xs'</span> <span class="free">lo</span> <span class="free">hi</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>sublist <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs'</span> <span class="main">=</span> mset <span class="free">xs</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">lo</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">xs</span><span class="main">!</span><span class="bound">i</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">hi</span><span class="main">&lt;</span><span class="bound">j</span><span class="main">;</span> <span class="bound">j</span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> <span class="free">xs</span><span class="main">!</span><span class="bound">j</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_post_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> bounds <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mset_sublist_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπIn the third case, we have run quicksort recursively on (p+1, hi, xs') after the partition, with hi&lt;=p+1 and p-1&lt;=lo.‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> quicksort_correct_case3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span><span class="main">;</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> lin<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">‚â†</span> <span class="bound">y</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">‚à®</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπquicksort_pre <span class="free">R</span> <span class="free">h</span> <span class="free">xs0</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπpartition_spec <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs'</span> <span class="free">p</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ifs<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">‚â§</span> <span class="free">lo</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">¬¨</span> <span class="free">hi</span> <span class="main">‚â§</span> Suc <span class="free">p</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IH1'<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπquicksort_post <span class="free">R</span> <span class="free">h</span> <span class="main">(</span>Suc <span class="free">p</span><span class="main">)</span> <span class="free">hi</span> <span class="free">xs'</span> <span class="free">xs''</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπquicksort_post <span class="free">R</span> <span class="free">h</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs</span> <span class="free">xs''</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπFirst boilerplate code step: 'unfold' the HOL definitions in the assumptions and convert them to Pure‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs</span> <span class="main">=</span> mset <span class="free">xs0</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> pre <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_pre_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs'</span> <span class="main">=</span> mset <span class="free">xs</span>‚Ä∫</span></span> <span class="quoted">True</span>
    <span class="quoted"><span class="quoted">‚ÄπisPartition_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs'</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">p</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">p</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">lo</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">hi</span><span class="main">&lt;</span><span class="bound">i</span><span class="main">;</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">xs'</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> part <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_spec_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> IH1<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs''</span> <span class="main">=</span> mset <span class="free">xs'</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs''</span> <span class="main">(</span>Suc <span class="free">p</span><span class="main">)</span> <span class="free">hi</span>‚Ä∫</span></span>
      <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>Suc <span class="free">p</span> <span class="main">‚üπ</span> <span class="free">xs''</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">xs'</span> <span class="main">!</span> <span class="bound">i</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">hi</span> <span class="main">&lt;</span> <span class="bound">j</span><span class="main">;</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">xs'</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">xs''</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">xs'</span> <span class="main">!</span> <span class="bound">j</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> IH1' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_post_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH1_perm <span class="main">=</span> quicksort_post_set<span class="main">[</span><span class="operator">OF</span> IH1'<span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> still_partition<span class="main">:</span> <span class="quoted"><span class="quoted">‚ÄπisPartition_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs''</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">p</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> isPartition_wrtI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="skolem">i</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">p</span>‚Ä∫</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs''</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs''</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThis holds because this part hasn't changed‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH1<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">p</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="skolem">i</span>‚Ä∫</span></span> isPartition_wrt_def part<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">&lt;</span> <span class="skolem">j</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">j</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπObtain the position <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">posJ</span></span>‚Ä∫</span></span></span></span> where <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">xs''</span></span><span class="main"><span class="main">!</span></span><span class="skolem"><span class="skolem">j</span></span>‚Ä∫</span></span></span></span> was stored in <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">xs'</span></span>‚Ä∫</span></span></span></span>.‚Ä∫</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs''</span><span class="main">!</span><span class="skolem">j</span> <span class="main">‚àà</span> set <span class="main">(</span>sublist <span class="free">xs''</span> <span class="main">(</span>Suc <span class="free">p</span><span class="main">)</span> <span class="free">hi</span><span class="main">)</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc_leI <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">j</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">&lt;</span> <span class="skolem">j</span>‚Ä∫</span></span> less_le_trans mset_eq_length part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pre<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sublist_el'<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs''</span><span class="main">!</span><span class="skolem">j</span> <span class="main">‚àà</span> set <span class="main">(</span>sublist <span class="free">xs'</span> <span class="main">(</span>Suc <span class="free">p</span><span class="main">)</span> <span class="free">hi</span><span class="main">)</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH1_perm ifs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nat_le_linear part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pre<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> size_mset<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÉ</span> <span class="bound">posJ</span><span class="main">.</span> Suc <span class="free">p</span><span class="main">‚â§</span><span class="bound">posJ</span><span class="main">‚àß</span><span class="bound">posJ</span><span class="main">‚â§</span><span class="free">hi</span> <span class="main">‚àß</span> <span class="free">xs''</span><span class="main">!</span><span class="skolem">j</span> <span class="main">=</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">posJ</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_leI <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">j</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">&lt;</span> <span class="skolem">j</span>‚Ä∫</span></span> less_le_trans part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pre<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> size_mset sublist_el'<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">posJ</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> PosJ<span class="main">:</span> <span class="quoted"><span class="quoted">‚ÄπSuc <span class="free">p</span><span class="main">‚â§</span><span class="skolem">posJ</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">posJ</span><span class="main">‚â§</span><span class="free">hi</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs''</span><span class="main">!</span><span class="skolem">j</span> <span class="main">=</span> <span class="free">xs'</span><span class="main">!</span><span class="skolem">posJ</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs''</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs''</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Suc_le_lessD isPartition_wrt_def lessI part<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> sorted_lower<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs''</span> <span class="free">lo</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sorted_sublist_wrt_le<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ifs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> IH1<span class="main">(</span>1<span class="main">)</span> mset_eq_length part<span class="main">(</span>1<span class="main">)</span> part<span class="main">(</span>5<span class="main">)</span> pre<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">note</span></span> sorted_upper <span class="main">=</span> IH1<span class="main">(</span>2<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> sorted_middle<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs''</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> merge_sorted_map_partitions<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">p</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> still_partition<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_lower<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_upper<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> pre<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> part<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> part<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pre<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> size_mset<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>


  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> quicksort_postI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs''</span> <span class="main">=</span> mset <span class="free">xs</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> part<span class="main">(</span>1<span class="main">)</span> IH1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">‚Äï ‚ÄπI was faster than sledgehammer :-)‚Ä∫</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs''</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_middle<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">lo</span> <span class="main">‚üπ</span> <span class="free">xs''</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH1<span class="main">(</span>3<span class="main">)</span> le_SucI part<span class="main">(</span>4<span class="main">)</span> part<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">j</span><span class="main">.</span> <span class="free">hi</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">‚üπ</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span> <span class="free">xs''</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH1<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> size_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπIn the 4th case, we have to show that the premise holds for <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">(</span></span><span class="free"><span class="free">lo</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">p</span></span><span class="main"><span class="main">-</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">xs'</span></span><span class="main"><span class="main">)</span></span>‚Ä∫</span></span></span></span>, in case <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">¬¨</span></span><span class="free"><span class="free">p</span></span><span class="main"><span class="main">-</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">‚â§</span></span><span class="free"><span class="free">lo</span></span>‚Ä∫</span></span></span></span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπAnalogous to case 2.‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> quicksort_correct_case4<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
        pre<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπquicksort_pre <span class="free">R</span> <span class="free">h</span> <span class="free">xs0</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπpartition_spec <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs'</span> <span class="free">p</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ifs<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">¬¨</span> <span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">‚â§</span> <span class="free">lo</span> ‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπquicksort_pre <span class="free">R</span> <span class="free">h</span> <span class="free">xs0</span> <span class="free">lo</span> <span class="main">(</span><span class="free">p</span><span class="main">-</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">xs'</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπFirst boilerplate code step: 'unfold' the HOL definitions in the assumptions and convert them to Pure‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs0</span> <span class="main">=</span> mset <span class="free">xs</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> pre <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_pre_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs'</span> <span class="main">=</span> mset <span class="free">xs</span>‚Ä∫</span></span> <span class="quoted">True</span>
    <span class="quoted"><span class="quoted">‚ÄπisPartition_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs'</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">p</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">p</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">lo</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">hi</span><span class="main">&lt;</span><span class="bound">i</span><span class="main">;</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">xs'</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> part <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_spec_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> quicksort_pre_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> ifs <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">&lt;</span> length <span class="free">xs'</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> mset_eq_length part<span class="main">(</span>1<span class="main">)</span> part<span class="main">(</span>5<span class="main">)</span> pre<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs'</span> <span class="main">=</span> mset <span class="free">xs0</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> pre<span class="main">(</span>3<span class="main">)</span> part<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_setD<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπIn the 5th case, we have run quicksort recursively on (lo, p-1, xs').‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> quicksort_correct_case5<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span><span class="main">;</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> lin<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">‚â†</span> <span class="bound">y</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">‚à®</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπquicksort_pre <span class="free">R</span> <span class="free">h</span> <span class="free">xs0</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπpartition_spec <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs'</span> <span class="free">p</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ifs<span class="main">:</span>  <span class="quoted"><span class="quoted">‚Äπ<span class="main">¬¨</span> <span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">‚â§</span> <span class="free">lo</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">‚â§</span> Suc <span class="free">p</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IH1'<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπquicksort_post <span class="free">R</span> <span class="free">h</span> <span class="free">lo</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="free">xs'</span> <span class="free">xs''</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπquicksort_post <span class="free">R</span> <span class="free">h</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs</span> <span class="free">xs''</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπFirst boilerplate code step: 'unfold' the HOL definitions in the assumptions and convert them to Pure‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> pre <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_pre_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs'</span> <span class="main">=</span> mset <span class="free">xs</span>‚Ä∫</span></span> <span class="quoted">True</span>
    <span class="quoted"><span class="quoted">‚ÄπisPartition_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs'</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">p</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">p</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">lo</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">hi</span><span class="main">&lt;</span><span class="bound">i</span><span class="main">;</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">xs'</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> part <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_spec_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> IH1<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs''</span> <span class="main">=</span> mset <span class="free">xs'</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs''</span> <span class="free">lo</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">lo</span> <span class="main">‚üπ</span> <span class="free">xs''</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">p</span><span class="main">-</span>Suc <span class="main">0</span><span class="main">&lt;</span><span class="bound">j</span><span class="main">;</span> <span class="bound">j</span><span class="main">&lt;</span>length <span class="free">xs'</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">xs''</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">j</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> IH1' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_post_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH1_perm <span class="main">=</span> quicksort_post_set<span class="main">[</span><span class="operator">OF</span> IH1'<span class="main">]</span>


 <span class="keyword1"><span class="command">have</span></span> still_partition<span class="main">:</span> <span class="quoted"><span class="quoted">‚ÄπisPartition_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs''</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">p</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> isPartition_wrtI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="skolem">i</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">p</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπObtain the position <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">posI</span></span>‚Ä∫</span></span></span></span> where <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">xs''</span></span><span class="main"><span class="main">!</span></span><span class="skolem"><span class="skolem">i</span></span>‚Ä∫</span></span></span></span> was stored in <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">xs'</span></span>‚Ä∫</span></span></span></span>.‚Ä∫</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs''</span><span class="main">!</span><span class="skolem">i</span> <span class="main">‚àà</span> set <span class="main">(</span>sublist <span class="free">xs''</span> <span class="free">lo</span> <span class="main">(</span><span class="free">p</span><span class="main">-</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> IH1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc_leI Suc_pred <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">p</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="skolem">i</span>‚Ä∫</span></span> le_less_trans less_imp_diff_less mset_eq_length not_le not_less_zero part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> pre<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sublist_el'<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs''</span><span class="main">!</span><span class="skolem">i</span> <span class="main">‚àà</span> set <span class="main">(</span>sublist <span class="free">xs'</span> <span class="free">lo</span> <span class="main">(</span><span class="free">p</span><span class="main">-</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH1_perm ifs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> le_less_trans less_imp_diff_less mset_eq_length nat_le_linear part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> pre<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÉ</span> <span class="bound">posI</span><span class="main">.</span> <span class="free">lo</span><span class="main">‚â§</span><span class="bound">posI</span><span class="main">‚àß</span><span class="bound">posI</span><span class="main">‚â§</span><span class="free">p</span><span class="main">-</span>Suc <span class="main">0</span> <span class="main">‚àß</span> <span class="free">xs''</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">posI</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> <span class="comment1">‚Äï ‚Äπsledgehammer‚Ä∫</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> diff_le_self le_less_trans part<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> pre<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs''</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">‚àà</span> set <span class="main">(</span>sublist <span class="free">xs'</span> <span class="free">lo</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> ifs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mset_eq_length nat_le_linear part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sublist_el'<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">posI</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> PosI<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span><span class="main">‚â§</span><span class="skolem">posI</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">posI</span><span class="main">‚â§</span><span class="free">p</span><span class="main">-</span>Suc <span class="main">0</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs''</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="free">xs'</span><span class="main">!</span><span class="skolem">posI</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs''</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs''</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> IH1<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">p</span>‚Ä∫</span></span> diff_Suc_less isPartition_wrt_def le_less_trans mset_eq_length not_le not_less_eq part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> pre<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> zero_less_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">&lt;</span> <span class="skolem">j</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">j</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs''</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs''</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThis holds because this part hasn't changed‚Ä∫</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> IH1<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> add_diff_cancel_left' add_diff_inverse_nat diff_Suc_eq_diff_pred diff_le_self ifs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> isPartition_wrt_def le_less_Suc_eq less_le_trans mset_eq_length nat_less_le part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> plus_1_eq_Suc pre<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>


  <span class="keyword1"><span class="command">note</span></span> sorted_lower <span class="main">=</span> IH1<span class="main">(</span>2<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> sorted_upper<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs''</span> <span class="main">(</span>Suc <span class="free">p</span><span class="main">)</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sorted_sublist_wrt_le<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ifs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> IH1<span class="main">(</span>1<span class="main">)</span> mset_eq_length part<span class="main">(</span>1<span class="main">)</span> part<span class="main">(</span>5<span class="main">)</span> pre<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>


  <span class="keyword1"><span class="command">have</span></span> sorted_middle<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs''</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> merge_sorted_map_partitions<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">p</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> still_partition<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_lower<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_upper<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> pre<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> part<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> part<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pre<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> size_mset<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>


  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> quicksort_postI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs''</span> <span class="main">=</span> mset <span class="free">xs</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs''</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_middle<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">lo</span> <span class="main">‚üπ</span> <span class="free">xs''</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">j</span><span class="main">.</span> <span class="free">hi</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">‚üπ</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span> <span class="free">xs''</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH1<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> diff_le_self dual_order.strict_trans2 mset_eq_length part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπIn the 6th case, we have run quicksort recursively on (lo, p-1, xs'). We show the precondition on the second call on (p+1, hi, xs'')‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> quicksort_correct_case6<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
        pre<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπquicksort_pre <span class="free">R</span> <span class="free">h</span> <span class="free">xs0</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπpartition_spec <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs'</span> <span class="free">p</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ifs<span class="main">:</span>  <span class="quoted"><span class="quoted">‚Äπ<span class="main">¬¨</span> <span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">‚â§</span> <span class="free">lo</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">¬¨</span> <span class="free">hi</span> <span class="main">‚â§</span> Suc <span class="free">p</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IH1<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπquicksort_post <span class="free">R</span> <span class="free">h</span> <span class="free">lo</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="free">xs'</span> <span class="free">xs''</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπquicksort_pre <span class="free">R</span> <span class="free">h</span> <span class="free">xs0</span> <span class="main">(</span>Suc <span class="free">p</span><span class="main">)</span> <span class="free">hi</span> <span class="free">xs''</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπFirst boilerplate code step: 'unfold' the HOL definitions in the assumptions and convert them to Pure‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs0</span> <span class="main">=</span> mset <span class="free">xs</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> pre <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_pre_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs'</span> <span class="main">=</span> mset <span class="free">xs</span>‚Ä∫</span></span> <span class="quoted">True</span>
    <span class="quoted"><span class="quoted">‚ÄπisPartition_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs'</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">p</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">p</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">lo</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">hi</span><span class="main">&lt;</span><span class="bound">i</span><span class="main">;</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">xs'</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> part <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_spec_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> IH1<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs''</span> <span class="main">=</span> mset <span class="free">xs'</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs''</span> <span class="free">lo</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">lo</span> <span class="main">‚üπ</span> <span class="free">xs''</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">p</span><span class="main">-</span>Suc <span class="main">0</span><span class="main">&lt;</span><span class="bound">j</span><span class="main">;</span> <span class="bound">j</span><span class="main">&lt;</span>length <span class="free">xs'</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">xs''</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">j</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> IH1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_post_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> quicksort_pre_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚ÄπSuc <span class="free">p</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> ifs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs''</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH1<span class="main">(</span>1<span class="main">)</span> mset_eq_length part<span class="main">(</span>1<span class="main">)</span> pre<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs''</span> <span class="main">=</span> mset <span class="free">xs0</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> pre<span class="main">(</span>3<span class="main">)</span> part<span class="main">(</span>1<span class="main">)</span> IH1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_setD<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπIn the 7th (and last) case, we have run quicksort recursively on (lo, p-1, xs'). We show the postcondition on the second call on (p+1, hi, xs'')‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> quicksort_correct_case7<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span><span class="main">;</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> lin<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">‚â†</span> <span class="bound">y</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">‚à®</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπquicksort_pre <span class="free">R</span> <span class="free">h</span> <span class="free">xs0</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπpartition_spec <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs'</span> <span class="free">p</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ifs<span class="main">:</span>  <span class="quoted"><span class="quoted">‚Äπ<span class="main">¬¨</span> <span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">‚â§</span> <span class="free">lo</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">¬¨</span> <span class="free">hi</span> <span class="main">‚â§</span> Suc <span class="free">p</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IH1'<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπquicksort_post <span class="free">R</span> <span class="free">h</span> <span class="free">lo</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="free">xs'</span> <span class="free">xs''</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IH2'<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπquicksort_post <span class="free">R</span> <span class="free">h</span> <span class="main">(</span>Suc <span class="free">p</span><span class="main">)</span> <span class="free">hi</span> <span class="free">xs''</span> <span class="free">xs'''</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπquicksort_post <span class="free">R</span> <span class="free">h</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs</span> <span class="free">xs'''</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπFirst boilerplate code step: 'unfold' the HOL definitions in the assumptions and convert them to Pure‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> pre <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_pre_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs'</span> <span class="main">=</span> mset <span class="free">xs</span>‚Ä∫</span></span> <span class="quoted">True</span>
    <span class="quoted"><span class="quoted">‚ÄπisPartition_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs'</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">p</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">p</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">lo</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">hi</span><span class="main">&lt;</span><span class="bound">i</span><span class="main">;</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">xs'</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> part <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_spec_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> IH1<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs''</span> <span class="main">=</span> mset <span class="free">xs'</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs''</span> <span class="free">lo</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">lo</span> <span class="main">‚üπ</span> <span class="free">xs''</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">i</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">p</span><span class="main">-</span>Suc <span class="main">0</span><span class="main">&lt;</span><span class="bound">j</span><span class="main">;</span> <span class="bound">j</span><span class="main">&lt;</span>length <span class="free">xs'</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">xs''</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">j</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> IH1' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_post_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH1_perm <span class="main">=</span> quicksort_post_set<span class="main">[</span><span class="operator">OF</span> IH1'<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> IH2<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs'''</span> <span class="main">=</span> mset <span class="free">xs''</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs'''</span> <span class="main">(</span>Suc <span class="free">p</span><span class="main">)</span> <span class="free">hi</span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>Suc <span class="free">p</span> <span class="main">‚üπ</span> <span class="free">xs'''</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">xs''</span><span class="main">!</span><span class="bound">i</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">hi</span><span class="main">&lt;</span><span class="bound">j</span><span class="main">;</span> <span class="bound">j</span><span class="main">&lt;</span>length <span class="free">xs''</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">xs'''</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> <span class="free">xs''</span><span class="main">!</span><span class="bound">j</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> IH2' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_post_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH2_perm <span class="main">=</span> quicksort_post_set<span class="main">[</span><span class="operator">OF</span> IH2'<span class="main">]</span>


  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπWe still have a partition after the first call (same as in case 5)‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span> still_partition1<span class="main">:</span> <span class="quoted"><span class="quoted">‚ÄπisPartition_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs''</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">p</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> isPartition_wrtI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="skolem">i</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">p</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπObtain the position <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">posI</span></span>‚Ä∫</span></span></span></span> where <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">xs''</span></span><span class="main"><span class="main">!</span></span><span class="skolem"><span class="skolem">i</span></span>‚Ä∫</span></span></span></span> was stored in <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">xs'</span></span>‚Ä∫</span></span></span></span>.‚Ä∫</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs''</span><span class="main">!</span><span class="skolem">i</span> <span class="main">‚àà</span> set <span class="main">(</span>sublist <span class="free">xs''</span> <span class="free">lo</span> <span class="main">(</span><span class="free">p</span><span class="main">-</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> IH1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc_leI Suc_pred <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">p</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="skolem">i</span>‚Ä∫</span></span> le_less_trans less_imp_diff_less mset_eq_length not_le not_less_zero part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> pre<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sublist_el'<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs''</span><span class="main">!</span><span class="skolem">i</span> <span class="main">‚àà</span> set <span class="main">(</span>sublist <span class="free">xs'</span> <span class="free">lo</span> <span class="main">(</span><span class="free">p</span><span class="main">-</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH1_perm ifs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> le_less_trans less_imp_diff_less mset_eq_length nat_le_linear part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> pre<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÉ</span> <span class="bound">posI</span><span class="main">.</span> <span class="free">lo</span><span class="main">‚â§</span><span class="bound">posI</span><span class="main">‚àß</span><span class="bound">posI</span><span class="main">‚â§</span><span class="free">p</span><span class="main">-</span>Suc <span class="main">0</span> <span class="main">‚àß</span> <span class="free">xs''</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="free">xs'</span><span class="main">!</span><span class="bound">posI</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> <span class="comment1">‚Äï ‚Äπsledgehammer‚Ä∫</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> diff_le_self le_less_trans part<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> pre<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs''</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">‚àà</span> set <span class="main">(</span>sublist <span class="free">xs'</span> <span class="free">lo</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> ifs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mset_eq_length nat_le_linear part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sublist_el'<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">posI</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> PosI<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span><span class="main">‚â§</span><span class="skolem">posI</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">posI</span><span class="main">‚â§</span><span class="free">p</span><span class="main">-</span>Suc <span class="main">0</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs''</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="free">xs'</span><span class="main">!</span><span class="skolem">posI</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs''</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs''</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> IH1<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">p</span>‚Ä∫</span></span> diff_Suc_less isPartition_wrt_def le_less_trans mset_eq_length not_le not_less_eq part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> pre<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> zero_less_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">&lt;</span> <span class="skolem">j</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">j</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs''</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs''</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThis holds because this part hasn't changed‚Ä∫</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> IH1<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> add_diff_cancel_left' add_diff_inverse_nat diff_Suc_eq_diff_pred diff_le_self ifs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> isPartition_wrt_def le_less_Suc_eq less_le_trans mset_eq_length nat_less_le part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> plus_1_eq_Suc pre<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>


  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπWe still have a partition after the second call (similar as in case 3)‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span> still_partition2<span class="main">:</span> <span class="quoted"><span class="quoted">‚ÄπisPartition_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs'''</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">p</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> isPartition_wrtI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="skolem">i</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">p</span>‚Ä∫</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs'''</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs'''</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThis holds because this part hasn't changed‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH2<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">p</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="skolem">i</span>‚Ä∫</span></span> isPartition_wrt_def still_partition1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">&lt;</span> <span class="skolem">j</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">j</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπObtain the position <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">posJ</span></span>‚Ä∫</span></span></span></span> where <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">xs'''</span></span><span class="main"><span class="main">!</span></span><span class="skolem"><span class="skolem">j</span></span>‚Ä∫</span></span></span></span> was stored in <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">xs'''</span></span>‚Ä∫</span></span></span></span>.‚Ä∫</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs'''</span><span class="main">!</span><span class="skolem">j</span> <span class="main">‚àà</span> set <span class="main">(</span>sublist <span class="free">xs'''</span> <span class="main">(</span>Suc <span class="free">p</span><span class="main">)</span> <span class="free">hi</span><span class="main">)</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> IH2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc_leI <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">j</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">&lt;</span> <span class="skolem">j</span>‚Ä∫</span></span> ifs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nat_le_linear part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pre<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> size_mset sublist_el'<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs'''</span><span class="main">!</span><span class="skolem">j</span> <span class="main">‚àà</span> set <span class="main">(</span>sublist <span class="free">xs''</span> <span class="main">(</span>Suc <span class="free">p</span><span class="main">)</span> <span class="free">hi</span><span class="main">)</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> IH2_perm ifs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mset_eq_length nat_le_linear part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pre<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÉ</span> <span class="bound">posJ</span><span class="main">.</span> Suc <span class="free">p</span><span class="main">‚â§</span><span class="bound">posJ</span><span class="main">‚àß</span><span class="bound">posJ</span><span class="main">‚â§</span><span class="free">hi</span> <span class="main">‚àß</span> <span class="free">xs'''</span><span class="main">!</span><span class="skolem">j</span> <span class="main">=</span> <span class="free">xs''</span><span class="main">!</span><span class="bound">posJ</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ifs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mset_eq_length nat_le_linear part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pre<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sublist_el'<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">posJ</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> PosJ<span class="main">:</span> <span class="quoted"><span class="quoted">‚ÄπSuc <span class="free">p</span><span class="main">‚â§</span><span class="skolem">posJ</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">posJ</span><span class="main">‚â§</span><span class="free">hi</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs'''</span><span class="main">!</span><span class="skolem">j</span> <span class="main">=</span> <span class="free">xs''</span><span class="main">!</span><span class="skolem">posJ</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs'''</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="free">xs'''</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> <span class="comment1">‚Äï ‚Äπsledgehammer‚Ä∫</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span><span class="bound">n</span> <span class="bound">na</span> <span class="bound">as</span> <span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span> <span class="main">(</span><span class="bound">as</span> <span class="main">!</span> <span class="bound">na</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">(</span><span class="bound">as</span> <span class="main">!</span> <span class="skolem">posJ</span><span class="main">)</span> <span class="main">‚à®</span> <span class="skolem">posJ</span> <span class="main">‚â§</span> <span class="bound">na</span><span class="main">)</span> <span class="main">‚à®</span> <span class="main">¬¨</span> isPartition_wrt <span class="bound">p</span> <span class="bound">as</span> <span class="bound">n</span> <span class="free">hi</span> <span class="bound">na</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> PosJ<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> isPartition_wrt_def not_less<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH2<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> PosJ<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> PosJ<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> lessI not_less_eq_eq still_partition1<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>


  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπWe have that the lower part is sorted after the first recursive call‚Ä∫</span></span>
  <span class="keyword1"><span class="command">note</span></span> sorted_lower1 <span class="main">=</span> IH1<span class="main">(</span>2<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπWe show that it is still sorted after the second call.‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span> sorted_lower2<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs'''</span> <span class="free">lo</span> <span class="main">(</span><span class="free">p</span><span class="main">-</span>Suc <span class="main">0</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> sorted_lower1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sorted_wrt_lower_sublist_still_sorted<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> part<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> IH1<span class="main">(</span>1<span class="main">)</span> mset_eq_length part<span class="main">(</span>1<span class="main">)</span> part<span class="main">(</span>5<span class="main">)</span> pre<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH2<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> size_mset<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThe second IH gives us the the upper list is sorted after the second recursive call‚Ä∫</span></span>
  <span class="keyword1"><span class="command">note</span></span> sorted_upper2 <span class="main">=</span> IH2<span class="main">(</span>2<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπFinally, we have to show that the entire list is sorted after the second recursive call.‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span> sorted_middle<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs'''</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> merge_sorted_map_partitions<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">p</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> still_partition2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_lower2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_upper2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> pre<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> part<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> part<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> IH2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pre<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> size_mset<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> quicksort_postI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs'''</span> <span class="main">=</span> mset <span class="free">xs</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> IH2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs'''</span> <span class="free">lo</span> <span class="free">hi</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_middle<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">lo</span> <span class="main">‚üπ</span> <span class="free">xs'''</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH1<span class="main">(</span>3<span class="main">)</span> IH2<span class="main">(</span>3<span class="main">)</span> part<span class="main">(</span>4<span class="main">)</span> part<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">j</span><span class="main">.</span> <span class="free">hi</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">‚üπ</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">‚üπ</span> <span class="free">xs'''</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> IH1<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> IH2<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> diff_le_self ifs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> le_SucI less_le_trans nat_le_eq_or_lt not_less part<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> part<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> size_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπWe can now show the correctness of the abstract quicksort procedure, using the refinement framework and the above case lemmas.‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> quicksort_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span><span class="main">;</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> lin<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">‚â†</span> <span class="bound">y</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">‚à®</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> Pre<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo0</span> <span class="main">‚â§</span> <span class="free">hi0</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi0</span> <span class="main">&lt;</span> length <span class="free">xs0</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπquicksort <span class="free">R</span> <span class="free">h</span> <span class="main">(</span><span class="free">lo0</span><span class="main">,</span><span class="free">hi0</span><span class="main">,</span><span class="free">xs0</span><span class="main">)</span> <span class="main">‚â§</span> <span class="main">‚áì</span> Id <span class="main">(</span>SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">xs</span><span class="main">.</span> quicksort_post <span class="free">R</span> <span class="free">h</span> <span class="free">lo0</span> <span class="free">hi0</span> <span class="free">xs0</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπwf <span class="main">(</span>measure <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">lo</span><span class="main">,</span> <span class="bound">hi</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span><span class="main">.</span> Suc <span class="bound">hi</span> <span class="main">-</span> <span class="bound">lo</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">pre</span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">lo</span><span class="main">,</span><span class="bound">hi</span><span class="main">,</span><span class="bound">xs</span><span class="main">)</span><span class="main">.</span> quicksort_pre <span class="free">R</span> <span class="free">h</span> <span class="free">xs0</span> <span class="bound">lo</span> <span class="bound">hi</span> <span class="bound">xs</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">post</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">post</span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">lo</span><span class="main">,</span><span class="bound">hi</span><span class="main">,</span><span class="bound">xs</span><span class="main">)</span><span class="main">.</span> quicksort_post <span class="free">R</span> <span class="free">h</span> <span class="bound">lo</span> <span class="bound">hi</span> <span class="bound">xs</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">pre</span> <span class="main">(</span><span class="free">lo0</span><span class="main">,</span><span class="free">hi0</span><span class="main">,</span><span class="free">xs0</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> quicksort_pre_def pre_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Pre<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπWe first generalize the goal a over all states.‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚ÄπWB_Sort.quicksort <span class="free">R</span> <span class="free">h</span> <span class="main">(</span><span class="free">lo0</span><span class="main">,</span><span class="free">hi0</span><span class="main">,</span><span class="free">xs0</span><span class="main">)</span> <span class="main">‚â§</span> <span class="main">‚áì</span> Id <span class="main">(</span>SPEC <span class="main">(</span><span class="skolem">post</span> <span class="main">(</span><span class="free">lo0</span><span class="main">,</span><span class="free">hi0</span><span class="main">,</span><span class="free">xs0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> quicksort_def prod.case
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> RECT_rule<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_mono</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> pre<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> IH <span class="keyword2"><span class="keyword">for</span></span> f x
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> ASSERT_leI<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> pre_def post_def

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="comment1">‚Äï ‚ÄπFirst premise (assertion) for partition‚Ä∫</span>
        <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_pre_def pre_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="comment1">‚Äï ‚ÄπSecond premise (assertion) for partition‚Ä∫</span>
        <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_pre_def pre_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_pre_def pre_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_setD<span class="main">)</span>

	<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπTermination case: <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">(</span></span><span class="free"><span class="free">p</span></span><span class="main"><span class="main">-</span></span><span class="main"><span class="main">1</span></span> <span class="main"><span class="main">‚â§</span></span> <span class="free"><span class="free">lo'</span></span><span class="main"><span class="main">)</span></span>‚Ä∫</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">(</span></span><span class="free"><span class="free">hi'</span></span> <span class="main"><span class="main">‚â§</span></span> <span class="free"><span class="free">p</span></span><span class="main"><span class="main">+</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span>‚Ä∫</span></span></span></span>; directly show postcondition‚Ä∫</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> partition_spec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_setD<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="comment1">‚Äï ‚ÄπPostcondition (after partition)‚Ä∫</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> pre_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">split</span> prod.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> trans lin <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> quicksort_correct_case1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπCase <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">(</span></span><span class="free"><span class="free">p</span></span><span class="main"><span class="main">-</span></span><span class="main"><span class="main">1</span></span> <span class="main"><span class="main">‚â§</span></span> <span class="free"><span class="free">lo'</span></span><span class="main"><span class="main">)</span></span>‚Ä∫</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">(</span></span><span class="free"><span class="free">hi'</span></span> <span class="main"><span class="main">&lt;</span></span> <span class="free"><span class="free">p</span></span><span class="main"><span class="main">+</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span>‚Ä∫</span></span></span></span> (Only second recursive call)‚Ä∫</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>

        <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπShow that the invariant holds for the second recursive call‚Ä∫</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> pre_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">split</span> prod.splits<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> quicksort_correct_case2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπWellfoundness (easy)‚Ä∫</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_pre_def partition_spec_def<span class="main">)</span>

        <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπShow that the postcondition holds‚Ä∫</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Misc.subset_Collect_conv post_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> trans lin <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> quicksort_correct_case3<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> pre_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

      <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπCase: At least the first recursive call‚Ä∫</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>

        <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπShow that the precondition holds for the first recursive call‚Ä∫</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> pre_def post_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">split</span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> quicksort_correct_case4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπWellfoundness for first recursive call (easy)‚Ä∫</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_pre_def partition_spec_def<span class="main">)</span>

        <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπSimplify some refinement suff...‚Ä∫</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Misc.subset_Collect_conv ASSERT_leI<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ASSERT_leI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Misc.subset_Collect_conv ASSERT_leI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> quicksort_post_def pre_def post_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_setD<span class="main">)</span>
        <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπOnly the first recursive call: show postcondition‚Ä∫</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">using</span></span> trans lin <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> quicksort_correct_case5<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> pre_def post_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ASSERT_leI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> quicksort_post_def pre_def post_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_setD<span class="main">)</span>

        <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπBoth recursive calls.‚Ä∫</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>

          <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπShow precondition for second recursive call (after the first call)‚Ä∫</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> pre_def post_def
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> quicksort_correct_case6<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> pre_def post_def  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπWellfoundedness for second recursive call (easy)‚Ä∫</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_pre_def partition_spec_def<span class="main">)</span>

          <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπShow that the postcondition holds (after both recursive calls)‚Ä∫</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Misc.subset_Collect_conv<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> trans lin <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> quicksort_correct_case7<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> pre_def post_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπFinally, apply the generalized lemma to show the thesis.‚Ä∫</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> post_def  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="comment1">(* TODO: Show that our (abstract) partition satisifies the specification *)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">partition_main_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> bool<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="main">(</span>nat<span class="main">√ó</span>nat<span class="main">√ó</span><span class="tfree">'a</span> list<span class="main">)</span> <span class="main">‚áí</span> bool‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">partition_main_inv</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="free"><span class="bound"><span class="entity">xs0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚â°</span>
    <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span><span class="bound">xs</span><span class="main">)</span> <span class="main">‚áí</span>
    <span class="bound">j</span> <span class="main">&lt;</span> length <span class="bound">xs</span> <span class="main">‚àß</span> <span class="bound">j</span> <span class="main">‚â§</span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="main">‚àß</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="bound">xs</span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="main">‚â§</span> <span class="bound">i</span> <span class="main">‚àß</span> <span class="bound">i</span> <span class="main">‚â§</span> <span class="bound">j</span> <span class="main">‚àß</span> mset <span class="bound">xs</span> <span class="main">=</span> mset <span class="free"><span class="bound"><span class="entity">xs0</span></span></span> <span class="main">‚àß</span>
    <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">‚â•</span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="main">‚àß</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span><span class="bound">xs</span><span class="main">!</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span><span class="bound">xs</span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àß</span> <span class="comment1">‚Äï ‚ÄπAll elements from <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span><span class="quoted">‚Äπ<span class="free">lo</span>‚Ä∫</span></span> to <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span><span class="quoted">‚Äπ<span class="free">i</span><span class="main">-</span><span class="main">1</span>‚Ä∫</span></span> are smaller than the pivot‚Ä∫</span>
    <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">‚â•</span> <span class="bound">i</span> <span class="main">‚àß</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">‚ü∂</span>  <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span><span class="bound">xs</span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span><span class="bound">xs</span><span class="main">!</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àß</span> <span class="comment1">‚Äï ‚ÄπAll elements from <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span><span class="quoted">‚Äπ<span class="free">i</span>‚Ä∫</span></span> to <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span><span class="quoted">‚Äπ<span class="free">j</span><span class="main">-</span><span class="main">1</span>‚Ä∫</span></span> are greater than the pivot‚Ä∫</span>
    <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="main">‚ü∂</span> <span class="bound">xs</span><span class="main">!</span><span class="bound">k</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs0</span></span></span><span class="main">!</span><span class="bound">k</span><span class="main">)</span> <span class="main">‚àß</span> <span class="comment1">‚Äï ‚ÄπEverything below <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span><span class="quoted">‚Äπ<span class="free">lo</span>‚Ä∫</span></span> is unchanged‚Ä∫</span>
    <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">‚â•</span> <span class="bound">j</span> <span class="main">‚àß</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="bound">xs</span> <span class="main">‚ü∂</span> <span class="bound">xs</span><span class="main">!</span><span class="bound">k</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs0</span></span></span><span class="main">!</span><span class="bound">k</span><span class="main">)</span> <span class="comment1">‚Äï ‚ÄπAll elements from <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span><span class="quoted">‚Äπ<span class="free">j</span>‚Ä∫</span></span> are unchanged (including everyting above <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span><span class="quoted">‚Äπ<span class="free">hi</span>‚Ä∫</span></span>)‚Ä∫</span>
  ‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThe main part of the partition function. The pivot is assumed to be the last element. This is
exactly the "Lomuto partition scheme" partition function from Wikipedia.‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">partition_main</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> bool<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">√ó</span> nat<span class="main">)</span> nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">partition_main</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="free"><span class="bound"><span class="entity">xs0</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    ASSERT<span class="main">(</span><span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs0</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="bound">pivot</span> <span class="main">‚Üê</span> RETURN <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs0</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span><span class="bound">xs</span><span class="main">)</span> <span class="main">‚Üê</span> WHILE<span class="hidden">‚á©</span><sub>T</sub><span class="hidden">‚áó</span><sup>partition_main_inv <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="free"><span class="bound"><span class="entity">xs0</span></span></span></sup><span class="hidden">‚áñ</span> <span class="comment1">‚Äï ‚ÄπWe loop from <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span><span class="quoted">‚Äπ<span class="free">j</span><span class="main">=</span><span class="free">lo</span>‚Ä∫</span></span> to <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span><span class="quoted">‚Äπ<span class="free">j</span><span class="main">=</span><span class="free">hi</span><span class="main">-</span><span class="main">1</span>‚Ä∫</span></span>.‚Ä∫</span>
      <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span><span class="bound">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">)</span>
      <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span><span class="bound">xs</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
        ASSERT<span class="main">(</span><span class="bound">i</span> <span class="main">&lt;</span> length <span class="bound">xs</span> <span class="main">‚àß</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="bound">xs</span><span class="main">)</span><span class="main">;</span>
      	<span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span><span class="bound">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="bound">pivot</span>
      	<span class="keyword1">then</span> RETURN <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">,</span> <span class="bound">j</span><span class="main">+</span><span class="main">1</span><span class="main">,</span> swap <span class="bound">xs</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span>
      	<span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">i</span><span class="main">,</span>   <span class="bound">j</span><span class="main">+</span><span class="main">1</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span>
      <span class="main">}</span><span class="main">)</span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lo</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs0</span></span></span><span class="main">)</span><span class="main">;</span> <span class="comment1">‚Äï ‚Äπi and j are both initialized to lo‚Ä∫</span>
    ASSERT<span class="main">(</span><span class="bound">i</span> <span class="main">&lt;</span> length <span class="bound">xs</span> <span class="main">‚àß</span> <span class="bound">j</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="main">‚â§</span> <span class="bound">i</span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="main">&lt;</span> length <span class="bound">xs</span> <span class="main">‚àß</span> mset <span class="bound">xs</span> <span class="main">=</span> mset <span class="free"><span class="bound"><span class="entity">xs0</span></span></span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="main">(</span>swap <span class="bound">xs</span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span>
  <span class="main">}</span>‚Ä∫</span></span>

<span class="comment1">(*
definition partition_spec :: ‚Äπ('b ‚áí 'b ‚áí bool) ‚áí ('a ‚áí 'b) ‚áí 'a list ‚áí nat ‚áí nat ‚áí 'a list ‚áí nat ‚áí bool‚Ä∫ where
  ‚Äπpartition_spec R h xs lo hi xs' p ‚â°
    mset xs' = mset xs ‚àß ‚Äï ‚ÄπThe list is a permutation‚Ä∫
    isPartition_map R h xs' lo hi p ‚àß ‚Äï ‚ÄπWe have a valid partition on the resulting list‚Ä∫
    lo ‚â§ p ‚àß p ‚â§ hi ‚àß ‚Äï ‚ÄπThe partition index is in bounds‚Ä∫
    (‚àÄ i. i&lt;lo ‚ü∂ xs'!i=xs!i) ‚àß (‚àÄ i. hi&lt;i‚àßi&lt;length xs' ‚ü∂ xs'!i=xs!i)‚Ä∫ ‚Äï ‚ÄπEverything else is unchanged.‚Ä∫
*)</span>

<span class="keyword1"><span class="command">lemma</span></span> partition_main_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bounds<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    trans<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span><span class="main">;</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> lin<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">‚à®</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπpartition_main <span class="free">R</span> <span class="free">h</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs</span> <span class="main">‚â§</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">xs'</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> mset <span class="free">xs</span> <span class="main">=</span> mset <span class="bound">xs'</span> <span class="main">‚àß</span>
     <span class="free">lo</span> <span class="main">‚â§</span> <span class="bound">p</span> <span class="main">‚àß</span> <span class="bound">p</span> <span class="main">‚â§</span> <span class="free">hi</span> <span class="main">‚àß</span> isPartition_map <span class="free">R</span> <span class="free">h</span> <span class="bound">xs'</span> <span class="free">lo</span> <span class="free">hi</span> <span class="bound">p</span> <span class="main">‚àß</span> <span class="main">(</span><span class="main">‚àÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">lo</span> <span class="main">‚ü∂</span> <span class="bound">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="main">‚àÄ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">hi</span><span class="main">&lt;</span><span class="bound">i</span><span class="main">‚àß</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="bound">xs'</span> <span class="main">‚ü∂</span> <span class="bound">xs'</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">b</span> <span class="main">‚â§</span> <span class="skolem">hi</span> <span class="main">-</span> Suc <span class="skolem">n</span> <span class="main">‚üπ</span> <span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">‚üπ</span> Suc <span class="skolem">n</span> <span class="main">‚â§</span> <span class="skolem">hi</span> <span class="main">‚üπ</span> Suc <span class="skolem">b</span> <span class="main">‚â§</span> <span class="skolem">hi</span> <span class="main">-</span> <span class="skolem">n</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span> <span class="skolem">hi</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">~</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="skolem">x</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="comment1">‚Äï ‚ÄπCorollary of linearity‚Ä∫</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">a</span> <span class="main">&lt;</span> Suc <span class="skolem">b</span> <span class="main">‚â°</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">‚à®</span> <span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">b</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">a</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">‚â§</span> <span class="skolem">b</span> <span class="main">‚â°</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">‚à®</span> <span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">b</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> partition_main_def choose_pivot_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> WHILEIT_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">‚Äπmeasure<span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span><span class="bound">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">hi</span><span class="main">-</span><span class="bound">j</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="comment1">‚Äï ‚ÄπWe feed our assumption to the assertion‚Ä∫</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">‚Äï ‚ÄπWF‚Ä∫</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="comment1">‚Äï ‚ÄπInvariant holds before the first iteration‚Ä∫</span>
      <span class="keyword1"><span class="command">unfolding</span></span> partition_main_inv_def
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> partition_main_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> partition_main_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> partition_main_inv_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_length<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> partition_main_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_length<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> partition_main_inv_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_length<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L M mset_eq_length nat_le_eq_or_lt<span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> partition_main_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="comment1">‚Äï ‚Äπassertions, etc‚Ä∫</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> partition_main_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> partition_main_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_length<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> partition_main_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> partition_main_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_length<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> partition_main_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_length<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> partition_main_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_length<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> partition_main_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> partition_main_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="comment1">‚Äï ‚ÄπAfter the last iteration, we have a partitioning! :-)‚Ä∫</span>
      <span class="keyword1"><span class="command">unfolding</span></span> partition_main_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isPartition_wrt_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="comment1">‚Äï ‚ÄπAnd the lower out-of-bounds parts of the list haven't been changed‚Ä∫</span>
      <span class="keyword1"><span class="command">unfolding</span></span> partition_main_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="comment1">‚Äï ‚ÄπAnd the upper out-of-bounds parts of the list haven't been changed‚Ä∫</span>
      <span class="keyword1"><span class="command">unfolding</span></span> partition_main_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">partition_between</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> bool<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">√ó</span> nat<span class="main">)</span> nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">partition_between</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="free"><span class="bound"><span class="entity">xs0</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    ASSERT<span class="main">(</span><span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs0</span></span></span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="main">‚â§</span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="bound">k</span> <span class="main">‚Üê</span> choose_pivot <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">xs0</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">;</span> <span class="comment1">‚Äï ‚Äπchoice of pivot‚Ä∫</span>
    ASSERT<span class="main">(</span><span class="bound">k</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs0</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="bound">xs</span> <span class="main">‚Üê</span> RETURN <span class="main">(</span>swap <span class="free"><span class="bound"><span class="entity">xs0</span></span></span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">)</span><span class="main">;</span> <span class="comment1">‚Äï ‚Äπmove the pivot to the last position, before we start the actual loop‚Ä∫</span>
    ASSERT<span class="main">(</span>length <span class="bound">xs</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">xs0</span></span></span><span class="main">)</span><span class="main">;</span>
    partition_main <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="bound">xs</span>
  <span class="main">}</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">lemma</span></span> partition_between_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span><span class="main">;</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">‚à®</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπpartition_between <span class="free">R</span> <span class="free">h</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs</span> <span class="main">‚â§</span> SPEC<span class="main">(</span>uncurry <span class="main">(</span>partition_spec <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">b</span> <span class="main">‚â§</span> <span class="skolem">hi</span> <span class="main">-</span> Suc <span class="skolem">n</span> <span class="main">‚üπ</span> <span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">‚üπ</span> Suc <span class="skolem">n</span> <span class="main">‚â§</span> <span class="skolem">hi</span> <span class="main">‚üπ</span> Suc <span class="skolem">b</span> <span class="main">‚â§</span> <span class="skolem">hi</span> <span class="main">-</span> <span class="skolem">n</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span> <span class="skolem">hi</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> partition_between_def choose_pivot_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> partition_main_correct<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_length <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_spec_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.strict_trans2 less_imp_not_eq2 mset_eq_length swap_nth<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπWe use the median of the first, the middle, and the last element.‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">choose_pivot3</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">choose_pivot3</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    ASSERT<span class="main">(</span><span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">;</span>
    ASSERT<span class="main">(</span><span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">k'</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">k</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="main">+</span> <span class="bound">k'</span><span class="main">;</span>
    ASSERT<span class="main">(</span><span class="bound">k</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">start</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">mid</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">end</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">start</span> <span class="bound">mid</span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">mid</span> <span class="bound">end</span><span class="main">)</span> <span class="main">‚à®</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">end</span> <span class="bound">mid</span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">mid</span> <span class="bound">start</span><span class="main">)</span> <span class="keyword1">then</span> RETURN <span class="bound">k</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">start</span> <span class="bound">end</span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">end</span> <span class="bound">mid</span><span class="main">)</span> <span class="main">‚à®</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">mid</span> <span class="bound">end</span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">end</span> <span class="bound">start</span><span class="main">)</span> <span class="keyword1">then</span> RETURN <span class="free"><span class="bound"><span class="entity">hi</span></span></span>
    <span class="keyword1">else</span> RETURN <span class="free"><span class="bound"><span class="entity">lo</span></span></span>
<span class="main">}</span>‚Ä∫</span></span>

<span class="comment1">‚Äï ‚ÄπWe only have to show that this procedure yields a valid index between <span class="antiquoted"><span class="raw_text"><span class="operator">‚Äπ</span>lo‚Ä∫</span></span> and <span class="antiquoted"><span class="raw_text"><span class="operator">‚Äπ</span>hi‚Ä∫</span></span>.‚Ä∫</span>
<span class="keyword1"><span class="command">lemma</span></span> choose_pivot3_choose_pivot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">‚â•</span> <span class="free">lo</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπchoose_pivot3 <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span> <span class="main">‚â§</span> <span class="main">‚áì</span> Id <span class="main">(</span>choose_pivot <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> choose_pivot3_def choose_pivot_def
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ASSERT_leI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThe refined partion function: We use the above pivot function and fold instead of non-deterministic iteration.‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">partition_between_ref</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> bool<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">√ó</span> nat<span class="main">)</span> nres‚Ä∫</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">partition_between_ref</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="free"><span class="bound"><span class="entity">xs0</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    ASSERT<span class="main">(</span><span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs0</span></span></span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs0</span></span></span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="main">‚â§</span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="bound">k</span> <span class="main">‚Üê</span> choose_pivot3 <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">xs0</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">;</span> <span class="comment1">‚Äï ‚Äπchoice of pivot‚Ä∫</span>
    ASSERT<span class="main">(</span><span class="bound">k</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs0</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="bound">xs</span> <span class="main">‚Üê</span> RETURN <span class="main">(</span>swap <span class="free"><span class="bound"><span class="entity">xs0</span></span></span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">)</span><span class="main">;</span> <span class="comment1">‚Äï ‚Äπmove the pivot to the last position, before we start the actual loop‚Ä∫</span>
    ASSERT<span class="main">(</span>length <span class="bound">xs</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">xs0</span></span></span><span class="main">)</span><span class="main">;</span>
    partition_main <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span> <span class="bound">xs</span>
  <span class="main">}</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">lemma</span></span> partition_main_ref'<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπpartition_main <span class="free">R</span> <span class="free">h</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs</span>
    <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">(</span><span class="main">(</span><span class="main">Œª</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">.</span> Id<span class="main">)</span> <span class="free">a</span> <span class="free">b</span> <span class="free">c</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span>partition_main <span class="free">R</span> <span class="free">h</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="comment1">(*TODO already exists somewhere*)</span>
<span class="keyword1"><span class="command">lemma</span></span> Down_id_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚áì</span>Id <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> partition_between_ref_partition_between<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπpartition_between_ref <span class="free">R</span> <span class="free">h</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs</span> <span class="main">‚â§</span> <span class="main">(</span>partition_between <span class="free">R</span> <span class="free">h</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> swap<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>swap <span class="free">xs</span> <span class="skolem">k</span> <span class="free">hi</span><span class="main">,</span> swap <span class="free">xs</span> <span class="skolem">ka</span> <span class="free">hi</span><span class="main">)</span> <span class="main">‚àà</span> Id‚Ä∫</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">ka</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="skolem">ka</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">refine0</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="skolem">xsa</span> <span class="main">!</span> <span class="free">hi</span><span class="main">)</span><span class="main">,</span> <span class="free">h</span> <span class="main">(</span><span class="skolem">xsaa</span> <span class="main">!</span> <span class="free">hi</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> Id‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">xsa</span><span class="main">,</span> <span class="skolem">xsaa</span><span class="main">)</span> <span class="main">‚àà</span> Id‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xsa</span> <span class="skolem">xsaa</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Down_id_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> partition_between_ref_def
      partition_between_def
      OP_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> choose_pivot3_choose_pivot swap partition_main_correct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Refine_Basic.Id_refine <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_length<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπTechnical lemma for sepref‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> partition_between_ref_partition_between'<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>uncurry2 <span class="main">(</span>partition_between_ref <span class="free">R</span> <span class="free">h</span><span class="main">)</span><span class="main">,</span> uncurry2 <span class="main">(</span>partition_between <span class="free">R</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span>
    <span class="main">(</span>nat_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> nat_rel<span class="main">)</span> <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> <span class="main">‚ü®</span>Id<span class="main">‚ü©</span>list_rel <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>f</sub></span> <span class="main">‚ü®</span><span class="main">‚ü®</span>Id<span class="main">‚ü©</span>list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> nat_rel<span class="main">‚ü©</span>nres_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> frefI nres_relI<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> partition_between_ref_partition_between<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπExample instantiation for pivot‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">choose_pivot3_impl</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">choose_pivot3_impl</span> <span class="main">=</span> choose_pivot3 <span class="main">(‚â§)</span> id‚Ä∫</span></span>


<span class="keyword1"><span class="command">lemma</span></span> partition_between_ref_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span><span class="main">;</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> lin<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">‚à®</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bounds<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπpartition_between_ref <span class="free">R</span> <span class="free">h</span> <span class="free">lo</span> <span class="free">hi</span> <span class="free">xs</span> <span class="main">‚â§</span> SPEC <span class="main">(</span>uncurry <span class="main">(</span>partition_spec <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="free">lo</span> <span class="free">hi</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> partition_between_ref_partition_between<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> bounds <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> partition_between_correct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">h</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lin<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπRefined quicksort algorithm: We use the refined partition function.‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">quicksort_ref</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">‚áí</span> <span class="main">_</span> <span class="main">‚áí</span> nat <span class="main">√ó</span> nat <span class="main">√ó</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> list nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">quicksort_ref</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">lo</span><span class="main">,</span><span class="bound">hi</span><span class="main">,</span><span class="bound">xs0</span><span class="main">)</span><span class="main">.</span>
  <span class="keyword1">do</span> <span class="main">{</span>
  RECT <span class="main">(</span><span class="main">Œª</span><span class="bound">f</span> <span class="main">(</span><span class="bound">lo</span><span class="main">,</span><span class="bound">hi</span><span class="main">,</span><span class="bound">xs</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      ASSERT<span class="main">(</span><span class="bound">lo</span> <span class="main">‚â§</span> <span class="bound">hi</span> <span class="main">‚àß</span> <span class="bound">hi</span> <span class="main">&lt;</span> length <span class="bound">xs0</span> <span class="main">‚àß</span> mset <span class="bound">xs</span> <span class="main">=</span> mset <span class="bound">xs0</span><span class="main">)</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">‚Üê</span> partition_between_ref <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="bound">lo</span> <span class="bound">hi</span> <span class="bound">xs</span><span class="main">;</span> <span class="comment1">‚Äï ‚ÄπThis is the refined partition function. Note that we need the premises (trans,lin,bounds) here.‚Ä∫</span>
      ASSERT<span class="main">(</span>mset <span class="bound">xs</span> <span class="main">=</span> mset <span class="bound">xs0</span> <span class="main">‚àß</span> <span class="bound">p</span> <span class="main">‚â•</span> <span class="bound">lo</span> <span class="main">‚àß</span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="bound">xs0</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">xs</span> <span class="main">‚Üê</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">p</span><span class="main">-</span><span class="main">1</span><span class="main">‚â§</span><span class="bound">lo</span> <span class="keyword1">then</span> RETURN <span class="bound">xs</span> <span class="keyword1">else</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">lo</span><span class="main">,</span> <span class="bound">p</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      ASSERT<span class="main">(</span>mset <span class="bound">xs</span> <span class="main">=</span> mset <span class="bound">xs0</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">if</span> <span class="bound">hi</span><span class="main">‚â§</span><span class="bound">p</span><span class="main">+</span><span class="main">1</span> <span class="keyword1">then</span> RETURN <span class="bound">xs</span> <span class="keyword1">else</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">p</span><span class="main">+</span><span class="main">1</span><span class="main">,</span> <span class="bound">hi</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span>
    <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="bound">lo</span><span class="main">,</span><span class="bound">hi</span><span class="main">,</span><span class="bound">xs0</span><span class="main">)</span>
  <span class="main">}</span><span class="main">)</span>‚Ä∫</span></span>


<span class="comment1">(*TODO share*)</span>
<span class="keyword1"><span class="command">lemma</span></span> fref_to_Down_curry2<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>uncurry2 <span class="free">f</span><span class="main">,</span> uncurry2 <span class="free">g</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">[</span><span class="free">P</span><span class="keyword1">]<span class="hidden">‚á©</span><sub>f</sub></span> <span class="free">A</span> <span class="main">‚Üí</span> <span class="main">‚ü®</span><span class="free">B</span><span class="main">‚ü©</span>nres_rel <span class="main">‚üπ</span>
     <span class="main">(</span><span class="main">‚ãÄ</span><span class="bound">x</span> <span class="bound">x'</span> <span class="bound">y</span> <span class="bound">y'</span> <span class="bound">z</span> <span class="bound">z'</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">y'</span><span class="main">)</span><span class="main">,</span> <span class="bound">z'</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">y'</span><span class="main">)</span><span class="main">,</span> <span class="bound">z'</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">A</span><span class="main">‚üπ</span>
         <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="free">B</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x'</span> <span class="bound">y'</span> <span class="bound">z'</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fref_def uncurry_def nres_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fref_to_Down_curry<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">[</span><span class="free">P</span><span class="keyword1">]<span class="hidden">‚á©</span><sub>f</sub></span> <span class="free">A</span> <span class="main">‚Üí</span> <span class="main">‚ü®</span><span class="free">B</span><span class="main">‚ü©</span>nres_rel <span class="main">‚üπ</span>
     <span class="main">(</span><span class="main">‚ãÄ</span><span class="bound">x</span> <span class="bound">x'</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">x'</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">A</span><span class="main">‚üπ</span>
         <span class="free">f</span> <span class="bound">x</span>  <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="free">B</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fref_def uncurry_def nres_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>



<span class="keyword1"><span class="command">lemma</span></span> quicksort_ref_quicksort<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bounds<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hi</span> <span class="main">&lt;</span> length <span class="free">xs</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">lo</span> <span class="main">‚â§</span> <span class="free">hi</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    trans<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span><span class="main">;</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> lin<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">‚à®</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπquicksort_ref <span class="free">R</span> <span class="free">h</span> <span class="free">x0</span> <span class="main">‚â§</span> <span class="main">‚áì</span> Id <span class="main">(</span>quicksort <span class="free">R</span> <span class="free">h</span> <span class="free">x0</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπwf <span class="main">(</span>measure <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">lo</span><span class="main">,</span> <span class="bound">hi</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span><span class="main">.</span> Suc <span class="bound">hi</span> <span class="main">-</span> <span class="bound">lo</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x0</span> <span class="main">=</span> <span class="skolem">x0'</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="skolem">x0</span><span class="main">,</span> <span class="skolem">x0'</span><span class="main">)</span> <span class="main">‚àà</span> Id <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> Id <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> <span class="main">‚ü®</span>Id<span class="main">‚ü©</span>list_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x0</span> <span class="skolem">x0'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπnat <span class="main">√ó</span> nat <span class="main">√ó</span> <span class="tfree">'b</span> list‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">refine0</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">x1e</span> <span class="main">=</span> <span class="skolem">x1d</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="skolem">x1e</span><span class="main">,</span><span class="skolem">x1d</span><span class="main">)</span> <span class="main">‚àà</span> Id‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x1e</span> <span class="skolem">x1d</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="tfree">'b</span> list‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> quicksort_def quicksort_ref_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> pre partition_between_ref_partition_between'<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> fref_to_Down_curry2<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπFirst assertion (premise for partition)‚Ä∫</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπFirst assertion (premise for partition)‚Ä∫</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_length<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_length mset_eq_setD<span class="main">)</span>

    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπCorrectness of the concrete partition function‚Ä∫</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> partition_between_ref_correct<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lin<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">‚Äï ‚Äπfirst premise‚Ä∫</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">‚Äï ‚Äπsecond premise‚Ä∫</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_length mset_eq_setD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> partition_spec_def isPartition_wrt_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> partition_spec_def isPartition_wrt_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_length<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_length mset_eq_setD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_length mset_eq_setD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_length mset_eq_setD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_length mset_eq_setD<span class="main">)</span>

    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">‚Äï ‚ÄπSort the entire list‚Ä∫</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">full_quicksort</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">full_quicksort</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">‚â°</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> RETURN <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">else</span> quicksort <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">full_quicksort_ref</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">full_quicksort_ref</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">‚â°</span>
    <span class="keyword1">if</span> List.null <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">then</span> RETURN <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
    <span class="keyword1">else</span> quicksort_ref <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">full_quicksort_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπnat list <span class="main">‚áí</span> nat list nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">full_quicksort_impl</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> full_quicksort_ref <span class="main">(‚â§)</span> id <span class="free"><span class="bound"><span class="entity">xs</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> full_quicksort_ref_full_quicksort<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span><span class="main">;</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> lin<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">‚à®</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>full_quicksort_ref <span class="free">R</span> <span class="free">h</span><span class="main">,</span> full_quicksort <span class="free">R</span> <span class="free">h</span><span class="main">)</span> <span class="main">‚àà</span>
          <span class="main">‚ü®</span>Id<span class="main">‚ü©</span>list_rel <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>f</sub></span> <span class="main">‚ü®</span> <span class="main">‚ü®</span>Id<span class="main">‚ü©</span>list_rel<span class="main">‚ü©</span>nres_rel‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> full_quicksort_ref_def full_quicksort_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> frefI nres_relI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> quicksort_ref_quicksort<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> Down_id_eq<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> List.null_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> lin <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> sublist_entire<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπsublist <span class="free">xs</span> <span class="main">0</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> sorted_sublist_wrt_entire<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_wrt <span class="free">R</span> <span class="free">xs</span> <span class="main">0</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_wrt <span class="free">R</span> <span class="free">xs</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_wrt <span class="free">R</span> <span class="main">(</span>sublist <span class="free">xs</span> <span class="main">0</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_sublist_wrt_def <span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sublist_entire<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_sublist_map_entire<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_sublist_map <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="main">0</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_wrt <span class="main">(</span><span class="main">Œª</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_sublist_wrt_entire<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπFinal correctness lemma‚Ä∫</span></span>
<span class="keyword1"><span class="command">theorem</span></span> full_quicksort_correct_sorted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    trans<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span><span class="main">;</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> lin<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">‚â†</span> <span class="bound">y</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">‚à®</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπfull_quicksort <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="main">‚â§</span> <span class="main">‚áì</span> Id <span class="main">(</span>SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">xs'</span><span class="main">.</span> mset <span class="bound">xs'</span> <span class="main">=</span> mset <span class="free">xs</span> <span class="main">‚àß</span> sorted_wrt <span class="main">(</span><span class="main">Œª</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="bound">xs'</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> full_quicksort_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="comment1">‚Äï ‚Äπcase xs=[]‚Ä∫</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="comment1">‚Äï ‚Äπcase xs=[]‚Ä∫</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> quicksort_correct<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lin<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Misc.subset_Collect_conv<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_post_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sorted_sublist_map_entire<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_post_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_length<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> full_quicksort_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    trans<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">‚ü¶</span><span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span><span class="main">;</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span><span class="main">‚üß</span> <span class="main">‚üπ</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    lin<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">‚à®</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπfull_quicksort <span class="free">R</span> <span class="free">h</span> <span class="free">xs</span> <span class="main">‚â§</span> <span class="main">‚áì</span> Id <span class="main">(</span>SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">xs'</span><span class="main">.</span> mset <span class="bound">xs'</span> <span class="main">=</span> mset <span class="free">xs</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> full_quicksort_correct_sorted<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="More_Loops">
<div class="head">
<h1>Theory More_Loops</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:         More_Loops.thy
  Author:       Mathias Fleury, Daniela Kaufmann, JKU
  Maintainer:   Mathias Fleury, JKU
*)</span>
<span class="keyword1"><span class="command">theory</span></span> More_Loops
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../Refine_Monadic/Refine_While.html">Refine_Monadic.Refine_While</a>"</span>
  <span class="quoted">"<a href="../Refine_Monadic/Refine_Foreach.html">Refine_Monadic.Refine_Foreach</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Rewrite.html">HOL-Library.Rewrite</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπMore Theorem about Loops‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπMost theorem below have a counterpart in the Refinement Framework that is weaker (by missing
  assertions for example that are critical for code generation).
‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> Down_id_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚áì</span>Id <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> while_upt_while_direct1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">‚â•</span> <span class="free">a</span> <span class="main">‚üπ</span>
  <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">œÉ</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="keyword1">WHILE<span class="hidden">‚á©</span><sub>T</sub></span> <span class="main">(</span>FOREACH_cond <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="main">(</span>FOREACH_cond <span class="free">c</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> FOREACH_body <span class="free">f</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>
      <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span><span class="main">,</span><span class="free">œÉ</span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="bound">œÉ</span>
  <span class="main">}</span> <span class="main">‚â§</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">œÉ</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="keyword1">WHILE<span class="hidden">‚á©</span><sub>T</sub></span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">‚àß</span> <span class="free">c</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="main">(</span><span class="bound">i</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">)</span><span class="main">;</span>  <span class="bound">œÉ'</span><span class="main">‚Üê</span><span class="free">f</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">;</span> RETURN <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">,</span><span class="bound">œÉ'</span><span class="main">)</span>
<span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">œÉ</span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="bound">œÉ</span>
  <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚â§</span></span> <span class="main"><span class="main">‚åë</span></span>‚Ä∫</span></span></span> Down_id_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> WHILET_refine<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">i</span><span class="main">::</span>nat<span class="main">,</span> <span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span> <span class="bound">x'</span> <span class="main">‚àß</span> <span class="bound">i</span> <span class="main">‚â§</span> <span class="free">b</span> <span class="main">‚àß</span> <span class="bound">i</span> <span class="main">‚â•</span> <span class="free">a</span> <span class="main">‚àß</span>
     <span class="bound">l</span> <span class="main">=</span> drop <span class="main">(</span><span class="bound">i</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span><span class="main">}</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> FOREACH_cond_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> FOREACH_body_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_refine<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Id_refine<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> while_upt_while_direct2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">‚â•</span> <span class="free">a</span> <span class="main">‚üπ</span>
  <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">œÉ</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="keyword1">WHILE<span class="hidden">‚á©</span><sub>T</sub></span> <span class="main">(</span>FOREACH_cond <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="main">(</span>FOREACH_cond <span class="free">c</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> FOREACH_body <span class="free">f</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>
      <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span><span class="main">,</span><span class="free">œÉ</span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="bound">œÉ</span>
  <span class="main">}</span> <span class="main">‚â•</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">œÉ</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="keyword1">WHILE<span class="hidden">‚á©</span><sub>T</sub></span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">‚àß</span> <span class="free">c</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="main">(</span><span class="bound">i</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">)</span><span class="main">;</span>  <span class="bound">œÉ'</span><span class="main">‚Üê</span><span class="free">f</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">;</span> RETURN <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">,</span><span class="bound">œÉ'</span><span class="main">)</span>
<span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">œÉ</span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="bound">œÉ</span>
  <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚â§</span></span> <span class="main"><span class="main">‚åë</span></span>‚Ä∫</span></span></span> Down_id_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> WHILET_refine<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">i</span><span class="main">::</span>nat<span class="main">,</span> <span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span> <span class="bound">x'</span> <span class="main">‚àß</span> <span class="bound">i</span> <span class="main">‚â§</span> <span class="free">b</span> <span class="main">‚àß</span> <span class="bound">i</span> <span class="main">‚â•</span> <span class="free">a</span> <span class="main">‚àß</span>
    <span class="bound">l</span> <span class="main">=</span> drop <span class="main">(</span><span class="bound">i</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span><span class="main">}</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> FOREACH_cond_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> FOREACH_body_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_refine<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Id_refine<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> FOREACH_body_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_refine<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Id_refine<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> while_upt_while_direct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">‚â•</span> <span class="free">a</span> <span class="main">‚üπ</span>
  <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">œÉ</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="keyword1">WHILE<span class="hidden">‚á©</span><sub>T</sub></span> <span class="main">(</span>FOREACH_cond <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="main">(</span>FOREACH_cond <span class="free">c</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> FOREACH_body <span class="free">f</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>
      <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span><span class="main">,</span><span class="free">œÉ</span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="bound">œÉ</span>
  <span class="main">}</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">œÉ</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="keyword1">WHILE<span class="hidden">‚á©</span><sub>T</sub></span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">‚àß</span> <span class="free">c</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="main">(</span><span class="bound">i</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">)</span><span class="main">;</span>  <span class="bound">œÉ'</span><span class="main">‚Üê</span><span class="free">f</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">;</span> RETURN <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">,</span><span class="bound">œÉ'</span><span class="main">)</span>
<span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">œÉ</span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="bound">œÉ</span>
  <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> while_upt_while_direct1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> while_upt_while_direct2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> order_class.eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> while_nfoldli<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">œÉ</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="keyword1">WHILE<span class="hidden">‚á©</span><sub>T</sub></span> <span class="main">(</span>FOREACH_cond <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="main">(</span>FOREACH_cond <span class="free">c</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> FOREACH_body <span class="free">f</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">œÉ</span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="bound">œÉ</span>
  <span class="main">}</span> <span class="main">‚â§</span> nfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">œÉ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">œÉ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> WHILET_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FOREACH_cond_def<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> WHILET_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span>
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> FOREACH_cond_def FOREACH_body_def
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bind_mono Refine_Basic.bind_mono<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">lemma</span></span> nfoldli_while<span class="main">:</span> <span class="quoted"><span class="quoted">"nfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">œÉ</span>
          <span class="main">‚â§</span>
         <span class="main">(</span>WHILE<span class="hidden">‚á©</span><sub>T</sub><span class="hidden">‚áó</span><sup><span class="free">I</span></sup><span class="hidden">‚áñ</span>
           <span class="main">(</span>FOREACH_cond <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="main">(</span>FOREACH_cond <span class="free">c</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> FOREACH_body <span class="free">f</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">œÉ</span><span class="main">)</span> <span class="main">‚§ú</span>
          <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">œÉ</span><span class="main">)</span><span class="main">.</span> RETURN <span class="bound">œÉ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">œÉ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> WHILEIT_unfold<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> FOREACH_cond_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">ls</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">œÉ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> WHILEIT_unfold<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> FOREACH_cond_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> True
    <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> WHILEIT_unfold<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> FOREACH_cond_def FOREACH_body_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Refine_Basic.bind_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> while_eq_nfoldli<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">œÉ</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="keyword1">WHILE<span class="hidden">‚á©</span><sub>T</sub></span> <span class="main">(</span>FOREACH_cond <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="main">(</span>FOREACH_cond <span class="free">c</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> FOREACH_body <span class="free">f</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">œÉ</span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="bound">œÉ</span>
  <span class="main">}</span> <span class="main">=</span> nfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">œÉ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> while_nfoldli<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nfoldli_while<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted">"<span class="main">Œª</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> WHILET_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="PAC_Specification">
<div class="head">
<h1>Theory PAC_Specification</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:         PAC_Specification.thy
  Author:       Mathias Fleury, Daniela Kaufmann, JKU
  Maintainer:   Mathias Fleury, JKU
*)</span>
<span class="keyword1"><span class="command">theory</span></span> PAC_Specification
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="PAC_More_Poly.html">PAC_More_Poly</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚ÄπSpecification of the PAC checker‚Ä∫</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπIdeals‚Ä∫</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> int_poly <span class="main">=</span> <span class="quoted"><span class="quoted">‚Äπint mpoly‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">polynomial_bool</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint_poly set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">polynomial_bool</span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">c</span><span class="main">.</span> Var <span class="bound">c</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> Var <span class="bound">c</span><span class="main">)</span> <span class="main">`</span> UNIV‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pac_ideal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">pac_ideal</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">‚â°</span> ideal <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">‚à™</span> polynomial_bool<span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> X2_X_in_pac_ideal<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπVar <span class="free">c</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> Var <span class="free">c</span> <span class="main">‚àà</span> pac_ideal <span class="free">A</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> polynomial_bool_def pac_ideal_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ideal.span_base<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pac_idealI1<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">‚àà</span> <span class="free">A</span> <span class="main">‚üπ</span> <span class="free">p</span> <span class="main">‚àà</span> pac_ideal <span class="free">A</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pac_ideal_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ideal.span_base<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pac_idealI2<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">‚àà</span> ideal <span class="free">A</span> <span class="main">‚üπ</span> <span class="free">p</span> <span class="main">‚àà</span> pac_ideal <span class="free">A</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> ideal.span_subspace_induct pac_ideal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> pac_idealI3<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">‚àà</span> ideal <span class="free">A</span> <span class="main">‚üπ</span> <span class="free">p</span><span class="main">*</span><span class="free">q</span> <span class="main">‚àà</span> pac_ideal <span class="free">A</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ideal.span_scale mult.commute pac_idealI2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pac_ideal_Xsq2_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπVar <span class="free">c</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">‚àà</span> pac_ideal <span class="free">A</span> <span class="main">‚ü∑</span> Var <span class="free">c</span> <span class="main">‚àà</span> pac_ideal <span class="free">A</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pac_ideal_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ideal.span_add_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> X2_X_in_pac_ideal<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">unfolded</span> pac_ideal_def<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_in_polynomial_bool_pac_idealI<span class="main">:</span>
   <span class="keyword2"><span class="keyword">assumes</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">‚àà</span> pac_ideal <span class="free">A</span>"</span></span>
   <span class="keyword2"><span class="keyword">assumes</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">-</span> <span class="free">p'</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool"</span></span>
   <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p'</span> <span class="main">‚àà</span> pac_ideal <span class="free">A</span>‚Ä∫</span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">p</span> polynomial_bool <span class="main">‚äÜ</span> pac_ideal <span class="free">A</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">unfolding</span></span> pac_ideal_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> ideal.span_superset insert_subset le_sup_iff<span class="main">)</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> a2 <span class="keyword1"><span class="command">unfolding</span></span> pac_ideal_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> ideal.eq_span_insert_eq ideal.span_subset_spanI ideal.span_superset insert_subset subsetD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_in_polynomial_bool_pac_idealI2<span class="main">:</span>
   <span class="keyword2"><span class="keyword">assumes</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">‚àà</span> <span class="free">A</span>"</span></span>
   <span class="keyword2"><span class="keyword">assumes</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">-</span> <span class="free">p'</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool"</span></span>
   <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p'</span> <span class="main">‚àà</span> pac_ideal <span class="free">A</span>‚Ä∫</span></span>
   <span class="keyword1"><span class="command">using</span></span> diff_in_polynomial_bool_pac_idealI<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ideal.span_base<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pac_ideal_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπpac_ideal <span class="free">A</span> <span class="main">=</span> ideal <span class="main">(</span><span class="free">A</span> <span class="main">‚à™</span> ideal polynomial_bool<span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pac_ideal_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> ideal.span_eq ideal.span_mono ideal.span_superset le_sup_iff subset_trans sup_ge2<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ

  The equality on ideals is restricted to polynomials whose variable
  appear in the set of ideals. The function restrict sets:

‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">restricted_ideal_to</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">restricted_ideal_to</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> vars <span class="bound">p</span>  <span class="main">‚äÜ</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">restricted_ideal_to<span class="hidden">‚á©</span><sub>I</sub></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">restricted_ideal_to<span class="hidden">‚á©</span><sub>I</sub></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">‚â°</span> restricted_ideal_to <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>pac_ideal <span class="main">(</span>set_mset <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">restricted_ideal_to<span class="hidden">‚á©</span><sub>V</sub></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">restricted_ideal_to<span class="hidden">‚á©</span><sub>V</sub></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">‚â°</span> restricted_ideal_to <span class="main">(</span><span class="main">‚ãÉ</span><span class="main">(</span>vars <span class="main">`</span> set_mset <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">restricted_ideal_to<span class="hidden">‚á©</span><sub>V</sub><span class="hidden">‚á©</span><sub>I</sub></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">restricted_ideal_to<span class="hidden">‚á©</span><sub>V</sub><span class="hidden">‚á©</span><sub>I</sub></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">‚â°</span> restricted_ideal_to <span class="main">(</span><span class="main">‚ãÉ</span><span class="main">(</span>vars <span class="main">`</span> set_mset <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pac_ideal <span class="main">(</span>set_mset <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">lemma</span></span> restricted_idealI<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>set_mset <span class="free">A</span><span class="main">)</span> <span class="main">‚üπ</span> vars <span class="free">p</span> <span class="main">‚äÜ</span> <span class="free">C</span> <span class="main">‚üπ</span> <span class="free">p</span> <span class="main">‚àà</span> restricted_ideal_to<span class="hidden">‚á©</span><sub>I</sub> <span class="free">C</span> <span class="free">A</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> restricted_ideal_to_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> pac_ideal_insert_already_in<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">pq</span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>set_mset <span class="free">A</span><span class="main">)</span> <span class="main">‚üπ</span> pac_ideal <span class="main">(</span>insert <span class="free">pq</span> <span class="main">(</span>set_mset <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> pac_ideal <span class="main">(</span>set_mset <span class="free">A</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pac_ideal_alt_def ideal.span_insert_idI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pac_ideal_add<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">‚àà#</span> <span class="free">A</span> <span class="main">‚üπ</span> <span class="free">q</span> <span class="main">‚àà#</span> <span class="free">A</span> <span class="main">‚üπ</span> <span class="free">p</span> <span class="main">+</span> <span class="free">q</span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>set_mset <span class="free">A</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ideal.span_add ideal.span_base pac_ideal_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> pac_ideal_mult<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">‚àà#</span> <span class="free">A</span> <span class="main">‚üπ</span> <span class="free">p</span> <span class="main">*</span> <span class="free">q</span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>set_mset <span class="free">A</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ideal.span_base pac_idealI3<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pac_ideal_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">A</span> <span class="main">‚äÜ</span> <span class="free">B</span> <span class="main">‚üπ</span> pac_ideal <span class="free">A</span> <span class="main">‚äÜ</span> pac_ideal <span class="free">B</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> ideal.span_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">A</span> <span class="main">‚à™</span> <span class="main">_</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">B</span> <span class="main">‚à™</span> <span class="main">_</span>‚Ä∫</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pac_ideal_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ideal.span_mono<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπPAC Format‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThe PAC format contains three kind of steps:
  <span class="antiquoted"><span class="antiquoted">‚ñ™</span></span> <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">‚ñ©</span></span><span class="raw_text"><span class="raw_text">‚Äπadd‚Ä∫</span></span></span></span> that adds up two polynomials that are known.
  <span class="antiquoted"><span class="antiquoted">‚ñ™</span></span> <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">‚ñ©</span></span><span class="raw_text"><span class="raw_text">‚Äπmult‚Ä∫</span></span></span></span> that multiply a known polynomial with another one.
  <span class="antiquoted"><span class="antiquoted">‚ñ™</span></span> <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">‚ñ©</span></span><span class="raw_text"><span class="raw_text">‚Äπdel‚Ä∫</span></span></span></span> that removes a polynomial that cannot be reused anymore.

To model the simplification that happens, we add the <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">p</span></span> <span class="main"><span class="main">-</span></span> <span class="free"><span class="free">p'</span></span> <span class="main"><span class="main">‚àà</span></span> polynomial_bool‚Ä∫</span></span></span></span>
stating that <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">p</span></span>‚Ä∫</span></span></span></span> and  <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">p'</span></span>‚Ä∫</span></span></span></span> are equivalent.
‚Ä∫</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> pac_st <span class="main">=</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>nat set <span class="main">√ó</span> int_poly multiset<span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">PAC_Format</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπpac_st <span class="main">‚áí</span> pac_st <span class="main">‚áí</span> bool‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
add<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">PAC_Format</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ùí±</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ùí±</span></span></span><span class="main">,</span> add_mset <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword2"><span class="keyword">if</span></span>
   <span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚àà#</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">‚àà#</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>‚Ä∫</span></span>
   <span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="main">‚àà</span> ideal polynomial_bool‚Ä∫</span></span>
   <span class="quoted"><span class="quoted">‚Äπvars <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="main">‚äÜ</span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span>‚Ä∫</span></span> <span class="main">|</span>
mult<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">PAC_Format</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ùí±</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ùí±</span></span></span><span class="main">,</span> add_mset <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword2"><span class="keyword">if</span></span>
   <span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚àà#</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>‚Ä∫</span></span>
   <span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="main">‚àà</span> ideal polynomial_bool‚Ä∫</span></span>
   <span class="quoted"><span class="quoted">‚Äπvars <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="main">‚äÜ</span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span>‚Ä∫</span></span>
   <span class="quoted"><span class="quoted">‚Äπvars <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">‚äÜ</span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span>‚Ä∫</span></span> <span class="main">|</span>
del<span class="main">:</span>
   <span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚àà#</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">‚üπ</span> <span class="free">PAC_Format</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ùí±</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ùí±</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">-</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">#}</span><span class="main">)</span>‚Ä∫</span></span> <span class="main">|</span>
extend_pos<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">PAC_Format</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ùí±</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ùí±</span></span></span> <span class="main">‚à™</span> <span class="main">{</span><span class="bound"><span class="bound">x'</span></span> <span class="main">‚àà</span> vars <span class="main">(</span><span class="main">-</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">‚àâ</span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span><span class="main">}</span><span class="main">,</span> add_mset <span class="main">(</span><span class="main">-</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">if</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free"><span class="bound"><span class="entity">p'</span></span></span><span class="main">)</span><span class="main"><span class="hidden">‚áß</span><sup>2</sup></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="main">‚àà</span> ideal polynomial_bool‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπvars <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="main">‚äÜ</span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">‚àâ</span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span>  <span class="quoted"><span class="plain_text">‚Äπ
  In the PAC format above, we have a technical condition on the
  normalisation: <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπvars <span class="free"><span class="free">p'</span></span> <span class="main"><span class="main">‚äÜ</span></span> vars <span class="main"><span class="main">(</span></span><span class="free"><span class="free">p</span></span> <span class="main"><span class="main">+</span></span> <span class="free"><span class="free">q</span></span><span class="main"><span class="main">)</span></span>‚Ä∫</span></span></span></span> is here to ensure that
  we don't normalise <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">0</span></span> <span class="main"><span class="main">::</span></span> int mpoly‚Ä∫</span></span></span></span> to  <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚ÄπVar <span class="free"><span class="free">x</span></span><span class="main"><span class="main">^</span></span><span class="numeral"><span class="numeral">2</span></span> <span class="main"><span class="main">-</span></span> Var <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">::</span></span> int mpoly‚Ä∫</span></span></span></span>
  for a new variable <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">x</span></span> <span class="main"><span class="main">::</span></span> nat‚Ä∫</span></span></span></span>. This is completely obvious for the normalisation
  process we have in mind when we write the specification, but we must add it
  explicitly because we are too general.
‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemmas</span></span>  PAC_Format_induct_split <span class="main">=</span>
   PAC_Format.induct<span class="main">[</span><span class="operator">split_format</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">complete</span><span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">V'</span></span> <span class="quoted"><span class="free">A'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">V</span> <span class="free">A</span> <span class="free">V'</span> <span class="free">A'</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> PAC_Format_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> add mult del ext<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">‚ÄπPAC_Format <span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">ùí±'</span><span class="main">,</span> <span class="free">A'</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    cases<span class="main">:</span>
      <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">p'</span>  <span class="bound">A</span> <span class="bound">ùí±</span><span class="main">.</span> <span class="bound">p</span> <span class="main">‚àà#</span> <span class="bound">A</span> <span class="main">‚üπ</span> <span class="bound">q</span> <span class="main">‚àà#</span> <span class="bound">A</span> <span class="main">‚üπ</span> <span class="bound">p</span><span class="main">+</span><span class="bound">q</span> <span class="main">-</span> <span class="bound">p'</span> <span class="main">‚àà</span> ideal polynomial_bool <span class="main">‚üπ</span> vars <span class="bound">p'</span> <span class="main">‚äÜ</span> <span class="bound">ùí±</span> <span class="main">‚üπ</span> <span class="free">P</span> <span class="bound">ùí±</span> <span class="bound">A</span> <span class="bound">ùí±</span> <span class="main">(</span>add_mset <span class="bound">p'</span> <span class="bound">A</span><span class="main">)</span>‚Ä∫</span></span>
      <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">p'</span> <span class="bound">A</span> <span class="bound">ùí±</span><span class="main">.</span> <span class="bound">p</span> <span class="main">‚àà#</span> <span class="bound">A</span> <span class="main">‚üπ</span> <span class="bound">p</span><span class="main">*</span><span class="bound">q</span> <span class="main">-</span> <span class="bound">p'</span> <span class="main">‚àà</span> ideal polynomial_bool <span class="main">‚üπ</span> vars <span class="bound">p'</span> <span class="main">‚äÜ</span> <span class="bound">ùí±</span> <span class="main">‚üπ</span> vars <span class="bound">q</span> <span class="main">‚äÜ</span> <span class="bound">ùí±</span> <span class="main">‚üπ</span>
        <span class="free">P</span> <span class="bound">ùí±</span> <span class="bound">A</span> <span class="bound">ùí±</span> <span class="main">(</span>add_mset <span class="bound">p'</span> <span class="bound">A</span><span class="main">)</span>‚Ä∫</span></span>
      <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">p</span> <span class="bound">A</span> <span class="bound">ùí±</span><span class="main">.</span> <span class="bound">p</span> <span class="main">‚àà#</span> <span class="bound">A</span> <span class="main">‚üπ</span> <span class="free">P</span> <span class="bound">ùí±</span> <span class="bound">A</span> <span class="bound">ùí±</span> <span class="main">(</span><span class="bound">A</span> <span class="main">-</span> <span class="main">{#</span><span class="bound">p</span><span class="main">#}</span><span class="main">)</span>‚Ä∫</span></span>
      <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">p'</span> <span class="bound">x</span> <span class="bound">r</span><span class="main">.</span>
        <span class="main">(</span><span class="bound">p'</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">(</span><span class="bound">p'</span><span class="main">)</span> <span class="main">‚àà</span> ideal polynomial_bool <span class="main">‚üπ</span> vars <span class="bound">p'</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span> <span class="main">‚üπ</span>
        <span class="bound">x</span> <span class="main">‚àâ</span> <span class="free">ùí±</span> <span class="main">‚üπ</span> <span class="free">P</span> <span class="free">ùí±</span> <span class="free">A</span> <span class="main">(</span><span class="free">ùí±</span> <span class="main">‚à™</span> <span class="main">{</span><span class="bound"><span class="bound">x'</span></span> <span class="main">‚àà</span> vars <span class="main">(</span><span class="bound">p'</span> <span class="main">-</span> Var <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">‚àâ</span> <span class="free">ùí±</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>add_mset <span class="main">(</span><span class="bound">p'</span> <span class="main">-</span>Var <span class="bound">x</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
     <span class="quoted"><span class="quoted">‚Äπ<span class="free">P</span> <span class="free">ùí±</span> <span class="free">A</span> <span class="free">ùí±'</span> <span class="free">A'</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="skolem">V</span><span class="main"><span class="main">‚â°</span></span><span class="quoted"><span class="free">ùí±</span></span> <span class="skolem">A</span><span class="main"><span class="main">‚â°</span></span><span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">ùí±'</span></span> <span class="quoted"><span class="free">A'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> PAC_Format_induct_split<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cases<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ

The theorem below (based on the proof ideal by Manuel Kauers) is the
correctness theorem of extensions. Remark that the assumption <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπvars
<span class="free"><span class="free">q</span></span> <span class="main"><span class="main">‚äÜ</span></span> <span class="free"><span class="free">ùí±</span></span>‚Ä∫</span></span></span></span> is only used to show that <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">x'</span></span> <span class="main"><span class="main">‚àâ</span></span> vars <span class="free"><span class="free">q</span></span>‚Ä∫</span></span></span></span>.

‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> extensions_are_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àà</span> vars <span class="free">p</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    x'<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> <span class="free">ùí±</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÉ</span> <span class="main">(</span>vars <span class="main">`</span> set_mset <span class="free">A</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    p_x_coeff<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπcoeff <span class="free">p</span> <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    vars_q<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπvars <span class="free">q</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    q<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">q</span> <span class="main">‚àà</span> More_Modules.ideal <span class="main">(</span>insert <span class="free">p</span> <span class="main">(</span>set_mset <span class="free">A</span> <span class="main">‚à™</span> polynomial_bool<span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    leading<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="main">(</span><span class="free">p</span> <span class="main">-</span> Var <span class="free">x'</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    diff<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>Var <span class="free">x'</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span><span class="main"><span class="hidden">‚áß</span><sup>2</sup></span> <span class="main">-</span> <span class="main">(</span>Var <span class="free">x'</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">q</span> <span class="main">‚àà</span> More_Modules.ideal <span class="main">(</span>set_mset <span class="free">A</span> <span class="main">‚à™</span> polynomial_bool<span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">p'</span> <span class="main">‚â°</span> <span class="free">p</span> <span class="main">-</span> Var <span class="free">x'</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‚ÄπVar <span class="free">x'</span> <span class="main">::</span> int mpoly‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span> p_p'<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">=</span> <span class="var">?v</span> <span class="main">+</span> <span class="skolem">p'</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p'_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">q'</span> <span class="main">‚â°</span> Var <span class="free">x'</span> <span class="main">-</span> <span class="free">p</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span> q_q'<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">=</span> <span class="var">?v</span> <span class="main">-</span> <span class="skolem">q'</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> q'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> diff<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">q'</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="skolem">q'</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> diff <span class="keyword1"><span class="command">unfolding</span></span> q_q' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπvars <span class="main">(</span><span class="main">(</span>Var <span class="skolem">c</span><span class="main">)</span><span class="main"><span class="hidden">‚áß</span><sup>2</sup></span> <span class="main">-</span> Var <span class="skolem">c</span> <span class="main">::</span> int mpoly<span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">c</span><span class="main">}</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_def Var_def Var<span class="hidden">‚á©</span><sub>0</sub>_def mpoly.MPoly_inverse keys_def lookup_minus_fun
      lookup_times_monomial_right single.rep_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_def Var_def Var<span class="hidden">‚á©</span><sub>0</sub>_def mpoly.MPoly_inverse keys_def lookup_minus_fun
      lookup_times_monomial_right single.rep_eq when_def <span class="dynamic"><span class="dynamic">ac_simps</span></span> adds_def lookup_plus_fun
      power2_eq_square times_mpoly.rep_eq minus_mpoly.rep_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> nat <span class="main">‚áí<span class="hidden">‚á©</span><sub>0</sub></span> nat<span class="main">)</span> <span class="main">*</span> monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="skolem">c</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> monomial_0D <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> plus_eq_zero_2 lookup_plus_fun mult_2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Suc_neq_Zero monomial_0D plus_eq_zero_2<span class="main">)</span>


  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">‚ÄπMore_Modules.ideal <span class="main">(</span>insert <span class="free">p</span> <span class="main">(</span>set_mset <span class="free">A</span> <span class="main">‚à™</span> polynomial_bool<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      More_Modules.ideal <span class="main">(</span>insert <span class="free">p</span> <span class="main">(</span>set_mset <span class="free">A</span> <span class="main">‚à™</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">c</span><span class="main">.</span> Var <span class="bound">c</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> Var <span class="bound">c</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">‚â†</span> <span class="free">x'</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?A</span> <span class="main">=</span> <span class="var">?B</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">=</span> More_Modules.ideal <span class="var">?trimmed</span>‚Ä∫</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
     <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‚Äπinsert <span class="free">p</span> <span class="main">(</span>set_mset <span class="free">A</span> <span class="main">‚à™</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">c</span><span class="main">.</span> Var <span class="bound">c</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> Var <span class="bound">c</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">‚â†</span> <span class="free">x'</span><span class="main">}</span><span class="main">)</span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">Œª</span><span class="bound">c</span><span class="main">.</span> Var <span class="bound">c</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> Var <span class="bound">c</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">‚â†</span> <span class="free">x'</span><span class="main">}</span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command">have</span></span> diff<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">q'</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="skolem">q'</span> <span class="main">‚àà</span> More_Modules.ideal <span class="var">?D</span>‚Ä∫</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?q</span> <span class="main">‚àà</span> <span class="main">_</span>‚Ä∫</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
       <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span>
         q<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?q</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">a</span><span class="main">‚àà</span><span class="skolem">t</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">a</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         fin_t<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπfinite <span class="skolem">t</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         t<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">t</span> <span class="main">‚äÜ</span> polynomial_bool‚Ä∫</span></span>
         <span class="keyword1"><span class="command">using</span></span> diff <span class="keyword1"><span class="command">unfolding</span></span> ideal.span_explicit
         <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
       <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?v</span><span class="main">^</span><span class="numeral">2</span><span class="main">-</span><span class="var">?v</span> <span class="main">‚àâ</span> <span class="skolem">t</span>‚Ä∫</span></span><span class="main">)</span>
         <span class="keyword3"><span class="command">case</span></span> True
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?thesis</span>‚Ä∫</span></span>
           <span class="keyword1"><span class="command">using</span></span> q fin_t t <span class="keyword1"><span class="command">unfolding</span></span> ideal.span_explicit
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">t</span> <span class="main">-</span> <span class="main">{</span><span class="var">?v</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span><span class="var">?v</span><span class="main">}</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="main">]</span></span>
             <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> polynomial_bool_def sum_diff1<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">t'</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">-</span> <span class="main">{</span><span class="var">?v</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="var">?v</span><span class="main">}</span>‚Ä∫</span></span>
          <span class="keyword1"><span class="command">have</span></span> t_t'<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">t</span> <span class="main">=</span> insert <span class="main">(</span><span class="var">?v</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="var">?v</span><span class="main">)</span> <span class="skolem">t'</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            notin<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?v</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="var">?v</span> <span class="main">‚àâ</span> <span class="skolem">t'</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">t'</span> <span class="main">‚äÜ</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">c</span><span class="main">.</span> Var <span class="bound">c</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> Var <span class="bound">c</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">‚â†</span> <span class="free">x'</span><span class="main">}</span>‚Ä∫</span></span>
            <span class="keyword1"><span class="command">using</span></span> False t <span class="keyword1"><span class="command">unfolding</span></span> t'_def polynomial_bool_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> mon<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmonom <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">1</span> <span class="main">=</span> Var <span class="free">x'</span>‚Ä∫</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_def minus_mpoly.rep_eq Var_def Var<span class="hidden">‚á©</span><sub>0</sub>_def monom_def
              times_mpoly.rep_eq lookup_minus lookup_times_monomial_right mpoly.MPoly_inverse<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÄ</span><span class="bound">a</span><span class="main">.</span> <span class="main">‚àÉ</span><span class="bound">g</span> <span class="bound">h</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">a</span> <span class="main">=</span> <span class="var">?v</span> <span class="main">*</span> <span class="bound">g</span> <span class="main">+</span> <span class="bound">h</span> <span class="main">‚àß</span> <span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="bound">h</span>‚Ä∫</span></span>
            <span class="keyword1"><span class="command">using</span></span> polynomial_split_on_var<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">r</span> <span class="main">_</span>‚Ä∫</span></span> <span class="quoted"><span class="free">x'</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span>
            r<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">r</span> <span class="skolem">a</span> <span class="main">=</span> <span class="var">?v</span> <span class="main">*</span> <span class="skolem">g</span> <span class="skolem">a</span> <span class="main">+</span> <span class="skolem">h</span> <span class="skolem">a</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            x'_h<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="main">(</span><span class="skolem">h</span> <span class="skolem">a</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span>
            <span class="keyword1"><span class="command">using</span></span> polynomial_split_on_var<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">r</span> <span class="free">a</span>‚Ä∫</span></span> <span class="quoted"><span class="free">x'</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">‚Äπ<span class="var">?q</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">‚àë</span><span class="bound">a</span><span class="main">‚àà</span><span class="skolem">t'</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">a</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">r</span> <span class="main">(</span><span class="var">?v</span><span class="main">^</span><span class="numeral">2</span><span class="main">-</span><span class="var">?v</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?v</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?v</span> <span class="main">+</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">a</span><span class="main">‚àà</span><span class="skolem">t'</span><span class="main">.</span> <span class="skolem">h</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">a</span><span class="main">)</span>‚Ä∫</span></span>
            <span class="keyword1"><span class="command">using</span></span> fin_t notin <span class="keyword1"><span class="command">unfolding</span></span> t_t' q r
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> comm_monoid_add_class.sum.distrib
              power2_eq_square ideal.scale_left_commute sum_distrib_left<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="var">?q</span>‚Ä∫</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Groups.add_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Un_iff add_diff_cancel_left'
              diff_minus_eq_add in_mono leading q'_def semiring_normalization_rules<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span>
              vars_in_right_only vars_mult<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> <span class="main">(</span><span class="main">‚ãÉ</span><span class="bound">m</span><span class="main">‚àà</span><span class="skolem">t'</span> <span class="main">-</span> <span class="main">{</span><span class="var">?v</span><span class="main">^</span><span class="numeral">2</span><span class="main">-</span><span class="var">?v</span><span class="main">}</span><span class="main">.</span> vars <span class="main">(</span><span class="skolem">h</span> <span class="bound">m</span> <span class="main">*</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
              <span class="keyword1"><span class="command">using</span></span> fin_t x'_h vars_mult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">h</span> <span class="main">_</span>‚Ä∫</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">t</span> <span class="main">‚äÜ</span> polynomial_bool‚Ä∫</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> polynomial_bool_def t_t' <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> vars_unE<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="main">(</span><span class="main">‚àë</span><span class="bound">a</span><span class="main">‚àà</span><span class="skolem">t'</span><span class="main">.</span> <span class="skolem">h</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">a</span><span class="main">)</span>‚Ä∫</span></span>
              <span class="keyword1"><span class="command">using</span></span> vars_setsum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">t'</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">Œª</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">h</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">a</span>‚Ä∫</span></span><span class="main">]</span> fin_t x'_h t notin
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_t'<span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?q</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">a</span><span class="main">‚àà</span><span class="skolem">t'</span><span class="main">.</span> <span class="skolem">h</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">a</span><span class="main">)</span>‚Ä∫</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> mon<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> polynomial_decomp_alien_var<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> t fin_t <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">t'</span> <span class="main">‚äÜ</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">c</span><span class="main">.</span> Var <span class="bound">c</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> Var <span class="bound">c</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">‚â†</span> <span class="free">x'</span><span class="main">}</span>‚Ä∫</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> ideal.span_explicit t_t'
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">‚ÄπMore_Modules.ideal <span class="main">(</span>insert <span class="free">p</span> <span class="main">(</span>set_mset <span class="free">A</span> <span class="main">‚à™</span> polynomial_bool<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      More_Modules.ideal <span class="main">(</span>insert <span class="main">(</span><span class="var">?v</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="var">?v</span><span class="main">)</span> <span class="var">?C</span><span class="main">)</span>‚Ä∫</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚ÄπMore_Modules.ideal <span class="main">_</span> <span class="main">=</span> More_Modules.ideal <span class="main">(</span>insert <span class="main">_</span> <span class="var">?C</span><span class="main">)</span>‚Ä∫</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">More_Modules.ideal</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> polynomial_bool_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?v</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="var">?v</span> <span class="main">‚àà</span> More_Modules.ideal <span class="var">?C</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?v</span> <span class="main">-</span> <span class="skolem">q'</span> <span class="main">‚àà</span> More_Modules.ideal <span class="var">?C</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> q_q' ideal.span_base<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> ideal.span_scale<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?v</span> <span class="main">+</span> <span class="skolem">q'</span> <span class="main">-</span> <span class="main">1</span>‚Ä∫</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="var">?v</span> <span class="main">-</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?v</span> <span class="main">+</span> <span class="skolem">q'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">‚àà</span> More_Modules.ideal <span class="var">?C</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">q'</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="skolem">q'</span> <span class="main">‚àà</span> More_Modules.ideal <span class="var">?C</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">using</span></span> diff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Un_insert_right ideal.span_mono insert_subset subsetD sup_ge2<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="var">?v</span> <span class="main">-</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?v</span> <span class="main">+</span> <span class="skolem">q'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">q'</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">‚àà</span> More_Modules.ideal <span class="var">?C</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ideal.span_add<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?v</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="var">?v</span> <span class="main">=</span> <span class="main">(</span><span class="var">?v</span> <span class="main">-</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?v</span> <span class="main">+</span> <span class="skolem">q'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">q'</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="skolem">q'</span><span class="main">)</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p'_def q_q' <span class="dynamic"><span class="dynamic">field_simps</span></span> power2_eq_square<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ideal.span_insert_idI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="main">‚üπ</span> <span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">‚üπ</span> <span class="main">‚àÉ</span><span class="bound">q</span><span class="main">.</span> <span class="var">?v</span><span class="main">^</span><span class="skolem">n</span> <span class="main">=</span> <span class="var">?v</span> <span class="main">+</span> <span class="bound">q</span> <span class="main">*</span> <span class="main">(</span><span class="var">?v</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="var">?v</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="skolem">m</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span> <span class="skolem">n</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this<span class="main">(</span>1-<span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">m</span>‚Ä∫</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">n</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">1</span>‚Ä∫</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">m</span>‚Ä∫</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?v</span><span class="main">^</span><span class="main">(</span><span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="var">?v</span> <span class="main">::</span> int mpoly<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?v</span><span class="main">^</span><span class="numeral">2</span><span class="main">-</span><span class="var">?v</span><span class="main">)</span> <span class="main">+</span> <span class="var">?v</span><span class="main">^</span><span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> power_eq_if
          ideal.scale_right_diff_distrib<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        q<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?v</span><span class="main">^</span><span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?v</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">*</span> <span class="main">(</span><span class="var">?v</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="var">?v</span><span class="main">)</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">n</span><span class="main">-</span><span class="main">1</span>‚Ä∫</span></span><span class="main">]</span> 2
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> q <span class="keyword1"><span class="command">unfolding</span></span> eq
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚ÄπVar <span class="free">x'</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">q</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distrib_right<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?thesis</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    q<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">a</span><span class="main">‚àà</span><span class="skolem">t</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">a</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    fin_t<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπfinite <span class="skolem">t</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    t<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">t</span> <span class="main">‚äÜ</span> <span class="var">?trimmed</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> q <span class="keyword1"><span class="command">unfolding</span></span> eq <span class="keyword1"><span class="command">unfolding</span></span> ideal.span_explicit
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">t'</span> <span class="main">‚â°</span> <span class="skolem">t</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">have</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="main">‚àà</span> <span class="skolem">t</span> <span class="keyword1">then</span> insert <span class="free">p</span> <span class="skolem">t'</span> <span class="keyword1">else</span> <span class="skolem">t'</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    t''<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">‚àâ</span> <span class="skolem">t'</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> t'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">r</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">‚à®</span> <span class="free">p</span> <span class="main">‚àâ</span> <span class="skolem">t</span>‚Ä∫</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span>
      q<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">a</span><span class="main">‚àà</span><span class="skolem">t'</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">a</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
     fin_t<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπfinite <span class="skolem">t'</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      t<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">t'</span> <span class="main">‚äÜ</span> set_mset <span class="free">A</span> <span class="main">‚à™</span> polynomial_bool‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> q fin_t t True t''
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> t'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum.insert_remove t'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> q fin_t t True t''
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum.insert_remove t'_def polynomial_bool_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ideal.span_explicit<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">r</span> <span class="free">p</span> <span class="main">‚â†</span> <span class="main">0</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">‚àà</span> <span class="skolem">t</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">t</span> <span class="main">=</span> insert <span class="free">p</span> <span class="skolem">t'</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t'_def<span class="main">)</span>

   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="main">(</span><span class="main">-</span> <span class="skolem">p'</span><span class="main">)</span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command">using</span></span> leading p'_def vars_in_right_only <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
   <span class="keyword1"><span class="command">have</span></span> mon<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmonom <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">1</span> <span class="main">=</span> Var <span class="free">x'</span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>coeff_def minus_mpoly.rep_eq Var_def Var<span class="hidden">‚á©</span><sub>0</sub>_def monom_def
       times_mpoly.rep_eq lookup_minus lookup_times_monomial_right mpoly.MPoly_inverse<span class="main">)</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÄ</span><span class="bound">a</span><span class="main">.</span> <span class="main">‚àÉ</span><span class="bound">g</span> <span class="bound">h</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">(</span><span class="var">?v</span> <span class="main">+</span> <span class="skolem">p'</span><span class="main">)</span> <span class="main">*</span> <span class="bound">g</span> <span class="main">+</span> <span class="bound">h</span> <span class="main">‚àß</span> <span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="bound">h</span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command">using</span></span> polynomial_split_on_var2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x'</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">-</span><span class="skolem">p'</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">r</span> <span class="main">_</span>‚Ä∫</span></span><span class="main">]</span>  <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="main">(</span><span class="main">-</span> <span class="skolem">p'</span><span class="main">)</span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_minus_eq_add<span class="main">)</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span>
     r<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">r</span> <span class="skolem">a</span> <span class="main">=</span> <span class="free">p</span> <span class="main">*</span> <span class="skolem">g</span> <span class="skolem">a</span> <span class="main">+</span> <span class="skolem">h</span> <span class="skolem">a</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
     x'_h<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="main">(</span><span class="skolem">h</span> <span class="skolem">a</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span>
     <span class="keyword1"><span class="command">using</span></span> polynomial_split_on_var2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x'</span></span> <span class="quoted"><span class="skolem">p'</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">r</span> <span class="free">a</span>‚Ä∫</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> p_p'<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>


  <span class="keyword1"><span class="command">have</span></span> ISABLLE_come_on<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">p</span> <span class="main">*</span> <span class="skolem">g</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">g</span> <span class="skolem">a</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> q1<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">q</span> <span class="main">=</span> <span class="free">p</span> <span class="main">*</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">a</span><span class="main">‚àà</span><span class="skolem">t'</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">a</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">a</span><span class="main">‚àà</span><span class="skolem">t'</span><span class="main">.</span> <span class="skolem">h</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">a</span><span class="main">)</span> <span class="main">+</span> <span class="free">p</span> <span class="main">*</span> <span class="skolem">r</span> <span class="free">p</span>‚Ä∫</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">+</span> <span class="var">?NOx'</span> <span class="main">+</span> <span class="main">_</span>‚Ä∫</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> fin_t t'' <span class="keyword1"><span class="command">unfolding</span></span> q t ISABLLE_come_on r
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> semiring_class.distrib_right<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comm_monoid_add_class.sum.distrib semigroup_mult_class.mult.assoc
      ISABLLE_come_on <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> semiring_0_class.sum_distrib_right
         semiring_0_class.sum_distrib_left<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">‚àë</span><span class="bound">a</span><span class="main">‚àà</span><span class="skolem">t'</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">a</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">*</span> <span class="free">p</span> <span class="main">+</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">a</span><span class="main">‚àà</span><span class="skolem">t'</span><span class="main">.</span> <span class="skolem">h</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">a</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> q_decomp<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">‚àë</span><span class="bound">a</span><span class="main">‚àà</span><span class="skolem">t'</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">a</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">*</span> <span class="free">p</span> <span class="main">+</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">a</span><span class="main">‚àà</span><span class="skolem">t'</span><span class="main">.</span> <span class="skolem">h</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">a</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">q</span> <span class="main">=</span> <span class="var">?X</span> <span class="main">*</span> <span class="free">p</span> <span class="main">+</span> <span class="var">?NOx'</span>‚Ä∫</span></span><span class="main">)</span><span class="keyword1"><span class="command">.</span></span>


   <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmonomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">0</span> <span class="main">-</span> monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">=</span> False‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def diff_is_0_eq' le_eq_less_or_eq less_Suc_eq_le monomial_0_iff single_diff zero_neq_one<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x</span> <span class="main">‚àà</span> <span class="skolem">t'</span> <span class="main">‚üπ</span> <span class="free">x'</span> <span class="main">‚àà</span> vars <span class="skolem">x</span> <span class="main">‚üπ</span> False‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">t</span> <span class="main">‚äÜ</span> <span class="var">?trimmed</span>‚Ä∫</span></span> t assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> polynomial_bool_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> set_rev_mp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> <span class="main">(</span><span class="main">‚ãÉ</span><span class="bound">m</span><span class="main">‚àà</span><span class="skolem">t'</span><span class="main">.</span> vars <span class="main">(</span><span class="skolem">h</span> <span class="bound">m</span> <span class="main">*</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command">using</span></span> fin_t x'_h vars_mult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">h</span> <span class="main">_</span>‚Ä∫</span></span><span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> vars_unE<span class="main">)</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="var">?NOx'</span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command">using</span></span> vars_setsum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">t'</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">Œª</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">h</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">a</span>‚Ä∫</span></span><span class="main">]</span> fin_t x'_h
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="skolem">p'</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>7<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> p'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="main">(</span><span class="skolem">h</span> <span class="free">p</span> <span class="main">*</span> <span class="skolem">p'</span><span class="main">)</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> vars_mult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">h</span> <span class="free">p</span>‚Ä∫</span></span> <span class="quoted"><span class="skolem">p'</span></span><span class="main">]</span> x'_h
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="free">q</span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="var">?NOx'</span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="skolem">p'</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> x' vars_q vars_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">h</span> <span class="free">p</span> <span class="main">*</span> <span class="skolem">p'</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àë</span><span class="bound">a</span><span class="main">‚àà</span><span class="skolem">t'</span><span class="main">.</span> <span class="skolem">h</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">a</span>‚Ä∫</span></span><span class="main">]</span> x'_h
      leading p'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?X</span> <span class="main">=</span> <span class="main">0</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> q_decomp<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">q</span> <span class="main">=</span> <span class="var">?NOx'</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mon<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> p_p'
    <span class="keyword1"><span class="command">using</span></span> polynomial_decomp_alien_var2<span class="main">[</span><span class="operator">OF</span> q_decomp<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">unfolded</span></span> p_p' mon<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">symmetric</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">r</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">a</span><span class="main">‚àà</span><span class="skolem">t'</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">g</span> <span class="bound">a</span><span class="main">)</span> <span class="main">*</span> <span class="bound">a</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">=</span> <span class="var">?CL</span>‚Ä∫</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> add.assoc add_eq_0_iff equation_minus_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_negf <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>


  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> q2<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àë</span><span class="bound">a</span><span class="main">‚àà</span><span class="skolem">t'</span><span class="main">.</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">a</span> <span class="main">-</span> <span class="free">p</span> <span class="main">*</span> <span class="skolem">g</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> fin_t <span class="keyword1"><span class="command">unfolding</span></span> q
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t r q
         comm_monoid_add_class.sum.distrib<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
         sum_distrib_left
         sum_distrib_right
         left_diff_distrib
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?thesis</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> t fin_t <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">t</span> <span class="main">‚äÜ</span> <span class="var">?trimmed</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ideal.span_explicit
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">t'</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">Œª</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">a</span> <span class="main">-</span> <span class="free">p</span> <span class="main">*</span> <span class="skolem">g</span> <span class="bound">a</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> polynomial_bool_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extensions_are_safe_uminus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àà</span> vars <span class="free">p</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    x'<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> <span class="free">ùí±</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÉ</span> <span class="main">(</span>vars <span class="main">`</span> set_mset <span class="free">A</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    p_x_coeff<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπcoeff <span class="free">p</span> <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    vars_q<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπvars <span class="free">q</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    q<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">q</span> <span class="main">‚àà</span> More_Modules.ideal <span class="main">(</span>insert <span class="free">p</span> <span class="main">(</span>set_mset <span class="free">A</span> <span class="main">‚à™</span> polynomial_bool<span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    leading<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">‚àâ</span> vars <span class="main">(</span><span class="free">p</span> <span class="main">+</span> Var <span class="free">x'</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    diff<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>Var <span class="free">x'</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">(</span>Var <span class="free">x'</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">q</span> <span class="main">‚àà</span> More_Modules.ideal <span class="main">(</span>set_mset <span class="free">A</span> <span class="main">‚à™</span> polynomial_bool<span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">q</span> <span class="main">‚àà</span> More_Modules.ideal <span class="main">(</span>insert <span class="main">(</span><span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">A</span> <span class="main">‚à™</span> polynomial_bool<span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ideal.span_breakdown_eq minus_mult_minus q<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> extensions_are_safe<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x'</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">-</span><span class="free">p</span>‚Ä∫</span></span> <span class="quoted"><span class="free">ùí±</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">using</span></span> vars_in_right_only <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThis is the correctness theorem of a PAC step: no polynomials are
added to the ideal.‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vars_subst_in_left_only<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">x</span> <span class="main">‚àâ</span> vars <span class="free">p</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àà</span> vars <span class="main">(</span><span class="free">p</span> <span class="main">-</span> Var <span class="free">x</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint mpoly‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Var.abs_eq Var<span class="hidden">‚á©</span><sub>0</sub>_def group_eq_aux monom.abs_eq mult_numeral_1 polynomial_decomp_alien_var<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> zero_neq_numeral<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_subst_in_left_only_diff_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint mpoly‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x</span> <span class="main">‚àâ</span> vars <span class="free">p</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπvars <span class="main">(</span><span class="free">p</span> <span class="main">-</span> Var <span class="free">x</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span>vars <span class="free">p</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">xa</span><span class="main">.</span> <span class="free">x</span> <span class="main">‚àâ</span> vars <span class="free">p</span> <span class="main">‚üπ</span> <span class="bound">xa</span> <span class="main">‚àà</span> vars <span class="main">(</span><span class="free">p</span> <span class="main">-</span> Var <span class="free">x</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="bound">xa</span> <span class="main">‚àâ</span> vars <span class="free">p</span> <span class="main">‚üπ</span> <span class="bound">xa</span> <span class="main">=</span> <span class="free">x</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> diff_0_right diff_minus_eq_add empty_iff in_vars_addE insert_iff
      keys_single minus_diff_eq monom_one mult.right_neutral one_neq_zero single_zero
      vars_monom_keys vars_mult_Var vars_uminus<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">xa</span><span class="main">.</span> <span class="free">x</span> <span class="main">‚àâ</span> vars <span class="free">p</span> <span class="main">‚üπ</span> <span class="bound">xa</span> <span class="main">‚àà</span> vars <span class="free">p</span> <span class="main">‚üπ</span> <span class="bound">xa</span> <span class="main">‚àà</span> vars <span class="main">(</span><span class="free">p</span> <span class="main">-</span> Var <span class="free">x</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.inverse_inverse diff_minus_eq_add empty_iff insert_iff keys_single minus_diff_eq
      monom_one mult.right_neutral one_neq_zero single_zero vars_in_right_only vars_monom_keys
      vars_mult_Var vars_uminus<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_subst_in_left_only<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vars_subst_in_left_only_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">x</span> <span class="main">‚àâ</span> vars <span class="free">p</span> <span class="main">‚üπ</span> vars <span class="main">(</span><span class="free">p</span> <span class="main">+</span> Var <span class="free">x</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span>vars <span class="free">p</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint mpoly‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> vars_subst_in_left_only_diff_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">-</span><span class="free">p</span>‚Ä∫</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_0 diff_diff_add vars_uminus<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_add_right_notin<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">x</span> <span class="main">‚àâ</span> vars <span class="free">p</span> <span class="main">‚üπ</span> MPoly_Type.coeff <span class="main">(</span>Var <span class="free">x</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> coeff_minus <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_in_vars_coeff0<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MPoly_Type.coeff_def Var.rep_eq Var<span class="hidden">‚á©</span><sub>0</sub>_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_add_left_notin<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">x</span> <span class="main">‚àâ</span> vars <span class="free">p</span> <span class="main">‚üπ</span> MPoly_Type.coeff <span class="main">(</span><span class="free">p</span> <span class="main">-</span> Var <span class="free">x</span><span class="main">)</span> <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint mpoly‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> coeff_minus <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_in_vars_coeff0<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MPoly_Type.coeff_def Var.rep_eq Var<span class="hidden">‚á©</span><sub>0</sub>_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ideal_insert_polynomial_bool_swap<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">r</span> <span class="main">-</span> <span class="free">s</span> <span class="main">‚àà</span> ideal polynomial_bool <span class="main">‚üπ</span>
  More_Modules.ideal <span class="main">(</span>insert <span class="free">r</span>  <span class="main">(</span><span class="free">A</span> <span class="main">‚à™</span> polynomial_bool<span class="main">)</span><span class="main">)</span> <span class="main">=</span> More_Modules.ideal <span class="main">(</span>insert <span class="free">s</span> <span class="main">(</span><span class="free">A</span> <span class="main">‚à™</span> polynomial_bool<span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">using</span></span> ideal.eq_span_insert_eq ideal.span_mono sup_ge2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PAC_Format_subset_ideal<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπPAC_Format <span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">ùí±'</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">‚ãÉ</span><span class="main">(</span>vars <span class="main">`</span> set_mset <span class="free">A</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span> <span class="main">‚üπ</span>
     restricted_ideal_to<span class="hidden">‚á©</span><sub>I</sub> <span class="free">ùí±</span> <span class="free">B</span> <span class="main">‚äÜ</span> restricted_ideal_to<span class="hidden">‚á©</span><sub>I</sub> <span class="free">ùí±</span> <span class="free">A</span> <span class="main">‚àß</span> <span class="free">ùí±</span> <span class="main">‚äÜ</span> <span class="free">ùí±'</span> <span class="main">‚àß</span> <span class="main">‚ãÉ</span><span class="main">(</span>vars <span class="main">`</span> set_mset <span class="free">B</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="free">ùí±'</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> restricted_ideal_to_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>PAC_Format_induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p q pq A ùí±
    <span class="keyword1"><span class="command">using</span></span> vars_add
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ideal.span_add_eq ideal.span_base pac_ideal_insert_already_in<span class="main"><span class="main">[</span></span><span class="operator">OF</span> diff_in_polynomial_bool_pac_idealI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">p</span> <span class="main">+</span> <span class="skolem">q</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span>‚Ä∫</span></span> <span class="quoted"><span class="skolem">pq</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
        pac_ideal_add
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> diff_in_polynomial_bool_pac_idealI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">p</span> <span class="main">+</span> <span class="skolem">q</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span>‚Ä∫</span></span> <span class="quoted"><span class="skolem">pq</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p q pq
    <span class="keyword1"><span class="command">using</span></span> vars_mult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ideal.span_add_eq ideal.span_base pac_ideal_mult
      pac_ideal_insert_already_in<span class="main"><span class="main">[</span></span><span class="operator">OF</span> diff_in_polynomial_bool_pac_idealI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">p</span><span class="main">*</span><span class="skolem">q</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span>‚Ä∫</span></span> <span class="quoted"><span class="skolem">pq</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p A
    <span class="keyword1"><span class="command">using</span></span> pac_ideal_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπset_mset <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">p</span><span class="main">#}</span><span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπset_mset <span class="skolem">A</span>‚Ä∫</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_diffD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p x' r'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x'</span> <span class="main">‚àâ</span> vars <span class="skolem">p</span>‚Ä∫</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> extensions_are_safe_uminus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x'</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">-</span>Var <span class="skolem">x'</span> <span class="main">+</span> <span class="skolem">p</span>‚Ä∫</span></span> <span class="quoted"><span class="free">ùí±</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> pac_ideal_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_subst_in_left_only coeff_add_left_notin<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ
  In general, if deletions are disallowed, then the stronger <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">B</span></span> <span class="main"><span class="main">=</span></span> pac_ideal <span class="free"><span class="free">A</span></span>‚Ä∫</span></span></span></span> holds.
‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> restricted_ideal_to_restricted_ideal_to<span class="hidden">‚á©</span><sub>I</sub>D<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπrestricted_ideal_to <span class="free">ùí±</span> <span class="main">(</span>set_mset <span class="free">A</span><span class="main">)</span> <span class="main">‚äÜ</span> restricted_ideal_to<span class="hidden">‚á©</span><sub>I</sub> <span class="free">ùí±</span> <span class="free">A</span>‚Ä∫</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_disj_eq pac_idealI1 restricted_ideal_to_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> rtranclp_PAC_Format_subset_ideal<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπrtranclp PAC_Format <span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">ùí±'</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">‚ãÉ</span><span class="main">(</span>vars <span class="main">`</span> set_mset <span class="free">A</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span> <span class="main">‚üπ</span>
     restricted_ideal_to<span class="hidden">‚á©</span><sub>I</sub> <span class="free">ùí±</span> <span class="free">B</span> <span class="main">‚äÜ</span> restricted_ideal_to<span class="hidden">‚á©</span><sub>I</sub> <span class="free">ùí±</span> <span class="free">A</span> <span class="main">‚àß</span> <span class="free">ùí±</span> <span class="main">‚äÜ</span> <span class="free">ùí±'</span> <span class="main">‚àß</span> <span class="main">‚ãÉ</span><span class="main">(</span>vars <span class="main">`</span> set_mset <span class="free">B</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="free">ùí±'</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>rtranclp_induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">PAC_Format</span></span> <span class="quoted"><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">(</span></span><span class="main"><span class="main">_</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">)</span></span>‚Ä∫</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">(</span></span><span class="main"><span class="main">_</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">)</span></span>‚Ä∫</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">split_format</span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="quasi_keyword"><span class="quasi_keyword">complete</span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restricted_ideal_to_restricted_ideal_to<span class="hidden">‚á©</span><sub>I</sub>D<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> PAC_Format_subset_ideal<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restricted_ideal_to_def Collect_mono_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="PAC_Map_Rel">
<div class="head">
<h1>Theory PAC_Map_Rel</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:         PAC_Map_Rel.thy
  Author:       Mathias Fleury, Daniela Kaufmann, JKU
  Maintainer:   Mathias Fleury, JKU
*)</span>
<span class="keyword1"><span class="command">theory</span></span> PAC_Map_Rel
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="../Refine_Imperative_HOL/IICF.html">Refine_Imperative_HOL.IICF</a> <a href="Finite_Map_Multiset.html">Finite_Map_Multiset</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚ÄπHash-Map for finite mappings‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ

This function declares hash-maps for <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'a</span></span><span class="main"><span class="main">,</span></span> <span class="tfree"><span class="tfree">'b</span></span><span class="main"><span class="main">)</span></span>fmap‚Ä∫</span></span></span></span>, that are nicer
to use especially here where everything is finite.

‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fmap_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">to_relAPP</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">fmap_rel</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">‚â°</span> <span class="main">{</span><span class="main">(</span><span class="bound">m1</span><span class="main">,</span> <span class="bound">m2</span><span class="main">)</span><span class="main">.</span>
     <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">|‚àà|</span> fmdom <span class="bound">m2</span> <span class="main">‚ü∂</span> <span class="main">(</span><span class="bound">j</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">‚ü∂</span> <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="bound">m1</span> <span class="bound">j</span><span class="main">)</span><span class="main">,</span> the <span class="main">(</span>fmlookup <span class="bound">m2</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span> <span class="main">‚àß</span>
     fset <span class="main">(</span>fmdom <span class="bound">m1</span><span class="main">)</span> <span class="main">‚äÜ</span> Domain <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">‚àß</span> fset <span class="main">(</span>fmdom <span class="bound">m2</span><span class="main">)</span> <span class="main">‚äÜ</span> Range <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">‚àß</span>
     <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">‚ü∂</span> <span class="bound">j</span> <span class="main">|‚àà|</span> fmdom <span class="bound">m2</span> <span class="main">‚ü∑</span> <span class="bound">i</span> <span class="main">|‚àà|</span> fmdom <span class="bound">m1</span><span class="main">)</span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> fmap_rel_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span> <span class="free">V</span><span class="main">‚ü©</span>fmap_rel <span class="main">‚â°</span>
     <span class="main">{</span><span class="main">(</span><span class="bound">m1</span><span class="main">,</span> <span class="bound">m2</span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">‚àà#</span> dom_m <span class="bound">m2</span> <span class="main">‚ü∂</span>
             <span class="main">(</span><span class="bound">j</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">K</span> <span class="main">‚ü∂</span> <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="bound">m1</span> <span class="bound">j</span><span class="main">)</span><span class="main">,</span> the <span class="main">(</span>fmlookup <span class="bound">m2</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">V</span><span class="main">)</span> <span class="main">‚àß</span>
      fset <span class="main">(</span>fmdom <span class="bound">m1</span><span class="main">)</span> <span class="main">‚äÜ</span> Domain <span class="free">K</span> <span class="main">‚àß</span>
      fset <span class="main">(</span>fmdom <span class="bound">m2</span><span class="main">)</span> <span class="main">‚äÜ</span> Range <span class="free">K</span> <span class="main">‚àß</span>
      <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">K</span> <span class="main">‚ü∂</span> <span class="main">(</span><span class="bound">j</span> <span class="main">‚àà#</span> dom_m <span class="bound">m2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">i</span> <span class="main">‚àà#</span> dom_m <span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fmap_rel_def dom_m_def fmember.rep_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fmdom_empty_fmempty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπfmdom <span class="free">m</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">‚ü∑</span> <span class="free">m</span> <span class="main">=</span> fmempty‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fmdom_empty fmdrop_fset_fmdom fmdrop_fset_null<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmap_rel_empty1_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>fmempty<span class="main">,</span><span class="free">m</span><span class="main">)</span><span class="main">‚àà</span><span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span><span class="free">V</span><span class="main">‚ü©</span>fmap_rel <span class="main">‚ü∑</span> <span class="free">m</span><span class="main">=</span>fmempty"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπfmdom <span class="free">m</span> <span class="main">=</span> <span class="main">{||}</span>‚Ä∫</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmap_rel_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember.rep_eq fmap_rel_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fmdom_empty_fmempty_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmap_rel_empty2_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">,</span>fmempty<span class="main">)</span><span class="main">‚àà</span><span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span><span class="free">V</span><span class="main">‚ü©</span>fmap_rel <span class="main">‚ü∑</span> <span class="free">m</span><span class="main">=</span>fmempty"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπfmdom <span class="free">m</span> <span class="main">=</span> <span class="main">{||}</span>‚Ä∫</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmap_rel_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember.rep_eq fmap_rel_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fmdom_empty_fmempty_iff<span class="main">)</span>

<span class="keyword1"><span class="command">sepref_decl_intf</span></span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> f_map <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> fmap"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">synth_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">‚ü¶</span>INTF_OF_REL <span class="free">K</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'k</span><span class="main">)</span><span class="main">;</span> INTF_OF_REL <span class="free">V</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'v</span><span class="main">)</span><span class="main">‚üß</span>
  <span class="main">‚üπ</span> INTF_OF_REL <span class="main">(</span><span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span><span class="free">V</span><span class="main">‚ü©</span>fmap_rel<span class="main">)</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> f_map<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπOperations‚Ä∫</span></span>
<span class="keyword1"><span class="command">sepref_decl_op</span></span> fmap_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"fmempty"</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span><span class="free">V</span><span class="main">‚ü©</span>fmap_rel"</span></span> <span class="keyword1"><span class="command">.</span></span>


<span class="keyword1"><span class="command">sepref_decl_op</span></span> fmap_is_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span> fmempty"</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span><span class="free">V</span><span class="main">‚ü©</span>fmap_rel <span class="main">‚Üí</span> bool_rel"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fref_ncI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">parametricity</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fun_relI<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> fmap_rel_fmupd_fmap_rel<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span> <span class="free">R</span><span class="main">‚ü©</span>fmap_rel <span class="main">‚üπ</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">K</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">q'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">R</span> <span class="main">‚üπ</span>
   <span class="main">(</span>fmupd <span class="free">p</span> <span class="free">q</span> <span class="free">A</span><span class="main">,</span> fmupd <span class="free">p'</span> <span class="free">q'</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span> <span class="free">R</span><span class="main">‚ü©</span>fmap_rel‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span><span class="free">K</span><span class="main">¬Ø</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">unfolding</span></span> fmap_rel_alt_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p'</span> <span class="main">‚àà#</span> dom_m <span class="free">B</span>‚Ä∫</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_conj_distrib IS_RIGHT_UNIQUED <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">sepref_decl_op</span></span> fmap_update<span class="main">:</span> <span class="quoted"><span class="quoted">"fmupd"</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">‚Üí</span> <span class="free">V</span> <span class="main">‚Üí</span> <span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span><span class="free">V</span><span class="main">‚ü©</span>fmap_rel <span class="main">‚Üí</span> <span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span><span class="free">V</span><span class="main">‚ü©</span>fmap_rel"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span><span class="free">K</span><span class="main">¬Ø</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fref_ncI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">parametricity</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fmap_rel_fmupd_fmap_rel<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> remove1_mset_eq_add_mset_iff<span class="main">:</span>
   <span class="quoted"><span class="quoted">‚Äπremove1_mset <span class="free">a</span> <span class="free">A</span> <span class="main">=</span> add_mset <span class="free">a</span> <span class="free">A'</span> <span class="main">‚ü∑</span> <span class="free">A</span> <span class="main">=</span> add_mset <span class="free">a</span> <span class="main">(</span>add_mset <span class="free">a</span> <span class="free">A'</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mset_add_single add_mset_diff_bothsides diff_zero remove1_mset_eqE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmap_rel_fmdrop_fmap_rel<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>fmdrop <span class="free">p</span> <span class="free">A</span><span class="main">,</span> fmdrop <span class="free">p'</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span> <span class="free">R</span><span class="main">‚ü©</span>fmap_rel‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> single<span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span><span class="free">K</span><span class="main">¬Ø</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    H0<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span> <span class="free">R</span><span class="main">‚ü©</span>fmap_rel‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">K</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">Aa</span> <span class="bound">j</span><span class="main">.</span>
       <span class="main">‚àÄ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">‚àà#</span> dom_m <span class="free">B</span> <span class="main">‚ü∂</span> <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">j</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">K</span> <span class="main">‚ü∂</span> <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="bound">j</span><span class="main">)</span><span class="main">,</span> the <span class="main">(</span>fmlookup <span class="free">B</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">R</span><span class="main">)</span> <span class="main">‚üπ</span>
       remove1_mset <span class="free">p'</span> <span class="main">(</span>dom_m <span class="free">B</span><span class="main">)</span> <span class="main">=</span> add_mset <span class="free">p'</span> <span class="bound">Aa</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="bound">j</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">K</span> <span class="main">‚üπ</span> False‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_m_fmdrop fmlookup_drop in_dom_m_lookup_iff union_single_eq_member<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> H2<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">i</span> <span class="bound">Aa</span> <span class="bound">j</span><span class="main">.</span>
       <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">K</span> <span class="main">‚üπ</span>
       <span class="main">‚àÄ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">‚àà#</span> dom_m <span class="free">B</span> <span class="main">‚ü∂</span> <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">j</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">K</span> <span class="main">‚ü∂</span> <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="bound">j</span><span class="main">)</span><span class="main">,</span> the <span class="main">(</span>fmlookup <span class="free">B</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">R</span><span class="main">)</span> <span class="main">‚üπ</span>
       <span class="main">‚àÄ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">K</span> <span class="main">‚ü∂</span> <span class="main">(</span><span class="bound">j</span> <span class="main">‚àà#</span> dom_m <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">i</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span><span class="main">)</span> <span class="main">‚üπ</span>
       remove1_mset <span class="free">p'</span> <span class="main">(</span>dom_m <span class="free">B</span><span class="main">)</span> <span class="main">=</span> add_mset <span class="bound">i</span> <span class="bound">Aa</span> <span class="main">‚üπ</span>
       <span class="main">(</span><span class="bound">j</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">K</span> <span class="main">‚üπ</span>
            <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="bound">j</span><span class="main">)</span><span class="main">,</span> the <span class="main">(</span>fmlookup <span class="free">B</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">R</span> <span class="main">‚àß</span> <span class="bound">j</span> <span class="main">‚àà#</span> remove1_mset <span class="free">p</span> <span class="main">(</span>dom_m <span class="free">A</span><span class="main">)</span> <span class="main">‚àß</span>
        <span class="bound">i</span> <span class="main">‚àà#</span> remove1_mset <span class="free">p'</span> <span class="main">(</span>dom_m <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">Aa</span><span class="main">.</span>
       <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">K</span> <span class="main">‚üπ</span>
       single_valued <span class="free">K</span> <span class="main">‚üπ</span>
       single_valued <span class="main">(</span><span class="free">K</span><span class="main">¬Ø</span><span class="main">)</span> <span class="main">‚üπ</span>
       <span class="main">‚àÄ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">‚àà#</span> dom_m <span class="free">B</span> <span class="main">‚ü∂</span> <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">j</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">K</span> <span class="main">‚ü∂</span> <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="bound">j</span><span class="main">)</span><span class="main">,</span> the <span class="main">(</span>fmlookup <span class="free">B</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">R</span><span class="main">)</span> <span class="main">‚üπ</span>
       fset <span class="main">(</span>fmdom <span class="free">A</span><span class="main">)</span> <span class="main">‚äÜ</span> Domain <span class="free">K</span> <span class="main">‚üπ</span>
       fset <span class="main">(</span>fmdom <span class="free">B</span><span class="main">)</span> <span class="main">‚äÜ</span> Range <span class="free">K</span> <span class="main">‚üπ</span>
       <span class="main">‚àÄ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">K</span> <span class="main">‚ü∂</span> <span class="main">(</span><span class="bound">j</span> <span class="main">‚àà#</span> dom_m <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">i</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span><span class="main">)</span> <span class="main">‚üπ</span>
       <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">K</span> <span class="main">‚üπ</span> remove1_mset <span class="free">p</span> <span class="main">(</span>dom_m <span class="free">A</span><span class="main">)</span> <span class="main">=</span> add_mset <span class="bound">i</span> <span class="bound">Aa</span> <span class="main">‚üπ</span> <span class="bound">j</span> <span class="main">‚àà#</span> remove1_mset <span class="free">p'</span> <span class="main">(</span>dom_m <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> single
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IS_RIGHT_UNIQUED converse.intros dom_m_fmdrop fmlookup_drop in_dom_m_lookup_iff
        union_single_eq_member<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>fmdrop <span class="free">p</span> <span class="free">A</span><span class="main">,</span> fmdrop <span class="free">p'</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span> <span class="free">R</span><span class="main">‚ü©</span>fmap_rel‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">unfolding</span></span> fmap_rel_alt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_conj_distrib IS_RIGHT_UNIQUED
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> H H2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sepref_decl_op</span></span> fmap_delete<span class="main">:</span> <span class="quoted"><span class="quoted">"fmdrop"</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">‚Üí</span> <span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span><span class="free">V</span><span class="main">‚ü©</span>fmap_rel <span class="main">‚Üí</span> <span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span><span class="free">V</span><span class="main">‚ü©</span>fmap_rel"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span><span class="free">K</span><span class="main">¬Ø</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fref_ncI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">parametricity</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmap_rel_fmdrop_fmap_rel<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmap_rel_nat_the_fmlookup<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free">S</span><span class="main">,</span> <span class="free">R</span><span class="main">‚ü©</span>fmap_rel <span class="main">‚üπ</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">S</span> <span class="main">‚üπ</span> <span class="free">p'</span> <span class="main">‚àà#</span> dom_m <span class="free">B</span> <span class="main">‚üπ</span>
     <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">p</span><span class="main">)</span><span class="main">,</span> the <span class="main">(</span>fmlookup <span class="free">B</span> <span class="free">p'</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">R</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmap_rel_alt_def distinct_mset_dom<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmap_rel_in_dom_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="free">a'a</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span> <span class="free">V</span><span class="main">‚ü©</span>fmap_rel <span class="main">‚üπ</span>
    <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">a'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">K</span> <span class="main">‚üπ</span>
    <span class="free">a'</span> <span class="main">‚àà#</span> dom_m <span class="free">a'a</span> <span class="main">‚ü∑</span>
    <span class="free">a</span> <span class="main">‚àà#</span> dom_m <span class="free">aa</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fmap_rel_alt_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fmap_rel_fmlookup_rel<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">a'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">K</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="free">a'a</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span> <span class="free">V</span><span class="main">‚ü©</span>fmap_rel <span class="main">‚üπ</span>
         <span class="main">(</span>fmlookup <span class="free">aa</span> <span class="free">a</span><span class="main">,</span> fmlookup <span class="free">a'a</span> <span class="free">a'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free">V</span><span class="main">‚ü©</span>option_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> fmap_rel_nat_the_fmlookup<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">aa</span></span> <span class="quoted"><span class="free">a'a</span></span> <span class="quoted"><span class="free">K</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">a'</span></span><span class="main">]</span>
    fmap_rel_in_dom_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">aa</span></span> <span class="quoted"><span class="free">a'a</span></span> <span class="quoted"><span class="free">K</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">a'</span></span><span class="main">]</span>
    in_dom_m_lookup_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a'</span></span> <span class="quoted"><span class="free">a'a</span></span><span class="main">]</span>
    in_dom_m_lookup_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">aa</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">a'</span> <span class="main">‚àà#</span> dom_m <span class="free">a'a</span>‚Ä∫</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fmap_rel_nat_the_fmlookup<span class="main">)</span>


<span class="keyword1"><span class="command">sepref_decl_op</span></span> fmap_lookup<span class="main">:</span> <span class="quoted"><span class="quoted">"fmlookup"</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span><span class="free">V</span><span class="main">‚ü©</span>fmap_rel <span class="main">‚Üí</span> <span class="free">K</span> <span class="main">‚Üí</span>  <span class="main">‚ü®</span><span class="free">V</span><span class="main">‚ü©</span>option_rel"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fref_ncI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">parametricity</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmap_rel_fmlookup_rel<span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_fdom_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">‚àà#</span>dom_m <span class="free">m</span> <span class="main">‚ü∑</span> <span class="main">¬¨</span>is_None <span class="main">(</span>fmlookup <span class="free">m</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdom_notI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dom_m_def fmember.rep_eq<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> fmdom_notI notin_fset<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> notin_fset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">sepref_decl_op</span></span> fmap_contains_key<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">Œª</span><span class="bound">k</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">k</span><span class="main">‚àà#</span>dom_m <span class="bound">m</span>"</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">‚Üí</span> <span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span><span class="free">V</span><span class="main">‚ü©</span>fmap_rel <span class="main">‚Üí</span> bool_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> in_fdom_alt
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fref_ncI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">parametricity</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmap_rel_fmlookup_rel<span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπPatterns‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pat_fmap_empty<span class="main">[</span><span class="operator">pat_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fmempty <span class="main">‚â°</span> op_fmap_empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pat_map_is_empty<span class="main">[</span><span class="operator">pat_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(=)</span> <span class="main">$</span><span class="free">m</span><span class="main">$</span>fmempty <span class="main">‚â°</span> op_fmap_is_empty<span class="main">$</span><span class="free">m</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(=)</span> <span class="main">$</span>fmempty<span class="main">$</span><span class="free">m</span> <span class="main">‚â°</span> op_fmap_is_empty<span class="main">$</span><span class="free">m</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(=)</span> <span class="main">$</span><span class="main">(</span>dom_m<span class="main">$</span><span class="free">m</span><span class="main">)</span><span class="main">$</span><span class="main">{#}</span> <span class="main">‚â°</span> op_fmap_is_empty<span class="main">$</span><span class="free">m</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(=)</span> <span class="main">$</span><span class="main">{#}</span><span class="main">$</span><span class="main">(</span>dom_m<span class="main">$</span><span class="free">m</span><span class="main">)</span> <span class="main">‚â°</span> op_fmap_is_empty<span class="main">$</span><span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atomize_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sym<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> op_map_contains_key<span class="main">[</span><span class="operator">pat_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(‚àà#)</span> <span class="main">$</span> <span class="free">k</span> <span class="main">$</span> <span class="main">(</span>dom_m<span class="main">$</span><span class="free">m</span><span class="main">)</span> <span class="main">‚â°</span> op_fmap_contains_key<span class="main">$'</span><span class="free">k</span><span class="main">$'</span><span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_reflection<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπMapping to Normal Hashmaps‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">map_of_fmap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'k</span> <span class="main">‚áí</span> <span class="tfree">'v</span> option<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> fmap‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">map_of_fmap</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">‚â°</span> Abs_fmap <span class="free"><span class="bound"><span class="entity">h</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map_fmap_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">map_fmap_rel</span> <span class="main">=</span> br map_of_fmap <span class="main">(</span><span class="main">Œª</span><span class="bound">a</span><span class="main">.</span> finite <span class="main">(</span>dom <span class="bound">a</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fmdrop_set_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>op_map_delete<span class="main">,</span> fmdrop<span class="main">)</span> <span class="main">‚àà</span> Id <span class="main">‚Üí</span> map_fmap_rel <span class="main">‚Üí</span> map_fmap_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_fmap_rel_def br_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fmdrop.abs_eq<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_onp_def fmap.Abs_fmap_inject
      map_drop_def map_filter_finite
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_filter_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_upd_fmupd<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>op_map_update<span class="main">,</span> fmupd<span class="main">)</span> <span class="main">‚àà</span> Id <span class="main">‚Üí</span> Id <span class="main">‚Üí</span> map_fmap_rel <span class="main">‚Üí</span> map_fmap_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_fmap_rel_def br_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fmupd.abs_eq<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_onp_def fmap.Abs_fmap_inject
      map_drop_def map_filter_finite map_upd_def
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπTechnically <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">op_map_lookup</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has the arguments in the wrong direction.‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fmlookup'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">fmlookup'</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> fmlookup <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">def_pat_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(‚àà#)</span><span class="main">$</span><span class="free">k</span><span class="main">$</span><span class="main">(</span>dom_m<span class="main">$</span><span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">‚â°</span> Not<span class="main">$</span><span class="main">(</span>is_None<span class="main">$</span><span class="main">(</span>fmlookup'<span class="main">$</span><span class="free">k</span><span class="main">$</span><span class="free">A</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fold_is_None in_fdom_alt<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> op_map_lookup_fmlookup<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>op_map_lookup<span class="main">,</span> fmlookup'<span class="main">)</span> <span class="main">‚àà</span> Id <span class="main">‚Üí</span> map_fmap_rel <span class="main">‚Üí</span> <span class="main">‚ü®</span>Id<span class="main">‚ü©</span>option_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_fmap_rel_def br_def fmap.Abs_fmap_inverse<span class="main">)</span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">hm_fmap_assn</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">hm_fmap_assn</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">‚â°</span> hr_comp <span class="main">(</span>hm.assn <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span> map_fmap_rel‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> fmap_delete_hnr <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span> <span class="main">=</span>
  hm.delete_hnr<span class="main">[</span><span class="operator">FCOMP</span> fmdrop_set_None<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> fmap_update_hnr <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span> <span class="main">=</span>
  hm.update_hnr<span class="main">[</span><span class="operator">FCOMP</span> map_upd_fmupd<span class="main">]</span>


<span class="keyword1"><span class="command">lemmas</span></span> fmap_lookup_hnr <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span> <span class="main">=</span>
  hm.lookup_hnr<span class="main">[</span><span class="operator">FCOMP</span> op_map_lookup_fmlookup<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> fmempty_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>uncurry0 <span class="main">(</span>RETURN op_map_empty<span class="main">)</span><span class="main">,</span> uncurry0 <span class="main">(</span>RETURN fmempty<span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> unit_rel <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>f</sub></span> <span class="main">‚ü®</span>map_fmap_rel<span class="main">‚ü©</span>nres_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_fmap_rel_def br_def fmempty_def frefI nres_relI<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span> <span class="main">=</span>
  hm.empty_hnr<span class="main">[</span><span class="operator">FCOMP</span> fmempty_empty<span class="main">,</span> <span class="operator">unfolded</span> op_fmap_empty_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">iam_fmap_assn</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">iam_fmap_assn</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">‚â°</span> hr_comp <span class="main">(</span>iam.assn <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span> map_fmap_rel‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> iam_fmap_delete_hnr <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span> <span class="main">=</span>
  iam.delete_hnr<span class="main">[</span><span class="operator">FCOMP</span> fmdrop_set_None<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> iam_ffmap_update_hnr <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span> <span class="main">=</span>
  iam.update_hnr<span class="main">[</span><span class="operator">FCOMP</span> map_upd_fmupd<span class="main">]</span>


<span class="keyword1"><span class="command">lemmas</span></span> iam_ffmap_lookup_hnr <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span> <span class="main">=</span>
  iam.lookup_hnr<span class="main">[</span><span class="operator">FCOMP</span> op_map_lookup_fmlookup<span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">op_iam_fmap_empty</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">op_iam_fmap_empty</span> <span class="main">=</span> fmempty‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iam_fmempty_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>uncurry0 <span class="main">(</span>RETURN op_map_empty<span class="main">)</span><span class="main">,</span> uncurry0 <span class="main">(</span>RETURN op_iam_fmap_empty<span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> unit_rel <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>f</sub></span> <span class="main">‚ü®</span>map_fmap_rel<span class="main">‚ü©</span>nres_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_fmap_rel_def br_def fmempty_def frefI nres_relI op_iam_fmap_empty_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span> <span class="main">=</span>
  iam.empty_hnr<span class="main">[</span><span class="operator">FCOMP</span> fmempty_empty<span class="main">,</span> <span class="operator">unfolded</span> op_iam_fmap_empty_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">upper_bound_on_dom</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">upper_bound_on_dom</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">n</span><span class="main">.</span> <span class="main">‚àÄ</span><span class="bound">i</span> <span class="main">‚àà#</span><span class="main">(</span>dom_m <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">n</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(</span>Array.len<span class="main">)</span><span class="main">,</span> upper_bound_on_dom<span class="main">)</span> <span class="main">‚àà</span> <span class="main">(</span>iam_fmap_assn nat_assn <span class="free">V</span><span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> nat_assn‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπfinite <span class="main">(</span>dom <span class="skolem">b</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="skolem">i</span> <span class="main">‚àà</span> fset <span class="main">(</span>fmdom <span class="main">(</span>map_of_fmap <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="main">‚ü∑</span> <span class="skolem">i</span> <span class="main">‚àà</span> dom <span class="skolem">b</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fmdom.abs_eq<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_onp_def fset.Abs_fset_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπnat_rel <span class="main">=</span> the_pure <span class="main">(</span>nat_assn<span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    3<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπnat_assn <span class="main">=</span> pure nat_rel‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπthe_pure <span class="main">(</span><span class="main">Œª</span><span class="bound">a</span> <span class="bound">c</span> <span class="main">::</span> nat<span class="main">.</span> <span class="main">‚Üë</span> <span class="main">(</span><span class="bound">c</span> <span class="main">=</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> nat_rel‚Ä∫</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> 2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> 3<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> pure_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>iam_of_list <span class="skolem">l</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">‚àà</span> the_pure <span class="main">(</span><span class="main">Œª</span><span class="bound">a</span> <span class="bound">c</span> <span class="main">::</span> nat<span class="main">.</span> <span class="main">‚Üë</span> <span class="main">(</span><span class="bound">c</span> <span class="main">=</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">‚Üí</span> <span class="main">‚ü®</span>the_pure <span class="free">V</span><span class="main">‚ü©</span>option_rel <span class="main">‚üπ</span>
       <span class="skolem">b</span> <span class="skolem">i</span> <span class="main">=</span> Some <span class="skolem">y</span> <span class="main">‚üπ</span> <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">l</span>‚Ä∫</span></span>  <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">b</span> <span class="skolem">l</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fun_relD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_rel_def
        iam_of_list_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref_to_hoare</span>
      <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upper_bound_on_dom_def hr_comp_def iam.assn_def map_rel_def
        map_fmap_rel_def is_iam_def br_def dom_m_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> fmap_rel_nat_rel_dom_m<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>nat_rel<span class="main">,</span> <span class="free">R</span><span class="main">‚ü©</span>fmap_rel <span class="main">‚üπ</span> dom_m <span class="free">A</span> <span class="main">=</span> dom_m <span class="free">B</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> distinct_set_mset_eq_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmap_rel_alt_def distinct_mset_dom
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fmap_rel_nat_the_fmlookup<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ref_two_step'<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">A</span> <span class="main">‚â§</span> <span class="free">B</span> <span class="main">‚üπ</span>  <span class="main">‚áì</span> <span class="free">R</span> <span class="free">A</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="free">R</span> <span class="free">B</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> ref_two_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="PAC_Checker_Specification">
<div class="head">
<h1>Theory PAC_Checker_Specification</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:         PAC_Checker_Specification.thy
  Author:       Mathias Fleury, Daniela Kaufmann, JKU
  Maintainer:   Mathias Fleury, JKU
*)</span>
<span class="keyword1"><span class="command">theory</span></span> PAC_Checker_Specification
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="PAC_Specification.html">PAC_Specification</a>
    <a href="../Refine_Imperative_HOL/IICF.html">Refine_Imperative_HOL.IICF</a>
    <a href="Finite_Map_Multiset.html">Finite_Map_Multiset</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚ÄπChecker Algorithm‚Ä∫</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ

In this level of refinement, we define the first level of the
implementation of the checker, both with the specification as
on ideals and the first version of the loop.

‚Ä∫</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπSpecification‚Ä∫</span></span>

<span class="keyword1"><span class="command">datatype</span></span> status <span class="main">=</span>
  <span class="entity">is_failed</span><span class="main">:</span> FAILED <span class="main">|</span>
  <span class="entity">is_success</span><span class="main">:</span> SUCCESS <span class="main">|</span>
  <span class="entity">is_found</span><span class="main">:</span> FOUND

<span class="keyword1"><span class="command">lemma</span></span> is_success_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπis_success <span class="free">a</span> <span class="main">‚ü∑</span> <span class="free">a</span> <span class="main">=</span> SUCCESS‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'lbls</span><span class="main">)</span> pac_step <span class="main">=</span>
  Add <span class="main">(</span><span class="free"><span class="entity">pac_src1</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'lbls</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">pac_src2</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'lbls</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">new_id</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'lbls</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">pac_res</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span> <span class="main">|</span>
  Mult <span class="main">(</span>pac_src1<span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'lbls</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">pac_mult</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span> <span class="main">(</span>new_id<span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'lbls</span></span></span><span class="main">)</span> <span class="main">(</span>pac_res<span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span> <span class="main">|</span>
  Extension <span class="main">(</span>new_id<span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'lbls</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">new_var</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span><span class="main">)</span> <span class="main">(</span>pac_res<span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span> <span class="main">|</span>
  Del <span class="main">(</span>pac_src1<span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'lbls</span></span></span><span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span>  pac_state <span class="main">=</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>nat set <span class="main">√ó</span> int_poly multiset<span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PAC_checker_specification</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint_poly <span class="main">‚áí</span> int_poly multiset <span class="main">‚áí</span> <span class="main">(</span>status <span class="main">√ó</span> nat set <span class="main">√ó</span> int_poly multiset<span class="main">)</span> nres‚Ä∫</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">PAC_checker_specification</span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span><span class="main">¬¨</span>is_failed <span class="bound">b</span> <span class="main">‚ü∂</span> restricted_ideal_to<span class="hidden">‚á©</span><sub>I</sub> <span class="main">(</span><span class="main">‚ãÉ</span><span class="main">(</span>vars <span class="main">`</span> set_mset <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">‚à™</span> vars <span class="free"><span class="bound"><span class="entity">spec</span></span></span><span class="main">)</span> <span class="bound">B</span> <span class="main">‚äÜ</span> restricted_ideal_to<span class="hidden">‚á©</span><sub>I</sub> <span class="main">(</span><span class="main">‚ãÉ</span><span class="main">(</span>vars <span class="main">`</span> set_mset <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">‚à™</span> vars <span class="free"><span class="bound"><span class="entity">spec</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">‚àß</span>
      <span class="main">(</span>is_found <span class="bound">b</span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>set_mset <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PAC_checker_specification_spec</span>
  <span class="main">::</span>  <span class="quoted"><span class="quoted">‚Äπint_poly <span class="main">‚áí</span> pac_state <span class="main">‚áí</span> <span class="main">(</span>status <span class="main">√ó</span> pac_state<span class="main">)</span> <span class="main">‚áí</span> bool‚Ä∫</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">PAC_checker_specification_spec</span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">¬¨</span>is_failed <span class="bound">b</span> <span class="main">‚ü∂</span> <span class="main">‚ãÉ</span><span class="main">(</span>vars <span class="main">`</span> set_mset <span class="bound">A</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="bound">ùí±</span><span class="main">)</span> <span class="main">‚àß</span>
       <span class="main">(</span>is_success <span class="bound">b</span> <span class="main">‚ü∂</span> PAC_Format<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="bound">B</span><span class="main">)</span> <span class="main">‚àß</span>
       <span class="main">(</span>is_found <span class="bound">b</span> <span class="main">‚ü∂</span> PAC_Format<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="bound">B</span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>set_mset <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">PAC_checker_specification2</span>
  <span class="main">::</span>  <span class="quoted"><span class="quoted">‚Äπint_poly <span class="main">‚áí</span> <span class="main">(</span>nat set <span class="main">√ó</span> int_poly multiset<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span>status <span class="main">√ó</span> <span class="main">(</span>nat set <span class="main">√ó</span> int_poly multiset<span class="main">)</span><span class="main">)</span> nres‚Ä∫</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">PAC_checker_specification2</span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">‚â°</span> SPEC<span class="main">(</span>PAC_checker_specification_spec <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PAC_checker_specification_step_spec</span>
  <span class="main">::</span>  <span class="quoted"><span class="quoted">‚Äπpac_state <span class="main">‚áí</span> int_poly <span class="main">‚áí</span> pac_state <span class="main">‚áí</span> <span class="main">(</span>status <span class="main">√ó</span> pac_state<span class="main">)</span> <span class="main">‚áí</span> bool‚Ä∫</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">PAC_checker_specification_step_spec</span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">ùí±<span class="hidden">‚á©</span><sub>0</sub></span><span class="main">,</span> <span class="bound">A<span class="hidden">‚á©</span><sub>0</sub></span><span class="main">)</span> <span class="bound">spec</span> <span class="main">(</span><span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span><span class="main">.</span>
       <span class="main">(</span>is_success <span class="bound">b</span> <span class="main">‚ü∂</span>
         <span class="main">‚ãÉ</span><span class="main">(</span>vars <span class="main">`</span> set_mset <span class="bound">A<span class="hidden">‚á©</span><sub>0</sub></span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="bound">ùí±<span class="hidden">‚á©</span><sub>0</sub></span> <span class="main">‚àß</span>
          <span class="main">‚ãÉ</span><span class="main">(</span>vars <span class="main">`</span> set_mset <span class="bound">A</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="bound">ùí±</span> <span class="main">‚àß</span> PAC_Format<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="bound">ùí±<span class="hidden">‚á©</span><sub>0</sub></span><span class="main">,</span> <span class="bound">A<span class="hidden">‚á©</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">‚àß</span> PAC_Format<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="bound">B</span><span class="main">)</span> <span class="main">‚àß</span>
       <span class="main">(</span>is_found <span class="bound">b</span> <span class="main">‚ü∂</span>
          <span class="main">‚ãÉ</span><span class="main">(</span>vars <span class="main">`</span> set_mset <span class="bound">A<span class="hidden">‚á©</span><sub>0</sub></span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="bound">ùí±<span class="hidden">‚á©</span><sub>0</sub></span> <span class="main">‚àß</span>
          <span class="main">‚ãÉ</span><span class="main">(</span>vars <span class="main">`</span> set_mset <span class="bound">A</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="bound">ùí±</span> <span class="main">‚àß</span> PAC_Format<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="bound">ùí±<span class="hidden">‚á©</span><sub>0</sub></span><span class="main">,</span> <span class="bound">A<span class="hidden">‚á©</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">‚àß</span> PAC_Format<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="bound">B</span> <span class="main">‚àß</span>
         <span class="bound">spec</span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>set_mset <span class="bound">A<span class="hidden">‚á©</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">PAC_checker_specification_step2</span>
  <span class="main">::</span>  <span class="quoted"><span class="quoted">‚Äπpac_state <span class="main">‚áí</span> int_poly <span class="main">‚áí</span> pac_state <span class="main">‚áí</span> <span class="main">(</span>status <span class="main">√ó</span> pac_state<span class="main">)</span> nres‚Ä∫</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">PAC_checker_specification_step2</span> <span class="free"><span class="bound"><span class="entity">A<span class="hidden">‚á©</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">‚â°</span> SPEC<span class="main">(</span>PAC_checker_specification_step_spec <span class="free"><span class="bound"><span class="entity">A<span class="hidden">‚á©</span><sub>0</sub></span></span></span>  <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">normalize_poly_spec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">normalize_poly_spec</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">Œª</span><span class="bound">r</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">-</span> <span class="bound">r</span> <span class="main">‚àà</span> ideal polynomial_bool <span class="main">‚àß</span> vars <span class="bound">r</span> <span class="main">‚äÜ</span> vars <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> normalize_poly_spec_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπnormalize_poly_spec <span class="free">p</span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">Œª</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">-</span> <span class="free">p</span> <span class="main">‚àà</span> ideal polynomial_bool <span class="main">‚àß</span> vars <span class="bound">r</span> <span class="main">‚äÜ</span> vars <span class="free">p</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> normalize_poly_spec_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ideal.span_neg<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mult_poly_spec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint mpoly <span class="main">‚áí</span> int mpoly <span class="main">‚áí</span> int mpoly nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">mult_poly_spec</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">Œª</span><span class="bound">r</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">-</span> <span class="bound">r</span> <span class="main">‚àà</span> ideal polynomial_bool<span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>nat<span class="main">,</span> int mpoly<span class="main">)</span> fmap <span class="main">‚áí</span> nat set <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> int mpoly <span class="main">‚áí</span> bool nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">check_add</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span>
     SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚àà#</span> dom_m <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">‚àà#</span> dom_m <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">‚àâ#</span> dom_m <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">‚àß</span> vars <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">‚äÜ</span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span> <span class="main">‚àß</span>
            the <span class="main">(</span>fmlookup <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">+</span> the <span class="main">(</span>fmlookup <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">‚àà</span>  ideal polynomial_bool<span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_mult</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>nat<span class="main">,</span> int mpoly<span class="main">)</span> fmap <span class="main">‚áí</span> nat set <span class="main">‚áí</span> nat <span class="main">‚áí</span> int mpoly <span class="main">‚áí</span> nat <span class="main">‚áí</span> int mpoly <span class="main">‚áí</span> bool nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">check_mult</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span>
     SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚àà#</span> dom_m <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">‚àß</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">‚àâ#</span> dom_m <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">‚àß</span> vars <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">‚äÜ</span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span> <span class="main">‚àß</span> vars <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">‚äÜ</span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span> <span class="main">‚àß</span>
            the <span class="main">(</span>fmlookup <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">‚àà</span>  ideal polynomial_bool<span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_extension</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>nat<span class="main">,</span> int mpoly<span class="main">)</span> fmap <span class="main">‚áí</span> nat set <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> int mpoly <span class="main">‚áí</span> <span class="main">(</span>bool<span class="main">)</span> nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">check_extension</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span>
     SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">‚ü∂</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">‚àâ#</span> dom_m <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">‚àß</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">‚àâ</span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span> <span class="main">‚àß</span>
           <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">+</span>Var <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main"><span class="hidden">‚áß</span><sup>2</sup></span> <span class="main">-</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">+</span>Var <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">‚àà</span> ideal polynomial_bool <span class="main">‚àß</span>
            vars <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">+</span>Var <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_status</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">merge_status</span> <span class="main">(</span>FAILED<span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> FAILED‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">merge_status</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>FAILED<span class="main">)</span> <span class="main">=</span> FAILED‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">merge_status</span> FOUND <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> FOUND‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">merge_status</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> FOUND <span class="main">=</span> FOUND‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">merge_status</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> SUCCESS‚Ä∫</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> fpac_step <span class="main">=</span> <span class="quoted"><span class="quoted">‚Äπnat set <span class="main">√ó</span> <span class="main">(</span>nat<span class="main">,</span> int_poly<span class="main">)</span> fmap‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_del</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>nat<span class="main">,</span> int mpoly<span class="main">)</span> fmap <span class="main">‚áí</span> nat <span class="main">‚áí</span> bool nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">check_del</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span>
     SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">‚ü∂</span> True<span class="main">)</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπAlgorithm‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PAC_checker_step</span>
  <span class="main">::</span>  <span class="quoted"><span class="quoted">‚Äπint_poly <span class="main">‚áí</span> <span class="main">(</span>status <span class="main">√ó</span> fpac_step<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span>int_poly<span class="main">,</span> nat<span class="main">,</span> nat<span class="main">)</span> pac_step <span class="main">‚áí</span>
    <span class="main">(</span>status <span class="main">√ó</span> fpac_step<span class="main">)</span> nres‚Ä∫</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">PAC_checker_step</span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">spec</span> <span class="main">(</span><span class="bound">stat</span><span class="main">,</span> <span class="main">(</span><span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="bound">st</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">st</span> <span class="keyword1">of</span>
     Add <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">‚áí</span>
       <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">r</span> <span class="main">‚Üê</span> normalize_poly_spec <span class="main">(</span>pac_res <span class="bound">st</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">eq</span> <span class="main">‚Üê</span> check_add <span class="bound">A</span> <span class="bound">ùí±</span> <span class="main">(</span>pac_src1 <span class="bound">st</span><span class="main">)</span> <span class="main">(</span>pac_src2 <span class="bound">st</span><span class="main">)</span> <span class="main">(</span>new_id <span class="bound">st</span><span class="main">)</span> <span class="bound">r</span><span class="main">;</span>
        <span class="bound">st'</span> <span class="main">‚Üê</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">st'</span><span class="main">.</span> <span class="main">(</span><span class="main">¬¨</span>is_failed <span class="bound">st'</span> <span class="main">‚àß</span> is_found <span class="bound">st'</span> <span class="main">‚ü∂</span> <span class="bound">r</span> <span class="main">-</span> <span class="bound">spec</span> <span class="main">‚àà</span> ideal polynomial_bool<span class="main">)</span><span class="main">)</span><span class="main">;</span>
        <span class="keyword1">if</span> <span class="bound">eq</span>
        <span class="keyword1">then</span> RETURN <span class="main">(</span>merge_status <span class="bound">stat</span> <span class="bound">st'</span><span class="main">,</span>
          <span class="bound">ùí±</span><span class="main">,</span> fmupd <span class="main">(</span>new_id <span class="bound">st</span><span class="main">)</span> <span class="bound">r</span> <span class="bound">A</span><span class="main">)</span>
        <span class="keyword1">else</span> RETURN <span class="main">(</span>FAILED<span class="main">,</span> <span class="main">(</span><span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span>
   <span class="main">}</span>
   <span class="main">|</span> Del <span class="main"><span class="bound">_</span></span> <span class="main">‚áí</span>
       <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">eq</span> <span class="main">‚Üê</span> check_del <span class="bound">A</span> <span class="main">(</span>pac_src1 <span class="bound">st</span><span class="main">)</span><span class="main">;</span>
        <span class="keyword1">if</span> <span class="bound">eq</span>
        <span class="keyword1">then</span> RETURN <span class="main">(</span><span class="bound">stat</span><span class="main">,</span> <span class="main">(</span><span class="bound">ùí±</span><span class="main">,</span> fmdrop <span class="main">(</span>pac_src1 <span class="bound">st</span><span class="main">)</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">else</span> RETURN <span class="main">(</span>FAILED<span class="main">,</span> <span class="main">(</span><span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span>
   <span class="main">}</span>
   <span class="main">|</span> Mult <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">‚áí</span>
       <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">r</span> <span class="main">‚Üê</span> normalize_poly_spec <span class="main">(</span>pac_res <span class="bound">st</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">q</span> <span class="main">‚Üê</span> normalize_poly_spec <span class="main">(</span>pac_mult <span class="bound">st</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">eq</span> <span class="main">‚Üê</span> check_mult <span class="bound">A</span> <span class="bound">ùí±</span> <span class="main">(</span>pac_src1 <span class="bound">st</span><span class="main">)</span> <span class="bound">q</span> <span class="main">(</span>new_id <span class="bound">st</span><span class="main">)</span> <span class="bound">r</span><span class="main">;</span>
        <span class="bound">st'</span> <span class="main">‚Üê</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">st'</span><span class="main">.</span> <span class="main">(</span><span class="main">¬¨</span>is_failed <span class="bound">st'</span> <span class="main">‚àß</span> is_found <span class="bound">st'</span> <span class="main">‚ü∂</span> <span class="bound">r</span> <span class="main">-</span> <span class="bound">spec</span> <span class="main">‚àà</span> ideal polynomial_bool<span class="main">)</span><span class="main">)</span><span class="main">;</span>
        <span class="keyword1">if</span> <span class="bound">eq</span>
        <span class="keyword1">then</span> RETURN <span class="main">(</span>merge_status <span class="bound">stat</span> <span class="bound">st'</span><span class="main">,</span>
          <span class="bound">ùí±</span><span class="main">,</span> fmupd <span class="main">(</span>new_id <span class="bound">st</span><span class="main">)</span> <span class="bound">r</span> <span class="bound">A</span><span class="main">)</span>
        <span class="keyword1">else</span> RETURN <span class="main">(</span>FAILED<span class="main">,</span> <span class="main">(</span><span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span>
   <span class="main">}</span>
   <span class="main">|</span> Extension <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">‚áí</span>
       <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">r</span> <span class="main">‚Üê</span> normalize_poly_spec <span class="main">(</span>pac_res <span class="bound">st</span> <span class="main">-</span> Var <span class="main">(</span>new_var <span class="bound">st</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        <span class="main">(</span><span class="bound">eq</span><span class="main">)</span> <span class="main">‚Üê</span> check_extension <span class="bound">A</span> <span class="bound">ùí±</span> <span class="main">(</span>new_id <span class="bound">st</span><span class="main">)</span> <span class="main">(</span>new_var <span class="bound">st</span><span class="main">)</span> <span class="bound">r</span><span class="main">;</span>
        <span class="keyword1">if</span> <span class="bound">eq</span>
        <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
         RETURN <span class="main">(</span><span class="bound">stat</span><span class="main">,</span>
          insert <span class="main">(</span>new_var <span class="bound">st</span><span class="main">)</span> <span class="bound">ùí±</span><span class="main">,</span> fmupd <span class="main">(</span>new_id <span class="bound">st</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span><span class="main">)</span> <span class="bound">A</span><span class="main">)</span><span class="main">}</span>
        <span class="keyword1">else</span> RETURN <span class="main">(</span>FAILED<span class="main">,</span> <span class="main">(</span><span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span>
   <span class="main">}</span>
 <span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">polys_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(</span>nat<span class="main">,</span> int mpoly<span class="main">)</span>fmap <span class="main">√ó</span> <span class="main">_</span><span class="main">)</span> set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">polys_rel</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span><span class="main">.</span> <span class="bound">B</span> <span class="main">=</span> <span class="main">(</span>ran_m <span class="bound">A</span><span class="main">)</span><span class="main">}</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">polys_rel_full</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(</span>nat set <span class="main">√ó</span> <span class="main">(</span>nat<span class="main">,</span> int mpoly<span class="main">)</span>fmap<span class="main">)</span> <span class="main">√ó</span> <span class="main">_</span><span class="main">)</span> set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">polys_rel_full</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">ùí±'</span> <span class="main">,</span> <span class="bound">B</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel <span class="main">‚àß</span> <span class="bound">ùí±</span> <span class="main">=</span> <span class="bound">ùí±'</span><span class="main">}</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> polys_rel_update_remove<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">x13</span> <span class="main">‚àâ#</span>dom_m <span class="free">A</span> <span class="main">‚üπ</span> <span class="free">x11</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚üπ</span> <span class="free">x12</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚üπ</span> <span class="free">x11</span> <span class="main">‚â†</span> <span class="free">x12</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel <span class="main">‚üπ</span>
   <span class="main">(</span>fmupd <span class="free">x13</span> <span class="free">r</span> <span class="main">(</span>fmdrop <span class="free">x11</span> <span class="main">(</span>fmdrop <span class="free">x12</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
        add_mset <span class="free">r</span> <span class="free">B</span> <span class="main">-</span> <span class="main">{#</span>the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x11</span><span class="main">)</span><span class="main">,</span> the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x12</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span>
       <span class="main">‚àà</span> polys_rel‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">x13</span> <span class="main">‚àâ#</span>dom_m <span class="free">A</span> <span class="main">‚üπ</span> <span class="free">x11</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel <span class="main">‚üπ</span>
   <span class="main">(</span>fmupd <span class="free">x13</span> <span class="free">r</span> <span class="main">(</span>fmdrop <span class="free">x11</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span>add_mset <span class="free">r</span> <span class="free">B</span> <span class="main">-</span> <span class="main">{#</span>the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x11</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span>
       <span class="main">‚àà</span> polys_rel‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">x13</span> <span class="main">‚àâ#</span>dom_m <span class="free">A</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel <span class="main">‚üπ</span>
   <span class="main">(</span>fmupd <span class="free">x13</span> <span class="free">r</span> <span class="free">A</span><span class="main">,</span> add_mset <span class="free">r</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">x13</span> <span class="main">‚àà#</span>dom_m <span class="free">A</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel <span class="main">‚üπ</span>
   <span class="main">(</span>fmdrop <span class="free">x13</span> <span class="free">A</span><span class="main">,</span> remove1_mset <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x13</span><span class="main">)</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> distinct_mset_dom<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> polys_rel_def ran_m_mapsto_upd ran_m_mapsto_upd_notin
    ran_m_fmdrop<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ran_m_mapsto_upd_notin<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_diffD <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_m_fmdrop ran_m_fmdrop_If distinct_mset_remove1_All ran_m_def
      add_mset_eq_add_mset removeAll_notin
    <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_mset_cong<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> polys_rel_in_dom_inD<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel <span class="main">‚üπ</span>
    <span class="free">x12</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚üπ</span>
    the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x12</span><span class="main">)</span> <span class="main">‚àà#</span> <span class="free">B</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> polys_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PAC_Format_add_and_remove<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">r</span> <span class="main">-</span> <span class="free">x14</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
       <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel <span class="main">‚üπ</span>
       <span class="free">x12</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚üπ</span>
       <span class="free">x13</span> <span class="main">‚àâ#</span> dom_m <span class="free">A</span> <span class="main">‚üπ</span>
       vars <span class="free">r</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span> <span class="main">‚üπ</span>
       <span class="numeral">2</span> <span class="main">*</span> the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x12</span><span class="main">)</span> <span class="main">-</span> <span class="free">r</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
       PAC_Format<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> remove1_mset <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x12</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>add_mset <span class="free">r</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
   <span class="quoted"><span class="quoted">‚Äπ<span class="free">r</span> <span class="main">-</span> <span class="free">x14</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
       <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel <span class="main">‚üπ</span>
       the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x11</span><span class="main">)</span> <span class="main">+</span> the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x12</span><span class="main">)</span> <span class="main">-</span> <span class="free">r</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
       <span class="free">x11</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚üπ</span>
       <span class="free">x12</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚üπ</span>
       vars <span class="free">r</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span> <span class="main">‚üπ</span>
       PAC_Format<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> add_mset <span class="free">r</span> <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span>
   <span class="quoted"><span class="quoted">‚Äπ<span class="free">r</span> <span class="main">-</span> <span class="free">x14</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
       <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel <span class="main">‚üπ</span>
       <span class="free">x11</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚üπ</span>
       <span class="free">x12</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚üπ</span>
       the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x11</span><span class="main">)</span> <span class="main">+</span> the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x12</span><span class="main">)</span> <span class="main">-</span> <span class="free">r</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
       vars <span class="free">r</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span> <span class="main">‚üπ</span>
       <span class="free">x11</span> <span class="main">‚â†</span> <span class="free">x12</span> <span class="main">‚üπ</span>
       PAC_Format<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span>
        <span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> add_mset <span class="free">r</span> <span class="free">B</span> <span class="main">-</span> <span class="main">{#</span>the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x11</span><span class="main">)</span><span class="main">,</span> the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x12</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span>‚Ä∫</span></span>
   <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel <span class="main">‚üπ</span>
       <span class="free">r</span> <span class="main">-</span> <span class="free">x34</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
       <span class="free">x11</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚üπ</span>
       the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x11</span><span class="main">)</span> <span class="main">*</span> <span class="free">x32</span> <span class="main">-</span> <span class="free">r</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
       vars <span class="free">x32</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span> <span class="main">‚üπ</span>
       vars <span class="free">r</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span> <span class="main">‚üπ</span>
       PAC_Format<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> add_mset <span class="free">r</span> <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span>
   <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel <span class="main">‚üπ</span>
       <span class="free">r</span> <span class="main">-</span> <span class="free">x34</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
       <span class="free">x11</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚üπ</span>
       the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x11</span><span class="main">)</span> <span class="main">*</span> <span class="free">x32</span> <span class="main">-</span> <span class="free">r</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
       vars <span class="free">x32</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span> <span class="main">‚üπ</span>
       vars <span class="free">r</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span> <span class="main">‚üπ</span>
       PAC_Format<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> remove1_mset <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x11</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>add_mset <span class="free">r</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel <span class="main">‚üπ</span>
       <span class="free">x12</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚üπ</span>
       PAC_Format<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> remove1_mset <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x12</span><span class="main">)</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span>
   <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel <span class="main">‚üπ</span>
       <span class="main">(</span><span class="free">p'</span> <span class="main">+</span> Var <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">‚áß</span><sup>2</sup></span> <span class="main">-</span> <span class="main">(</span><span class="free">p'</span> <span class="main">+</span> Var <span class="free">x</span><span class="main">)</span> <span class="main">‚àà</span> ideal polynomial_bool <span class="main">‚üπ</span>
       <span class="free">x</span> <span class="main">‚àâ</span> <span class="free">ùí±</span> <span class="main">‚üπ</span>
       <span class="free">x</span> <span class="main">‚àâ</span> vars<span class="main">(</span><span class="free">p'</span> <span class="main">+</span> Var <span class="free">x</span><span class="main">)</span> <span class="main">‚üπ</span>
       vars<span class="main">(</span><span class="free">p'</span> <span class="main">+</span> Var <span class="free">x</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span> <span class="main">‚üπ</span>
       PAC_Format<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span>
         <span class="main">(</span>insert <span class="free">x</span> <span class="free">ùí±</span><span class="main">,</span> add_mset <span class="free">p'</span> <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> converse_rtranclp_into_rtranclp<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> PAC_Format.add<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπthe <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x12</span><span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="quoted">‚Äπthe <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x12</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> polys_rel_in_dom_inD<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> converse_rtranclp_into_rtranclp<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> PAC_Format.del<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπthe <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x12</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> polys_rel_in_dom_inD<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> H2
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> converse_rtranclp_into_rtranclp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> PAC_Format.add<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπthe <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x11</span><span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="quoted">‚Äπthe <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x12</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> polys_rel_in_dom_inD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtranclp_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> H2<span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> converse_rtranclp_into_rtranclp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> PAC_Format.del<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπthe <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x12</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> polys_rel_in_dom_inD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> converse_rtranclp_into_rtranclp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> PAC_Format.del<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπthe <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x11</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> polys_rel_in_dom_inD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> polys_rel_def ran_m_def add_mset_eq_add_mset <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> H2
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> converse_rtranclp_into_rtranclp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> PAC_Format.mult<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπthe <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x11</span><span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x32</span>‚Ä∫</span></span> <span class="quoted"><span class="free">r</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> polys_rel_in_dom_inD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtranclp_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> H2<span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> converse_rtranclp_into_rtranclp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> PAC_Format.del<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπthe <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x11</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> polys_rel_in_dom_inD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> converse_rtranclp_into_rtranclp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> PAC_Format.del<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπthe <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">x12</span><span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="free">B</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> polys_rel_in_dom_inD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> converse_rtranclp_into_rtranclp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> PAC_Format.extend_pos<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p'</span> <span class="main">+</span> Var <span class="free">x</span>‚Ä∫</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> coeff_monomila_in_varsD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p'</span> <span class="main">-</span> Var <span class="free">x</span>‚Ä∫</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> polys_rel_in_dom_inD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_in_right_only vars_subst_in_left_only<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">ùí±</span> <span class="main">‚à™</span> <span class="main">{</span><span class="bound"><span class="bound">x'</span></span> <span class="main">‚àà</span> vars <span class="main">(</span><span class="free">p'</span><span class="main">)</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">‚àâ</span> <span class="free">ùí±</span><span class="main">}</span> <span class="main">=</span> insert <span class="free">x</span> <span class="free">ùí±</span>‚Ä∫</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> coeff_monomila_in_varsD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p'</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> vars_add_Var_subset vars_minus_Var_subset polys_rel_in_dom_inD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_subst_in_left_only_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> vars_in_right_only vars_subst_in_left_only <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">status_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>status <span class="main">√ó</span> status<span class="main">)</span> set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">status_rel</span> <span class="main">‚â°</span> Id‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_merge_status<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπis_failed <span class="main">(</span>merge_status <span class="free">a</span> <span class="free">st'</span><span class="main">)</span> <span class="main">‚ü∑</span> is_failed <span class="free">a</span> <span class="main">‚à®</span> is_failed <span class="free">st'</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπis_found <span class="main">(</span>merge_status <span class="free">a</span> <span class="free">st'</span><span class="main">)</span> <span class="main">‚ü∑</span> <span class="main">¬¨</span>is_failed <span class="free">a</span> <span class="main">‚àß</span> <span class="main">¬¨</span>is_failed <span class="free">st'</span> <span class="main">‚àß</span> <span class="main">(</span>is_found <span class="free">a</span> <span class="main">‚à®</span> is_found <span class="free">st'</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπis_success <span class="main">(</span>merge_status <span class="free">a</span> <span class="free">st'</span><span class="main">)</span> <span class="main">‚ü∑</span> <span class="main">(</span>is_success <span class="free">a</span> <span class="main">‚àß</span> is_success <span class="free">st'</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">st'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> status_rel_merge_status<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>merge_status <span class="free">a</span> <span class="free">b</span><span class="main">,</span> SUCCESS<span class="main">)</span> <span class="main">‚àâ</span> status_rel <span class="main">‚ü∑</span>
    <span class="main">(</span><span class="free">a</span> <span class="main">=</span> FAILED<span class="main">)</span> <span class="main">‚à®</span> <span class="main">(</span><span class="free">b</span> <span class="main">=</span> FAILED<span class="main">)</span> <span class="main">‚à®</span>
    <span class="free">a</span> <span class="main">=</span> FOUND <span class="main">‚à®</span> <span class="main">(</span><span class="free">b</span> <span class="main">=</span> FOUND<span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Ex_status_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚àÉ</span><span class="bound">a</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span><span class="main">)</span> <span class="main">‚ü∑</span> <span class="free">P</span> SUCCESS <span class="main">‚à®</span> <span class="free">P</span> FOUND <span class="main">‚à®</span> <span class="main">(</span><span class="free">P</span> <span class="main">(</span>FAILED<span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_failed_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπis_failed <span class="free">st'</span> <span class="main">‚ü∑</span> <span class="main">¬¨</span>is_success <span class="free">st'</span> <span class="main">‚àß</span> <span class="main">¬¨</span>is_found <span class="free">st'</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">st'</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> merge_status_eq_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπmerge_status <span class="free">a</span> SUCCESS <span class="main">=</span> SUCCESS <span class="main">‚ü∑</span> <span class="free">a</span> <span class="main">=</span> SUCCESS‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπmerge_status <span class="free">a</span> SUCCESS <span class="main">=</span> FOUND <span class="main">‚ü∑</span> <span class="free">a</span> <span class="main">=</span> FOUND‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπmerge_status SUCCESS <span class="free">a</span> <span class="main">=</span> SUCCESS <span class="main">‚ü∑</span> <span class="free">a</span> <span class="main">=</span> SUCCESS‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπmerge_status SUCCESS <span class="free">a</span> <span class="main">=</span> FOUND <span class="main">‚ü∑</span> <span class="free">a</span> <span class="main">=</span> FOUND‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπmerge_status SUCCESS <span class="free">a</span> <span class="main">=</span> FAILED <span class="main">‚ü∑</span> <span class="free">a</span> <span class="main">=</span> FAILED‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπmerge_status <span class="free">a</span> SUCCESS <span class="main">=</span> FAILED <span class="main">‚ü∑</span> <span class="free">a</span> <span class="main">=</span> FAILED‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπmerge_status FOUND <span class="free">a</span> <span class="main">=</span> FAILED <span class="main">‚ü∑</span> <span class="free">a</span> <span class="main">=</span> FAILED‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπmerge_status <span class="free">a</span> FOUND <span class="main">=</span> FAILED <span class="main">‚ü∑</span> <span class="free">a</span> <span class="main">=</span> FAILED‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπmerge_status <span class="free">a</span> FOUND <span class="main">=</span> SUCCESS <span class="main">‚ü∑</span> False‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπmerge_status <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> FOUND <span class="main">‚ü∑</span> <span class="main">(</span><span class="free">a</span> <span class="main">=</span> FOUND <span class="main">‚à®</span> <span class="free">b</span> <span class="main">=</span> FOUND<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a</span> <span class="main">‚â†</span> FAILED <span class="main">‚àß</span> <span class="free">b</span> <span class="main">‚â†</span> FAILED<span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> fmdrop_irrelevant<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x11</span> <span class="main">‚àâ#</span> dom_m <span class="free">A</span> <span class="main">‚üπ</span> fmdrop <span class="free">x11</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmap_ext in_dom_m_lookup_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PAC_checker_step_PAC_checker_specification2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπstatus‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> AB<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">ùí±<span class="hidden">‚á©</span><sub>B</sub></span><span class="main">,</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel_full‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">¬¨</span>is_failed <span class="free">a</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">a</span> <span class="main">=</span> FOUND <span class="main">‚üπ</span> <span class="free">spec</span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>set_mset <span class="free">A<span class="hidden">‚á©</span><sub>0</sub></span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    A<span class="hidden">‚á©</span><sub>0</sub>B<span class="main">:</span> <span class="quoted"><span class="quoted">‚ÄπPAC_Format<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free">ùí±<span class="hidden">‚á©</span><sub>0</sub></span><span class="main">,</span> <span class="free">A<span class="hidden">‚á©</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    spec<span class="hidden">‚á©</span><sub>0</sub><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπvars <span class="free">spec</span> <span class="main">‚äÜ</span> <span class="free">ùí±<span class="hidden">‚á©</span><sub>0</sub></span>‚Ä∫</span></span>  <span class="keyword2"><span class="keyword">and</span></span>
    vars_A<span class="hidden">‚á©</span><sub>0</sub><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÉ</span> <span class="main">(</span>vars <span class="main">`</span> set_mset <span class="free">A<span class="hidden">‚á©</span><sub>0</sub></span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="free">ùí±<span class="hidden">‚á©</span><sub>0</sub></span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚ÄπPAC_checker_step <span class="free">spec</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="free">st</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">(</span>status_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> polys_rel_full<span class="main">)</span> <span class="main">(</span>PAC_checker_specification_step2 <span class="main">(</span><span class="free">ùí±<span class="hidden">‚á©</span><sub>0</sub></span><span class="main">,</span> <span class="free">A<span class="hidden">‚á©</span><sub>0</sub></span><span class="main">)</span> <span class="free">spec</span> <span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">ùí±<span class="hidden">‚á©</span><sub>B</sub></span> <span class="main">=</span> <span class="free">ùí±</span>‚Ä∫</span></span><span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> AB
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> polys_rel_full_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> H0<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="numeral">2</span> <span class="main">*</span> the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x12</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">r</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
          <span class="skolem">r</span> <span class="main">‚àà</span> pac_ideal
                <span class="main">(</span>insert <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x12</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> set_mset <span class="skolem">Aa</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x12</span> <span class="skolem">r</span> <span class="skolem">Aa</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> ab_semigroup_mult_class.mult.commute 
         diff_in_polynomial_bool_pac_idealI
       ideal.span_base pac_idealI3 set_image_mset set_mset_add_mset_insert union_single_eq_member<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> H0'<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">Aa</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x12</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">r</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
          <span class="skolem">r</span> <span class="main">-</span> <span class="free">spec</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
          <span class="free">spec</span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>insert <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x12</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> set_mset <span class="bound">Aa</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span> <span class="skolem">x12</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> diff_in_polynomial_bool_pac_idealI<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> H1<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ <span class="skolem">x12</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚üπ</span>
       <span class="numeral">2</span> <span class="main">*</span> the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x12</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">r</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
       <span class="skolem">r</span> <span class="main">-</span> <span class="free">spec</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
       vars <span class="free">spec</span> <span class="main">‚äÜ</span> vars <span class="skolem">r</span> <span class="main">‚üπ</span>
       <span class="free">spec</span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>set_mset <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x12</span> <span class="skolem">r</span>
     <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel‚Ä∫</span></span>
      ideal.span_add<span class="main">[</span><span class="operator">OF</span> ideal.span_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ideal.span_neg ideal.span_neg<span class="main"><span class="main">,</span></span>
         <span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπthe <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x12</span><span class="main">)</span>‚Ä∫</span></span> <span class="main"><span class="main">_</span></span>  <span class="quoted"><span class="quoted">‚Äπthe <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x12</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span>
      <span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπset_mset <span class="free">B</span> <span class="main">‚à™</span> polynomial_bool‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="numeral">2</span> <span class="main">*</span> the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x12</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">r</span>‚Ä∫</span></span><span class="main">]</span>
     <span class="keyword1"><span class="command">unfolding</span></span> polys_rel_def
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_m_def 
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H0'<span class="main">)</span>
   <span class="keyword1"><span class="command">have</span></span> H2'<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπthe <span class="main">(</span>fmlookup <span class="skolem">A</span> <span class="skolem">x11</span><span class="main">)</span> <span class="main">+</span> the <span class="main">(</span>fmlookup <span class="skolem">A</span> <span class="skolem">x12</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">r</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
       <span class="free">B</span> <span class="main">=</span> add_mset <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="skolem">A</span> <span class="skolem">x11</span><span class="main">)</span><span class="main">)</span> <span class="main">{#</span>the <span class="main">(</span>fmlookup <span class="skolem">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà#</span> <span class="skolem">Aa</span><span class="main">#}</span> <span class="main">‚üπ</span>
       <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="skolem">A</span> <span class="skolem">x11</span><span class="main">)</span> <span class="main">+</span> the <span class="main">(</span>fmlookup <span class="skolem">A</span> <span class="skolem">x12</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">r</span>
        <span class="main">‚àà</span> More_Modules.ideal
            <span class="main">(</span>insert <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="skolem">A</span> <span class="skolem">x11</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span>fmlookup <span class="skolem">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> set_mset <span class="skolem">Aa</span> <span class="main">‚à™</span> polynomial_bool<span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span>
        <span class="main">-</span> <span class="skolem">r</span>
        <span class="main">‚àà</span> More_Modules.ideal
            <span class="main">(</span>insert <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="skolem">A</span> <span class="skolem">x11</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span>fmlookup <span class="skolem">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> set_mset <span class="skolem">Aa</span> <span class="main">‚à™</span> polynomial_bool<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span>
       <span class="skolem">r</span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>insert <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="skolem">A</span> <span class="skolem">x11</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span>fmlookup <span class="skolem">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> set_mset <span class="skolem">Aa</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
     <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span> <span class="skolem">x12</span> <span class="skolem">x11</span> <span class="skolem">A</span> <span class="skolem">Aa</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Un_insert_left diff_diff_eq2 diff_in_polynomial_bool_pac_idealI diff_zero
       ideal.span_diff ideal.span_neg minus_diff_eq pac_idealI1 pac_ideal_def set_image_mset
       set_mset_add_mset_insert union_single_eq_member<span class="main">)</span>
   <span class="keyword1"><span class="command">have</span></span> H2<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x11</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚üπ</span>
       <span class="skolem">x12</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚üπ</span>
       the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x11</span><span class="main">)</span> <span class="main">+</span> the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x12</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">r</span>
       <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
       <span class="skolem">r</span> <span class="main">-</span> <span class="free">spec</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
       <span class="free">spec</span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>set_mset <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span>  <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x12</span> <span class="skolem">r</span> <span class="skolem">x11</span>
     <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel‚Ä∫</span></span>
      ideal.span_add<span class="main">[</span><span class="operator">OF</span> ideal.span_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ideal.span_neg ideal.span_neg<span class="main"><span class="main">,</span></span>
         <span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπthe <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x11</span><span class="main">)</span>‚Ä∫</span></span> <span class="main"><span class="main">_</span></span>  <span class="quoted"><span class="quoted">‚Äπthe <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x12</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span>
      <span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπset_mset <span class="free">B</span> <span class="main">‚à™</span> polynomial_bool‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπthe <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x11</span><span class="main">)</span> <span class="main">+</span> the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x12</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">r</span>‚Ä∫</span></span><span class="main">]</span>
     <span class="keyword1"><span class="command">unfolding</span></span> polys_rel_def
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">r</span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>set_mset <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_m_def ideal.span_base 
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> diff_in_polynomial_bool_pac_idealI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H2'<span class="main">)</span>

   <span class="keyword1"><span class="command">have</span></span> H3'<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπthe <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x12</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q</span> <span class="main">-</span> <span class="skolem">r</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
          <span class="skolem">r</span> <span class="main">-</span> <span class="free">spec</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
          <span class="skolem">r</span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>insert <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x12</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> set_mset <span class="skolem">Aa</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
     <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">Aa</span> <span class="skolem">x12</span> <span class="skolem">r</span> <span class="skolem">q</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> ab_semigroup_mult_class.mult.commute diff_in_polynomial_bool_pac_idealI
       ideal.span_base pac_idealI3 set_image_mset set_mset_add_mset_insert union_single_eq_member<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> H3<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x12</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚üπ</span>
       the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x12</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q</span> <span class="main">-</span> <span class="skolem">r</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
       <span class="skolem">r</span> <span class="main">-</span> <span class="free">spec</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
       <span class="free">spec</span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>set_mset <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x12</span> <span class="skolem">r</span> <span class="skolem">q</span>
     <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel‚Ä∫</span></span>
      ideal.span_add<span class="main">[</span><span class="operator">OF</span> ideal.span_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ideal.span_neg ideal.span_neg<span class="main"><span class="main">,</span></span>
         <span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπthe <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x12</span><span class="main">)</span>‚Ä∫</span></span> <span class="main"><span class="main">_</span></span>  <span class="quoted"><span class="quoted">‚Äπthe <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x12</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span>
      <span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπset_mset <span class="free">B</span> <span class="main">‚à™</span> polynomial_bool‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="numeral">2</span> <span class="main">*</span> the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x12</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">r</span>‚Ä∫</span></span><span class="main">]</span>
     <span class="keyword1"><span class="command">unfolding</span></span> polys_rel_def
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">r</span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>set_mset <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_m_def H3'
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> diff_in_polynomial_bool_pac_idealI<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">spec</span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>set_mset <span class="free">B</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">spec</span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>set_mset <span class="free">A<span class="hidden">‚á©</span><sub>0</sub></span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    vars_B<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÉ</span> <span class="main">(</span>vars <span class="main">`</span> set_mset <span class="free">B</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span>‚Ä∫</span></span><span class="keyword2"><span class="keyword">and</span></span>
    vars_B<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÉ</span> <span class="main">(</span>vars <span class="main">`</span> set_mset <span class="main">(</span>ran_m <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> rtranclp_PAC_Format_subset_ideal<span class="main">[</span><span class="operator">OF</span> A<span class="hidden">‚á©</span><sub>0</sub>B  vars_A<span class="hidden">‚á©</span><sub>0</sub><span class="main">]</span> spec<span class="hidden">‚á©</span><sub>0</sub> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel‚Ä∫</span></span><span class="main">[</span><span class="operator">unfolded</span> polys_rel_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> in_mono mem_Collect_eq restricted_ideal_to_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> eq_successI<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">st'</span> <span class="main">‚â†</span> FAILED <span class="main">‚üπ</span>
       <span class="skolem">st'</span> <span class="main">‚â†</span> FOUND <span class="main">‚üπ</span> <span class="skolem">st'</span> <span class="main">=</span> SUCCESS‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">st'</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">st'</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> vars_diff_inv<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπvars <span class="main">(</span>Var <span class="skolem">x2</span> <span class="main">-</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> vars <span class="main">(</span><span class="skolem">r</span> <span class="main">-</span> Var <span class="skolem">x2</span> <span class="main">::</span> int mpoly<span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x2</span> <span class="skolem">r</span>
    <span class="keyword1"><span class="command">using</span></span> vars_uminus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚ÄπVar <span class="skolem">x2</span> <span class="main">-</span> <span class="skolem">r</span>‚Ä∫</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> vars_uminus<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> vars_add_inv<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπvars <span class="main">(</span>Var <span class="skolem">x2</span> <span class="main">+</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> vars <span class="main">(</span><span class="skolem">r</span> <span class="main">+</span> Var <span class="skolem">x2</span> <span class="main">::</span> int mpoly<span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x2</span> <span class="skolem">r</span>
    <span class="keyword1"><span class="command">unfolding</span></span> add.commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚ÄπVar <span class="skolem">x2</span>‚Ä∫</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">a</span> <span class="main">‚â†</span> FAILED‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">a</span> <span class="main">‚â†</span> SUCCESS <span class="main">‚üπ</span> <span class="free">a</span> <span class="main">=</span> FOUND‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmerge_status <span class="free">a</span> FOUND <span class="main">=</span> FOUND‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> PAC_checker_step_def PAC_checker_specification_step_spec_def
      normalize_poly_spec_alt_def check_mult_def check_add_def
      check_extension_def polys_rel_full_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">st</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x11 x12 x13 x14
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> lhs_step_If<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> r eqa st'
        <span class="keyword1"><span class="command">using</span></span> assms vars_B <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> RETURN_SPEC_refine<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>merge_status <span class="free">a</span> <span class="skolem">st'</span><span class="main">,</span><span class="free">ùí±</span><span class="main">,</span>add_mset <span class="skolem">r</span> <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> polys_rel_update_remove ran_m_mapsto_upd_notin
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> PAC_Format_add_and_remove H2 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rtranclp_PAC_Format_subset_ideal<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> RETURN_SPEC_refine<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ex_status_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rtranclp_PAC_Format_subset_ideal<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x11 x12 x13 x14
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> lhs_step_If<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> r q eqa st'
        <span class="keyword1"><span class="command">using</span></span> assms vars_B <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> RETURN_SPEC_refine<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>merge_status <span class="free">a</span> <span class="skolem">st'</span><span class="main">,</span><span class="free">ùí±</span><span class="main">,</span>add_mset <span class="skolem">r</span> <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> polys_rel_update_remove <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> PAC_Format_add_and_remove<span class="main"><span class="main">(</span></span>3-<span class="main"><span class="main">)</span></span> H3
           <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rtranclp_PAC_Format_subset_ideal<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> RETURN_SPEC_refine<span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ex_status_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x31 x32 x34
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> lhs_step_If<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> r x
        <span class="keyword1"><span class="command">using</span></span> assms vars_B <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> RETURN_SPEC_refine<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a</span><span class="main">,</span>insert <span class="skolem">x32</span> <span class="free">ùí±</span><span class="main">,</span> add_mset <span class="skolem">r</span> <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> polys_rel_update_remove PAC_Format_add_and_remove<span class="main"><span class="main">(</span></span>5-<span class="main"><span class="main">)</span></span>
           <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rtranclp_PAC_Format_subset_ideal<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> RETURN_SPEC_refine<span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ex_status_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x11
      <span class="keyword1"><span class="command">unfolding</span></span> check_del_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> lhs_step_If<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> eq
        <span class="keyword1"><span class="command">using</span></span> assms vars_B <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> RETURN_SPEC_refine<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x11</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span>‚Ä∫</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">ùí±</span><span class="main">,</span> remove1_mset <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x11</span><span class="main">)</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> polys_rel_update_remove PAC_Format_add_and_remove
               is_failed_def is_success_def is_found_def
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_successI
            <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rtranclp_PAC_Format_subset_ideal
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> PAC_Format_add_and_remove H3<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">ùí±</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmdrop_irrelevant
               is_failed_def is_success_def is_found_def
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_successI
            <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rtranclp_PAC_Format_subset_ideal
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> PAC_Format_add_and_remove<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> RETURN_SPEC_refine<span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ex_status_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PAC_checker</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint_poly <span class="main">‚áí</span> fpac_step <span class="main">‚áí</span> status <span class="main">‚áí</span> <span class="main">(</span>int_poly<span class="main">,</span> nat<span class="main">,</span> nat<span class="main">)</span> pac_step list <span class="main">‚áí</span>
    <span class="main">(</span>status <span class="main">√ó</span> fpac_step<span class="main">)</span> nres‚Ä∫</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">PAC_checker</span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚Üê</span> <span class="keyword1">WHILE<span class="hidden">‚á©</span><sub>T</sub></span>
       <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="main">(</span><span class="bound">b</span> <span class="main">::</span> status<span class="main">,</span> <span class="bound">A</span> <span class="main">::</span> fpac_step<span class="main">)</span><span class="main">,</span> <span class="bound">st</span><span class="main">)</span><span class="main">.</span> <span class="main">¬¨</span>is_failed <span class="bound">b</span> <span class="main">‚àß</span> <span class="bound">st</span> <span class="main">‚â†</span> <span class="main">[]</span><span class="main">)</span>
       <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="main">(</span><span class="bound">bA</span><span class="main">)</span><span class="main">,</span> <span class="bound">st</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
          ASSERT<span class="main">(</span><span class="bound">st</span> <span class="main">‚â†</span> <span class="main">[]</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">S</span> <span class="main">‚Üê</span> PAC_checker_step <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="main">(</span><span class="bound">bA</span><span class="main">)</span> <span class="main">(</span>hd <span class="bound">st</span><span class="main">)</span><span class="main">;</span>
          RETURN <span class="main">(</span><span class="bound">S</span><span class="main">,</span> tl <span class="bound">st</span><span class="main">)</span>
        <span class="main">}</span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="bound">S</span>
  <span class="main">}</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">lemma</span></span> PAC_checker_specification_spec_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπPAC_checker_specification_spec <span class="free">spec</span> <span class="free">A</span> <span class="main">(</span><span class="free">st</span><span class="main">,</span> <span class="free">x2</span><span class="main">)</span> <span class="main">‚üπ</span>
    PAC_checker_specification_step_spec <span class="free">A</span> <span class="free">spec</span> <span class="free">x2</span> <span class="main">(</span><span class="free">st'</span><span class="main">,</span> <span class="free">x1a</span><span class="main">)</span> <span class="main">‚üπ</span>
    PAC_checker_specification_spec <span class="free">spec</span> <span class="free">A</span> <span class="main">(</span><span class="free">st'</span><span class="main">,</span> <span class="free">x1a</span><span class="main">)</span>‚Ä∫</span></span>
 <span class="keyword1"><span class="command">unfolding</span></span> PAC_checker_specification_spec_def
   PAC_checker_specification_step_spec_def
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">using</span></span> is_failed_alt_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> RES_SPEC_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπRES <span class="free">Œ¶</span> <span class="main">=</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">‚àà</span> <span class="free">Œ¶</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_failed_is_success_completeD<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">¬¨</span> is_failed <span class="free">x</span> <span class="main">‚üπ</span> <span class="main">¬¨</span>is_success <span class="free">x</span> <span class="main">‚üπ</span> is_found <span class="free">x</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> PAC_checker_PAC_checker_specification2<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span>  polys_rel_full <span class="main">‚üπ</span>
    <span class="main">¬¨</span>is_failed <span class="free">a</span> <span class="main">‚üπ</span>
    <span class="main">(</span><span class="free">a</span> <span class="main">=</span> FOUND <span class="main">‚üπ</span> <span class="free">spec</span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>set_mset <span class="main">(</span>snd <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span>
    <span class="main">‚ãÉ</span><span class="main">(</span>vars <span class="main">`</span> set_mset <span class="main">(</span>ran_m <span class="main">(</span>snd <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äÜ</span> fst <span class="free">B</span> <span class="main">‚üπ</span>
    vars <span class="free">spec</span> <span class="main">‚äÜ</span> fst <span class="free">B</span> <span class="main">‚üπ</span>
  PAC_checker <span class="free">spec</span> <span class="free">A</span> <span class="free">a</span> <span class="free">st</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">(</span>status_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> polys_rel_full<span class="main">)</span> <span class="main">(</span>PAC_checker_specification2 <span class="free">spec</span> <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> PAC_checker_def conc_fun_RES
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> RES_SPEC_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> WHILET_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span>
      I <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">Œª</span><span class="main">(</span><span class="main">(</span><span class="bound">bB</span><span class="main">)</span><span class="main">,</span> <span class="bound">st</span><span class="main">)</span><span class="main">.</span> <span class="bound">bB</span> <span class="main">‚àà</span> <span class="main">(</span>status_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> polys_rel_full<span class="main">)</span><span class="main">¬Ø</span> <span class="main">``</span>
                      Collect <span class="main">(</span>PAC_checker_specification_spec <span class="free">spec</span> <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">‚Äπmeasure <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">st</span><span class="main">)</span><span class="main">.</span>  Suc <span class="main">(</span>length <span class="bound">st</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PAC_checker_specification_spec_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">B</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>polys_rel_def polys_rel_full_def Image_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span>
     PAC_checker_step_PAC_checker_specification2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπfst <span class="free">B</span>‚Ä∫</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> PAC_checker_specification_spec_trans <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_fun_RES<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> PAC_checker_specification_spec_def polys_rel_full_def polys_rel_def
       <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> PAC_Format_subset_ideal
       <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_failed_is_success_completeD<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Image_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> PAC_checker_specification_spec_trans
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> polys_rel_def polys_rel_full_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">remap_polys_polynomial_bool</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint mpoly <span class="main">‚áí</span> nat set <span class="main">‚áí</span> <span class="main">(</span>nat<span class="main">,</span> int_poly<span class="main">)</span> fmap <span class="main">‚áí</span> <span class="main">(</span>status <span class="main">√ó</span> fpac_step<span class="main">)</span> nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">remap_polys_polynomial_bool</span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">ùí±</span> <span class="bound">A</span><span class="main">.</span>
   SPEC<span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">st</span><span class="main">,</span> <span class="bound">ùí±'</span><span class="main">,</span> <span class="bound">A'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">¬¨</span>is_failed <span class="bound">st</span> <span class="main">‚ü∂</span>
      dom_m <span class="bound">A</span> <span class="main">=</span> dom_m <span class="bound">A'</span> <span class="main">‚àß</span>
      <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">i</span> <span class="main">‚àà#</span> dom_m <span class="bound">A</span><span class="main">.</span> the <span class="main">(</span>fmlookup <span class="bound">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> the <span class="main">(</span>fmlookup <span class="bound">A'</span> <span class="bound">i</span><span class="main">)</span> <span class="main">‚àà</span> ideal polynomial_bool<span class="main">)</span> <span class="main">‚àß</span>
      <span class="main">‚ãÉ</span><span class="main">(</span>vars <span class="main">`</span> set_mset <span class="main">(</span>ran_m <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="bound">ùí±'</span> <span class="main">‚àß</span>
      <span class="main">‚ãÉ</span><span class="main">(</span>vars <span class="main">`</span> set_mset <span class="main">(</span>ran_m <span class="bound">A'</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="bound">ùí±'</span><span class="main">)</span> <span class="main">‚àß</span>
    <span class="main">(</span><span class="bound">st</span> <span class="main">=</span> FOUND <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="main">‚àà#</span> ran_m <span class="bound">A'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">remap_polys_change_all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint mpoly <span class="main">‚áí</span> nat set <span class="main">‚áí</span> <span class="main">(</span>nat<span class="main">,</span> int_poly<span class="main">)</span> fmap <span class="main">‚áí</span> <span class="main">(</span>status <span class="main">√ó</span> fpac_step<span class="main">)</span> nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">remap_polys_change_all</span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">ùí±</span> <span class="bound">A</span><span class="main">.</span> SPEC <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">st</span><span class="main">,</span> <span class="bound">ùí±'</span><span class="main">,</span> <span class="bound">A'</span><span class="main">)</span><span class="main">.</span>
    <span class="main">(</span><span class="main">¬¨</span>is_failed <span class="bound">st</span> <span class="main">‚ü∂</span>
      pac_ideal <span class="main">(</span>set_mset <span class="main">(</span>ran_m <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> pac_ideal <span class="main">(</span>set_mset <span class="main">(</span>ran_m <span class="bound">A'</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àß</span>
      <span class="main">‚ãÉ</span><span class="main">(</span>vars <span class="main">`</span> set_mset <span class="main">(</span>ran_m <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="bound">ùí±'</span> <span class="main">‚àß</span>
      <span class="main">‚ãÉ</span><span class="main">(</span>vars <span class="main">`</span> set_mset <span class="main">(</span>ran_m <span class="bound">A'</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="bound">ùí±'</span><span class="main">)</span> <span class="main">‚àß</span>
    <span class="main">(</span><span class="bound">st</span> <span class="main">=</span> FOUND <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="main">‚àà#</span> ran_m <span class="bound">A'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fmap_eq_dom_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">A</span> <span class="main">=</span> <span class="free">A'</span> <span class="main">‚ü∑</span> dom_m <span class="free">A</span> <span class="main">=</span> dom_m <span class="free">A'</span> <span class="main">‚àß</span> <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">i</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span><span class="main">.</span> the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span>fmlookup <span class="free">A'</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fmap_ext in_dom_m_lookup_iff option.expand<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ideal_remap_incl<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπfinite <span class="free">A'</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">a'</span><span class="main">‚àà</span><span class="free">A'</span><span class="main">.</span> <span class="main">‚àÉ</span><span class="bound">a</span><span class="main">‚àà</span><span class="free">A</span><span class="main">.</span> <span class="bound">a</span><span class="main">-</span><span class="bound">a'</span> <span class="main">‚àà</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚üπ</span> ideal <span class="main">(</span><span class="free">A'</span> <span class="main">‚à™</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚äÜ</span> ideal <span class="main">(</span><span class="free">A</span> <span class="main">‚à™</span> <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ideal.span_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> ideal.span_mono sup_ge2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xa</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">‚àà</span> <span class="free">A</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">-</span> <span class="skolem">x</span> <span class="main">‚àà</span> <span class="free">B</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">‚àà</span> More_Modules.ideal <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">(</span><span class="skolem">F</span> <span class="main">‚à™</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a4<span class="main">:</span> <span class="quoted"><span class="quoted">"More_Modules.ideal <span class="main">(</span><span class="skolem">F</span> <span class="main">‚à™</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚äÜ</span> More_Modules.ideal <span class="main">(</span><span class="free">A</span> <span class="main">‚à™</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">‚àà</span> More_Modules.ideal <span class="main">(</span><span class="free">A</span> <span class="main">‚à™</span> <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a2 a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Un_upper1 Un_upper2 add_diff_cancel_left' diff_add_cancel
        ideal.module_axioms ideal.span_diff in_mono module.span_superset<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">‚àà</span> More_Modules.ideal <span class="main">(</span><span class="free">A</span> <span class="main">‚à™</span> <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a4 a3 ideal.span_insert_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pac_ideal_remap_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπdom_m <span class="free">b</span> <span class="main">=</span> dom_m <span class="free">ba</span> <span class="main">‚üπ</span>
       <span class="main">‚àÄ</span><span class="bound">i</span><span class="main">‚àà#</span>dom_m <span class="free">ba</span><span class="main">.</span>
          the <span class="main">(</span>fmlookup <span class="free">b</span> <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> the <span class="main">(</span>fmlookup <span class="free">ba</span> <span class="bound">i</span><span class="main">)</span>
          <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
     pac_ideal <span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span>fmlookup <span class="free">b</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> set_mset <span class="main">(</span>dom_m <span class="free">ba</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> pac_ideal <span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span>fmlookup <span class="free">ba</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> set_mset <span class="main">(</span>dom_m <span class="free">ba</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pac_ideal_alt_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ideal_remap_incl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ideal.span_neg<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> ideal.span_neg<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ideal_remap_incl<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> remap_polys_polynomial_bool_remap_polys_change_all<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπremap_polys_polynomial_bool <span class="free">spec</span> <span class="free">ùí±</span> <span class="free">A</span> <span class="main">‚â§</span> remap_polys_change_all <span class="free">spec</span> <span class="free">ùí±</span> <span class="free">A</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> remap_polys_polynomial_bool_def remap_polys_change_all_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ideal.span_zero fmap_eq_dom_iff ideal.span_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> multi_member_split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_m_def ideal.span_base pac_ideal_remap_eq
    add_mset_eq_add_mset
    eq_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπadd_mset <span class="main">_</span> <span class="main">_</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπdom_m <span class="main">(</span><span class="skolem">A</span> <span class="main">::</span> <span class="main">(</span>nat<span class="main">,</span> int mpoly<span class="main">)</span>fmap<span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">A</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">remap_polys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint mpoly <span class="main">‚áí</span> nat set <span class="main">‚áí</span> <span class="main">(</span>nat<span class="main">,</span> int_poly<span class="main">)</span> fmap <span class="main">‚áí</span> <span class="main">(</span>status <span class="main">√ó</span> fpac_step<span class="main">)</span> nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">remap_polys</span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">ùí±</span> <span class="bound">A</span><span class="main">.</span> <span class="keyword1">do</span><span class="main">{</span>
   <span class="bound">dom</span> <span class="main">‚Üê</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">dom</span><span class="main">.</span> set_mset <span class="main">(</span>dom_m <span class="bound">A</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="bound">dom</span> <span class="main">‚àß</span> finite <span class="bound">dom</span><span class="main">)</span><span class="main">;</span>

   <span class="bound">failed</span> <span class="main">‚Üê</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="main"><span class="bound">_</span></span><span class="main">::</span>bool<span class="main">.</span> True<span class="main">)</span><span class="main">;</span>
   <span class="keyword1">if</span> <span class="bound">failed</span>
   <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
      RETURN <span class="main">(</span>FAILED<span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> fmempty<span class="main">)</span>
   <span class="main">}</span>
   <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">N</span><span class="main">)</span> <span class="main">‚Üê</span> FOREACH <span class="bound">dom</span>
       <span class="main">(</span><span class="main">Œª</span><span class="bound">i</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A'</span><span class="main">)</span><span class="main">.</span>
          <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">‚àà#</span> dom_m <span class="bound">A</span>
          <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
            <span class="bound">p</span> <span class="main">‚Üê</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">p</span><span class="main">.</span> the <span class="main">(</span>fmlookup <span class="bound">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> <span class="bound">p</span> <span class="main">‚àà</span> ideal polynomial_bool <span class="main">‚àß</span> vars <span class="bound">p</span> <span class="main">‚äÜ</span> vars <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="bound">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
            <span class="bound">eq</span> <span class="main">‚Üê</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">eq</span><span class="main">.</span> <span class="bound">eq</span> <span class="main">‚ü∂</span> <span class="bound">p</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span><span class="main">)</span><span class="main">;</span>
            <span class="bound">ùí±</span> <span class="main">‚Üê</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">ùí±'</span><span class="main">.</span> <span class="bound">ùí±</span> <span class="main">‚à™</span> vars <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="bound">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="bound">ùí±'</span><span class="main">)</span><span class="main">;</span>
            RETURN<span class="main">(</span><span class="bound">b</span> <span class="main">‚à®</span> <span class="bound">eq</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> fmupd <span class="bound">i</span> <span class="bound">p</span> <span class="bound">A'</span><span class="main">)</span>
          <span class="main">}</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A'</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span>False<span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> fmempty<span class="main">)</span><span class="main">;</span>
       RETURN <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> FOUND <span class="keyword1">else</span> SUCCESS<span class="main">,</span> <span class="bound">N</span><span class="main">)</span>
     <span class="main">}</span>
   <span class="main">}</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> remap_polys_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπremap_polys <span class="free">spec</span> <span class="free">ùí±</span> <span class="free">A</span> <span class="main">‚â§</span> remap_polys_polynomial_bool <span class="free">spec</span> <span class="free">ùí±</span> <span class="free">A</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> remap_polys_def remap_polys_polynomial_bool_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> FOREACH_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span>
    I <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">Œª</span><span class="bound">dom</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A'</span><span class="main">)</span><span class="main">.</span>
      set_mset <span class="main">(</span>dom_m <span class="bound">A'</span><span class="main">)</span> <span class="main">=</span>  set_mset <span class="main">(</span>dom_m <span class="free">A</span><span class="main">)</span> <span class="main">-</span> <span class="bound">dom</span> <span class="main">‚àß</span>
      <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">i</span> <span class="main">‚àà</span> set_mset <span class="main">(</span>dom_m <span class="free">A</span><span class="main">)</span> <span class="main">-</span> <span class="bound">dom</span><span class="main">.</span> the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> the <span class="main">(</span>fmlookup <span class="bound">A'</span> <span class="bound">i</span><span class="main">)</span> <span class="main">‚àà</span> ideal polynomial_bool<span class="main">)</span> <span class="main">‚àß</span>
     <span class="main">‚ãÉ</span><span class="main">(</span>vars <span class="main">`</span> set_mset <span class="main">(</span>ran_m <span class="main">(</span>fmrestrict_set <span class="main">(</span>set_mset <span class="main">(</span>dom_m <span class="bound">A'</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="bound">ùí±</span> <span class="main">‚àß</span>
     <span class="main">‚ãÉ</span><span class="main">(</span>vars <span class="main">`</span> set_mset <span class="main">(</span>ran_m <span class="bound">A'</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="bound">ùí±</span> <span class="main">‚àß</span>
      <span class="main">(</span><span class="bound">b</span> <span class="main">‚ü∂</span> <span class="free">spec</span> <span class="main">‚àà#</span> ran_m <span class="bound">A'</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> ideal.span_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span><span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_m_mapsto_upd_notin dom_m_fmrestrict_set' subset_eq<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span><span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_m_mapsto_upd_notin dom_m_fmrestrict_set' subset_eq<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_m_mapsto_upd_notin<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_m_mapsto_upd_notin dom_m_fmrestrict_set' subset_eq<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_m_mapsto_upd_notin dom_m_fmrestrict_set' subset_eq<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_set_mset_eq_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> distinct_mset_dom<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_set_mset_eq_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> distinct_mset_dom<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_m_mapsto_upd_notin dom_m_fmrestrict_set' subset_eq
       fmlookup_restrict_set_id'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_m_mapsto_upd_notin dom_m_fmrestrict_set' subset_eq<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_m_mapsto_upd_notin dom_m_fmrestrict_set' subset_eq
       fmlookup_restrict_set_id'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπFull Checker‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">full_checker</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint_poly <span class="main">‚áí</span> <span class="main">(</span>nat<span class="main">,</span> int_poly<span class="main">)</span> fmap <span class="main">‚áí</span> <span class="main">(</span>int_poly<span class="main">,</span> nat<span class="main">,</span>nat<span class="main">)</span> pac_step list <span class="main">‚áí</span> <span class="main">(</span>status <span class="main">√ó</span> <span class="main">_</span><span class="main">)</span> nres‚Ä∫</span></span>
 <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">full_checker</span> <span class="free"><span class="bound"><span class="entity">spec0</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">pac</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">spec</span> <span class="main">‚Üê</span> normalize_poly_spec <span class="free"><span class="bound"><span class="entity">spec0</span></span></span><span class="main">;</span>
     <span class="main">(</span><span class="bound">st</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">‚Üê</span> remap_polys_change_all <span class="bound">spec</span> <span class="main">{}</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
     <span class="keyword1">if</span> is_failed <span class="bound">st</span> <span class="keyword1">then</span>
     RETURN <span class="main">(</span><span class="bound">st</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">ùí±</span> <span class="main">‚Üê</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">ùí±'</span><span class="main">.</span> <span class="bound">ùí±</span> <span class="main">‚à™</span> vars <span class="free"><span class="bound"><span class="entity">spec0</span></span></span> <span class="main">‚äÜ</span> <span class="bound">ùí±'</span><span class="main">)</span><span class="main">;</span>
       PAC_checker <span class="bound">spec</span> <span class="main">(</span><span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="bound">st</span> <span class="free"><span class="bound"><span class="entity">pac</span></span></span>
    <span class="main">}</span>
<span class="main">}</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> restricted_ideal_to_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπrestricted_ideal_to<span class="hidden">‚á©</span><sub>I</sub> <span class="free">ùí±</span> <span class="free">I</span> <span class="main">‚äÜ</span> restricted_ideal_to<span class="hidden">‚á©</span><sub>I</sub> <span class="free">ùí±'</span> <span class="free">J</span> <span class="main">‚üπ</span>
  <span class="free">ùí∞</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span> <span class="main">‚üπ</span>
   restricted_ideal_to<span class="hidden">‚á©</span><sub>I</sub> <span class="free">ùí∞</span> <span class="free">I</span> <span class="main">‚äÜ</span> restricted_ideal_to<span class="hidden">‚á©</span><sub>I</sub> <span class="free">ùí∞</span>  <span class="free">J</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restricted_ideal_to_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pac_ideal_idemp<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπpac_ideal <span class="main">(</span>pac_ideal <span class="free">A</span><span class="main">)</span> <span class="main">=</span> pac_ideal <span class="free">A</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.antisym ideal.span_subset_spanI ideal.span_superset le_sup_iff pac_ideal_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> full_checker_spec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">A'</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
      <span class="quoted"><span class="quoted">‚Äπfull_checker <span class="free">spec</span> <span class="free">A</span> <span class="free">pac</span> <span class="main">‚â§</span> <span class="main">‚áì</span><span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">st</span><span class="main">,</span> <span class="bound">G</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> <span class="bound">G'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">st</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span> <span class="main">‚àà</span> status_rel <span class="main">‚àß</span>
           <span class="main">(</span><span class="bound">st</span> <span class="main">‚â†</span> FAILED <span class="main">‚ü∂</span> <span class="main">(</span><span class="bound">G</span><span class="main">,</span> <span class="bound">G'</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel_full<span class="main">)</span><span class="main">}</span>
        <span class="main">(</span>PAC_checker_specification <span class="free">spec</span> <span class="main">(</span><span class="free">A'</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπset_mset <span class="skolem">b</span> <span class="main">‚äÜ</span> pac_ideal <span class="main">(</span>set_mset <span class="main">(</span>ran_m <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span>
       <span class="skolem">x</span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>set_mset <span class="skolem">b</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="skolem">x</span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>set_mset <span class="free">A'</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pac_ideal_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> polys_rel_def pac_ideal_idemp<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x</span> <span class="main">‚àà</span> <span class="main">{</span><span class="main">(</span><span class="bound">st</span><span class="main">,</span> <span class="bound">ùí±'</span><span class="main">,</span> <span class="bound">A'</span><span class="main">)</span><span class="main">.</span>
          <span class="main">(</span> <span class="main">¬¨</span> is_failed <span class="bound">st</span> <span class="main">‚ü∂</span> pac_ideal <span class="main">(</span>set_mset <span class="main">(</span>ran_m <span class="skolem">x2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              pac_ideal <span class="main">(</span>set_mset <span class="main">(</span>ran_m <span class="bound">A'</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àß</span>
              <span class="main">‚ãÉ</span> <span class="main">(</span>vars <span class="main">`</span> set_mset <span class="main">(</span>ran_m <span class="skolem">ABC</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="bound">ùí±'</span> <span class="main">‚àß</span>
              <span class="main">‚ãÉ</span> <span class="main">(</span>vars <span class="main">`</span> set_mset <span class="main">(</span>ran_m <span class="bound">A'</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="bound">ùí±'</span><span class="main">)</span> <span class="main">‚àß</span>
            <span class="main">(</span><span class="bound">st</span> <span class="main">=</span> FOUND <span class="main">‚ü∂</span> <span class="skolem">speca</span> <span class="main">‚àà#</span> ran_m <span class="bound">A'</span><span class="main">)</span><span class="main">}</span> <span class="main">‚üπ</span>
         <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="skolem">x'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ùí±</span><span class="main">,</span> <span class="skolem">Aa</span><span class="main">)</span> <span class="main">‚üπ</span><span class="main">(</span><span class="main">(</span><span class="skolem">ùí±'</span><span class="main">,</span> <span class="skolem">Aa</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ùí±'</span><span class="main">,</span> ran_m <span class="skolem">Aa</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel_full‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">Aa</span> <span class="skolem">speca</span> <span class="skolem">x2</span> <span class="skolem">st</span> <span class="skolem">x</span> <span class="skolem">ùí±'</span> <span class="skolem">ùí±</span> <span class="skolem">x'</span> <span class="skolem">ABC</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> polys_rel_def polys_rel_full_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> H1<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">a</span> <span class="bound">aa</span> <span class="bound">b</span> <span class="bound">xa</span> <span class="bound">x</span> <span class="bound">x1a</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">speca</span><span class="main">.</span>
       vars <span class="free">spec</span> <span class="main">‚äÜ</span> <span class="skolem">x1b</span> <span class="main">‚üπ</span>
       <span class="main">‚ãÉ</span> <span class="main">(</span>vars <span class="main">`</span> set_mset <span class="main">(</span>ran_m <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="skolem">x1b</span> <span class="main">‚üπ</span>
       <span class="main">‚ãÉ</span> <span class="main">(</span>vars <span class="main">`</span> set_mset <span class="main">(</span>ran_m <span class="skolem">x2a</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="skolem">x1b</span> <span class="main">‚üπ</span>
       restricted_ideal_to<span class="hidden">‚á©</span><sub>I</sub> <span class="skolem">x1b</span> <span class="bound">b</span> <span class="main">‚äÜ</span> restricted_ideal_to<span class="hidden">‚á©</span><sub>I</sub> <span class="skolem">x1b</span> <span class="main">(</span>ran_m <span class="skolem">x2a</span><span class="main">)</span> <span class="main">‚üπ</span>
       <span class="bound">xa</span> <span class="main">‚àà</span> restricted_ideal_to<span class="hidden">‚á©</span><sub>I</sub> <span class="main">(</span><span class="main">‚ãÉ</span> <span class="main">(</span>vars <span class="main">`</span> set_mset <span class="main">(</span>ran_m <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">‚à™</span> vars <span class="free">spec</span><span class="main">)</span> <span class="bound">b</span> <span class="main">‚üπ</span>
       <span class="bound">xa</span> <span class="main">‚àà</span> restricted_ideal_to<span class="hidden">‚á©</span><sub>I</sub> <span class="main">(</span><span class="main">‚ãÉ</span> <span class="main">(</span>vars <span class="main">`</span> set_mset <span class="main">(</span>ran_m <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">‚à™</span> vars <span class="free">spec</span><span class="main">)</span> <span class="main">(</span>ran_m <span class="skolem">x2a</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x1b</span> <span class="skolem">b</span> <span class="skolem">xa</span> <span class="skolem">x2a</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> restricted_ideal_to_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÉ</span> <span class="main">(</span>vars <span class="main">`</span> set_mset <span class="main">(</span>ran_m <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">‚à™</span> vars <span class="free">spec</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> H2<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">a</span> <span class="bound">aa</span> <span class="bound">b</span> <span class="bound">speca</span> <span class="bound">x2</span> <span class="bound">x1a</span> <span class="bound">x1b</span> <span class="bound">x2a</span><span class="main">.</span>
       <span class="free">spec</span> <span class="main">-</span> <span class="bound">speca</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
       vars <span class="free">spec</span> <span class="main">‚äÜ</span> <span class="bound">x1b</span> <span class="main">‚üπ</span>
       <span class="main">‚ãÉ</span> <span class="main">(</span>vars <span class="main">`</span> set_mset <span class="main">(</span>ran_m <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="bound">x1b</span> <span class="main">‚üπ</span>
       <span class="main">‚ãÉ</span> <span class="main">(</span>vars <span class="main">`</span> set_mset <span class="main">(</span>ran_m <span class="bound">x2a</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="bound">x1b</span> <span class="main">‚üπ</span>
       <span class="bound">speca</span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>set_mset <span class="main">(</span>ran_m <span class="bound">x2a</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span>
       restricted_ideal_to<span class="hidden">‚á©</span><sub>I</sub> <span class="bound">x1b</span> <span class="bound">b</span> <span class="main">‚äÜ</span> restricted_ideal_to<span class="hidden">‚á©</span><sub>I</sub> <span class="bound">x1b</span> <span class="main">(</span>ran_m <span class="bound">x2a</span><span class="main">)</span> <span class="main">‚üπ</span>
       <span class="free">spec</span> <span class="main">‚àà</span> pac_ideal <span class="main">(</span>set_mset <span class="main">(</span>ran_m <span class="bound">x2a</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> group_eq_aux ideal.span_add ideal.span_base in_mono
        pac_ideal_alt_def sup.cobounded2<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span><span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> full_checker_def normalize_poly_spec_def
      PAC_checker_specification_def remap_polys_change_all_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> PAC_checker_PAC_checker_specification2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">]</span></span>
      lhs_step_If<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_failed_def RETURN_RES_refine_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 1<span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> fmap_ext assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> polys_rel_def ran_m_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> speca x1 x2 x x1a x2a x1b
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ref_two_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> conc_fun_R_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PAC_checker_specification_spec_def conc_fun_RES polys_rel_def H1 H2
          polys_rel_full_def
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rtranclp_PAC_Format_subset_ideal <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_failed_is_success_completeD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> full_checker_spec'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>uncurry2 full_checker<span class="main">,</span> uncurry2 <span class="main">(</span><span class="main">Œª</span><span class="bound">spec</span> <span class="bound">A</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> PAC_checker_specification <span class="bound">spec</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span>
       <span class="main">(</span>Id <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> polys_rel<span class="main">)</span> <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> Id <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>f</sub></span> <span class="main">‚ü®</span><span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">st</span><span class="main">,</span> <span class="bound">G</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> <span class="bound">G'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">st</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span> <span class="main">‚àà</span> status_rel <span class="main">‚àß</span>
           <span class="main">(</span><span class="bound">st</span> <span class="main">‚â†</span> FAILED <span class="main">‚ü∂</span> <span class="main">(</span><span class="bound">G</span><span class="main">,</span> <span class="bound">G'</span><span class="main">)</span> <span class="main">‚àà</span> polys_rel_full<span class="main">)</span><span class="main">}</span><span class="main">‚ü©</span>nres_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> full_checker_spec
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> frefI nres_relI<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="PAC_Polynomials">
<div class="head">
<h1>Theory PAC_Polynomials</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> PAC_Polynomials
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="PAC_Specification.html">PAC_Specification</a> <a href="Finite_Map_Multiset.html">Finite_Map_Multiset</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚ÄπPolynomials of strings‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ

  Isabelle's definition of polynomials only work with variables of type
  <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπnat‚Ä∫</span></span></span></span>. Therefore, we introduce a version that uses strings by using an injective function
  that converts a string to a natural number. It exists because strings are countable. Remark that
  the whole development is independent of the function.

‚Ä∫</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπPolynomials and Variables‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> poly_embed_EX<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÉ</span><span class="bound">œÜ</span><span class="main">.</span> bij <span class="main">(</span><span class="bound">œÜ</span> <span class="main">::</span> string <span class="main">‚áí</span> nat<span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> countableE_infinite<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‚ÄπUNIV <span class="main"><span class="main"><span class="main">::</span></span></span> string set‚Ä∫</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> infinite_UNIV_listI<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπUsing a multiset instead of a list has some advantage from an abstract point of view. First,
  we can have monomials that appear several times  and the coefficient can also be zero. Basically,
  we can represent un-normalised polynomials, which is very useful to talk about intermediate states
  in our program.
‚Ä∫</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> term_poly <span class="main">=</span> <span class="quoted"><span class="quoted">‚Äπstring multiset‚Ä∫</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> mset_polynomial <span class="main">=</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>term_poly <span class="main">*</span> int<span class="main">)</span> multiset‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">normalized_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπmset_polynomial <span class="main">‚áí</span> bool‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">normalized_poly</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚ü∑</span>
     distinct_mset <span class="main">(</span>fst <span class="main">`#</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">‚àß</span>
     <span class="main">0</span> <span class="main">‚àâ#</span> snd <span class="main">`#</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> normalized_poly_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπnormalized_poly <span class="main">{#}</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπnormalized_poly <span class="main">(</span>add_mset <span class="free">t</span> <span class="free">p</span><span class="main">)</span> <span class="main">‚ü∑</span> snd <span class="free">t</span> <span class="main">‚â†</span> <span class="main">0</span> <span class="main">‚àß</span>
    fst <span class="free">t</span> <span class="main">‚àâ#</span> fst <span class="main">`#</span> <span class="free">p</span> <span class="main">‚àß</span> normalized_poly <span class="free">p</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> normalized_poly_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> normalized_poly_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπnormalized_poly <span class="free">B</span> <span class="main">‚üπ</span> <span class="free">A</span> <span class="main">‚äÜ#</span> <span class="free">B</span> <span class="main">‚üπ</span> normalized_poly <span class="free">A</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> normalized_poly_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> distinct_mset_mono image_mset_subseteq_mono<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mult_poly_by_monom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπterm_poly <span class="main">*</span> int <span class="main">‚áí</span> mset_polynomial <span class="main">‚áí</span> mset_polynomial‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">mult_poly_by_monom</span>  <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">ys</span> <span class="bound">q</span><span class="main">.</span> image_mset <span class="main">(</span><span class="main">Œª</span><span class="bound">xs</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">xs</span> <span class="main">+</span> fst <span class="bound">ys</span><span class="main">,</span> snd <span class="bound">ys</span> <span class="main">*</span> snd <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mult_poly_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπmset_polynomial <span class="main">‚áí</span> mset_polynomial <span class="main">‚áí</span> mset_polynomial‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">mult_poly_raw</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span>
    <span class="main">(</span>sum_mset <span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="bound">y</span><span class="main">.</span> mult_poly_by_monom <span class="bound">y</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">`#</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">remove_powers</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπmset_polynomial <span class="main">‚áí</span> mset_polynomial‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">remove_powers</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span>  image_mset <span class="main">(</span>apfst remdups_mset<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_vars_mset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπmset_polynomial <span class="main">‚áí</span> string multiset‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">all_vars_mset</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">‚àë<span class="hidden">‚á©</span><sub>#</sub></span> <span class="main">(</span>fst <span class="main">`#</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">all_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπmset_polynomial <span class="main">‚áí</span> string set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">all_vars</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚â°</span> set_mset <span class="main">(</span>all_vars_mset <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">add_to_coefficient</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">‚áí</span> mset_polynomial <span class="main">‚áí</span> mset_polynomial‚Ä∫</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">add_to_coefficient</span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="bound">b</span><span class="main">.</span> <span class="main">{#</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚àà#</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a'</span> <span class="main">‚â†</span> <span class="bound">a</span><span class="main">#}</span> <span class="main">+</span>
             <span class="main">(</span><span class="keyword1">if</span> <span class="bound">n</span> <span class="main">+</span> sum_mset <span class="main">(</span>snd <span class="main">`#</span> <span class="main">{#</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚àà#</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a'</span> <span class="main">=</span> <span class="bound">a</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">{#}</span>
               <span class="keyword1">else</span> <span class="main">{#</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">n</span> <span class="main">+</span> sum_mset <span class="main">(</span>snd <span class="main">`#</span> <span class="main">{#</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚àà#</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a'</span> <span class="main">=</span> <span class="bound">a</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">normalize_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπmset_polynomial <span class="main">‚áí</span> mset_polynomial‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">normalize_poly</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> fold_mset add_to_coefficient <span class="main">{#}</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_to_coefficient_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">n</span> <span class="main">+</span> sum_mset <span class="main">(</span>snd <span class="main">`#</span> <span class="main">{#</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚àà#</span> <span class="free">b</span><span class="main">.</span> <span class="bound">a'</span> <span class="main">=</span> <span class="free">a</span><span class="main">#}</span><span class="main">)</span> <span class="main">‚â†</span> <span class="main">0</span> <span class="main">‚üπ</span>
    add_to_coefficient <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">b</span> <span class="main">=</span> <span class="main">{#</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚àà#</span> <span class="free">b</span><span class="main">.</span> <span class="bound">a'</span> <span class="main">‚â†</span> <span class="free">a</span><span class="main">#}</span> <span class="main">+</span>
             <span class="main">{#</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">n</span> <span class="main">+</span> sum_mset <span class="main">(</span>snd <span class="main">`#</span> <span class="main">{#</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚àà#</span> <span class="free">b</span><span class="main">.</span> <span class="bound">a'</span> <span class="main">=</span> <span class="free">a</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">n</span> <span class="main">+</span> sum_mset <span class="main">(</span>snd <span class="main">`#</span> <span class="main">{#</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚àà#</span> <span class="free">b</span><span class="main">.</span> <span class="bound">a'</span> <span class="main">=</span> <span class="free">a</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">‚üπ</span>
    add_to_coefficient <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">b</span> <span class="main">=</span> <span class="main">{#</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚àà#</span> <span class="free">b</span><span class="main">.</span> <span class="bound">a'</span> <span class="main">‚â†</span> <span class="free">a</span><span class="main">#}</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  add_to_coefficient_simps_If<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπadd_to_coefficient <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">b</span> <span class="main">=</span> <span class="main">{#</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚àà#</span> <span class="free">b</span><span class="main">.</span> <span class="bound">a'</span> <span class="main">‚â†</span> <span class="free">a</span><span class="main">#}</span> <span class="main">+</span>
             <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">+</span> sum_mset <span class="main">(</span>snd <span class="main">`#</span> <span class="main">{#</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚àà#</span> <span class="free">b</span><span class="main">.</span> <span class="bound">a'</span> <span class="main">=</span> <span class="free">a</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">{#}</span>
               <span class="keyword1">else</span> <span class="main">{#</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">n</span> <span class="main">+</span> sum_mset <span class="main">(</span>snd <span class="main">`#</span> <span class="main">{#</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚àà#</span> <span class="free">b</span><span class="main">.</span> <span class="bound">a'</span> <span class="main">=</span> <span class="free">a</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_to_coefficient_def<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> comp_fun_commute <span class="quoted"><span class="quoted">‚Äπadd_to_coefficient‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">a</span> <span class="main">‚â†</span> <span class="skolem">aa</span> <span class="main">‚üπ</span>
    <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span> <span class="skolem">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚áí</span> <span class="bound">a'</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚áí</span> <span class="bound">a'</span> <span class="main">‚â†</span> <span class="skolem">aa</span><span class="main">)</span><span class="main">)</span> <span class="main">‚ü∑</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚áí</span> <span class="bound">a'</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a'</span> <span class="skolem">aa</span> <span class="skolem">a</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπcomp_fun_commute add_to_coefficient‚Ä∫</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> add_to_coefficient_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filter_filter_mset <span class="dynamic"><span class="dynamic">ac_simps</span></span> add_eq_0_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> normalized_poly_normalize_poly<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπnormalized_poly <span class="main">(</span>normalize_poly <span class="free">p</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> normalize_poly_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x p
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_to_coefficient_simps_If
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> normalized_poly_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπAddition‚Ä∫</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">add_poly_p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπmset_polynomial <span class="main">√ó</span> mset_polynomial <span class="main">√ó</span> mset_polynomial <span class="main">‚áí</span> mset_polynomial <span class="main">√ó</span> mset_polynomial <span class="main">√ó</span> mset_polynomial <span class="main">‚áí</span> bool‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
add_new_coeff_r<span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">add_poly_p</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> add_mset <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> add_mset <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>‚Ä∫</span></span> <span class="main">|</span>
add_new_coeff_l<span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">add_poly_p</span> <span class="main">(</span>add_mset <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> add_mset <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>‚Ä∫</span></span> <span class="main">|</span>
add_same_coeff_l<span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">add_poly_p</span> <span class="main">(</span>add_mset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> add_mset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> add_mset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>‚Ä∫</span></span> <span class="main">|</span>
add_same_coeff_r<span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">add_poly_p</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> add_mset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> add_mset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> add_mset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>‚Ä∫</span></span> <span class="main">|</span>
rem_0_coeff<span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">add_poly_p</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> add_mset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> add_poly_pE<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπadd_poly_p <span class="free">S</span> <span class="free">T</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> add_poly_p_induct <span class="main">=</span>
  add_poly_p.induct<span class="main">[</span><span class="operator">split_format</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">complete</span><span class="main"><span class="main">)</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> add_poly_p_empty_l<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπadd_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="free">q</span><span class="main">,</span> <span class="free">p</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add_new_coeff_l r_into_rtranclp
      rtranclp_trans union_mset_add_mset_left union_mset_add_mset_right<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_poly_p_empty_r<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπadd_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="main">{#}</span><span class="main">,</span> <span class="free">q</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add_new_coeff_r r_into_rtranclp
      rtranclp_trans union_mset_add_mset_left union_mset_add_mset_right<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_poly_p_sym<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπadd_poly_p <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">p'</span><span class="main">,</span> <span class="free">q'</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span> <span class="main">‚ü∑</span> add_poly_p <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">p'</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> add_poly_p.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_poly_p.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> add_poly_p.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_poly_p.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_if_measure_in_wf<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπwf <span class="free">R</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="main">‚ãÄ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">S</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">ŒΩ</span> <span class="bound">a</span><span class="main">,</span> <span class="free">ŒΩ</span> <span class="bound">b</span><span class="main">)</span><span class="main">‚àà</span><span class="free">R</span><span class="main">)</span> <span class="main">‚üπ</span> wf <span class="free">S</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_inv_image wfE_min wfI_min wf_inv_image<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lexn_n<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">,</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">‚àà</span> lexn <span class="free">r</span> <span class="free">n</span> <span class="main">‚ü∑</span>
  <span class="main">(</span>length <span class="free">xs</span> <span class="main">=</span> <span class="free">n</span><span class="main">-</span><span class="main">1</span> <span class="main">‚àß</span> length <span class="free">ys</span> <span class="main">=</span> <span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">r</span> <span class="main">‚à®</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">‚àà</span> lexn <span class="free">r</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_prod_def image_iff lex_prod_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_add_poly_p<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπwf <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> add_poly_p <span class="bound">y</span> <span class="bound">x</span><span class="main">}</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_if_measure_in_wf<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‚Äπlexn less_than <span class="numeral"><span class="numeral"><span class="numeral">3</span></span></span>‚Ä∫</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span>
     ŒΩ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main"><span class="main">Œª</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="bound"><span class="bound"><span class="bound">a</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span><span class="bound"><span class="bound"><span class="bound">b</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span><span class="bound"><span class="bound"><span class="bound">c</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">[</span></span></span>size <span class="bound"><span class="bound"><span class="bound">a</span></span></span> <span class="main"><span class="main"><span class="main">,</span></span></span> size <span class="bound"><span class="bound"><span class="bound">b</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> size <span class="bound"><span class="bound"><span class="bound">c</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>‚Ä∫</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_poly_p.simps wf_lexn
     <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lexn_n <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> lexn.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_poly_by_monom_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπmult_poly_by_monom <span class="free">t</span> <span class="main">{#}</span> <span class="main">=</span> <span class="main">{#}</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπmult_poly_by_monom <span class="free">t</span> <span class="main">(</span><span class="free">ps</span> <span class="main">+</span> <span class="free">qs</span><span class="main">)</span> <span class="main">=</span>  mult_poly_by_monom <span class="free">t</span> <span class="free">ps</span> <span class="main">+</span> mult_poly_by_monom <span class="free">t</span> <span class="free">qs</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπmult_poly_by_monom <span class="free">a</span> <span class="main">(</span>add_mset <span class="free">p</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> add_mset <span class="main">(</span>fst <span class="free">a</span> <span class="main">+</span> fst <span class="free">p</span><span class="main">,</span> snd <span class="free">a</span> <span class="main">*</span> snd <span class="free">p</span><span class="main">)</span> <span class="main">(</span>mult_poly_by_monom <span class="free">a</span> <span class="free">ps</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> comp_fun_commute <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">Œª</span><span class="bound">xs</span><span class="main">.</span> add_mset <span class="main">(</span><span class="bound">xs</span> <span class="main">+</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">‚Äπmult_poly_by_monom <span class="skolem">t</span> <span class="main">(</span><span class="free">ps</span> <span class="main">+</span> <span class="free">qs</span><span class="main">)</span> <span class="main">=</span>  mult_poly_by_monom <span class="skolem">t</span> <span class="free">ps</span> <span class="main">+</span> mult_poly_by_monom <span class="skolem">t</span> <span class="free">qs</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult_poly_by_monom_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">‚Äπmult_poly_by_monom <span class="free">a</span> <span class="main">(</span>add_mset <span class="free">p</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> add_mset <span class="main">(</span>fst <span class="free">a</span> <span class="main">+</span> fst <span class="free">p</span><span class="main">,</span> snd <span class="free">a</span> <span class="main">*</span> snd <span class="free">p</span><span class="main">)</span> <span class="main">(</span>mult_poly_by_monom <span class="free">a</span> <span class="free">ps</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπmult_poly_by_monom <span class="skolem">t</span> <span class="main">{#}</span> <span class="main">=</span> <span class="main">{#}</span>‚Ä∫</span></span><span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult_poly_by_monom_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">mult_poly_p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπmset_polynomial <span class="main">‚áí</span> mset_polynomial <span class="main">√ó</span> mset_polynomial <span class="main">‚áí</span> mset_polynomial <span class="main">√ó</span> mset_polynomial <span class="main">‚áí</span> bool‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">q</span> <span class="main">::</span> <span class="quoted">mset_polynomial</span> <span class="keyword2"><span class="keyword">where</span></span>
mult_step<span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">mult_poly_p</span> <span class="free">q</span> <span class="main">(</span>add_mset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>remdups_mset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">+</span> <span class="bound">ys</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">*</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">`#</span> <span class="free">q</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">lemmas</span></span> mult_poly_p_induct <span class="main">=</span> mult_poly_p.induct<span class="main">[</span><span class="operator">split_format</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">complete</span><span class="main"><span class="main">)</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπNormalisation‚Ä∫</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">normalize_poly_p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπmset_polynomial <span class="main">‚áí</span> mset_polynomial <span class="main">‚áí</span> bool‚Ä∫</span></span><span class="keyword2"><span class="keyword">where</span></span>
rem_0_coeff<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">normalize_poly_p</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">‚üπ</span> <span class="free">normalize_poly_p</span> <span class="main">(</span>add_mset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>‚Ä∫</span></span> <span class="main">|</span>
merge_dup_coeff<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">normalize_poly_p</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">‚üπ</span> <span class="free">normalize_poly_p</span> <span class="main">(</span>add_mset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>add_mset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>add_mset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>‚Ä∫</span></span> <span class="main">|</span>
same<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">normalize_poly_p</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>‚Ä∫</span></span> <span class="main">|</span>
keep_coeff<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">normalize_poly_p</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">‚üπ</span> <span class="free">normalize_poly_p</span> <span class="main">(</span>add_mset <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>add_mset <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπCorrectness‚Ä∫</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ
  This locales maps string polynomials to real polynomials.
‚Ä∫</span></span>
<span class="keyword1"><span class="command">locale</span></span> poly_embed <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">œÜ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπstring <span class="main">‚áí</span> nat‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> œÜ_inj<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπinj <span class="free">œÜ</span>‚Ä∫</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">poly_of_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term_poly <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>comm_semiring_1<span class="main">}</span><span class="main">)</span> mpoly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">poly_of_vars</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> fold_mset <span class="main">(</span><span class="main">Œª</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> Var <span class="main">(</span><span class="free">œÜ</span> <span class="bound">a</span><span class="main">)</span> <span class="main">*</span> <span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> <span class="tfree">'a</span> mpoly<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> poly_of_vars_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‚Äπpoly_of_vars <span class="main">(</span>add_mset <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> Var <span class="main">(</span><span class="free">œÜ</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>poly_of_vars <span class="free">xs</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>comm_semiring_1<span class="main">}</span><span class="main">)</span> mpoly<span class="main">)</span>‚Ä∫</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπpoly_of_vars <span class="main">(</span><span class="free">xs</span> <span class="main">+</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> poly_of_vars <span class="free">xs</span> <span class="main">*</span> <span class="main">(</span>poly_of_vars <span class="free">ys</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>comm_semiring_1<span class="main">}</span><span class="main">)</span> mpoly<span class="main">)</span>‚Ä∫</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> comp_fun_commute <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">Œª</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>comm_semiring_1<span class="main">}</span> mpoly<span class="main">)</span> <span class="main">*</span> Var <span class="main">(</span><span class="free">œÜ</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span>
         Var_def times_monomial_monomial <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_of_vars_def comp_fun_commute_axioms fold_mset_fusion
      <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_of_vars_def <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.comp_fun_commute_axioms local.fold_mset_fusion
      semiring_normalization_rules<span class="main"><span class="main">(</span></span>18<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mononom_of_vars</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">mononom_of_vars</span> <span class="main">‚â°</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="main">(+)</span> <span class="main">(</span>Const <span class="bound">n</span> <span class="main">*</span> poly_of_vars <span class="bound">xs</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> comp_fun_commute <span class="quoted"><span class="quoted">‚Äπmononom_of_vars‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> mononom_of_vars_def
       Var_def times_monomial_monomial <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπpoly_of_vars <span class="main">{#}</span> <span class="main">=</span> <span class="main">1</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_of_vars_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mononom_of_vars_add<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπNO_MATCH <span class="main">0</span> <span class="free">b</span> <span class="main">‚üπ</span> mononom_of_vars <span class="free">xs</span> <span class="free">b</span> <span class="main">=</span> Const <span class="main">(</span>snd <span class="free">xs</span><span class="main">)</span> <span class="main">*</span> poly_of_vars <span class="main">(</span>fst <span class="free">xs</span><span class="main">)</span> <span class="main">+</span> <span class="free">b</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> mononom_of_vars_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">polynomial_of_mset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπmset_polynomial <span class="main">‚áí</span> <span class="main">_</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">polynomial_of_mset</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> sum_mset <span class="main">(</span>mononom_of_vars <span class="main">`#</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">0</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> polynomial_of_mset_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπpolynomial_of_mset <span class="main">(</span><span class="free">xs</span> <span class="main">+</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> polynomial_of_mset <span class="free">xs</span> <span class="main">+</span> polynomial_of_mset <span class="free">ys</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> Const_def polynomial_of_mset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> polynomial_of_mset_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπpolynomial_of_mset <span class="main">(</span>add_mset <span class="free">x</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> Const <span class="main">(</span>snd <span class="free">x</span><span class="main">)</span> <span class="main">*</span> poly_of_vars <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">+</span> polynomial_of_mset <span class="free">ys</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> polynomial_of_mset_def mononom_of_vars_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> polynomial_of_mset_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπpolynomial_of_mset <span class="main">{#}</span> <span class="main">=</span> <span class="main">0</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> polynomial_of_mset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> polynomial_of_mset_mult_poly_by_monom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπpolynomial_of_mset <span class="main">(</span>mult_poly_by_monom <span class="free">x</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
       <span class="main">(</span>Const <span class="main">(</span>snd <span class="free">x</span><span class="main">)</span> <span class="main">*</span> poly_of_vars <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">*</span> polynomial_of_mset <span class="free">ys</span><span class="main">)</span>‚Ä∫</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Const_mult <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> polynomial_of_mset_mult_poly_raw<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπpolynomial_of_mset <span class="main">(</span>mult_poly_raw <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> polynomial_of_mset <span class="free">xs</span> <span class="main">*</span> polynomial_of_mset <span class="free">ys</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mult_poly_raw_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Const_mult <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> polynomial_of_mset_uminus<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπpolynomial_of_mset <span class="main">{#</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà#</span> <span class="free">za</span><span class="main">#}</span> <span class="main">=</span>
    <span class="main">-</span> polynomial_of_mset <span class="free">za</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">za</span></span><span class="main">)</span>
    <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> X2_X_polynomial_bool_mult_in<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπVar <span class="main">(</span><span class="free">x1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>Var <span class="main">(</span><span class="free">x1</span><span class="main">)</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">-</span>  Var <span class="main">(</span><span class="free">x1</span><span class="main">)</span> <span class="main">*</span> <span class="free">p</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> ideal_mult_right_in<span class="main">[</span><span class="operator">OF</span>  X2_X_in_pac_ideal<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">x1</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{}</span>‚Ä∫</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> pac_ideal_def<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> right_diff_distrib <span class="dynamic"><span class="dynamic">ac_simps</span></span> power2_eq_square<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> polynomial_of_list_remove_powers_polynomial_bool<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>polynomial_of_mset <span class="free">xs</span><span class="main">)</span> <span class="main">-</span> polynomial_of_mset <span class="main">(</span>remove_powers <span class="free">xs</span><span class="main">)</span> <span class="main">‚àà</span> ideal polynomial_bool‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?case</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> remove_powers_def ideal.span_zero<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> H1<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x1</span> <span class="main">‚àà#</span> <span class="skolem">x2</span> <span class="main">‚üπ</span>
       Var <span class="main">(</span><span class="free">œÜ</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">*</span> poly_of_vars <span class="skolem">x2</span> <span class="main">-</span> <span class="skolem">p</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚ü∑</span>
       poly_of_vars <span class="skolem">x2</span> <span class="main">-</span> <span class="skolem">p</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool
       ‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x1</span> <span class="skolem">x2</span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ideal.span_add_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span>
      <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">‚ÄπVar <span class="main"><span class="main">(</span></span><span class="free"><span class="free">œÜ</span></span> <span class="skolem"><span class="skolem">x1</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">*</span></span> poly_of_vars <span class="skolem"><span class="skolem">x2</span></span> <span class="main"><span class="main">-</span></span> poly_of_vars <span class="skolem"><span class="skolem">x2</span></span>‚Ä∫</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> multi_member_split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X2_X_polynomial_bool_mult_in<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> diff<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπpoly_of_vars <span class="main">(</span><span class="skolem">x</span><span class="main">)</span> <span class="main">-</span> poly_of_vars <span class="main">(</span>remdups_mset <span class="main">(</span><span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> ideal polynomial_bool‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> remove_powers_def ideal.span_zero H1
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> right_diff_distrib <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ideal.span_scale<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπpolynomial_of_mset <span class="skolem">xs</span> <span class="main">-</span>
    polynomial_of_mset <span class="main">(</span>apfst remdups_mset <span class="main">`#</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
    poly_of_vars <span class="skolem">ys</span> <span class="main">*</span> poly_of_vars <span class="skolem">ys</span> <span class="main">-</span>
    poly_of_vars <span class="skolem">ys</span> <span class="main">*</span> poly_of_vars <span class="main">(</span>remdups_mset <span class="skolem">ys</span><span class="main">)</span>
    <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚üπ</span>
    polynomial_of_mset <span class="skolem">xs</span> <span class="main">+</span> Const <span class="skolem">y</span> <span class="main">*</span> poly_of_vars <span class="skolem">ys</span> <span class="main">-</span>
    <span class="main">(</span>polynomial_of_mset <span class="main">(</span>apfst remdups_mset <span class="main">`#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span>
    Const <span class="skolem">y</span> <span class="main">*</span> poly_of_vars <span class="main">(</span>remdups_mset <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>
    <span class="main">‚àà</span> More_Modules.ideal polynomial_bool‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span> <span class="skolem">ys</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_add diff ideal.scale_right_diff_distrib ideal.span_add ideal.span_scale<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> add
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ys y
      <span class="keyword1"><span class="command">using</span></span> ideal_mult_right_in2<span class="main">[</span><span class="operator">OF</span> diff<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπpoly_of_vars <span class="skolem">ys</span>‚Ä∫</span></span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> remove_powers_def right_diff_distrib
        ideal.span_diff ideal.span_add <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_poly_p_polynomial_of_mset<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπadd_poly_p <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">p'</span><span class="main">,</span> <span class="free">q'</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span> <span class="main">‚üπ</span>
    polynomial_of_mset <span class="free">r</span> <span class="main">+</span> <span class="main">(</span>polynomial_of_mset <span class="free">p</span> <span class="main">+</span> polynomial_of_mset <span class="free">q</span><span class="main">)</span> <span class="main">=</span>
    polynomial_of_mset <span class="free">r'</span> <span class="main">+</span> <span class="main">(</span>polynomial_of_mset <span class="free">p'</span> <span class="main">+</span> polynomial_of_mset <span class="free">q'</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> add_poly_p_induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> Const_add<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> Const_add<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> Const_add<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> rtranclp_add_poly_p_polynomial_of_mset<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπadd_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">p'</span><span class="main">,</span> <span class="free">q'</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span> <span class="main">‚üπ</span>
    polynomial_of_mset <span class="free">r</span> <span class="main">+</span> <span class="main">(</span>polynomial_of_mset <span class="free">p</span> <span class="main">+</span> polynomial_of_mset <span class="free">q</span><span class="main">)</span> <span class="main">=</span>
    polynomial_of_mset <span class="free">r'</span> <span class="main">+</span> <span class="main">(</span>polynomial_of_mset <span class="free">p'</span> <span class="main">+</span> polynomial_of_mset <span class="free">q'</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">add_poly_p</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">_</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>‚Ä∫</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">_</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>‚Ä∫</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">split_format</span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="quasi_keyword"><span class="quasi_keyword">complete</span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> add_poly_p_polynomial_of_mset<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> rtranclp_add_poly_p_polynomial_of_mset_full<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπadd_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="main">{#}</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span> <span class="main">‚üπ</span>
    polynomial_of_mset <span class="free">r'</span> <span class="main">=</span> <span class="main">(</span>polynomial_of_mset <span class="free">p</span> <span class="main">+</span> polynomial_of_mset <span class="free">q</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> rtranclp_add_poly_p_polynomial_of_mset<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> add_eq_0_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> poly_of_vars_remdups_mset<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπpoly_of_vars <span class="main">(</span>remdups_mset <span class="main">(</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>poly_of_vars <span class="free">xs</span><span class="main">)</span>
    <span class="main">‚àà</span> More_Modules.ideal polynomial_bool‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ideal.span_zero<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x xs
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x</span> <span class="main">‚àà#</span> <span class="skolem">xs</span>‚Ä∫</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> X2_X_polynomial_bool_mult_in diff_add_cancel diff_diff_eq2
        ideal.span_diff insert_DiffM poly_of_vars_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> remdups_mset_singleton_sum<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> ideal.span_scale poly_of_vars_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> remdups_mset_singleton_sum
        right_diff_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> polynomial_of_mset_mult_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπpolynomial_of_mset
     <span class="main">{#</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span>remdups_mset <span class="main">(</span><span class="bound">ys</span> <span class="main">+</span> <span class="free">xs</span><span class="main">)</span><span class="main">,</span> <span class="bound">n</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà#</span> <span class="free">q</span><span class="main">#}</span> <span class="main">-</span>
    Const <span class="free">m</span> <span class="main">*</span> <span class="main">(</span>poly_of_vars <span class="free">xs</span> <span class="main">*</span> polynomial_of_mset <span class="free">q</span><span class="main">)</span>
    <span class="main">‚àà</span> More_Modules.ideal polynomial_bool‚Ä∫</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?P</span> <span class="free">q</span> <span class="main">‚àà</span> <span class="main">_</span>‚Ä∫</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> ideal.span_zero<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">x</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> uP<span class="main">:</span>  <span class="quoted"><span class="quoted">‚Äπ<span class="main">-</span><span class="var">?P</span> <span class="skolem">q</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> ideal.span_neg <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ Const <span class="skolem">b</span> <span class="main">*</span> <span class="main">(</span>Const <span class="free">m</span> <span class="main">*</span> poly_of_vars <span class="main">(</span>remdups_mset <span class="main">(</span><span class="skolem">a</span> <span class="main">+</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span>
           Const <span class="skolem">b</span> <span class="main">*</span> <span class="main">(</span>Const <span class="free">m</span> <span class="main">*</span> <span class="main">(</span>poly_of_vars <span class="skolem">a</span> <span class="main">*</span> poly_of_vars <span class="free">xs</span><span class="main">)</span><span class="main">)</span>
           <span class="main">‚àà</span> More_Modules.ideal polynomial_bool‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Const_mult <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> right_diff_distrib' poly_of_vars_simps
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ideal.span_scale poly_of_vars_remdups_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ideal.span_add_eq2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> uP<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> Const_mult  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span>
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ideal.span_scale poly_of_vars_remdups_mset<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mult_poly_p_mult_ideal<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπmult_poly_p <span class="free">q</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">p'</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span> <span class="main">‚üπ</span>
     <span class="main">(</span>polynomial_of_mset <span class="free">p'</span> <span class="main">*</span> polynomial_of_mset <span class="free">q</span> <span class="main">+</span> polynomial_of_mset <span class="free">r'</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>polynomial_of_mset <span class="free">p</span> <span class="main">*</span> polynomial_of_mset <span class="free">q</span> <span class="main">+</span> polynomial_of_mset <span class="free">r</span><span class="main">)</span>
       <span class="main">‚àà</span> ideal polynomial_bool‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mult_poly_p_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mult_step <span class="skolem">xs</span> <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> polynomial_of_mset_mult_map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rtranclp_mult_poly_p_mult_ideal<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>mult_poly_p <span class="free">q</span><span class="main">)</span><span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">p'</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span> <span class="main">‚üπ</span>
     <span class="main">(</span>polynomial_of_mset <span class="free">p'</span> <span class="main">*</span> polynomial_of_mset <span class="free">q</span> <span class="main">+</span> polynomial_of_mset <span class="free">r'</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>polynomial_of_mset <span class="free">p</span> <span class="main">*</span> polynomial_of_mset <span class="free">q</span> <span class="main">+</span> polynomial_of_mset <span class="free">r</span><span class="main">)</span>
       <span class="main">‚àà</span> ideal polynomial_bool‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p'</span></span> <span class="quoted"><span class="free">r'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">‚Äπmult_poly_p <span class="free"><span class="free">q</span></span>‚Ä∫</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">(</span></span><span class="free"><span class="free">p</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">r</span></span><span class="main"><span class="main">)</span></span>‚Ä∫</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">p'</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">q'</span></span><span class="main"><span class="main">)</span></span>‚Ä∫</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="skolem"><span class="skolem">q'</span></span><span class="main"><span class="main">,</span></span> <span class="operator">split_format</span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="quasi_keyword"><span class="quasi_keyword">complete</span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ideal.span_zero<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b aa ba
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> mult_poly_p_mult_ideal<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> ideal.span_add<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> group_add_class.diff_add_eq_diff_diff_swap
        add.inverse_distrib_swap <span class="dynamic"><span class="dynamic">ac_simps</span></span> add_diff_eq
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span>  diff_add_eq_diff_diff_swap<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> rtranclp_mult_poly_p_mult_ideal_final<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>mult_poly_p <span class="free">q</span><span class="main">)</span><span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">‚üπ</span>
    <span class="main">(</span>polynomial_of_mset <span class="free">r</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>polynomial_of_mset <span class="free">p</span> <span class="main">*</span> polynomial_of_mset <span class="free">q</span><span class="main">)</span>
       <span class="main">‚àà</span> ideal polynomial_bool‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> rtranclp_mult_poly_p_mult_ideal<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> normalize_poly_p_poly_of_mset<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπnormalize_poly_p <span class="free">p</span> <span class="free">q</span> <span class="main">‚üπ</span> polynomial_of_mset <span class="free">p</span> <span class="main">=</span> polynomial_of_mset <span class="free">q</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> normalize_poly_p.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Const_add <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> rtranclp_normalize_poly_p_poly_of_mset<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπnormalize_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="free">p</span> <span class="free">q</span> <span class="main">‚üπ</span> polynomial_of_mset <span class="free">p</span> <span class="main">=</span> polynomial_of_mset <span class="free">q</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> normalize_poly_p_poly_of_mset<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπIt would be nice to have the property in the other direction too, but this requires a deep
dive into the definitions of polynomials.‚Ä∫</span></span>
<span class="keyword1"><span class="command">locale</span></span> poly_embed_bij <span class="main">=</span> poly_embed <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">V</span> <span class="free">N</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> œÜ_bij<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπbij_betw <span class="free">œÜ</span> <span class="free">V</span> <span class="free">N</span>‚Ä∫</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">œÜ'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπnat <span class="main">‚áí</span> string‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">œÜ'</span> <span class="main">=</span> the_inv_into <span class="free">V</span> <span class="free">œÜ</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> œÜ'_œÜ<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">x</span> <span class="main">‚àà</span> <span class="free">V</span> <span class="main">‚üπ</span> œÜ' <span class="main">(</span><span class="free">œÜ</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> œÜ_bij <span class="keyword1"><span class="command">unfolding</span></span> œÜ'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bij_betw_imp_inj_on the_inv_into_f_f<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> œÜ_œÜ'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">x</span> <span class="main">‚àà</span> <span class="free">N</span> <span class="main">‚üπ</span> <span class="free">œÜ</span> <span class="main">(</span>œÜ' <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> œÜ_bij <span class="keyword1"><span class="command">unfolding</span></span> œÜ'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> f_the_inv_into_f_bij_betw<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="PAC_Polynomials_Term">
<div class="head">
<h1>Theory PAC_Polynomials_Term</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:         PAC_Polynomials_Term.thy
  Author:       Mathias Fleury, Daniela Kaufmann, JKU
  Maintainer:   Mathias Fleury, JKU
*)</span>
<span class="keyword1"><span class="command">theory</span></span> PAC_Polynomials_Term
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="PAC_Polynomials.html">PAC_Polynomials</a>
    <a href="../Refine_Imperative_HOL/IICF.html">Refine_Imperative_HOL.IICF</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚ÄπTerms‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπWe define some helper functions.‚Ä∫</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπOrdering‚Ä∫</span></span>

<span class="comment1">(*Taken from WB_More_Refinement*)</span>
<span class="keyword1"><span class="command">lemma</span></span> fref_to_Down_curry_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'c</span> nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">√ó</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">√ó</span> <span class="tfree">'d</span><span class="main">)</span> set‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>uncurry <span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">[</span><span class="free">P</span><span class="keyword1">]<span class="hidden">‚á©</span><sub>f</sub></span> <span class="free">A</span> <span class="main">‚Üí</span> <span class="main">‚ü®</span><span class="free">B</span><span class="main">‚ü©</span>nres_rel <span class="main">‚üπ</span>
      <span class="main">(</span><span class="main">‚ãÄ</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">x'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x'</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">,</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">A</span> <span class="main">‚üπ</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="free">B</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fref_def uncurry_def nres_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fref_to_Down_curry_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'c</span> nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="tfree">'d</span> <span class="main">‚áí</span> <span class="main">_</span> nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'d</span> <span class="main">√ó</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">√ó</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span> set‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">f</span><span class="main">,</span> uncurry <span class="free">g</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">[</span><span class="free">P</span><span class="keyword1">]<span class="hidden">‚á©</span><sub>f</sub></span> <span class="free">A</span> <span class="main">‚Üí</span> <span class="main">‚ü®</span><span class="free">B</span><span class="main">‚ü©</span>nres_rel <span class="main">‚üπ</span>
      <span class="main">(</span><span class="main">‚ãÄ</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">x'</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">A</span> <span class="main">‚üπ</span> <span class="free">f</span> <span class="bound">x'</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="free">B</span> <span class="main">(</span><span class="free">g</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fref_def uncurry_def nres_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">type_synonym</span></span> term_poly_list <span class="main">=</span> <span class="quoted"><span class="quoted">‚Äπstring list‚Ä∫</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> llist_polynomial <span class="main">=</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>term_poly_list <span class="main">√ó</span> int<span class="main">)</span> list‚Ä∫</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπWe instantiate the characters with typeclass linorder to be able to talk abourt sorted and
  so on.‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">less_eq_char</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπchar <span class="main">‚áí</span> char <span class="main">‚áí</span> bool‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">less_eq_char</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>of_char <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">‚â§</span> of_char <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">less_char</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπchar <span class="main">‚áí</span> char <span class="main">‚áí</span> bool‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">less_char</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>of_char <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">&lt;</span> of_char <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> char<span class="main">:</span> linorder <span class="quoted">less_eq_char</span> <span class="quoted">less_char</span>
  <span class="keyword1"><span class="command">using</span></span> linorder_char
  <span class="keyword1"><span class="command">unfolding</span></span> linorder_class_def class.linorder_def
    less_eq_char_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> less_char_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    class.order_def order_class_def
    class.preorder_def preorder_class_def
    ord_class_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">less_than_char</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>char <span class="main">√ó</span> char<span class="main">)</span> set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">less_than_char</span> <span class="main">‚â°</span> p2rel less_char‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> less_than_char_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">‚àà</span> less_than_char <span class="main">‚ü∑</span> less_char <span class="free">x</span> <span class="free">y</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p2rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trans_less_than_char<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπtrans less_than_char‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  irrefl_less_than_char<span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπirrefl less_than_char‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  antisym_less_than_char<span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπantisym less_than_char‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_than_char_def trans_def irrefl_def antisym_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπPolynomials‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">var_order_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>string <span class="main">√ó</span> string<span class="main">)</span> set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">var_order_rel</span> <span class="main">‚â°</span> lexord less_than_char‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">var_order</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπstring <span class="main">‚áí</span> string <span class="main">‚áí</span> bool‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">var_order</span> <span class="main">‚â°</span> rel2p var_order_rel‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">term_order_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>term_poly_list <span class="main">√ó</span> term_poly_list<span class="main">)</span> set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">term_order_rel</span> <span class="main">‚â°</span> lexord var_order_rel‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">term_order</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπterm_poly_list <span class="main">‚áí</span> term_poly_list <span class="main">‚áí</span> bool‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">term_order</span> <span class="main">‚â°</span> rel2p term_order_rel‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">term_poly_list_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>term_poly_list <span class="main">√ó</span> term_poly<span class="main">)</span> set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">term_poly_list_rel</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span><span class="main">.</span>
     <span class="bound">ys</span> <span class="main">=</span> mset <span class="bound">xs</span> <span class="main">‚àß</span>
     distinct <span class="bound">xs</span> <span class="main">‚àß</span>
     sorted_wrt <span class="main">(</span>rel2p var_order_rel<span class="main">)</span> <span class="bound">xs</span><span class="main">}</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">unsorted_term_poly_list_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>term_poly_list <span class="main">√ó</span> term_poly<span class="main">)</span> set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">unsorted_term_poly_list_rel</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span><span class="main">.</span>
     <span class="bound">ys</span> <span class="main">=</span> mset <span class="bound">xs</span> <span class="main">‚àß</span> distinct <span class="bound">xs</span><span class="main">}</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">poly_list_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">√ó</span> int<span class="main">)</span> list <span class="main">√ó</span> mset_polynomial<span class="main">)</span> set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">poly_list_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span><span class="main">.</span>
     <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel <span class="keyword1">O</span> list_mset_rel <span class="main">‚àß</span>
     <span class="main">0</span> <span class="main">‚àâ#</span> snd <span class="main">`#</span> <span class="bound">ys</span><span class="main">}</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sorted_poly_list_rel_wrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'a</span> <span class="main">‚áí</span> bool<span class="main">)</span>
     <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">√ó</span> string multiset<span class="main">)</span> set <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">√ó</span> int<span class="main">)</span> list <span class="main">√ó</span> mset_polynomial<span class="main">)</span> set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">sorted_poly_list_rel_wrt</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span><span class="main">.</span>
     <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel <span class="keyword1">O</span> list_mset_rel <span class="main">‚àß</span>
     sorted_wrt <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span>map fst <span class="bound">xs</span><span class="main">)</span> <span class="main">‚àß</span>
     distinct <span class="main">(</span>map fst <span class="bound">xs</span><span class="main">)</span> <span class="main">‚àß</span>
     <span class="main">0</span> <span class="main">‚àâ#</span> snd <span class="main">`#</span> <span class="bound">ys</span><span class="main">}</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sorted_poly_list_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">sorted_poly_list_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">‚â°</span> sorted_poly_list_rel_wrt <span class="free"><span class="bound"><span class="entity">R</span></span></span> term_poly_list_rel‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sorted_poly_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">sorted_poly_rel</span> <span class="main">‚â°</span> sorted_poly_list_rel term_order‚Ä∫</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sorted_repeat_poly_list_rel_wrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'a</span> <span class="main">‚áí</span> bool<span class="main">)</span>
     <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">√ó</span> string multiset<span class="main">)</span> set <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">√ó</span> int<span class="main">)</span> list <span class="main">√ó</span> mset_polynomial<span class="main">)</span> set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">sorted_repeat_poly_list_rel_wrt</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span><span class="main">.</span>
     <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel <span class="keyword1">O</span> list_mset_rel <span class="main">‚àß</span>
     sorted_wrt <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span>map fst <span class="bound">xs</span><span class="main">)</span> <span class="main">‚àß</span>
     <span class="main">0</span> <span class="main">‚àâ#</span> snd <span class="main">`#</span> <span class="bound">ys</span><span class="main">}</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sorted_repeat_poly_list_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">sorted_repeat_poly_list_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">‚â°</span> sorted_repeat_poly_list_rel_wrt <span class="free"><span class="bound"><span class="entity">R</span></span></span> term_poly_list_rel‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sorted_repeat_poly_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">sorted_repeat_poly_rel</span> <span class="main">‚â°</span> sorted_repeat_poly_list_rel <span class="main">(</span>rel2p <span class="main">(</span>Id <span class="main">‚à™</span> lexord var_order_rel<span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">unsorted_poly_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">unsorted_poly_rel</span> <span class="main">‚â°</span> poly_list_rel term_poly_list_rel‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_poly_list_rel_empty_l<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_list_rel_wrt <span class="free">S</span> <span class="free">T</span> <span class="main">‚ü∑</span> <span class="free">s'</span> <span class="main">=</span> <span class="main">{#}</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s'</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_wrt_def list_mset_rel_def br_def<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fully_unsorted_poly_list_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">√ó</span> int<span class="main">)</span> list <span class="main">√ó</span> mset_polynomial<span class="main">)</span> set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">fully_unsorted_poly_list_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span><span class="main">.</span>
     <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel <span class="keyword1">O</span> list_mset_rel<span class="main">}</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fully_unsorted_poly_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">fully_unsorted_poly_rel</span> <span class="main">‚â°</span> fully_unsorted_poly_list_rel unsorted_term_poly_list_rel‚Ä∫</span></span>


<span class="keyword1"><span class="command">lemma</span></span> fully_unsorted_poly_list_rel_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">‚àà</span> fully_unsorted_poly_list_rel <span class="free">R</span> <span class="main">‚ü∑</span> <span class="free">p</span> <span class="main">=</span> <span class="main">[]</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> fully_unsorted_poly_list_rel <span class="free">R</span> <span class="main">‚ü∑</span> <span class="free">p'</span> <span class="main">=</span> <span class="main">{#}</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fully_unsorted_poly_list_rel_def list_mset_rel_def br_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">poly_list_rel_with0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">√ó</span> int<span class="main">)</span> list <span class="main">√ó</span> mset_polynomial<span class="main">)</span> set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">poly_list_rel_with0</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span><span class="main">.</span>
     <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel <span class="keyword1">O</span> list_mset_rel<span class="main">}</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">unsorted_poly_rel_with0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">unsorted_poly_rel_with0</span> <span class="main">‚â°</span> fully_unsorted_poly_list_rel term_poly_list_rel‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> poly_list_rel_with0_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">‚àà</span> poly_list_rel_with0 <span class="free">R</span> <span class="main">‚ü∑</span> <span class="free">p</span> <span class="main">=</span> <span class="main">[]</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> poly_list_rel_with0 <span class="free">R</span> <span class="main">‚ü∑</span> <span class="free">p'</span> <span class="main">=</span> <span class="main">{#}</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_list_rel_with0_def list_mset_rel_def br_def<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sorted_repeat_poly_list_rel_with0_wrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'a</span> <span class="main">‚áí</span> bool<span class="main">)</span>
     <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">√ó</span> string multiset<span class="main">)</span> set <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">√ó</span> int<span class="main">)</span> list <span class="main">√ó</span> mset_polynomial<span class="main">)</span> set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">sorted_repeat_poly_list_rel_with0_wrt</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span><span class="main">.</span>
     <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel <span class="keyword1">O</span> list_mset_rel <span class="main">‚àß</span>
     sorted_wrt <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span>map fst <span class="bound">xs</span><span class="main">)</span><span class="main">}</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sorted_repeat_poly_list_rel_with0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">sorted_repeat_poly_list_rel_with0</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">‚â°</span> sorted_repeat_poly_list_rel_with0_wrt <span class="free"><span class="bound"><span class="entity">R</span></span></span> term_poly_list_rel‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sorted_repeat_poly_rel_with0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">sorted_repeat_poly_rel_with0</span> <span class="main">‚â°</span> sorted_repeat_poly_list_rel_with0 <span class="main">(</span>rel2p <span class="main">(</span>Id <span class="main">‚à™</span> lexord var_order_rel<span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> term_poly_list_relD<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel <span class="main">‚üπ</span> distinct <span class="free">xs</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel <span class="main">‚üπ</span> <span class="free">ys</span> <span class="main">=</span> mset <span class="free">xs</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel <span class="main">‚üπ</span> sorted_wrt <span class="main">(</span>rel2p var_order_rel<span class="main">)</span> <span class="free">xs</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel <span class="main">‚üπ</span> sorted_wrt <span class="main">(</span>rel2p <span class="main">(</span>Id <span class="main">‚à™</span> var_order_rel<span class="main">)</span><span class="main">)</span> <span class="free">xs</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> CollectD UnI2 rel2p_def sorted_wrt_mono_rel split_conv
    term_poly_list_rel_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="PAC_Polynomials_Operations">
<div class="head">
<h1>Theory PAC_Polynomials_Operations</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> PAC_Polynomials_Operations
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="PAC_Polynomials_Term.html">PAC_Polynomials_Term</a> <a href="PAC_Checker_Specification.html">PAC_Checker_Specification</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπAddition‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπIn this section, we refine the polynomials to list. These lists will be used in our checker
to represent the polynomials and execute operations.

There is one <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">‚àó</span></span>‚Äπkey‚Ä∫</span></span> difference between the list representation and the usual representation: in the
former, coefficients can be zero and monomials can appear several times. This makes it easier to
reason on intermediate representation where this has not yet been sanitized.
‚Ä∫</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">add_poly_l'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπllist_polynomial <span class="main">√ó</span> llist_polynomial <span class="main">‚áí</span> llist_polynomial‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">add_poly_l'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">add_poly_l'</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">add_poly_l'</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">add_poly_l'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="keyword1">else</span>
                 <span class="keyword1">let</span> <span class="bound">pq</span> <span class="main">=</span> <span class="free">add_poly_l'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
                 <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="bound">pq</span><span class="main">)</span>
            <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">‚àà</span> term_order_rel
              <span class="keyword1">then</span>
                 <span class="keyword1">let</span> <span class="bound">pq</span> <span class="main">=</span> <span class="free">add_poly_l'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
                 <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="bound">pq</span><span class="main">)</span>
            <span class="keyword1">else</span>
                 <span class="keyword1">let</span> <span class="bound">pq</span> <span class="main">=</span> <span class="free">add_poly_l'</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
                 <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="bound">pq</span><span class="main">)</span>
            <span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">add_poly_l</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπllist_polynomial <span class="main">√ó</span> llist_polynomial <span class="main">‚áí</span> llist_polynomial nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">add_poly_l</span> <span class="main">=</span> <span class="keyword1">REC<span class="hidden">‚á©</span><sub>T</sub></span>
      <span class="main">(</span><span class="main">Œª</span><span class="bound">add_poly_l</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span>
        <span class="keyword1">case</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">q</span><span class="main">)</span> <span class="keyword1">of</span>
          <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">‚áí</span> RETURN <span class="bound">p</span>
        <span class="main">|</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span> <span class="main">‚áí</span> RETURN <span class="bound">q</span>
        <span class="main">|</span> <span class="main">(</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">,</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">#</span> <span class="bound">q</span><span class="main">)</span> <span class="main">‚áí</span>
            <span class="main">(</span><span class="keyword1">if</span> <span class="bound">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">+</span> <span class="bound">m</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="bound">add_poly_l</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span> <span class="keyword1">else</span>
               <span class="keyword1">do</span> <span class="main">{</span>
                 <span class="bound">pq</span> <span class="main">‚Üê</span> <span class="bound">add_poly_l</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">;</span>
                 RETURN <span class="main">(</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">n</span> <span class="main">+</span> <span class="bound">m</span><span class="main">)</span> <span class="main">#</span> <span class="bound">pq</span><span class="main">)</span>
             <span class="main">}</span>
            <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">‚àà</span> term_order_rel
              <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                 <span class="bound">pq</span> <span class="main">‚Üê</span> <span class="bound">add_poly_l</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">#</span> <span class="bound">q</span><span class="main">)</span><span class="main">;</span>
                 RETURN <span class="main">(</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">#</span> <span class="bound">pq</span><span class="main">)</span>
            <span class="main">}</span>
            <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                 <span class="bound">pq</span> <span class="main">‚Üê</span> <span class="bound">add_poly_l</span> <span class="main">(</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">;</span>
                 RETURN <span class="main">(</span><span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">#</span> <span class="bound">pq</span><span class="main">)</span>
            <span class="main">}</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nonzero_coeffs</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">nonzero_coeffs</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">‚ü∑</span> <span class="main">0</span> <span class="main">‚àâ#</span> snd <span class="main">`#</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonzero_coeffs_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπnonzero_coeffs <span class="main">{#}</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπnonzero_coeffs <span class="main">(</span>add_mset <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">‚ü∑</span> nonzero_coeffs <span class="free">a</span> <span class="main">‚àß</span> <span class="free">n</span> <span class="main">‚â†</span> <span class="main">0</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonzero_coeffs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nonzero_coeffsD<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπnonzero_coeffs <span class="free">a</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">‚àà#</span> <span class="free">a</span> <span class="main">‚üπ</span> <span class="free">n</span> <span class="main">‚â†</span> <span class="main">0</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonzero_coeffs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_poly_list_rel_ConsD<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_list_rel <span class="free">S</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> remove1_mset <span class="main">(</span>mset <span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_list_rel <span class="free">S</span> <span class="main">‚àß</span>
    <span class="main">(</span>mset <span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">‚àà#</span> <span class="free">a</span> <span class="main">‚àß</span> <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">x</span> <span class="main">‚àà</span> set <span class="free">p</span><span class="main">.</span> <span class="free">S</span> <span class="free">ys</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àß</span> sorted_wrt <span class="main">(</span>rel2p var_order_rel<span class="main">)</span> <span class="free">ys</span> <span class="main">‚àß</span>
    distinct <span class="free">ys</span> <span class="main">‚àß</span> <span class="free">ys</span> <span class="main">‚àâ</span> set <span class="main">(</span>map fst <span class="free">p</span><span class="main">)</span> <span class="main">‚àß</span> <span class="free">n</span> <span class="main">‚â†</span> <span class="main">0</span> <span class="main">‚àß</span> nonzero_coeffs <span class="free">a</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sorted_poly_list_rel_wrt_def prod.case mem_Collect_eq
    list_rel_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> list.rel_sel<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> y<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπtl <span class="improper">y</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> relcompI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_wrt_def list_mset_rel_def br_def
    list.tl_def term_poly_list_rel_def nonzero_coeffs_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_poly_list_rel_Cons_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_list_rel <span class="free">S</span> <span class="main">‚ü∑</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> remove1_mset <span class="main">(</span>mset <span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_list_rel <span class="free">S</span> <span class="main">‚àß</span>
    <span class="main">(</span>mset <span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">‚àà#</span> <span class="free">a</span> <span class="main">‚àß</span> <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">x</span> <span class="main">‚àà</span> set <span class="free">p</span><span class="main">.</span> <span class="free">S</span> <span class="free">ys</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àß</span> sorted_wrt <span class="main">(</span>rel2p var_order_rel<span class="main">)</span> <span class="free">ys</span> <span class="main">‚àß</span>
    distinct <span class="free">ys</span> <span class="main">‚àß</span> <span class="free">ys</span> <span class="main">‚àâ</span> set <span class="main">(</span>map fst <span class="free">p</span><span class="main">)</span> <span class="main">‚àß</span> <span class="free">n</span> <span class="main">‚â†</span> <span class="main">0</span> <span class="main">‚àß</span> nonzero_coeffs <span class="free">a</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_ConsD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sorted_poly_list_rel_wrt_def prod.case mem_Collect_eq
      list_rel_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> y<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule_tac</span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>mset <span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">#</span> <span class="improper">y</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> relcompI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_wrt_def list_mset_rel_def br_def
        term_poly_list_rel_def add_mset_eq_add_mset eq_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="main">_</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span>
        nonzero_coeffs_def
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1"><span class="command">lemma</span></span> sorted_repeat_poly_list_rel_ConsD<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">‚àà</span> sorted_repeat_poly_list_rel <span class="free">S</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> remove1_mset <span class="main">(</span>mset <span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">‚àà</span> sorted_repeat_poly_list_rel <span class="free">S</span> <span class="main">‚àß</span>
    <span class="main">(</span>mset <span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">‚àà#</span> <span class="free">a</span> <span class="main">‚àß</span> <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">x</span> <span class="main">‚àà</span> set <span class="free">p</span><span class="main">.</span> <span class="free">S</span> <span class="free">ys</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àß</span> sorted_wrt <span class="main">(</span>rel2p var_order_rel<span class="main">)</span> <span class="free">ys</span> <span class="main">‚àß</span>
    distinct <span class="free">ys</span> <span class="main">‚àß</span> <span class="free">n</span> <span class="main">‚â†</span> <span class="main">0</span> <span class="main">‚àß</span> nonzero_coeffs <span class="free">a</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sorted_repeat_poly_list_rel_wrt_def prod.case mem_Collect_eq
    list_rel_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> list.rel_sel<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> y<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπtl <span class="improper">y</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> relcompI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_wrt_def list_mset_rel_def br_def
    list.tl_def term_poly_list_rel_def nonzero_coeffs_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_repeat_poly_list_rel_Cons_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">‚àà</span> sorted_repeat_poly_list_rel <span class="free">S</span> <span class="main">‚ü∑</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> remove1_mset <span class="main">(</span>mset <span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">‚àà</span> sorted_repeat_poly_list_rel <span class="free">S</span> <span class="main">‚àß</span>
    <span class="main">(</span>mset <span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">‚àà#</span> <span class="free">a</span> <span class="main">‚àß</span> <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">x</span> <span class="main">‚àà</span> set <span class="free">p</span><span class="main">.</span> <span class="free">S</span> <span class="free">ys</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àß</span> sorted_wrt <span class="main">(</span>rel2p var_order_rel<span class="main">)</span> <span class="free">ys</span> <span class="main">‚àß</span>
    distinct <span class="free">ys</span> <span class="main">‚àß</span> <span class="free">n</span> <span class="main">‚â†</span> <span class="main">0</span> <span class="main">‚àß</span> nonzero_coeffs <span class="free">a</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sorted_repeat_poly_list_rel_ConsD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sorted_repeat_poly_list_rel_wrt_def prod.case mem_Collect_eq
      list_rel_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> y<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>mset <span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">#</span> <span class="improper">y</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> relcompI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_repeat_poly_list_rel_wrt_def list_mset_rel_def br_def
        term_poly_list_rel_def add_mset_eq_add_mset eq_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="main">_</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span>
        nonzero_coeffs_def
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> add_poly_p_add_mset_sum_0<span class="main">:</span>
   <span class="quoted"><span class="quoted">‚Äπ<span class="free">n</span> <span class="main">+</span> <span class="free">m</span> <span class="main">=</span> <span class="main">0</span> <span class="main">‚üπ</span>add_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">Aa</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="main">{#}</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">‚üπ</span>
           add_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span>
            <span class="main">(</span>add_mset <span class="main">(</span>mset <span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">A</span><span class="main">,</span> add_mset <span class="main">(</span>mset <span class="free">ys</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">Aa</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span>
            <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="main">{#}</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> converse_rtranclp_into_rtranclp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> add_poly_p.add_new_coeff_r<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> converse_rtranclp_into_rtranclp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> add_poly_p.add_same_coeff_l<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> converse_rtranclp_into_rtranclp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_poly_p.rem_0_coeff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> monoms_add_poly_l'D<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="free">ba</span><span class="main">)</span> <span class="main">‚àà</span> set <span class="main">(</span>add_poly_l' <span class="free">x</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">aa</span> <span class="main">‚àà</span> fst <span class="main">`</span> set <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">‚à®</span> <span class="free">aa</span> <span class="main">‚àà</span> fst <span class="main">`</span> set <span class="main">(</span>snd <span class="free">x</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> add_poly_l'.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add_poly_p_add_to_result<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπadd_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">A'</span><span class="main">,</span> <span class="free">B'</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span> <span class="main">‚üπ</span>
       add_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span>
        <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">,</span> <span class="free">p</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">A'</span><span class="main">,</span> <span class="free">B'</span><span class="main">,</span> <span class="free">p</span> <span class="main">+</span> <span class="free">r'</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">add_poly_p</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">,</span></span> <span class="operator">split_format</span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="quasi_keyword"><span class="quasi_keyword">complete</span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> r<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> add_poly_pE<span class="main">)</span>
   <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Pair_inject add_poly_p.intros rtranclp.simps union_mset_add_mset_right<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_poly_p_add_mset_comb<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπadd_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">Aa</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="main">{#}</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">‚üπ</span>
       add_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span>
        <span class="main">(</span>add_mset <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">A</span><span class="main">,</span> <span class="free">Aa</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span>
        <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="main">{#}</span><span class="main">,</span> add_mset <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> converse_rtranclp_into_rtranclp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> add_poly_p.add_new_coeff_l<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> add_poly_p_add_to_result<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">Aa</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{#}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{#}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{#}</span>‚Ä∫</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{#</span><span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> add_poly_p_add_mset_comb2<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπadd_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">Aa</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="main">{#}</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">‚üπ</span>
       add_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span>
        <span class="main">(</span>add_mset <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">A</span><span class="main">,</span> add_mset <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">Aa</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span>
        <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="main">{#}</span><span class="main">,</span> add_mset <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> converse_rtranclp_into_rtranclp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> add_poly_p.add_new_coeff_r<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> converse_rtranclp_into_rtranclp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> add_poly_p.add_same_coeff_l<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> add_poly_p_add_to_result<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">Aa</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{#}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{#}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{#}</span>‚Ä∫</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{#</span><span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">+</span><span class="free">m</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> add_poly_p_add_mset_comb3<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπadd_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">Aa</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="main">{#}</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">‚üπ</span>
       add_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span>
        <span class="main">(</span><span class="free">A</span><span class="main">,</span> add_mset <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">Aa</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span>
        <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="main">{#}</span><span class="main">,</span> add_mset <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> converse_rtranclp_into_rtranclp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> add_poly_p.add_new_coeff_r<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> add_poly_p_add_to_result<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">Aa</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{#}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{#}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{#}</span>‚Ä∫</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{#</span><span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> total_on_lexord<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπRelation.total_on UNIV <span class="free">R</span> <span class="main">‚üπ</span> Relation.total_on UNIV <span class="main">(</span>lexord <span class="free">R</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Relation.total_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> lexord_linear<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> antisym_lexord<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπantisym <span class="free">R</span> <span class="main">‚üπ</span> irrefl <span class="free">R</span> <span class="main">‚üπ</span> antisym <span class="main">(</span>lexord <span class="free">R</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> antisym_def lexord_def irrefl_def
    <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_match_lel_lel<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> less_than_char_linear<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚àà</span> less_than_char <span class="main">‚à®</span>
           <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">‚à®</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">‚àà</span> less_than_char‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_than_char_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> total_on_lexord_less_than_char_linear<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs</span> <span class="main">‚â†</span> <span class="free">ys</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">‚àâ</span> lexord <span class="main">(</span>lexord less_than_char<span class="main">)</span> <span class="main">‚ü∑</span>
       <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">xs</span><span class="main">)</span> <span class="main">‚àà</span> lexord <span class="main">(</span>lexord less_than_char<span class="main">)</span>‚Ä∫</span></span>
   <span class="keyword1"><span class="command">using</span></span> lexord_linear<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπlexord less_than_char‚Ä∫</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">]</span>
   <span class="keyword1"><span class="command">using</span></span> lexord_linear<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπless_than_char‚Ä∫</span></span><span class="main">]</span> less_than_char_linear
   <span class="keyword1"><span class="command">using</span></span> lexord_irrefl<span class="main">[</span><span class="operator">OF</span> irrefl_less_than_char<span class="main">]</span>
     antisym_lexord<span class="main">[</span><span class="operator">OF</span> antisym_lexord<span class="main"><span class="main">[</span></span><span class="operator">OF</span> antisym_less_than_char irrefl_less_than_char<span class="main"><span class="main">]</span></span><span class="main">]</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> antisym_def Relation.total_on_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_poly_list_rel_nonzeroD<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_list_rel term_order <span class="main">‚üπ</span>
       nonzero_coeffs <span class="main">(</span><span class="free">r</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_list_rel <span class="main">(</span>rel2p <span class="main">(</span>lexord <span class="main">(</span>lexord less_than_char<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span>
       nonzero_coeffs <span class="main">(</span><span class="free">r</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_wrt_def nonzero_coeffs_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> add_poly_l'_add_poly_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">pq</span><span class="main">,</span> <span class="free">pq'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> sorted_poly_rel‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÉ</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span>add_poly_l' <span class="free">pq</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="main">‚àß</span>
                        add_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span>fst <span class="free">pq'</span><span class="main">,</span> snd <span class="free">pq'</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="main">{#}</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">pq</span>‚Ä∫</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">pq'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> add_poly_l'.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p pq'
    <span class="keyword1"><span class="command">using</span></span> add_poly_p_empty_l<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπfst <span class="skolem">pq'</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{#}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{#}</span>‚Ä∫</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">pq'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπfst <span class="skolem">pq'</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x p pq'
    <span class="keyword1"><span class="command">using</span></span> add_poly_p_empty_r<span class="main">[</span><span class="operator">of</span>  <span class="quoted"><span class="quoted">‚Äπ<span class="main">{#}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπsnd <span class="skolem">pq'</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{#}</span>‚Ä∫</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">pq'</span></span><span class="main">)</span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπsnd <span class="skolem">pq'</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> p <span class="keyword2"><span class="keyword">for</span></span> xs n p ys m q pq'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">pq'</span></span><span class="main">)</span> <span class="comment1">‚Äï ‚ÄπIsabelle does a completely stupid case distinction here‚Ä∫</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys</span>‚Ä∫</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">0</span>‚Ä∫</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>remove1_mset <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">pq'</span><span class="main">)</span><span class="main">,</span> remove1_mset <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span>  <span class="main">(</span>snd <span class="skolem">pq'</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span><span class="main">]</span> p<span class="main">(</span>5-<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_ConsD multi_member_split
           <span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> add_poly_p_add_mset_sum_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>remove1_mset <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">pq'</span><span class="main">)</span><span class="main">,</span> remove1_mset <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span>  <span class="main">(</span>snd <span class="skolem">pq'</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span><span class="main">]</span> p<span class="main">(</span>5-<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_ConsD multi_member_split<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπadd_mset <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span> <span class="improper">r</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> monoms_add_poly_l'D <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_Cons_iff rel2p_def
           sorted_poly_list_rel_nonzeroD var_order_rel_def
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_poly_p_add_mset_comb2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">‚àà</span> term_order_rel‚Ä∫</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>remove1_mset <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">pq'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>snd <span class="skolem">pq'</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span><span class="main">]</span> p<span class="main">(</span>5-<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_Cons_iff rel2p_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπadd_mset <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="improper">r</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> monoms_add_poly_l'D<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lexord_trans add_poly_p_add_mset_comb <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lexord_transI var_order_rel_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lexord_trans<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lexord_trans add_poly_p_add_mset_comb <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lexord_transI
          sorted_poly_list_rel_nonzeroD var_order_rel_def<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> total_on_lexord_less_than_char_linear <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>fst <span class="skolem">pq'</span><span class="main">,</span> remove1_mset <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">pq'</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span><span class="main">]</span> p<span class="main">(</span>5-<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_Cons_iff rel2p_def
           var_order_rel_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπadd_mset <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span> <span class="improper">r</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> monoms_add_poly_l'D
          <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> total_on_lexord_less_than_char_linear<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lexord_trans add_poly_p_add_mset_comb  <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lexord_transI
          total_on_lexord_less_than_char_linear var_order_rel_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lexord_trans<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lexord_trans add_poly_p_add_mset_comb3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lexord_transI
          sorted_poly_list_rel_nonzeroD var_order_rel_def<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> total_on_lexord_less_than_char_linear <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> add_poly_l_add_poly<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπadd_poly_l <span class="free">x</span> <span class="main">=</span> RETURN <span class="main">(</span>add_poly_l' <span class="free">x</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_poly_l_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> add_poly_l'.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‚Äπ<span class="operator">subst</span> RECT_unfold<span class="keyword3">,</span> <span class="operator">refine_mono</span><span class="keyword3">,</span> <span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main">:</span> list.split‚Ä∫</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_poly_l_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>add_poly_l<span class="main">,</span> uncurry <span class="main">(</span><span class="main">Œª</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">r</span><span class="main">.</span> add_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="main">{#}</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span>
    sorted_poly_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> sorted_poly_rel <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>f</sub></span> <span class="main">‚ü®</span>sorted_poly_rel<span class="main">‚ü©</span>nres_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_poly_l_add_poly
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> nres_relI frefI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> add_poly_l'_add_poly_p<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_fun_RES<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sort_poly_spec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπllist_polynomial <span class="main">‚áí</span> llist_polynomial nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">sort_poly_spec</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span>
  SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">p'</span><span class="main">.</span> mset <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> mset <span class="bound">p'</span> <span class="main">‚àß</span> sorted_wrt <span class="main">(</span>rel2p <span class="main">(</span>Id <span class="main">‚à™</span> term_order_rel<span class="main">)</span><span class="main">)</span> <span class="main">(</span>map fst <span class="bound">p'</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sort_poly_spec_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> unsorted_poly_rel‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπsort_poly_spec <span class="free">p</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">(</span>sorted_repeat_poly_rel<span class="main">)</span> <span class="main">(</span>RETURN <span class="free">p'</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    py<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    p'_y<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p'</span> <span class="main">=</span> mset <span class="skolem">y</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    zero<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">0</span> <span class="main">‚àâ#</span> snd <span class="main">`#</span> <span class="free">p'</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> sort_poly_spec_def poly_list_rel_def sorted_poly_list_rel_wrt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_mset_rel_def br_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπlength <span class="skolem">y</span> <span class="main">=</span> length <span class="free">p</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_def list_all2_conv_all_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span>
        <span class="main">‚àà</span> <span class="main">‚ü®</span>term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel <span class="keyword1">O</span> list_mset_rel‚Ä∫</span></span>
     <span class="keyword2"><span class="keyword">if</span></span> px<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">p</span> <span class="main">=</span> mset <span class="skolem">x</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_wrt <span class="main">(</span>rel2p <span class="main">(</span>Id <span class="main">‚à™</span> lexord var_order_rel<span class="main">)</span><span class="main">)</span> <span class="main">(</span>map fst <span class="skolem">x</span><span class="main">)</span>‚Ä∫</span></span>
     <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπllist_polynomial‚Ä∫</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      f<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπbij_betw <span class="skolem">f</span> <span class="main">{..&lt;</span>length <span class="skolem">x</span><span class="main">}</span> <span class="main">{..&lt;</span>length <span class="free">p</span><span class="main">}</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="skolem">x</span> <span class="main">‚üπ</span> <span class="skolem">x</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">p</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> px <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> eq_commute<span class="main">)</span>  <span class="keyword1"><span class="command">unfolding</span></span> mset_eq_perm
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> permutation_Ex_bij<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‚Äπmap <span class="main">(</span><span class="main">Œª</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">!</span> <span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="skolem">x</span><span class="main">]</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">y</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">p</span> <span class="main">!</span> <span class="skolem">f</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">y</span> <span class="main">!</span> <span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">using</span></span> list_all2_nthD<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="skolem">y</span></span>
         <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">f</span> <span class="skolem">i</span>‚Ä∫</span></span><span class="main">,</span> <span class="operator">OF</span> py<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> list_rel_def mem_Collect_eq prod.case<span class="main"><span class="main">]</span></span><span class="main">]</span>
         mset_eq_length<span class="main">[</span><span class="operator">OF</span> px<span class="main">]</span> f
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_def list_all2_conv_all_nth bij_betw_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="var">?y</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      xy<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπlength <span class="skolem">x</span> <span class="main">=</span> length <span class="skolem">y</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> py list_all2_nthD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπrel2p <span class="main">(</span>term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="skolem">y</span></span>
         <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">f</span> <span class="skolem">i</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">i</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> mset_eq_length<span class="main">[</span><span class="operator">OF</span> px<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_def list_all2_conv_all_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset_set <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">x</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">`#</span> mset_set <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">x</span><span class="main">}</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">using</span></span> f mset_eq_length<span class="main">[</span><span class="operator">OF</span> px<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def lessThan_atLeast0 image_mset_mset_set<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="skolem">y</span> <span class="main">=</span> <span class="main">{#</span><span class="skolem">y</span> <span class="main">!</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà#</span> mset_set <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">x</span><span class="main">}</span><span class="main">#}</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> drop_0<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> mset_drop_upto<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> xy<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> f<span class="main">)</span>
          <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="var">?y</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> list_mset_rel‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_mset_rel_def br_def p'_y<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> relcompI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> zero
    <span class="keyword1"><span class="command">unfolding</span></span> sort_poly_spec_def poly_list_rel_def sorted_repeat_poly_list_rel_wrt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">refine_rcg</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπMultiplication‚Ä∫</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mult_monoms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπterm_poly_list <span class="main">‚áí</span> term_poly_list <span class="main">‚áí</span> term_poly_list‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">mult_monoms</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">mult_monoms</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">mult_monoms</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">mult_monoms</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">‚àà</span> var_order_rel <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">mult_monoms</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free">mult_monoms</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> term_poly_list_rel_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">q'</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel <span class="main">‚ü∑</span> <span class="free">q'</span> <span class="main">=</span> <span class="main">{#}</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_eqD_set_mset<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">xs</span> <span class="main">=</span> <span class="free">A</span> <span class="main">‚üπ</span> set <span class="free">xs</span> <span class="main">=</span> set_mset <span class="free">A</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> term_poly_list_rel_Cons_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel <span class="main">‚ü∑</span>
    <span class="main">(</span><span class="free">p</span><span class="main">,</span> remove1_mset <span class="free">y</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel <span class="main">‚àß</span>
    <span class="free">y</span> <span class="main">‚àà#</span> <span class="free">p'</span> <span class="main">‚àß</span> <span class="free">y</span> <span class="main">‚àâ</span> set <span class="free">p</span> <span class="main">‚àß</span> <span class="free">y</span> <span class="main">‚àâ#</span> remove1_mset <span class="free">y</span> <span class="free">p'</span> <span class="main">‚àß</span>
  <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">x</span><span class="main">‚àà#</span>mset <span class="free">p</span><span class="main">.</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">‚àà</span> var_order_rel<span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_def rel2p_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split mset_eqD_set_mset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> var_order_rel_antisym<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">‚àâ</span> var_order_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_than_char_def lexord_irreflexive var_order_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> term_poly_list_rel_remdups_mset<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel <span class="main">‚üπ</span>
    <span class="main">(</span><span class="free">p</span><span class="main">,</span> remdups_mset <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_def distinct_mset_remdups_mset_id <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> distinct_mset_mset_distinct<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> var_notin_notin_mult_monomsD<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">y</span> <span class="main">‚àà</span> set <span class="main">(</span>mult_monoms <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">y</span> <span class="main">‚àà</span> set <span class="free">p</span> <span class="main">‚à®</span> <span class="free">y</span> <span class="main">‚àà</span> set <span class="free">q</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p'</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mult_monoms.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> term_poly_list_rel_set_mset<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel <span class="main">‚üπ</span> set <span class="free">p</span> <span class="main">=</span> set_mset <span class="free">q</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> mult_monoms_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>mult_monoms<span class="main">,</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> remdups_mset <span class="main">(</span><span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel <span class="main">‚Üí</span> term_poly_list_rel <span class="main">‚Üí</span> term_poly_list_rel‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπremdups_mset <span class="main">(</span><span class="skolem">A</span> <span class="main">+</span> <span class="skolem">Aa</span><span class="main">)</span> <span class="main">=</span> add_mset <span class="skolem">y</span> <span class="skolem">Ab</span> <span class="main">‚üπ</span> <span class="skolem">y</span> <span class="main">‚àâ#</span> <span class="skolem">A</span> <span class="main">‚üπ</span>
       <span class="skolem">y</span> <span class="main">‚àâ#</span> <span class="skolem">Aa</span> <span class="main">‚üπ</span>
       False‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">Aa</span> <span class="skolem">Ab</span> <span class="skolem">y</span> <span class="skolem">A</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> set_mset_remdups_mset union_iff union_single_eq_member<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> p p' q q'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p p' q q'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">p'</span></span> <span class="quoted"><span class="skolem">q'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mult_monoms.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_Cons_iff rel2p_def term_poly_list_rel_remdups_mset<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x p p' q'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_Cons_iff rel2p_def term_poly_list_rel_remdups_mset
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">q'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> p <span class="keyword2"><span class="keyword">for</span></span> x p y q p' q'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>‚Ä∫</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπremove1_mset <span class="skolem">y</span> <span class="skolem">p'</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπremove1_mset <span class="skolem">y</span> <span class="skolem">q'</span>‚Ä∫</span></span><span class="main">]</span> p<span class="main">(</span>4-<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_Cons_iff rel2p_def
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> var_notin_notin_mult_monomsD
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">‚àà</span> var_order_rel‚Ä∫</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπremove1_mset <span class="skolem">x</span> <span class="skolem">p'</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">q'</span>‚Ä∫</span></span><span class="main">]</span> p<span class="main">(</span>4-<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_Cons_iff
            term_poly_list_rel_set_mset rel2p_def var_order_rel_def
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">p'</span></span><span class="main"><span class="main">]</span></span> multi_member_split<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">q'</span></span><span class="main"><span class="main">]</span></span>
            var_notin_notin_mult_monomsD
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> lexord_cons_cons list.inject total_on_lexord_less_than_char_linear<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> lexord_cons_cons list.inject total_on_lexord_less_than_char_linear<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> lexord_cons_cons list.inject total_on_lexord_less_than_char_linear<span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> lexord_trans trans_less_than_char var_order_rel_antisym
       <span class="keyword1"><span class="command">unfolding</span></span> var_order_rel_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">p'</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπremove1_mset <span class="skolem">y</span> <span class="skolem">q'</span>‚Ä∫</span></span><span class="main">]</span> p<span class="main">(</span>4-<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_Cons_iff rel2p_def
            term_poly_list_rel_set_mset rel2p_def var_order_rel_antisym
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">p'</span></span><span class="main"><span class="main">]</span></span> multi_member_split<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">q'</span></span><span class="main"><span class="main">]</span></span>
            var_notin_notin_mult_monomsD
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> lexord_trans trans_less_than_char var_order_rel_antisym
       <span class="keyword1"><span class="command">unfolding</span></span> var_order_rel_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> lexord_cons_cons list.inject total_on_lexord_less_than_char_linear<span class="main">)</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> less_than_char_linear lexord_linear lexord_trans trans_less_than_char<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mult_monomials</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπterm_poly_list <span class="main">√ó</span> int <span class="main">‚áí</span> term_poly_list <span class="main">√ó</span> int <span class="main">‚áí</span> term_poly_list <span class="main">√ó</span> int‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">mult_monomials</span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mult_monoms <span class="bound">x</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mult_poly_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπllist_polynomial <span class="main">‚áí</span> llist_polynomial <span class="main">‚áí</span> llist_polynomial‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">mult_poly_raw</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> foldl <span class="main">(</span><span class="main">Œª</span><span class="bound">b</span> <span class="bound">x</span><span class="main">.</span> map <span class="main">(</span>mult_monomials <span class="bound">x</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">@</span> <span class="bound">b</span><span class="main">)</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">map_append</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">map_append</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">map_append</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">map_append</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_append_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπmap_append <span class="free">f</span> <span class="free">b</span> <span class="free">xs</span> <span class="main">=</span> map <span class="free">f</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">b</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> map_append.induct<span class="main">)</span>
   <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> foldl_append_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπNO_MATCH <span class="main">[]</span> <span class="free">xs</span> <span class="main">‚üπ</span> foldl <span class="main">(</span><span class="main">Œª</span><span class="bound">b</span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">@</span> <span class="bound">b</span><span class="main">)</span> <span class="free">xs</span> <span class="free">p</span> <span class="main">=</span> foldl <span class="main">(</span><span class="main">Œª</span><span class="bound">b</span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">@</span> <span class="bound">b</span><span class="main">)</span> <span class="main">[]</span> <span class="free">p</span> <span class="main">@</span> <span class="free">xs</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> NO_MATCH_def append.assoc append_self_conv foldl_Cons<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> poly_list_rel_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">‚àà</span> poly_list_rel <span class="free">R</span> <span class="main">‚ü∑</span> <span class="free">r</span> <span class="main">=</span> <span class="main">{#}</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_list_rel_def list_mset_rel_def br_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_poly_raw_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπmult_poly_raw <span class="main">[]</span> <span class="free">q</span> <span class="main">=</span> <span class="main">[]</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπmult_poly_raw <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">p</span><span class="main">)</span> <span class="free">q</span> <span class="main">=</span> mult_poly_raw <span class="free">p</span> <span class="free">q</span> <span class="main">@</span> map <span class="main">(</span>mult_monomials <span class="free">x</span><span class="main">)</span> <span class="free">q</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult_poly_raw_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult_poly_raw_def foldl_append_empty<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_poly_list_relD<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">q'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_list_rel <span class="free">R</span> <span class="main">‚üπ</span> <span class="free">q'</span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">`#</span> mset <span class="free">q</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_wrt_def list_mset_rel_def br_def
    list_rel_split_right_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> term_poly_list_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> relcomp.relcompI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_in_set_ExD<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπlist_all2 <span class="free">R</span> <span class="free">p</span> <span class="free">q</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àà</span> set <span class="free">p</span> <span class="main">‚üπ</span> <span class="main">‚àÉ</span><span class="bound">y</span> <span class="main">‚àà</span> set <span class="free">q</span><span class="main">.</span> <span class="free">R</span> <span class="free">x</span> <span class="bound">y</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all2_induct<span class="main">)</span>
    <span class="operator">auto</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> mult_poly_p_elim<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmult_poly_p <span class="free">q</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mult_poly_p_add_mset_same<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>mult_poly_p <span class="free">q'</span><span class="main">)</span><span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">(</span>mult_poly_p <span class="free">q'</span><span class="main">)</span><span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span>add_mset <span class="free">x</span> <span class="free">A</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>add_mset <span class="free">x</span> <span class="free">B</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπmult_poly_p <span class="free">q'</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">p'</span><span class="main">,</span> <span class="skolem">q''</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">p'</span> <span class="skolem">q''</span><span class="main"><span class="main">,</span></span> <span class="operator">split_format</span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="quasi_keyword"><span class="quasi_keyword">complete</span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtranclp.rtrancl_into_rtrancl<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_poly_p_elim <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mult_poly_p.intros
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtranclp.rtrancl_into_rtrancl <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_mset_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_poly_raw_mult_poly_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">q'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÉ</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span>mult_poly_raw <span class="free">p</span> <span class="free">q</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">‚àà</span> unsorted_poly_rel <span class="main">‚àß</span> <span class="main">(</span>mult_poly_p <span class="free">q'</span><span class="main">)</span><span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free">p'</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">q'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_list_rel term_order <span class="main">‚üπ</span> <span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">q</span> <span class="main">‚üπ</span>
    distinct <span class="skolem">aa</span> <span class="main">‚üπ</span> sorted_wrt var_order <span class="skolem">aa</span> <span class="main">‚üπ</span>
    <span class="main">(</span>mult_monoms <span class="skolem">aa</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">q</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
           mset <span class="main">(</span>mult_monoms <span class="skolem">aa</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">q</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">‚àà</span> term_poly_list_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">aa</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> mult_monoms_spec<span class="main">[</span><span class="operator">unfolded</span> fun_rel_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bspec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">aa</span><span class="main">,</span> <span class="main">(</span>mset <span class="skolem">aa</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> prod.case sorted_poly_list_rel_wrt_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> y
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bspec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>fst <span class="main">(</span><span class="free">q</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">,</span> mset <span class="main">(</span>fst <span class="main">(</span><span class="free">q</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">q</span> <span class="main">!</span> <span class="skolem">n</span>‚Ä∫</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">y</span> <span class="main">!</span> <span class="skolem">n</span>‚Ä∫</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> param_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">‚Äπterm_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel‚Ä∫</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_imp_same_length term_poly_list_rel_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> H'<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">q'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_list_rel term_order <span class="main">‚üπ</span>
    distinct <span class="skolem">aa</span> <span class="main">‚üπ</span> sorted_wrt var_order <span class="skolem">aa</span> <span class="main">‚üπ</span>
     <span class="main">(</span><span class="skolem">ab</span><span class="main">,</span> <span class="skolem">ba</span><span class="main">)</span> <span class="main">‚àà</span> set <span class="free">q</span> <span class="main">‚üπ</span>
       remdups_mset <span class="main">(</span>mset <span class="skolem">aa</span> <span class="main">+</span> mset <span class="skolem">ab</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>mult_monoms <span class="skolem">aa</span> <span class="skolem">ab</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">aa</span> <span class="skolem">n</span> <span class="skolem">ab</span> <span class="skolem">ba</span>
    <span class="keyword1"><span class="command">using</span></span> mult_monoms_spec<span class="main">[</span><span class="operator">unfolded</span> fun_rel_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bspec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">aa</span><span class="main">,</span> <span class="main">(</span>mset <span class="skolem">aa</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> prod.case sorted_poly_list_rel_wrt_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> y
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bspec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">ab</span><span class="main">,</span> mset <span class="skolem">ab</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_imp_same_length term_poly_list_rel_def list_rel_def
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_in_set_ExD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span>  H<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">q'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_list_rel term_order <span class="main">‚üπ</span>
       <span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">aa</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">‚üπ</span>
       <span class="main">(</span><span class="skolem">pq</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">‚àà</span> unsorted_poly_rel <span class="main">‚üπ</span>
       <span class="skolem">p'</span> <span class="main">=</span> add_mset <span class="main">(</span>mset <span class="skolem">aa</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="free">A</span> <span class="main">‚üπ</span>
       <span class="main">‚àÄ</span><span class="bound">x</span><span class="main">‚àà</span>set <span class="skolem">p</span><span class="main">.</span> term_order <span class="skolem">aa</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">‚üπ</span>
       sorted_wrt var_order <span class="skolem">aa</span> <span class="main">‚üπ</span>
       distinct <span class="skolem">aa</span> <span class="main">‚üπ</span> <span class="skolem">b</span><span class="main">‚â†</span> <span class="main">0</span> <span class="main">‚üπ</span>
       <span class="main">(</span><span class="main">‚ãÄ</span><span class="bound">aaa</span><span class="main">.</span> <span class="main">(</span><span class="bound">aaa</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">‚àâ#</span> <span class="free">q'</span><span class="main">)</span> <span class="main">‚üπ</span>
       <span class="main">(</span><span class="skolem">pq</span> <span class="main">@</span>
        map <span class="main">(</span>mult_monomials <span class="main">(</span><span class="skolem">aa</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span><span class="main">,</span>
        <span class="main">{#</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span>remdups_mset <span class="main">(</span>mset <span class="skolem">aa</span> <span class="main">+</span> <span class="bound">ys</span><span class="main">)</span><span class="main">,</span> <span class="bound">n</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span>
        <span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà#</span> <span class="free">q'</span><span class="main">#}</span> <span class="main">+</span>
        <span class="skolem">r</span><span class="main">)</span>
       <span class="main">‚àà</span> unsorted_poly_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">p</span> <span class="skolem">p'</span> <span class="skolem">pq</span> <span class="skolem">aa</span> <span class="skolem">b</span> <span class="skolem">r</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_list_rel_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="improper">y</span> <span class="main">@</span> map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>mult_monomials <span class="main">(</span><span class="skolem">aa</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> relcompI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_def list_all2_append list_all2_lengthD H
     list_mset_rel_def br_def mult_monomials_def case_prod_beta <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_all_nthI
     <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_poly_list_relD<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sorted_poly_list_relD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quoted">term_order</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_beta H' <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_mset_cong<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> p <span class="keyword2"><span class="keyword">for</span></span> a p p'
      <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπremove1_mset <span class="main">(</span>mset <span class="main">(</span>fst <span class="skolem">a</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">a</span><span class="main">)</span> <span class="skolem">p'</span>‚Ä∫</span></span><span class="main">]</span> p<span class="main">(</span>2-<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_Cons_iff
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>remdups_mset <span class="main">(</span>mset <span class="main">(</span>fst <span class="skolem">a</span><span class="main">)</span> <span class="main">+</span> <span class="bound">ys</span><span class="main">)</span><span class="main">,</span> <span class="bound">n</span> <span class="main">*</span> snd <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">`#</span> <span class="free">q'</span> <span class="main">+</span> <span class="improper">r</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 5 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mult_poly_p.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> H
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_nonzeroD nonzero_coeffsD<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtranclp_trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mult_poly_p_add_mset_same<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> converse_rtranclp_into_rtranclp<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_poly_p.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_coeffs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπllist_polynomial <span class="main">‚áí</span> llist_polynomial‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">merge_coeffs</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">merge_coeffs</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">]</span>‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">merge_coeffs</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>
    <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">‚â†</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">merge_coeffs</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">merge_coeffs</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free">merge_coeffs</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span><span class="entity">mononoms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπllist_polynomial <span class="main">‚áí</span> term_poly_list set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">mononoms</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚â°</span> fst <span class="main">`</span>set <span class="free"><span class="bound"><span class="entity">p</span></span></span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">lemma</span></span> fst_normalize_polynomial_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπmononoms <span class="main">(</span>merge_coeffs <span class="free">p</span><span class="main">)</span> <span class="main">‚äÜ</span> mononoms <span class="free">p</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_coeffs.induct<span class="main">)</span>  <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> fst_normalize_polynomial_subsetD<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚àà</span> set <span class="main">(</span>merge_coeffs <span class="free">p</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">a</span> <span class="main">‚àà</span> mononoms <span class="free">p</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_coeffs.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_merge_coeffs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_wrt <span class="free">R</span> <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπtransp <span class="free">R</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπantisymp <span class="free">R</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπdistinct <span class="main">(</span>map fst <span class="main">(</span>merge_coeffs <span class="free">xs</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_coeffs.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 5 4 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> antisympD <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fst_normalize_polynomial_subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_set_merge_coeffsD<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚àà</span> set <span class="main">(</span>merge_coeffs <span class="free">p</span><span class="main">)</span> <span class="main">‚üπ</span><span class="main">‚àÉ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">‚àà</span> set <span class="free">p</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fst_normalize_polynomial_subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rtranclp_normalize_poly_add_mset<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπnormalize_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="free">A</span> <span class="free">r</span> <span class="main">‚üπ</span> normalize_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span>add_mset <span class="free">x</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>add_mset <span class="free">x</span> <span class="free">r</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> normalize_poly_p.keep_coeff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nonzero_coeffs_diff<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπnonzero_coeffs <span class="free">A</span> <span class="main">‚üπ</span> nonzero_coeffs <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonzero_coeffs_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_diffD<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> merge_coeffs_is_normalize_poly_p<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">‚àà</span> sorted_repeat_poly_rel <span class="main">‚üπ</span> <span class="main">‚àÉ</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span>merge_coeffs <span class="free">xs</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="main">‚àß</span> normalize_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="free">ys</span> <span class="bound">r</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_coeffs.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_repeat_poly_list_rel_wrt_def sorted_poly_list_rel_wrt_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_repeat_poly_list_rel_wrt_def sorted_poly_list_rel_wrt_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> p <span class="keyword2"><span class="keyword">for</span></span> xs n ys m p ysa
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys</span>‚Ä∫</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">m</span><span class="main">+</span><span class="skolem">n</span> <span class="main">‚â†</span> <span class="main">0</span>‚Ä∫</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπadd_mset <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">+</span><span class="skolem">n</span><span class="main">)</span> <span class="skolem">ysa</span> <span class="main">-</span> <span class="main">{#</span><span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span><span class="main">]</span> p<span class="main">(</span>4-<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_Cons_iff <span class="dynamic"><span class="dynamic">ac_simps</span></span> add_mset_commute
        remove1_mset_add_mset_If nonzero_coeffs_diff sorted_repeat_poly_list_rel_Cons_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="improper">r</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> normalize_poly_p.merge_dup_coeff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">ysa</span> <span class="main">-</span>  <span class="main">{#</span><span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">ysa</span> <span class="main">-</span>  <span class="main">{#</span><span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="skolem">ys</span>‚Ä∫</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> normalize_poly_p.merge_dup_coeff
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_mset_commute
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> converse_rtranclp_into_rtranclp<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">ysa</span> <span class="main">-</span> <span class="main">{#</span><span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span><span class="main">]</span> p<span class="main">(</span>4-<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_Cons_iff <span class="dynamic"><span class="dynamic">ac_simps</span></span> add_mset_commute
        remove1_mset_add_mset_If nonzero_coeffs_diff sorted_repeat_poly_list_rel_Cons_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="improper">r</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> normalize_poly_p.rem_0_coeff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπadd_mset <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span> <span class="main">+</span><span class="skolem">n</span><span class="main">)</span> <span class="skolem">ysa</span> <span class="main">-</span>  <span class="main">{#</span><span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπadd_mset <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span> <span class="main">+</span><span class="skolem">n</span><span class="main">)</span> <span class="skolem">ysa</span> <span class="main">-</span>  <span class="main">{#</span><span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="skolem">ys</span>‚Ä∫</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> normalize_poly_p.merge_dup_coeff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">ysa</span> <span class="main">-</span>  <span class="main">{#</span><span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">ysa</span> <span class="main">-</span>  <span class="main">{#</span><span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="skolem">ys</span>‚Ä∫</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_mset_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="main">-</span><span class="skolem">n</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span>
          converse_rtranclp_into_rtranclp
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> normalize_poly_p.rem_0_coeff
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_eq_0_iff2
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> normalize_poly_p.rem_0_coeff<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπadd_mset <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span> <span class="skolem">ysa</span> <span class="main">-</span> <span class="main">{#</span><span class="main">(</span>mset <span class="skolem">xs</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span><span class="main">]</span> p<span class="main">(</span>4-<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_Cons_iff <span class="dynamic"><span class="dynamic">ac_simps</span></span> add_mset_commute
      remove1_mset_add_mset_If sorted_repeat_poly_list_rel_Cons_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπadd_mset <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="improper">r</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_set_merge_coeffsD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> normalize_poly_p.intros rtranclp_normalize_poly_add_mset
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel2p_def var_order_rel_def
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_nonzeroD<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> total_on_lexord_less_than_char_linear <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command">using</span></span> total_on_lexord_less_than_char_linear <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπNormalisation‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">normalize_poly</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">normalize_poly</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">p</span> <span class="main">‚Üê</span> sort_poly_spec <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
     RETURN <span class="main">(</span>merge_coeffs <span class="bound">p</span><span class="main">)</span>
<span class="main">}</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sort_coeff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπstring list <span class="main">‚áí</span> string list nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">sort_coeff</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">xs</span><span class="main">.</span> mset <span class="bound">xs</span> <span class="main">=</span> mset <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">‚àß</span> sorted_wrt <span class="main">(</span>rel2p <span class="main">(</span>Id <span class="main">‚à™</span> var_order_rel<span class="main">)</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_var_order_Id_var_order<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπdistinct <span class="free">a</span> <span class="main">‚üπ</span> sorted_wrt <span class="main">(</span>rel2p <span class="main">(</span>Id <span class="main">‚à™</span> var_order_rel<span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="main">‚üπ</span>
          sorted_wrt var_order <span class="free">a</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel2p_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sort_all_coeffs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπllist_polynomial <span class="main">‚áí</span> llist_polynomial nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">sort_all_coeffs</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> monadic_nfoldli <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="main">Œª</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> RETURN True<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="bound">b</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">a</span> <span class="main">‚Üê</span> sort_coeff <span class="bound">a</span><span class="main">;</span> RETURN <span class="main">(</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">#</span> <span class="bound">b</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">[]</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sort_all_coeffs_gen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚àÄ</span><span class="bound">xs</span> <span class="main">‚àà</span> mononoms <span class="free">xs'</span><span class="main">.</span> sorted_wrt <span class="main">(</span>rel2p <span class="main">(</span>var_order_rel<span class="main">)</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÄ</span><span class="bound">x</span> <span class="main">‚àà</span> mononoms <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">xs'</span><span class="main">)</span><span class="main">.</span> distinct <span class="bound">x</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπmonadic_nfoldli <span class="free">xs</span> <span class="main">(</span><span class="main">Œª</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> RETURN True<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="bound">b</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">a</span> <span class="main">‚Üê</span> sort_coeff <span class="bound">a</span><span class="main">;</span> RETURN <span class="main">(</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">#</span> <span class="bound">b</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="free">xs'</span> <span class="main">‚â§</span>
     <span class="main">‚áì</span>Id <span class="main">(</span>SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">ys</span><span class="main">.</span> map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rev <span class="free">xs</span> <span class="main">@</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">ys</span><span class="main">)</span> <span class="main">‚àß</span>
     <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">xs</span> <span class="main">‚àà</span> mononoms <span class="bound">ys</span><span class="main">.</span> sorted_wrt <span class="main">(</span>rel2p <span class="main">(</span>var_order_rel<span class="main">)</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ
       <span class="main">‚àÄ</span><span class="bound">x</span><span class="main">‚àà</span>set <span class="skolem">xs'</span><span class="main">.</span> sorted_wrt var_order <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">‚üπ</span>
       sorted_wrt <span class="main">(</span>rel2p <span class="main">(</span>Id <span class="main">‚à™</span> var_order_rel<span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">‚üπ</span>
       <span class="main">(</span><span class="skolem">aaa</span><span class="main">,</span> <span class="skolem">ba</span><span class="main">)</span> <span class="main">‚àà</span> set <span class="skolem">xs'</span> <span class="main">‚üπ</span>
       sorted_wrt <span class="main">(</span>rel2p <span class="main">(</span>Id <span class="main">‚à™</span> var_order_rel<span class="main">)</span><span class="main">)</span> <span class="skolem">aaa</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xs</span>  <span class="skolem">xs'</span> <span class="skolem">ba</span> <span class="skolem">aa</span> <span class="skolem">b</span> <span class="skolem">x</span> <span class="skolem">aaa</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UnCI fst_eqD rel2p_def sorted_wrt_mono_rel<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> sort_all_coeffs_def sort_coeff_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> p <span class="keyword2"><span class="keyword">for</span></span> a xs
      <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>2-<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> monadic_nfoldli_simp bind_to_let_conv Let_def if_True Refine_Basic.nres_monad3
        intro_spec_refine_iff prod.case<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 5 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> intro_spec_refine_iff image_Un
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> same_mset_distinct_iff
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span> distinct_var_order_Id_var_order
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">shuffle_coefficients</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">shuffle_coefficients</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span>SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">ys</span><span class="main">.</span> map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">ys</span> <span class="main">‚àß</span>
     <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">xs</span> <span class="main">‚àà</span> mononoms <span class="bound">ys</span><span class="main">.</span> sorted_wrt <span class="main">(</span>rel2p <span class="main">(</span>var_order_rel<span class="main">)</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sort_all_coeffs<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÄ</span><span class="bound">x</span> <span class="main">‚àà</span> mononoms <span class="free">xs</span><span class="main">.</span> distinct <span class="bound">x</span> <span class="main">‚üπ</span>
  sort_all_coeffs <span class="free">xs</span> <span class="main">‚â§</span> <span class="main">‚áì</span> Id <span class="main">(</span>shuffle_coefficients <span class="free">xs</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sort_all_coeffs_def shuffle_coefficients_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sort_all_coeffs_gen<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> unsorted_term_poly_list_rel_mset<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">aa</span><span class="main">)</span> <span class="main">‚àà</span> unsorted_term_poly_list_rel <span class="main">‚üπ</span> mset <span class="free">ys</span> <span class="main">=</span> <span class="free">aa</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unsorted_term_poly_list_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RETURN_map_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπRETURN <span class="keyword1">o</span> <span class="main">(</span>map <span class="free">f</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword1">REC<span class="hidden">‚á©</span><sub>T</sub></span> <span class="main">(</span><span class="main">Œª</span><span class="bound">g</span> <span class="bound">xs</span><span class="main">.</span>
      <span class="keyword1">case</span> <span class="bound">xs</span> <span class="keyword1">of</span>
        <span class="main">[]</span> <span class="main">‚áí</span> RETURN <span class="main">[]</span>
      <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">‚áí</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">xs</span> <span class="main">‚Üê</span> <span class="bound">g</span> <span class="bound">xs</span><span class="main">;</span> RETURN <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> comp_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eq_commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> RECT_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_mono</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> RECT_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_mono</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> fully_unsorted_poly_rel_Cons_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">‚àà</span> fully_unsorted_poly_rel <span class="main">‚ü∑</span>
    <span class="main">(</span><span class="free">p</span><span class="main">,</span> remove1_mset <span class="main">(</span>mset <span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">‚àà</span> fully_unsorted_poly_rel <span class="main">‚àß</span>
    <span class="main">(</span>mset <span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">‚àà#</span> <span class="free">a</span> <span class="main">‚àß</span> distinct <span class="free">ys</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_list_rel_def list_rel_split_right_iff list_mset_rel_def br_def
     unsorted_term_poly_list_rel_def
     nonzero_coeffs_def fully_unsorted_poly_list_rel_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>mset <span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">#</span> <span class="improper">y</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> relcompI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_mset_unsorted_term_poly_list_rel<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚ãÄ</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">‚àà</span> mononoms <span class="free">s</span> <span class="main">‚üπ</span> distinct <span class="bound">a</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">‚àÄ</span><span class="bound">x</span> <span class="main">‚àà</span> mononoms <span class="free">s</span><span class="main">.</span> distinct <span class="bound">x</span> <span class="main">‚üπ</span>
    <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">xs</span> <span class="main">‚àà</span> mononoms <span class="free">s</span><span class="main">.</span> sorted_wrt <span class="main">(</span>rel2p <span class="main">(</span>Id <span class="main">‚à™</span> var_order_rel<span class="main">)</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">‚üπ</span>
    <span class="main">(</span><span class="free">s</span><span class="main">,</span> map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>
          <span class="main">‚àà</span> <span class="main">‚ü®</span>term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_def
    distinct_var_order_Id_var_order<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_rel_unsorted_term_poly_list_relD<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>unsorted_term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel <span class="main">‚üπ</span>
   mset <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`#</span> mset <span class="free">p</span> <span class="main">‚àß</span> <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">x</span> <span class="main">‚àà</span> mononoms <span class="free">p</span><span class="main">.</span> distinct <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_split_right_iff
    unsorted_term_poly_list_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> shuffle_terms_distinct_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπmap <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚àÄ</span><span class="bound">x</span><span class="main">‚àà</span>set <span class="free">p</span><span class="main">.</span> distinct <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">‚ü∑</span> <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">x</span><span class="main">‚àà</span>set <span class="free">s</span><span class="main">.</span> distinct <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÄ</span><span class="bound">x</span><span class="main">‚àà</span>set <span class="skolem">s</span><span class="main">.</span> distinct <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> m<span class="main">:</span>  <span class="quoted"><span class="quoted">‚Äπmap <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      dist<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÄ</span><span class="bound">x</span><span class="main">‚àà</span>set <span class="skolem">p</span><span class="main">.</span> distinct <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="skolem">p</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">standard</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x</span> <span class="main">‚àà</span> set <span class="skolem">s</span>‚Ä∫</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>mset <span class="skolem">v</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">‚àà</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">unfolding</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">v'</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">‚àà</span> set <span class="skolem">p</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">‚Äπmset <span class="skolem">v'</span> <span class="main">=</span> mset <span class="skolem">v</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπdistinct <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> dist <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>‚Ä∫</span></span> distinct_mset_mset_distinct fst_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?thesis</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>unsorted_term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel <span class="main">‚üπ</span>
       <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚àà</span> set <span class="free">p</span> <span class="main">‚üπ</span>  distinct <span class="free">a</span>‚Ä∫</span></span>
   <span class="keyword1"><span class="command">using</span></span> list_rel_unsorted_term_poly_list_relD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> sort_all_coeffs_unsorted_poly_rel_with0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> fully_unsorted_poly_rel‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπsort_all_coeffs <span class="free">p</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">(</span>unsorted_poly_rel_with0<span class="main">)</span> <span class="main">(</span>RETURN <span class="free">p'</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rev <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">‚ü∑</span>
          <span class="main">(</span>map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span>
          map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rev <span class="skolem">s</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> rev_map <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπrev <span class="main">(</span>map <span class="main">_</span> <span class="main">_</span><span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπmap <span class="main">_</span> <span class="main">_</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">s</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>unsorted_term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel <span class="main">‚üπ</span>
           <span class="free">p'</span> <span class="main">=</span> mset <span class="bound">y</span> <span class="main">‚üπ</span>
           map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rev <span class="free">p</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="main">‚üπ</span>
           <span class="main">‚àÄ</span><span class="bound">x</span><span class="main">‚àà</span>set <span class="bound">s</span><span class="main">.</span> sorted_wrt var_order <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">‚üπ</span>
           <span class="main">(</span><span class="bound">s</span><span class="main">,</span> map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>
           <span class="main">‚àà</span> <span class="main">‚ü®</span>term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel2p_def
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_rel_unsorted_term_poly_list_relD
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> shuffle_terms_distinct_iff<span class="main"><span class="main">[</span></span><span class="quoted"><span class="operator">"THEN"</span></span> iffD1<span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_mset_unsorted_term_poly_list_rel
        sorted_wrt_mono_rel<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπrel2p <span class="main">(</span>var_order_rel<span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπrel2p <span class="main">(</span>Id <span class="main">‚à™</span> var_order_rel<span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">s</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>unsorted_term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel <span class="main">‚üπ</span>
           <span class="free">p'</span> <span class="main">=</span> mset <span class="bound">y</span> <span class="main">‚üπ</span>
           map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rev <span class="free">p</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="main">‚üπ</span>
           <span class="main">‚àÄ</span><span class="bound">x</span><span class="main">‚àà</span>set <span class="bound">s</span><span class="main">.</span> sorted_wrt var_order <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">‚üπ</span>
           mset <span class="bound">y</span> <span class="main">=</span> <span class="main">{#</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà#</span> mset <span class="bound">s</span><span class="main">#}</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> list_rel_unsorted_term_poly_list_relD mset_map mset_rev<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sort_all_coeffs<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shuffle_coefficients_def poly_list_rel_def
        RETURN_def fully_unsorted_poly_list_rel_def list_mset_rel_def
        br_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_rel_unsorted_term_poly_list_relD
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RES_refine relcompI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span>  <span class="quoted"><span class="quoted">‚Äπmap <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rev <span class="free">p</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span>
        1 2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sort_poly_spec_id'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> unsorted_poly_rel_with0‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπsort_poly_spec <span class="free">p</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">(</span>sorted_repeat_poly_rel_with0<span class="main">)</span> <span class="main">(</span>RETURN <span class="free">p'</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    py<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    p'_y<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p'</span> <span class="main">=</span> mset <span class="skolem">y</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> fully_unsorted_poly_list_rel_def poly_list_rel_def sorted_poly_list_rel_wrt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_mset_rel_def br_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπlength <span class="skolem">y</span> <span class="main">=</span> length <span class="free">p</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_def list_all2_conv_all_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span>
        <span class="main">‚àà</span> <span class="main">‚ü®</span>term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel <span class="keyword1">O</span> list_mset_rel‚Ä∫</span></span>
     <span class="keyword2"><span class="keyword">if</span></span> px<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="free">p</span> <span class="main">=</span> mset <span class="skolem">x</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπsorted_wrt <span class="main">(</span>rel2p <span class="main">(</span>Id <span class="main">‚à™</span> lexord var_order_rel<span class="main">)</span><span class="main">)</span> <span class="main">(</span>map fst <span class="skolem">x</span><span class="main">)</span>‚Ä∫</span></span>
     <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπllist_polynomial‚Ä∫</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      f<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπbij_betw <span class="skolem">f</span> <span class="main">{..&lt;</span>length <span class="skolem">x</span><span class="main">}</span> <span class="main">{..&lt;</span>length <span class="free">p</span><span class="main">}</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="skolem">x</span> <span class="main">‚üπ</span> <span class="skolem">x</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">p</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> px <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> eq_commute<span class="main">)</span>  <span class="keyword1"><span class="command">unfolding</span></span> mset_eq_perm
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> permutation_Ex_bij<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‚Äπmap <span class="main">(</span><span class="main">Œª</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">!</span> <span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="skolem">x</span><span class="main">]</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">y</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">p</span> <span class="main">!</span> <span class="skolem">f</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">y</span> <span class="main">!</span> <span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">using</span></span> list_all2_nthD<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="skolem">y</span></span>
         <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">f</span> <span class="skolem">i</span>‚Ä∫</span></span><span class="main">,</span> <span class="operator">OF</span> py<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> list_rel_def mem_Collect_eq prod.case<span class="main"><span class="main">]</span></span><span class="main">]</span>
         mset_eq_length<span class="main">[</span><span class="operator">OF</span> px<span class="main">]</span> f
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_def list_all2_conv_all_nth bij_betw_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="var">?y</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      xy<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπlength <span class="skolem">x</span> <span class="main">=</span> length <span class="skolem">y</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> py list_all2_nthD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπrel2p <span class="main">(</span>term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="skolem">y</span></span>
         <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">f</span> <span class="skolem">i</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">i</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> mset_eq_length<span class="main">[</span><span class="operator">OF</span> px<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_def list_all2_conv_all_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπmset_set <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">x</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">`#</span> mset_set <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">x</span><span class="main">}</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">using</span></span> f mset_eq_length<span class="main">[</span><span class="operator">OF</span> px<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def lessThan_atLeast0 image_mset_mset_set<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="skolem">y</span> <span class="main">=</span> <span class="main">{#</span><span class="skolem">y</span> <span class="main">!</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà#</span> mset_set <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">x</span><span class="main">}</span><span class="main">#}</span>‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> drop_0<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> mset_drop_upto<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> xy<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> f<span class="main">)</span>
          <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="var">?y</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> list_mset_rel‚Ä∫</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_mset_rel_def br_def p'_y<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> relcompI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sort_poly_spec_def poly_list_rel_def sorted_repeat_poly_list_rel_with0_wrt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">refine_rcg</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_coeffs0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπllist_polynomial <span class="main">‚áí</span> llist_polynomial‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">merge_coeffs0</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">merge_coeffs0</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">merge_coeffs0</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>
    <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">‚â†</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">merge_coeffs0</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">merge_coeffs0</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">merge_coeffs0</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free">merge_coeffs0</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">lemma</span></span> sorted_repeat_poly_list_rel_with0_wrt_ConsD<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">‚àà</span> sorted_repeat_poly_list_rel_with0_wrt <span class="free">S</span> term_poly_list_rel <span class="main">‚üπ</span>
     <span class="main">(</span><span class="free">p</span><span class="main">,</span> remove1_mset <span class="main">(</span>mset <span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">‚àà</span> sorted_repeat_poly_list_rel_with0_wrt <span class="free">S</span> term_poly_list_rel <span class="main">‚àß</span>
    <span class="main">(</span>mset <span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">‚àà#</span> <span class="free">a</span> <span class="main">‚àß</span> <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">x</span> <span class="main">‚àà</span> set <span class="free">p</span><span class="main">.</span> <span class="free">S</span> <span class="free">ys</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àß</span> sorted_wrt <span class="main">(</span>rel2p var_order_rel<span class="main">)</span> <span class="free">ys</span> <span class="main">‚àß</span>
    distinct <span class="free">ys</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sorted_repeat_poly_list_rel_with0_wrt_def prod.case mem_Collect_eq
    list_rel_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> list.rel_sel<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπtl <span class="improper">y</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> relcompI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_wrt_def list_mset_rel_def br_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">‚Äπlead_coeff <span class="improper">y</span>‚Ä∫</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">‚Äπlead_coeff <span class="improper">y</span>‚Ä∫</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">‚Äπlead_coeff <span class="improper">y</span>‚Ä∫</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">‚Äπlead_coeff <span class="improper">y</span>‚Ä∫</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_repeat_poly_list_rel_with0_wrtl_Cons_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">‚àà</span> sorted_repeat_poly_list_rel_with0_wrt <span class="free">S</span> term_poly_list_rel <span class="main">‚ü∑</span>
    <span class="main">(</span><span class="free">p</span><span class="main">,</span> remove1_mset <span class="main">(</span>mset <span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">‚àà</span> sorted_repeat_poly_list_rel_with0_wrt <span class="free">S</span> term_poly_list_rel <span class="main">‚àß</span>
    <span class="main">(</span>mset <span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">‚àà#</span> <span class="free">a</span> <span class="main">‚àß</span> <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">x</span> <span class="main">‚àà</span> set <span class="free">p</span><span class="main">.</span> <span class="free">S</span> <span class="free">ys</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àß</span> sorted_wrt <span class="main">(</span>rel2p var_order_rel<span class="main">)</span> <span class="free">ys</span> <span class="main">‚àß</span>
    distinct <span class="free">ys</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sorted_repeat_poly_list_rel_with0_wrt_ConsD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sorted_poly_list_rel_wrt_def prod.case mem_Collect_eq
      list_rel_def sorted_repeat_poly_list_rel_with0_wrt_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>mset <span class="free">ys</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">#</span> <span class="improper">y</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> relcompI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_wrt_def list_mset_rel_def br_def
        term_poly_list_rel_def add_mset_eq_add_mset eq_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="main">_</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span>
        nonzero_coeffs_def
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> fst_normalize0_polynomial_subsetD<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚àà</span> set <span class="main">(</span>merge_coeffs0 <span class="free">p</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">a</span> <span class="main">‚àà</span> mononoms <span class="free">p</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_coeffs0.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_set_merge_coeffs0D<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚àà</span> set <span class="main">(</span>merge_coeffs0 <span class="free">p</span><span class="main">)</span> <span class="main">‚üπ</span><span class="main">‚àÉ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">‚àà</span> set <span class="free">p</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fst_normalize0_polynomial_subsetD<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> merge_coeffs0_is_normalize_poly_p<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">‚àà</span> sorted_repeat_poly_rel_with0 <span class="main">‚üπ</span> <span class="main">‚àÉ</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span>merge_coeffs0 <span class="free">xs</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="main">‚àß</span> normalize_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="free">ys</span> <span class="bound">r</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_coeffs0.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_repeat_poly_list_rel_wrt_def sorted_poly_list_rel_wrt_def
    sorted_repeat_poly_list_rel_with0_wrt_def list_mset_rel_def br_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> xs n ys
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_repeat_poly_list_rel_wrt_def sorted_poly_list_rel_wrt_def
      sorted_repeat_poly_list_rel_with0_wrt_def list_mset_rel_def br_def
      list_rel_split_right_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> p <span class="keyword2"><span class="keyword">for</span></span> xs n ys m p ysa
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys</span>‚Ä∫</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">m</span><span class="main">+</span><span class="skolem">n</span> <span class="main">‚â†</span> <span class="main">0</span>‚Ä∫</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπadd_mset <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">+</span><span class="skolem">n</span><span class="main">)</span> <span class="skolem">ysa</span> <span class="main">-</span> <span class="main">{#</span><span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span><span class="main">]</span> p<span class="main">(</span>5-<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_repeat_poly_list_rel_with0_wrtl_Cons_iff <span class="dynamic"><span class="dynamic">ac_simps</span></span> add_mset_commute
        remove1_mset_add_mset_If nonzero_coeffs_diff sorted_repeat_poly_list_rel_Cons_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> normalize_poly_p.intros add_mset_commute add_mset_commute
         converse_rtranclp_into_rtranclp <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> normalize_poly_p.merge_dup_coeff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="improper">r</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> normalize_poly_p.merge_dup_coeff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">ysa</span> <span class="main">-</span>  <span class="main">{#</span><span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">ysa</span> <span class="main">-</span>  <span class="main">{#</span><span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="skolem">ys</span>‚Ä∫</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> normalize_poly_p.intros 
         converse_rtranclp_into_rtranclp <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split
         <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_mset_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span>
         <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> normalize_poly_p.merge_dup_coeff<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">ysa</span> <span class="main">-</span> <span class="main">{#</span><span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span><span class="main">]</span> p<span class="main">(</span>5-<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_repeat_poly_list_rel_with0_wrtl_Cons_iff <span class="dynamic"><span class="dynamic">ac_simps</span></span> add_mset_commute
        remove1_mset_add_mset_If nonzero_coeffs_diff sorted_repeat_poly_list_rel_Cons_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="improper">r</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> normalize_poly_p.rem_0_coeff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπadd_mset <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span> <span class="main">+</span><span class="skolem">n</span><span class="main">)</span> <span class="skolem">ysa</span> <span class="main">-</span>  <span class="main">{#</span><span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπadd_mset <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span> <span class="main">+</span><span class="skolem">n</span><span class="main">)</span> <span class="skolem">ysa</span> <span class="main">-</span>  <span class="main">{#</span><span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="skolem">ys</span>‚Ä∫</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> normalize_poly_p.merge_dup_coeff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">ysa</span> <span class="main">-</span>  <span class="main">{#</span><span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">ysa</span> <span class="main">-</span>  <span class="main">{#</span><span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="skolem">ys</span>‚Ä∫</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> normalize_poly_p.intros converse_rtranclp_into_rtranclp
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> normalize_poly_p.rem_0_coeff
         <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_mset_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>‚Ä∫</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπadd_mset <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span> <span class="skolem">ysa</span> <span class="main">-</span> <span class="main">{#</span><span class="main">(</span>mset <span class="skolem">xs</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span><span class="main">]</span> p<span class="main">(</span>4-<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_repeat_poly_list_rel_with0_wrtl_Cons_iff <span class="dynamic"><span class="dynamic">ac_simps</span></span> add_mset_commute
      remove1_mset_add_mset_If sorted_repeat_poly_list_rel_Cons_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="improper">r</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_set_merge_coeffsD<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtranclp_normalize_poly_add_mset converse_rtranclp_into_rtranclp
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel2p_def var_order_rel_def sorted_poly_list_rel_Cons_iff
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_nonzeroD<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπadd_mset <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span> <span class="skolem">ysa</span> <span class="main">-</span> <span class="main">{#</span><span class="main">(</span>mset <span class="skolem">xs</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span><span class="main">]</span> p<span class="main">(</span>5-<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_repeat_poly_list_rel_with0_wrtl_Cons_iff <span class="dynamic"><span class="dynamic">ac_simps</span></span> add_mset_commute
      remove1_mset_add_mset_If sorted_repeat_poly_list_rel_Cons_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπadd_mset <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="improper">r</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_set_merge_coeffs0D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> normalize_poly_p.intros rtranclp_normalize_poly_add_mset
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel2p_def var_order_rel_def sorted_poly_list_rel_Cons_iff
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_nonzeroD<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> in_set_merge_coeffs0D total_on_lexord_less_than_char_linear <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">using</span></span> in_set_merge_coeffs0D total_on_lexord_less_than_char_linear <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">full_normalize_poly</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">full_normalize_poly</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">p</span> <span class="main">‚Üê</span> sort_all_coeffs <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
     <span class="bound">p</span> <span class="main">‚Üê</span> sort_poly_spec <span class="bound">p</span><span class="main">;</span>
     RETURN <span class="main">(</span>merge_coeffs0 <span class="bound">p</span><span class="main">)</span>
  <span class="main">}</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sorted_remdups</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">sorted_remdups</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free">sorted_remdups</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">sorted_remdups</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">sorted_remdups</span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_sorted_remdups<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπset <span class="main">(</span>sorted_remdups <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sorted_remdups.induct<span class="main">)</span>
   <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_sorted_remdups<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπsorted_wrt <span class="free">R</span> <span class="free">xs</span> <span class="main">‚üπ</span> transp <span class="free">R</span> <span class="main">‚üπ</span> Restricted_Predicates.total_on <span class="free">R</span> UNIV <span class="main">‚üπ</span>
    antisymp <span class="free">R</span> <span class="main">‚üπ</span> distinct <span class="main">(</span>sorted_remdups <span class="free">xs</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sorted_remdups.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> antisympD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> full_normalize_poly_normalize_poly_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> fully_unsorted_poly_rel‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπfull_normalize_poly <span class="free">p</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">(</span>sorted_poly_rel<span class="main">)</span> <span class="main">(</span>SPEC <span class="main">(</span><span class="main">Œª</span><span class="bound">r</span><span class="main">.</span> normalize_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="free">p'</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?A</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="var">?R</span> <span class="var">?B</span>‚Ä∫</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?B</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">p'</span> <span class="main">‚Üê</span> RETURN <span class="free">p'</span><span class="main">;</span>
     <span class="bound">p'</span> <span class="main">‚Üê</span> RETURN <span class="bound">p'</span><span class="main">;</span>
     SPEC <span class="main">(</span><span class="main">Œª</span><span class="bound">r</span><span class="main">.</span> normalize_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="bound">p'</span> <span class="bound">r</span><span class="main">)</span>
    <span class="main">}</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">refine0</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπsort_all_coeffs <span class="free">p</span> <span class="main">‚â§</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> unsorted_poly_rel_with0<span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sort_all_coeffs_unsorted_poly_rel_with0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_fun_RES RETURN_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">refine0</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπsort_poly_spec <span class="skolem">p</span> <span class="main">‚â§</span> SPEC <span class="main">(</span><span class="main">Œª</span><span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="skolem">p'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_repeat_poly_rel_with0<span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">p'</span><span class="main">)</span> <span class="main">‚àà</span> unsorted_poly_rel_with0‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">p'</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sort_poly_spec_id'<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_fun_RES RETURN_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> 1<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> full_normalize_poly_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_rcg</span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RES_refine
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> merge_coeffs0_is_normalize_poly_p
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> RETURN_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mult_poly_full</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">mult_poly_full</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="keyword1">let</span> <span class="bound">pq</span> <span class="main">=</span> mult_poly_raw <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">;</span>
  normalize_poly <span class="bound">pq</span>
<span class="main">}</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> normalize_poly_normalize_poly_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> unsorted_poly_rel‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπnormalize_poly <span class="free">p</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">(</span>sorted_poly_rel<span class="main">)</span> <span class="main">(</span>SPEC <span class="main">(</span><span class="main">Œª</span><span class="bound">r</span><span class="main">.</span> normalize_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="free">p'</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‚ÄπSPEC <span class="main">(</span><span class="main">Œª</span><span class="bound">r</span><span class="main">.</span> normalize_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="free">p'</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">p'</span> <span class="main">‚Üê</span> RETURN <span class="free">p'</span><span class="main">;</span>
      SPEC <span class="main">(</span><span class="main">Œª</span><span class="bound">r</span><span class="main">.</span> normalize_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="bound">p'</span> <span class="bound">r</span><span class="main">)</span>
   <span class="main">}</span>‚Ä∫</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> normalize_poly_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> 1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> sort_poly_spec_id<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span>
      merge_coeffs_is_normalize_poly_p<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> merge_coeffs_is_normalize_poly_p<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RES_refine <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> RETURN_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπMultiplication and normalisation‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mult_poly_p'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">mult_poly_p'</span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="free"><span class="bound"><span class="entity">q'</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">pq</span> <span class="main">‚Üê</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span>mult_poly_p <span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">)</span><span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p'</span></span></span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
  SPEC <span class="main">(</span><span class="main">Œª</span><span class="bound">r</span><span class="main">.</span> normalize_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="bound">pq</span> <span class="bound">r</span><span class="main">)</span>
<span class="main">}</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unsorted_poly_rel_fully_unsorted_poly_rel<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπunsorted_poly_rel <span class="main">‚äÜ</span> fully_unsorted_poly_rel‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπterm_poly_list_rel  <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel <span class="main">‚äÜ</span> unsorted_term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unsorted_term_poly_list_rel_def term_poly_list_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> list_rel_mono<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> poly_list_rel_def fully_unsorted_poly_list_rel_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mult_poly_full_mult_poly_p'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">q'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπmult_poly_full <span class="free">p</span> <span class="free">q</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">(</span>sorted_poly_rel<span class="main">)</span> <span class="main">(</span>mult_poly_p' <span class="free">p'</span> <span class="free">q'</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mult_poly_full_def mult_poly_p'_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> full_normalize_poly_normalize_poly_p
    normalize_poly_normalize_poly_p<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> RETURN_RES_refine_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Bex_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> conj_commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mult_poly_raw_mult_poly_p<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">add_poly_spec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">add_poly_spec</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">Œª</span><span class="bound">r</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">-</span> <span class="bound">r</span> <span class="main">‚àà</span> ideal polynomial_bool<span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">add_poly_p'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">add_poly_p'</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">r</span><span class="main">.</span> add_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="main">{#}</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_poly_l_add_poly_p'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">q'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπadd_poly_l <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">(</span>sorted_poly_rel<span class="main">)</span> <span class="main">(</span>add_poly_p' <span class="free">p'</span> <span class="free">q'</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_poly_p'_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> add_poly_l_spec<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> fref_to_Down_curry_right<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> order_trans<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">p'</span></span> <span class="quoted"><span class="free">q'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπCorrectness‚Ä∫</span></span>

<span class="keyword1"><span class="command">context</span></span> poly_embed
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mset_poly_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">mset_poly_rel</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">b</span> <span class="main">=</span> polynomial_of_mset <span class="bound">a</span><span class="main">}</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">var_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">var_rel</span> <span class="main">=</span> br <span class="free">œÜ</span> <span class="main">(</span><span class="main">Œª</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> normalize_poly_p_normalize_poly_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> mset_poly_rel <span class="main">‚üπ</span>
    SPEC <span class="main">(</span><span class="main">Œª</span><span class="bound">r</span><span class="main">.</span> normalize_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="free">p</span> <span class="bound">r</span><span class="main">)</span> <span class="main">‚â§</span> <span class="main">‚áì</span>mset_poly_rel <span class="main">(</span>normalize_poly_spec <span class="free">p'</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_poly_rel_def rtranclp_normalize_poly_p_poly_of_mset ideal.span_zero
    normalize_poly_spec_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RES_refine<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> mult_poly_p'_mult_poly_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> mset_poly_rel <span class="main">‚üπ</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">q'</span><span class="main">)</span> <span class="main">‚àà</span> mset_poly_rel <span class="main">‚üπ</span>
  mult_poly_p' <span class="free">p</span> <span class="free">q</span> <span class="main">‚â§</span> <span class="main">‚áì</span>mset_poly_rel <span class="main">(</span>mult_poly_spec <span class="free">p'</span> <span class="free">q'</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mult_poly_p'_def mult_poly_spec_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_rcg</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_poly_rel_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rtranclp_mult_poly_p_mult_ideal_final<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> RES_refine<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> ideal.span_add_eq2 ideal.span_zero
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rtranclp_normalize_poly_p_poly_of_mset <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ideal.span_add_eq2<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> add_poly_p'_add_poly_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> mset_poly_rel <span class="main">‚üπ</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">q'</span><span class="main">)</span> <span class="main">‚àà</span> mset_poly_rel <span class="main">‚üπ</span>
  add_poly_p' <span class="free">p</span> <span class="free">q</span> <span class="main">‚â§</span> <span class="main">‚áì</span>mset_poly_rel <span class="main">(</span>add_poly_spec <span class="free">p'</span> <span class="free">q'</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_poly_p'_def add_poly_spec_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_poly_rel_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rtranclp_add_poly_p_polynomial_of_mset_full<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> RES_refine<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rtranclp_add_poly_p_polynomial_of_mset_full ideal.span_zero<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">weak_equality_l</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπllist_polynomial <span class="main">‚áí</span> llist_polynomial <span class="main">‚áí</span> bool nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">weak_equality_l</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> RETURN <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">weak_equality</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint mpoly <span class="main">‚áí</span> int mpoly <span class="main">‚áí</span> bool nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">weak_equality</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">Œª</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">weak_equality_spec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπmset_polynomial <span class="main">‚áí</span> mset_polynomial <span class="main">‚áí</span> bool nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">weak_equality_spec</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">Œª</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> term_poly_list_rel_same_rightD<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">aa</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel <span class="main">‚üπ</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">ab</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel <span class="main">‚üπ</span> <span class="free">aa</span> <span class="main">=</span> <span class="free">ab</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_rel_term_poly_list_rel_same_rightD<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">xa</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel <span class="main">‚üπ</span>
   <span class="main">(</span><span class="free">xa</span><span class="main">,</span> <span class="free">ya</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel <span class="main">‚üπ</span>
    <span class="free">y</span> <span class="main">=</span> <span class="free">ya</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xa</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">ya</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_split_right_iff
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_same_rightD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> weak_equality_l_weak_equality_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>uncurry weak_equality_l<span class="main">,</span> uncurry weak_equality_spec<span class="main">)</span> <span class="main">‚àà</span>
    sorted_poly_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> sorted_poly_rel <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>f</sub></span> <span class="main">‚ü®</span>bool_rel<span class="main">‚ü©</span>nres_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> frefI nres_relI<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> weak_equality_l_def weak_equality_spec_def
      sorted_poly_list_rel_wrt_def list_mset_rel_def br_def
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_rel_term_poly_list_rel_same_rightD<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="PAC_Checker">
<div class="head">
<h1>Theory PAC_Checker</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:         PAC_Checker.thy
  Author:       Mathias Fleury, Daniela Kaufmann, JKU
  Maintainer:   Mathias Fleury, JKU
*)</span>
<span class="keyword1"><span class="command">theory</span></span> PAC_Checker
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="PAC_Polynomials_Operations.html">PAC_Polynomials_Operations</a>
    <a href="PAC_Checker_Specification.html">PAC_Checker_Specification</a>
    <a href="PAC_Map_Rel.html">PAC_Map_Rel</a>
    <a href="../Show/Show.html">Show.Show</a>
    <a href="../Show/Show_Instances.html">Show.Show_Instances</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚ÄπExecutable Checker‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπIn this layer we finally refine the checker to executable code.‚Ä∫</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπDefinitions‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπCompared to the previous layer, we add an error message when an error is discovered. We do not
  attempt to prove anything on the error message (neither that there really is an error, nor that the
  error message is correct).
‚Ä∫</span></span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‚ÄπExtended error message‚Ä∫</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> code_status <span class="main">=</span>
  <span class="entity">is_cfailed</span><span class="main">:</span> CFAILED <span class="main">(</span><span class="free"><span class="entity">the_error</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span> <span class="main">|</span>
  CSUCCESS <span class="main">|</span>
  <span class="entity">is_cfound</span><span class="main">:</span> CFOUND

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπIn the following function, we merge errors. We will never merge an error message with an
  another error message; hence we do not attempt to concatenate error messages.
‚Ä∫</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_cstatus</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">merge_cstatus</span> <span class="main">(</span>CFAILED <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> CFAILED <span class="free"><span class="bound"><span class="entity">a</span></span></span>‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">merge_cstatus</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>CFAILED <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> CFAILED <span class="free"><span class="bound"><span class="entity">a</span></span></span>‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">merge_cstatus</span> CFOUND <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> CFOUND‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">merge_cstatus</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> CFOUND <span class="main">=</span> CFOUND‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">merge_cstatus</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> CSUCCESS‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">code_status_status_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'a</span> code_status <span class="main">√ó</span> status<span class="main">)</span> set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">code_status_status_rel</span> <span class="main">=</span>
  <span class="main">{</span><span class="main">(</span>CFOUND<span class="main">,</span> FOUND<span class="main">)</span><span class="main">,</span> <span class="main">(</span>CSUCCESS<span class="main">,</span> SUCCESS<span class="main">)</span><span class="main">}</span> <span class="main">‚à™</span>
  <span class="main">{</span><span class="main">(</span>CFAILED <span class="bound">a</span><span class="main">,</span> FAILED<span class="main">)</span><span class="main">|</span> <span class="bound">a</span><span class="main">.</span> True<span class="main">}</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_code_status_status_rel_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>CFOUND<span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚àà</span> code_status_status_rel <span class="main">‚ü∑</span> <span class="free">b</span> <span class="main">=</span> FOUND‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a</span><span class="main">,</span> FOUND<span class="main">)</span> <span class="main">‚àà</span> code_status_status_rel <span class="main">‚ü∑</span> <span class="free">a</span> <span class="main">=</span> CFOUND‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>CSUCCESS<span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚àà</span> code_status_status_rel <span class="main">‚ü∑</span> <span class="free">b</span> <span class="main">=</span> SUCCESS‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a</span><span class="main">,</span> SUCCESS<span class="main">)</span> <span class="main">‚àà</span> code_status_status_rel <span class="main">‚ü∑</span> <span class="free">a</span> <span class="main">=</span> CSUCCESS‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a</span><span class="main">,</span> FAILED<span class="main">)</span> <span class="main">‚àà</span> code_status_status_rel <span class="main">‚ü∑</span> is_cfailed <span class="free">a</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>CFAILED <span class="free">C</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚àà</span> code_status_status_rel <span class="main">‚ü∑</span> <span class="free">b</span> <span class="main">=</span> FAILED‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> code_status_status_rel_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‚ÄπRefinement relation‚Ä∫</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pac_step_rel_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'olbl</span> <span class="main">√ó</span> <span class="tfree">'lbl</span><span class="main">)</span> set <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">√ó</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">√ó</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'olbl</span><span class="main">)</span> pac_step <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'lbl</span><span class="main">)</span> pac_step <span class="main">‚áí</span> bool‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">pac_step_rel_raw</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="free"><span class="bound"><span class="entity">R3</span></span></span> <span class="main">(</span>Add <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Add <span class="free"><span class="bound"><span class="entity">p1'</span></span></span> <span class="free"><span class="bound"><span class="entity">p2'</span></span></span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="main">‚ü∑</span>
   <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p1'</span></span></span><span class="main">)</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="main">‚àß</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p2'</span></span></span><span class="main">)</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="main">‚àß</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">)</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="main">‚àß</span>
   <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span>‚Ä∫</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">pac_step_rel_raw</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="free"><span class="bound"><span class="entity">R3</span></span></span> <span class="main">(</span>Mult <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Mult <span class="free"><span class="bound"><span class="entity">p1'</span></span></span> <span class="free"><span class="bound"><span class="entity">p2'</span></span></span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="main">‚ü∑</span>
   <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p1'</span></span></span><span class="main">)</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="main">‚àß</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p2'</span></span></span><span class="main">)</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="main">‚àß</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">)</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="main">‚àß</span>
   <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span>‚Ä∫</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">pac_step_rel_raw</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="free"><span class="bound"><span class="entity">R3</span></span></span> <span class="main">(</span>Del <span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">)</span> <span class="main">(</span>Del <span class="free"><span class="bound"><span class="entity">p1'</span></span></span><span class="main">)</span> <span class="main">‚ü∑</span>
   <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p1'</span></span></span><span class="main">)</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span>‚Ä∫</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">pac_step_rel_raw</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="free"><span class="bound"><span class="entity">R3</span></span></span> <span class="main">(</span>Extension <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">)</span> <span class="main">(</span>Extension <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span> <span class="free"><span class="bound"><span class="entity">p1'</span></span></span><span class="main">)</span> <span class="main">‚ü∑</span>
   <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="main">‚àß</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span><span class="main">)</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">R3</span></span></span> <span class="main">‚àß</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p1'</span></span></span><span class="main">)</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span>‚Ä∫</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">pac_step_rel_raw</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="free"><span class="bound"><span class="entity">R3</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">‚ü∑</span> False‚Ä∫</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pac_step_rel_assn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'olbl</span> <span class="main">‚áí</span> <span class="tfree">'lbl</span> <span class="main">‚áí</span> assn<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> assn<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">‚áí</span> <span class="tfree">'d</span> <span class="main">‚áí</span> assn<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'olbl</span><span class="main">)</span> pac_step <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'lbl</span><span class="main">)</span> pac_step <span class="main">‚áí</span> assn‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">pac_step_rel_assn</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="free"><span class="bound"><span class="entity">R3</span></span></span> <span class="main">(</span>Add <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Add <span class="free"><span class="bound"><span class="entity">p1'</span></span></span> <span class="free"><span class="bound"><span class="entity">p2'</span></span></span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p1'</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">p2'</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="main">*</span>
   <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span>‚Ä∫</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">pac_step_rel_assn</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="free"><span class="bound"><span class="entity">R3</span></span></span> <span class="main">(</span>Mult <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Mult <span class="free"><span class="bound"><span class="entity">p1'</span></span></span> <span class="free"><span class="bound"><span class="entity">p2'</span></span></span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p1'</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">p2'</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="main">*</span>
   <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span>‚Ä∫</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">pac_step_rel_assn</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="free"><span class="bound"><span class="entity">R3</span></span></span> <span class="main">(</span>Del <span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">)</span> <span class="main">(</span>Del <span class="free"><span class="bound"><span class="entity">p1'</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p1'</span></span></span>‚Ä∫</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">pac_step_rel_assn</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="free"><span class="bound"><span class="entity">R3</span></span></span> <span class="main">(</span>Extension <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">)</span> <span class="main">(</span>Extension <span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span> <span class="free"><span class="bound"><span class="entity">p1'</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">R3</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p1'</span></span></span>‚Ä∫</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">pac_step_rel_assn</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="keyword1">false</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pac_step_rel_assn_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπpac_step_rel_assn <span class="free">R1</span> <span class="free">R2</span> <span class="free">R3</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">case</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span>Add <span class="bound">p1</span> <span class="bound">p2</span> <span class="bound">i</span> <span class="bound">r</span><span class="main">,</span> Add <span class="bound">p1'</span> <span class="bound">p2'</span> <span class="bound">i'</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">‚áí</span>
        <span class="free">R1</span> <span class="bound">p1</span> <span class="bound">p1'</span> <span class="main">*</span> <span class="free">R1</span> <span class="bound">p2</span> <span class="bound">p2'</span> <span class="main">*</span> <span class="free">R1</span> <span class="bound">i</span> <span class="bound">i'</span> <span class="main">*</span> <span class="free">R2</span> <span class="bound">r</span> <span class="bound">r'</span>
    <span class="main">|</span> <span class="main">(</span>Mult <span class="bound">p1</span> <span class="bound">p2</span> <span class="bound">i</span> <span class="bound">r</span><span class="main">,</span> Mult <span class="bound">p1'</span> <span class="bound">p2'</span> <span class="bound">i'</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">‚áí</span>
        <span class="free">R1</span> <span class="bound">p1</span> <span class="bound">p1'</span> <span class="main">*</span> <span class="free">R2</span> <span class="bound">p2</span> <span class="bound">p2'</span> <span class="main">*</span> <span class="free">R1</span> <span class="bound">i</span> <span class="bound">i'</span> <span class="main">*</span> <span class="free">R2</span> <span class="bound">r</span> <span class="bound">r'</span>
    <span class="main">|</span> <span class="main">(</span>Del <span class="bound">p1</span><span class="main">,</span> Del <span class="bound">p1'</span><span class="main">)</span> <span class="main">‚áí</span> <span class="free">R1</span> <span class="bound">p1</span> <span class="bound">p1'</span>
    <span class="main">|</span> <span class="main">(</span>Extension <span class="bound">i</span> <span class="bound">x</span> <span class="bound">p1</span><span class="main">,</span> Extension <span class="bound">i'</span> <span class="bound">x'</span> <span class="bound">p1'</span><span class="main">)</span> <span class="main">‚áí</span> <span class="free">R1</span> <span class="bound">i</span> <span class="bound">i'</span> <span class="main">*</span> <span class="free">R3</span> <span class="bound">x</span> <span class="bound">x'</span> <span class="main">*</span> <span class="free">R2</span> <span class="bound">p1</span> <span class="bound">p1'</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">‚áí</span> <span class="keyword1">false</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pac_step.splits<span class="main">)</span>


<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‚ÄπAddition checking‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">error_msg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">error_msg</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span> <span class="main">=</span> CFAILED <span class="main">(</span><span class="inner_quoted">''s CHECKING failed at line ''</span> <span class="main">@</span> show <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' with error ''</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">error_msg_notin_dom_err</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">error_msg_notin_dom_err</span> <span class="main">=</span> <span class="inner_quoted">'' notin domain''</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">error_msg_notin_dom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπnat <span class="main">‚áí</span> string‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">error_msg_notin_dom</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> show <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">@</span> error_msg_notin_dom_err‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">error_msg_reused_dom</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">error_msg_reused_dom</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> show <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' already in domain''</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">error_msg_not_equal_dom</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">error_msg_not_equal_dom</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">pq</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> show <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' + ''</span> <span class="main">@</span> show <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' = ''</span> <span class="main">@</span> show <span class="free"><span class="bound"><span class="entity">pq</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' not equal''</span> <span class="main">@</span> show <span class="free"><span class="bound"><span class="entity">r</span></span></span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_not_equal_dom_err</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπllist_polynomial <span class="main">‚áí</span> llist_polynomial <span class="main">‚áí</span> llist_polynomial <span class="main">‚áí</span> llist_polynomial <span class="main">‚áí</span> string nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">check_not_equal_dom_err</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">pq</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">Œª</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vars_llist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπllist_polynomial <span class="main">‚áí</span> string set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">vars_llist</span>  <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">‚ãÉ</span><span class="main">(</span>set <span class="main">`</span> fst <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_addition_l</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">‚áí</span> <span class="main">_</span> <span class="main">‚áí</span> string set <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> llist_polynomial <span class="main">‚áí</span> string code_status nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">check_addition_l</span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
   <span class="keyword1">let</span> <span class="bound">b</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚àà#</span> dom_m <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">‚àà#</span> dom_m <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">‚àâ#</span> dom_m <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">‚àß</span> vars_llist <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">‚äÜ</span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span><span class="main">;</span>
   <span class="keyword1">if</span> <span class="main">¬¨</span><span class="bound">b</span>
   <span class="keyword1">then</span> RETURN <span class="main">(</span>error_msg <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚àâ#</span> dom_m <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> error_msg_notin_dom <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">‚àâ#</span> dom_m <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> error_msg_notin_dom <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="main">@</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">‚àà#</span> dom_m <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> error_msg_reused_dom <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
     ASSERT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚àà#</span> dom_m <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">;</span>
     <span class="keyword1">let</span> <span class="bound">p</span> <span class="main">=</span> the <span class="main">(</span>fmlookup <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">;</span>
     ASSERT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">‚àà#</span> dom_m <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">;</span>
     <span class="keyword1">let</span> <span class="bound">q</span> <span class="main">=</span> the <span class="main">(</span>fmlookup <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">;</span>
     <span class="bound">pq</span> <span class="main">‚Üê</span> add_poly_l <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">;</span>
     <span class="bound">b</span> <span class="main">‚Üê</span> weak_equality_l <span class="bound">pq</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span>
     <span class="bound">b'</span> <span class="main">‚Üê</span> weak_equality_l <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span><span class="main">;</span>
     <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b'</span> <span class="keyword1">then</span> RETURN CFOUND <span class="keyword1">else</span> RETURN CSUCCESS<span class="main">)</span>
     <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">c</span> <span class="main">‚Üê</span> check_not_equal_dom_err <span class="bound">p</span> <span class="bound">q</span> <span class="bound">pq</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span>
       RETURN <span class="main">(</span>error_msg <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">c</span><span class="main">)</span><span class="main">}</span>
   <span class="main">}</span>
<span class="main">}</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‚ÄπMultiplication checking‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_mult_l_dom_err</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπbool <span class="main">‚áí</span> nat <span class="main">‚áí</span> bool <span class="main">‚áí</span> nat <span class="main">‚áí</span> string nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">check_mult_l_dom_err</span> <span class="free"><span class="bound"><span class="entity">p_notin</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i_already</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">Œª</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_mult_l_mult_err</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπllist_polynomial <span class="main">‚áí</span> llist_polynomial <span class="main">‚áí</span> llist_polynomial <span class="main">‚áí</span> llist_polynomial <span class="main">‚áí</span> string nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">check_mult_l_mult_err</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">pq</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">Œª</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_mult_l</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">‚áí</span> <span class="main">_</span> <span class="main">‚áí</span> <span class="main">_</span> <span class="main">‚áí</span> nat <span class="main">‚áí</span>llist_polynomial <span class="main">‚áí</span>  nat <span class="main">‚áí</span> llist_polynomial <span class="main">‚áí</span> string code_status nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">check_mult_l</span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="bound">b</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚àà#</span> dom_m <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">‚àâ#</span> dom_m <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">‚àß</span> vars_llist <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">‚äÜ</span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span><span class="main">‚àß</span> vars_llist <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">‚äÜ</span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span><span class="main">;</span>
    <span class="keyword1">if</span> <span class="main">¬¨</span><span class="bound">b</span>
    <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">c</span> <span class="main">‚Üê</span> check_mult_l_dom_err <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚àâ#</span> dom_m <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">‚àà#</span> dom_m <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
      RETURN <span class="main">(</span>error_msg <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">c</span><span class="main">)</span><span class="main">}</span>
    <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
       ASSERT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚àà#</span> dom_m <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">;</span>
       <span class="keyword1">let</span> <span class="bound">p</span> <span class="main">=</span> the <span class="main">(</span>fmlookup <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">;</span>
       <span class="bound">pq</span> <span class="main">‚Üê</span> mult_poly_full <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">;</span>
       <span class="bound">b</span> <span class="main">‚Üê</span> weak_equality_l <span class="bound">pq</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span>
       <span class="bound">b'</span> <span class="main">‚Üê</span> weak_equality_l <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span><span class="main">;</span>
       <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b'</span> <span class="keyword1">then</span> RETURN CFOUND <span class="keyword1">else</span> RETURN CSUCCESS<span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">c</span> <span class="main">‚Üê</span> check_mult_l_mult_err <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="bound">pq</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span>
         RETURN <span class="main">(</span>error_msg <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">c</span><span class="main">)</span>
       <span class="main">}</span>
     <span class="main">}</span>
  <span class="main">}</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‚ÄπDeletion checking‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_del_l</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">‚áí</span> <span class="main">_</span> <span class="main">‚áí</span> nat <span class="main">‚áí</span> string code_status nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">check_del_l</span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> RETURN CSUCCESS‚Ä∫</span></span>


<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‚ÄπExtension checking‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_extension_l_dom_err</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπnat <span class="main">‚áí</span> string nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">check_extension_l_dom_err</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">Œª</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_extension_l_no_new_var_err</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπllist_polynomial <span class="main">‚áí</span> string nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">check_extension_l_no_new_var_err</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">Œª</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_extension_l_new_var_multiple_err</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπstring <span class="main">‚áí</span> llist_polynomial <span class="main">‚áí</span> string nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">check_extension_l_new_var_multiple_err</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">Œª</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_extension_l_side_cond_err</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπstring <span class="main">‚áí</span> llist_polynomial <span class="main">‚áí</span> llist_polynomial <span class="main">‚áí</span> llist_polynomial <span class="main">‚áí</span> string nres‚Ä∫</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">check_extension_l_side_cond_err</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">Œª</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_extension_l</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">‚áí</span> <span class="main">_</span> <span class="main">‚áí</span> string set <span class="main">‚áí</span> nat <span class="main">‚áí</span> string <span class="main">‚áí</span> llist_polynomial <span class="main">‚áí</span> <span class="main">(</span>string code_status<span class="main">)</span> nres‚Ä∫</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">check_extension_l</span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="keyword1">let</span> <span class="bound">b</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">‚àâ#</span> dom_m <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">‚àâ</span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span> <span class="main">‚àß</span> <span class="main">(</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">‚àà</span> set <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
  <span class="keyword1">if</span> <span class="main">¬¨</span><span class="bound">b</span>
  <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">c</span> <span class="main">‚Üê</span> check_extension_l_dom_err <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
    RETURN <span class="main">(</span>error_msg <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">c</span><span class="main">)</span>
  <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="keyword1">let</span> <span class="bound">p'</span> <span class="main">=</span> remove1 <span class="main">(</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">b</span> <span class="main">=</span> vars_llist <span class="bound">p'</span> <span class="main">‚äÜ</span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span><span class="main">;</span>
      <span class="keyword1">if</span> <span class="main">¬¨</span><span class="bound">b</span>
      <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">c</span> <span class="main">‚Üê</span> check_extension_l_new_var_multiple_err <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">p'</span><span class="main">;</span>
        RETURN <span class="main">(</span>error_msg <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">c</span><span class="main">)</span>
      <span class="main">}</span>
      <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">p2</span> <span class="main">‚Üê</span> mult_poly_full <span class="bound">p'</span> <span class="bound">p'</span><span class="main">;</span>
         <span class="keyword1">let</span> <span class="bound">p'</span> <span class="main">=</span> map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">-</span><span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">p'</span><span class="main">;</span>
         <span class="bound">q</span> <span class="main">‚Üê</span> add_poly_l <span class="main">(</span><span class="bound">p2</span><span class="main">,</span> <span class="bound">p'</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">eq</span> <span class="main">‚Üê</span> weak_equality_l <span class="bound">q</span> <span class="main">[]</span><span class="main">;</span>
         <span class="keyword1">if</span> <span class="bound">eq</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
           RETURN <span class="main">(</span>CSUCCESS<span class="main">)</span>
         <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">c</span> <span class="main">‚Üê</span> check_extension_l_side_cond_err <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">p'</span> <span class="bound">q</span><span class="main">;</span>
          RETURN <span class="main">(</span>error_msg <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">c</span><span class="main">)</span>
        <span class="main">}</span>
      <span class="main">}</span>
    <span class="main">}</span>
  <span class="main">}</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">lemma</span></span> check_extension_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπcheck_extension <span class="free">A</span> <span class="free">ùí±</span> <span class="free">i</span> <span class="free">v</span> <span class="free">p</span> <span class="main">‚â•</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">b</span> <span class="main">‚Üê</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">‚ü∂</span> <span class="free">i</span> <span class="main">‚àâ#</span> dom_m <span class="free">A</span> <span class="main">‚àß</span> <span class="free">v</span> <span class="main">‚àâ</span> <span class="free">ùí±</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">if</span> <span class="main">¬¨</span><span class="bound">b</span>
    <span class="keyword1">then</span> RETURN <span class="main">(</span>False<span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">p'</span> <span class="main">‚Üê</span> RETURN <span class="main">(</span><span class="free">p</span> <span class="main">+</span> Var <span class="free">v</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">b</span> <span class="main">‚Üê</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">‚ü∂</span> vars <span class="bound">p'</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span><span class="main">)</span><span class="main">;</span>
         <span class="keyword1">if</span> <span class="main">¬¨</span><span class="bound">b</span>
         <span class="keyword1">then</span> RETURN <span class="main">(</span>False<span class="main">)</span>
         <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
           <span class="bound">pq</span> <span class="main">‚Üê</span> mult_poly_spec <span class="bound">p'</span> <span class="bound">p'</span><span class="main">;</span>
           <span class="keyword1">let</span> <span class="bound">p'</span> <span class="main">=</span> <span class="main">-</span> <span class="bound">p'</span><span class="main">;</span>
           <span class="bound">p</span> <span class="main">‚Üê</span> add_poly_spec <span class="bound">pq</span> <span class="bound">p'</span><span class="main">;</span>
           <span class="bound">eq</span> <span class="main">‚Üê</span> weak_equality <span class="bound">p</span> <span class="main">0</span><span class="main">;</span>
           <span class="keyword1">if</span> <span class="bound">eq</span> <span class="keyword1">then</span> RETURN<span class="main">(</span>True<span class="main">)</span>
           <span class="keyword1">else</span> RETURN <span class="main">(</span>False<span class="main">)</span>
       <span class="main">}</span>
     <span class="main">}</span>
   <span class="main">}</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">ab</span> <span class="main">‚àâ</span> <span class="free">ùí±</span> <span class="main">‚üπ</span>
       vars <span class="skolem">ba</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span> <span class="main">‚üπ</span>
       MPoly_Type.coeff <span class="main">(</span><span class="skolem">ba</span> <span class="main">+</span> Var <span class="skolem">ab</span><span class="main">)</span> <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="skolem">ab</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ab</span> <span class="skolem">ba</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> coeff_add<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> not_in_vars_coeff0<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> coeff_add monom.abs_eq
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_in_vars_coeff0 MPoly_Type.coeff_def
          Var.abs_eq Var<span class="hidden">‚á©</span><sub>0</sub>_def lookup_single_eq monom.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚ÄπMPoly_Type.coeff <span class="free">p</span> <span class="main">(</span>monomial <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="skolem">ab</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>‚Ä∫</span></span>
     <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‚Äπvars <span class="main">(</span><span class="free">p</span> <span class="main">+</span> Var <span class="skolem">ab</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span>‚Ä∫</span></span>
       <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">ab</span> <span class="main">‚àâ</span> <span class="free">ùí±</span>‚Ä∫</span></span>
     <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ab</span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
     <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">q</span> <span class="main">‚â°</span> <span class="free">p</span> <span class="main">+</span> Var <span class="skolem">ab</span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">-</span> Var <span class="skolem">ab</span>‚Ä∫</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> p
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> coeff_minus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> not_in_vars_coeff0<span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> q_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> coeff_minus <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_in_vars_coeff0
           Var.abs_eq Var<span class="hidden">‚á©</span><sub>0</sub>_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> monom.abs_eq
           <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_in_vars_coeff0 MPoly_Type.coeff_def
           Var.abs_eq Var<span class="hidden">‚á©</span><sub>0</sub>_def lookup_single_eq monom.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπvars <span class="main">(</span><span class="free">p</span> <span class="main">-</span> Var <span class="skolem">ab</span><span class="main">)</span> <span class="main">=</span> vars <span class="main">(</span>Var <span class="skolem">ab</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ab</span>
    <span class="keyword1"><span class="command">using</span></span> vars_uminus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">p</span> <span class="main">-</span> Var <span class="skolem">ab</span>‚Ä∫</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> check_extension_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 5 5 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> check_extension_def weak_equality_def
      mult_poly_spec_def <span class="dynamic"><span class="dynamic">field_simps</span></span>
      add_poly_spec_def power2_eq_square <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> intro_spec_refine<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">Id</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ideal.span_add<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Copy of WB_More_Refinement *)</span>
<span class="keyword1"><span class="command">lemma</span></span> RES_RES_RETURN_RES<span class="main">:</span> <span class="quoted"><span class="quoted">‚ÄπRES <span class="free">A</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">T</span><span class="main">.</span> RES <span class="main">(</span><span class="free">f</span> <span class="bound">T</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> RES <span class="main">(</span><span class="main">‚ãÉ</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> check_add_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπcheck_add <span class="free">A</span> <span class="free">ùí±</span> <span class="free">p</span> <span class="free">q</span> <span class="free">i</span> <span class="free">r</span> <span class="main">‚â•</span>
    <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">b</span> <span class="main">‚Üê</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">‚ü∂</span> <span class="free">p</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚àß</span> <span class="free">q</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚àß</span> <span class="free">i</span> <span class="main">‚àâ#</span> dom_m <span class="free">A</span> <span class="main">‚àß</span> vars <span class="free">r</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span><span class="main">)</span><span class="main">;</span>
     <span class="keyword1">if</span> <span class="main">¬¨</span><span class="bound">b</span>
     <span class="keyword1">then</span> RETURN False
     <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
       ASSERT <span class="main">(</span><span class="free">p</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span><span class="main">)</span><span class="main">;</span>
       <span class="keyword1">let</span> <span class="bound">p</span> <span class="main">=</span> the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">p</span><span class="main">)</span><span class="main">;</span>
       ASSERT <span class="main">(</span><span class="free">q</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span><span class="main">)</span><span class="main">;</span>
       <span class="keyword1">let</span> <span class="bound">q</span> <span class="main">=</span> the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">q</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">pq</span> <span class="main">‚Üê</span> add_poly_spec <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span>
       <span class="bound">eq</span> <span class="main">‚Üê</span> weak_equality <span class="bound">pq</span> <span class="free">r</span><span class="main">;</span>
       RETURN <span class="bound">eq</span>
     <span class="main">}</span>
  <span class="main">}</span>‚Ä∫</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">‚â•</span> <span class="var">?A</span>‚Ä∫</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> check_add_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπcheck_add <span class="free">A</span> <span class="free">ùí±</span> <span class="free">p</span> <span class="free">q</span> <span class="free">i</span> <span class="free">r</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">b</span> <span class="main">‚Üê</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">‚ü∂</span> <span class="free">p</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚àß</span> <span class="free">q</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚àß</span> <span class="free">i</span> <span class="main">‚àâ#</span> dom_m <span class="free">A</span> <span class="main">‚àß</span> vars <span class="free">r</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span><span class="main">)</span><span class="main">;</span>
     <span class="keyword1">if</span> <span class="main">¬¨</span><span class="bound">b</span> <span class="keyword1">then</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">‚ü∂</span> <span class="free">p</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚àß</span> <span class="free">q</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚àß</span> <span class="free">i</span> <span class="main">‚àâ#</span> dom_m <span class="free">A</span> <span class="main">‚àß</span> vars <span class="free">r</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span> <span class="main">‚àß</span>
            the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">p</span><span class="main">)</span> <span class="main">+</span> the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">q</span><span class="main">)</span> <span class="main">-</span> <span class="free">r</span> <span class="main">‚àà</span>  ideal polynomial_bool<span class="main">)</span>
     <span class="keyword1">else</span>
       SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">‚ü∂</span> <span class="free">p</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚àß</span> <span class="free">q</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚àß</span> <span class="free">i</span> <span class="main">‚àâ#</span> dom_m <span class="free">A</span> <span class="main">‚àß</span> vars <span class="free">r</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span> <span class="main">‚àß</span>
            the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">p</span><span class="main">)</span> <span class="main">+</span> the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">q</span><span class="main">)</span> <span class="main">-</span> <span class="free">r</span> <span class="main">‚àà</span>  ideal polynomial_bool<span class="main">)</span><span class="main">}</span>‚Ä∫</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">=</span> <span class="var">?B</span>‚Ä∫</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> check_add_def RES_RES_RETURN_RES<span class="main">)</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="var">?A</span> <span class="main">‚â§</span> <span class="main">‚áì</span> Id <span class="main">(</span>check_add <span class="free">A</span> <span class="free">ùí±</span> <span class="free">p</span> <span class="free">q</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> check_add_alt_def weak_equality_def
        add_poly_spec_def RES_RES_RETURN_RES summarize_ASSERT_conv
      <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ideal.span_zero<span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">unfolding</span></span> check_add_alt_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> check_mult_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπcheck_mult <span class="free">A</span> <span class="free">ùí±</span> <span class="free">p</span> <span class="free">q</span> <span class="free">i</span> <span class="free">r</span> <span class="main">‚â•</span>
    <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">b</span> <span class="main">‚Üê</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">‚ü∂</span> <span class="free">p</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚àß</span> <span class="free">i</span> <span class="main">‚àâ#</span> dom_m <span class="free">A</span> <span class="main">‚àß</span> vars <span class="free">q</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span>  <span class="main">‚àß</span> vars <span class="free">r</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span><span class="main">)</span><span class="main">;</span>
     <span class="keyword1">if</span> <span class="main">¬¨</span><span class="bound">b</span>
     <span class="keyword1">then</span> RETURN False
     <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
       ASSERT <span class="main">(</span><span class="free">p</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span><span class="main">)</span><span class="main">;</span>
       <span class="keyword1">let</span> <span class="bound">p</span> <span class="main">=</span> the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">p</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">pq</span> <span class="main">‚Üê</span> mult_poly_spec <span class="bound">p</span> <span class="free">q</span><span class="main">;</span>
       <span class="bound">p</span> <span class="main">‚Üê</span> weak_equality <span class="bound">pq</span> <span class="free">r</span><span class="main">;</span>
       RETURN <span class="bound">p</span>
     <span class="main">}</span>
  <span class="main">}</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> check_mult_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refine_IdD<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">refine_vcg</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> check_mult_def weak_equality_def
      mult_poly_spec_def RES_RES_RETURN_RES
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  ideal.span_zero
      exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπthe <span class="main">(</span>fmlookup <span class="free">A</span> <span class="free">p</span><span class="main">)</span> <span class="main">*</span> <span class="free">q</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">insort_key_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> bool<span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'b</span> list <span class="main">‚áí</span> <span class="tfree">'b</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">insort_key_rel</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">insort_key_rel</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="main">(</span><span class="free">insort_key_rel</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_insort_key_rel<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπset <span class="main">(</span>insort_key_rel <span class="free">R</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
   <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_wrt_insort_key_rel<span class="main">:</span>
   <span class="quoted"><span class="quoted">‚Äπtotal_on <span class="free">R</span> <span class="main">(</span>insert <span class="free">x</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span> transp <span class="free">R</span> <span class="main">‚üπ</span> reflp <span class="free">R</span> <span class="main">‚üπ</span>
    sorted_wrt <span class="free">R</span> <span class="free">xs</span> <span class="main">‚üπ</span> sorted_wrt <span class="free">R</span> <span class="main">(</span>insort_key_rel <span class="free">R</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> transpD reflpD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Restricted_Predicates.total_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_wrt_insort_key_rel2<span class="main">:</span>
   <span class="quoted"><span class="quoted">‚Äπtotal_on <span class="free">R</span> <span class="main">(</span>insert <span class="free">x</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span> transp <span class="free">R</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àâ</span> set <span class="free">xs</span> <span class="main">‚üπ</span>
    sorted_wrt <span class="free">R</span> <span class="free">xs</span> <span class="main">‚üπ</span> sorted_wrt <span class="free">R</span> <span class="main">(</span>insort_key_rel <span class="free">R</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> transpD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Restricted_Predicates.total_on_def in_mono<span class="main">)</span>


<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‚ÄπStep checking‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PAC_checker_l_step</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">‚áí</span> string code_status <span class="main">√ó</span> string set <span class="main">√ó</span> <span class="main">_</span> <span class="main">‚áí</span> <span class="main">(</span>llist_polynomial<span class="main">,</span> string<span class="main">,</span> nat<span class="main">)</span> pac_step <span class="main">‚áí</span> <span class="main">_</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">PAC_checker_l_step</span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">spec</span> <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="bound">st</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">st</span> <span class="keyword1">of</span>
     Add <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">‚áí</span>
       <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">r</span> <span class="main">‚Üê</span> full_normalize_poly <span class="main">(</span>pac_res <span class="bound">st</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">eq</span> <span class="main">‚Üê</span> check_addition_l <span class="bound">spec</span> <span class="bound">A</span> <span class="bound">ùí±</span> <span class="main">(</span>pac_src1 <span class="bound">st</span><span class="main">)</span> <span class="main">(</span>pac_src2 <span class="bound">st</span><span class="main">)</span> <span class="main">(</span>new_id <span class="bound">st</span><span class="main">)</span> <span class="bound">r</span><span class="main">;</span>
        <span class="keyword1">let</span> <span class="main"><span class="bound">_</span></span> <span class="main">=</span> <span class="bound">eq</span><span class="main">;</span>
        <span class="keyword1">if</span> <span class="main">¬¨</span>is_cfailed <span class="bound">eq</span>
        <span class="keyword1">then</span> RETURN <span class="main">(</span>merge_cstatus <span class="bound">st'</span> <span class="bound">eq</span><span class="main">,</span>
          <span class="bound">ùí±</span><span class="main">,</span> fmupd <span class="main">(</span>new_id <span class="bound">st</span><span class="main">)</span> <span class="bound">r</span> <span class="bound">A</span><span class="main">)</span>
        <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">eq</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span>
   <span class="main">}</span>
   <span class="main">|</span> Del <span class="main"><span class="bound">_</span></span> <span class="main">‚áí</span>
       <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">eq</span> <span class="main">‚Üê</span> check_del_l <span class="bound">spec</span> <span class="bound">A</span> <span class="main">(</span>pac_src1 <span class="bound">st</span><span class="main">)</span><span class="main">;</span>
        <span class="keyword1">let</span> <span class="main"><span class="bound">_</span></span> <span class="main">=</span> <span class="bound">eq</span><span class="main">;</span>
        <span class="keyword1">if</span> <span class="main">¬¨</span>is_cfailed <span class="bound">eq</span>
        <span class="keyword1">then</span> RETURN <span class="main">(</span>merge_cstatus <span class="bound">st'</span> <span class="bound">eq</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> fmdrop <span class="main">(</span>pac_src1 <span class="bound">st</span><span class="main">)</span> <span class="bound">A</span><span class="main">)</span>
        <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">eq</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span>
   <span class="main">}</span>
   <span class="main">|</span> Mult <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">‚áí</span>
       <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">r</span> <span class="main">‚Üê</span> full_normalize_poly <span class="main">(</span>pac_res <span class="bound">st</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">q</span> <span class="main">‚Üê</span> full_normalize_poly <span class="main">(</span>pac_mult <span class="bound">st</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">eq</span> <span class="main">‚Üê</span> check_mult_l <span class="bound">spec</span> <span class="bound">A</span> <span class="bound">ùí±</span> <span class="main">(</span>pac_src1 <span class="bound">st</span><span class="main">)</span> <span class="bound">q</span> <span class="main">(</span>new_id <span class="bound">st</span><span class="main">)</span> <span class="bound">r</span><span class="main">;</span>
        <span class="keyword1">let</span> <span class="main"><span class="bound">_</span></span> <span class="main">=</span> <span class="bound">eq</span><span class="main">;</span>
        <span class="keyword1">if</span> <span class="main">¬¨</span>is_cfailed <span class="bound">eq</span>
        <span class="keyword1">then</span> RETURN <span class="main">(</span>merge_cstatus <span class="bound">st'</span> <span class="bound">eq</span><span class="main">,</span>
          <span class="bound">ùí±</span><span class="main">,</span> fmupd <span class="main">(</span>new_id <span class="bound">st</span><span class="main">)</span> <span class="bound">r</span> <span class="bound">A</span><span class="main">)</span>
        <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">eq</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span>
   <span class="main">}</span>
   <span class="main">|</span> Extension <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">‚áí</span>
       <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">r</span> <span class="main">‚Üê</span> full_normalize_poly <span class="main">(</span><span class="main">(</span><span class="main">[</span>new_var <span class="bound">st</span><span class="main">]</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>pac_res <span class="bound">st</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        <span class="main">(</span><span class="bound">eq</span><span class="main">)</span> <span class="main">‚Üê</span> check_extension_l <span class="bound">spec</span> <span class="bound">A</span> <span class="bound">ùí±</span> <span class="main">(</span>new_id <span class="bound">st</span><span class="main">)</span> <span class="main">(</span>new_var <span class="bound">st</span><span class="main">)</span> <span class="bound">r</span><span class="main">;</span>
        <span class="keyword1">if</span> <span class="main">¬¨</span>is_cfailed <span class="bound">eq</span>
        <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
          RETURN <span class="main">(</span><span class="bound">st'</span><span class="main">,</span>
            insert <span class="main">(</span>new_var <span class="bound">st</span><span class="main">)</span> <span class="bound">ùí±</span><span class="main">,</span> fmupd <span class="main">(</span>new_id <span class="bound">st</span><span class="main">)</span> <span class="bound">r</span> <span class="bound">A</span><span class="main">)</span><span class="main">}</span>
        <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">eq</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span>
   <span class="main">}</span>
 <span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pac_step_rel_raw_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span> <span class="free">V</span><span class="main">,</span> <span class="free">R</span><span class="main">‚ü©</span> pac_step_rel_raw <span class="main">=</span> pac_step_rel_raw <span class="free">K</span> <span class="free">V</span> <span class="free">R</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> relAPP_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mononoms_equal_up_to_reorder</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">mononoms_equal_up_to_reorder</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">‚ü∑</span>
     map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span>  <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>‚Ä∫</span></span>


 <span class="keyword1"><span class="command">definition</span></span> <span class="entity">normalize_poly_l</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">normalize_poly_l</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">Œª</span><span class="bound">p'</span><span class="main">.</span>
     normalize_poly_p<span class="main"><span class="hidden">‚áß</span><sup>*</sup><span class="hidden">‚áß</span><sup>*</sup></span> <span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">`#</span> mset <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">`#</span> mset <span class="bound">p'</span><span class="main">)</span> <span class="main">‚àß</span>
     <span class="main">0</span> <span class="main">‚àâ#</span> snd <span class="main">`#</span> mset <span class="bound">p'</span> <span class="main">‚àß</span>
     sorted_wrt <span class="main">(</span>rel2p <span class="main">(</span>term_order_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">)</span><span class="main">)</span> <span class="bound">p'</span> <span class="main">‚àß</span>
     <span class="main">(</span><span class="main">‚àÄ</span> <span class="bound">x</span> <span class="main">‚àà</span> mononoms <span class="bound">p'</span><span class="main">.</span> sorted_wrt <span class="main">(</span>rel2p var_order_rel<span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">remap_polys_l_dom_err</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπstring nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">remap_polys_l_dom_err</span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">Œª</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">remap_polys_l</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπllist_polynomial <span class="main">‚áí</span> string set <span class="main">‚áí</span> <span class="main">(</span>nat<span class="main">,</span> llist_polynomial<span class="main">)</span> fmap <span class="main">‚áí</span>
   <span class="main">(</span><span class="main">_</span> code_status <span class="main">√ó</span> string set <span class="main">√ó</span> <span class="main">(</span>nat<span class="main">,</span> llist_polynomial<span class="main">)</span> fmap<span class="main">)</span> nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">remap_polys_l</span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">ùí±</span> <span class="bound">A</span><span class="main">.</span> <span class="keyword1">do</span><span class="main">{</span>
   <span class="bound">dom</span> <span class="main">‚Üê</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="bound">dom</span><span class="main">.</span> set_mset <span class="main">(</span>dom_m <span class="bound">A</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="bound">dom</span> <span class="main">‚àß</span> finite <span class="bound">dom</span><span class="main">)</span><span class="main">;</span>
   <span class="bound">failed</span> <span class="main">‚Üê</span> SPEC<span class="main">(</span><span class="main">Œª</span><span class="main"><span class="bound">_</span></span><span class="main">::</span>bool<span class="main">.</span> True<span class="main">)</span><span class="main">;</span>
   <span class="keyword1">if</span> <span class="bound">failed</span>
   <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">c</span> <span class="main">‚Üê</span> remap_polys_l_dom_err<span class="main">;</span>
      RETURN <span class="main">(</span>error_msg <span class="main">(</span><span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> fmempty<span class="main">)</span>
   <span class="main">}</span>
   <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">‚Üê</span> FOREACH <span class="bound">dom</span>
       <span class="main">(</span><span class="main">Œª</span><span class="bound">i</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span>  <span class="bound">A'</span><span class="main">)</span><span class="main">.</span>
          <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">‚àà#</span> dom_m <span class="bound">A</span>
          <span class="keyword1">then</span>  <span class="keyword1">do</span> <span class="main">{</span>
            <span class="bound">p</span> <span class="main">‚Üê</span> full_normalize_poly <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="bound">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
            <span class="bound">eq</span> <span class="main">‚Üê</span> weak_equality_l <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span><span class="main">;</span>
            <span class="bound">ùí±</span> <span class="main">‚Üê</span> RETURN<span class="main">(</span><span class="bound">ùí±</span> <span class="main">‚à™</span> vars_llist <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="bound">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
            RETURN<span class="main">(</span><span class="bound">b</span> <span class="main">‚à®</span> <span class="bound">eq</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> fmupd <span class="bound">i</span> <span class="bound">p</span> <span class="bound">A'</span><span class="main">)</span>
          <span class="main">}</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A'</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span>False<span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> fmempty<span class="main">)</span><span class="main">;</span>
     RETURN <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> CFOUND <span class="keyword1">else</span> CSUCCESS<span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span>
 <span class="main">}</span><span class="main">}</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PAC_checker_l</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">PAC_checker_l</span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚Üê</span> <span class="keyword1">WHILE<span class="hidden">‚á©</span><sub>T</sub></span>
       <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="main">¬¨</span>is_cfailed <span class="bound">b</span> <span class="main">‚àß</span> <span class="bound">n</span> <span class="main">‚â†</span> <span class="main">[]</span><span class="main">)</span>
       <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="main">(</span><span class="bound">bA</span><span class="main">)</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
          ASSERT<span class="main">(</span><span class="bound">n</span> <span class="main">‚â†</span> <span class="main">[]</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">S</span> <span class="main">‚Üê</span> PAC_checker_l_step <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="bound">bA</span> <span class="main">(</span>hd <span class="bound">n</span><span class="main">)</span><span class="main">;</span>
          RETURN <span class="main">(</span><span class="bound">S</span><span class="main">,</span> tl <span class="bound">n</span><span class="main">)</span>
        <span class="main">}</span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="bound">S</span>
  <span class="main">}</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπCorrectness‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπWe now enter the locale to reason about polynomials directly.‚Ä∫</span></span>

<span class="keyword1"><span class="command">context</span></span> poly_embed
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">pac_step_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">pac_step_rel</span> <span class="main">‚â°</span> p2rel <span class="main">(</span><span class="main">‚ü®</span>Id<span class="main">,</span> fully_unsorted_poly_rel <span class="keyword1">O</span> mset_poly_rel<span class="main">,</span> var_rel<span class="main">‚ü©</span> pac_step_rel_raw<span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fmap_polys_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">fmap_polys_rel</span> <span class="main">‚â°</span> <span class="main">‚ü®</span>nat_rel<span class="main">,</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel<span class="main">‚ü©</span>fmap_rel‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">‚Äπnormalize_poly_p <span class="free">s0</span> <span class="free">s</span> <span class="main">‚üπ</span>
        <span class="main">(</span><span class="free">s0</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span> <span class="main">‚àà</span> mset_poly_rel <span class="main">‚üπ</span>
        <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span> <span class="main">‚àà</span> mset_poly_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_poly_rel_def normalize_poly_p_poly_of_mset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_poly_of_vars<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπvars <span class="main">(</span>poly_of_vars <span class="free">a</span> <span class="main">::</span> int mpoly<span class="main">)</span> <span class="main">‚äÜ</span> <span class="main">(</span><span class="free">œÜ</span> <span class="main">`</span> set_mset <span class="free">a</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_mult_Var<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_polynomial_of_mset<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπvars <span class="main">(</span>polynomial_of_mset <span class="free">za</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="main">‚ãÉ</span><span class="main">(</span>image <span class="free">œÜ</span> <span class="main">`</span> <span class="main">(</span>set_mset <span class="keyword1">o</span> fst<span class="main">)</span> <span class="main">`</span> set_mset <span class="free">za</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">za</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> vars_poly_of_vars
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_vars_addE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_mult_Const <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fully_unsorted_poly_rel_vars_subset_vars_llist<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> fully_unsorted_poly_rel <span class="keyword1">O</span> mset_poly_rel <span class="main">‚üπ</span> vars <span class="free">B</span> <span class="main">‚äÜ</span> <span class="free">œÜ</span> <span class="main">`</span> vars_llist <span class="free">A</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fully_unsorted_poly_list_rel_def mset_poly_rel_def
      set_rel_def var_rel_def br_def vars_llist_def list_rel_append2 list_rel_append1
      list_rel_split_right_iff list_mset_rel_def image_iff
      unsorted_term_poly_list_rel_def list_rel_split_left_iff
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_rev_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ vars_polynomial_of_mset<span class="main"><span class="main">]</span></span> split_list
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> multi_member_split
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="main">_</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπadd_mset <span class="main">_</span> <span class="main">_</span>‚Ä∫</span></span> <span class="quoted">set_mset</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fully_unsorted_poly_rel_extend_vars<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> fully_unsorted_poly_rel <span class="keyword1">O</span> mset_poly_rel <span class="main">‚üπ</span>
  <span class="main">(</span><span class="free">x1c</span><span class="main">,</span> <span class="free">x1a</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel <span class="main">‚üπ</span>
   RETURN <span class="main">(</span><span class="free">x1c</span> <span class="main">‚à™</span> vars_llist <span class="free">A</span><span class="main">)</span>
    <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">(</span><span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel<span class="main">)</span>
       <span class="main">(</span>SPEC <span class="main">(</span><span class="main">(‚äÜ)</span> <span class="main">(</span><span class="free">x1a</span> <span class="main">‚à™</span> vars <span class="main">(</span><span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> fully_unsorted_poly_rel_vars_subset_vars_llist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> RETURN_RES_refine_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x1a</span> <span class="main">‚à™</span> <span class="free">œÜ</span> <span class="main">`</span> vars_llist <span class="free">A</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_rel_def var_rel_def br_def
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fully_unsorted_poly_rel_vars_subset_vars_llist<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> remap_polys_l_remap_polys<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    AB<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>nat_rel<span class="main">,</span> fully_unsorted_poly_rel <span class="keyword1">O</span> mset_poly_rel<span class="main">‚ü©</span>fmap_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    spec<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">spec</span><span class="main">,</span> <span class="free">spec'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    V<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> <span class="free">ùí±'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπremap_polys_l <span class="free">spec</span> <span class="free">ùí±</span> <span class="free">A</span> <span class="main">‚â§</span>
     <span class="main">‚áì</span><span class="main">(</span>code_status_status_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> <span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> fmap_polys_rel<span class="main">)</span> <span class="main">(</span>remap_polys <span class="free">spec'</span> <span class="free">ùí±'</span> <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="var">?R</span> <span class="main">_</span>‚Ä∫</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπinj_on id <span class="main">(</span><span class="skolem">dom</span> <span class="main">::</span> nat set<span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">dom</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span> <span class="main">‚üπ</span>
     <span class="main">(</span><span class="main">‚ãÄ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x</span><span class="main">)</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">‚àà</span> fully_unsorted_poly_rel <span class="main">‚üπ</span>
       <span class="main">(</span><span class="bound">p</span><span class="main">,</span> the <span class="main">(</span>fmlookup <span class="free">B</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> mset_poly_rel <span class="main">‚üπ</span> <span class="skolem">thesis</span><span class="main">)</span> <span class="main">‚üπ</span>
     <span class="skolem">thesis</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">thesis</span>
     <span class="keyword1"><span class="command">using</span></span> fmap_rel_nat_the_fmlookup<span class="main">[</span><span class="operator">OF</span> AB<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> fmap_rel_nat_rel_dom_m<span class="main">[</span><span class="operator">OF</span> AB<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> full_normalize_poly<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπfull_normalize_poly <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">A</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>
       <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">(</span>sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel<span class="main">)</span>
          <span class="main">(</span>SPEC
            <span class="main">(</span><span class="main">Œª</span><span class="bound">p</span><span class="main">.</span> the <span class="main">(</span>fmlookup <span class="free">B</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">-</span> <span class="bound">p</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool <span class="main">‚àß</span>
                 vars <span class="bound">p</span> <span class="main">‚äÜ</span> vars <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free">B</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> x_dom<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x</span> <span class="main">‚àà#</span> dom_m <span class="free">A</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">‚àà</span> Id‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">x'</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> H<span class="main"><span class="main">[</span></span><span class="operator">OF</span> x_dom<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> full_normalize_poly_normalize_poly_p<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">unfolding</span></span> conc_fun_chain<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ref_two_step'<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> RES_refine<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rtranclp_normalize_poly_p_poly_of_mset
          mset_poly_rel_def ideal.span_zero<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> H'<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">pa</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel <span class="main">‚üπ</span>
     weak_equality_l <span class="skolem">p</span> <span class="free">spec</span> <span class="main">‚â§</span> SPEC <span class="main">(</span><span class="main">Œª</span><span class="bound">eqa</span><span class="main">.</span> <span class="bound">eqa</span> <span class="main">‚ü∂</span> <span class="skolem">pa</span> <span class="main">=</span> <span class="free">spec'</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">pa</span>
    <span class="keyword1"><span class="command">using</span></span> spec <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> weak_equality_l_def weak_equality_spec_def
        list_mset_rel_def br_def mset_poly_rel_def
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_rel_term_poly_list_rel_same_rightD sorted_poly_list_relD<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> emp<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">ùí±</span><span class="main">,</span> <span class="skolem">ùí±'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel <span class="main">‚üπ</span>
    <span class="main">(</span><span class="main">(</span>False<span class="main">,</span> <span class="skolem">ùí±</span><span class="main">,</span> fmempty<span class="main">)</span><span class="main">,</span> False<span class="main">,</span> <span class="skolem">ùí±'</span><span class="main">,</span> fmempty<span class="main">)</span> <span class="main">‚àà</span> bool_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> <span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> fmap_polys_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ùí±</span> <span class="skolem">ùí±'</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> remap_polys_l_def remap_polys_l_dom_err_def
      remap_polys_def prod.case
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> full_normalize_poly fmap_rel_fmupd_fmap_rel<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> error_msg_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> emp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> V <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> H'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fully_unsorted_poly_rel_extend_vars<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fmap_rel_nat_the_fmlookup<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fmap_rel_fmupd_fmap_rel<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fmap_rel_fmupd_fmap_rel<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> fref_to_Down_curry<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>uncurry <span class="free">f</span><span class="main">,</span> uncurry <span class="free">g</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">[</span><span class="free">P</span><span class="keyword1">]<span class="hidden">‚á©</span><sub>f</sub></span> <span class="free">A</span> <span class="main">‚Üí</span> <span class="main">‚ü®</span><span class="free">B</span><span class="main">‚ü©</span>nres_rel <span class="main">‚üπ</span>
     <span class="main">(</span><span class="main">‚ãÄ</span><span class="bound">x</span> <span class="bound">x'</span> <span class="bound">y</span> <span class="bound">y'</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">y'</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">y'</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">A</span> <span class="main">‚üπ</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="free">B</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x'</span> <span class="bound">y'</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fref_def uncurry_def nres_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> weak_equality_spec_weak_equality<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> mset_poly_rel <span class="main">‚üπ</span>
    <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span> <span class="main">‚àà</span> mset_poly_rel <span class="main">‚üπ</span>
    weak_equality_spec <span class="free">p</span> <span class="free">r</span> <span class="main">‚â§</span> weak_equality <span class="free">p'</span> <span class="free">r'</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> weak_equality_spec_def weak_equality_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_poly_rel_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> weak_equality_l_weak_equality_l'<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπweak_equality_l <span class="free">p</span> <span class="free">q</span> <span class="main">‚â§</span> <span class="main">‚áì</span> bool_rel <span class="main">(</span>weak_equality <span class="free">p'</span> <span class="free">q'</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">q'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">p</span> <span class="free">p'</span> <span class="free">q</span> <span class="free">q'</span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> weak_equality_l_weak_equality_spec<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> fref_to_Down_curry<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span>
         ref_two_step'
         weak_equality_spec_weak_equality
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> conc_fun_chain<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> error_msg_ne_SUCCES<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπerror_msg <span class="free">i</span> <span class="free">m</span> <span class="main">‚â†</span> CSUCCESS‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπerror_msg <span class="free">i</span> <span class="free">m</span> <span class="main">‚â†</span> CFOUND‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπis_cfailed <span class="main">(</span>error_msg <span class="free">i</span> <span class="free">m</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">¬¨</span>is_cfound <span class="main">(</span>error_msg <span class="free">i</span> <span class="free">m</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> error_msg_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_poly_rel_vars_llist<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel <span class="main">‚üπ</span>
   vars <span class="free">r'</span> <span class="main">‚äÜ</span> <span class="free">œÜ</span> <span class="main">`</span> vars_llist <span class="free">r</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_poly_rel_def
      set_rel_def var_rel_def br_def vars_llist_def list_rel_append2 list_rel_append1
      list_rel_split_right_iff list_mset_rel_def image_iff sorted_poly_list_rel_wrt_def
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_rev_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ vars_polynomial_of_mset<span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> split_list<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_append1
      term_poly_list_rel_def eq_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπmset <span class="main">_</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span>
      list_rel_split_right_iff list_rel_append2 list_rel_split_left_iff
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπmset <span class="main">_</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπadd_mset <span class="main">_</span> <span class="main">_</span>‚Ä∫</span></span> <span class="quoted">set_mset</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> check_addition_l_check_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> fmap_polys_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> Id‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">q'</span><span class="main">)</span> <span class="main">‚àà</span> Id‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">i'</span><span class="main">)</span> <span class="main">‚àà</span> nat_rel‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">ùí±'</span><span class="main">,</span> <span class="free">ùí±</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‚Äπcheck_addition_l <span class="free">spec</span> <span class="free">A</span> <span class="free">ùí±'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">i</span> <span class="free">r</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">{</span><span class="main">(</span><span class="bound">st</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">¬¨</span>is_cfailed <span class="bound">st</span> <span class="main">‚ü∑</span> <span class="bound">b</span><span class="main">)</span> <span class="main">‚àß</span>
       <span class="main">(</span>is_cfound <span class="bound">st</span> <span class="main">‚ü∂</span> <span class="free">spec</span> <span class="main">=</span> <span class="free">r</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span>check_add <span class="free">B</span> <span class="free">ùí±</span> <span class="free">p'</span> <span class="free">q'</span> <span class="free">i'</span> <span class="free">r'</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπadd_poly_l <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">(</span>sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel<span class="main">)</span> <span class="main">(</span>add_poly_spec <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">p'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span>
      <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">p'</span> <span class="skolem">q</span> <span class="skolem">q'</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_poly_l_add_poly_p'<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span> ref_two_step'
         add_poly_p'_add_poly_spec
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> conc_fun_chain<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> check_addition_l_def
      check_not_equal_dom_err_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ref_two_step'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> check_add_alt_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_rcg</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> sorted_poly_rel_vars_llist<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_rel_def var_rel_def br_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> weak_equality_l_def bind_RES_RETURN_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> check_del_l_check_del<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> fmap_polys_rel <span class="main">‚üπ</span> <span class="main">(</span><span class="free">x3</span><span class="main">,</span> <span class="free">x3a</span><span class="main">)</span> <span class="main">‚àà</span> Id <span class="main">‚üπ</span> check_del_l <span class="free">spec</span> <span class="free">A</span> <span class="main">(</span>pac_src1 <span class="main">(</span>Del <span class="free">x3</span><span class="main">)</span><span class="main">)</span>
    <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">{</span><span class="main">(</span><span class="bound">st</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">¬¨</span>is_cfailed <span class="bound">st</span> <span class="main">‚ü∑</span> <span class="bound">b</span><span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">b</span> <span class="main">‚ü∂</span> <span class="bound">st</span> <span class="main">=</span> CSUCCESS<span class="main">)</span><span class="main">}</span> <span class="main">(</span>check_del <span class="free">B</span> <span class="main">(</span>pac_src1 <span class="main">(</span>Del <span class="free">x3a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> check_del_l_def check_del_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_vcg</span> lhs_step_If RETURN_SPEC_refine<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmap_rel_nat_rel_dom_m bind_RES_RETURN_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> check_mult_l_check_mult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> fmap_polys_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">q'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> Id‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">i'</span><span class="main">)</span> <span class="main">‚àà</span> nat_rel‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> <span class="free">ùí±'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‚Äπcheck_mult_l <span class="free">spec</span> <span class="free">A</span> <span class="free">ùí±</span> <span class="free">p</span> <span class="free">q</span> <span class="free">i</span> <span class="free">r</span> <span class="main">‚â§</span> <span class="main">‚áì</span>  <span class="main">{</span><span class="main">(</span><span class="bound">st</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">¬¨</span>is_cfailed <span class="bound">st</span> <span class="main">‚ü∑</span> <span class="bound">b</span><span class="main">)</span> <span class="main">‚àß</span>
       <span class="main">(</span>is_cfound <span class="bound">st</span> <span class="main">‚ü∂</span> <span class="free">spec</span> <span class="main">=</span> <span class="free">r</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span>check_mult <span class="free">B</span> <span class="free">ùí±'</span> <span class="free">p'</span> <span class="free">q'</span> <span class="free">i'</span> <span class="free">r'</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπmult_poly_full <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">(</span>sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel<span class="main">)</span> <span class="main">(</span>mult_poly_spec <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">p'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span>
      <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">p'</span> <span class="skolem">q</span> <span class="skolem">q'</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_poly_full_mult_poly_p'<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span> ref_two_step'
         mult_poly_p'_mult_poly_spec
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> conc_fun_chain<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> check_mult_l_def
      check_mult_l_mult_err_def check_mult_l_dom_err_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ref_two_step'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> check_mult_alt_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_rcg</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> sorted_poly_rel_vars_llist<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_rel_def var_rel_def br_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> weak_equality_l_def bind_RES_RETURN_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> normalize_poly_normalize_poly_spec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">‚àà</span> unsorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‚Äπnormalize_poly <span class="free">r</span> <span class="main">‚â§</span> <span class="main">‚áì</span><span class="main">(</span>sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel<span class="main">)</span> <span class="main">(</span>normalize_poly_spec <span class="free">t</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    rs<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">‚àà</span> unsorted_poly_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    st<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">‚àà</span> mset_poly_rel‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> normalize_poly_normalize_poly_p<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> rs<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">use</span> st <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‚Äπ<span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main">!</span><span class="main">:</span> rtranclp_normalize_poly_p_poly_of_mset
      <span class="quasi_keyword">intro</span><span class="main">!</span><span class="main">:</span> ref_two_step' RES_refine exI<span class="main">[</span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
      <span class="quasi_keyword">simp</span><span class="main">:</span> normalize_poly_spec_def ideal.span_zero mset_poly_rel_def
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main">:</span> conc_fun_chain‚Ä∫</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> remove1_list_rel<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free">R</span><span class="main">‚ü©</span> list_rel <span class="main">‚üπ</span>
  <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">R</span> <span class="main">‚üπ</span>
  IS_RIGHT_UNIQUE <span class="free">R</span> <span class="main">‚üπ</span>
  IS_LEFT_UNIQUE <span class="free">R</span> <span class="main">‚üπ</span>
  <span class="main">(</span>remove1 <span class="free">a</span> <span class="free">xs</span><span class="main">,</span> remove1 <span class="free">b</span> <span class="free">ys</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free">R</span><span class="main">‚ü©</span>list_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_rel_induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> single_valued_def IS_LEFT_UNIQUE_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> remove1_list_rel2<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free">R</span><span class="main">‚ü©</span> list_rel <span class="main">‚üπ</span>
  <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">R</span> <span class="main">‚üπ</span>
  <span class="main">(</span><span class="main">‚ãÄ</span><span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">R</span> <span class="main">‚üπ</span> <span class="bound">c</span> <span class="main">=</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚üπ</span>
  <span class="main">(</span><span class="main">‚ãÄ</span><span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚àà</span> <span class="free">R</span> <span class="main">‚üπ</span> <span class="bound">c</span> <span class="main">=</span> <span class="free">a</span><span class="main">)</span> <span class="main">‚üπ</span>
  <span class="main">(</span>remove1 <span class="free">a</span> <span class="free">xs</span><span class="main">,</span> remove1 <span class="free">b</span> <span class="free">ys</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free">R</span><span class="main">‚ü©</span>list_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_rel_induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‚Äπ<span class="operator">simp</span> <span class="main">(</span><span class="quasi_keyword">no_asm</span><span class="main">)</span>‚Ä∫</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> list_rel_simp<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> remove1.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> remove1_sorted_poly_rel_mset_poly_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">‚àà</span> set <span class="free">r</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>remove1 <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="free">r</span><span class="main">,</span> <span class="free">r'</span> <span class="main">-</span> Var <span class="main">(</span><span class="free">œÜ</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>
          <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel‚Ä∫</span></span>
     <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">aa</span><span class="main">.</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="bound">aa</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel <span class="main">‚ü∑</span> <span class="bound">aa</span> <span class="main">=</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">aa</span><span class="main">.</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="bound">aa</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel <span class="main">‚üπ</span> <span class="bound">aa</span> <span class="main">=</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span>‚Ä∫</span></span>
     <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">aa</span><span class="main">.</span> <span class="main">(</span><span class="bound">aa</span><span class="main">,</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel <span class="main">‚üπ</span> <span class="bound">aa</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> single_valued_def IS_LEFT_UNIQUE_def
       term_poly_list_rel_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚ÄπConst <span class="main">(</span><span class="main">1</span> <span class="main">::</span> int<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> int mpoly<span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Const.abs_eq Const<span class="hidden">‚á©</span><sub>0</sub>_one one_mpoly.abs_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπsorted_wrt term_order <span class="main">(</span>map fst <span class="free">r</span><span class="main">)</span> <span class="main">‚üπ</span>
         sorted_wrt term_order <span class="main">(</span>map fst <span class="main">(</span>remove1 <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπdistinct <span class="main">(</span>map fst <span class="free">r</span><span class="main">)</span> <span class="main">‚üπ</span> distinct <span class="main">(</span>map fst <span class="main">(</span>remove1 <span class="skolem">x</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_remove1D<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="skolem">ya</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel <span class="main">‚üπ</span>
         polynomial_of_mset <span class="main">(</span>mset <span class="skolem">ya</span><span class="main">)</span> <span class="main">-</span>  Var <span class="main">(</span><span class="free">œÜ</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span>
         polynomial_of_mset <span class="main">(</span>remove1_mset <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>mset <span class="skolem">ya</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ya</span>
    <span class="keyword1"><span class="command">using</span></span> assms
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_append1 list_rel_split_right_iff
       <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> split_list<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> relcompEpair<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> za<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπremove1_mset <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="improper">za</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> relcompI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_poly_rel_def sorted_poly_list_rel_wrt_def Collect_eq_comp'
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> relcompI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπremove1 <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">ya</span>‚Ä∫</span></span>
        <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">ya</span> <span class="main"><span class="main"><span class="main">::</span></span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>string multiset <span class="main">√ó</span> int<span class="main">)</span> list‚Ä∫</span></span><span class="main"><span class="main">]</span></span>  remove1_list_rel2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_mset_rel_def br_def
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_diffD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> remove1_sorted_poly_rel_mset_poly_rel_minus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">‚àà</span> set <span class="free">r</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>remove1 <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">r</span><span class="main">,</span> <span class="free">r'</span> <span class="main">+</span> Var <span class="main">(</span><span class="free">œÜ</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>
          <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel‚Ä∫</span></span>
     <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">aa</span><span class="main">.</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="bound">aa</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel <span class="main">‚ü∑</span> <span class="bound">aa</span> <span class="main">=</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">aa</span><span class="main">.</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="bound">aa</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel <span class="main">‚üπ</span> <span class="bound">aa</span> <span class="main">=</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span>‚Ä∫</span></span>
     <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">aa</span><span class="main">.</span> <span class="main">(</span><span class="bound">aa</span><span class="main">,</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel <span class="main">‚üπ</span> <span class="bound">aa</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> single_valued_def IS_LEFT_UNIQUE_def
       term_poly_list_rel_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚ÄπConst <span class="main">(</span><span class="main">1</span> <span class="main">::</span> int<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> int mpoly<span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Const.abs_eq Const<span class="hidden">‚á©</span><sub>0</sub>_one one_mpoly.abs_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπsorted_wrt term_order <span class="main">(</span>map fst <span class="free">r</span><span class="main">)</span> <span class="main">‚üπ</span>
         sorted_wrt term_order <span class="main">(</span>map fst <span class="main">(</span>remove1 <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπdistinct <span class="main">(</span>map fst <span class="free">r</span><span class="main">)</span> <span class="main">‚üπ</span> distinct <span class="main">(</span>map fst <span class="main">(</span>remove1 <span class="skolem">x</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> img_fst in_set_remove1D<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="skolem">ya</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel <span class="main">‚üπ</span>
         polynomial_of_mset <span class="main">(</span>mset <span class="skolem">ya</span><span class="main">)</span> <span class="main">+</span>  Var <span class="main">(</span><span class="free">œÜ</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span>
         polynomial_of_mset <span class="main">(</span>remove1_mset <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>mset <span class="skolem">ya</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ya</span>
    <span class="keyword1"><span class="command">using</span></span> assms
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_append1 list_rel_split_right_iff
       <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> split_list<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> relcompEpair<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> za<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπremove1_mset <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="improper">za</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> relcompI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_poly_rel_def sorted_poly_list_rel_wrt_def Collect_eq_comp'
       <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_diffD
       <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> relcompI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπremove1 <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="skolem">ya</span>‚Ä∫</span></span>
         <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">ya</span> <span class="main"><span class="main"><span class="main">::</span></span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>string multiset <span class="main">√ó</span> int<span class="main">)</span> list‚Ä∫</span></span><span class="main"><span class="main">]</span></span>  remove1_list_rel2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_mset_rel_def br_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> insert_var_rel_set_rel<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> <span class="free">ùí±'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel <span class="main">‚üπ</span>
  <span class="main">(</span><span class="free">yb</span><span class="main">,</span> <span class="free">x2</span><span class="main">)</span> <span class="main">‚àà</span> var_rel <span class="main">‚üπ</span>
  <span class="main">(</span>insert <span class="free">yb</span> <span class="free">ùí±</span><span class="main">,</span> insert <span class="free">x2</span> <span class="free">ùí±'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> var_rel_def set_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> var_rel_set_rel_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> <span class="free">ùí±'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel <span class="main">‚üπ</span>
  <span class="main">(</span><span class="free">yb</span><span class="main">,</span> <span class="free">x2</span><span class="main">)</span> <span class="main">‚àà</span> var_rel <span class="main">‚üπ</span>
  <span class="free">yb</span> <span class="main">‚àà</span> <span class="free">ùí±</span> <span class="main">‚ü∑</span> <span class="free">x2</span> <span class="main">‚àà</span>  <span class="free">ùí±'</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> œÜ_inj inj_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> var_rel_def set_rel_def br_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> check_extension_l_check_extension<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> fmap_polys_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">i'</span><span class="main">)</span> <span class="main">‚àà</span> nat_rel‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">ùí±</span><span class="main">,</span> <span class="free">ùí±'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">x'</span><span class="main">)</span> <span class="main">‚àà</span> var_rel‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‚Äπcheck_extension_l <span class="free">spec</span> <span class="free">A</span> <span class="free">ùí±</span> <span class="free">i</span> <span class="free">x</span> <span class="free">r</span> <span class="main">‚â§</span>
      <span class="main">‚áì</span><span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">st</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
        <span class="main">(</span><span class="main">¬¨</span>is_cfailed <span class="bound">st</span> <span class="main">‚ü∑</span> <span class="bound">b</span><span class="main">)</span> <span class="main">‚àß</span>
       <span class="main">(</span>is_cfound <span class="bound">st</span> <span class="main">‚ü∂</span> <span class="free">spec</span> <span class="main">=</span> <span class="free">r</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span>check_extension <span class="free">B</span> <span class="free">ùí±'</span> <span class="free">i'</span> <span class="free">x'</span> <span class="free">r'</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">=</span> <span class="free">œÜ</span> <span class="free">x</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> var_rel_def br_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπmult_poly_full <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">(</span>sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel<span class="main">)</span> <span class="main">(</span>mult_poly_spec <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">p'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span>
      <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">p'</span> <span class="skolem">q</span> <span class="skolem">q'</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_poly_full_mult_poly_p'<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span> ref_two_step'
         mult_poly_p'_mult_poly_spec
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> conc_fun_chain<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπadd_poly_l <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">(</span>sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel<span class="main">)</span> <span class="main">(</span>add_poly_spec <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">p'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span>
      <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">p'</span> <span class="skolem">q</span> <span class="skolem">q'</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_poly_l_add_poly_p'<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span> ref_two_step'
         add_poly_p'_add_poly_spec
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> conc_fun_chain<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">l'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel <span class="main">‚üπ</span>
       <span class="main">(</span>map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l</span><span class="main">,</span> map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l'</span><span class="main">)</span>
       <span class="main">‚àà</span> <span class="main">‚ü®</span>term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l</span> <span class="skolem">l'</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">l'</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_rel_induct<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_mset_rel_def br_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">x2c</span><span class="main">,</span> <span class="skolem">za</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel <span class="keyword1">O</span> list_mset_rel <span class="main">‚üπ</span>
     <span class="main">(</span>map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x2c</span><span class="main">,</span>
        <span class="main">{#</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà#</span> <span class="skolem">za</span><span class="main">#}</span><span class="main">)</span>
       <span class="main">‚àà</span> <span class="main">‚ü®</span>term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel <span class="keyword1">O</span> list_mset_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x2c</span> <span class="skolem">za</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> y
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x2c</span></span> <span class="quoted"><span class="skolem">y</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_rel_induct<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_mset_rel_def br_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a ba aa l l'<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="improper">aa</span><span class="main">,</span> <span class="main">-</span> <span class="improper">ba</span><span class="main">)</span> <span class="main">#</span> map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="improper">l'</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> relcompI<span class="main">)</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> fst <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> uminus<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">x2c</span><span class="main">,</span> <span class="skolem">x2a</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel <span class="main">‚üπ</span>
       <span class="main">(</span>map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x2c</span><span class="main">,</span>
        <span class="main">-</span> <span class="skolem">x2a</span><span class="main">)</span>
       <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x2c</span> <span class="skolem">x2a</span> <span class="skolem">x1c</span> <span class="skolem">x1a</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_wrt_def
      mset_poly_rel_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">`#</span> <span class="improper">za</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> relcompI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_wrt_def
      mset_poly_rel_def comp_def polynomial_of_mset_uminus<span class="main">)</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_poly_list_rel_wrt_def
      mset_poly_rel_def list_mset_rel_def br_def
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> relcompI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{#}</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">unfolding</span></span> check_extension_l_def
       check_extension_l_dom_err_def
       check_extension_l_no_new_var_err_def
       check_extension_l_new_var_multiple_err_def
       check_extension_l_side_cond_err_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ref_two_step'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> check_extension_alt_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> <span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> var_rel_set_rel_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> var_rel_set_rel_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x'</span> <span class="main">=</span> <span class="free">œÜ</span> <span class="free">x</span>‚Ä∫</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> remove1_sorted_poly_rel_mset_poly_rel_minus<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> sorted_poly_rel_vars_llist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">r</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">r'</span>‚Ä∫</span></span><span class="main">]</span> assms
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_rel_def var_rel_def br_def
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sorted_poly_rel_vars_llist<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> uminus<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> full_normalize_poly_diff_ideal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">dom</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> fully_unsorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‚Äπfull_normalize_poly <span class="free">p</span>
    <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">(</span>sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel<span class="main">)</span>
       <span class="main">(</span>normalize_poly_spec <span class="free">p'</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    pq<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">‚àà</span> fully_unsorted_poly_rel‚Ä∫</span></span>  <span class="keyword2"><span class="keyword">and</span></span> qp'<span class="main">:</span><span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">‚àà</span> mset_poly_rel‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">unfolding</span></span> normalize_poly_spec_def
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> full_normalize_poly_normalize_poly_p<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> pq<span class="main">)</span>
     <span class="keyword1"><span class="command">unfolding</span></span> conc_fun_chain<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ref_two_step'<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> RES_refine<span class="main">)</span>
       <span class="main">(</span><span class="operator">use</span> qp' <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‚Äπ<span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main">!</span><span class="main">:</span> rtranclp_normalize_poly_p_poly_of_mset
            <span class="quasi_keyword">simp</span><span class="main">:</span> mset_poly_rel_def ideal.span_zero‚Ä∫</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insort_key_rel_decomp<span class="main">:</span>
   <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÉ</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="bound">zs</span> <span class="main">‚àß</span> insort_key_rel <span class="free">R</span> <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a xs
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">a</span> <span class="main">#</span> <span class="main">_</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_rel_append_same_length<span class="main">:</span>
   <span class="quoted"><span class="quoted">‚Äπlength <span class="free">xs</span> <span class="main">=</span> length <span class="free">xs'</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">,</span> <span class="free">xs'</span> <span class="main">@</span> <span class="free">ys'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free">R</span><span class="main">‚ü©</span>list_rel <span class="main">‚ü∑</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free">R</span><span class="main">‚ü©</span>list_rel <span class="main">‚àß</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">ys'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free">R</span><span class="main">‚ü©</span>list_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_def list_all2_append2 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> term_poly_list_rel_list_relD<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">cs</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel <span class="main">‚üπ</span>
       <span class="free">cs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">ys</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_def list_rel_def list_all2_append list_all2_Cons1 list_all2_Cons2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> term_poly_list_rel_single<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">[</span><span class="free">x32</span><span class="main">]</span><span class="main">,</span> <span class="main">{#</span><span class="free">x32</span><span class="main">#}</span><span class="main">)</span> <span class="main">‚àà</span> term_poly_list_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_poly_list_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unsorted_poly_rel_list_rel_list_rel_uminus<span class="main">:</span>
   <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span><span class="main">,</span> <span class="free">yc</span><span class="main">)</span>
       <span class="main">‚àà</span> <span class="main">‚ü®</span>unsorted_term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel <span class="main">‚üπ</span>
       <span class="main">(</span><span class="free">r</span><span class="main">,</span> map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="free">yc</span><span class="main">)</span>
       <span class="main">‚àà</span> <span class="main">‚ü®</span>unsorted_term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">yc</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_relE3<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_poly_rel_minus<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">{#</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span> <span class="main">‚àà</span> mset_poly_rel <span class="main">‚üπ</span>
       <span class="main">(</span>mset <span class="free">yc</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span> <span class="main">‚àà</span> mset_poly_rel <span class="main">‚üπ</span>
       <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">yc</span><span class="main">)</span>
       <span class="main">‚àà</span> <span class="main">‚ü®</span>unsorted_term_poly_list_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel <span class="main">‚üπ</span>
       <span class="main">(</span>add_mset <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">yc</span><span class="main">)</span><span class="main">,</span>
        <span class="free">v'</span> <span class="main">+</span> <span class="free">r'</span><span class="main">)</span>
       <span class="main">‚àà</span> mset_poly_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r'</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_poly_rel_def polynomial_of_mset_uminus<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fully_unsorted_poly_rel_diff<span class="main">:</span>
   <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">[</span><span class="free">v</span><span class="main">]</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span> <span class="main">‚àà</span> fully_unsorted_poly_rel <span class="keyword1">O</span> mset_poly_rel <span class="main">‚üπ</span>
   <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">r'</span><span class="main">)</span> <span class="main">‚àà</span> fully_unsorted_poly_rel <span class="keyword1">O</span> mset_poly_rel <span class="main">‚üπ</span>
    <span class="main">(</span><span class="free">v</span> <span class="main">#</span> <span class="free">r</span><span class="main">,</span>
     <span class="free">v'</span> <span class="main">+</span> <span class="free">r'</span><span class="main">)</span>
    <span class="main">‚àà</span> fully_unsorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="improper">y</span> <span class="main">+</span> <span class="improper">ya</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> relcompI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fully_unsorted_poly_list_rel_def list_mset_rel_def br_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="improper">yb</span> <span class="main">@</span> <span class="improper">yc</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> relcompI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_relE3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unsorted_poly_rel_list_rel_list_rel_uminus mset_poly_rel_minus<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PAC_checker_l_step_PAC_checker_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">Ast</span><span class="main">,</span> <span class="free">Bst</span><span class="main">)</span> <span class="main">‚àà</span> code_status_status_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> <span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> fmap_polys_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">st</span><span class="main">,</span> <span class="free">st'</span><span class="main">)</span> <span class="main">‚àà</span> pac_step_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    spec<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">spec</span><span class="main">,</span> <span class="free">spec'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‚ÄπPAC_checker_l_step <span class="free">spec</span> <span class="free">Ast</span> <span class="free">st</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">(</span>code_status_status_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> <span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> fmap_polys_rel<span class="main">)</span> <span class="main">(</span>PAC_checker_step <span class="free">spec'</span> <span class="free">Bst</span> <span class="free">st'</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">ùí±</span></span> <span class="skolem"><span class="skolem">cst</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">ùí±'</span></span> <span class="skolem"><span class="skolem">cst'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   Ast<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">Ast</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">cst</span><span class="main">,</span> <span class="skolem">ùí±</span><span class="main">,</span> <span class="skolem">A</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   Bst<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">Bst</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">cst'</span><span class="main">,</span> <span class="skolem">ùí±'</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   ùí±<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">ùí±</span><span class="main">,</span> <span class="skolem">ùí±'</span><span class="main">)</span> <span class="main">‚àà</span>  <span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel‚Ä∫</span></span>  <span class="keyword2"><span class="keyword">and</span></span>
   AB<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">‚àà</span> fmap_polys_rel‚Ä∫</span></span>
     <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">cst</span><span class="main">,</span> <span class="skolem">cst'</span><span class="main">)</span> <span class="main">‚àà</span> code_status_status_rel‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Ast</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">Bst</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">ra</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel <span class="main">‚üπ</span>
       <span class="main">(</span><span class="skolem">eqa</span><span class="main">,</span> <span class="skolem">eqaa</span><span class="main">)</span>
       <span class="main">‚àà</span> <span class="main">{</span><span class="main">(</span><span class="bound">st</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">¬¨</span> is_cfailed <span class="bound">st</span> <span class="main">‚ü∑</span> <span class="bound">b</span><span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span>is_cfound <span class="bound">st</span> <span class="main">‚ü∂</span> <span class="free">spec</span> <span class="main">=</span> <span class="skolem">r</span><span class="main">)</span><span class="main">}</span> <span class="main">‚üπ</span>
       RETURN <span class="skolem">eqa</span>
       <span class="main">‚â§</span> <span class="main">‚áì</span> code_status_status_rel
          <span class="main">(</span>SPEC
            <span class="main">(</span><span class="main">Œª</span><span class="bound">st'</span><span class="main">.</span> <span class="main">(</span><span class="main">¬¨</span> is_failed <span class="bound">st'</span> <span class="main">‚àß</span>
                   is_found <span class="bound">st'</span> <span class="main">‚ü∂</span>
                    <span class="skolem">ra</span> <span class="main">-</span> <span class="free">spec'</span> <span class="main">‚àà</span> More_Modules.ideal polynomial_bool<span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
     <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span> <span class="skolem">ra</span> <span class="skolem">eqa</span> <span class="skolem">eqaa</span>
     <span class="keyword1"><span class="command">using</span></span> spec
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">eqa</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RETURN_RES_refine <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sorted_poly_list_relD
         <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_poly_rel_def ideal.span_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">eqa</span><span class="main">,</span> <span class="skolem">st'a</span><span class="main">)</span> <span class="main">‚àà</span> code_status_status_rel <span class="main">‚üπ</span>
       <span class="main">(</span>merge_cstatus <span class="skolem">cst</span> <span class="skolem">eqa</span><span class="main">,</span> merge_status <span class="skolem">cst'</span> <span class="skolem">st'a</span><span class="main">)</span>
       <span class="main">‚àà</span> code_status_status_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">eqa</span> <span class="skolem">st'a</span>
     <span class="keyword1"><span class="command">using</span></span> AB
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">eqa</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">st'a</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> code_status_status_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>merge_cstatus <span class="skolem">cst</span> CSUCCESS<span class="main">,</span> <span class="skolem">cst'</span><span class="main">)</span> <span class="main">‚àà</span> code_status_status_rel‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> AB
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">st</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> code_status_status_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">x32</span><span class="main">,</span> <span class="skolem">x32a</span><span class="main">)</span> <span class="main">‚àà</span> var_rel <span class="main">‚üπ</span>
        <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="skolem">x32</span><span class="main">]</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">::</span>int<span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">-</span>Var <span class="skolem">x32a</span><span class="main">)</span> <span class="main">‚àà</span> fully_unsorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x32</span> <span class="skolem">x32a</span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_poly_rel_def fully_unsorted_poly_list_rel_def list_mset_rel_def br_def
         unsorted_term_poly_list_rel_def var_rel_def Const_1_eq_1
       <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> relcompI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">{#</span><span class="main">(</span><span class="main">{#</span><span class="skolem">x32</span><span class="main">#}</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span> <span class="main">::</span> int<span class="main">)</span><span class="main">#}</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span>
         relcompI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">[</span><span class="main">(</span><span class="main">{#</span><span class="skolem">x32</span><span class="main">#}</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">]</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> H3<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">p</span> <span class="main">-</span> Var <span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span>Var <span class="skolem">a</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">p</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπint mpoly‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> PAC_checker_l_step_def PAC_checker_step_def Ast Bst prod.case
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">st</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">st'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> p2rel_def pac_step.case
      pac_step_rel_raw_def mem_Collect_eq prod.case pac_step_rel_raw.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> normalize_poly_normalize_poly_spec
        check_mult_l_check_mult check_addition_l_check_add
        full_normalize_poly_diff_ideal<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ùí±<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> code_status_status_rel_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fmap_rel_fmupd_fmap_rel
          fmap_rel_fmdrop_fmap_rel AB<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> normalize_poly_normalize_poly_spec
        check_mult_l_check_mult check_addition_l_check_add
        full_normalize_poly_diff_ideal<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> normalize_poly_spec_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> code_status_status_rel_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fmap_rel_fmupd_fmap_rel
          fmap_rel_fmdrop_fmap_rel AB<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> full_normalize_poly_diff_ideal
        check_extension_l_check_extension<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fully_unsorted_poly_rel_diff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">-</span>Var <span class="main">_</span> <span class="main">::</span> int mpoly‚Ä∫</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> H3<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def case_prod_beta<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> code_status_status_rel_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> AB
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fmap_rel_fmupd_fmap_rel insert_var_rel_set_rel<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> code_status_status_rel_def AB
          code_status.is_cfailed_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> normalize_poly_normalize_poly_spec
        check_del_l_check_del check_addition_l_check_add
        full_normalize_poly_diff_ideal<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> normalize_poly_spec_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fmap_rel_fmupd_fmap_rel
          fmap_rel_fmdrop_fmap_rel code_status_status_rel_def AB<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fmap_rel_fmupd_fmap_rel
          fmap_rel_fmdrop_fmap_rel AB<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> code_status_status_rel_discrim_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">x1a</span><span class="main">,</span> <span class="free">x1c</span><span class="main">)</span> <span class="main">‚àà</span> code_status_status_rel <span class="main">‚üπ</span> is_cfailed <span class="free">x1a</span> <span class="main">‚ü∑</span> is_failed <span class="free">x1c</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">x1a</span><span class="main">,</span> <span class="free">x1c</span><span class="main">)</span> <span class="main">‚àà</span> code_status_status_rel <span class="main">‚üπ</span> is_cfound <span class="free">x1a</span> <span class="main">‚ü∑</span> is_found <span class="free">x1c</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x1a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">x1c</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PAC_checker_l_PAC_checker<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> fmap_polys_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">st</span><span class="main">,</span> <span class="free">st'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>pac_step_rel<span class="main">‚ü©</span>list_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">spec</span><span class="main">,</span> <span class="free">spec'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">b'</span><span class="main">)</span> <span class="main">‚àà</span> code_status_status_rel‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‚ÄπPAC_checker_l <span class="free">spec</span> <span class="free">A</span> <span class="free">b</span> <span class="free">st</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">(</span>code_status_status_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> <span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> fmap_polys_rel<span class="main">)</span> <span class="main">(</span>PAC_checker <span class="free">spec'</span> <span class="free">B</span> <span class="free">b'</span> <span class="free">st'</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">refine0</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="free">st</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">b'</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="free">st'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">(</span><span class="main">(</span>code_status_status_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> <span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> fmap_polys_rel<span class="main">)</span> <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span>  <span class="main">‚ü®</span>pac_step_rel<span class="main">‚ü©</span>list_rel<span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> code_status_status_rel_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> PAC_checker_l_def PAC_checker_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> PAC_checker_l_step_PAC_checker_step
      WHILEIT_refine<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(</span>bool_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> <span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> fmap_polys_rel<span class="main">)</span> <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> <span class="main">‚ü®</span>pac_step_rel<span class="main">‚ü©</span>list_rel<span class="main">)</span>‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> code_status_status_rel_discrim_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> neq_Nil_conv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> neq_Nil_conv <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> param_nth<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> neq_Nil_conv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> less_than_char_of_char<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">‚àà</span> less_than_char <span class="main">‚ü∑</span> <span class="main">(</span>of_char <span class="free">x</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">&lt;</span> of_char <span class="free">y</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_than_char_def less_char_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  add_poly_l'.simps<span class="main">[</span><span class="operator">unfolded</span> var_order_rel_def<span class="main">]</span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">add_poly_l'</span></span> <span class="keyword2"><span class="keyword">in</span></span> SML <span class="keyword2"><span class="keyword">module_name</span></span> test

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">full_checker_l</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπllist_polynomial <span class="main">‚áí</span> <span class="main">(</span>nat<span class="main">,</span> llist_polynomial<span class="main">)</span> fmap <span class="main">‚áí</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> string<span class="main">,</span> nat<span class="main">)</span> pac_step list <span class="main">‚áí</span>
    <span class="main">(</span>string code_status <span class="main">√ó</span> <span class="main">_</span><span class="main">)</span> nres‚Ä∫</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">full_checker_l</span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">spec'</span> <span class="main">‚Üê</span> full_normalize_poly <span class="free"><span class="bound"><span class="entity">spec</span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">‚Üê</span> remap_polys_l <span class="bound">spec'</span> <span class="main">{}</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
    <span class="keyword1">if</span> is_cfailed <span class="bound">b</span>
    <span class="keyword1">then</span> RETURN <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="keyword1">let</span> <span class="bound">ùí±</span> <span class="main">=</span> <span class="bound">ùí±</span> <span class="main">‚à™</span> vars_llist <span class="free"><span class="bound"><span class="entity">spec</span></span></span><span class="main">;</span>
      PAC_checker_l <span class="bound">spec'</span> <span class="main">(</span><span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span>
    <span class="main">}</span>
  <span class="main">}</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">context</span></span> poly_embed
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">term</span></span> <span class="quoted">normalize_poly_spec</span>
<span class="keyword1"><span class="command">thm</span></span> full_normalize_poly_diff_ideal<span class="main">[</span><span class="operator">unfolded</span> normalize_poly_spec_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">unsorted_fmap_polys_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">unsorted_fmap_polys_rel</span> <span class="main">‚â°</span> <span class="main">‚ü®</span>nat_rel<span class="main">,</span> fully_unsorted_poly_rel <span class="keyword1">O</span> mset_poly_rel<span class="main">‚ü©</span>fmap_rel‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> full_checker_l_full_checker<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚àà</span> unsorted_fmap_polys_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">st</span><span class="main">,</span> <span class="free">st'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>pac_step_rel<span class="main">‚ü©</span>list_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">spec</span><span class="main">,</span> <span class="free">spec'</span><span class="main">)</span> <span class="main">‚àà</span> fully_unsorted_poly_rel <span class="keyword1">O</span> mset_poly_rel‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‚Äπfull_checker_l <span class="free">spec</span> <span class="free">A</span> <span class="free">st</span> <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">(</span>code_status_status_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> <span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> fmap_polys_rel<span class="main">)</span> <span class="main">(</span>full_checker <span class="free">spec'</span> <span class="free">B</span> <span class="free">st'</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">spec</span><span class="main">,</span> <span class="skolem">spec'</span><span class="main">)</span> <span class="main">‚àà</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel <span class="main">‚üπ</span>
    <span class="main">(</span><span class="skolem">ùí±</span><span class="main">,</span> <span class="skolem">ùí±'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel <span class="main">‚üπ</span>
    remap_polys_l <span class="skolem">spec</span> <span class="skolem">ùí±</span> <span class="free">A</span> <span class="main">‚â§</span> <span class="main">‚áì</span><span class="main">(</span>code_status_status_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> <span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> fmap_polys_rel<span class="main">)</span>
        <span class="main">(</span>remap_polys_change_all <span class="skolem">spec'</span> <span class="skolem">ùí±'</span> <span class="free">B</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">spec</span> <span class="skolem">spec'</span> <span class="skolem">ùí±</span> <span class="skolem">ùí±'</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> remap_polys_l_remap_polys<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ref_two_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> remap_polys_spec<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> remap_polys_polynomial_bool_remap_polys_change_all<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> full_checker_l_def full_checker_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> remap_polys_l_remap_polys
       full_normalize_poly_diff_ideal<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> normalize_poly_spec_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span>
       PAC_checker_l_PAC_checker<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_cfailed_def is_failed_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fully_unsorted_poly_rel_extend_vars<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p2rel_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> full_checker_l_full_checker'<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>uncurry2 full_checker_l<span class="main">,</span> uncurry2 full_checker<span class="main">)</span> <span class="main">‚àà</span>
  <span class="main">(</span><span class="main">(</span>fully_unsorted_poly_rel <span class="keyword1">O</span> mset_poly_rel<span class="main">)</span> <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> unsorted_fmap_polys_rel<span class="main">)</span> <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> <span class="main">‚ü®</span>pac_step_rel<span class="main">‚ü©</span>list_rel <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>f</sub></span>
    <span class="main">‚ü®</span><span class="main">(</span>code_status_status_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> <span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> fmap_polys_rel<span class="main">)</span><span class="main">‚ü©</span>nres_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> frefI nres_relI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> full_checker_l_full_checker <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">remap_polys_l2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπllist_polynomial <span class="main">‚áí</span> string set <span class="main">‚áí</span> <span class="main">(</span>nat<span class="main">,</span> llist_polynomial<span class="main">)</span> fmap <span class="main">‚áí</span> <span class="main">_</span> nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">remap_polys_l2</span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">ùí±</span> <span class="bound">A</span><span class="main">.</span> <span class="keyword1">do</span><span class="main">{</span>
   <span class="bound">n</span> <span class="main">‚Üê</span> upper_bound_on_dom <span class="bound">A</span><span class="main">;</span>
   <span class="bound">b</span> <span class="main">‚Üê</span> RETURN <span class="main">(</span><span class="bound">n</span> <span class="main">‚â•</span> <span class="numeral">2</span><span class="main">^</span><span class="numeral">64</span><span class="main">)</span><span class="main">;</span>
   <span class="keyword1">if</span> <span class="bound">b</span>
   <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">c</span> <span class="main">‚Üê</span> remap_polys_l_dom_err<span class="main">;</span>
     RETURN <span class="main">(</span>error_msg <span class="main">(</span><span class="main">0</span> <span class="main">::</span>nat<span class="main">)</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> fmempty<span class="main">)</span>
   <span class="main">}</span>
   <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">‚Üê</span> nfoldli <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">n</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>
       <span class="main">(</span><span class="main">Œª</span><span class="bound">i</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A'</span><span class="main">)</span><span class="main">.</span>
          <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">‚àà#</span> dom_m <span class="bound">A</span>
          <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
            ASSERT<span class="main">(</span>fmlookup <span class="bound">A</span> <span class="bound">i</span> <span class="main">‚â†</span> None<span class="main">)</span><span class="main">;</span>
            <span class="bound">p</span> <span class="main">‚Üê</span> full_normalize_poly <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="bound">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
            <span class="bound">eq</span> <span class="main">‚Üê</span> weak_equality_l <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">spec</span></span></span><span class="main">;</span>
            <span class="bound">ùí±</span> <span class="main">‚Üê</span> RETURN <span class="main">(</span><span class="bound">ùí±</span> <span class="main">‚à™</span> vars_llist <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="bound">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
            RETURN<span class="main">(</span><span class="bound">b</span> <span class="main">‚à®</span> <span class="bound">eq</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> fmupd <span class="bound">i</span> <span class="bound">p</span> <span class="bound">A'</span><span class="main">)</span>
          <span class="main">}</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A'</span><span class="main">)</span>
        <span class="main">)</span>
       <span class="main">(</span>False<span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> fmempty<span class="main">)</span><span class="main">;</span>
     RETURN <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> CFOUND <span class="keyword1">else</span> CSUCCESS<span class="main">,</span> <span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span>
    <span class="main">}</span>
 <span class="main">}</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> remap_polys_l2_remap_polys_l<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπremap_polys_l2 <span class="free">spec</span> <span class="free">ùí±</span> <span class="free">A</span> <span class="main">‚â§</span> <span class="main">‚áì</span> Id <span class="main">(</span>remap_polys_l <span class="free">spec</span> <span class="free">ùí±</span> <span class="free">A</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">A'</span><span class="main">)</span> <span class="main">‚àà</span> Id <span class="main">‚üπ</span> upper_bound_on_dom <span class="skolem">A</span>
    <span class="main">‚â§</span> <span class="main">‚áì</span> <span class="main">{</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">dom</span><span class="main">)</span><span class="main">.</span> <span class="bound">dom</span> <span class="main">=</span> set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">n</span><span class="main">]</span><span class="main">}</span> <span class="main">(</span>SPEC <span class="main">(</span><span class="main">Œª</span><span class="bound">dom</span><span class="main">.</span> set_mset <span class="main">(</span>dom_m <span class="skolem">A'</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="bound">dom</span> <span class="main">‚àß</span> finite <span class="bound">dom</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="skolem">A'</span>
    <span class="keyword1"><span class="command">unfolding</span></span> upper_bound_on_dom_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> RES_refine<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upper_bound_on_dom_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπinj_on id <span class="skolem">dom</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">dom</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x</span> <span class="main">‚àà#</span> dom_m <span class="skolem">A</span> <span class="main">‚üπ</span>
       <span class="skolem">x'</span> <span class="main">‚àà#</span> dom_m <span class="skolem">A'</span> <span class="main">‚üπ</span>
       <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">‚àà</span> nat_rel <span class="main">‚üπ</span>
       <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">A'</span><span class="main">)</span> <span class="main">‚àà</span> Id <span class="main">‚üπ</span>
       full_normalize_poly <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="skolem">A</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>
       <span class="main">‚â§</span> <span class="main">‚áì</span> Id
          <span class="main">(</span>full_normalize_poly <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="skolem">A'</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
       <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">x</span> <span class="skolem">x'</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">dom</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">{</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">dom</span><span class="main">)</span><span class="main">.</span> <span class="bound">dom</span> <span class="main">=</span> set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">n</span><span class="main">]</span><span class="main">}</span> <span class="main">‚üπ</span>
       <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">]</span><span class="main">,</span> <span class="skolem">dom</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>nat_rel<span class="main">‚ü©</span>list_set_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="skolem">dom</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_set_rel_def br_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">q</span><span class="main">)</span> <span class="main">‚àà</span> Id <span class="main">‚üπ</span>
    weak_equality_l <span class="skolem">p</span> <span class="skolem">spec</span> <span class="main">‚â§</span> <span class="main">‚áì</span>Id <span class="main">(</span>weak_equality_l <span class="skolem">q</span> <span class="skolem">spec</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">spec</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">‚àà</span> Id‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> remap_polys_l2_def remap_polys_l_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> LFO_refine<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">‚ÄπId <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> <span class="main">‚ü®</span>Id<span class="main">‚ü©</span>set_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> Id‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 3<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_dom_m_lookup_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_dom_m_lookup_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 4<span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 6<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="PAC_Checker_Relation">
<div class="head">
<h1>Theory PAC_Checker_Relation</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:         PAC_Checker_Relation.thy
  Author:       Mathias Fleury, Daniela Kaufmann, JKU
  Maintainer:   Mathias Fleury, JKU
*)</span>
<span class="keyword1"><span class="command">theory</span></span> PAC_Checker_Relation
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="PAC_Checker.html">PAC_Checker</a> <a href="WB_Sort.html">WB_Sort</a> <span class="quoted">"<a href="../Native_Word/Uint64.html">Native_Word.Uint64</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚ÄπVarious Refinement Relations‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπWhen writing this, it was not possible to share the definition with the IsaSAT version.‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">uint64_nat_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>uint64 <span class="main">√ó</span> nat<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">‚Äπ<span class="free">uint64_nat_rel</span> <span class="main">=</span> br nat_of_uint64 <span class="main">(</span><span class="main">Œª</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">uint64_nat_assn</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">uint64_nat_assn</span> <span class="main">‚â°</span> pure uint64_nat_rel‚Ä∫</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> uint32 <span class="main">::</span> <span class="quoted">hashable</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">hashcode_uint32</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπuint32 <span class="main">‚áí</span> uint32‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">hashcode_uint32</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">def_hashmap_size_uint32</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπuint32 itself <span class="main">‚áí</span> nat‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">def_hashmap_size_uint32</span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="numeral">16</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="comment1">‚Äï ‚Äπsame as <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">nat</span><span class="antiquote">}</span></span>‚Ä∫</span>
<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> def_hashmap_size_uint32_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> uint64 <span class="main">::</span> <span class="quoted">hashable</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">hashcode_uint64</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπuint64 <span class="main">‚áí</span> uint32‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">hashcode_uint64</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span>uint32_of_nat <span class="main">(</span>nat_of_uint64 <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1">AND</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> uint64<span class="main">)</span><span class="main">^</span><span class="numeral">32</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">def_hashmap_size_uint64</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπuint64 itself <span class="main">‚áí</span> nat‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">def_hashmap_size_uint64</span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="numeral">16</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="comment1">‚Äï ‚Äπsame as <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">nat</span><span class="antiquote">}</span></span>‚Ä∫</span>
<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> def_hashmap_size_uint64_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> word_nat_of_uint64_Rep_inject<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπnat_of_uint64 <span class="free">ai</span> <span class="main">=</span> nat_of_uint64 <span class="free">bi</span> <span class="main">‚ü∑</span> <span class="free">ai</span> <span class="main">=</span> <span class="free">bi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> word_unat_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> uint64 <span class="main">::</span> <span class="quoted">heap</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_def exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">nat_of_uint64</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> uint64 <span class="main">::</span> <span class="quoted">semiring_numeral</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>

<span class="keyword1"><span class="command">lemma</span></span> nat_of_uint64_012<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπnat_of_uint64 <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπnat_of_uint64 <span class="numeral">2</span> <span class="main">=</span> <span class="numeral">2</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπnat_of_uint64 <span class="main">1</span> <span class="main">=</span> <span class="main">1</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">uint64_of_nat_conv</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">uint64_of_nat_conv</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> less_upper_bintrunc_id<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span><span class="free">b</span> <span class="main">‚üπ</span> <span class="free">n</span> <span class="main">‚â•</span> <span class="main">0</span> <span class="main">‚üπ</span> bintrunc <span class="free">b</span> <span class="free">n</span> <span class="main">=</span> <span class="free">n</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> uint32_of_nat_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_bintr_alt1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nat_of_uint64_uint64_of_nat_id<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">^</span><span class="numeral">64</span> <span class="main">‚üπ</span> nat_of_uint64 <span class="main">(</span>uint64_of_nat <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> uint64_of_nat_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> unat_eq_nat_uint<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_upper_bintrunc_id<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>return <span class="keyword1">o</span> uint64_of_nat<span class="main">,</span> RETURN <span class="keyword1">o</span> uint64_of_nat_conv<span class="main">)</span> <span class="main">‚àà</span> <span class="main">[</span><span class="main">Œª</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span><span class="numeral">64</span><span class="keyword1">]<span class="hidden">‚á©</span><sub>a</sub></span> nat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="main">‚Üí</span> uint64_nat_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref_to_hoare</span>
   <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> uint64_nat_rel_def br_def nat_of_uint64_uint64_of_nat_id<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">string_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>String.literal <span class="main">√ó</span> string<span class="main">)</span> set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">string_rel</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> String.explode <span class="bound">x</span><span class="main">}</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">string_assn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπstring <span class="main">‚áí</span> String.literal <span class="main">‚áí</span> assn‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">string_assn</span> <span class="main">‚â°</span> pure string_rel‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_string_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(=)</span><span class="main">,</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">‚àà</span> string_rel <span class="main">‚Üí</span> string_rel <span class="main">‚Üí</span> bool_rel‚Ä∫</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> frefI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> string_rel_def String.less_literal_def
    less_than_char_def rel2p_def literal.explode_inject<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> eq_string_eq_hnr <span class="main">=</span>
   eq_string_eq<span class="main">[</span><span class="operator">sepref_import_param</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">string2_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>string <span class="main">√ó</span> string<span class="main">)</span> set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">string2_rel</span> <span class="main">‚â°</span> <span class="main">‚ü®</span>Id<span class="main">‚ü©</span>list_rel‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">string2_assn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπstring <span class="main">‚áí</span> string <span class="main">‚áí</span> assn‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">string2_assn</span> <span class="main">‚â°</span> pure string2_rel‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">monom_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">monom_rel</span> <span class="main">‚â°</span> <span class="main">‚ü®</span>string_rel<span class="main">‚ü©</span>list_rel‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">monom_assn</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">monom_assn</span> <span class="main">‚â°</span> list_assn string_assn‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">monomial_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">monomial_rel</span> <span class="main">‚â°</span> monom_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">monomial_assn</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">monomial_assn</span> <span class="main">‚â°</span> monom_assn <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>a</sub></span> int_assn‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">poly_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">poly_rel</span> <span class="main">‚â°</span> <span class="main">‚ü®</span>monomial_rel<span class="main">‚ü©</span>list_rel‚Ä∫</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">poly_assn</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">poly_assn</span> <span class="main">‚â°</span> list_assn monomial_assn‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> poly_assn_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπpoly_assn <span class="main">=</span> pure poly_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_assn_pure_conv<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">polys_assn</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">polys_assn</span> <span class="main">‚â°</span> hm_fmap_assn uint64_nat_assn poly_assn‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> string_rel_string_assn<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">‚Üë</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">‚àà</span> string_rel<span class="main">)</span><span class="main">)</span> <span class="main">=</span> string_assn <span class="free">a</span> <span class="free">c</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pure_app_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> single_valued_string_rel<span class="main">:</span>
   <span class="quoted"><span class="quoted">‚Äπsingle_valued string_rel‚Ä∫</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> single_valued_def string_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> IS_LEFT_UNIQUE_string_rel<span class="main">:</span>
   <span class="quoted"><span class="quoted">‚ÄπIS_LEFT_UNIQUE string_rel‚Ä∫</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IS_LEFT_UNIQUE_def single_valued_def string_rel_def
     literal.explode_inject<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> IS_RIGHT_UNIQUE_string_rel<span class="main">:</span>
   <span class="quoted"><span class="quoted">‚ÄπIS_RIGHT_UNIQUE string_rel‚Ä∫</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> single_valued_def string_rel_def
     literal.explode_inject<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> single_valued_monom_rel<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπsingle_valued monom_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> list_rel_sv<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> frefI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> string_rel_def
    rel2p_def single_valued_def p2rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> single_valued_monomial_rel<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπsingle_valued monomial_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> single_valued_monom_rel
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> frefI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>
    rel2p_def single_valued_def p2rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> single_valued_monom_rel'<span class="main">:</span> <span class="quoted"><span class="quoted">‚ÄπIS_LEFT_UNIQUE monom_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> IS_LEFT_UNIQUE_def inv_list_rel_eq string2_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> list_rel_sv<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> frefI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> string_rel_def
    rel2p_def single_valued_def p2rel_def literal.explode_inject<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> single_valued_monomial_rel'<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπIS_LEFT_UNIQUE monomial_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> single_valued_monom_rel'
  <span class="keyword1"><span class="command">unfolding</span></span> IS_LEFT_UNIQUE_def inv_list_rel_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> frefI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>
    rel2p_def single_valued_def p2rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">safe_constraint_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπSepref_Constraints.CONSTRAINT single_valued string_rel‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚ÄπSepref_Constraints.CONSTRAINT IS_LEFT_UNIQUE string_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> CONSTRAINT_def single_valued_def
    string_rel_def IS_LEFT_UNIQUE_def literal.explode_inject<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_string_monom_hnr<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>uncurry <span class="main">(</span>return <span class="keyword1">oo</span> <span class="main">(=)</span><span class="main">)</span><span class="main">,</span> uncurry <span class="main">(</span>RETURN <span class="keyword1">oo</span> <span class="main">(=)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> monom_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> monom_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> bool_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> single_valued_monom_rel' single_valued_monom_rel
  <span class="keyword1"><span class="command">unfolding</span></span> list_assn_pure_conv
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref_to_hoare</span>
   <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_assn_pure_conv string_rel_string_assn
       single_valued_def IS_LEFT_UNIQUE_def
     <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mod_starD
     <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> inv_list_rel_eq<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">term_order_rel'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">term_order_rel'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">‚àà</span> term_order_rel<span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> term_order_rel<span class="main">[</span><span class="operator">def_pat_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(‚àà)</span><span class="main">$</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">$</span>term_order_rel <span class="main">‚â°</span> term_order_rel'<span class="main">$</span><span class="free">x</span><span class="main">$</span><span class="free">y</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> term_order_rel_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπterm_order_rel <span class="main">=</span> lexord <span class="main">(</span>p2rel char.lexordp<span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p2rel_def char.lexordp_conv_lexord var_order_rel_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">lexord</span><span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">instantiation</span></span> char <span class="main">::</span> <span class="quoted">linorder</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_char</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">less_char</span> <span class="main">=</span> PAC_Polynomials_Term.less_char"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_eq_char</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">less_eq_char</span> <span class="main">=</span> PAC_Polynomials_Term.less_eq_char"</span></span>
<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">using</span></span> char.linorder_axioms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> class.linorder_def class.order_def class.preorder_def
       less_eq_char_def less_than_char_def class.order_axioms_def
       class.linorder_axioms_def p2rel_def less_char_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">instantiation</span></span> list <span class="main">::</span> <span class="main">(</span><span class="quoted">linorder</span><span class="main">)</span> <span class="quoted">linorder</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_list</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">less_list</span> <span class="main">=</span> lexordp <span class="main">(&lt;)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_eq_list</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">less_eq_list</span> <span class="main">=</span> lexordp_eq"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">x</span> <span class="bound">y</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> linorder list<span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">‚àà</span> lexord <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span> <span class="main">‚üπ</span>
           lexordp_eq <span class="bound">y</span> <span class="bound">x</span> <span class="main">‚üπ</span> False‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lexordp_antisym lexordp_conv_lexord lexordp_eq_conv_lexord<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">x</span> <span class="bound">y</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> linorder list<span class="main">.</span> lexordp_eq <span class="bound">x</span> <span class="bound">y</span> <span class="main">‚üπ</span>
           <span class="main">¬¨</span> lexordp_eq <span class="bound">y</span> <span class="bound">x</span> <span class="main">‚üπ</span>
           <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">‚àà</span> lexord <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">using</span></span> lexordp_conv_lexord lexordp_conv_lexordp_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span>
   <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> Restricted_Predicates.strict <span class="main">(‚â§)</span> <span class="skolem">x</span> <span class="skolem">y</span>‚Ä∫</span></span>
   <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x</span> <span class="main">‚â§</span> <span class="skolem">x</span>‚Ä∫</span></span>
   <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x</span> <span class="main">‚â§</span> <span class="skolem">y</span> <span class="main">‚üπ</span> <span class="skolem">y</span> <span class="main">‚â§</span> <span class="skolem">z</span> <span class="main">‚üπ</span> <span class="skolem">x</span> <span class="main">‚â§</span> <span class="skolem">z</span>‚Ä∫</span></span>
   <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x</span> <span class="main">‚â§</span> <span class="skolem">y</span> <span class="main">‚üπ</span> <span class="skolem">y</span> <span class="main">‚â§</span> <span class="skolem">x</span> <span class="main">‚üπ</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>‚Ä∫</span></span>
   <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">x</span> <span class="main">‚â§</span> <span class="skolem">y</span> <span class="main">‚à®</span> <span class="skolem">y</span> <span class="main">‚â§</span> <span class="skolem">x</span>‚Ä∫</span></span>
   <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="tfree">'a</span> <span class="main">::</span> linorder list‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_list_def less_eq_list_def List.lexordp_def
    lexordp_conv_lexord lexordp_into_lexordp_eq lexordp_antisym
    antisym_def lexordp_eq_refl lexordp_eq_linear <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lexordp_eq_trans
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lexordp_eq_antisym<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">lemma</span></span> term_order_rel'_alt_def_lexord<span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπterm_order_rel' <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> ord_class.lexordp <span class="free">x</span> <span class="free">y</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  term_order_rel'_alt_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπterm_order_rel' <span class="free">x</span> <span class="free">y</span> <span class="main">‚ü∑</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">‚Äπterm_order_rel' <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> ord_class.lexordp <span class="free">x</span> <span class="free">y</span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπterm_order_rel' <span class="free">x</span> <span class="free">y</span> <span class="main">‚ü∑</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> less_than_char_of_char<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lexordp_conv_lexord less_eq_list_def
         less_list_def lexordp_def var_order_rel_def
         rel2p_def term_order_rel_alt_def p2rel_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_rel_list_rel_order_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>string_rel<span class="main">‚ü©</span>list_rel‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a'</span><span class="main">,</span> <span class="free">b'</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>string_rel<span class="main">‚ü©</span>list_rel‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">a</span> <span class="main">&lt;</span> <span class="free">a'</span> <span class="main">‚ü∑</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">b'</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>string_rel<span class="main">‚ü©</span>list_rel <span class="main">‚üπ</span>
       <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>string_rel<span class="main">‚ü©</span>list_rel <span class="main">‚üπ</span> <span class="free">b</span> <span class="main">=</span> <span class="skolem">cs</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">cs</span>
     <span class="keyword1"><span class="command">using</span></span> single_valued_monom_rel' IS_RIGHT_UNIQUE_string_rel
     <span class="keyword1"><span class="command">unfolding</span></span> string2_rel_def
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span>list_rel_sv_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> single_valued_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">a</span> <span class="main">&lt;</span> <span class="free">a'</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
    <span class="skolem">u</span> <span class="skolem">u'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">a'</span> <span class="main">=</span> <span class="free">a</span> <span class="main">@</span> <span class="skolem">u</span> <span class="main">#</span> <span class="skolem">u'</span>‚Ä∫</span></span> <span class="main">|</span>
    <span class="skolem">u</span> <span class="skolem">aa</span> <span class="skolem">v</span> <span class="skolem">w</span> <span class="skolem">aaa</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">a</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">v</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">a'</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">aaa</span> <span class="main">#</span> <span class="skolem">w</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">aa</span> <span class="main">&lt;</span> <span class="skolem">aaa</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> less_list_def<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lexord_def List.lexordp_def
      list_rel_append1 list_rel_split_right_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">b</span> <span class="main">&lt;</span> <span class="free">b'</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">b</span> <span class="main">&lt;</span> <span class="free">b'</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> less_list_def<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lexord_def List.lexordp_def
        list_rel_append1 list_rel_split_right_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> H<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">aa'</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="skolem"><span class="skolem">aaa'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
       <span class="quoted"><span class="quoted">‚Äπ<span class="free">b</span> <span class="main">=</span> <span class="skolem">u'</span> <span class="main">@</span> <span class="skolem">aa'</span> <span class="main">#</span> <span class="skolem">v'</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">b'</span> <span class="main">=</span> <span class="skolem">u'</span> <span class="main">@</span> <span class="skolem">aaa'</span> <span class="main">#</span> <span class="skolem">w'</span>‚Ä∫</span></span>
       <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">aa</span><span class="main">,</span> <span class="skolem">aa'</span><span class="main">)</span> <span class="main">‚àà</span> string_rel‚Ä∫</span></span>
       <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">aaa</span><span class="main">,</span> <span class="skolem">aaa'</span><span class="main">)</span> <span class="main">‚àà</span> string_rel‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> list_rel_append1 list_rel_split_right_iff single_valued_def single_valued_monom_rel<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">aa</span> <span class="main">&lt;</span> <span class="skolem">aaa</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">aa'</span> <span class="main">&lt;</span> <span class="skolem">aaa'</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> string_rel_def less_literal.rep_eq less_list_def
        lexordp_conv_lexord lexordp_def char.lexordp_conv_lexord
          <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> less_char_def PAC_Polynomials_Term.less_char_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">b</span> <span class="main">&lt;</span> <span class="free">b'</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">b</span> <span class="main">=</span> <span class="skolem">u'</span> <span class="main">@</span> <span class="skolem">aa'</span> <span class="main">#</span> <span class="skolem">v'</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">b'</span> <span class="main">=</span> <span class="skolem">u'</span> <span class="main">@</span> <span class="skolem">aaa'</span> <span class="main">#</span> <span class="skolem">w'</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> less_list_def<span class="main">)</span>
        <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lexord_def List.lexordp_def
        list_rel_append1 list_rel_split_right_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>string_rel<span class="main">‚ü©</span>list_rel <span class="main">‚üπ</span>
       <span class="main">(</span><span class="skolem">a'</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>string_rel<span class="main">‚ü©</span>list_rel <span class="main">‚üπ</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a'</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">a'</span> <span class="skolem">b</span>
     <span class="keyword1"><span class="command">using</span></span> single_valued_monom_rel'
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> single_valued_def IS_LEFT_UNIQUE_def
       <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> inv_list_rel_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">b</span> <span class="main">&lt;</span> <span class="free">b'</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
    <span class="skolem">u</span> <span class="skolem">u'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">b'</span> <span class="main">=</span> <span class="free">b</span> <span class="main">@</span> <span class="skolem">u</span> <span class="main">#</span> <span class="skolem">u'</span>‚Ä∫</span></span> <span class="main">|</span>
    <span class="skolem">u</span> <span class="skolem">aa</span> <span class="skolem">v</span> <span class="skolem">w</span> <span class="skolem">aaa</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">b</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">v</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">b'</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">aaa</span> <span class="main">#</span> <span class="skolem">w</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">aa</span> <span class="main">&lt;</span> <span class="skolem">aaa</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> less_list_def<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lexord_def List.lexordp_def
      list_rel_append1 list_rel_split_right_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">a</span> <span class="main">&lt;</span> <span class="free">a'</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">a</span> <span class="main">&lt;</span> <span class="free">a'</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> less_list_def<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lexord_def List.lexordp_def
        list_rel_append2 list_rel_split_left_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> H<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">aa'</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="skolem"><span class="skolem">aaa'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
       <span class="quoted"><span class="quoted">‚Äπ<span class="free">a</span> <span class="main">=</span> <span class="skolem">u'</span> <span class="main">@</span> <span class="skolem">aa'</span> <span class="main">#</span> <span class="skolem">v'</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">a'</span> <span class="main">=</span> <span class="skolem">u'</span> <span class="main">@</span> <span class="skolem">aaa'</span> <span class="main">#</span> <span class="skolem">w'</span>‚Ä∫</span></span>
       <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">aa'</span><span class="main">,</span> <span class="skolem">aa</span><span class="main">)</span> <span class="main">‚àà</span> string_rel‚Ä∫</span></span>
       <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">aaa'</span><span class="main">,</span> <span class="skolem">aaa</span><span class="main">)</span> <span class="main">‚àà</span> string_rel‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lexord_def List.lexordp_def
        list_rel_append2 list_rel_split_left_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> H<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">aa</span> <span class="main">&lt;</span> <span class="skolem">aaa</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">aa'</span> <span class="main">&lt;</span> <span class="skolem">aaa'</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> string_rel_def less_literal.rep_eq less_list_def
        lexordp_conv_lexord lexordp_def char.lexordp_conv_lexord
          <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> less_char_def PAC_Polynomials_Term.less_char_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">a</span> <span class="main">&lt;</span> <span class="free">a'</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">a</span> <span class="main">=</span> <span class="skolem">u'</span> <span class="main">@</span> <span class="skolem">aa'</span> <span class="main">#</span> <span class="skolem">v'</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">a'</span> <span class="main">=</span> <span class="skolem">u'</span> <span class="main">@</span> <span class="skolem">aaa'</span> <span class="main">#</span> <span class="skolem">w'</span>‚Ä∫</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> less_list_def<span class="main">)</span>
        <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lexord_def List.lexordp_def
        list_rel_append1 list_rel_split_right_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> string_rel_le<span class="main">[</span><span class="operator">sepref_import_param</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(&lt;)</span><span class="main">,</span> <span class="main">(&lt;)</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>string_rel<span class="main">‚ü©</span>list_rel <span class="main">‚Üí</span>  <span class="main">‚ü®</span>string_rel<span class="main">‚ü©</span>list_rel <span class="main">‚Üí</span> bool_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fun_relI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_list_rel_order_iff<span class="main">)</span>

<span class="comment1">(* TODO Move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sepref_import_param</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚ÄπCONSTRAINT IS_LEFT_UNIQUE <span class="free">R</span>‚Ä∫</span></span>  <span class="quoted"><span class="quoted">‚ÄπCONSTRAINT IS_RIGHT_UNIQUE <span class="free">R</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>remove1<span class="main">,</span> remove1<span class="main">)</span> <span class="main">‚àà</span> <span class="free">R</span> <span class="main">‚Üí</span> <span class="main">‚ü®</span><span class="free">R</span><span class="main">‚ü©</span>list_rel <span class="main">‚Üí</span> <span class="main">‚ü®</span><span class="free">R</span><span class="main">‚ü©</span>list_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> p <span class="keyword2"><span class="keyword">for</span></span> x y xs ys
    <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>2<span class="main">)</span> p<span class="main">(</span>1<span class="main">)</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_rel_induct<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IS_LEFT_UNIQUE_def single_valued_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">instantiation</span></span> pac_step <span class="main">::</span> <span class="main">(</span><span class="quoted">heap</span><span class="main">,</span> <span class="quoted">heap</span><span class="main">,</span> <span class="quoted">heap</span><span class="main">)</span> <span class="quoted">heap</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">standard</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="tfree">'a</span> <span class="main">‚áí</span> nat‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    f<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπinj <span class="skolem">f</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπnat <span class="main">√ó</span> nat <span class="main">√ó</span> nat <span class="main">√ó</span> nat <span class="main">√ó</span> nat <span class="main">‚áí</span> nat‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    g<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπinj <span class="skolem">g</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="tfree">'b</span> <span class="main">‚áí</span> nat‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    h<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπinj <span class="skolem">h</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="tfree">'c</span> <span class="main">‚áí</span> nat‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    i<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπinj <span class="skolem">i</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">g</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">g</span> <span class="skolem">b</span> <span class="main">‚ü∑</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>‚Ä∫</span></span><span class="quoted"><span class="quoted">‚Äπ<span class="skolem">h</span> <span class="skolem">a''</span> <span class="main">=</span> <span class="skolem">h</span> <span class="skolem">b''</span> <span class="main">‚ü∑</span> <span class="skolem">a''</span> <span class="main">=</span> <span class="skolem">b''</span>‚Ä∫</span></span>  <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">f</span> <span class="skolem">a'</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">b'</span> <span class="main">‚ü∑</span> <span class="skolem">a'</span> <span class="main">=</span> <span class="skolem">b'</span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="skolem">i</span> <span class="skolem">a'''</span> <span class="main">=</span> <span class="skolem">i</span> <span class="skolem">b'''</span> <span class="main">‚ü∑</span> <span class="skolem">a'''</span> <span class="main">=</span> <span class="skolem">b'''</span>‚Ä∫</span></span>  <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">a'</span> <span class="skolem">b'</span> <span class="skolem">a''</span> <span class="skolem">b''</span> <span class="skolem">a'''</span> <span class="skolem">b'''</span>
    <span class="keyword1"><span class="command">using</span></span> f g h i <span class="keyword1"><span class="command">unfolding</span></span> inj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">Œª</span><span class="bound">x</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> pac_step<span class="main">.</span>
     <span class="skolem">g</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span>
        Add <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span> <span class="main">‚áí</span>     <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="skolem">i</span> <span class="bound">a</span><span class="main">,</span>  <span class="skolem">i</span> <span class="bound">b</span><span class="main">,</span>  <span class="skolem">i</span> <span class="bound">c</span><span class="main">,</span> <span class="skolem">f</span> <span class="bound">d</span><span class="main">)</span>
      <span class="main">|</span> Del <span class="bound">a</span>  <span class="main">‚áí</span>          <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="skolem">i</span> <span class="bound">a</span><span class="main">,</span>    <span class="main">0</span><span class="main">,</span>   <span class="main">0</span><span class="main">,</span>   <span class="main">0</span><span class="main">)</span>
      <span class="main">|</span> Mult <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span> <span class="main">‚áí</span>    <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="skolem">i</span> <span class="bound">a</span><span class="main">,</span> <span class="skolem">f</span> <span class="bound">b</span><span class="main">,</span> <span class="skolem">i</span> <span class="bound">c</span><span class="main">,</span> <span class="skolem">f</span> <span class="bound">d</span><span class="main">)</span>
      <span class="main">|</span> Extension <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="main">‚áí</span> <span class="main">(</span><span class="numeral">3</span><span class="main">,</span> <span class="skolem">i</span> <span class="bound">a</span><span class="main">,</span> <span class="skolem">f</span> <span class="bound">c</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">h</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπinj <span class="var">?f</span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">y</span></span></span></span></span></span></span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚àÉ</span><span class="bound">f</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> pac_step <span class="main">‚áí</span> nat<span class="main">.</span> inj <span class="bound">f</span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="PAC_Assoc_Map_Rel">
<div class="head">
<h1>Theory PAC_Assoc_Map_Rel</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> PAC_Assoc_Map_Rel
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="PAC_Map_Rel.html">PAC_Map_Rel</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚ÄπHash Map as association list‚Ä∫</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hash_assoc <span class="main">=</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'k</span> <span class="main">√ó</span> <span class="tfree">'v</span><span class="main">)</span> list‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hassoc_map_rel_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hash_assoc <span class="main">√ó</span> <span class="main">_</span><span class="main">)</span> set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">hassoc_map_rel_raw</span> <span class="main">=</span> br map_of <span class="main">(</span><span class="main">Œª</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">hassoc_map_assn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'k</span> <span class="main">‚áí</span> <span class="tfree">'v</span> option<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hash_assoc <span class="main">‚áí</span> assn‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">hassoc_map_assn</span> <span class="main">‚â°</span> pure <span class="main">(</span>hassoc_map_rel_raw<span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hassoc_map_rel_raw_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">‚àà</span> hassoc_map_rel_raw <span class="main">‚ü∑</span> <span class="free">m</span> <span class="main">=</span> Map.empty‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">p</span><span class="main">,</span> Map.empty<span class="main">)</span> <span class="main">‚àà</span> hassoc_map_rel_raw <span class="main">‚ü∑</span> <span class="free">p</span> <span class="main">=</span> <span class="main">[]</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπhassoc_map_assn Map.empty <span class="main">[]</span> <span class="main">=</span> <span class="keyword1">emp</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hassoc_map_rel_raw_def br_def pure_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hassoc_new</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hash_assoc Heap‚Ä∫</span></span><span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">hassoc_new</span> <span class="main">=</span> return <span class="main">[]</span>‚Ä∫</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> precise_hassoc_map_assn<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπprecise hassoc_map_assn‚Ä∫</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> precise_pure<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> single_valued_def hassoc_map_rel_raw_def
      br_def<span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">hassoc_isEmpty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span> <span class="main">√ó</span> <span class="tfree">'v</span><span class="main">)</span> list <span class="main">‚áí</span> bool Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">hassoc_isEmpty</span> <span class="free"><span class="bound"><span class="entity">ht</span></span></span> <span class="main">‚â°</span> return <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ht</span></span></span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>


 <span class="keyword1"><span class="command">interpretation</span></span> hassoc<span class="main">:</span> bind_map_empty <span class="quoted">hassoc_map_assn</span> <span class="quoted">hassoc_new</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> precise_hassoc_map_assn
         <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ent_refl_true hassoc_new_def
       <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> return_cons_rule<span class="main">)</span>


  <span class="keyword1"><span class="command">interpretation</span></span> hassoc<span class="main">:</span> bind_map_is_empty <span class="quoted">hassoc_map_assn</span> <span class="quoted">hassoc_isEmpty</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> precise_hassoc_map_assn hassoc_isEmpty_def ent_refl_true
       <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> precise_pure return_cons_rule<span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">op_assoc_empty</span> <span class="main">‚â°</span> IICF_Map.op_map_empty"</span></span>

  <span class="keyword1"><span class="command">interpretation</span></span> hassoc<span class="main">:</span> map_custom_empty <span class="quoted">op_assoc_empty</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> op_assoc_empty_def<span class="main">)</span>


  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span> <span class="main">=</span> hassoc.empty_hnr<span class="main">[</span><span class="operator">folded</span> op_assoc_empty_def<span class="main">]</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">hassoc_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> <span class="main">‚áí</span> <span class="tfree">'v</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hash_assoc <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hash_assoc Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">hassoc_update</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ht</span></span></span> <span class="main">=</span> return <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ht</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> hassoc_map_assn_Cons<span class="main">:</span>
     <span class="quoted"><span class="quoted">‚Äπhassoc_map_assn <span class="main">(</span><span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">)</span> <span class="keyword1">‚üπ<span class="hidden">‚á©</span><sub>A</sub></span> hassoc_map_assn <span class="main">(</span><span class="free">m</span><span class="main">(</span><span class="free">k</span> <span class="main">‚Ü¶</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="free">p</span><span class="main">)</span> <span class="main">*</span> <span class="keyword1">true</span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hassoc_map_rel_raw_def pure_def br_def<span class="main">)</span>

  <span class="keyword1"><span class="command">interpretation</span></span> hassoc<span class="main">:</span> bind_map_update <span class="quoted">hassoc_map_assn</span> <span class="quoted">hassoc_update</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> return_cons_rule
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hassoc_update_def hassoc_map_assn_Cons<span class="main">)</span>


  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">hassoc_delete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="tfree">'k</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hash_assoc <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hash_assoc Heap‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">hassoc_delete</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">ht</span></span></span> <span class="main">=</span> return <span class="main">(</span>filter <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">‚â†</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ht</span></span></span><span class="main">)</span>‚Ä∫</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> hassoc_map_of_filter_all<span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπmap_of <span class="free">p</span> <span class="main">|`</span> <span class="main">(</span><span class="main">-</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> map_of <span class="main">(</span>filter <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">‚â†</span> <span class="free">k</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def fun_eq_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">presburger</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">lemma</span></span> hassoc_map_assn_hassoc_delete<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">&lt;</span>hassoc_map_assn <span class="free">m</span> <span class="free">p</span><span class="main">&gt;</span> hassoc_delete <span class="free">k</span> <span class="free">p</span> <span class="main">&lt;</span>hassoc_map_assn <span class="main">(</span><span class="free">m</span> <span class="main">|`</span> <span class="main">(</span><span class="main">-</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">‚á©</span><sub>t</sub></span>‚Ä∫</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hassoc_delete_def hassoc_map_rel_raw_def pure_def br_def
           hassoc_map_of_filter_all
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> return_cons_rule<span class="main">)</span>

  <span class="keyword1"><span class="command">interpretation</span></span> hassoc<span class="main">:</span> bind_map_delete <span class="quoted">hassoc_map_assn</span> <span class="quoted">hassoc_delete</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> hassoc_map_assn_hassoc_delete<span class="main">)</span>


  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">hassoc_lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="tfree">'k</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hash_assoc <span class="main">‚áí</span> <span class="tfree">'v</span> option Heap‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="free">hassoc_lookup</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">ht</span></span></span> <span class="main">=</span> return <span class="main">(</span>map_of <span class="free"><span class="bound"><span class="entity">ht</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>‚Ä∫</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> hassoc_map_assn_hassoc_lookup<span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">&lt;</span>hassoc_map_assn <span class="free">m</span> <span class="free">p</span><span class="main">&gt;</span> hassoc_lookup <span class="free">k</span> <span class="free">p</span> <span class="main">&lt;</span><span class="main">Œª</span><span class="bound">r</span><span class="main">.</span> hassoc_map_assn <span class="free">m</span> <span class="free">p</span> <span class="main">*</span> <span class="main">‚Üë</span> <span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="free">m</span> <span class="free">k</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">‚á©</span><sub>t</sub></span>‚Ä∫</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hassoc_lookup_def hassoc_map_rel_raw_def pure_def br_def
             hassoc_map_of_filter_all
           <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> return_cons_rule<span class="main">)</span>

  <span class="keyword1"><span class="command">interpretation</span></span> hassoc<span class="main">:</span> bind_map_lookup <span class="quoted">hassoc_map_assn</span> <span class="quoted">hassoc_lookup</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
     <span class="main">(</span><span class="operator">rule</span> hassoc_map_assn_hassoc_lookup<span class="main">)</span>

  <span class="keyword1"><span class="command">setup</span></span> <span class="entity">Locale_Code.open_block</span>
  <span class="keyword1"><span class="command">interpretation</span></span> hassoc<span class="main">:</span> gen_contains_key_by_lookup <span class="quoted">hassoc_map_assn</span> <span class="quoted">hassoc_lookup</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">setup</span></span> <span class="entity">Locale_Code.close_block</span>

  <span class="keyword1"><span class="command">interpretation</span></span> hassoc<span class="main">:</span> bind_map_contains_key <span class="quoted">hassoc_map_assn</span> <span class="quoted">hassoc.contains_key</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπConversion from assoc to other map‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hash_of_assoc_map</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">hash_of_assoc_map</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> fold <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="bound">m</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">m</span> <span class="bound">k</span> <span class="main">‚â†</span> None <span class="keyword1">then</span> <span class="bound">m</span> <span class="keyword1">else</span> <span class="bound">m</span><span class="main">(</span><span class="bound">k</span> <span class="main">‚Ü¶</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> Map.empty‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_upd_map_add_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">m</span><span class="main">(</span><span class="free">a</span>  <span class="main">‚Ü¶</span> <span class="free">b</span><span class="main">)</span> <span class="main">++</span> <span class="free">m'</span> <span class="main">=</span> <span class="free">m</span> <span class="main">++</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">‚àâ</span> dom <span class="free">m'</span> <span class="keyword1">then</span> <span class="free">m'</span><span class="main">(</span><span class="free">a</span>  <span class="main">‚Ü¶</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">m'</span><span class="main">)</span>‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">m'</span> <span class="free">a</span> <span class="main">=</span> Some <span class="skolem">y</span> <span class="main">‚üπ</span> <span class="free">m</span><span class="main">(</span><span class="free">a</span> <span class="main">‚Ü¶</span> <span class="free">b</span><span class="main">)</span> <span class="main">++</span> <span class="free">m'</span> <span class="main">=</span> <span class="free">m</span> <span class="main">++</span> <span class="free">m'</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> fun_upd_triv fun_upd_upd map_add_assoc map_add_empty map_add_upd
        map_le_iff_map_add_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fold_map_of_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπfold <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="bound">m</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">m</span> <span class="bound">k</span> <span class="main">‚â†</span> None <span class="keyword1">then</span> <span class="bound">m</span> <span class="keyword1">else</span> <span class="bound">m</span><span class="main">(</span><span class="bound">k</span> <span class="main">‚Ü¶</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">m'</span> <span class="main">=</span> map_of <span class="free">xs</span> <span class="main">++</span> <span class="free">m'</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m'</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_upd_map_add_left<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_of_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπmap_of <span class="free">xs</span> <span class="main">=</span> hash_of_assoc_map <span class="free">xs</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> fold_map_of_alt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted">Map.empty</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> hash_of_assoc_map_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hashmap_conv</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hashmap_conv</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hash_of_assoc_map_id<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>hash_of_assoc_map<span class="main">,</span> hashmap_conv<span class="main">)</span> <span class="main">‚àà</span> hassoc_map_rel_raw <span class="main">‚Üí</span> Id‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fun_relI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hassoc_map_rel_raw_def br_def map_of_alt_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hassoc_map_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  hassoc_map_rel_internal_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">hassoc_map_rel</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">=</span> hassoc_map_rel_raw <span class="keyword1">O</span> <span class="main">‚ü®</span><span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">‚ü©</span>map_rel‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hassoc_map_rel_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span><span class="free">V</span><span class="main">‚ü©</span> hassoc_map_rel <span class="main">=</span> hassoc_map_rel_raw <span class="keyword1">O</span> <span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span><span class="free">V</span><span class="main">‚ü©</span>map_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> relAPP_def hassoc_map_rel_internal_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="PAC_Checker_Init">
<div class="head">
<h1>Theory PAC_Checker_Init</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:         PAC_Checker_Init.thy
  Author:       Mathias Fleury, Daniela Kaufmann, JKU
  Maintainer:   Mathias Fleury, JKU
*)</span>
<span class="keyword1"><span class="command">theory</span></span> PAC_Checker_Init
  <span class="keyword2"><span class="keyword">imports</span></span>  <a href="PAC_Checker.html">PAC_Checker</a> <a href="WB_Sort.html">WB_Sort</a> <a href="PAC_Checker_Relation.html">PAC_Checker_Relation</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚ÄπInitial Normalisation of Polynomials‚Ä∫</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπSorting‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπAdapted from the theory <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">text</span><span class="hidden">&gt;</span></span></span><span class="raw_text"><span class="raw_text">‚ÄπHOL-ex.MergeSort‚Ä∫</span></span></span></span> by Tobias Nipkow. We did not change much, but
   we refine it to executable code and try to improve efficiency.
‚Ä∫</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">‚áí</span>  <span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span>
         <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mset_merge <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="main">(</span>merge <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span> <span class="main">+</span> mset <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_merge <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>merge <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">‚à™</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_merge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"transp <span class="free">f</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="main">‚ãÄ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">‚à®</span> <span class="free">f</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">‚üπ</span>
   sorted_wrt <span class="free">f</span> <span class="main">(</span>merge <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">‚ü∑</span> sorted_wrt <span class="free">f</span> <span class="free">xs</span> <span class="main">‚àß</span> sorted_wrt <span class="free">f</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ball_Un not_le less_le <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> transpD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> transpD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">msort</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">msort</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">msort</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">msort</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> merge <span class="free"><span class="bound"><span class="entity">f</span></span></span>
                      <span class="main">(</span><span class="free">msort</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>take <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>
                      <span class="main">(</span><span class="free">msort</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>drop <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">swap_ternary</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span><span class="main">‚áí</span>nat<span class="main">‚áí</span>nat<span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">√ó</span> <span class="tfree">'a</span> <span class="main">√ó</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">√ó</span> <span class="tfree">'a</span> <span class="main">√ó</span> <span class="tfree">'a</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">swap_ternary</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>  <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>
    <span class="keyword1">then</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="numeral">2</span><span class="main">)</span>
    <span class="keyword1">then</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="bound">c</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="numeral">2</span><span class="main">)</span>
    <span class="keyword1">then</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">b</span> <span class="bound">c</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">c</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">msort2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">msort2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">msort2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">msort2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">msort2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> merge <span class="free"><span class="bound"><span class="entity">f</span></span></span>
                      <span class="main">(</span>msort <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>take <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>
                      <span class="main">(</span>msort <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>drop <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span><span class="main">]</span> <span class="main">=</span>
  msort2.simps

<span class="keyword1"><span class="command">declare</span></span> msort2.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  msort2.simps<span class="main">[</span><span class="operator">unfolded</span> swap_ternary.simps<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> msort2.simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> msort_msort2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="tfree">'a</span> <span class="main">::</span> linorder list‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">‚Äπmsort <span class="main">(‚â§)</span> <span class="free">xs</span> <span class="main">=</span> msort2 <span class="main">(‚â§)</span> <span class="free">xs</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span>  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(‚â§)</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'a</span> <span class="main">‚áí</span> bool‚Ä∫</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> msort2.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> transpD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_msort<span class="main">:</span>
  <span class="quoted"><span class="quoted">"transp <span class="free">f</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="main">‚ãÄ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">‚à®</span> <span class="free">f</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">‚üπ</span>
   sorted_wrt <span class="free">f</span> <span class="main">(</span>msort <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> msort.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_merge<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_msort<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="main">(</span>msort <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> msort.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_code<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπSorting applied to monomials‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> merge_coeffs_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>RETURN <span class="keyword1">o</span> merge_coeffs<span class="main">)</span> <span class="free">p</span> <span class="main">=</span>
   <span class="keyword1">REC<span class="hidden">‚á©</span><sub>T</sub></span><span class="main">(</span><span class="main">Œª</span><span class="bound">f</span> <span class="bound">p</span><span class="main">.</span>
     <span class="main">(</span><span class="keyword1">case</span> <span class="bound">p</span> <span class="keyword1">of</span>
       <span class="main">[]</span> <span class="main">‚áí</span> RETURN <span class="main">[]</span>
     <span class="main">|</span> <span class="main">[</span><span class="main"><span class="bound">_</span></span><span class="main">]</span> <span class="main">=&gt;</span> RETURN <span class="bound">p</span>
     <span class="main">|</span> <span class="main">(</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span> <span class="main">‚áí</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="bound">xs</span> <span class="main">=</span> <span class="bound">ys</span>
       <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">+</span> <span class="bound">m</span> <span class="main">‚â†</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="bound">f</span> <span class="main">(</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">n</span> <span class="main">+</span> <span class="bound">m</span><span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">f</span> <span class="bound">p</span>
       <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">p</span> <span class="main">‚Üê</span> <span class="bound">f</span> <span class="main">(</span><span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span><span class="main">;</span> RETURN <span class="main">(</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="free">p</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_coeffs.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> RECT_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> RECT_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x p y q
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> RECT_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span>
     <span class="main">(</span><span class="operator">smt</span> case_prod_conv list.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> merge_coeffs.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nres_monad1
      push_in_let_conv<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> hn_invalid_recover<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπis_pure <span class="free">R</span> <span class="main">‚üπ</span> hn_invalid <span class="free">R</span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">*</span> <span class="keyword1">true</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπis_pure <span class="free">R</span> <span class="main">‚üπ</span> invalid_assn <span class="free">R</span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">*</span> <span class="keyword1">true</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_pure_conv invalid_pure_recover hn_ctxt_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_poly_vars<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="main">[</span><span class="operator">safe_constraint_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"is_pure <span class="main">(</span>poly_assn<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">[</span><span class="operator">safe_constraint_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"is_pure <span class="main">(</span>monom_assn<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">[</span><span class="operator">safe_constraint_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"is_pure <span class="main">(</span>monomial_assn<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">[</span><span class="operator">safe_constraint_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"is_pure string_assn"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> pure_prod list_assn_pure <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_assn_pure_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> invalid_assn_distrib<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπinvalid_assn monom_assn <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>a</sub></span> invalid_assn int_assn <span class="main">=</span> invalid_assn <span class="main">(</span>monom_assn <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>a</sub></span> int_assn<span class="main">)</span>‚Ä∫</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invalid_pure_recover hn_invalid_recover
      <span class="dynamic"><span class="dynamic">safe_constraint_rules</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> hn_invalid_recover<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> safe_poly_vars<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> hn_invalid_recover<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> safe_poly_vars<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> WTF_RF_recover<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπhn_ctxt <span class="main">(</span>invalid_assn monom_assn <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>a</sub></span> invalid_assn int_assn<span class="main">)</span> <span class="free">xb</span>
        <span class="free">x'a</span> <span class="keyword1">‚à®<span class="hidden">‚á©</span><sub>A</sub></span>
       hn_ctxt monomial_assn <span class="free">xb</span> <span class="free">x'a</span> <span class="keyword1">‚üπ<span class="hidden">‚á©</span><sub>t</sub></span>
       hn_ctxt <span class="main">(</span>monomial_assn<span class="main">)</span> <span class="free">xb</span> <span class="free">x'a</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> assn_aci<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> hn_ctxt_def invalid_assn_distrib invalid_pure_recover is_pure_conv
    merge_thms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> merge_true_star reorder_enttI safe_poly_vars<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> star_aci<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> star_aci<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> WTF_RF<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπhn_ctxt <span class="main">(</span>invalid_assn monom_assn <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>a</sub></span> invalid_assn int_assn<span class="main">)</span> <span class="free">xb</span> <span class="free">x'a</span> <span class="main">*</span>
       <span class="main">(</span>hn_invalid poly_assn <span class="free">la</span> <span class="free">l'a</span> <span class="main">*</span> hn_invalid int_assn <span class="free">a2'</span> <span class="free">a2</span> <span class="main">*</span>
        hn_invalid monom_assn <span class="free">a1'</span> <span class="free">a1</span> <span class="main">*</span>
        hn_invalid poly_assn <span class="free">l</span> <span class="free">l'</span> <span class="main">*</span>
        hn_invalid monomial_assn <span class="free">xa</span> <span class="free">x'</span> <span class="main">*</span>
        hn_invalid poly_assn <span class="free">ax</span> <span class="free">px</span><span class="main">)</span> <span class="keyword1">‚üπ<span class="hidden">‚á©</span><sub>t</sub></span>
       hn_ctxt <span class="main">(</span>monomial_assn<span class="main">)</span> <span class="free">xb</span> <span class="free">x'a</span> <span class="main">*</span>
       hn_ctxt poly_assn
        <span class="free">la</span> <span class="free">l'a</span> <span class="main">*</span>
       hn_ctxt poly_assn <span class="free">l</span> <span class="free">l'</span> <span class="main">*</span>
       <span class="main">(</span>hn_invalid int_assn <span class="free">a2'</span> <span class="free">a2</span> <span class="main">*</span>
        hn_invalid monom_assn <span class="free">a1'</span> <span class="free">a1</span> <span class="main">*</span>
        hn_invalid monomial_assn <span class="free">xa</span> <span class="free">x'</span> <span class="main">*</span>
        hn_invalid poly_assn <span class="free">ax</span> <span class="free">px</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπhn_ctxt <span class="main">(</span>invalid_assn monom_assn <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>a</sub></span> invalid_assn int_assn<span class="main">)</span> <span class="free">xa</span> <span class="free">x'</span> <span class="main">*</span>
       <span class="main">(</span>hn_ctxt poly_assn <span class="free">l</span> <span class="free">l'</span> <span class="main">*</span> hn_invalid poly_assn <span class="free">ax</span> <span class="free">px</span><span class="main">)</span> <span class="keyword1">‚üπ<span class="hidden">‚á©</span><sub>t</sub></span>
       hn_ctxt <span class="main">(</span>monomial_assn<span class="main">)</span> <span class="free">xa</span> <span class="free">x'</span> <span class="main">*</span>
       hn_ctxt poly_assn <span class="free">l</span> <span class="free">l'</span> <span class="main">*</span>
       hn_ctxt poly_assn <span class="free">ax</span> <span class="free">px</span> <span class="main">*</span>
       <span class="keyword1">emp</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref_dbg_trans_step</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThe refinement frameword is completely lost here when synthesizing the constants -- it does
  not understant what is pure (actually everything) and what must be destroyed.‚Ä∫</span></span>
<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">merge_coeffs_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚ÄπRETURN <span class="keyword1">o</span> merge_coeffs‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπpoly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>d</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> merge_coeffs_alt_def
    HOL_list.fold_custom_empty poly_assn_alt_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">_</span></span>‚Ä∫</span></span></span> annotate_assn<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">‚Äπpoly_assn‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_dbg_preproc</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_dbg_cons_init</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_dbg_id</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_dbg_monadify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_dbg_opt_init</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WTF_RF <span class="main"><span class="keyword3">|</span></span> <span class="operator">sepref_dbg_trans_step</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_dbg_opt</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_dbg_cons_solve</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_dbg_cons_solve</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_dbg_constraints</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">full_quicksort_poly</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">full_quicksort_poly</span> <span class="main">=</span> full_quicksort_ref <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">‚à®</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">‚àà</span> term_order_rel<span class="main">)</span> fst‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> down_eq_id_list_rel<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚áì</span><span class="main">(</span><span class="main">‚ü®</span>Id<span class="main">‚ü©</span>list_rel<span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">quicksort_poly</span><span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπnat <span class="main">‚áí</span> nat <span class="main">‚áí</span> llist_polynomial <span class="main">‚áí</span> <span class="main">(</span>llist_polynomial<span class="main">)</span> nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">quicksort_poly</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>  <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> quicksort_ref <span class="main">(‚â§)</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">term</span></span> <span class="quoted">partition_between_ref</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">partition_between_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπnat <span class="main">‚áí</span> nat <span class="main">‚áí</span> llist_polynomial <span class="main">‚áí</span> <span class="main">(</span>llist_polynomial <span class="main">√ó</span> nat<span class="main">)</span> nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">partition_between_poly</span> <span class="main">=</span> partition_between_ref <span class="main">(‚â§)</span> fst‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">partition_main_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπnat <span class="main">‚áí</span> nat <span class="main">‚áí</span> llist_polynomial <span class="main">‚áí</span> <span class="main">(</span>llist_polynomial <span class="main">√ó</span> nat<span class="main">)</span> nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">partition_main_poly</span> <span class="main">=</span> partition_main <span class="main">(‚â§)</span>  fst‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> string_list_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">xa</span> <span class="main">::</span>char list list<span class="main">,</span> <span class="free">ya</span><span class="main">)</span> <span class="main">‚àà</span> lexord <span class="main">(</span>lexord <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span> <span class="main">‚üπ</span>
  <span class="main">(</span><span class="free">ya</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">‚àà</span> lexord <span class="main">(</span>lexord <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span> <span class="main">‚üπ</span>
    <span class="main">(</span><span class="free">xa</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">‚àà</span> lexord <span class="main">(</span>lexord <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> less_char_def char.less_trans less_than_char_def lexord_partial_trans p2rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> full_quicksort_sort_poly_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>full_quicksort_poly<span class="main">,</span> sort_poly_spec<span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>Id<span class="main">‚ü©</span>list_rel <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>f</sub></span> <span class="main">‚ü®</span><span class="main">‚ü®</span>Id<span class="main">‚ü©</span>list_rel<span class="main">‚ü©</span>nres_rel‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>Id<span class="main">‚ü©</span>list_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚áì</span><span class="main">(</span><span class="main">‚ü®</span>Id<span class="main">‚ü©</span>list_rel<span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> frefI nres_relI<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> full_quicksort_poly_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> full_quicksort_ref_full_quicksort<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> fref_to_Down_curry<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel2p_def var_order_rel_def p2rel_def Relation.total_on_def
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> string_list_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> total_on_lexord_less_than_char_linear<span class="main">[</span><span class="operator">unfolded</span> var_order_rel_def<span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel2p_def var_order_rel_def p2rel_def Relation.total_on_def less_char_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> xs<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> down_eq_id_list_rel<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> sorted_wrt_map sort_poly_spec_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> full_quicksort_correct_sorted<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">Œª</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">‚à®</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">‚àà</span> term_order_rel<span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> h <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">‚Äπfst‚Ä∫</span></span><span class="main"><span class="main">,</span></span>
       <span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel2p_def var_order_rel_def p2rel_def Relation.total_on_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> string_list_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y
      <span class="keyword1"><span class="command">using</span></span> total_on_lexord_less_than_char_linear<span class="main">[</span><span class="operator">unfolded</span> var_order_rel_def<span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel2p_def var_order_rel_def p2rel_def Relation.total_on_def
        less_char_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel2p_def p2rel_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπLifting to polynomials‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">merge_sort_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">merge_sort_poly</span> <span class="main">=</span> msort <span class="main">(</span><span class="main">Œª</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> fst <span class="bound">a</span> <span class="main">‚â§</span> fst <span class="bound">b</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">merge_monoms_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">merge_monoms_poly</span> <span class="main">=</span> msort <span class="main">(‚â§)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">merge_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">merge_poly</span> <span class="main">=</span> merge <span class="main">(</span><span class="main">Œª</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> fst <span class="bound">a</span> <span class="main">‚â§</span> fst <span class="bound">b</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">merge_monoms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">merge_monoms</span> <span class="main">=</span> merge <span class="main">(‚â§)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">msort_poly_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>String.literal list <span class="main">√ó</span> int<span class="main">)</span> list <span class="main">‚áí</span> <span class="main">_</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">msort_poly_impl</span> <span class="main">=</span> msort <span class="main">(</span><span class="main">Œª</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> fst <span class="bound">a</span> <span class="main">‚â§</span> fst <span class="bound">b</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">msort_monoms_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>String.literal list<span class="main">)</span> <span class="main">‚áí</span> <span class="main">_</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">msort_monoms_impl</span> <span class="main">=</span> msort <span class="main">(‚â§)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> msort_poly_impl_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπmsort_poly_impl <span class="free">xs</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free">xs</span> <span class="keyword1">of</span>
      <span class="main">[]</span> <span class="main">‚áí</span> <span class="main">[]</span>
     <span class="main">|</span> <span class="main">[</span><span class="bound">a</span><span class="main">]</span> <span class="main">‚áí</span> <span class="main">[</span><span class="bound">a</span><span class="main">]</span>
     <span class="main">|</span> <span class="main">[</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">]</span> <span class="main">‚áí</span> <span class="keyword1">if</span> fst <span class="bound">a</span> <span class="main">‚â§</span> fst <span class="bound">b</span> <span class="keyword1">then</span> <span class="main">[</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">]</span><span class="keyword1">else</span> <span class="main">[</span><span class="bound">b</span><span class="main">,</span><span class="bound">a</span><span class="main">]</span>
     <span class="main">|</span> <span class="bound">xs</span> <span class="main">‚áí</span> merge_poly
                      <span class="main">(</span>msort_poly_impl <span class="main">(</span>take <span class="main">(</span><span class="main">(</span>length <span class="bound">xs</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">(</span>msort_poly_impl <span class="main">(</span>drop <span class="main">(</span><span class="main">(</span>length <span class="bound">xs</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> msort_poly_impl_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> merge_poly_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> le_term_order_rel'<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(‚â§)</span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">‚à®</span>  term_order_rel' <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_list_def less_eq_list_def
    lexordp_eq_conv_lexord lexordp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> term_order_rel'_alt_def_lexord term_order_rel'_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">using</span></span> term_order_rel'_alt_def_lexord term_order_rel'_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lexord_eq</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">lexord_eq</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">lexord_eq</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">‚à®</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">‚àß</span> <span class="free">lexord_eq</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">lexord_eq</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπlexord_eq <span class="main">[]</span> <span class="main">[]</span> <span class="main">=</span> True‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπlexord_eq <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">b</span><span class="main">)</span><span class="main">[]</span> <span class="main">=</span> False‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπlexord_eq <span class="main">[]</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> True‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> var_order_rel'<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(‚â§)</span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">‚à®</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">‚àà</span> var_order_rel<span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_list_def less_eq_list_def
    lexordp_eq_conv_lexord lexordp_def var_order_rel_def
    lexordp_conv_lexord p2rel_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> var_order_rel''<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">‚àà</span> var_order_rel <span class="main">‚ü∑</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> leD less_than_char_linear lexord_linear neq_iff var_order_rel' var_order_rel_antisym
      var_order_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lexord_eq_alt_def1<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">a</span> <span class="main">‚â§</span> <span class="free">b</span> <span class="main">=</span> lexord_eq <span class="free">a</span> <span class="free">b</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚ÄπString.literal list‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> le_term_order_rel'
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lexord_eq.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> var_order_rel'' less_eq_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> lexord_eq_alt_def2<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>RETURN <span class="keyword1">oo</span> lexord_eq<span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span>
     <span class="keyword1">REC<span class="hidden">‚á©</span><sub>T</sub></span> <span class="main">(</span><span class="main">Œª</span><span class="bound">f</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span><span class="main">.</span>
        <span class="keyword1">case</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="keyword1">of</span>
           <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚áí</span> RETURN True
         <span class="main">|</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">,</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">‚áí</span>
            <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span> <span class="keyword1">then</span> RETURN True
            <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="keyword1">then</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="keyword1">else</span> RETURN False
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">‚áí</span> RETURN False<span class="main">)</span>
        <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eq_commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lexord_eq.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> RECT_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> RECT_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> RECT_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">var_order'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">var_order'</span> <span class="main">=</span> var_order‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> var_order_rel<span class="main">[</span><span class="operator">def_pat_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(‚àà)</span><span class="main">$</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">$</span>var_order_rel <span class="main">‚â°</span> var_order'<span class="main">$</span><span class="free">x</span><span class="main">$</span><span class="free">y</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p2rel_def rel2p_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> var_order_rel_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπvar_order_rel <span class="main">=</span> p2rel char.lexordp‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p2rel_def char.lexordp_conv_lexord var_order_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> char.lexordp_conv_lexord <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> var_order_rel_var_order<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">‚àà</span> var_order_rel <span class="main">‚ü∑</span> var_order <span class="free">x</span> <span class="free">y</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel2p_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> var_order_string_le<span class="main">[</span><span class="operator">sepref_import_param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(&lt;)</span><span class="main">,</span> var_order'<span class="main">)</span> <span class="main">‚àà</span> string_rel <span class="main">‚Üí</span> string_rel <span class="main">‚Üí</span> bool_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> frefI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> string_rel_def String.less_literal_def
     rel2p_def linorder.lexordp_conv_lexord<span class="main"><span class="main">[</span></span><span class="operator">OF</span> char.linorder_axioms<span class="main"><span class="main">,</span></span>
      <span class="operator">unfolded</span> less_eq_char_def<span class="main"><span class="main">]</span></span> var_order_rel_def
      p2rel_def
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> PAC_Polynomials_Term.less_char_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> char.lexordp_conv_lexord <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sepref_import_param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span> <span class="main">(‚â§)</span><span class="main">,</span> <span class="main">(‚â§)</span><span class="main">)</span> <span class="main">‚àà</span> monom_rel <span class="main">‚Üí</span> monom_rel <span class="main">‚Üí</span>bool_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> list_rel_list_rel_order_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sepref_import_param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span> <span class="main">(&lt;)</span><span class="main">,</span> <span class="main">(&lt;)</span><span class="main">)</span> <span class="main">‚àà</span> string_rel <span class="main">‚Üí</span> string_rel <span class="main">‚Üí</span>bool_rel‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπord.lexordp <span class="main">(&lt;)</span> <span class="main">(</span>literal.explode <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>literal.explode <span class="skolem">aa</span><span class="main">)</span> <span class="main">‚ü∑</span>
       List.lexordp <span class="main">(&lt;)</span> <span class="main">(</span>literal.explode <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>literal.explode <span class="skolem">aa</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">aa</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> PAC_Checker_Relation.less_char_def char.lexordp_conv_lexord less_list_def
        p2rel_def var_order_rel'' var_order_rel_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> PAC_Checker_Relation.less_char_def char.lexordp_conv_lexord less_list_def
        p2rel_def var_order_rel'' var_order_rel_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> string_rel_def less_literal.rep_eq less_than_char_def
      less_eq_list_def PAC_Polynomials_Term.less_char_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> string_rel_def less_literal.rep_eq
        less_list_def char.lexordp_conv_lexord lexordp_eq_refl
        lexordp_eq_conv_lexord<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> lexordp_char_char<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπord_class.lexordp <span class="main">=</span> char.lexordp‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> char.lexordp_def ord_class.lexordp_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">lfp</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sepref_import_param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span> <span class="main">(‚â§)</span><span class="main">,</span> <span class="main">(‚â§)</span><span class="main">)</span> <span class="main">‚àà</span> string_rel <span class="main">‚Üí</span> string_rel <span class="main">‚Üí</span>bool_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> string_rel_def less_eq_literal.rep_eq less_than_char_def
    less_eq_list_def PAC_Polynomials_Term.less_char_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> string_rel_def less_eq_literal.rep_eq less_than_char_def
    less_eq_list_def char.lexordp_eq_conv_lexord lexordp_eq_refl
    lexordp_eq_conv_lexord lexordp_char_char
    <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> less_char_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">sepref_register</span></span> <span class="quoted">lexord_eq</span>
<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">lexord_eq_term</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry <span class="main">(</span>RETURN <span class="keyword1">oo</span> lexord_eq<span class="main">)</span>‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπmonom_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> monom_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> bool_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span><span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> lexord_eq_alt_def2
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">declare</span></span> lexord_eq_term.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>


<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span> <span class="main">=</span> msort_poly_impl_def msort_monoms_impl_def
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  msort_poly_impl_def<span class="main">[</span><span class="operator">unfolded</span> lexord_eq_alt_def1<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  msort_monoms_impl_def<span class="main">[</span><span class="operator">unfolded</span> msort_msort2<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> term_order_rel_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">aa</span><span class="main">)</span> <span class="main">‚àà</span> term_order_rel <span class="main">‚üπ</span>
       <span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="free">ab</span><span class="main">)</span> <span class="main">‚àà</span> term_order_rel <span class="main">‚üπ</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">ab</span><span class="main">)</span> <span class="main">‚àà</span> term_order_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> PAC_Checker_Relation.less_char_def p2rel_def string_list_trans var_order_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> merge_sort_poly_sort_poly_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>RETURN <span class="keyword1">o</span> merge_sort_poly<span class="main">,</span> sort_poly_spec<span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>Id<span class="main">‚ü©</span>list_rel <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>f</sub></span> <span class="main">‚ü®</span><span class="main">‚ü®</span>Id<span class="main">‚ü©</span>list_rel<span class="main">‚ü©</span>nres_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sort_poly_spec_def merge_sort_poly_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> frefI nres_relI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> total_on_lexord_less_than_char_linear var_order_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sorted_msort <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_wrt_map rel2p_def
    le_term_order_rel' transp_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> term_order_rel_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> msort_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπRETURN <span class="keyword1">o</span> <span class="main">(</span>msort <span class="free">f</span><span class="main">)</span> <span class="main">=</span>
     <span class="keyword1">REC<span class="hidden">‚á©</span><sub>T</sub></span> <span class="main">(</span><span class="main">Œª</span><span class="bound">g</span> <span class="bound">xs</span><span class="main">.</span>
        <span class="keyword1">case</span> <span class="bound">xs</span> <span class="keyword1">of</span>
          <span class="main">[]</span> <span class="main">‚áí</span> RETURN <span class="main">[]</span>
        <span class="main">|</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">‚áí</span> RETURN <span class="main">[</span><span class="bound">x</span><span class="main">]</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">‚áí</span> <span class="keyword1">do</span> <span class="main">{</span>
           <span class="bound">a</span> <span class="main">‚Üê</span> <span class="bound">g</span> <span class="main">(</span>take <span class="main">(</span>size <span class="bound">xs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span><span class="main">;</span>
           <span class="bound">b</span> <span class="main">‚Üê</span> <span class="bound">g</span> <span class="main">(</span>drop <span class="main">(</span>size <span class="bound">xs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span><span class="main">;</span>
           RETURN <span class="main">(</span>merge <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> comp_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> msort.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> RECT_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> RECT_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> RECT_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span>
     <span class="main">(</span><span class="operator">smt</span> let_to_bind_conv list.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> msort.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> monomial_rel_order_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚àà</span> monomial_rel <span class="main">‚üπ</span>
       <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">aa</span><span class="main">,</span> <span class="free">bb</span><span class="main">)</span> <span class="main">‚àà</span> monomial_rel <span class="main">‚üπ</span>
       fst <span class="free">x</span> <span class="main">‚â§</span> fst <span class="free">y</span> <span class="main">‚ü∑</span> <span class="free">a</span> <span class="main">‚â§</span> <span class="free">aa</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">using</span></span> list_rel_list_rel_order_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">lemma</span></span> step_rewrite_pure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">K</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="tfree">'olbl</span> <span class="main">√ó</span> <span class="tfree">'lbl</span><span class="main">)</span> set‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‚Äπpure <span class="main">(</span>p2rel <span class="main">(</span><span class="main">‚ü®</span><span class="free">K</span><span class="main">,</span> <span class="free">V</span><span class="main">,</span> <span class="free">R</span><span class="main">‚ü©</span>pac_step_rel_raw<span class="main">)</span><span class="main">)</span> <span class="main">=</span> pac_step_rel_assn <span class="main">(</span>pure <span class="free">K</span><span class="main">)</span> <span class="main">(</span>pure <span class="free">V</span><span class="main">)</span> <span class="main">(</span>pure <span class="free">R</span><span class="main">)</span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπmonomial_assn <span class="main">=</span> pure <span class="main">(</span>monom_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  poly_assn_list<span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπpoly_assn <span class="main">=</span> pure <span class="main">(</span><span class="main">‚ü®</span>monom_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">‚ü©</span>list_rel<span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">xa</span></span></span></span></span></span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> relAPP_def p2rel_def pure_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> H
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">xa</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_assn_pure_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_assn_pure_conv relAPP_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> safe_pac_step_rel_assn<span class="main">[</span><span class="operator">safe_constraint_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_pure <span class="free">K</span> <span class="main">‚üπ</span> is_pure <span class="free">V</span> <span class="main">‚üπ</span> is_pure <span class="free">R</span> <span class="main">‚üπ</span> is_pure <span class="main">(</span>pac_step_rel_assn <span class="free">K</span> <span class="free">V</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> step_rewrite_pure<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> is_pure_conv<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> merge_poly_merge_poly<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>merge_poly<span class="main">,</span> merge_poly<span class="main">)</span>
   <span class="main">‚àà</span> poly_rel <span class="main">‚Üí</span> poly_rel <span class="main">‚Üí</span> poly_rel‚Ä∫</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> merge_poly_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a a' aa a'a
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span> <span class="main">::</span> String.literal list <span class="main">√ó</span> int<span class="main">)</span>
      <span class="main">(</span><span class="bound">b</span> <span class="main">::</span> String.literal list <span class="main">√ó</span> int<span class="main">)</span><span class="main">.</span> fst <span class="bound">a</span> <span class="main">‚â§</span> fst <span class="bound">b</span><span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">aa</span></span>
      <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">a'</span></span> <span class="quoted"><span class="skolem">a'a</span></span>
      <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_relE3 list_relE4 list_relE list_relE2
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> monomial_rel_order_map<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_relE3 list_relE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_relE3 list_relE4 list_relE list_relE2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">fcomp_norm_unfold</span><span class="main">]</span> <span class="main">=</span>
  poly_assn_list<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  step_rewrite_pure<span class="main">(</span>1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> merge_poly_merge_poly2<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚àà</span> poly_rel <span class="main">‚üπ</span> <span class="main">(</span><span class="free">a'</span><span class="main">,</span> <span class="free">b'</span><span class="main">)</span> <span class="main">‚àà</span> poly_rel <span class="main">‚üπ</span>
    <span class="main">(</span>merge_poly <span class="free">a</span> <span class="free">a'</span><span class="main">,</span> merge_poly <span class="free">b</span> <span class="free">b'</span><span class="main">)</span> <span class="main">‚àà</span> poly_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> merge_poly_merge_poly
  <span class="keyword1"><span class="command">unfolding</span></span> fun_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> list_rel_takeD<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free">R</span><span class="main">‚ü©</span>list_rel <span class="main">‚üπ</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">n'</span><span class="main">)</span><span class="main">‚àà</span> Id <span class="main">‚üπ</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">a</span><span class="main">,</span> take <span class="free">n'</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free">R</span><span class="main">‚ü©</span>list_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_rel_eq_listrel listrel_iff_nth relAPP_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_rel_dropD<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free">R</span><span class="main">‚ü©</span>list_rel <span class="main">‚üπ</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">n'</span><span class="main">)</span><span class="main">‚àà</span> Id <span class="main">‚üπ</span> <span class="main">(</span>drop <span class="free">n</span> <span class="free">a</span><span class="main">,</span> drop <span class="free">n'</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span><span class="free">R</span><span class="main">‚ü©</span>list_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_rel_eq_listrel listrel_iff_nth relAPP_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> merge_sort_poly<span class="main">[</span><span class="operator">sepref_import_param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>msort_poly_impl<span class="main">,</span> merge_sort_poly<span class="main">)</span>
   <span class="main">‚àà</span> poly_rel <span class="main">‚Üí</span> poly_rel‚Ä∫</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> merge_sort_poly_def msort_poly_impl_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a a'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span> <span class="main">::</span> String.literal list <span class="main">√ó</span> int<span class="main">)</span>
      <span class="main">(</span><span class="bound">b</span> <span class="main">::</span> String.literal list <span class="main">√ó</span> int<span class="main">)</span><span class="main">.</span> fst <span class="bound">a</span> <span class="main">‚â§</span> fst <span class="bound">b</span><span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="skolem">a</span></span>
      <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">a'</span></span>
      <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> msort.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_relE3 list_relE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> p
      <span class="keyword1"><span class="command">using</span></span> p
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_relE3 list_relE4 list_relE list_relE2
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> merge_poly_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_rel_takeD list_rel_dropD
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> merge_poly_merge_poly2 p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span> p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_imp_same_length<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span> <span class="main">=</span> merge_sort_poly<span class="main">[</span><span class="operator">FCOMP</span> merge_sort_poly_sort_poly_spec<span class="main">]</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">partition_main_poly_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry2 partition_main_poly‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπnat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> nat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> prod_assn poly_assn nat_assn ‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> partition_main_poly_def partition_main_def
    term_order_rel'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    term_order_rel'_alt_def
    le_term_order_rel'
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">declare</span></span> partition_main_poly_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">partition_between_poly_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry2 partition_between_poly‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπnat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> nat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> prod_assn poly_assn nat_assn ‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> partition_between_poly_def partition_between_ref_def
    partition_main_poly_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> choose_pivot3_def
    term_order_rel'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    term_order_rel'_alt_def choose_pivot_def
    lexord_eq_alt_def1
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">declare</span></span> partition_between_poly_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">quicksort_poly_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry2 quicksort_poly‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπnat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> nat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> partition_main_poly_def quicksort_ref_def quicksort_poly_def
    partition_between_poly_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span> <span class="main">=</span> quicksort_poly_impl.refine

<span class="keyword1"><span class="command">sepref_register</span></span> <span class="quoted">quicksort_poly</span>
<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">full_quicksort_poly_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπfull_quicksort_poly‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπpoly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> full_quicksort_poly_def full_quicksort_ref_def
    quicksort_poly_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    le_term_order_rel'<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    term_order_rel'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    List.null_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>


<span class="keyword1"><span class="command">lemmas</span></span> sort_poly_spec_hnr <span class="main">=</span>
  full_quicksort_poly_impl.refine<span class="main">[</span><span class="operator">FCOMP</span> full_quicksort_sort_poly_spec<span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> merge_coeffs_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">normalize_poly_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπnormalize_poly‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπpoly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> normalize_poly_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">declare</span></span> normalize_poly_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">full_quicksort_vars</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">full_quicksort_vars</span> <span class="main">=</span> full_quicksort_ref <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">‚à®</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">‚àà</span> var_order_rel<span class="main">)</span> id‚Ä∫</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">quicksort_vars</span><span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπnat <span class="main">‚áí</span> nat <span class="main">‚áí</span> string list <span class="main">‚áí</span> <span class="main">(</span>string list<span class="main">)</span> nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">quicksort_vars</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>  <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> quicksort_ref <span class="main">(‚â§)</span> id <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">partition_between_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπnat <span class="main">‚áí</span> nat <span class="main">‚áí</span> string list <span class="main">‚áí</span> <span class="main">(</span>string list <span class="main">√ó</span> nat<span class="main">)</span> nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">partition_between_vars</span> <span class="main">=</span> partition_between_ref <span class="main">(‚â§)</span> id‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">partition_main_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπnat <span class="main">‚áí</span> nat <span class="main">‚áí</span> string list <span class="main">‚áí</span> <span class="main">(</span>string list <span class="main">√ó</span> nat<span class="main">)</span> nres‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">partition_main_vars</span> <span class="main">=</span> partition_main <span class="main">(‚â§)</span> id‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> total_on_lexord_less_than_char_linear2<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">xs</span> <span class="main">‚â†</span> <span class="free">ys</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">‚àâ</span> lexord <span class="main">(</span>less_than_char<span class="main">)</span> <span class="main">‚ü∑</span>
       <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">xs</span><span class="main">)</span> <span class="main">‚àà</span> lexord less_than_char‚Ä∫</span></span>
   <span class="keyword1"><span class="command">using</span></span> lexord_linear<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπless_than_char‚Ä∫</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">]</span>
   <span class="keyword1"><span class="command">using</span></span> lexord_linear<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπless_than_char‚Ä∫</span></span><span class="main">]</span> less_than_char_linear
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Relation.total_on_def<span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> lexord_irrefl<span class="main">[</span><span class="operator">OF</span> irrefl_less_than_char<span class="main">]</span>
     antisym_lexord<span class="main">[</span><span class="operator">OF</span> antisym_less_than_char irrefl_less_than_char<span class="main">]</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> antisym_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> string_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">xa</span><span class="main">,</span> <span class="free">ya</span><span class="main">)</span> <span class="main">‚àà</span> lexord <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>char<span class="main">,</span> <span class="bound">y</span><span class="main">::</span>char<span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span> <span class="main">‚üπ</span>
  <span class="main">(</span><span class="free">ya</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">‚àà</span> lexord <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>char<span class="main">,</span> <span class="bound">y</span><span class="main">::</span>char<span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span> <span class="main">‚üπ</span>
  <span class="main">(</span><span class="free">xa</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">‚àà</span> lexord <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>char<span class="main">,</span> <span class="bound">y</span><span class="main">::</span>char<span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> less_char_def char.less_trans less_than_char_def lexord_partial_trans p2rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> full_quicksort_sort_vars_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>full_quicksort_vars<span class="main">,</span> sort_coeff<span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>Id<span class="main">‚ü©</span>list_rel <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>f</sub></span> <span class="main">‚ü®</span><span class="main">‚ü®</span>Id<span class="main">‚ü©</span>list_rel<span class="main">‚ü©</span>nres_rel‚Ä∫</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>Id<span class="main">‚ü©</span>list_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚áì</span><span class="main">(</span><span class="main">‚ü®</span>Id<span class="main">‚ü©</span>list_rel<span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> frefI nres_relI<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> full_quicksort_vars_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> full_quicksort_ref_full_quicksort<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> fref_to_Down_curry<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel2p_def var_order_rel_def p2rel_def Relation.total_on_def
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> string_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> total_on_lexord_less_than_char_linear2<span class="main">[</span><span class="operator">unfolded</span> var_order_rel_def<span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel2p_def var_order_rel_def p2rel_def Relation.total_on_def less_char_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> xs<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> down_eq_id_list_rel<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> sorted_wrt_map sort_coeff_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> full_quicksort_correct_sorted<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">Œª</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">‚à®</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">‚àà</span> var_order_rel<span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> h <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">‚Äπid‚Ä∫</span></span><span class="main"><span class="main">,</span></span>
       <span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel2p_def var_order_rel_def p2rel_def Relation.total_on_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> string_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y
      <span class="keyword1"><span class="command">using</span></span> total_on_lexord_less_than_char_linear2<span class="main">[</span><span class="operator">unfolded</span> var_order_rel_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel2p_def var_order_rel_def p2rel_def Relation.total_on_def
        less_char_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel2p_def p2rel_def rel2p_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">partition_main_vars_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry2 partition_main_vars‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπnat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> nat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> <span class="main">(</span>monom_assn<span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> prod_assn <span class="main">(</span>monom_assn<span class="main">)</span> nat_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> partition_main_vars_def partition_main_def
    var_order_rel_var_order
    var_order'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    term_order_rel'_alt_def
    le_term_order_rel'
    id_apply
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">declare</span></span> partition_main_vars_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">partition_between_vars_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry2 partition_between_vars‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπnat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> nat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> monom_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> prod_assn monom_assn nat_assn ‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> partition_between_vars_def partition_between_ref_def
    partition_main_vars_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> choose_pivot3_def
    term_order_rel'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    term_order_rel'_alt_def choose_pivot_def
    le_term_order_rel' id_apply
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">declare</span></span> partition_between_vars_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">quicksort_vars_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry2 quicksort_vars‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπnat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> nat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> monom_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> monom_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> partition_main_vars_def quicksort_ref_def quicksort_vars_def
    partition_between_vars_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span> <span class="main">=</span> quicksort_vars_impl.refine

<span class="keyword1"><span class="command">sepref_register</span></span> <span class="quoted">quicksort_vars</span>


<span class="keyword1"><span class="command">lemma</span></span> le_var_order_rel<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(‚â§)</span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">‚à®</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">‚àà</span> var_order_rel<span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_list_def less_eq_list_def rel2p_def
      p2rel_def lexordp_conv_lexord p2rel_def var_order_rel_def
    lexordp_eq_conv_lexord lexordp_def<span class="main">)</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">full_quicksort_vars_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπfull_quicksort_vars‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπmonom_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> monom_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> full_quicksort_vars_def full_quicksort_ref_def
    quicksort_vars_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    le_var_order_rel<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    term_order_rel'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    List.null_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>


<span class="keyword1"><span class="command">lemmas</span></span> sort_vars_spec_hnr <span class="main">=</span>
  full_quicksort_vars_impl.refine<span class="main">[</span><span class="operator">FCOMP</span> full_quicksort_sort_vars_spec<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> string_rel_order_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">‚àà</span> string_rel <span class="main">‚üπ</span>
       <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">aa</span><span class="main">)</span> <span class="main">‚àà</span> string_rel <span class="main">‚üπ</span>
       <span class="free">x</span> <span class="main">‚â§</span> <span class="free">y</span> <span class="main">‚ü∑</span> <span class="free">a</span> <span class="main">‚â§</span> <span class="free">aa</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> string_rel_def less_eq_literal.rep_eq less_than_char_def
    less_eq_list_def PAC_Polynomials_Term.less_char_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> string_rel_def less_eq_literal.rep_eq less_than_char_def
    less_eq_list_def char.lexordp_eq_conv_lexord lexordp_eq_refl
    lexordp_char_char lexordp_eq_conv_lexord
    <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> less_char_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> merge_monoms_merge_monoms<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>merge_monoms<span class="main">,</span> merge_monoms<span class="main">)</span> <span class="main">‚àà</span> monom_rel <span class="main">‚Üí</span> monom_rel <span class="main">‚Üí</span> monom_rel‚Ä∫</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> merge_monoms_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a a' aa a'a
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span> <span class="main">::</span> String.literal<span class="main">)</span>
      <span class="main">(</span><span class="bound">b</span> <span class="main">::</span> String.literal<span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">‚â§</span> <span class="bound">b</span><span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">aa</span></span>
      <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">a'</span></span> <span class="quoted"><span class="skolem">a'a</span></span>
      <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_relE3 list_relE4 list_relE list_relE2
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> string_rel_order_map<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_relE3 list_relE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_relE3 list_relE4 list_relE list_relE2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> merge_monoms_merge_monoms2<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚àà</span> monom_rel <span class="main">‚üπ</span> <span class="main">(</span><span class="free">a'</span><span class="main">,</span> <span class="free">b'</span><span class="main">)</span> <span class="main">‚àà</span> monom_rel <span class="main">‚üπ</span>
    <span class="main">(</span>merge_monoms <span class="free">a</span> <span class="free">a'</span><span class="main">,</span> merge_monoms <span class="free">b</span> <span class="free">b'</span><span class="main">)</span> <span class="main">‚àà</span> monom_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> merge_monoms_merge_monoms
  <span class="keyword1"><span class="command">unfolding</span></span> fun_rel_def merge_monoms_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> msort_monoms_impl<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>msort_monoms_impl<span class="main">,</span> merge_monoms_poly<span class="main">)</span>
   <span class="main">‚àà</span> monom_rel <span class="main">‚Üí</span> monom_rel‚Ä∫</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> msort_monoms_impl_def merge_monoms_poly_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a a'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span> <span class="main">::</span> String.literal<span class="main">)</span>
      <span class="main">(</span><span class="bound">b</span> <span class="main">::</span> String.literal<span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">‚â§</span> <span class="bound">b</span><span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="skolem">a</span></span>
      <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">a'</span></span>
      <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> msort.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_relE3 list_relE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> p
      <span class="keyword1"><span class="command">using</span></span> p
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_relE3 list_relE4 list_relE list_relE2
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> merge_monoms_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_rel_takeD list_rel_dropD
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> merge_monoms_merge_monoms2 p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span> p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_rel_imp_same_length<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> merge_sort_monoms_sort_monoms_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>RETURN <span class="keyword1">o</span> merge_monoms_poly<span class="main">,</span> sort_coeff<span class="main">)</span> <span class="main">‚àà</span> <span class="main">‚ü®</span>Id<span class="main">‚ü©</span>list_rel <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>f</sub></span> <span class="main">‚ü®</span><span class="main">‚ü®</span>Id<span class="main">‚ü©</span>list_rel<span class="main">‚ü©</span>nres_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> merge_monoms_poly_def sort_coeff_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> frefI nres_relI<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sorted_msort <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_wrt_map rel2p_def
     le_term_order_rel' transp_def rel2p_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span>
     <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> le_var_order_rel<span class="main">)</span>

<span class="keyword1"><span class="command">sepref_register</span></span> <span class="quoted">sort_coeff</span>
<span class="keyword1"><span class="command">lemma</span></span>  <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>return <span class="keyword1">o</span> msort_monoms_impl<span class="main">,</span> sort_coeff<span class="main">)</span> <span class="main">‚àà</span> monom_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> monom_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> msort_monoms_impl<span class="main">[</span><span class="operator">sepref_param</span><span class="main">,</span> <span class="operator">FCOMP</span> merge_sort_monoms_sort_monoms_spec<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">sort_all_coeffs_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπsort_all_coeffs‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπpoly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sort_all_coeffs_def
    HOL_list.fold_custom_empty
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">declare</span></span> sort_all_coeffs_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> merge_coeffs0_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>RETURN <span class="keyword1">o</span> merge_coeffs0<span class="main">)</span> <span class="free">p</span> <span class="main">=</span>
   <span class="keyword1">REC<span class="hidden">‚á©</span><sub>T</sub></span><span class="main">(</span><span class="main">Œª</span><span class="bound">f</span> <span class="bound">p</span><span class="main">.</span>
     <span class="main">(</span><span class="keyword1">case</span> <span class="bound">p</span> <span class="keyword1">of</span>
       <span class="main">[]</span> <span class="main">‚áí</span> RETURN <span class="main">[]</span>
     <span class="main">|</span> <span class="main">[</span><span class="bound">p</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="keyword1">if</span> snd <span class="bound">p</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> RETURN <span class="main">[]</span> <span class="keyword1">else</span> RETURN <span class="main">[</span><span class="bound">p</span><span class="main">]</span>
     <span class="main">|</span> <span class="main">(</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span> <span class="main">‚áí</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="bound">xs</span> <span class="main">=</span> <span class="bound">ys</span>
       <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">+</span> <span class="bound">m</span> <span class="main">‚â†</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="bound">f</span> <span class="main">(</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">n</span> <span class="main">+</span> <span class="bound">m</span><span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">f</span> <span class="bound">p</span>
       <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span>
          <span class="keyword1">do</span> <span class="main">{</span><span class="bound">p</span> <span class="main">‚Üê</span> <span class="bound">f</span> <span class="main">(</span><span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span><span class="main">;</span>
            RETURN <span class="bound">p</span><span class="main">}</span>
       <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">p</span> <span class="main">‚Üê</span> <span class="bound">f</span> <span class="main">(</span><span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span><span class="main">;</span>
            RETURN <span class="main">(</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="free">p</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eq_commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_coeffs0.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> RECT_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> RECT_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> RECT_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> let_to_bind_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπAgain, Sepref does not understand what is going here.‚Ä∫</span></span>
<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">merge_coeffs0_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚ÄπRETURN <span class="keyword1">o</span> merge_coeffs0‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπpoly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> merge_coeffs0_alt_def
    HOL_list.fold_custom_empty
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_dbg_preproc</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_dbg_cons_init</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_dbg_id</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_dbg_monadify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_dbg_opt_init</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WTF_RF <span class="main"><span class="keyword3">|</span></span> <span class="operator">sepref_dbg_trans_step</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_dbg_opt</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_dbg_cons_solve</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_dbg_cons_solve</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_dbg_constraints</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">declare</span></span> merge_coeffs0_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">fully_normalize_poly_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπfull_normalize_poly‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπpoly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> full_normalize_poly_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">declare</span></span> fully_normalize_poly_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>


<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="PAC_Version">
<div class="head">
<h1>Theory PAC_Version</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:         PAC_Version.thy
  Author:       Mathias Fleury, Daniela Kaufmann, JKU
  Maintainer:   Mathias Fleury, JKU
*)</span>
<span class="keyword1"><span class="command">theory</span></span> PAC_Version
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThis code was taken from IsaFoR. However, for the AFP, we use the version name <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">text</span><span class="hidden">&gt;</span></span></span><span class="raw_text"><span class="raw_text">‚ÄπAFP‚Ä∫</span></span></span></span>,
instead of a mercurial version. ‚Ä∫</span></span>
<span class="keyword1"><span class="command">local_setup</span></span> <span class="quoted">‚Äπ
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">version</span> <span class="main">=</span> <span class="inner_quoted">"AFP"</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    Local_Theory.define
      <span class="main">(</span><span class="main">(</span><span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‚Äπversion‚Ä∫</span></span><span class="main">,</span> NoSyn<span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="main">(</span><span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‚Äπversion_def‚Ä∫</span></span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="entity">HOLogic.mk_literal</span> <span class="entity">version</span><span class="main">)</span><span class="main">)</span> #&gt; <span class="main">#</span><span class="inner_numeral">2</span>
  <span class="keyword2"><span class="keyword">end</span></span>
‚Ä∫</span>

<span class="keyword1"><span class="command">declare</span></span> version_def <span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="PAC_Checker_Synthesis">
<div class="head">
<h1>Theory PAC_Checker_Synthesis</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:         PAC_Checker_Synthesis.thy
  Author:       Mathias Fleury, Daniela Kaufmann, JKU
  Maintainer:   Mathias Fleury, JKU
*)</span>
<span class="keyword1"><span class="command">theory</span></span> PAC_Checker_Synthesis
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="PAC_Checker.html">PAC_Checker</a> <a href="WB_Sort.html">WB_Sort</a> <a href="PAC_Checker_Relation.html">PAC_Checker_Relation</a>
    <a href="PAC_Checker_Init.html">PAC_Checker_Init</a> <a href="More_Loops.html">More_Loops</a> <a href="PAC_Version.html">PAC_Version</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚ÄπCode Synthesis of the Complete Checker‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπWe here combine refine the full checker, using the initialisation provided in another file and
adding more efficient data structures (mostly replacing the set of variables by a more efficient
hash map).‚Ä∫</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">vars_assn</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">vars_assn</span> <span class="main">‚â°</span> hs.assn string_assn‚Ä∫</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">vars_of_monom_in</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">vars_of_monom_in</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">vars_of_monom_in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span> <span class="main">‚ü∑</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span> <span class="main">‚àß</span> <span class="free">vars_of_monom_in</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">vars_of_poly_in</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">vars_of_poly_in</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">vars_of_poly_in</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span> <span class="main">‚ü∑</span> vars_of_monom_in <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span> <span class="main">‚àß</span> <span class="free">vars_of_poly_in</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vars_of_monom_in_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπvars_of_monom_in <span class="free">xs</span> <span class="free">ùí±</span> <span class="main">‚ü∑</span> set <span class="free">xs</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
   <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_llist_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπvars_llist <span class="free">xs</span> <span class="main">‚äÜ</span> <span class="free">ùí±</span> <span class="main">‚ü∑</span> vars_of_poly_in <span class="free">xs</span> <span class="free">ùí±</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_llist_def vars_of_monom_in_alt_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_of_monom_in_alt_def2<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπvars_of_monom_in <span class="free">xs</span> <span class="free">ùí±</span> <span class="main">‚ü∑</span> fold <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">‚àß</span> <span class="bound">x</span> <span class="main">‚àà</span> <span class="free">ùí±</span><span class="main">)</span> <span class="free">xs</span> True‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> foldr_fold<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">vars_of_monom_in_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry <span class="main">(</span>RETURN <span class="keyword1">oo</span> vars_of_monom_in<span class="main">)</span>‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>list_assn string_assn<span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> vars_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> bool_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vars_of_monom_in_alt_def2
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">declare</span></span> vars_of_monom_in_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_of_poly_in_alt_def2<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπvars_of_poly_in <span class="free">xs</span> <span class="free">ùí±</span> <span class="main">‚ü∑</span> fold <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">‚àß</span> vars_of_monom_in <span class="bound">x</span> <span class="free">ùí±</span><span class="main">)</span> <span class="free">xs</span> True‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> foldr_fold<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">vars_of_poly_in_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry <span class="main">(</span>RETURN <span class="keyword1">oo</span> vars_of_poly_in<span class="main">)</span>‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>poly_assn<span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> vars_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> bool_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vars_of_poly_in_alt_def2
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">declare</span></span> vars_of_poly_in_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">union_vars_monom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπstring list <span class="main">‚áí</span> string set <span class="main">‚áí</span> string set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">union_vars_monom</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span> <span class="main">=</span> fold insert <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">union_vars_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπllist_polynomial <span class="main">‚áí</span> string set <span class="main">‚áí</span> string set‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">union_vars_poly</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span> <span class="main">=</span> fold <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="bound">ùí±</span><span class="main">.</span> union_vars_monom <span class="bound">xs</span> <span class="bound">ùí±</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> union_vars_monom_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπunion_vars_monom <span class="free">xs</span> <span class="free">ùí±</span> <span class="main">=</span> <span class="free">ùí±</span> <span class="main">‚à™</span> set <span class="free">xs</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> union_vars_monom_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> foldr_fold<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> union_vars_poly_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπunion_vars_poly <span class="free">xs</span> <span class="free">ùí±</span> <span class="main">=</span> <span class="free">ùí±</span> <span class="main">‚à™</span> vars_llist <span class="free">xs</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> union_vars_poly_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> foldr_fold<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> union_vars_monom_alt_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_llist_def union_vars_monom_alt_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">union_vars_monom_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry <span class="main">(</span>RETURN <span class="keyword1">oo</span> union_vars_monom<span class="main">)</span>‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπmonom_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> vars_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>d</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> vars_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> union_vars_monom_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">declare</span></span> union_vars_monom_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">union_vars_poly_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry <span class="main">(</span>RETURN <span class="keyword1">oo</span> union_vars_poly<span class="main">)</span>‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπpoly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> vars_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>d</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> vars_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> union_vars_poly_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">declare</span></span> union_vars_poly_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>


<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Autoref_Fix_Rel.CONSTRAINT

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">status_assn</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">status_assn</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> CSUCCESS CSUCCESS <span class="main">=</span> <span class="keyword1">emp</span>‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">status_assn</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> CFOUND CFOUND <span class="main">=</span> <span class="keyword1">emp</span>‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">status_assn</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>CFAILED <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>CFAILED <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>‚Ä∫</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">status_assn</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="keyword1">false</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> SUCCESS_hnr<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>uncurry0 <span class="main">(</span>return CSUCCESS<span class="main">)</span><span class="main">,</span> uncurry0 <span class="main">(</span>RETURN CSUCCESS<span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> unit_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> status_assn <span class="free">R</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sepref_to_hoare</span><span class="main">)</span>
    <span class="operator">sep_auto</span>

<span class="keyword1"><span class="command">lemma</span></span> FOUND_hnr<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>uncurry0 <span class="main">(</span>return CFOUND<span class="main">)</span><span class="main">,</span> uncurry0 <span class="main">(</span>RETURN CFOUND<span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> unit_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> status_assn <span class="free">R</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sepref_to_hoare</span><span class="main">)</span>
    <span class="operator">sep_auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_success_hnr<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπCONSTRAINT is_pure <span class="free">R</span> <span class="main">‚üπ</span>
  <span class="main">(</span><span class="main">(</span>return <span class="keyword1">o</span> is_cfound<span class="main">)</span><span class="main">,</span> <span class="main">(</span>RETURN <span class="keyword1">o</span> is_cfound<span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">(</span>status_assn <span class="free">R</span><span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> bool_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sepref_to_hoare</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> xi x<span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">xi</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_cfailed_hnr<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπCONSTRAINT is_pure <span class="free">R</span> <span class="main">‚üπ</span>
  <span class="main">(</span><span class="main">(</span>return <span class="keyword1">o</span> is_cfailed<span class="main">)</span><span class="main">,</span> <span class="main">(</span>RETURN <span class="keyword1">o</span> is_cfailed<span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">(</span>status_assn <span class="free">R</span><span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> bool_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sepref_to_hoare</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> xi x<span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">xi</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span>  <span class="operator">sep_auto</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> merge_cstatus_hnr<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπCONSTRAINT is_pure <span class="free">R</span> <span class="main">‚üπ</span>
  <span class="main">(</span>uncurry <span class="main">(</span>return <span class="keyword1">oo</span> merge_cstatus<span class="main">)</span><span class="main">,</span> uncurry <span class="main">(</span>RETURN <span class="keyword1">oo</span> merge_cstatus<span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span>
    <span class="main">(</span>status_assn <span class="free">R</span><span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span>  <span class="main">(</span>status_assn <span class="free">R</span><span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> status_assn <span class="free">R</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sepref_to_hoare</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">bi</span></span></span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">a</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">ai</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_pure_conv pure_app_eq<span class="main">)</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">add_poly_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπadd_poly_l‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>poly_assn <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_poly_l_def
    HOL_list.fold_custom_empty
    term_order_rel'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    term_order_rel'_alt_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>


<span class="keyword1"><span class="command">declare</span></span> add_poly_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>


<span class="keyword1"><span class="command">sepref_register</span></span> <span class="quoted">mult_monomials</span>
<span class="keyword1"><span class="command">lemma</span></span> mult_monoms_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>RETURN <span class="keyword1">oo</span> mult_monoms<span class="main">)</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="keyword1">REC<span class="hidden">‚á©</span><sub>T</sub></span>
    <span class="main">(</span><span class="main">Œª</span><span class="bound">f</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span>
      <span class="keyword1">case</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span> <span class="keyword1">of</span>
        <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚áí</span> RETURN <span class="bound">q</span>
       <span class="main">|</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">‚áí</span> RETURN <span class="bound">p</span>
       <span class="main">|</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">q</span><span class="main">)</span> <span class="main">‚áí</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">pq</span> <span class="main">‚Üê</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">;</span>
           RETURN <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">pq</span><span class="main">)</span><span class="main">}</span>
        <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">‚àà</span> var_order_rel
        <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">pq</span> <span class="main">‚Üê</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">q</span><span class="main">)</span><span class="main">;</span>
          RETURN <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">pq</span><span class="main">)</span><span class="main">}</span>
        <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">pq</span> <span class="main">‚Üê</span>  <span class="bound">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">;</span>
          RETURN <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">pq</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eq_commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mult_monoms.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> RECT_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> RECT_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x p y q
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> RECT_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> let_to_bind_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">mult_monoms_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry <span class="main">(</span>RETURN <span class="keyword1">oo</span> mult_monoms<span class="main">)</span>‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>monom_assn<span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> <span class="main">(</span>monom_assn<span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> <span class="main">(</span>monom_assn<span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> mult_poly_raw_def
    HOL_list.fold_custom_empty
    var_order'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    term_order_rel'_alt_def
    mult_monoms_alt_def
    var_order_rel_var_order
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">declare</span></span> mult_monoms_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">mult_monomials_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry <span class="main">(</span>RETURN <span class="keyword1">oo</span> mult_monomials<span class="main">)</span>‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>monomial_assn<span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> <span class="main">(</span>monomial_assn<span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> <span class="main">(</span>monomial_assn<span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> mult_monomials_def
    HOL_list.fold_custom_empty
    term_order_rel'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    term_order_rel'_alt_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>


<span class="keyword1"><span class="command">lemma</span></span> map_append_alt_def2<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>RETURN <span class="keyword1">o</span> <span class="main">(</span>map_append <span class="free">f</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> <span class="keyword1">REC<span class="hidden">‚á©</span><sub>T</sub></span>
    <span class="main">(</span><span class="main">Œª</span><span class="bound">g</span> <span class="bound">xs</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">xs</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">‚áí</span> RETURN <span class="free">b</span>
      <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">‚áí</span> <span class="keyword1">do</span> <span class="main">{</span>
           <span class="bound">y</span> <span class="main">‚Üê</span> <span class="bound">g</span> <span class="bound">xs</span><span class="main">;</span>
           RETURN <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">y</span><span class="main">)</span>
     <span class="main">}</span><span class="main">)</span> <span class="free">xs</span>‚Ä∫</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eq_commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> map_append.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> RECT_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> RECT_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map_append_poly_mult</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">map_append_poly_mult</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> map_append <span class="main">(</span>mult_monomials <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">declare</span></span> mult_monomials_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">map_append_poly_mult_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry2 <span class="main">(</span>RETURN <span class="keyword1">ooo</span> map_append_poly_mult<span class="main">)</span>‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπmonomial_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_append_poly_mult_def
    map_append_alt_def2
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">declare</span></span> map_append_poly_mult_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπTODO <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> map_by_foldl<span class="antiquote"><span class="antiquote">}</span></span></span></span> is the worst possible implementation of map!‚Ä∫</span></span>
<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">mult_poly_raw_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry <span class="main">(</span>RETURN <span class="keyword1">oo</span> mult_poly_raw<span class="main">)</span>‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπpoly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">eta_contract</span> <span class="main"><span class="main">=</span></span> <span class="quasi_keyword">false</span><span class="main">,</span> <span class="operator">show_abbrevs</span><span class="main"><span class="main">=</span></span><span class="quasi_keyword">false</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> mult_poly_raw_def
    HOL_list.fold_custom_empty
    term_order_rel'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    term_order_rel'_alt_def
    foldl_conv_fold
    fold_eq_nfoldli
    map_append_poly_mult_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    map_append_alt_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">declare</span></span> mult_poly_raw_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>


<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">mult_poly_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry mult_poly_full‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπpoly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> mult_poly_full_def
    HOL_list.fold_custom_empty
    term_order_rel'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    term_order_rel'_alt_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">declare</span></span> mult_poly_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> inverse_monomial<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπmonom_rel<span class="main">¬Ø</span> <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel <span class="main">=</span> <span class="main">(</span>monom_rel <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> int_rel<span class="main">)</span><span class="main">¬Ø</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_poly_rel_eq<span class="main">[</span><span class="operator">sepref_import_param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(=)</span><span class="main">,</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">‚àà</span> poly_rel <span class="main">‚Üí</span> poly_rel <span class="main">‚Üí</span> bool_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> list_rel_sv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπmonomial_rel‚Ä∫</span></span><span class="main">,</span> <span class="operator">OF</span> single_valued_monomial_rel<span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> list_rel_sv<span class="main">[</span><span class="operator">OF</span> single_valued_monomial_rel'<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> IS_LEFT_UNIQUE_def inv_list_rel_eq<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> inv_list_rel_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> frefI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>
      rel2p_def single_valued_def p2rel_def
    <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> inv_list_rel_eq<span class="main">)</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">weak_equality_l_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry weak_equality_l‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπpoly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> bool_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> weak_equality_l_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">declare</span></span> weak_equality_l_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>
<span class="keyword1"><span class="command">sepref_register</span></span> <span class="quoted">add_poly_l</span> <span class="quoted">mult_poly_full</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">raw_string_assn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπstring <span class="main">‚áí</span> string <span class="main">‚áí</span> assn‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">raw_string_assn</span> <span class="main">‚â°</span> list_assn id_assn‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">show_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπnat <span class="main">‚áí</span> string‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">show_nat</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> show <span class="free"><span class="bound"><span class="entity">i</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sepref_import_param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>show_nat<span class="main">,</span> show_nat<span class="main">)</span> <span class="main">‚àà</span> nat_rel <span class="main">‚Üí</span> <span class="main">‚ü®</span>Id<span class="main">‚ü©</span>list_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fun_relI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> status_assn_pure_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπstatus_assn <span class="main">(</span>id_assn<span class="main">)</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> id_assn <span class="free">a</span> <span class="free">b</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pure_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>uncurry3 <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> return <span class="keyword1">oo</span> <span class="main">(</span>error_msg_not_equal_dom <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry3 check_not_equal_dom_err<span class="main">)</span> <span class="main">‚àà</span>
  poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> raw_string_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> show_nat_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> list_assn_pure_conv
    prod_assn_pure_conv check_not_equal_dom_err_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sepref_to_hoare</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> error_msg_not_equal_dom_def<span class="main">)</span>



<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>return <span class="keyword1">o</span> <span class="main">(</span>error_msg_notin_dom <span class="keyword1">o</span> nat_of_uint64<span class="main">)</span><span class="main">,</span> RETURN <span class="keyword1">o</span> error_msg_notin_dom<span class="main">)</span>
   <span class="main">‚àà</span> uint64_nat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> raw_string_assn‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>return <span class="keyword1">o</span> <span class="main">(</span>error_msg_reused_dom <span class="keyword1">o</span> nat_of_uint64<span class="main">)</span><span class="main">,</span> RETURN <span class="keyword1">o</span> error_msg_reused_dom<span class="main">)</span>
    <span class="main">‚àà</span> uint64_nat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> raw_string_assn‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>uncurry <span class="main">(</span>return <span class="keyword1">oo</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">i</span><span class="main">.</span> error_msg <span class="main">(</span>nat_of_uint64 <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry <span class="main">(</span>RETURN <span class="keyword1">oo</span> error_msg<span class="main">)</span><span class="main">)</span>
    <span class="main">‚àà</span> uint64_nat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> raw_string_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span>  <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> status_assn raw_string_assn‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>uncurry <span class="main">(</span>return <span class="keyword1">oo</span>  error_msg<span class="main">)</span><span class="main">,</span> uncurry <span class="main">(</span>RETURN <span class="keyword1">oo</span> error_msg<span class="main">)</span><span class="main">)</span>
   <span class="main">‚àà</span> nat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> raw_string_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span>  <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> status_assn raw_string_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> error_msg_notin_dom_def list_assn_pure_conv list_rel_id_simp
  <span class="keyword1"><span class="command">unfolding</span></span> status_assn_pure_conv
  <span class="keyword1"><span class="command">unfolding</span></span> show_nat_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sepref_to_hoare</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> uint64_nat_rel_def br_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">check_addition_l_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry6 check_addition_l‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπpoly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> polys_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> vars_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> uint64_nat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> uint64_nat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span>
        uint64_nat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span>  <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> status_assn raw_string_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> mult_poly_full_def
    HOL_list.fold_custom_empty
    term_order_rel'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    term_order_rel'_alt_def
    check_addition_l_def
    in_dom_m_lookup_iff
    fmlookup'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    vars_llist_alt_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">declare</span></span> check_addition_l_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>

<span class="keyword1"><span class="command">sepref_register</span></span> <span class="quoted">check_mult_l_dom_err</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_mult_l_dom_err_impl</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">check_mult_l_dom_err_impl</span> <span class="free"><span class="bound"><span class="entity">pd</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">ia</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pd</span></span></span> <span class="keyword1">then</span> <span class="inner_quoted">''The polynomial with id ''</span> <span class="main">@</span> show <span class="main">(</span>nat_of_uint64 <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="inner_quoted">'' was not found''</span> <span class="keyword1">else</span> <span class="inner_quoted">''''</span><span class="main">)</span> <span class="main">@</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ia</span></span></span> <span class="keyword1">then</span> <span class="inner_quoted">''The id of the resulting id ''</span> <span class="main">@</span> show <span class="main">(</span>nat_of_uint64 <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="inner_quoted">'' was already given''</span> <span class="keyword1">else</span> <span class="inner_quoted">''''</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_mult_l_mult_err_impl</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">check_mult_l_mult_err_impl</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">pq</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span>
    <span class="inner_quoted">''Multiplying ''</span> <span class="main">@</span> show <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' by ''</span> <span class="main">@</span> show <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' gives ''</span> <span class="main">@</span> show <span class="free"><span class="bound"><span class="entity">pq</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' and not ''</span> <span class="main">@</span> show <span class="free"><span class="bound"><span class="entity">r</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>uncurry3 <span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> return <span class="keyword1">oo</span> <span class="main">(</span>check_mult_l_dom_err_impl <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
   uncurry3 <span class="main">(</span>check_mult_l_dom_err<span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> bool_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> uint64_nat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> bool_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> uint64_nat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> raw_string_assn‚Ä∫</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> check_mult_l_dom_err_def check_mult_l_dom_err_impl_def list_assn_pure_conv
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_to_hoare</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>uncurry3 <span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> return <span class="keyword1">oo</span> <span class="main">(</span>check_mult_l_mult_err_impl <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
   uncurry3 <span class="main">(</span>check_mult_l_mult_err<span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> raw_string_assn‚Ä∫</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> check_mult_l_mult_err_def check_mult_l_mult_err_impl_def list_assn_pure_conv
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_to_hoare</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">check_mult_l_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry6 check_mult_l‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπpoly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> polys_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> vars_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> uint64_nat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> uint64_nat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span>  <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> status_assn raw_string_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> check_mult_l_def
    HOL_list.fold_custom_empty
    term_order_rel'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    term_order_rel'_alt_def
    in_dom_m_lookup_iff
    fmlookup'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    vars_llist_alt_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">declare</span></span> check_mult_l_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_ext_l_dom_err_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπuint64 <span class="main">‚áí</span> <span class="main">_</span>‚Ä∫</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">check_ext_l_dom_err_impl</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span>
    <span class="inner_quoted">''There is already a polynomial with index ''</span> <span class="main">@</span> show <span class="main">(</span>nat_of_uint64 <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(</span><span class="main">(</span>return <span class="keyword1">o</span> <span class="main">(</span>check_ext_l_dom_err_impl<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>check_extension_l_dom_err<span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> uint64_nat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> raw_string_assn‚Ä∫</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> check_extension_l_dom_err_def check_ext_l_dom_err_impl_def list_assn_pure_conv
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_to_hoare</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_extension_l_no_new_var_err_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">‚áí</span> <span class="main">_</span>‚Ä∫</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">check_extension_l_no_new_var_err_impl</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span>
    <span class="inner_quoted">''No new variable could be found in polynomial ''</span> <span class="main">@</span> show <span class="free"><span class="bound"><span class="entity">p</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(</span><span class="main">(</span>return <span class="keyword1">o</span> <span class="main">(</span>check_extension_l_no_new_var_err_impl<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span>check_extension_l_no_new_var_err<span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> raw_string_assn‚Ä∫</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> check_extension_l_no_new_var_err_impl_def check_extension_l_no_new_var_err_def
     list_assn_pure_conv
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_to_hoare</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_extension_l_side_cond_err_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">‚áí</span> <span class="main">_</span>‚Ä∫</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">check_extension_l_side_cond_err_impl</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
    <span class="inner_quoted">''Error while checking side conditions of extensions polynow, var is ''</span> <span class="main">@</span> show <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">@</span>
    <span class="inner_quoted">'' polynomial is ''</span> <span class="main">@</span> show <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">@</span> <span class="inner_quoted">''side condition p*p - p = ''</span> <span class="main">@</span> show <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' and should be 0''</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(</span>uncurry3 <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> return <span class="keyword1">oo</span> <span class="main">(</span>check_extension_l_side_cond_err_impl <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    uncurry3 <span class="main">(</span>check_extension_l_side_cond_err<span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> string_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> raw_string_assn‚Ä∫</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> check_extension_l_side_cond_err_impl_def check_extension_l_side_cond_err_def
     list_assn_pure_conv
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_to_hoare</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_extension_l_new_var_multiple_err_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span> <span class="main">‚áí</span> <span class="main">_</span>‚Ä∫</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">check_extension_l_new_var_multiple_err_impl</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span>
    <span class="inner_quoted">''Error while checking side conditions of extensions polynow, var is ''</span> <span class="main">@</span> show <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">@</span>
    <span class="inner_quoted">'' but it either appears at least once in the polynomial or another new variable is created ''</span> <span class="main">@</span>
    show <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' but should not.''</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(</span>uncurry <span class="main">(</span>return <span class="keyword1">oo</span> <span class="main">(</span>check_extension_l_new_var_multiple_err_impl<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    uncurry <span class="main">(</span>check_extension_l_new_var_multiple_err<span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> string_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> raw_string_assn‚Ä∫</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> check_extension_l_new_var_multiple_err_impl_def
     check_extension_l_new_var_multiple_err_def
     list_assn_pure_conv
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_to_hoare</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">sepref_register</span></span> <span class="quoted">check_extension_l_dom_err</span> <span class="quoted">fmlookup'</span>
  <span class="quoted">check_extension_l_side_cond_err</span> <span class="quoted">check_extension_l_no_new_var_err</span>
  <span class="quoted">check_extension_l_new_var_multiple_err</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">uminus_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπllist_polynomial <span class="main">‚áí</span> llist_polynomial‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">uminus_poly</span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">sepref_register</span></span> <span class="quoted">uminus_poly</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sepref_import_param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>map <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uminus_poly<span class="main">)</span> <span class="main">‚àà</span> poly_rel <span class="main">‚Üí</span> poly_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> uminus_poly_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p p'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">p'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_rel_induct<span class="main">)</span>
     <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">sepref_register</span></span> <span class="quoted">vars_of_poly_in</span>
  <span class="quoted">weak_equality_l</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">safe_constraint_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπSepref_Constraints.CONSTRAINT single_valued <span class="main">(</span>the_pure monomial_assn<span class="main">)</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  single_valued_the_monomial_assn<span class="main">:</span>
    <span class="quoted"><span class="quoted">‚Äπsingle_valued <span class="main">(</span>the_pure monomial_assn<span class="main">)</span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπsingle_valued <span class="main">(</span><span class="main">(</span>the_pure monomial_assn<span class="main">)</span><span class="main">¬Ø</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> IS_LEFT_UNIQUE_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> step_rewrite_pure single_valued_monomial_rel single_valued_monomial_rel' Sepref_Constraints.CONSTRAINT_def<span class="main">)</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">check_extension_l_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry5 check_extension_l‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπpoly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> polys_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> vars_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> uint64_nat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> string_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span>
     status_assn raw_string_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> option.splits<span class="main">[</span><span class="operator">split</span><span class="main">]</span> single_valued_the_monomial_assn<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span>
    HOL_list.fold_custom_empty
    term_order_rel'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    term_order_rel'_alt_def
    in_dom_m_lookup_iff
    fmlookup'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    vars_llist_alt_def
    check_extension_l_def
    not_not
    option.case_eq_if
    uminus_poly_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    HOL_list.fold_custom_empty
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>


<span class="keyword1"><span class="command">declare</span></span> check_extension_l_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">check_del_l_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry2 check_del_l‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπpoly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> polys_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> uint64_nat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> status_assn raw_string_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> check_del_l_def
    in_dom_m_lookup_iff
    fmlookup'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span> <span class="main">=</span> check_del_l_impl.refine

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">pac_step_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">pac_step_rel</span> <span class="main">‚â°</span> p2rel <span class="main">(</span><span class="main">‚ü®</span>Id<span class="main">,</span> <span class="main">‚ü®</span>monomial_rel<span class="main">‚ü©</span>list_rel<span class="main">,</span> Id<span class="main">‚ü©</span> pac_step_rel_raw<span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">sepref_register</span></span> <span class="quoted">PAC_Polynomials_Operations.normalize_poly</span>
  <span class="quoted">pac_src1</span> <span class="quoted">pac_src2</span> <span class="quoted">new_id</span> <span class="quoted">pac_mult</span> <span class="quoted">case_pac_step</span> <span class="quoted">check_mult_l</span>
  <span class="quoted">check_addition_l</span> <span class="quoted">check_del_l</span> <span class="quoted">check_extension_l</span>

<span class="keyword1"><span class="command">lemma</span></span> pac_step_rel_assn_alt_def2<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπhn_ctxt <span class="main">(</span>pac_step_rel_assn nat_assn poly_assn id_assn<span class="main">)</span> <span class="free">b</span> <span class="free">bi</span> <span class="main">=</span>
       hn_val
        <span class="main">(</span>p2rel
          <span class="main">(</span><span class="main">‚ü®</span>nat_rel<span class="main">,</span> poly_rel<span class="main">,</span> Id <span class="main">::</span> <span class="main">(</span>string <span class="main">√ó</span> <span class="main">_</span><span class="main">)</span> set<span class="main">‚ü©</span>pac_step_rel_raw<span class="main">)</span><span class="main">)</span> <span class="free">b</span> <span class="free">bi</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> poly_assn_list hn_ctxt_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted">nat_assn</span> <span class="quoted">poly_assn</span> <span class="quoted"><span class="quoted">‚Äπid_assn <span class="main">::</span> string <span class="main">‚áí</span> <span class="main">_</span>‚Ä∫</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">bi</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pac_step_rel_assn.induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p2rel_def hn_val_unfold pac_step_rel_raw.simps relAPP_def
    pure_app_eq<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> is_AddD_import<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‚ÄπCONSTRAINT is_pure <span class="free">K</span>‚Ä∫</span></span>  <span class="quoted"><span class="quoted">‚ÄπCONSTRAINT is_pure <span class="free">V</span>‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>return <span class="keyword1">o</span> pac_res<span class="main">,</span> RETURN <span class="keyword1">o</span> pac_res<span class="main">)</span> <span class="main">‚àà</span> <span class="main">[</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> is_Add <span class="bound">x</span> <span class="main">‚à®</span> is_Mult <span class="bound">x</span> <span class="main">‚à®</span> is_Extension <span class="bound">x</span><span class="keyword1">]<span class="hidden">‚á©</span><sub>a</sub></span>
       <span class="main">(</span>pac_step_rel_assn <span class="free">K</span> <span class="free">V</span> <span class="free">R</span><span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="main">‚Üí</span> <span class="free">V</span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>return <span class="keyword1">o</span> pac_src1<span class="main">,</span> RETURN <span class="keyword1">o</span> pac_src1<span class="main">)</span> <span class="main">‚àà</span> <span class="main">[</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> is_Add <span class="bound">x</span> <span class="main">‚à®</span> is_Mult <span class="bound">x</span> <span class="main">‚à®</span> is_Del <span class="bound">x</span><span class="keyword1">]<span class="hidden">‚á©</span><sub>a</sub></span> <span class="main">(</span>pac_step_rel_assn <span class="free">K</span> <span class="free">V</span> <span class="free">R</span><span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="main">‚Üí</span> <span class="free">K</span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>return <span class="keyword1">o</span> new_id<span class="main">,</span> RETURN <span class="keyword1">o</span> new_id<span class="main">)</span> <span class="main">‚àà</span> <span class="main">[</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> is_Add <span class="bound">x</span> <span class="main">‚à®</span> is_Mult <span class="bound">x</span> <span class="main">‚à®</span> is_Extension <span class="bound">x</span><span class="keyword1">]<span class="hidden">‚á©</span><sub>a</sub></span> <span class="main">(</span>pac_step_rel_assn <span class="free">K</span> <span class="free">V</span> <span class="free">R</span><span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="main">‚Üí</span> <span class="free">K</span>‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>return <span class="keyword1">o</span> is_Add<span class="main">,</span> RETURN <span class="keyword1">o</span> is_Add<span class="main">)</span> <span class="main">‚àà</span>  <span class="main">(</span>pac_step_rel_assn <span class="free">K</span> <span class="free">V</span> <span class="free">R</span><span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> bool_assn‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>return <span class="keyword1">o</span> is_Mult<span class="main">,</span> RETURN <span class="keyword1">o</span> is_Mult<span class="main">)</span> <span class="main">‚àà</span> <span class="main">(</span>pac_step_rel_assn <span class="free">K</span> <span class="free">V</span> <span class="free">R</span><span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> bool_assn‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>return <span class="keyword1">o</span> is_Del<span class="main">,</span> RETURN <span class="keyword1">o</span> is_Del<span class="main">)</span> <span class="main">‚àà</span> <span class="main">(</span>pac_step_rel_assn <span class="free">K</span> <span class="free">V</span> <span class="free">R</span><span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> bool_assn‚Ä∫</span></span>
    <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>return <span class="keyword1">o</span> is_Extension<span class="main">,</span> RETURN <span class="keyword1">o</span> is_Extension<span class="main">)</span> <span class="main">‚àà</span> <span class="main">(</span>pac_step_rel_assn <span class="free">K</span> <span class="free">V</span> <span class="free">R</span><span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> bool_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sepref_to_hoare</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pac_step_rel_assn_alt_def is_pure_conv ent_true_drop pure_app_eq
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pac_step.splits<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπCONSTRAINT is_pure <span class="free">K</span> <span class="main">‚üπ</span>
  <span class="main">(</span>return <span class="keyword1">o</span> pac_src2<span class="main">,</span> RETURN <span class="keyword1">o</span> pac_src2<span class="main">)</span> <span class="main">‚àà</span> <span class="main">[</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> is_Add <span class="bound">x</span><span class="keyword1">]<span class="hidden">‚á©</span><sub>a</sub></span> <span class="main">(</span>pac_step_rel_assn <span class="free">K</span> <span class="free">V</span> <span class="free">R</span><span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="main">‚Üí</span> <span class="free">K</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚ÄπCONSTRAINT is_pure <span class="free">V</span> <span class="main">‚üπ</span>
  <span class="main">(</span>return <span class="keyword1">o</span> pac_mult<span class="main">,</span> RETURN <span class="keyword1">o</span> pac_mult<span class="main">)</span> <span class="main">‚àà</span> <span class="main">[</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> is_Mult <span class="bound">x</span><span class="keyword1">]<span class="hidden">‚á©</span><sub>a</sub></span> <span class="main">(</span>pac_step_rel_assn <span class="free">K</span> <span class="free">V</span> <span class="free">R</span><span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="main">‚Üí</span> <span class="free">V</span>‚Ä∫</span></span>
  <span class="quoted"><span class="quoted">‚ÄπCONSTRAINT is_pure <span class="free">R</span> <span class="main">‚üπ</span>
  <span class="main">(</span>return <span class="keyword1">o</span> new_var<span class="main">,</span> RETURN <span class="keyword1">o</span> new_var<span class="main">)</span> <span class="main">‚àà</span> <span class="main">[</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> is_Extension <span class="bound">x</span><span class="keyword1">]<span class="hidden">‚á©</span><sub>a</sub></span> <span class="main">(</span>pac_step_rel_assn <span class="free">K</span> <span class="free">V</span> <span class="free">R</span><span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="main">‚Üí</span> <span class="free">R</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sepref_to_hoare</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pac_step_rel_assn_alt_def is_pure_conv ent_true_drop pure_app_eq
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pac_step.splits<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_Mult_lastI<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">¬¨</span> is_Add <span class="free">b</span> <span class="main">‚üπ</span> <span class="main">¬¨</span>is_Mult <span class="free">b</span> <span class="main">‚üπ</span> <span class="main">¬¨</span>is_Extension <span class="free">b</span> <span class="main">‚üπ</span> is_Del <span class="free">b</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">sepref_register</span></span> <span class="quoted">is_cfailed</span> <span class="quoted">is_Del</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PAC_checker_l_step'</span> <span class="main">::</span>  <span class="quoted"><span class="main">_</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">PAC_checker_l_step'</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> PAC_checker_l_step <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PAC_checker_l_step_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπPAC_checker_l_step <span class="free">a</span> <span class="free">bcd</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span> <span class="main">=</span> <span class="free">bcd</span> <span class="keyword1">in</span> PAC_checker_l_step' <span class="free">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span> <span class="free">e</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> PAC_checker_l_step'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">sepref_decl_intf</span></span> <span class="main">(</span><span class="tfree">'k</span><span class="main">)</span> acode_status <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">)</span> code_status"</span></span>
<span class="keyword1"><span class="command">sepref_decl_intf</span></span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'lbl</span><span class="main">)</span> apac_step <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'lbl</span><span class="main">)</span> pac_step"</span></span>

<span class="keyword1"><span class="command">sepref_register</span></span> <span class="quoted">merge_cstatus</span> <span class="quoted">full_normalize_poly</span> <span class="quoted">new_var</span> <span class="quoted">is_Add</span>

<span class="keyword1"><span class="command">lemma</span></span> poly_rel_the_pure<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπpoly_rel <span class="main">=</span> the_pure poly_assn‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  nat_rel_the_pure<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπnat_rel <span class="main">=</span> the_pure nat_assn‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
 WTF_RF<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπpure <span class="main">(</span>the_pure nat_assn<span class="main">)</span> <span class="main">=</span> nat_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> poly_assn_list
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">safe_constraint_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">‚ÄπCONSTRAINT IS_LEFT_UNIQUE uint64_nat_rel‚Ä∫</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  single_valued_uint64_nat_rel<span class="main">[</span><span class="operator">safe_constraint_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">‚ÄπCONSTRAINT single_valued uint64_nat_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IS_LEFT_UNIQUE_def single_valued_def uint64_nat_rel_def br_def<span class="main">)</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">check_step_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry4 PAC_checker_l_step'‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπpoly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> <span class="main">(</span>status_assn raw_string_assn<span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>d</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> vars_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>d</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> polys_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>d</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> <span class="main">(</span>pac_step_rel_assn <span class="main">(</span>uint64_nat_assn<span class="main">)</span> poly_assn <span class="main">(</span>string_assn <span class="main">::</span> string <span class="main">‚áí</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>d</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span>
    status_assn raw_string_assn <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>a</sub></span> vars_assn <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>a</sub></span> polys_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span> is_Mult_lastI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span> single_valued_uint64_nat_rel<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> PAC_checker_l_step_def PAC_checker_l_step'_def
    pac_step.case_eq_if Let_def
     is_success_alt_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    uminus_poly_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    HOL_list.fold_custom_empty
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>


<span class="keyword1"><span class="command">declare</span></span> check_step_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>

<span class="keyword1"><span class="command">sepref_register</span></span> <span class="quoted">PAC_checker_l_step</span> <span class="quoted">PAC_checker_l_step'</span> <span class="quoted">fully_normalize_poly_impl</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PAC_checker_l'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">PAC_checker_l'</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">ùí±</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">status</span></span></span> <span class="free"><span class="bound"><span class="entity">steps</span></span></span> <span class="main">=</span> PAC_checker_l <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ùí±</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">status</span></span></span> <span class="free"><span class="bound"><span class="entity">steps</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PAC_checker_l_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚ÄπPAC_checker_l <span class="free">p</span> <span class="free">ùí±A</span> <span class="free">status</span> <span class="free">steps</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">ùí±</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">ùí±A</span> <span class="keyword1">in</span> PAC_checker_l' <span class="free">p</span> <span class="bound">ùí±</span> <span class="bound">A</span> <span class="free">status</span> <span class="free">steps</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> PAC_checker_l'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">PAC_checker_l_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry4 PAC_checker_l'‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπpoly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> vars_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>d</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> polys_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>d</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> <span class="main">(</span>status_assn raw_string_assn<span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>d</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span>
       <span class="main">(</span>list_assn <span class="main">(</span>pac_step_rel_assn <span class="main">(</span>uint64_nat_assn<span class="main">)</span> poly_assn string_assn<span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span>
     status_assn raw_string_assn <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>a</sub></span> vars_assn <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>a</sub></span> polys_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span> is_Mult_lastI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> PAC_checker_l_def is_success_alt_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> PAC_checker_l_step_alt_def
    nres_bind_let_law<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> PAC_checker_l'_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nres_bind_let_law<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">declare</span></span> PAC_checker_l_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">polys_assn_input</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">polys_assn_input</span> <span class="main">‚â°</span> iam_fmap_assn nat_assn poly_assn‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">remap_polys_l_dom_err_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span>‚Ä∫</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">remap_polys_l_dom_err_impl</span> <span class="main">=</span>
    <span class="inner_quoted">''Error during initialisation. Too many polynomials where provided. If this happens,''</span> <span class="main">@</span>
    <span class="inner_quoted">''please report the example to the authors, because something went wrong during ''</span> <span class="main">@</span>
    <span class="inner_quoted">''code generation (code generation to arrays is likely to be broken).''</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">(</span>uncurry0 <span class="main">(</span>return <span class="main">(</span>remap_polys_l_dom_err_impl<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    uncurry0 <span class="main">(</span>remap_polys_l_dom_err<span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> unit_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> raw_string_assn‚Ä∫</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> remap_polys_l_dom_err_def
     remap_polys_l_dom_err_def
     list_assn_pure_conv
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref_to_hoare</span> <span class="operator">sep_auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπMLton is not able to optimise the calls to pow.‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> pow_2_64<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">^</span> <span class="numeral">64</span> <span class="main">=</span> <span class="numeral">18446744073709551616</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">sepref_register</span></span> <span class="quoted">upper_bound_on_dom</span> <span class="quoted">op_fmap_empty</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">remap_polys_l_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry2 remap_polys_l2‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπpoly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> vars_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>d</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> polys_assn_input<span class="keyword1"><span class="hidden">‚áß</span><sup>d</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span>
    status_assn raw_string_assn <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>a</sub></span> vars_assn <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>a</sub></span> polys_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span> is_Mult_lastI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span> indom_mI<span class="main">[</span><span class="operator">dest</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> remap_polys_l2_def op_fmap_empty_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> while_eq_nfoldli<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    while_upt_while_direct pow_2_64
    in_dom_m_lookup_iff
    fmlookup'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    union_vars_poly_alt_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">‚Äπfmupd <span class="main"><span class="main">‚åë</span></span>‚Ä∫</span></span></span> uint64_of_nat_conv_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> while_upt_while_direct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">‚Äπop_fmap_empty‚Ä∫</span></span></span> annotate_assn<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">‚Äπpolys_assn‚Ä∫</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">lemma</span></span> remap_polys_l2_remap_polys_l<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>uncurry2 remap_polys_l2<span class="main">,</span> uncurry2 remap_polys_l<span class="main">)</span> <span class="main">‚àà</span> <span class="main">(</span>Id <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> <span class="main">‚ü®</span>Id<span class="main">‚ü©</span>set_rel<span class="main">)</span> <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> Id <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>f</sub></span> <span class="main">‚ü®</span>Id<span class="main">‚ü©</span>nres_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> frefI fun_relI nres_relI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> remap_polys_l2_remap_polys_l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span>
   <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>uncurry2 remap_polys_l_impl<span class="main">,</span>
     uncurry2 remap_polys_l<span class="main">)</span> <span class="main">‚àà</span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> vars_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>d</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> polys_assn_input<span class="keyword1"><span class="hidden">‚áß</span><sup>d</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span>
       status_assn raw_string_assn <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>a</sub></span> vars_assn <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>a</sub></span> polys_assn‚Ä∫</span></span>
   <span class="keyword1"><span class="command">using</span></span> hfcomp_tcomp_pre<span class="main">[</span><span class="operator">OF</span> remap_polys_l2_remap_polys_l remap_polys_l_impl.refine<span class="main">]</span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hrp_comp_def hfprod_def<span class="main">)</span>

<span class="keyword1"><span class="command">sepref_register</span></span> <span class="quoted">remap_polys_l</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">full_checker_l_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry2 full_checker_l‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπpoly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> polys_assn_input<span class="keyword1"><span class="hidden">‚áß</span><sup>d</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> <span class="main">(</span>list_assn <span class="main">(</span>pac_step_rel_assn <span class="main">(</span>uint64_nat_assn<span class="main">)</span> poly_assn string_assn<span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span>
    status_assn raw_string_assn <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>a</sub></span> vars_assn <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>a</sub></span> polys_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span><span class="main"><span class="main">=</span></span>1<span class="main">]</span><span class="main">]</span> is_Mult_lastI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> full_checker_l_def hs.fold_custom_empty
    union_vars_poly_alt_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    PAC_checker_l_alt_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">PAC_update_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry2 <span class="main">(</span>RETURN <span class="keyword1">ooo</span> fmupd<span class="main">)</span>‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπnat_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> poly_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> <span class="main">(</span>polys_assn_input<span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>d</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> polys_assn_input‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> comp_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">PAC_empty_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry0 <span class="main">(</span>RETURN fmempty<span class="main">)</span>‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπunit_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> polys_assn_input‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> op_iam_fmap_empty_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> pat_fmap_empty
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">empty_vars_impl</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‚Äπuncurry0 <span class="main">(</span>RETURN <span class="main">{}</span><span class="main">)</span>‚Ä∫</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπunit_assn<span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> vars_assn‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> hs.fold_custom_empty
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThis is a hack for performance. There is no need to recheck that that a char is valid when
  working on chars coming from strings... It is not that important in most cases, but in our case
  the preformance difference is really large.‚Ä∫</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">unsafe_asciis_of_literal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">unsafe_asciis_of_literal</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> String.asciis_of_literal <span class="free"><span class="bound"><span class="entity">xs</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">unsafe_asciis_of_literal'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">,</span> <span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">unsafe_asciis_of_literal'</span> <span class="main">=</span> unsafe_asciis_of_literal‚Ä∫</span></span>

<span class="keyword1"><span class="command">code_printing</span></span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">unsafe_asciis_of_literal'</span> <span class="main">‚áÄ</span>
    <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"!(List.map (fn c =&gt; let val k = Char.ord c in IntInf.fromInt k end) /o String.explode)"</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ
  Now comes the big and ugly and unsafe hack.

  Basically, we try to avoid the conversion to IntInf when calculating the hash. The performance
  gain is roughly 40\%, which is a LOT and definitively something we need to do. We are aware that the
  SML semantic encourages compilers to optimise conversions, but this does not happen here,
  corroborating our early observation on the verified SAT solver IsaSAT.x
‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">raw_explode</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">raw_explode</span> <span class="main">=</span> String.explode‚Ä∫</span></span>
<span class="keyword1"><span class="command">code_printing</span></span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">raw_explode</span> <span class="main">‚áÄ</span>
    <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"String.explode"</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">hashcode_literal'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â°</span>
    foldl <span class="main">(</span><span class="main">Œª</span><span class="bound">h</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">h</span> <span class="main">*</span> <span class="numeral">33</span> <span class="main">+</span> uint32_of_int <span class="main">(</span>of_char <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="numeral">5381</span>
     <span class="main">(</span>raw_explode <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  hashcode_literal_def<span class="main">[</span><span class="operator">unfolded</span> String.explode_code
    unsafe_asciis_of_literal_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">uint32_of_char</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">uint32_of_char</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> uint32_of_int <span class="main">(</span>int_of_char <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>‚Ä∫</span></span>


<span class="keyword1"><span class="command">code_printing</span></span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">uint32_of_char</span> <span class="main">‚áÄ</span>
    <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"!(Word32.fromInt /o (Char.ord))"</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπhashcode <span class="free">s</span> <span class="main">=</span> hashcode_literal' <span class="free">s</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> hashcode_literal_def hashcode_list_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unsafe_asciis_of_literal_def hashcode_list_def
     String.asciis_of_literal_def hashcode_literal_def hashcode_literal'_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπWe compile Past√®que in <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">üóè</span></span>‚ÄπPAC_Checker_MLton.thy‚Ä∫</span></span>.‚Ä∫</span></span>
<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">PAC_checker_l_impl</span></span> <span class="quoted"><span class="quoted">PAC_update_impl</span></span> <span class="quoted"><span class="quoted">PAC_empty_impl</span></span> <span class="quoted"><span class="quoted">the_error</span></span> <span class="quoted"><span class="quoted">is_cfailed</span></span> <span class="quoted"><span class="quoted">is_cfound</span></span>
  <span class="quoted"><span class="quoted">int_of_integer</span></span> <span class="quoted"><span class="quoted">Del</span></span> <span class="quoted"><span class="quoted">Add</span></span> <span class="quoted"><span class="quoted">Mult</span></span> <span class="quoted"><span class="quoted">nat_of_integer</span></span> <span class="quoted"><span class="quoted">String.implode</span></span> <span class="quoted"><span class="quoted">remap_polys_l_impl</span></span>
  <span class="quoted"><span class="quoted">fully_normalize_poly_impl</span></span> <span class="quoted"><span class="quoted">union_vars_poly_impl</span></span> <span class="quoted"><span class="quoted">empty_vars_impl</span></span>
  <span class="quoted"><span class="quoted">full_checker_l_impl</span></span> <span class="quoted"><span class="quoted">check_step_impl</span></span> <span class="quoted"><span class="quoted">CSUCCESS</span></span>
  <span class="quoted"><span class="quoted">Extension</span></span> <span class="quoted"><span class="quoted">hashcode_literal'</span></span> <span class="quoted"><span class="quoted">version</span></span>
  <span class="keyword2"><span class="keyword">in</span></span> SML_imp <span class="keyword2"><span class="keyword">module_name</span></span> PAC_Checker


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚ÄπCorrectness theorem‚Ä∫</span></span>

<span class="keyword1"><span class="command">context</span></span> poly_embed
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">full_poly_assn</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">full_poly_assn</span> <span class="main">=</span> hr_comp poly_assn <span class="main">(</span>fully_unsorted_poly_rel <span class="keyword1">O</span> mset_poly_rel<span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">full_poly_input_assn</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">full_poly_input_assn</span> <span class="main">=</span> hr_comp
        <span class="main">(</span>hr_comp polys_assn_input
          <span class="main">(</span><span class="main">‚ü®</span>nat_rel<span class="main">,</span> fully_unsorted_poly_rel <span class="keyword1">O</span> mset_poly_rel<span class="main">‚ü©</span>fmap_rel<span class="main">)</span><span class="main">)</span>
        polys_rel‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fully_pac_assn</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">fully_pac_assn</span> <span class="main">=</span> <span class="main">(</span>list_assn
        <span class="main">(</span>hr_comp <span class="main">(</span>pac_step_rel_assn uint64_nat_assn poly_assn string_assn<span class="main">)</span>
          <span class="main">(</span>p2rel
            <span class="main">(</span><span class="main">‚ü®</span>nat_rel<span class="main">,</span>
             fully_unsorted_poly_rel <span class="keyword1">O</span>
             mset_poly_rel<span class="main">,</span> var_rel<span class="main">‚ü©</span>pac_step_rel_raw<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">code_status_assn</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">code_status_assn</span> <span class="main">=</span> hr_comp <span class="main">(</span>status_assn raw_string_assn<span class="main">)</span>
                            code_status_status_rel‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">full_vars_assn</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">full_vars_assn</span> <span class="main">=</span> hr_comp <span class="main">(</span>hs.assn string_assn<span class="main">)</span>
                              <span class="main">(</span><span class="main">‚ü®</span>var_rel<span class="main">‚ü©</span>set_rel<span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> polys_rel_full_polys_rel<span class="main">:</span>
  <span class="quoted"><span class="quoted">‚Äπpolys_rel_full <span class="main">=</span> Id <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> polys_rel‚Ä∫</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> polys_rel_full_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">full_polys_assn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">_</span>‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">‚Äπ<span class="free">full_polys_assn</span> <span class="main">=</span> hr_comp <span class="main">(</span>hr_comp polys_assn
                              <span class="main">(</span><span class="main">‚ü®</span>nat_rel<span class="main">,</span>
                               sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel<span class="main">‚ü©</span>fmap_rel<span class="main">)</span><span class="main">)</span>
                            polys_rel‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ

Below is the full correctness theorems. It basically states that:

  <span class="antiquoted"><span class="antiquoted">‚ñ∏</span></span> assuming that the input polynomials have no duplicate variables


Then:

<span class="antiquoted"><span class="antiquoted">‚ñ∏</span></span> if the checker returns <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚ÄπCFOUND‚Ä∫</span></span></span></span>, the spec is in the ideal
  and the PAC file is correct

<span class="antiquoted"><span class="antiquoted">‚ñ∏</span></span> if the checker returns <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚ÄπCSUCCESS‚Ä∫</span></span></span></span>, the PAC file is correct (but
there is no information on the spec, aka checking failed)

<span class="antiquoted"><span class="antiquoted">‚ñ∏</span></span> if the checker return <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚ÄπCFAILED <span class="free"><span class="free">err</span></span>‚Ä∫</span></span></span></span>, then checking failed (and
<span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">err</span></span>‚Ä∫</span></span></span></span> <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">‚àó</span></span>‚Äπmight‚Ä∫</span></span> give you an indication of the error, but the correctness
theorem does not say anything about that).


The input parameters are:

<span class="antiquoted"><span class="antiquoted">‚ñ∏</span></span> the specification polynomial represented as a list

<span class="antiquoted"><span class="antiquoted">‚ñ∏</span></span> the input polynomials as hash map (as an array of option polynomial)

<span class="antiquoted"><span class="antiquoted">‚ñ∏</span></span> a represention of the PAC proofs.

‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PAC_full_correctness<span class="main">:</span> <span class="comment1">(* \htmllink{PAC-full-correctness} *)</span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>uncurry2 full_checker_l_impl<span class="main">,</span>
     uncurry2 <span class="main">(</span><span class="main">Œª</span><span class="bound">spec</span> <span class="bound">A</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> PAC_checker_specification <span class="bound">spec</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span>
    <span class="main">‚àà</span> <span class="main">(</span>full_poly_assn<span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> <span class="main">(</span>full_poly_input_assn<span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>d</sup></span> <span class="keyword1">*<span class="hidden">‚á©</span><sub>a</sub></span> <span class="main">(</span>fully_pac_assn<span class="main">)</span><span class="keyword1"><span class="hidden">‚áß</span><sup>k</sup></span> <span class="keyword1">‚Üí<span class="hidden">‚á©</span><sub>a</sub></span> hr_comp
      <span class="main">(</span>code_status_assn <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>a</sub></span> full_vars_assn <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>a</sub></span> hr_comp polys_assn
                              <span class="main">(</span><span class="main">‚ü®</span>nat_rel<span class="main">,</span> sorted_poly_rel <span class="keyword1">O</span> mset_poly_rel<span class="main">‚ü©</span>fmap_rel<span class="main">)</span><span class="main">)</span>
                            <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">st</span><span class="main">,</span> <span class="bound">G</span><span class="main">)</span><span class="main">,</span> <span class="bound">st'</span><span class="main">,</span> <span class="bound">G'</span><span class="main">)</span><span class="main">.</span>
                             <span class="bound">st</span> <span class="main">=</span> <span class="bound">st'</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">st</span> <span class="main">‚â†</span> FAILED <span class="main">‚ü∂</span> <span class="main">(</span><span class="bound">G</span><span class="main">,</span> <span class="bound">G'</span><span class="main">)</span> <span class="main">‚àà</span> Id <span class="keyword1">√ó<span class="hidden">‚á©</span><sub>r</sub></span> polys_rel<span class="main">)</span><span class="main">}</span>‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span>
    full_checker_l_impl.refine<span class="main">[</span><span class="operator">FCOMP</span> full_checker_l_full_checker'<span class="main">,</span>
      <span class="operator">FCOMP</span> full_checker_spec'<span class="main">,</span>
      <span class="operator">unfolded</span> full_poly_assn_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        full_poly_input_assn_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        fully_pac_assn_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        code_status_assn_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        full_vars_assn_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        polys_rel_full_polys_rel
        hr_comp_prod_conv
        full_polys_assn_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      hr_comp_Id2
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ

It would be more efficient to move the parsing to Isabelle, as this
would be more memory efficient (and also reduce the TCB). But now
comes the fun part: It cannot work. A stream (of a file) is consumed
by side effects. Assume that this would work. The code could look like:

<span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ
  <span class="keyword1"><span class="keyword1">let</span></span> <span class="bound"><span class="bound">next_token</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">read_file</span></span> <span class="free"><span class="free">file</span></span>
  <span class="keyword1"><span class="keyword1">in</span></span> <span class="free"><span class="free">f</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">next_token</span></span><span class="main"><span class="main">)</span></span>
‚Ä∫</span></span></span></span>

This code is equal to (in the HOL sense of equality):
<span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ
  <span class="keyword1"><span class="keyword1">let</span></span> <span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">read_file</span></span> <span class="free"><span class="free">file</span></span><span class="main"><span class="main">;</span></span>
      <span class="bound"><span class="bound">next_token</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">read_file</span></span> <span class="free"><span class="free">file</span></span>
  <span class="keyword1"><span class="keyword1">in</span></span> <span class="free"><span class="free">f</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">next_token</span></span><span class="main"><span class="main">)</span></span>
‚Ä∫</span></span></span></span>

However, as an hypothetical <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">read_file</span></span>‚Ä∫</span></span></span></span> changes the underlying stream, we would get the next
token. Remark that this is already a weird point of ML compilers. Anyway, I see currently two
solutions to this problem:

<span class="antiquoted"><span class="antiquoted">‚ñ∏</span></span> The meta-argument: use it only in the Refinement Framework in a setup where copies are
disallowed. Basically, this works because we can express the non-duplication constraints on the type
level. However, we cannot forbid people from expressing things directly at the HOL level.

<span class="antiquoted"><span class="antiquoted">‚ñ∏</span></span> On the target language side, model the stream as the stream and the position. Reading takes two
arguments. First, the position to read. Second, the stream (and the current position) to read. If
the position to read does not match the current position, return an error. This would fit the
correctness theorem of the code generation (roughly ``if it terminates without exception, the answer
is the same''), but it is still unsatisfactory.
‚Ä∫</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">œÜ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπstring <span class="main">‚áí</span> nat‚Ä∫</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">‚Äπ<span class="free">œÜ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">œÜ</span><span class="main">.</span> bij <span class="bound">œÜ</span><span class="main">)</span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bij_œÜ<span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπbij œÜ‚Ä∫</span></span>
  <span class="keyword1"><span class="command">using</span></span> someI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">Œª</span><span class="bound">œÜ</span> <span class="main">::</span> string <span class="main">‚áí</span> nat<span class="main">.</span> bij <span class="bound">œÜ</span>‚Ä∫</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> œÜ_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> poly_embed_EX
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">global_interpretation</span></span> PAC<span class="main">:</span> poly_embed <span class="keyword2"><span class="keyword">where</span></span>
  œÜ <span class="main">=</span> <span class="quoted">œÜ</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">use</span> bij_œÜ <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‚Äπ<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> bij_def‚Ä∫</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThe full correctness theorem is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> PAC.PAC_full_correctness<span class="antiquote"><span class="antiquote">}</span></span></span></span>.‚Ä∫</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="PAC_Checker_MLton">
<div class="head">
<h1>Theory PAC_Checker_MLton</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:         PAC_Checker_MLton.thy
  Author:       Mathias Fleury, Daniela Kaufmann, JKU
  Maintainer:   Mathias Fleury, JKU
*)</span>
<span class="keyword1"><span class="command">theory</span></span> PAC_Checker_MLton
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="PAC_Checker_Synthesis.html">PAC_Checker_Synthesis</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">PAC_checker_l_impl</span></span> <span class="quoted"><span class="quoted">PAC_update_impl</span></span> <span class="quoted"><span class="quoted">PAC_empty_impl</span></span> <span class="quoted"><span class="quoted">the_error</span></span> <span class="quoted"><span class="quoted">is_cfailed</span></span> <span class="quoted"><span class="quoted">is_cfound</span></span>
  <span class="quoted"><span class="quoted">int_of_integer</span></span> <span class="quoted"><span class="quoted">Del</span></span> <span class="quoted"><span class="quoted">Add</span></span> <span class="quoted"><span class="quoted">Mult</span></span> <span class="quoted"><span class="quoted">nat_of_integer</span></span> <span class="quoted"><span class="quoted">String.implode</span></span> <span class="quoted"><span class="quoted">remap_polys_l_impl</span></span>
  <span class="quoted"><span class="quoted">fully_normalize_poly_impl</span></span> <span class="quoted"><span class="quoted">union_vars_poly_impl</span></span> <span class="quoted"><span class="quoted">empty_vars_impl</span></span>
  <span class="quoted"><span class="quoted">full_checker_l_impl</span></span> <span class="quoted"><span class="quoted">check_step_impl</span></span> <span class="quoted"><span class="quoted">CSUCCESS</span></span>
  <span class="quoted"><span class="quoted">Extension</span></span> <span class="quoted"><span class="quoted">hashcode_literal'</span></span> <span class="quoted"><span class="quoted">version</span></span>
  <span class="keyword2"><span class="keyword">in</span></span> SML_imp <span class="keyword2"><span class="keyword">module_name</span></span> PAC_Checker
  <span class="keyword2"><span class="keyword">file_prefix</span></span> <span class="quoted">"checker"</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπHere is how to compile it:‚Ä∫</span></span>
<span class="keyword1"><span class="command">compile_generated_files</span></span> _
  <span class="keyword2"><span class="keyword">external_files</span></span>
    <span class="quoted">‚Äπcode/parser.sml‚Ä∫</span>
    <span class="quoted">‚Äπcode/pasteque.sml‚Ä∫</span>
    <span class="quoted">‚Äπcode/pasteque.mlb‚Ä∫</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted">‚Äπ<span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">dir</span> <span class="main">=&gt;</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">exec</span> <span class="main">=</span> <span class="entity">Generated_Files.execute</span> <span class="main">(</span><span class="entity">dir</span> + Path.basic <span class="inner_quoted">"code"</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
        <span class="entity">exec</span> <span class="antiquoted"><span class="entity"><span class="operator">‚Äπ</span>Compilation‚Ä∫</span></span>
          <span class="main">(</span>File.bash_path <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">path</span><span class="hidden">&gt;</span></span>‚Äπ$ISABELLE_MLTON‚Ä∫</span></span> ^ <span class="inner_quoted">" "</span> ^
            <span class="inner_quoted">"-const 'MLton.safe false' -verbose 1 -default-type int64 -output pasteque "</span> ^
            <span class="inner_quoted">"-codegen native -inline 700 -cc-opt -O3 pasteque.mlb"</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>‚Ä∫</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>