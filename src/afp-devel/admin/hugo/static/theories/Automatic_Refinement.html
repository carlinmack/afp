<div id="Refine_Util_Bootstrap1">
<div class="head">
<h1>Theory Refine_Util_Bootstrap1</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Refine_Util_Bootstrap1
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">1</span> ##

  <span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">BASIC_REFINE_UTIL</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> map_option<span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> 'b<span class="main">)</span> <span class="main">-&gt;</span> 'a option <span class="main">-&gt;</span> 'b option

    <span class="keyword1"><span class="keyword">val</span></span> map_fold<span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> 'b <span class="main">-&gt;</span> 'c * 'b<span class="main">)</span> <span class="main">-&gt;</span> 'a list <span class="main">-&gt;</span> 'b <span class="main">-&gt;</span> 'c list * 'b

    <span class="keyword1"><span class="keyword">val</span></span> split<span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> bool<span class="main">)</span> <span class="main">-&gt;</span> 'a list <span class="main">-&gt;</span> 'a list * 'a list
    <span class="keyword1"><span class="keyword">val</span></span> split_matching<span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> 'b <span class="main">-&gt;</span> bool<span class="main">)</span> <span class="main">-&gt;</span> 'a list <span class="main">-&gt;</span> 'b list <span class="main">-&gt;</span> <span class="main">(</span>'b list * 'b list<span class="main">)</span> option

    <span class="keyword1"><span class="keyword">val</span></span> yield_singleton2<span class="main">:</span> <span class="main">(</span>'a list <span class="main">-&gt;</span> 'b <span class="main">-&gt;</span> <span class="main">(</span>'c * 'd list<span class="main">)</span> * 'e<span class="main">)</span> <span class="main">-&gt;</span> 'a <span class="main">-&gt;</span> 'b <span class="main">-&gt;</span>
      <span class="main">(</span>'c * 'd<span class="main">)</span> * 'e

    <span class="keyword1"><span class="keyword">val</span></span> ## <span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> 'c<span class="main">)</span> * <span class="main">(</span>'b <span class="main">-&gt;</span> 'd<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'a * 'b<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'c * 'd<span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> seq_is_empty<span class="main">:</span> 'a Seq.seq <span class="main">-&gt;</span> bool * 'a Seq.seq

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Basic_Refine_Util</span> <span class="main">:</span> <span class="entity">BASIC_REFINE_UTIL</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">map_option</span> <span class="main">_</span> NONE <span class="main">=</span> NONE
      <span class="main">|</span> <span class="entity">map_option</span> <span class="entity">f</span> <span class="main">(</span>SOME <span class="entity">x</span><span class="main">)</span> <span class="main">=</span> SOME <span class="main">(</span><span class="entity">f</span> <span class="entity">x</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">map_fold</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="entity">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">map_fold</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">xs</span><span class="main">)</span> <span class="entity">s</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">let</span></span> 
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">x'</span><span class="main">,</span><span class="entity">s'</span><span class="main">)</span> <span class="main">=</span> <span class="entity">f</span> <span class="entity">x</span> <span class="entity">s</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">xs'</span><span class="main">,</span><span class="entity">s'</span><span class="main">)</span> <span class="main">=</span> <span class="entity">map_fold</span> <span class="entity">f</span> <span class="entity">xs</span> <span class="entity">s'</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="main">(</span><span class="entity">x'</span>::<span class="entity">xs'</span><span class="main">,</span><span class="entity">s'</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>


    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">yield_singleton2</span> <span class="entity">f</span> <span class="entity">x</span> <span class="entity">y</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">f</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span> <span class="entity">y</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="main">(</span><span class="main">(</span><span class="entity">r1</span><span class="main">,</span><span class="main">[</span><span class="entity">r2</span><span class="main">]</span><span class="main">)</span><span class="main">,</span><span class="entity">r3</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">(</span><span class="entity">r1</span><span class="main">,</span><span class="entity">r2</span><span class="main">)</span><span class="main">,</span><span class="entity">r3</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> error <span class="inner_quoted">"INTERNAL: yield_singleton2"</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="main">(</span><span class="entity">f</span> <span class="entity">##</span> <span class="entity">g</span><span class="main">)</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">a</span><span class="main">,</span> <span class="entity">g</span> <span class="entity">b</span><span class="main">)</span>
  
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">seq_is_empty</span> <span class="entity">seq</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> Seq.pull <span class="entity">seq</span> <span class="keyword2"><span class="keyword">of</span></span>
      NONE <span class="main">=&gt;</span> <span class="main">(</span>true<span class="main">,</span> <span class="entity">seq</span><span class="main">)</span>
    <span class="main">|</span> SOME <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">seq</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>false<span class="main">,</span> Seq.cons <span class="entity">a</span> <span class="entity">seq</span><span class="main">)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">split</span> <span class="entity">P</span> <span class="entity">l</span> <span class="main">=</span> <span class="main">(</span>filter <span class="entity">P</span> <span class="entity">l</span><span class="main">,</span> filter_out <span class="entity">P</span> <span class="entity">l</span><span class="main">)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">split_matching</span> <span class="entity">R</span> <span class="entity">xs</span> <span class="entity">ys</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">exception</span></span> <span class="entity">EXC</span>
    
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fs</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> <span class="entity">EXC</span>
          <span class="main">|</span> <span class="entity">fs</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">y</span>::<span class="entity">ys</span><span class="main">)</span> <span class="main">=</span> 
              <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">R</span> <span class="entity">x</span> <span class="entity">y</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="entity">y</span><span class="main">,</span><span class="entity">ys</span><span class="main">)</span> 
              <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">y'</span><span class="main">,</span><span class="entity">ys</span><span class="main">)</span> <span class="main">=</span> <span class="entity">fs</span> <span class="entity">x</span> <span class="entity">ys</span> <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">y'</span><span class="main">,</span><span class="entity">y</span>::<span class="entity">ys</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
    
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fm</span> <span class="main">[</span><span class="main">]</span> <span class="entity">ys</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="entity">ys</span><span class="main">)</span>      
          <span class="main">|</span> <span class="entity">fm</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">xs</span><span class="main">)</span> <span class="entity">ys</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">y</span><span class="main">,</span><span class="entity">ys</span><span class="main">)</span> <span class="main">=</span> <span class="entity">fs</span> <span class="entity">x</span> <span class="entity">ys</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">ys1</span><span class="main">,</span><span class="entity">ys2</span><span class="main">)</span> <span class="main">=</span> <span class="entity">fm</span> <span class="entity">xs</span> <span class="entity">ys</span>
            <span class="keyword2"><span class="keyword">in</span></span>
              <span class="main">(</span><span class="entity">y</span>::<span class="entity">ys1</span><span class="main">,</span><span class="entity">ys2</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">in</span></span>
        try <span class="main">(</span><span class="entity">fm</span> <span class="entity">xs</span><span class="main">)</span> <span class="entity">ys</span>
      <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword3"><span class="keyword">open</span></span> <span class="entity">Basic_Refine_Util</span>
›</span>  




<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Mpat_Antiquot">
<div class="head">
<h1>Theory Mpat_Antiquot</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Matching-Pattern Antiquotation›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Mpat_Antiquot
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Refine_Util_Bootstrap1.html">Refine_Util_Bootstrap1</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">typedecl</span></span> term_struct
<span class="keyword1"><span class="command">typedecl</span></span> typ_struct
<span class="keyword1"><span class="command">typedecl</span></span> sort

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mpaq_AS_PAT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">AS<span class="hidden">⇩</span><sub>p</sub></span>"</span> 900<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1"><span class="free">AS<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mpaq_STRUCT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term_struct <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mpaq_STRUCT</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">mpaq_AS_STRUCT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> term_struct <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">AS<span class="hidden">⇩</span><sub>s</sub></span>"</span> 900<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1"><span class="free">AS<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">AS<span class="hidden">⇩</span><sub>p</sub></span> mpaq_STRUCT <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">consts</span></span>
  mpaq_Const <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> typ_struct <span class="main">⇒</span> term_struct"</span></span>
  mpaq_Free <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> typ_struct <span class="main">⇒</span> term_struct"</span></span>
  mpaq_Var <span class="main">::</span> <span class="quoted"><span class="quoted">"string<span class="main">*</span>nat <span class="main">⇒</span> typ_struct <span class="main">⇒</span> term_struct"</span></span>
  mpaq_Bound <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> term_struct"</span></span>
  mpaq_Abs <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> typ_struct <span class="main">⇒</span> term_struct <span class="main">⇒</span> term_struct"</span></span>
  mpaq_App <span class="main">::</span> <span class="quoted"><span class="quoted">"term_struct <span class="main">⇒</span> term_struct <span class="main">⇒</span> term_struct"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">$$</span>"</span> 900<span class="main">)</span>

<span class="keyword1"><span class="command">consts</span></span>
  mpaq_TFree <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> sort <span class="main">⇒</span> typ_struct"</span></span>
  mpaq_TVar <span class="main">::</span> <span class="quoted"><span class="quoted">"string<span class="main">*</span>nat <span class="main">⇒</span> sort <span class="main">⇒</span> typ_struct"</span></span>
  mpaq_Type <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> typ_struct list <span class="main">⇒</span> typ_struct"</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="comment1">(*
    Antiquotation to generate a term-pattern in ML. 
    Features:
      * Schematic term variables are translated to ML-variables of same name.
      * Non-dummy variables in lambda-abstractions are bound to variables of 
        same name, and type of λx. t is bound to x_T
      * In (typs) mode, schematic type variables are translated if they start
        with 'v_, where the prefix is removed. Otherwise, types are completely
        ignored and translated to ML dummy pattern.
      * Dummy variables are translated to ML dummy patterns
      * Supports AS to define alternative pattern,
        and STRUCT to reflect term structure
  
    Limitations:
      * Non-linear patterns are not allowed, due to SML limitation.
        For term variables, it will result in an error. Type variables, 
        however, are silently linearized and only the first occurrence is bound.
      * Indexes &lt;&gt;0 on term variables are not allowed. 
        On type variables, such indexes are silently ignored.
      * Sorts are completely ignored
      * Due to the type-inference on patterns, only innermost types can be 
        bound to names.
      * Patterns are not localized. Currently, we issue an error if pattern
        contains free variables.

    TODO:
      * We could also bind the type of a term-var, where the name for the 
        type ML-var is encoded into the term-var name

    Examples: See below

  *)</span>

  <span class="keyword2"><span class="keyword">local</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">replace_dummy'</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Pure.dummy_pattern<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="main">=</span>
          <span class="main">(</span>Var <span class="main">(</span><span class="main">(</span><span class="inner_quoted">"_dummy_"</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span><span class="main">,</span> <span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">replace_dummy'</span> <span class="main">(</span>Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">T</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">t'</span><span class="main">,</span> <span class="entity">i'</span><span class="main">)</span> <span class="main">=</span> <span class="entity">replace_dummy'</span> <span class="entity">t</span> <span class="entity">i</span>
          <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span>Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">T</span><span class="main">,</span> <span class="entity">t'</span><span class="main">)</span><span class="main">,</span> <span class="entity">i'</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> <span class="entity">replace_dummy'</span> <span class="main">(</span><span class="entity">t</span> $ <span class="entity">u</span><span class="main">)</span> <span class="entity">i</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">t'</span><span class="main">,</span> <span class="entity">i'</span><span class="main">)</span> <span class="main">=</span> <span class="entity">replace_dummy'</span> <span class="entity">t</span> <span class="entity">i</span><span class="main">;</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">u'</span><span class="main">,</span> <span class="entity">i''</span><span class="main">)</span> <span class="main">=</span> <span class="entity">replace_dummy'</span> <span class="entity">u</span> <span class="entity">i'</span><span class="main">;</span>
          <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">t'</span> $ <span class="entity">u'</span><span class="main">,</span> <span class="entity">i''</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> <span class="entity">replace_dummy'</span> <span class="entity">a</span> <span class="entity">i</span> <span class="main">=</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prepare_dummies'</span> <span class="entity">ts</span> <span class="main">=</span> <span class="main">#</span><span class="inner_numeral">1</span> <span class="main">(</span>fold_map <span class="entity">replace_dummy'</span> <span class="entity">ts</span> <span class="inner_numeral">1</span><span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tcheck</span> <span class="main">(</span>Type <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">Ts</span><span class="main">)</span><span class="main">)</span> <span class="entity">tnames</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">Ts</span><span class="main">,</span><span class="entity">tnames</span><span class="main">)</span> <span class="main">=</span> <span class="entity">map_fold</span> <span class="entity">tcheck</span> <span class="entity">Ts</span> <span class="entity">tnames</span>
        <span class="keyword2"><span class="keyword">in</span></span> 
          <span class="main">(</span>Type <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">Ts</span><span class="main">)</span><span class="main">,</span><span class="entity">tnames</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> <span class="entity">tcheck</span> <span class="main">(</span>TFree <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">_</span> <span class="main">=</span> 
          error <span class="main">(</span><span class="inner_quoted">"Pattern contains free type variable: "</span> ^ <span class="entity">name</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">tcheck</span> <span class="main">(</span>TVar <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">idx</span><span class="main">)</span><span class="main">,</span><span class="entity">S</span><span class="main">)</span><span class="main">)</span> <span class="entity">tnames</span> <span class="main">=</span> 
          <span class="keyword2"><span class="keyword">if</span></span> String.isPrefix <span class="inner_quoted">"'v_"</span> <span class="entity">name</span> <span class="keyword1"><span class="keyword">andalso</span></span> not <span class="main">(</span>member <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">tnames</span> <span class="entity">name</span><span class="main">)</span> 
          <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>TVar <span class="main">(</span><span class="main">(</span>unprefix <span class="inner_quoted">"'v_"</span> <span class="entity">name</span><span class="main">,</span><span class="entity">idx</span><span class="main">)</span><span class="main">,</span><span class="entity">S</span><span class="main">)</span><span class="main">,</span><span class="entity">name</span>::<span class="entity">tnames</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span>TVar <span class="main">(</span><span class="main">(</span><span class="inner_quoted">"_"</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span><span class="entity">S</span><span class="main">)</span><span class="main">,</span><span class="entity">tnames</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">vcheck</span> <span class="main">(</span>Const <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">vnames</span><span class="main">,</span><span class="entity">tnames</span><span class="main">)</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">let</span></span> 
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">T</span><span class="main">,</span><span class="entity">tnames</span><span class="main">)</span> <span class="main">=</span> <span class="entity">tcheck</span> <span class="entity">T</span> <span class="entity">tnames</span>
        <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span>Const <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">vnames</span><span class="main">,</span><span class="entity">tnames</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> <span class="entity">vcheck</span> <span class="main">(</span>Free <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">_</span> <span class="main">=</span> 
          error <span class="main">(</span><span class="inner_quoted">"Pattern contains free variable: "</span> ^ <span class="entity">n</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">vcheck</span> <span class="main">(</span>Var <span class="main">(</span><span class="main">(</span><span class="inner_quoted">"_dummy_"</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">vnames</span><span class="main">,</span><span class="entity">tnames</span><span class="main">)</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">T</span><span class="main">,</span><span class="entity">tnames</span><span class="main">)</span> <span class="main">=</span> <span class="entity">tcheck</span> <span class="entity">T</span> <span class="entity">tnames</span>
        <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span>Var <span class="main">(</span><span class="main">(</span><span class="inner_quoted">"_"</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">vnames</span><span class="main">,</span><span class="entity">tnames</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> <span class="entity">vcheck</span> <span class="main">(</span>Var <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">idx</span><span class="main">)</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">vnames</span><span class="main">,</span><span class="entity">tnames</span><span class="main">)</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">T</span><span class="main">,</span><span class="entity">tnames</span><span class="main">)</span> <span class="main">=</span> <span class="entity">tcheck</span> <span class="entity">T</span> <span class="entity">tnames</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">idx</span> &lt;&gt; <span class="inner_numeral">0</span> <span class="keyword1"><span class="keyword">andalso</span></span> error <span class="main">(</span><span class="inner_quoted">"Variable index greater zero: "</span>
            ^ Term.string_of_vname <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">idx</span><span class="main">)</span><span class="main">)</span> 
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> member <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">vnames</span> <span class="entity">name</span> <span class="keyword1"><span class="keyword">andalso</span></span> error <span class="main">(</span><span class="inner_quoted">"Non-linear pattern: "</span>
            ^ Term.string_of_vname <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">idx</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span>Var <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">name</span>::<span class="entity">vnames</span><span class="main">,</span><span class="entity">tnames</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> <span class="entity">vcheck</span> <span class="main">(</span>Bound <span class="entity">i</span><span class="main">)</span> <span class="entity">p</span> <span class="main">=</span> <span class="main">(</span>Bound <span class="entity">i</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">vcheck</span> <span class="main">(</span>Abs <span class="main">(</span><span class="inner_quoted">"uu_"</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">vnames</span><span class="main">,</span><span class="entity">tnames</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">T</span><span class="main">,</span><span class="entity">tnames</span><span class="main">)</span> <span class="main">=</span> <span class="entity">tcheck</span> <span class="entity">T</span> <span class="entity">tnames</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="main">(</span><span class="entity">vnames</span><span class="main">,</span><span class="entity">tnames</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">vcheck</span> <span class="entity">t</span> <span class="main">(</span><span class="entity">vnames</span><span class="main">,</span><span class="entity">tnames</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span>Abs <span class="main">(</span><span class="inner_quoted">"_"</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">vnames</span><span class="main">,</span><span class="entity">tnames</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> <span class="entity">vcheck</span> <span class="main">(</span>Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">vnames</span><span class="main">,</span><span class="entity">tnames</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">T</span><span class="main">,</span><span class="entity">tnames</span><span class="main">)</span> <span class="main">=</span> <span class="entity">tcheck</span> <span class="entity">T</span> <span class="entity">tnames</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="main">(</span><span class="entity">vnames</span><span class="main">,</span><span class="entity">tnames</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">vcheck</span> <span class="entity">t</span> <span class="main">(</span><span class="entity">vnames</span><span class="main">,</span><span class="entity">tnames</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span>Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">vnames</span><span class="main">,</span><span class="entity">tnames</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> <span class="entity">vcheck</span> <span class="main">(</span><span class="entity">t1</span>$<span class="entity">t2</span><span class="main">)</span> <span class="entity">p</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">t1</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">=</span> <span class="entity">vcheck</span> <span class="entity">t1</span> <span class="entity">p</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">t2</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">=</span> <span class="entity">vcheck</span> <span class="entity">t2</span> <span class="entity">p</span>
        <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">t1</span>$<span class="entity">t2</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">read</span> <span class="main">=</span> Scan.lift <span class="main">(</span>Args.mode <span class="inner_quoted">"typs"</span> <span class="main">)</span>
      -- <span class="main">(</span>Args.context -- Scan.lift <span class="main">(</span>Parse.position Args.embedded_inner_syntax<span class="main">)</span><span class="main">)</span>
        

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">write</span> <span class="main">(</span><span class="entity">with_types</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">twr_aux</span> <span class="main">(</span>Type <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">Ts</span><span class="main">)</span><span class="main">)</span> 
            <span class="main">=</span> <span class="inner_quoted">"Type ("</span> ^ ML_Syntax.print_string <span class="entity">name</span> ^ <span class="inner_quoted">", "</span> ^ ML_Syntax.print_list <span class="entity">twr_aux</span> <span class="entity">Ts</span> ^ <span class="inner_quoted">")"</span>
        <span class="main">|</span> <span class="entity">twr_aux</span> <span class="main">(</span>TFree <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">"TFree ("</span> ^ ML_Syntax.print_string <span class="entity">name</span> ^ <span class="inner_quoted">", _)"</span>
        <span class="main">|</span> <span class="entity">twr_aux</span> <span class="main">(</span>TVar <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">name</span>
  
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">twr</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">with_types</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">twr_aux</span> <span class="keyword2"><span class="keyword">else</span></span> K <span class="inner_quoted">"_"</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">s_string</span> <span class="main">(</span>Var <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">name</span>
        <span class="main">|</span> <span class="entity">s_string</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> try <span class="entity">HOLogic.dest_string</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
            SOME <span class="entity">s</span> <span class="main">=&gt;</span> ML_Syntax.print_string <span class="entity">s</span>
          <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"Expected var or string literal"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">s_index</span> <span class="main">(</span>Var <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">name</span>
        <span class="main">|</span> <span class="entity">s_index</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> try <span class="entity">HOLogic.dest_nat</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
            SOME <span class="entity">n</span> <span class="main">=&gt;</span> ML_Syntax.print_int <span class="entity">n</span>
          <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"Expected var or nat literal"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">s_indexname</span> <span class="main">(</span>Var <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">name</span>
        <span class="main">|</span> <span class="entity">s_indexname</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Pair<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="entity">n</span>$<span class="entity">i</span><span class="main">)</span> <span class="main">=</span>
            <span class="inner_quoted">"("</span> ^ <span class="entity">s_string</span> <span class="entity">n</span> ^ <span class="inner_quoted">", "</span> ^ <span class="entity">s_index</span> <span class="entity">i</span> ^ <span class="inner_quoted">")"</span>
        <span class="main">|</span> <span class="entity">s_indexname</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"Expected var or indexname-pair"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">s_typ</span> <span class="main">(</span>Var <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">name</span>
        <span class="main">|</span> <span class="entity">s_typ</span> <span class="main">(</span>Const<span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "mpaq_TFree"<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="entity">name</span>$<span class="entity">typ</span><span class="main">)</span> 
            <span class="main">=</span> <span class="inner_quoted">"TFree ("</span> ^ <span class="entity">s_string</span> <span class="entity">name</span> ^ <span class="inner_quoted">","</span> ^ <span class="entity">s_typ</span> <span class="entity">typ</span> ^ <span class="inner_quoted">")"</span>
        <span class="main">|</span> <span class="entity">s_typ</span> <span class="main">(</span>Const<span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "mpaq_TVar"<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="entity">name</span>$<span class="entity">typ</span><span class="main">)</span>
            <span class="main">=</span> <span class="inner_quoted">"TVar ("</span> ^ <span class="entity">s_indexname</span> <span class="entity">name</span> ^ <span class="inner_quoted">","</span> ^ <span class="entity">s_typ</span> <span class="entity">typ</span> ^ <span class="inner_quoted">")"</span>
        <span class="main">|</span> <span class="entity">s_typ</span> <span class="main">(</span>Const<span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "mpaq_Type"<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="entity">name</span>$<span class="entity">args</span><span class="main">)</span>
            <span class="main">=</span> <span class="inner_quoted">"Type ("</span> ^ <span class="entity">s_string</span> <span class="entity">name</span> ^ <span class="inner_quoted">","</span> ^ <span class="entity">s_args</span> <span class="entity">args</span> ^ <span class="inner_quoted">")"</span>
        <span class="main">|</span> <span class="entity">s_typ</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"Expected var or type structure"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">s_args</span> <span class="main">(</span>Var <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">name</span>
        <span class="main">|</span> <span class="entity">s_args</span> <span class="entity">t</span> <span class="main">=</span> <span class="main">(</span> <span class="keyword2"><span class="keyword">case</span></span> try <span class="entity">HOLogic.dest_list</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
            SOME <span class="entity">l</span> <span class="main">=&gt;</span> ML_Syntax.print_list <span class="entity">s_typ</span> <span class="entity">l</span>
          <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"Expected variable or type argument list"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>
          <span class="main">)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">swr</span> <span class="main">(</span>Const<span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "mpaq_Const"<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="entity">name</span>$<span class="entity">typ</span><span class="main">)</span> 
            <span class="main">=</span> <span class="inner_quoted">"Const ("</span> ^ <span class="entity">s_string</span> <span class="entity">name</span> ^ <span class="inner_quoted">", "</span> ^ <span class="entity">s_typ</span> <span class="entity">typ</span> ^ <span class="inner_quoted">")"</span>
        <span class="main">|</span> <span class="entity">swr</span> <span class="main">(</span>Const<span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "mpaq_Free"<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="entity">name</span>$<span class="entity">typ</span><span class="main">)</span>
            <span class="main">=</span> <span class="inner_quoted">"Free ("</span> ^ <span class="entity">s_string</span> <span class="entity">name</span> ^ <span class="inner_quoted">", "</span> ^ <span class="entity">s_typ</span> <span class="entity">typ</span> ^ <span class="inner_quoted">")"</span>
        <span class="main">|</span> <span class="entity">swr</span> <span class="main">(</span>Const<span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "mpaq_Var"<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="entity">name</span>$<span class="entity">typ</span><span class="main">)</span>
            <span class="main">=</span> <span class="inner_quoted">"Var ("</span> ^ <span class="entity">s_indexname</span> <span class="entity">name</span> ^ <span class="inner_quoted">", "</span> ^ <span class="entity">s_typ</span> <span class="entity">typ</span> ^ <span class="inner_quoted">")"</span>
        <span class="main">|</span> <span class="entity">swr</span> <span class="main">(</span>Const<span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "mpaq_Bound"<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="entity">idx</span><span class="main">)</span>
            <span class="main">=</span> <span class="inner_quoted">"Bound "</span> ^ <span class="entity">s_index</span> <span class="entity">idx</span>
        <span class="main">|</span> <span class="entity">swr</span> <span class="main">(</span>Const<span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "mpaq_Abs"<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="entity">name</span>$<span class="entity">T</span>$<span class="entity">t</span><span class="main">)</span>
            <span class="main">=</span> <span class="inner_quoted">"Abs ("</span> ^ <span class="entity">s_string</span> <span class="entity">name</span> ^ <span class="inner_quoted">", "</span> ^ <span class="entity">s_typ</span> <span class="entity">T</span> ^ <span class="inner_quoted">", "</span> ^ <span class="entity">swr</span> <span class="entity">t</span> ^ <span class="inner_quoted">")"</span>
        <span class="main">|</span> <span class="entity">swr</span> <span class="main">(</span>Const<span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "mpaq_App"<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="entity">t1</span>$<span class="entity">t2</span><span class="main">)</span>
            <span class="main">=</span> <span class="inner_quoted">"("</span> ^ <span class="entity">swr</span> <span class="entity">t1</span> ^ <span class="inner_quoted">") $ ("</span> ^ <span class="entity">swr</span> <span class="entity">t2</span> ^ <span class="inner_quoted">")"</span>
        <span class="main">|</span> <span class="entity">swr</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"Expected var or term structure"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">vwr</span> <span class="main">(</span>Const <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">)</span> 
            <span class="main">=</span> <span class="inner_quoted">"Const ("</span> ^ ML_Syntax.print_string <span class="entity">name</span> ^ <span class="inner_quoted">", "</span> ^ <span class="entity">twr</span> <span class="entity">T</span> ^ <span class="inner_quoted">")"</span>
        <span class="main">|</span> <span class="entity">vwr</span> <span class="main">(</span>Var <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">name</span>
        <span class="main">|</span> <span class="entity">vwr</span> <span class="main">(</span>Free <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">"Free ("</span> ^ <span class="entity">name</span> ^ <span class="inner_quoted">", "</span> ^ <span class="entity">twr</span> <span class="entity">T</span> ^ <span class="inner_quoted">")"</span>
        <span class="main">|</span> <span class="entity">vwr</span> <span class="main">(</span>Bound <span class="entity">i</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">"Bound "</span> ^ ML_Syntax.print_int <span class="entity">i</span>
        <span class="main">|</span> <span class="entity">vwr</span> <span class="main">(</span>Abs <span class="main">(</span><span class="inner_quoted">"_"</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">"Abs (_,"</span> ^ <span class="entity">twr</span> <span class="entity">T</span> ^ <span class="inner_quoted">","</span> ^ <span class="entity">vwr</span> <span class="entity">t</span> ^ <span class="inner_quoted">")"</span>
        <span class="main">|</span> <span class="entity">vwr</span> <span class="main">(</span>Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">"Abs ("</span> ^ <span class="entity">x</span> ^ <span class="inner_quoted">","</span> 
                ^ <span class="entity">x</span> ^ <span class="inner_quoted">"_T as "</span> ^ <span class="entity">twr</span> <span class="entity">T</span> ^ <span class="inner_quoted">","</span> 
                ^ <span class="entity">vwr</span> <span class="entity">t</span> ^ <span class="inner_quoted">")"</span>
        <span class="main">|</span> <span class="entity">vwr</span> <span class="main">(</span>Const<span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> mpaq_STRUCT<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
            <span class="entity">swr</span> <span class="entity">t</span>
          <span class="main">)</span>
        <span class="main">|</span> <span class="entity">vwr</span> <span class="main">(</span><span class="entity">trm</span> <span class="keyword1"><span class="keyword">as</span></span> Const<span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "mpaq_AS_PAT"<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="entity">t</span>$<span class="entity">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> 
            <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
              <span class="main">(</span>Var <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">name</span> ^ <span class="inner_quoted">" as ("</span> ^ <span class="entity">vwr</span> <span class="entity">s</span> ^ <span class="inner_quoted">")"</span>
            <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"_AS_ must have identifier on LHS"</span><span class="main">,</span><span class="main">[</span><span class="entity">trm</span><span class="main">]</span><span class="main">)</span>
          <span class="main">)</span>
        <span class="main">|</span> <span class="entity">vwr</span> <span class="main">(</span><span class="entity">t1</span>$<span class="entity">t2</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">"("</span> ^ <span class="entity">vwr</span> <span class="entity">t1</span> ^ <span class="inner_quoted">") $ ("</span> ^ <span class="entity">vwr</span> <span class="entity">t2</span> ^ <span class="inner_quoted">")"</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">vcheck</span> <span class="entity">t</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">s</span> <span class="main">=</span> <span class="entity">vwr</span> <span class="entity">t</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="inner_quoted">"("</span> ^ <span class="entity">s</span> ^ <span class="inner_quoted">")"</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process</span> <span class="main">(</span><span class="entity">with_types</span><span class="main">,</span><span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="main">(</span><span class="entity">raw_t</span><span class="main">,</span><span class="entity">pos</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt'</span> <span class="main">=</span> Context.proof_map <span class="main">(</span>
        Syntax_Phases.term_check <span class="inner_numeral">90</span> <span class="inner_quoted">"Prepare dummies"</span> <span class="main">(</span>K <span class="entity">prepare_dummies'</span><span class="main">)</span>
      <span class="main">)</span> <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> Proof_Context.read_term_pattern <span class="entity">ctxt'</span> <span class="entity">raw_t</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="entity">write</span> <span class="main">(</span><span class="entity">with_types</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="comment1">(*tracing res;*)</span>
      <span class="entity">res</span>
    <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword3"><span class="keyword">handle</span></span> ERROR <span class="entity">msg</span> <span class="main">=&gt;</span> error <span class="main">(</span><span class="entity">msg</span> ^ Position.here <span class="entity">pos</span><span class="main">)</span>
    <span class="main">)</span>


  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mpat_antiquot</span> <span class="main">=</span> <span class="entity">read</span> &gt;&gt; <span class="entity">process</span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹
  ML_Antiquotation.inline <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> "mpat"<span class="antiquote">}</span></span></span> <span class="entity">mpat_antiquot</span>
›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Examples›</span></span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_pair_singleton</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="var">?a</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">}</span>"</span><span class="antiquote">}</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="entity">a</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">dest_pair_singleton</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dest_pair_singleton"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_nat_pair_singleton</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="main">(</span><span class="quasi_keyword">typs</span><span class="main">)</span> <span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="var">?a</span><span class="main">::</span>nat<span class="main">,</span><span class="var">?b</span><span class="main">::</span>nat<span class="main">)</span><span class="main">}</span>"</span><span class="antiquote">}</span></span></span></span> <span class="main">=</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">dest_nat_pair_singleton</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dest_nat_pair_singleton"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_pair_singleton_T</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="main">(</span><span class="quasi_keyword">typs</span><span class="main">)</span> <span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="var">?a</span><span class="main">::</span><span class="main">_</span> <span class="main">⇒</span> <span class="tvar">?'v_Ta</span><span class="main">,</span><span class="var">?b</span><span class="main">::</span><span class="tvar">?'v_Tb</span><span class="main">)</span><span class="main">}</span>"</span><span class="antiquote">}</span></span></span></span></span></span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">Ta</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">b</span><span class="main">,</span><span class="entity">Tb</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">dest_pair_singleton_T</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dest_pair_singleton_T"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_pair_lambda</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="var">?Ta</span><span class="main">,</span> <span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="var">?Tb</span><span class="main">)</span><span class="main">}</span>"</span><span class="antiquote">}</span></span></span></span></span></span></span></span> <span class="main">=</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">a_T</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">b_T</span><span class="main">,</span><span class="entity">Ta</span><span class="main">,</span><span class="entity">Tb</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">dest_pair_lambda</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dest_pair_lambda"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>


  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">foo</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="main">[</span><span class="var">?a</span><span class="main">,</span><span class="var">?b</span> <span class="keyword1">AS<span class="hidden">⇩</span><sub>s</sub></span> mpaq_Bound <span class="var">?i</span><span class="main">,</span><span class="var">?c</span> <span class="keyword1">AS<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">[</span><span class="var">?n</span><span class="main">]</span><span class="main">]</span>"</span><span class="antiquote">}</span></span></span></span></span></span></span> <span class="main">=</span> 
    <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">i</span><span class="main">,</span><span class="entity">c</span><span class="main">,</span><span class="entity">n</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">foo</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"foo"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>


›</span>

<span class="keyword1"><span class="command">hide_type</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> term_struct typ_struct sort


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Mk_Term_Antiquot">
<div class="head">
<h1>Theory Mk_Term_Antiquot</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Antiquotation to Build Terms›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Mk_Term_Antiquot
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Refine_Util_Bootstrap1.html">Refine_Util_Bootstrap1</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="comment1">(*
  Antiquotation to generate a term from a template.

  This antiquotation takes a term with schematic variables, 
  interprets the schematic variables as names of term-valued ML-variables and generates
  code to create the ML-level representation of the term with the schematics replaced
  by the ML-variables.  

  All type variables in the term must be inferable from the types of the schematics.

  Limitations:
    * The type-inference is not complete, i.e., it may fail to detect some type-errors,
      resulting in untypable terms to be created.

    * Does not work if inserted terms contain loose bound variables (FIXME)

  TODO:
    * We could also provide explicit type variables

  Examples: See below
*)</span>

<span class="keyword2"><span class="keyword">local</span></span>

  <span class="keyword1"><span class="keyword">fun</span></span> 
    <span class="entity">add_nv_tvars</span> <span class="main">(</span>Const <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">)</span> <span class="entity">l</span> <span class="main">=</span> Term.add_tvarsT <span class="entity">T</span> <span class="entity">l</span>
  <span class="main">|</span> <span class="entity">add_nv_tvars</span> <span class="main">(</span>Free <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">)</span> <span class="entity">l</span> <span class="main">=</span>  Term.add_tvarsT <span class="entity">T</span> <span class="entity">l</span>
  <span class="main">|</span> <span class="entity">add_nv_tvars</span> <span class="main">(</span>Abs <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="entity">l</span> <span class="main">=</span> <span class="entity">add_nv_tvars</span> <span class="entity">t</span> <span class="main">(</span>Term.add_tvarsT <span class="entity">T</span> <span class="entity">l</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">add_nv_tvars</span> <span class="main">(</span><span class="entity">t1</span>$<span class="entity">t2</span><span class="main">)</span> <span class="entity">l</span> <span class="main">=</span> <span class="entity">add_nv_tvars</span> <span class="entity">t1</span> <span class="main">(</span><span class="entity">add_nv_tvars</span> <span class="entity">t2</span> <span class="entity">l</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">add_nv_tvars</span> <span class="main">_</span> <span class="entity">l</span> <span class="main">=</span> <span class="entity">l</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prepare</span> <span class="entity">env</span> <span class="entity">t</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tvars</span> <span class="main">=</span> <span class="entity">add_nv_tvars</span> <span class="entity">t</span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vars</span> <span class="main">=</span> Term.add_vars <span class="entity">t</span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vtvars</span> <span class="main">=</span> fold <span class="main">(</span>Term.add_tvarsT o <span class="main">#</span><span class="inner_numeral">2</span><span class="main">)</span> <span class="entity">vars</span> <span class="main">[</span><span class="main">]</span>
  
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_expl_tvar</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span> <span class="main">=</span> <span class="entity">i</span><span class="main">=</span><span class="inner_numeral">0</span> <span class="keyword1"><span class="keyword">andalso</span></span> String.isPrefix <span class="inner_quoted">"'v_"</span> <span class="entity">n</span>
  
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">expl_tvars</span> <span class="main">=</span> Term.add_tvars <span class="entity">t</span> <span class="main">[</span><span class="main">]</span>
      |&gt; filter <span class="main">(</span><span class="entity">is_expl_tvar</span> o <span class="main">#</span><span class="inner_numeral">1</span><span class="main">)</span>
  
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">spec_tvars</span> <span class="main">=</span> union <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">vtvars</span> <span class="entity">expl_tvars</span>
  
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> subset <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="main">(</span><span class="entity">tvars</span><span class="main">,</span> <span class="entity">spec_tvars</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">orelse</span></span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">loose</span> <span class="main">=</span> subtract <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">spec_tvars</span> <span class="entity">tvars</span> 
          |&gt; map <span class="main">(</span>TVar #&gt; Syntax.pretty_typ <span class="entity">ctxt</span><span class="main">)</span>
          |&gt; Pretty.commas |&gt; Pretty.block

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pretty_t</span> <span class="main">=</span> Syntax.pretty_term <span class="entity">ctxt</span> <span class="entity">t</span>
  
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">msg</span> <span class="main">=</span> Pretty.block <span class="main">[</span>
            Pretty.str <span class="inner_quoted">"mk_term: Loose type variables in"</span><span class="main">,</span>
            Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span><span class="entity">pretty_t</span><span class="main">,</span>Pretty.str <span class="inner_quoted">":"</span><span class="main">,</span>Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span><span class="entity">loose</span>
          <span class="main">]</span> |&gt; Pretty.string_of
        
      <span class="keyword2"><span class="keyword">in</span></span> error <span class="entity">msg</span> <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> fold 
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">v</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span>&lt;&gt;<span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> 
          Pretty.block <span class="main">[</span>
            Pretty.str <span class="inner_quoted">"mk_term: Variable indices must be zero:"</span><span class="main">,</span> Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span>
            Syntax.pretty_term <span class="entity">ctxt</span> <span class="main">(</span>Var <span class="entity">v</span><span class="main">)</span>
          <span class="main">]</span> |&gt; Pretty.string_of |&gt; error
        <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
      <span class="main">)</span> 
      <span class="entity">vars</span> <span class="main">(</span><span class="main">)</span>
  
    <span class="comment1">(* ARGH!!! "subtract eq a b" computes "b - a" *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">unused_tvars</span> <span class="main">=</span> subtract <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">tvars</span> <span class="entity">vtvars</span> 
      |&gt; map <span class="main">#</span><span class="inner_numeral">1</span>
  
    <span class="comment1">(*
    val _ = tracing ("tvars: " ^ @{make_string} tvars)
    val _ = tracing ("vtvars: " ^ @{make_string} vtvars)
    val _ = tracing ("unused_tvars: " ^ @{make_string} unused_tvars)
    *)</span>
  
    <span class="keyword1"><span class="keyword">fun</span></span> 
      <span class="entity">lin_type</span> <span class="main">(</span>TFree <span class="entity">f</span><span class="main">)</span> <span class="entity">Ts</span> <span class="main">=</span> <span class="main">(</span>TFree <span class="entity">f</span><span class="main">,</span> <span class="entity">Ts</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">lin_type</span> <span class="main">(</span>TVar <span class="main">(</span><span class="entity">iname</span><span class="main">,</span><span class="entity">S</span><span class="main">)</span><span class="main">)</span> <span class="entity">Ts</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_expl_tvar</span> <span class="entity">iname</span> <span class="keyword1"><span class="keyword">orelse</span></span> member <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">Ts</span> <span class="entity">iname</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>TVar <span class="main">(</span><span class="main">(</span><span class="inner_quoted">"_"</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span><span class="entity">S</span><span class="main">)</span><span class="main">,</span> <span class="entity">Ts</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span>TVar <span class="main">(</span><span class="entity">iname</span><span class="main">,</span><span class="entity">S</span><span class="main">)</span><span class="main">,</span> <span class="entity">iname</span>::<span class="entity">Ts</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">lin_type</span> <span class="main">(</span>Type <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span><span class="main">)</span> <span class="entity">Ts</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">args</span><span class="main">,</span><span class="entity">Ts</span><span class="main">)</span> <span class="main">=</span> <span class="entity">map_fold</span> <span class="entity">lin_type</span> <span class="entity">args</span> <span class="entity">Ts</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="main">(</span>Type <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span><span class="main">,</span><span class="entity">Ts</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">vars</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">map_fold</span> 
      <span class="main">(</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">iname</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">Ts</span> <span class="main">=&gt;</span> 
          <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">T</span><span class="main">,</span><span class="entity">Ts</span><span class="main">)</span> <span class="main">=</span> <span class="entity">lin_type</span> <span class="entity">T</span> <span class="entity">Ts</span> <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">iname</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">,</span><span class="entity">Ts</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">)</span> 
      <span class="entity">vars</span> <span class="entity">unused_tvars</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">name_of_T</span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">idx</span><span class="main">)</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_expl_tvar</span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">idx</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> unprefix <span class="inner_quoted">"'v_"</span> <span class="entity">name</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_quoted">"T_"</span> ^ <span class="entity">name</span> ^ <span class="inner_quoted">"_"</span> ^ string_of_int <span class="entity">idx</span>

    <span class="keyword2"><span class="keyword">local</span></span> 
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">wrv</span> <span class="main">(</span>TVar <span class="main">(</span><span class="main">(</span><span class="inner_quoted">"_"</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">"_"</span>
        <span class="main">|</span> <span class="entity">wrv</span> <span class="main">(</span>TVar <span class="main">(</span><span class="entity">iname</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">name_of_T</span> <span class="entity">iname</span>
        <span class="main">|</span> <span class="entity">wrv</span> <span class="main">(</span><span class="entity">T</span> <span class="keyword1"><span class="keyword">as</span></span> TFree <span class="main">_</span><span class="main">)</span> <span class="main">=</span> ML_Syntax.print_typ <span class="entity">T</span>
        <span class="main">|</span> <span class="entity">wrv</span> <span class="main">(</span>Type <span class="entity">arg</span><span class="main">)</span> <span class="main">=</span>
            <span class="inner_quoted">"Type "</span> ^ ML_Syntax.print_pair ML_Syntax.print_string <span class="main">(</span>ML_Syntax.print_list <span class="entity">wrv</span><span class="main">)</span> <span class="entity">arg</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_special</span> <span class="main">(</span>TVar <span class="main">_</span><span class="main">)</span> <span class="main">=</span> false <span class="main">|</span> <span class="entity">is_special</span> <span class="main">_</span> <span class="main">=</span> true
  
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_error_msg</span> <span class="entity">name</span> <span class="entity">T</span> <span class="main">=</span> 
        Pretty.block <span class="main">[</span>
          Pretty.str <span class="main">(</span><span class="inner_quoted">"mk_term type error: Argument for ?"</span> ^ <span class="entity">name</span> ^ <span class="inner_quoted">" does not match type"</span><span class="main">)</span><span class="main">,</span>
          Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span> Syntax.pretty_typ <span class="entity">ctxt</span> <span class="entity">T</span>
        <span class="main">]</span>
      |&gt; Pretty.unformatted_string_of |&gt; ML_Syntax.print_string
  
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pr_fastype</span> <span class="entity">name</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">env</span> <span class="keyword2"><span class="keyword">of</span></span>
        SOME <span class="entity">env</span> <span class="main">=&gt;</span> <span class="inner_quoted">"fastype_of1 ("</span> ^ <span class="entity">env</span> ^ <span class="inner_quoted">", "</span> ^ <span class="entity">name</span> ^ <span class="inner_quoted">")"</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="inner_quoted">"fastype_of "</span> ^ <span class="entity">name</span>
  
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">matcher</span> <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span> <span class="entity">rest</span> <span class="main">=</span> 
        <span class="inner_quoted">"case "</span> ^ <span class="entity">pr_fastype</span> <span class="entity">name</span> ^ <span class="inner_quoted">" of "</span> ^ <span class="entity">wrv</span> <span class="entity">T</span> ^ <span class="inner_quoted">" =&gt; ("</span> ^ <span class="entity">rest</span> ^ <span class="inner_quoted">")"</span>
        ^ <span class="main">(</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_special</span> <span class="entity">T</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_quoted">"| _ =&gt; raise TERM ("</span>^<span class="entity">mk_error_msg</span> <span class="entity">name</span> <span class="entity">T</span>^<span class="inner_quoted">",["</span>^<span class="entity">name</span>^<span class="inner_quoted">"])"</span> 
            <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_quoted">""</span><span class="main">)</span>

    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">matchers</span> <span class="main">[</span><span class="main">]</span> <span class="entity">rest</span> <span class="main">=</span> <span class="entity">rest</span>
        <span class="main">|</span> <span class="entity">matchers</span> <span class="main">(</span><span class="entity">v</span>::<span class="entity">vs</span><span class="main">)</span> <span class="entity">rest</span> <span class="main">=</span> <span class="entity">matcher</span> <span class="entity">v</span> <span class="main">(</span><span class="entity">matchers</span> <span class="entity">vs</span> <span class="entity">rest</span><span class="main">)</span>

    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword2"><span class="keyword">local</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_typ</span> <span class="main">(</span>Type <span class="entity">arg</span><span class="main">)</span> <span class="main">=</span>
            <span class="inner_quoted">"Type "</span> ^ ML_Syntax.print_pair ML_Syntax.print_string <span class="main">(</span>ML_Syntax.print_list <span class="entity">print_typ</span><span class="main">)</span> <span class="entity">arg</span>
        <span class="main">|</span> <span class="entity">print_typ</span> <span class="main">(</span>TFree <span class="entity">arg</span><span class="main">)</span> <span class="main">=</span>
            <span class="inner_quoted">"TFree "</span> ^ ML_Syntax.print_pair ML_Syntax.print_string ML_Syntax.print_sort <span class="entity">arg</span>
        <span class="main">|</span> <span class="entity">print_typ</span> <span class="main">(</span>TVar <span class="main">(</span><span class="entity">iname</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">name_of_T</span> <span class="entity">iname</span><span class="main">;</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_term</span> <span class="main">(</span>Const <span class="entity">arg</span><span class="main">)</span> <span class="main">=</span>
            <span class="inner_quoted">"Const "</span> ^ ML_Syntax.print_pair ML_Syntax.print_string <span class="entity">print_typ</span> <span class="entity">arg</span>
        <span class="main">|</span> <span class="entity">print_term</span> <span class="main">(</span>Free <span class="entity">arg</span><span class="main">)</span> <span class="main">=</span>
            <span class="inner_quoted">"Free "</span> ^ ML_Syntax.print_pair ML_Syntax.print_string ML_Syntax.print_typ <span class="entity">arg</span>
        <span class="main">|</span> <span class="entity">print_term</span> <span class="main">(</span>Var <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">name</span>
        <span class="main">|</span> <span class="entity">print_term</span> <span class="main">(</span>Bound <span class="entity">i</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">"Bound "</span> ^ ML_Syntax.print_int <span class="entity">i</span>
        <span class="main">|</span> <span class="entity">print_term</span> <span class="main">(</span>Abs <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">T</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
            <span class="keyword2"><span class="keyword">if</span></span> String.isPrefix <span class="inner_quoted">"v_"</span> <span class="entity">s</span> <span class="keyword2"><span class="keyword">then</span></span>
              <span class="inner_quoted">"Abs ("</span> ^ unprefix <span class="inner_quoted">"v_"</span> <span class="entity">s</span> ^ <span class="inner_quoted">", "</span> ^ <span class="entity">print_typ</span> <span class="entity">T</span> ^ <span class="inner_quoted">", "</span> ^ <span class="entity">print_term</span> <span class="entity">t</span> ^ <span class="inner_quoted">")"</span>
            <span class="keyword2"><span class="keyword">else</span></span>
              <span class="inner_quoted">"Abs ("</span> ^ ML_Syntax.print_string <span class="entity">s</span> ^ <span class="inner_quoted">", "</span> ^ <span class="entity">print_typ</span> <span class="entity">T</span> ^ <span class="inner_quoted">", "</span> ^ <span class="entity">print_term</span> <span class="entity">t</span> ^ <span class="inner_quoted">")"</span>
        <span class="main">|</span> <span class="entity">print_term</span> <span class="main">(</span><span class="entity">t1</span> $ <span class="entity">t2</span><span class="main">)</span> <span class="main">=</span>
            ML_Syntax.atomic <span class="main">(</span><span class="entity">print_term</span> <span class="entity">t1</span><span class="main">)</span> ^ <span class="inner_quoted">" $ "</span> ^ ML_Syntax.atomic <span class="main">(</span><span class="entity">print_term</span> <span class="entity">t2</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">et</span> <span class="main">=</span> <span class="entity">print_term</span> <span class="entity">t</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">e</span> <span class="main">=</span> <span class="inner_quoted">"("</span> ^ <span class="entity">matchers</span> <span class="entity">vars</span> <span class="entity">et</span> ^ <span class="inner_quoted">")"</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">e</span>
  <span class="keyword2"><span class="keyword">end</span></span>


  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">read</span> <span class="main">=</span> Scan.lift <span class="main">(</span>Scan.option <span class="main">(</span>Args.name --| Args.colon<span class="main">)</span><span class="main">)</span> -- 
    <span class="main">(</span>Args.context -- Scan.lift <span class="main">(</span>Parse.position Args.embedded_inner_syntax<span class="main">)</span><span class="main">)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process</span> <span class="main">(</span><span class="entity">env</span><span class="main">,</span><span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="main">(</span><span class="entity">raw_t</span><span class="main">,</span><span class="entity">pos</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> Proof_Context.read_term_pattern <span class="entity">ctxt</span> <span class="entity">raw_t</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">prepare</span> <span class="entity">env</span> <span class="entity">t</span> <span class="entity">ctxt</span>
  <span class="keyword2"><span class="keyword">end</span></span> <span class="keyword3"><span class="keyword">handle</span></span> ERROR <span class="entity">msg</span> <span class="main">=&gt;</span> error <span class="main">(</span><span class="entity">msg</span> ^ Position.here <span class="entity">pos</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mk_term_antiquot</span> <span class="main">=</span> <span class="entity">read</span> &gt;&gt; <span class="entity">process</span>
<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹ML_Antiquotation.inline <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> mk_term<span class="antiquote">}</span></span></span> <span class="entity">mk_term_antiquot</span>›</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Examples"</span></span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹
  <span class="comment1">(* The mk_term antiquotation can replace the omnipresent mk_xxx functions, and 
    easily works with complex patterns *)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_2elem_list</span> <span class="entity">a</span> <span class="entity">b</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mk_term</span> <span class="quoted">"<span class="main">[</span><span class="var">?a</span><span class="main">,</span><span class="var">?b</span><span class="main">]</span>"</span><span class="antiquote">}</span></span></span></span></span></span></span></span></span></span></span></span></span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_compr</span> <span class="entity">s</span> <span class="entity">P</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mk_term</span> <span class="quoted">"<span class="main">{</span> <span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="var">?s</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">x</span><span class="main">}</span>"</span><span class="antiquote">}</span></span></span></span></span></span></span></span></span></span></span></span></span></span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">test1</span> <span class="main">=</span> <span class="entity">mk_2elem_list</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">1</span><span class="main">::</span>nat"</span><span class="antiquote">}</span></span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="numeral">2</span><span class="main">::</span>nat"</span><span class="antiquote">}</span></span> |&gt; Thm.cterm_of <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">test2</span> <span class="main">=</span> <span class="entity">mk_compr</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">::</span>nat<span class="main">}</span>"</span><span class="antiquote">}</span></span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">(&lt;)</span> <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span>"</span><span class="antiquote">}</span></span> |&gt; Thm.cterm_of <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">test3</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> 
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">x</span> <span class="main">=</span> Bound <span class="inner_numeral">0</span> 
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">env</span> <span class="main">=</span> <span class="main">[</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">nat</span><span class="antiquote">}</span></span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">in</span></span> 
    <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mk_term</span> env<span class="main">:</span> <span class="quoted">"<span class="var">?x</span><span class="main">+</span><span class="var">?x</span>"</span><span class="antiquote">}</span></span></span></span></span></span></span></span></span></span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="comment1">(*
  val test4 = let 
    val x = Bound 0 
    val T = @{typ nat}
  in 
    ctd here: Handle bounds below lambdas!
    @{mk_term "λx::?'v_T. ?x"}
  end
  *)</span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Refine_Util">
<div class="head">
<h1>Theory Refine_Util</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"General Utilities"</span></span>
<span class="keyword1"><span class="command">theory</span></span> Refine_Util
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Refine_Util_Bootstrap1.html">Refine_Util_Bootstrap1</a> <a href="Mpat_Antiquot.html">Mpat_Antiquot</a> <a href="Mk_Term_Antiquot.html">Mk_Term_Antiquot</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">conv_tag</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">conv_tag</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">==</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> 
  <span class="comment1">― ‹Used internally for <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"pat_conv"</span><span class="antiquote">}</span></span>-conversion›</span>

<span class="keyword1" id="Refine_Util-shift_lambda_left"><span class="command">lemma</span></span> shift_lambda_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≡</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">0</span> THEN_ELSE' THEN_ELSE_COMB'
  <span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">1</span> THEN_ALL_NEW_FWD THEN_INTERVAL
  <span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">2</span> ORELSE_INTERVAL
  <span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">3</span> -&gt;&gt;

  <span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">BASIC_REFINE_UTIL</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
    <span class="keyword1"><span class="keyword">include</span></span> <span class="entity">BASIC_REFINE_UTIL</span>
    <span class="comment1">(* Resolution with matching *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> RSm<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm

    <span class="keyword1"><span class="keyword">val</span></span> is_Abs<span class="main">:</span> term <span class="main">-&gt;</span> bool
    <span class="keyword1"><span class="keyword">val</span></span> is_Comb<span class="main">:</span> term <span class="main">-&gt;</span> bool
    <span class="keyword1"><span class="keyword">val</span></span> has_Var<span class="main">:</span> term <span class="main">-&gt;</span> bool

    <span class="keyword1"><span class="keyword">val</span></span> is_TFree<span class="main">:</span> typ <span class="main">-&gt;</span> bool

    <span class="keyword1"><span class="keyword">val</span></span> is_def_thm<span class="main">:</span> thm <span class="main">-&gt;</span> bool

    <span class="comment1">(* Tacticals *)</span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">tactic'</span> <span class="main">=</span> int <span class="main">-&gt;</span> tactic
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">itactic</span> <span class="main">=</span> int <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic

    <span class="keyword1"><span class="keyword">val</span></span> IF_EXGOAL<span class="main">:</span> <span class="main">(</span>int <span class="main">-&gt;</span> tactic<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> COND'<span class="main">:</span> <span class="main">(</span>term <span class="main">-&gt;</span> bool<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> CONCL_COND'<span class="main">:</span> <span class="main">(</span>term <span class="main">-&gt;</span> bool<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    
    <span class="keyword1"><span class="keyword">val</span></span> THEN_ELSE'<span class="main">:</span> <span class="entity">tactic'</span> * <span class="main">(</span><span class="entity">tactic'</span> * <span class="entity">tactic'</span><span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> THEN_ELSE_COMB'<span class="main">:</span> 
      <span class="entity">tactic'</span> * <span class="main">(</span><span class="main">(</span><span class="entity">tactic'</span>*<span class="entity">tactic'</span><span class="main">-&gt;</span><span class="entity">tactic'</span><span class="main">)</span> * <span class="entity">tactic'</span> * <span class="entity">tactic'</span><span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>

    <span class="keyword1"><span class="keyword">val</span></span> INTERVAL_FWD<span class="main">:</span> <span class="entity">tactic'</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
    <span class="keyword1"><span class="keyword">val</span></span> THEN_ALL_NEW_FWD<span class="main">:</span> <span class="entity">tactic'</span> * <span class="entity">tactic'</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> REPEAT_ALL_NEW_FWD<span class="main">:</span> <span class="entity">tactic'</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> REPEAT_DETERM'<span class="main">:</span> <span class="entity">tactic'</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> REPEAT'<span class="main">:</span> <span class="entity">tactic'</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> ALL_GOALS_FWD'<span class="main">:</span> <span class="entity">tactic'</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> ALL_GOALS_FWD<span class="main">:</span> <span class="entity">tactic'</span> <span class="main">-&gt;</span> tactic

    <span class="keyword1"><span class="keyword">val</span></span> APPEND_LIST'<span class="main">:</span> <span class="entity">tactic'</span> list <span class="main">-&gt;</span> <span class="entity">tactic'</span>

    <span class="keyword1"><span class="keyword">val</span></span> SINGLE_INTERVAL<span class="main">:</span> <span class="entity">itactic</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> THEN_INTERVAL<span class="main">:</span> <span class="entity">itactic</span> * <span class="entity">itactic</span> <span class="main">-&gt;</span> <span class="entity">itactic</span>
    <span class="keyword1"><span class="keyword">val</span></span> ORELSE_INTERVAL<span class="main">:</span> <span class="entity">itactic</span> * <span class="entity">itactic</span> <span class="main">-&gt;</span> <span class="entity">itactic</span>

    <span class="keyword1"><span class="keyword">val</span></span> CAN'<span class="main">:</span> <span class="entity">tactic'</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>

    <span class="keyword1"><span class="keyword">val</span></span> NTIMES'<span class="main">:</span> <span class="entity">tactic'</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> <span class="entity">tactic'</span>

    <span class="comment1">(* Only consider results that solve subgoal. If none, return all results unchanged. *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> TRY_SOLVED'<span class="main">:</span> <span class="entity">tactic'</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>

    <span class="comment1">(* Case distinction with tactics. Generalization of THEN_ELSE to lists. *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> CASES'<span class="main">:</span> <span class="main">(</span><span class="entity">tactic'</span> * tactic<span class="main">)</span> list <span class="main">-&gt;</span> <span class="entity">tactic'</span>

    <span class="comment1">(* Tactic that depends on subgoal term structure *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> WITH_subgoal<span class="main">:</span> <span class="main">(</span>term <span class="main">-&gt;</span> <span class="entity">tactic'</span><span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="comment1">(* Tactic that depends on subgoal's conclusion term structure *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> WITH_concl<span class="main">:</span> <span class="main">(</span>term <span class="main">-&gt;</span> <span class="entity">tactic'</span><span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>

    <span class="comment1">(* Tactic version of Variable.trade. Import, apply tactic, and export results.
      One effect is that schematic variables in the goal are fixed, and thus cannot 
      be instantiated by the tactic.
    *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> TRADE<span class="main">:</span> <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span><span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>


    <span class="comment1">(* Tactics *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> fo_rtac<span class="main">:</span> thm <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> fo_resolve_tac<span class="main">:</span> thm list <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> rprems_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> rprem_tac<span class="main">:</span> int <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> elim_all_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm list <span class="main">-&gt;</span> tactic

    <span class="keyword1"><span class="keyword">val</span></span> prefer_tac<span class="main">:</span> int <span class="main">-&gt;</span> tactic

    <span class="keyword1"><span class="keyword">val</span></span> insert_subgoal_tac<span class="main">:</span> cterm <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> insert_subgoals_tac<span class="main">:</span> cterm list <span class="main">-&gt;</span> <span class="entity">tactic'</span>

    <span class="keyword1"><span class="keyword">val</span></span> eqsubst_inst_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> bool <span class="main">-&gt;</span> int list 
      <span class="main">-&gt;</span> <span class="main">(</span><span class="main">(</span>indexname * Position.T<span class="main">)</span> * string<span class="main">)</span> list <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic

    <span class="keyword1"><span class="keyword">val</span></span> eqsubst_inst_meth<span class="main">:</span> <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">Proof.method</span><span class="main">)</span> context_parser

    <span class="comment1">(* Parsing *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> -&gt;&gt; <span class="main">:</span> 'a context_parser *<span class="main">(</span>'a * Context.generic <span class="main">-&gt;</span> 'b * Context.generic<span class="main">)</span>
      <span class="main">-&gt;</span> 'b context_parser

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">REFINE_UTIL</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
    <span class="keyword1"><span class="keyword">include</span></span> <span class="entity">BASIC_REFINE_UTIL</span>

    <span class="keyword1"><span class="keyword">val</span></span> order_by<span class="main">:</span> <span class="main">(</span>'a * 'a <span class="main">-&gt;</span> order<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'b <span class="main">-&gt;</span> 'a<span class="main">)</span> <span class="main">-&gt;</span> 'b list <span class="main">-&gt;</span> 'b list
    <span class="keyword1"><span class="keyword">val</span></span> build_res_net<span class="main">:</span> thm list <span class="main">-&gt;</span> <span class="main">(</span>int * thm<span class="main">)</span> Net.net

    <span class="comment1">(* Terms *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> fo_matchp<span class="main">:</span> theory <span class="main">-&gt;</span> cterm <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term list option
    <span class="keyword1"><span class="keyword">val</span></span> fo_matches<span class="main">:</span> theory <span class="main">-&gt;</span> cterm <span class="main">-&gt;</span> term <span class="main">-&gt;</span> bool

    <span class="keyword1"><span class="keyword">val</span></span> anorm_typ<span class="main">:</span> typ <span class="main">-&gt;</span> typ
    <span class="keyword1"><span class="keyword">val</span></span> anorm_term<span class="main">:</span> term <span class="main">-&gt;</span> term

    <span class="keyword1"><span class="keyword">val</span></span> import_cterms<span class="main">:</span> bool <span class="main">-&gt;</span> cterm list <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> 
      cterm list * <span class="entity">Proof.context</span>

    <span class="keyword1"><span class="keyword">val</span></span> subsume_sort<span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> term<span class="main">)</span> <span class="main">-&gt;</span> theory <span class="main">-&gt;</span> 'a list <span class="main">-&gt;</span> 'a list
    <span class="keyword1"><span class="keyword">val</span></span> subsume_sort_gen<span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> term<span class="main">)</span> <span class="main">-&gt;</span> Context.generic 
      <span class="main">-&gt;</span> 'a list <span class="main">-&gt;</span> 'a list

    <span class="keyword1"><span class="keyword">val</span></span> mk_compN1<span class="main">:</span> typ list <span class="main">-&gt;</span> int <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term
    <span class="keyword1"><span class="keyword">val</span></span> mk_compN<span class="main">:</span> int <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term

    <span class="keyword1"><span class="keyword">val</span></span> dest_itselfT<span class="main">:</span> typ <span class="main">-&gt;</span> typ
    <span class="keyword1"><span class="keyword">val</span></span> dummify_tvars<span class="main">:</span> term <span class="main">-&gt;</span> term

    <span class="comment1">(* a≡λx. f x  ↦  a ?x ≡ f ?x *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> shift_lambda_left<span class="main">:</span> thm <span class="main">-&gt;</span> thm
    <span class="keyword1"><span class="keyword">val</span></span> shift_lambda_leftN<span class="main">:</span> int <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm

    <span class="comment1">(* Left-Bracketed Structures *)</span>

    <span class="comment1">(* Map [] to z, and [x1,...,xN] to f(...f(f(x1,x2),x3)...) *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> list_binop_left<span class="main">:</span> 'a <span class="main">-&gt;</span> <span class="main">(</span>'a * 'a <span class="main">-&gt;</span> 'a<span class="main">)</span> <span class="main">-&gt;</span> 'a list <span class="main">-&gt;</span> 'a
    <span class="comment1">(* Map [] to z, [x] to i x, [x1,...,xN] to f(...f(f(x1,x2),x3)...), thread state *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> fold_binop_left<span class="main">:</span> <span class="main">(</span>'c <span class="main">-&gt;</span> 'b * 'c<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'a <span class="main">-&gt;</span> 'c <span class="main">-&gt;</span> 'b * 'c<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'b * 'b <span class="main">-&gt;</span> 'b<span class="main">)</span> 
          <span class="main">-&gt;</span> 'a list <span class="main">-&gt;</span> 'c <span class="main">-&gt;</span> 'b * 'c

    <span class="comment1">(* Tuples, handling () as empty tuple *)</span>      
    <span class="keyword1"><span class="keyword">val</span></span> strip_prodT_left<span class="main">:</span> typ <span class="main">-&gt;</span> typ list
    <span class="keyword1"><span class="keyword">val</span></span> list_prodT_left<span class="main">:</span> typ list <span class="main">-&gt;</span> typ
    <span class="keyword1"><span class="keyword">val</span></span> mk_ltuple<span class="main">:</span> term list <span class="main">-&gt;</span> term
    <span class="comment1">(* Fix a tuple of new frees *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> fix_left_tuple_from_Ts<span class="main">:</span> string <span class="main">-&gt;</span> typ list <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> term * <span class="entity">Proof.context</span>

    <span class="comment1">(* HO-Patterns with tuples *)</span>
    <span class="comment1">(* Lambda-abstraction over list of terms, recognizing tuples *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> lambda_tuple<span class="main">:</span> term list <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term
    <span class="comment1">(* Instantiate tuple-types in specified variables *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> instantiate_tuples<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="main">(</span>indexname*typ<span class="main">)</span> list <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm
    <span class="comment1">(* Instantiate tuple-types in variables from given term *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> instantiate_tuples_from_term_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> term <span class="main">-&gt;</span> tactic
    <span class="comment1">(* Instantiate tuple types in variables of subgoal *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> instantiate_tuples_subgoal_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>




    <span class="comment1">(* Rules *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> abs_def<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm

    <span class="comment1">(* Rule combinators *)</span>
    
    <span class="comment1">(* Iterate rule on theorem until it fails *)</span>  
    <span class="keyword1"><span class="keyword">val</span></span> repeat_rule<span class="main">:</span> <span class="main">(</span>thm <span class="main">-&gt;</span> thm<span class="main">)</span> <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm
    <span class="comment1">(* Apply rule on theorem and assert that theorem was changed *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> changed_rule<span class="main">:</span> <span class="main">(</span>thm <span class="main">-&gt;</span> thm<span class="main">)</span> <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm
    <span class="comment1">(* Try rule on theorem, return theorem unchanged if rule fails *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> try_rule<span class="main">:</span> <span class="main">(</span>thm <span class="main">-&gt;</span> thm<span class="main">)</span> <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm
    <span class="comment1">(* Singleton version of Variable.trade *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> trade_rule<span class="main">:</span> <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm
    <span class="comment1">(* Combine with first matching theorem *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> RS_fst<span class="main">:</span> thm <span class="main">-&gt;</span> thm list <span class="main">-&gt;</span> thm
    <span class="comment1">(* Instantiate first matching theorem *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> OF_fst<span class="main">:</span> thm list <span class="main">-&gt;</span> thm list <span class="main">-&gt;</span> thm


    <span class="comment1">(* Conversion *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> trace_conv<span class="main">:</span> conv
    <span class="keyword1"><span class="keyword">val</span></span> monitor_conv<span class="main">:</span> string <span class="main">-&gt;</span> conv <span class="main">-&gt;</span> conv
    <span class="keyword1"><span class="keyword">val</span></span> monitor_conv'<span class="main">:</span> string <span class="main">-&gt;</span> <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv

    <span class="keyword1"><span class="keyword">val</span></span> fixup_vars<span class="main">:</span> cterm <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm
    <span class="keyword1"><span class="keyword">val</span></span> fixup_vars_conv<span class="main">:</span> conv <span class="main">-&gt;</span> conv
    <span class="keyword1"><span class="keyword">val</span></span> fixup_vars_conv'<span class="main">:</span> <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv

    <span class="keyword1"><span class="keyword">val</span></span> pat_conv'<span class="main">:</span> cterm <span class="main">-&gt;</span> <span class="main">(</span>string <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span>
      <span class="main">-&gt;</span> conv
    <span class="keyword1"><span class="keyword">val</span></span> pat_conv<span class="main">:</span> cterm <span class="main">-&gt;</span> <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv

    <span class="keyword1"><span class="keyword">val</span></span> HOL_concl_conv<span class="main">:</span> <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv

    <span class="keyword1"><span class="keyword">val</span></span> import_conv<span class="main">:</span> <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv

    <span class="keyword1"><span class="keyword">val</span></span> fix_conv<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv <span class="main">-&gt;</span> conv
    <span class="keyword1"><span class="keyword">val</span></span> ite_conv<span class="main">:</span> conv <span class="main">-&gt;</span> conv <span class="main">-&gt;</span> conv <span class="main">-&gt;</span> conv

    <span class="keyword1"><span class="keyword">val</span></span> cfg_trace_f_tac_conv<span class="main">:</span> bool Config.T
    <span class="keyword1"><span class="keyword">val</span></span> f_tac_conv<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="main">(</span>term <span class="main">-&gt;</span> term<span class="main">)</span> <span class="main">-&gt;</span> tactic <span class="main">-&gt;</span> conv

    <span class="comment1">(* Conversion combinators to choose first matching position *)</span>
    <span class="comment1">(* Try argument, then function *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> fcomb_conv<span class="main">:</span> conv <span class="main">-&gt;</span> conv
    <span class="comment1">(* Descend over function or abstraction *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> fsub_conv<span class="main">:</span> <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv 
    <span class="comment1">(* Apply to topmost matching position *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> ftop_conv<span class="main">:</span> <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv


    <span class="comment1">(* Parsing *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> parse_bool_config<span class="main">:</span> string <span class="main">-&gt;</span> bool Config.T <span class="main">-&gt;</span> bool context_parser
    <span class="keyword1"><span class="keyword">val</span></span> parse_paren_list<span class="main">:</span> 'a context_parser <span class="main">-&gt;</span> 'a list context_parser
    <span class="keyword1"><span class="keyword">val</span></span> parse_paren_lists<span class="main">:</span> 'a context_parser <span class="main">-&gt;</span> 'a list list context_parser

    <span class="comment1">(* 2-step configuration parser *)</span>
    <span class="comment1">(* Parse boolean config, name or no_name. *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> parse_bool_config'<span class="main">:</span> string <span class="main">-&gt;</span> bool Config.T <span class="main">-&gt;</span> Token.T list <span class="main">-&gt;</span> <span class="main">(</span>bool Config.T * bool<span class="main">)</span> * Token.T list
    <span class="comment1">(* Parse optional (p1,...,pn). Empty list if nothing parsed. *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> parse_paren_list'<span class="main">:</span> 'a parser <span class="main">-&gt;</span> Token.T list <span class="main">-&gt;</span> 'a list * Token.T list
    <span class="comment1">(* Apply list of (config,value) pairs *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> apply_configs<span class="main">:</span> <span class="main">(</span>'a Config.T * 'a<span class="main">)</span> list <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span>


  <span class="keyword2"><span class="keyword">end</span></span>


  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Refine_Util</span><span class="main">:</span> <span class="entity">REFINE_UTIL</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword3"><span class="keyword">open</span></span> Basic_Refine_Util

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">RSm</span> <span class="entity">ctxt</span> <span class="entity">thA</span> <span class="entity">thB</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">thA</span><span class="main">,</span> <span class="entity">ctxt'</span><span class="main">)</span> <span class="main">=</span> <span class="entity">ctxt</span>
        |&gt; Variable.declare_thm <span class="entity">thA</span>
        |&gt; Variable.declare_thm <span class="entity">thB</span>
        |&gt; yield_singleton <span class="main">(</span>apfst snd oo Variable.import true<span class="main">)</span> <span class="entity">thA</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">thA</span> RS <span class="entity">thB</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> singleton <span class="main">(</span>Variable.export <span class="entity">ctxt'</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">thm</span>
        |&gt; Drule.zero_var_indexes
    <span class="keyword2"><span class="keyword">in</span></span> 
      <span class="entity">thm</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_Abs</span> <span class="main">(</span>Abs <span class="main">_</span><span class="main">)</span> <span class="main">=</span> true <span class="main">|</span> <span class="entity">is_Abs</span> <span class="main">_</span> <span class="main">=</span> false
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_Comb</span> <span class="main">(</span><span class="main">_</span>$<span class="main">_</span><span class="main">)</span> <span class="main">=</span> true <span class="main">|</span> <span class="entity">is_Comb</span> <span class="main">_</span> <span class="main">=</span> false

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">has_Var</span> <span class="main">(</span>Var <span class="main">_</span><span class="main">)</span> <span class="main">=</span> true
      <span class="main">|</span> <span class="entity">has_Var</span> <span class="main">(</span>Abs <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">has_Var</span> <span class="entity">t</span>
      <span class="main">|</span> <span class="entity">has_Var</span> <span class="main">(</span><span class="entity">t1</span>$<span class="entity">t2</span><span class="main">)</span> <span class="main">=</span> <span class="entity">has_Var</span> <span class="entity">t1</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">has_Var</span> <span class="entity">t2</span>
      <span class="main">|</span> <span class="entity">has_Var</span> <span class="main">_</span> <span class="main">=</span> false

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_TFree</span> <span class="main">(</span>TFree <span class="main">_</span><span class="main">)</span> <span class="main">=</span> true
      <span class="main">|</span> <span class="entity">is_TFree</span> <span class="main">_</span> <span class="main">=</span> false

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_def_thm</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">thm</span> |&gt; Thm.prop_of <span class="keyword2"><span class="keyword">of</span></span>
      Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "Pure.eq"<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="main">_</span>$<span class="main">_</span> <span class="main">=&gt;</span> true <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false


    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">tactic'</span> <span class="main">=</span> int <span class="main">-&gt;</span> tactic
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">itactic</span> <span class="main">=</span> int <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic

    <span class="comment1">(* Fail if subgoal does not exist *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">IF_EXGOAL</span> <span class="entity">tac</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &lt;= Thm.nprems_of <span class="entity">st</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">tac</span> <span class="entity">i</span> <span class="entity">st</span>
    <span class="keyword2"><span class="keyword">else</span></span> no_tac <span class="entity">st</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">COND'</span> <span class="entity">P</span> <span class="main">=</span> <span class="entity">IF_EXGOAL</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st</span> <span class="main">=&gt;</span> 
      <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">P</span> <span class="main">(</span>Thm.prop_of <span class="entity">st</span> |&gt; curry Logic.nth_prem <span class="entity">i</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
      all_tac <span class="entity">st</span> <span class="keyword2"><span class="keyword">else</span></span> no_tac <span class="entity">st</span><span class="main">)</span> 
      <span class="keyword3"><span class="keyword">handle</span></span> TERM <span class="main">_</span> <span class="main">=&gt;</span> no_tac <span class="entity">st</span>
      <span class="main">|</span> Pattern.MATCH <span class="main">=&gt;</span> no_tac <span class="entity">st</span>
    <span class="main">)</span>

    <span class="comment1">(* FIXME: Subtle difference between Logic.concl_of_goal and this:
         concl_of_goal converts loose bounds to frees!
    *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">CONCL_COND'</span> <span class="entity">P</span> <span class="main">=</span> <span class="entity">COND'</span> <span class="main">(</span>strip_all_body #&gt; Logic.strip_imp_concl #&gt; <span class="entity">P</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="main">(</span><span class="entity">tac1</span> <span class="entity">THEN_ELSE'</span> <span class="main">(</span><span class="entity">tac2</span><span class="main">,</span><span class="entity">tac3</span><span class="main">)</span><span class="main">)</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">tac1</span> <span class="entity">x</span> THEN_ELSE <span class="main">(</span><span class="entity">tac2</span> <span class="entity">x</span><span class="main">,</span><span class="entity">tac3</span> <span class="entity">x</span><span class="main">)</span><span class="main">;</span>  

    <span class="comment1">(* If first tactic succeeds, combine its effect with "comb tac2", 
      otherwise use tac_else. Example: 
        tac1 THEN_ELSE_COMB ((THEN_ALL_NEW),tac2,tac_else)  *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="main">(</span><span class="entity">tac1</span> <span class="entity">THEN_ELSE_COMB'</span> <span class="main">(</span><span class="entity">comb</span><span class="main">,</span><span class="entity">tac2</span><span class="main">,</span><span class="entity">tac_else</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rseq</span> <span class="main">=</span> <span class="entity">tac1</span> <span class="entity">i</span> <span class="entity">st</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">seq_is_empty</span> <span class="entity">rseq</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="main">(</span>true<span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">tac_else</span> <span class="entity">i</span> <span class="entity">st</span>
      <span class="main">|</span> <span class="main">(</span>false<span class="main">,</span><span class="entity">rseq</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">comb</span> <span class="main">(</span>K<span class="main">(</span>K<span class="main">(</span> <span class="entity">rseq</span> <span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">tac2</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>

    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="comment1">(* Apply tactic to subgoals in interval, in a forward manner, skipping over
      emerging subgoals *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">INTERVAL_FWD</span> <span class="entity">tac</span> <span class="entity">l</span> <span class="entity">u</span> <span class="entity">st</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">l</span>&gt;<span class="entity">u</span> <span class="keyword2"><span class="keyword">then</span></span> all_tac <span class="entity">st</span> 
      <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="entity">tac</span> <span class="entity">l</span> THEN <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st'</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ofs</span> <span class="main">=</span> Thm.nprems_of <span class="entity">st'</span> - Thm.nprems_of <span class="entity">st</span><span class="main">;</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">ofs</span> &lt; <span class="inner_numeral">~1</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="keyword3"><span class="keyword">raise</span></span> THM <span class="main">(</span>
            <span class="inner_quoted">"INTERVAL_FWD: Tac solved more than one goal"</span><span class="main">,</span><span class="inner_numeral">~1</span><span class="main">,</span><span class="main">[</span><span class="entity">st</span><span class="main">,</span><span class="entity">st'</span><span class="main">]</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">INTERVAL_FWD</span> <span class="entity">tac</span> <span class="main">(</span><span class="entity">l</span>+<span class="inner_numeral">1</span>+<span class="entity">ofs</span><span class="main">)</span> <span class="main">(</span><span class="entity">u</span>+<span class="entity">ofs</span><span class="main">)</span> <span class="entity">st'</span>
        <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">)</span> <span class="entity">st</span><span class="main">;</span>

    <span class="comment1">(* Apply tac2 to all subgoals emerged from tac1, in forward manner. *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="main">(</span><span class="entity">tac1</span> <span class="entity">THEN_ALL_NEW_FWD</span> <span class="entity">tac2</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span>
      <span class="main">(</span><span class="entity">tac1</span> <span class="entity">i</span> 
        THEN <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st'</span> <span class="main">=&gt;</span> <span class="entity">INTERVAL_FWD</span> <span class="entity">tac2</span> <span class="entity">i</span> <span class="main">(</span><span class="entity">i</span> + Thm.nprems_of <span class="entity">st'</span> - Thm.nprems_of <span class="entity">st</span><span class="main">)</span> <span class="entity">st'</span><span class="main">)</span>
      <span class="main">)</span> <span class="entity">st</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">REPEAT_ALL_NEW_FWD</span> <span class="entity">tac</span> <span class="main">=</span>
      <span class="entity">tac</span> <span class="entity">THEN_ALL_NEW_FWD</span> <span class="main">(</span>TRY o <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="entity">REPEAT_ALL_NEW_FWD</span> <span class="entity">tac</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

    <span class="comment1">(* Repeat tac on subgoal. Determinize each step. 
       Stop if tac fails or subgoal is solved. *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">REPEAT_DETERM'</span> <span class="entity">tac</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> Thm.nprems_of <span class="entity">st</span> 
    <span class="keyword2"><span class="keyword">in</span></span>
      REPEAT_DETERM <span class="main">(</span>COND <span class="main">(</span>has_fewer_prems <span class="entity">n</span><span class="main">)</span> no_tac <span class="main">(</span><span class="entity">tac</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="entity">st</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">REPEAT'</span> <span class="entity">tac</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> Thm.nprems_of <span class="entity">st</span> 
    <span class="keyword2"><span class="keyword">in</span></span>
      REPEAT <span class="main">(</span>COND <span class="main">(</span>has_fewer_prems <span class="entity">n</span><span class="main">)</span> no_tac <span class="main">(</span><span class="entity">tac</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="entity">st</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="comment1">(* Apply tactic to all goals in a forward manner.
      Newly generated goals are ignored.
    *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ALL_GOALS_FWD'</span> <span class="entity">tac</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span>
      <span class="main">(</span><span class="entity">tac</span> <span class="entity">i</span> THEN <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st'</span> <span class="main">=&gt;</span> 
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">i'</span> <span class="main">=</span> <span class="entity">i</span> + Thm.nprems_of <span class="entity">st'</span> + <span class="inner_numeral">1</span> - Thm.nprems_of <span class="entity">st</span><span class="main">;</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i'</span> &lt;= Thm.nprems_of <span class="entity">st'</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="entity">ALL_GOALS_FWD'</span> <span class="entity">tac</span> <span class="entity">i'</span> <span class="entity">st'</span>
          <span class="keyword2"><span class="keyword">else</span></span>
            all_tac <span class="entity">st'</span>
        <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">)</span><span class="main">)</span> <span class="entity">st</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ALL_GOALS_FWD</span> <span class="entity">tac</span> <span class="main">=</span> <span class="entity">ALL_GOALS_FWD'</span> <span class="entity">tac</span> <span class="inner_numeral">1</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">APPEND_LIST'</span> <span class="entity">tacs</span> <span class="main">=</span> fold_rev <span class="main">(</span>curry <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> APPEND'<span class="main">)</span><span class="main">)</span> <span class="entity">tacs</span> <span class="main">(</span>K no_tac<span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">SINGLE_INTERVAL</span> <span class="entity">tac</span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">tac</span> <span class="entity">i</span> <span class="entity">i</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">tac1</span><span class="main">:</span><span class="entity">itactic</span><span class="main">)</span> <span class="entity">THEN_INTERVAL</span> <span class="main">(</span><span class="entity">tac2</span><span class="main">:</span><span class="entity">itactic</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">j</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st</span> <span class="main">=&gt;</span>
        <span class="main">(</span> <span class="entity">tac1</span> <span class="entity">i</span> <span class="entity">j</span>
          THEN <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st'</span> <span class="main">=&gt;</span> <span class="entity">tac2</span> <span class="entity">i</span> <span class="main">(</span><span class="entity">j</span> + Thm.nprems_of <span class="entity">st'</span> - Thm.nprems_of <span class="entity">st</span><span class="main">)</span> <span class="entity">st'</span><span class="main">)</span>
        <span class="main">)</span> <span class="entity">st</span>
      <span class="main">)</span><span class="main">:</span><span class="entity">itactic</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tac1</span> <span class="entity">ORELSE_INTERVAL</span> <span class="entity">tac2</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">j</span> <span class="main">=&gt;</span> <span class="entity">tac1</span> <span class="entity">i</span> <span class="entity">j</span> ORELSE <span class="entity">tac2</span> <span class="entity">i</span> <span class="entity">j</span><span class="main">)</span>

    <span class="comment1">(* Fail if tac fails, otherwise do nothing *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">CAN'</span> <span class="entity">tac</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">tac</span> <span class="entity">i</span> <span class="entity">st</span> |&gt; Seq.pull <span class="keyword2"><span class="keyword">of</span></span>
        NONE <span class="main">=&gt;</span> Seq.empty
      <span class="main">|</span> SOME <span class="main">_</span> <span class="main">=&gt;</span> Seq.single <span class="entity">st</span>

    <span class="comment1">(* Repeat tactic n times *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">NTIMES'</span> <span class="main">_</span> <span class="inner_numeral">0</span> <span class="main">_</span> <span class="entity">st</span> <span class="main">=</span> Seq.single <span class="entity">st</span>
      <span class="main">|</span> <span class="entity">NTIMES'</span> <span class="entity">tac</span> <span class="entity">n</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="main">(</span><span class="entity">tac</span> THEN' <span class="entity">NTIMES'</span> <span class="entity">tac</span> <span class="main">(</span><span class="entity">n</span>-<span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>

    <span class="comment1">(* Resolve with rule. Use first-order unification.
      From cookbook, added exception handling *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fo_rtac</span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">Subgoal.FOCUS</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">,</span> <span class="entity">concl</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span> 
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">concl_pat</span> <span class="main">=</span> Drule.strip_imp_concl <span class="main">(</span>Thm.cprop_of <span class="entity">thm</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">insts</span> <span class="main">=</span> Thm.first_order_match <span class="main">(</span><span class="entity">concl_pat</span><span class="main">,</span> <span class="entity">concl</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      resolve_tac <span class="entity">ctxt</span> <span class="main">[</span>Drule.instantiate_normalize <span class="entity">insts</span> <span class="entity">thm</span><span class="main">]</span> <span class="inner_numeral">1</span>
    <span class="keyword2"><span class="keyword">end</span></span> <span class="keyword3"><span class="keyword">handle</span></span> Pattern.MATCH <span class="main">=&gt;</span> no_tac <span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fo_resolve_tac</span> <span class="entity">thms</span> <span class="entity">ctxt</span> <span class="main">=</span> 
      FIRST' <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">fo_rtac</span> <span class="entity">thm</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">thms</span><span class="main">)</span><span class="main">;</span>

    <span class="comment1">(* Resolve with premises. Copied and adjusted from Goal.assume_rule_tac. *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rprems_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> Goal.norm_hhf_tac <span class="entity">ctxt</span> THEN' CSUBGOAL <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">goal</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">non_atomic</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Pure.imp<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="main">_</span><span class="main">)</span> <span class="main">=</span> true
          <span class="main">|</span> <span class="entity">non_atomic</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Pure.all<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span><span class="main">)</span> <span class="main">=</span> true
          <span class="main">|</span> <span class="entity">non_atomic</span> <span class="main">_</span> <span class="main">=</span> false<span class="main">;</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">goal'</span><span class="main">)</span><span class="main">,</span> <span class="entity">ctxt'</span><span class="main">)</span> <span class="main">=</span> Variable.focus_cterm NONE <span class="entity">goal</span> <span class="entity">ctxt</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">goal''</span> <span class="main">=</span> Drule.cterm_rule 
          <span class="main">(</span>singleton <span class="main">(</span>Variable.export <span class="entity">ctxt'</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span> <span class="entity">goal'</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Rs</span> <span class="main">=</span> filter <span class="main">(</span><span class="entity">non_atomic</span> o Thm.term_of<span class="main">)</span> 
          <span class="main">(</span>Drule.strip_imp_prems <span class="entity">goal''</span><span class="main">)</span><span class="main">;</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ethms</span> <span class="main">=</span> <span class="entity">Rs</span> |&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">R</span> <span class="main">=&gt;</span>
          <span class="main">(</span>Simplifier.norm_hhf <span class="entity">ctxt</span> <span class="main">(</span>Thm.trivial <span class="entity">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword2"><span class="keyword">in</span></span> eresolve_tac <span class="entity">ctxt</span> <span class="entity">ethms</span> <span class="entity">i</span> <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">)</span><span class="main">;</span>

    <span class="comment1">(* Resolve with premise. Copied and adjusted from Goal.assume_rule_tac. *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rprem_tac</span> <span class="entity">n</span> <span class="entity">ctxt</span> <span class="main">=</span> Goal.norm_hhf_tac <span class="entity">ctxt</span> THEN' CSUBGOAL <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">goal</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">goal'</span><span class="main">)</span><span class="main">,</span> <span class="entity">ctxt'</span><span class="main">)</span> <span class="main">=</span> Variable.focus_cterm NONE <span class="entity">goal</span> <span class="entity">ctxt</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">goal''</span> <span class="main">=</span> Drule.cterm_rule 
          <span class="main">(</span>singleton <span class="main">(</span>Variable.export <span class="entity">ctxt'</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span> <span class="entity">goal'</span><span class="main">;</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">R</span> <span class="main">=</span> nth <span class="main">(</span>Drule.strip_imp_prems <span class="entity">goal''</span><span class="main">)</span> <span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">1</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rl</span> <span class="main">=</span> Simplifier.norm_hhf <span class="entity">ctxt</span> <span class="main">(</span>Thm.trivial <span class="entity">R</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        eresolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">rl</span><span class="main">]</span> <span class="entity">i</span>
      <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">elim_all_tac</span> <span class="entity">ctxt</span> <span class="entity">thms</span> <span class="main">=</span> ALLGOALS <span class="main">(</span>REPEAT_ALL_NEW <span class="main">(</span>ematch_tac <span class="entity">ctxt</span> <span class="entity">thms</span><span class="main">)</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prefer_tac</span> <span class="entity">i</span> <span class="main">=</span> defer_tac <span class="entity">i</span> THEN PRIMITIVE <span class="main">(</span>Thm.permute_prems <span class="inner_numeral">0</span> <span class="inner_numeral">~1</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">order_by</span> <span class="entity">ord</span> <span class="entity">f</span> <span class="main">=</span> sort <span class="main">(</span><span class="entity">ord</span> o apply2 <span class="entity">f</span><span class="main">)</span>

    <span class="comment1">(* CLONE from tactic.ML *)</span>
    <span class="keyword2"><span class="keyword">local</span></span>
      <span class="comment1">(*insert one tagged rl into the net*)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">insert_krl</span> <span class="main">(</span><span class="entity">krl</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">th</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        Net.insert_term <span class="main">(</span>K false<span class="main">)</span> <span class="main">(</span>Thm.concl_of <span class="entity">th</span><span class="main">,</span> <span class="entity">krl</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="comment1">(*build a net of rules for resolution*)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">build_res_net</span> <span class="entity">rls</span> <span class="main">=</span>
        fold_rev <span class="entity">insert_krl</span> <span class="main">(</span>tag_list <span class="inner_numeral">1</span> <span class="entity">rls</span><span class="main">)</span> Net.empty<span class="main">;</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">insert_subgoals_tac</span> <span class="entity">cts</span> <span class="entity">i</span> <span class="main">=</span> PRIMITIVE <span class="main">(</span>
      Thm.permute_prems <span class="inner_numeral">0</span> <span class="main">(</span><span class="entity">i</span> - <span class="inner_numeral">1</span><span class="main">)</span>
      #&gt; fold_rev Thm.implies_intr <span class="entity">cts</span>
      #&gt; Thm.permute_prems <span class="inner_numeral">0</span> <span class="main">(</span>~<span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span>
    <span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">insert_subgoal_tac</span> <span class="entity">ct</span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">insert_subgoals_tac</span> <span class="main">[</span><span class="entity">ct</span><span class="main">]</span> <span class="entity">i</span>

  <span class="keyword2"><span class="keyword">local</span></span>
    <span class="comment1">(* Substitution with dynamic instantiation of parameters.
       By Lars Noschinski. *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eqsubst_tac'</span> <span class="entity">ctxt</span> <span class="entity">asm</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">asm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">EqSubst.eqsubst_asm_tac</span> <span class="entity">ctxt</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">EqSubst.eqsubst_tac</span> <span class="entity">ctxt</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">subst_method</span> <span class="entity">inst_tac</span> <span class="entity">tac</span> <span class="main">=</span>
      Args.goal_spec --
      Scan.lift <span class="main">(</span>Args.mode <span class="inner_quoted">"asm"</span> -- Scan.optional <span class="main">(</span>Args.parens <span class="main">(</span>Scan.repeat Parse.nat<span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="inner_numeral">0</span><span class="main">]</span><span class="main">)</span> --
      Scan.optional <span class="main">(</span>Scan.lift
        <span class="main">(</span>Parse.and_list1 
          <span class="main">(</span>Parse.position Args.var -- <span class="main">(</span>Args.$$$ <span class="inner_quoted">"="</span> |-- Parse.!!! Args.embedded_inner_syntax<span class="main">)</span><span class="main">)</span> --|
          Args.$$$ <span class="inner_quoted">"in"</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span> --
      <span class="entity">Attrib.thms</span> &gt;&gt;
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">quant</span><span class="main">,</span> <span class="main">(</span><span class="entity">asm</span><span class="main">,</span> <span class="entity">occL</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">insts</span><span class="main">)</span><span class="main">,</span> <span class="entity">thms</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">METHOD</span> 
        <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">facts</span> <span class="main">=&gt;</span>
          <span class="keyword2"><span class="keyword">if</span></span> null <span class="entity">insts</span> <span class="keyword2"><span class="keyword">then</span></span> 
            <span class="entity">quant</span> <span class="main">(</span><span class="entity">Method.insert_tac</span> <span class="entity">ctxt</span> <span class="entity">facts</span> THEN' <span class="entity">tac</span> <span class="entity">ctxt</span> <span class="entity">asm</span> <span class="entity">occL</span> <span class="entity">thms</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">else</span></span>
            <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">thms</span> <span class="keyword2"><span class="keyword">of</span></span>
              <span class="main">[</span><span class="entity">thm</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">quant</span> <span class="main">(</span>
                <span class="entity">Method.insert_tac</span> <span class="entity">ctxt</span> <span class="entity">facts</span> THEN' <span class="entity">inst_tac</span> <span class="entity">ctxt</span> <span class="entity">asm</span> <span class="entity">occL</span> <span class="entity">insts</span> <span class="entity">thm</span><span class="main">)</span>
            <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> error <span class="inner_quoted">"Cannot have instantiations with multiple rules"</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eqsubst_inst_tac</span> <span class="entity">ctxt</span> <span class="entity">asm</span> <span class="entity">occL</span> <span class="entity">insts</span> <span class="entity">thm</span> <span class="main">=</span> 
      <span class="entity">Subgoal.FOCUS</span> <span class="main">(</span>
        <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context<span class="main">=</span><span class="entity">ctxt</span><span class="main">,</span><span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt'</span> <span class="main">=</span> <span class="entity">ctxt</span> |&gt; Proof_Context.set_mode Proof_Context.mode_schematic  <span class="comment1">(* FIXME !? *)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm'</span> <span class="main">=</span> <span class="entity">thm</span> |&gt; <span class="entity">Rule_Insts.read_instantiate</span> <span class="entity">ctxt'</span> <span class="entity">insts</span> <span class="main">[</span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">eqsubst_tac'</span> <span class="entity">ctxt</span> <span class="entity">asm</span> <span class="entity">occL</span> <span class="main">[</span><span class="entity">thm'</span><span class="main">]</span> <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">)</span> <span class="entity">ctxt</span>


    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eqsubst_inst_meth</span> <span class="main">=</span> <span class="entity">subst_method</span> <span class="entity">eqsubst_inst_tac</span> <span class="entity">eqsubst_tac'</span>
  <span class="keyword2"><span class="keyword">end</span></span>

    <span class="comment1">(* Match pattern against term, and return list of values for non-dummy
      variables. A variable is considered dummy if its name starts with 
      an underscore (_)*)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fo_matchp</span> <span class="entity">thy</span> <span class="entity">cpat</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ignore</span> <span class="main">(</span>Var <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> String.isPrefix <span class="inner_quoted">"_"</span> <span class="entity">name</span>
        <span class="main">|</span> <span class="entity">ignore</span> <span class="main">_</span> <span class="main">=</span> true<span class="main">;</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pat</span> <span class="main">=</span> Thm.term_of <span class="entity">cpat</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pvars</span> <span class="main">=</span> fold_aterms <span class="main">(</span>
        <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">l</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> is_Var <span class="entity">t</span> <span class="keyword1"><span class="keyword">andalso</span></span> not <span class="main">(</span><span class="entity">ignore</span> <span class="entity">t</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">t</span>::<span class="entity">l</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">l</span>
      <span class="main">)</span> <span class="entity">pat</span> <span class="main">[</span><span class="main">]</span> |&gt; rev
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">inst</span> <span class="main">=</span> Pattern.first_order_match <span class="entity">thy</span> <span class="main">(</span><span class="entity">pat</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span> 
        <span class="main">(</span>Vartab.empty<span class="main">,</span>Vartab.empty<span class="main">)</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span> SOME <span class="main">(</span>map <span class="main">(</span>Envir.subst_term <span class="entity">inst</span><span class="main">)</span> <span class="entity">pvars</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span> 
    <span class="keyword3"><span class="keyword">handle</span></span> Pattern.MATCH <span class="main">=&gt;</span> NONE<span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fo_matches</span> <span class="main">=</span> is_some ooo <span class="entity">fo_matchp</span>


    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">anorm_typ</span> <span class="entity">ty</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">instT</span> <span class="main">=</span> Term.add_tvarsT <span class="entity">ty</span> <span class="main">[</span><span class="main">]</span>
      |&gt; map_index <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">i</span><span class="main">,</span><span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span>TVar <span class="main">(</span><span class="main">(</span><span class="inner_quoted">"t"</span>^string_of_int <span class="entity">i</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ty</span> <span class="main">=</span> Term.typ_subst_TVars <span class="entity">instT</span> <span class="entity">ty</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">ty</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">anorm_term</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">instT</span> <span class="main">=</span> Term.add_tvars <span class="entity">t</span> <span class="main">[</span><span class="main">]</span>
      |&gt; map_index <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">i</span><span class="main">,</span><span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span>TVar <span class="main">(</span><span class="main">(</span><span class="inner_quoted">"t"</span>^string_of_int <span class="entity">i</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> Term.subst_TVars <span class="entity">instT</span> <span class="entity">t</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">inst</span> <span class="main">=</span> Term.add_vars <span class="entity">t</span> <span class="main">[</span><span class="main">]</span>
      |&gt; map_index <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">i</span><span class="main">,</span><span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span>Var <span class="main">(</span><span class="main">(</span><span class="inner_quoted">"v"</span>^string_of_int <span class="entity">i</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> Term.subst_Vars <span class="entity">inst</span> <span class="entity">t</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">import_cterms</span> <span class="entity">is_open</span> <span class="entity">cts</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ts</span> <span class="main">=</span> map Thm.term_of <span class="entity">cts</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">ts'</span><span class="main">,</span> <span class="entity">ctxt'</span><span class="main">)</span> <span class="main">=</span> Variable.import_terms <span class="entity">is_open</span> <span class="entity">ts</span> <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cts'</span> <span class="main">=</span> map <span class="main">(</span>Thm.cterm_of <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">ts'</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">cts'</span><span class="main">,</span> <span class="entity">ctxt'</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>


    <span class="comment1">(* Order a list of items such that more specific items come
       before less specific ones. The term to be compared is
       extracted by a function that is given as parameter.
    *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">subsume_sort</span> <span class="entity">f</span> <span class="entity">thy</span> <span class="entity">items</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rhss</span> <span class="main">=</span> map <span class="main">(</span>Envir.beta_eta_contract o <span class="entity">f</span><span class="main">)</span> <span class="entity">items</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">freqf</span> <span class="entity">thy</span> <span class="entity">net</span> <span class="entity">rhs</span> <span class="main">=</span> Net.match_term <span class="entity">net</span> <span class="entity">rhs</span> 
        |&gt; filter <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">p</span> <span class="main">=&gt;</span> Pattern.matches <span class="entity">thy</span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">rhs</span><span class="main">)</span><span class="main">)</span>
        |&gt; length

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">net</span> <span class="main">=</span> fold 
        <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">rhs</span> <span class="main">=&gt;</span> Net.insert_term_safe <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="main">(</span><span class="entity">rhs</span><span class="main">,</span><span class="entity">rhs</span><span class="main">)</span><span class="main">)</span> <span class="entity">rhss</span> Net.empty 

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">freqs</span> <span class="main">=</span> map <span class="main">(</span><span class="entity">freqf</span> <span class="entity">thy</span> <span class="entity">net</span><span class="main">)</span> <span class="entity">rhss</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="entity">freqs</span> ~~ <span class="entity">items</span> 
        |&gt; sort <span class="main">(</span>rev_order o int_ord o apply2 fst<span class="main">)</span>
        |&gt; map snd
  
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">res</span> <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">subsume_sort_gen</span> <span class="entity">f</span> <span class="main">=</span> <span class="entity">subsume_sort</span> <span class="entity">f</span> o Context.theory_of

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_comp1</span> <span class="entity">env</span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span> <span class="entity">g</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fT</span> <span class="main">=</span> fastype_of1 <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="entity">f</span><span class="main">)</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">gT</span> <span class="main">=</span> fastype_of1 <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="entity">g</span><span class="main">)</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">compT</span> <span class="main">=</span> <span class="entity">fT</span> --&gt; <span class="entity">gT</span> --&gt; domain_type <span class="entity">gT</span> --&gt; range_type <span class="entity">fT</span><span class="main">;</span>
      <span class="keyword2"><span class="keyword">in</span></span> Const <span class="main">(</span><span class="inner_quoted">"Fun.comp"</span><span class="main">,</span> <span class="entity">compT</span><span class="main">)</span> $ <span class="entity">f</span> $ <span class="entity">g</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_compN1</span> <span class="main">_</span>   <span class="inner_numeral">0</span> <span class="entity">f</span> <span class="entity">g</span> <span class="main">=</span> <span class="entity">f</span>$<span class="entity">g</span>
      <span class="main">|</span> <span class="entity">mk_compN1</span> <span class="entity">env</span> <span class="inner_numeral">1</span> <span class="entity">f</span> <span class="entity">g</span> <span class="main">=</span> <span class="entity">mk_comp1</span> <span class="entity">env</span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span> <span class="entity">g</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">mk_compN1</span> <span class="entity">env</span> <span class="entity">n</span> <span class="entity">f</span> <span class="entity">g</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">T</span> <span class="main">=</span> fastype_of1 <span class="main">(</span><span class="entity">env</span><span class="main">,</span> <span class="entity">g</span><span class="main">)</span> |&gt; domain_type
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">g</span> <span class="main">=</span> incr_boundvars <span class="inner_numeral">1</span> <span class="entity">g</span> $ Bound <span class="inner_numeral">0</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">env</span> <span class="main">=</span> <span class="entity">T</span>::<span class="entity">env</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          Abs <span class="main">(</span><span class="inner_quoted">"x"</span>^string_of_int <span class="entity">n</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">mk_compN1</span> <span class="entity">env</span> <span class="main">(</span><span class="entity">n</span>-<span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">f</span> <span class="entity">g</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mk_compN</span> <span class="main">=</span> <span class="entity">mk_compN1</span> <span class="main">[</span><span class="main">]</span>    

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">abs_def</span> <span class="entity">ctxt</span> <span class="main">=</span> Local_Defs.meta_rewrite_rule <span class="entity">ctxt</span> #&gt; Drule.abs_def

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">trace_conv</span> <span class="entity">ct</span> <span class="main">=</span> <span class="main">(</span>tracing <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">make_string</span><span class="antiquote">}</span></span></span></span> <span class="entity">ct</span><span class="main">)</span><span class="main">;</span> Conv.all_conv <span class="entity">ct</span><span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">monitor_conv</span> <span class="entity">msg</span> <span class="entity">conv</span> <span class="entity">ct</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> tracing <span class="main">(</span><span class="entity">msg</span> ^ <span class="inner_quoted">" (gets): "</span> ^ <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">make_string</span><span class="antiquote">}</span></span></span></span> <span class="entity">ct</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="entity">conv</span> <span class="entity">ct</span> 
        <span class="keyword3"><span class="keyword">handle</span></span> <span class="entity">exc</span> <span class="main">=&gt;</span>
         <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> Exn.is_interrupt <span class="entity">exc</span> <span class="keyword2"><span class="keyword">then</span></span> Exn.reraise <span class="entity">exc</span>
          <span class="keyword2"><span class="keyword">else</span></span> tracing <span class="main">(</span><span class="entity">msg</span> ^ <span class="inner_quoted">" (raises): "</span> ^ <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">make_string</span><span class="antiquote">}</span></span></span></span> <span class="entity">exc</span><span class="main">)</span><span class="main">;</span>
          Exn.reraise <span class="entity">exc</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> tracing <span class="main">(</span><span class="entity">msg</span> ^ <span class="inner_quoted">" (yields): "</span> ^ <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">make_string</span><span class="antiquote">}</span></span></span></span> <span class="entity">res</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">res</span> <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">monitor_conv'</span> <span class="entity">msg</span> <span class="entity">conv</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span> <span class="entity">monitor_conv</span> <span class="entity">msg</span> <span class="main">(</span><span class="entity">conv</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">ct</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fixup_vars</span> <span class="entity">ct</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lhs</span> <span class="main">=</span> Thm.lhs_of <span class="entity">thm</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">inst</span> <span class="main">=</span> Thm.first_order_match <span class="main">(</span><span class="entity">lhs</span><span class="main">,</span><span class="entity">ct</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm'</span> <span class="main">=</span> Thm.instantiate <span class="entity">inst</span> <span class="entity">thm</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">thm'</span> <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fixup_vars_conv</span> <span class="entity">conv</span> <span class="entity">ct</span> <span class="main">=</span> <span class="entity">fixup_vars</span> <span class="entity">ct</span> <span class="main">(</span><span class="entity">conv</span> <span class="entity">ct</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fixup_vars_conv'</span> <span class="entity">conv</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">fixup_vars_conv</span> <span class="main">(</span><span class="entity">conv</span> <span class="entity">ctxt</span><span class="main">)</span>

    <span class="keyword2"><span class="keyword">local</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tag_ct</span> <span class="entity">ctxt</span> <span class="entity">name</span> <span class="entity">ct</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> Thm.term_of <span class="entity">ct</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ty</span> <span class="main">=</span> fastype_of <span class="entity">t</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t'</span> <span class="main">=</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> conv_tag<span class="antiquote">}</span></span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">unit</span><span class="antiquote">}</span></span>--&gt;<span class="entity">ty</span>--&gt;<span class="entity">ty</span><span class="main">)</span>
          $Free <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">unit</span><span class="antiquote">}</span></span><span class="main">)</span>$<span class="entity">t</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ct'</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">t'</span><span class="main">;</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">ct'</span> <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mpat_conv</span> <span class="entity">pat</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">tym</span><span class="main">,</span><span class="entity">tm</span><span class="main">)</span> <span class="main">=</span> Thm.first_order_match <span class="main">(</span><span class="entity">pat</span><span class="main">,</span><span class="entity">ct</span><span class="main">)</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tm'</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">pt</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="entity">ot</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">pt</span><span class="main">,</span> <span class="entity">tag_ct</span> <span class="entity">ctxt</span> <span class="entity">name</span> <span class="entity">ot</span><span class="main">)</span><span class="main">)</span> <span class="entity">tm</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ct'</span> <span class="main">=</span> Thm.instantiate_cterm <span class="main">(</span><span class="entity">tym</span><span class="main">,</span><span class="entity">tm'</span><span class="main">)</span> <span class="entity">pat</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rthm</span> <span class="main">=</span>
          Goal.prove_internal <span class="entity">ctxt</span> <span class="main">[</span><span class="main">]</span>
            <span class="main">(</span>Thm.cterm_of <span class="entity">ctxt</span> <span class="main">(</span>Logic.mk_equals <span class="main">(</span>apply2 Thm.term_of <span class="main">(</span><span class="entity">ct</span><span class="main">,</span> <span class="entity">ct'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>K <span class="main">(</span><span class="entity">simp_tac</span> <span class="main">(</span>put_simpset <span class="entity">HOL_basic_ss</span> <span class="entity">ctxt</span> addsimps <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> conv_tag_def<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span>
        |&gt; Goal.norm_result <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">in</span></span> 
        <span class="entity">fixup_vars</span> <span class="entity">ct</span> <span class="entity">rthm</span> 
      <span class="keyword2"><span class="keyword">end</span></span> <span class="keyword3"><span class="keyword">handle</span></span> Pattern.MATCH 
        <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> <span class="main">(</span>CTERM <span class="main">(</span><span class="inner_quoted">"mpat_conv: No match"</span><span class="main">,</span><span class="main">[</span><span class="entity">pat</span><span class="main">,</span><span class="entity">ct</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tag_conv</span> <span class="entity">cnv</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> Thm.term_of <span class="entity">ct</span> <span class="keyword2"><span class="keyword">of</span></span>
        Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> conv_tag<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$Free<span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="main">_</span> <span class="main">=&gt;</span> <span class="main">(</span>
          <span class="main">(</span>Conv.rewr_conv <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> conv_tag_def<span class="antiquote">}</span></span></span><span class="main">)</span> then_conv <span class="main">(</span><span class="entity">cnv</span> <span class="entity">name</span><span class="main">)</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">ct</span><span class="main">)</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Conv.all_conv <span class="entity">ct</span><span class="main">;</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">all_tag_conv</span> <span class="entity">cnv</span> <span class="main">=</span> Conv.bottom_conv <span class="main">(</span><span class="entity">tag_conv</span> <span class="entity">cnv</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span> 
      <span class="comment1">(* Match against pattern, and apply parameter conversion to matches of
         variables prefixed by hole_prefix.
      *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pat_conv'</span> <span class="entity">cpat</span> <span class="entity">cnv</span> <span class="entity">ctxt</span> <span class="main">=</span> 
        <span class="entity">mpat_conv</span> <span class="entity">cpat</span> <span class="entity">ctxt</span>
        then_conv <span class="main">(</span><span class="entity">all_tag_conv</span> <span class="entity">cnv</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">;</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pat_conv</span> <span class="entity">cpat</span> <span class="entity">conv</span> <span class="main">=</span> <span class="entity">pat_conv'</span> <span class="entity">cpat</span> 
        <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">name</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">name</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="inner_quoted">"HOLE"</span> <span class="main">=&gt;</span> <span class="entity">conv</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> K Conv.all_conv<span class="main">)</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">HOL_concl_conv</span> <span class="entity">cnv</span> <span class="main">=</span> Conv.params_conv <span class="inner_numeral">~1</span> 
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> Conv.concl_conv <span class="inner_numeral">~1</span> <span class="main">(</span>
        <span class="entity">HOLogic.Trueprop_conv</span> <span class="main">(</span><span class="entity">cnv</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>


    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">import_conv</span> <span class="entity">conv</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">ct'</span><span class="main">,</span><span class="entity">ctxt'</span><span class="main">)</span> <span class="main">=</span> yield_singleton <span class="main">(</span><span class="entity">import_cterms</span> true<span class="main">)</span> <span class="entity">ct</span> <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="entity">conv</span> <span class="entity">ctxt'</span> <span class="entity">ct'</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res'</span> <span class="main">=</span> singleton <span class="main">(</span>Variable.export <span class="entity">ctxt'</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">res</span> |&gt; <span class="entity">fixup_vars</span> <span class="entity">ct</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">res'</span> <span class="keyword2"><span class="keyword">end</span></span>


    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fix_conv</span> <span class="entity">ctxt</span> <span class="entity">conv</span> <span class="entity">ct</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">conv</span> <span class="entity">ct</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eq</span> <span class="main">=</span> Logic.mk_equals <span class="main">(</span>Thm.term_of <span class="entity">ct</span><span class="main">,</span> Thm.term_of <span class="entity">ct</span><span class="main">)</span> |&gt; head_of
    <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span>Thm.term_of <span class="main">(</span>Thm.lhs_of <span class="entity">thm</span><span class="main">)</span> aconv Thm.term_of <span class="entity">ct</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">thm</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">thm</span> RS Thm.trivial <span class="main">(</span>Thm.mk_binop <span class="main">(</span>Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">eq</span><span class="main">)</span> <span class="entity">ct</span> <span class="main">(</span>Thm.rhs_of <span class="entity">thm</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ite_conv</span> <span class="entity">cv</span> <span class="entity">cv1</span> <span class="entity">cv2</span> <span class="entity">ct</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span> 
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eq1</span> <span class="main">=</span> SOME <span class="main">(</span><span class="entity">cv</span> <span class="entity">ct</span><span class="main">)</span> 
          <span class="keyword3"><span class="keyword">handle</span></span> THM <span class="main">_</span> <span class="main">=&gt;</span> NONE
            <span class="main">|</span> CTERM <span class="main">_</span> <span class="main">=&gt;</span> NONE
            <span class="main">|</span> TERM <span class="main">_</span> <span class="main">=&gt;</span> NONE
            <span class="main">|</span> TYPE <span class="main">_</span> <span class="main">=&gt;</span> NONE<span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">eq1</span> <span class="keyword2"><span class="keyword">of</span></span>
          NONE <span class="main">=&gt;</span> <span class="entity">cv2</span> <span class="entity">ct</span>
        <span class="main">|</span> SOME <span class="entity">eq1</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eq2</span> <span class="main">=</span> <span class="entity">cv1</span> <span class="main">(</span>Thm.rhs_of <span class="entity">eq1</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span> 
            <span class="keyword2"><span class="keyword">if</span></span> Thm.is_reflexive <span class="entity">eq1</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">eq2</span>
            <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> Thm.is_reflexive <span class="entity">eq2</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">eq1</span>
            <span class="keyword2"><span class="keyword">else</span></span> Thm.transitive <span class="entity">eq1</span> <span class="entity">eq2</span>
          <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">res</span> <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cfg_trace_f_tac_conv</span> <span class="main">=</span> 
        <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> trace_f_tac_conv<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span>

      <span class="comment1">(* Transform term and prove equality to original by tactic *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">f_tac_conv</span> <span class="entity">ctxt</span> <span class="entity">f</span> <span class="entity">tac</span> <span class="entity">ct</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> Thm.term_of <span class="entity">ct</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t'</span> <span class="main">=</span> <span class="entity">f</span> <span class="entity">t</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">goal</span> <span class="main">=</span> Logic.mk_equals <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="entity">t'</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> Config.get <span class="entity">ctxt</span> <span class="entity">cfg_trace_f_tac_conv</span> <span class="keyword2"><span class="keyword">then</span></span>
          tracing <span class="main">(</span>Syntax.string_of_term <span class="entity">ctxt</span> <span class="entity">goal</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">goal</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">goal</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> Goal.prove_internal <span class="entity">ctxt</span> <span class="main">[</span><span class="main">]</span> <span class="entity">goal</span> <span class="main">(</span>K <span class="entity">tac</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">thm</span>
      <span class="keyword2"><span class="keyword">end</span></span>

    <span class="comment1">(* Apply function to result and context *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="main">(</span><span class="entity">p</span><span class="entity">-&gt;&gt;</span><span class="entity">f</span><span class="main">)</span> <span class="entity">ctks</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">res</span><span class="main">,</span><span class="main">(</span><span class="entity">context</span><span class="main">,</span><span class="entity">tks</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">p</span> <span class="entity">ctks</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">res</span><span class="main">,</span><span class="entity">context</span><span class="main">)</span> <span class="main">=</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">res</span><span class="main">,</span> <span class="entity">context</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="main">(</span><span class="entity">res</span><span class="main">,</span><span class="main">(</span><span class="entity">context</span><span class="main">,</span><span class="entity">tks</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_bool_config</span> <span class="entity">name</span> <span class="entity">cfg</span> <span class="main">=</span> <span class="main">(</span>
      Scan.lift <span class="main">(</span>Args.$$$ <span class="entity">name</span><span class="main">)</span>
        <span class="entity">-&gt;&gt;</span> <span class="main">(</span>apsnd <span class="main">(</span>Config.put_generic <span class="entity">cfg</span> true<span class="main">)</span> #&gt;&gt; K true<span class="main">)</span>
      || 
      Scan.lift <span class="main">(</span>Args.$$$ <span class="main">(</span><span class="inner_quoted">"no_"</span>^<span class="entity">name</span><span class="main">)</span><span class="main">)</span>
        <span class="entity">-&gt;&gt;</span> <span class="main">(</span>apsnd <span class="main">(</span>Config.put_generic <span class="entity">cfg</span> false<span class="main">)</span> #&gt;&gt; K false<span class="main">)</span>
      <span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_paren_list</span> <span class="entity">p</span> <span class="main">=</span> 
      Scan.lift <span class="main">(</span>
        Args.$$$ <span class="inner_quoted">"("</span><span class="main">)</span> |-- Parse.enum1' <span class="inner_quoted">","</span> <span class="entity">p</span> --| Scan.lift <span class="main">(</span>Args.$$$ <span class="inner_quoted">")"</span>
      <span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_paren_lists</span> <span class="entity">p</span> <span class="main">=</span> Scan.repeat <span class="main">(</span><span class="entity">parse_paren_list</span> <span class="entity">p</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> Theory.setup
      <span class="main">(</span><span class="entity">Method.setup</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> fo_rule<span class="antiquote">}</span></span></span> 
        <span class="main">(</span><span class="entity">Attrib.thms</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thms</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span>
          <span class="entity">fo_resolve_tac</span> <span class="entity">thms</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
        <span class="inner_quoted">"resolve using first-order matching"</span>
     #&gt;
      <span class="entity">Method.setup</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> rprems<span class="antiquote">}</span></span></span> 
        <span class="main">(</span>Scan.lift <span class="main">(</span>Scan.option Parse.nat<span class="main">)</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> 
          <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span>
            <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">i</span> <span class="keyword2"><span class="keyword">of</span></span>
              NONE <span class="main">=&gt;</span> <span class="entity">rprems_tac</span> <span class="entity">ctxt</span>
            <span class="main">|</span> SOME <span class="entity">i</span> <span class="main">=&gt;</span> <span class="entity">rprem_tac</span> <span class="entity">i</span> <span class="entity">ctxt</span>
          <span class="main">)</span><span class="main">)</span>
        <span class="main">)</span>
        <span class="inner_quoted">"resolve with premises"</span>
      #&gt; <span class="entity">Method.setup</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> elim_all<span class="antiquote">}</span></span></span>
         <span class="main">(</span><span class="entity">Attrib.thms</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thms</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD</span> <span class="main">(</span><span class="entity">elim_all_tac</span> <span class="entity">ctxt</span> <span class="entity">thms</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
         <span class="inner_quoted">"repeteadly apply elimination rules to all subgoals"</span>
      #&gt; <span class="entity">Method.setup</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> subst_tac<span class="antiquote">}</span></span></span> <span class="entity">eqsubst_inst_meth</span>
         <span class="inner_quoted">"single-step substitution (dynamic instantiation)"</span>
      #&gt; <span class="entity">Method.setup</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> clarsimp_all<span class="antiquote">}</span></span></span> <span class="main">(</span>
           <span class="entity">Method.sections</span> <span class="entity">Clasimp.clasimp_modifiers</span> &gt;&gt; K <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD</span> <span class="main">(</span>
             CHANGED_PROP <span class="main">(</span>ALLGOALS <span class="main">(</span><span class="entity">Clasimp.clarsimp_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
         <span class="main">)</span> <span class="inner_quoted">"simplify and clarify all subgoals"</span><span class="main">)</span>



    


      <span class="comment1">(* Filter alternatives that solve a subgoal. 
        If no alternative solves goal, return result sequence unchanged *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">TRY_SOLVED'</span> <span class="entity">tac</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="entity">tac</span> <span class="entity">i</span> <span class="entity">st</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">solved</span> <span class="main">=</span> Seq.filter <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st'</span> <span class="main">=&gt;</span> Thm.nprems_of <span class="entity">st'</span> &lt; Thm.nprems_of <span class="entity">st</span><span class="main">)</span> <span class="entity">res</span>
      <span class="keyword2"><span class="keyword">in</span></span> 
        <span class="keyword2"><span class="keyword">case</span></span> Seq.pull <span class="entity">solved</span> <span class="keyword2"><span class="keyword">of</span></span>
          SOME <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">solved</span>
        <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="entity">res</span>  
      <span class="keyword2"><span class="keyword">end</span></span>
    
      <span class="keyword2"><span class="keyword">local</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">CASES_aux</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> no_tac
          <span class="main">|</span> <span class="entity">CASES_aux</span> <span class="main">(</span><span class="main">(</span><span class="entity">tac1</span><span class="main">,</span> <span class="entity">tac2</span><span class="main">)</span>::<span class="entity">cs</span><span class="main">)</span> <span class="main">=</span> <span class="entity">tac1</span> <span class="inner_numeral">1</span> THEN_ELSE <span class="main">(</span><span class="entity">tac2</span><span class="main">,</span> <span class="entity">CASES_aux</span> <span class="entity">cs</span><span class="main">)</span>    
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="comment1">(* 
          Accepts a list of pairs of (pattern_tac', worker_tac), and applies
          worker_tac to results of first successful pattern_tac'.
        *)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">CASES'</span> <span class="main">=</span> SELECT_GOAL o <span class="entity">CASES_aux</span>
      <span class="keyword2"><span class="keyword">end</span></span>    

      <span class="comment1">(* TODO/FIXME: There seem to be no guarantees when eta-long forms are introduced by unification.
        So, we have to expect eta-long forms everywhere, which may be a problem when matching terms
        syntactically.
      *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">WITH_subgoal</span> <span class="entity">tac</span> <span class="main">=</span> 
        CONVERSION Thm.eta_conversion THEN' 
        <span class="entity">IF_EXGOAL</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st</span> <span class="main">=&gt;</span> <span class="entity">tac</span> <span class="main">(</span>nth <span class="main">(</span>Thm.prems_of <span class="entity">st</span><span class="main">)</span> <span class="main">(</span><span class="entity">i</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span><span class="main">)</span>
  
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">WITH_concl</span> <span class="entity">tac</span> <span class="main">=</span> 
        CONVERSION Thm.eta_conversion THEN' 
        <span class="entity">IF_EXGOAL</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st</span> <span class="main">=&gt;</span> 
          <span class="entity">tac</span> <span class="main">(</span>Logic.concl_of_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>
        <span class="main">)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">TRADE</span> <span class="entity">tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">orig_ctxt</span> <span class="main">=</span> <span class="entity">ctxt</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">st</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> yield_singleton <span class="main">(</span>apfst snd oo Variable.import true<span class="main">)</span> <span class="entity">st</span> <span class="entity">ctxt</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">seq</span> <span class="main">=</span> <span class="entity">tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span>
          |&gt; Seq.map <span class="main">(</span>singleton <span class="main">(</span>Variable.export <span class="entity">ctxt</span> <span class="entity">orig_ctxt</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">seq</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="comment1">(* Try argument, then function *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fcomb_conv</span> <span class="entity">conv</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Conv <span class="keyword2"><span class="keyword">in</span></span>
        arg_conv <span class="entity">conv</span> else_conv fun_conv <span class="entity">conv</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  
      <span class="comment1">(* Descend over function or abstraction *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fsub_conv</span> <span class="entity">conv</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> 
        <span class="keyword3"><span class="keyword">open</span></span> Conv 
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">fcomb_conv</span> <span class="main">(</span><span class="entity">conv</span> <span class="entity">ctxt</span><span class="main">)</span> else_conv
        abs_conv <span class="main">(</span><span class="entity">conv</span> o snd<span class="main">)</span> <span class="entity">ctxt</span> else_conv
        no_conv
      <span class="keyword2"><span class="keyword">end</span></span>
  
      <span class="comment1">(* Apply to topmost matching position *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ftop_conv</span> <span class="entity">conv</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span> 
        <span class="main">(</span><span class="entity">conv</span> <span class="entity">ctxt</span> else_conv <span class="entity">fsub_conv</span> <span class="main">(</span><span class="entity">ftop_conv</span> <span class="entity">conv</span><span class="main">)</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">ct</span>
  
      <span class="comment1">(* Iterate rule on theorem until it fails *)</span>  
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">repeat_rule</span> <span class="entity">n</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> try <span class="entity">n</span> <span class="entity">thm</span> <span class="keyword2"><span class="keyword">of</span></span>
        SOME <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">repeat_rule</span> <span class="entity">n</span> <span class="entity">thm</span>
      <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="entity">thm</span>
  
      <span class="comment1">(* Apply rule on theorem and assert that theorem was changed *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">changed_rule</span> <span class="entity">n</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm'</span> <span class="main">=</span> <span class="entity">n</span> <span class="entity">thm</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> Thm.eq_thm_prop <span class="main">(</span><span class="entity">thm</span><span class="main">,</span> <span class="entity">thm'</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="keyword3"><span class="keyword">raise</span></span> THM <span class="main">(</span><span class="inner_quoted">"Same"</span><span class="main">,</span><span class="inner_numeral">~1</span><span class="main">,</span><span class="main">[</span><span class="entity">thm</span><span class="main">,</span><span class="entity">thm'</span><span class="main">]</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">thm'</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="comment1">(* Try rule on theorem *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">try_rule</span> <span class="entity">n</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> try <span class="entity">n</span> <span class="entity">thm</span> <span class="keyword2"><span class="keyword">of</span></span>
        SOME <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">thm</span> <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="entity">thm</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">trade_rule</span> <span class="entity">f</span> <span class="entity">ctxt</span> <span class="entity">thm</span> <span class="main">=</span> 
        singleton <span class="main">(</span>Variable.trade <span class="main">(</span>map o <span class="entity">f</span><span class="main">)</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">thm</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">RS_fst</span> <span class="entity">thm</span> <span class="entity">thms</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">r</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> THM <span class="main">(</span><span class="inner_quoted">"RS_fst, no matches"</span><span class="main">,</span><span class="inner_numeral">~1</span><span class="main">,</span><span class="entity">thm</span>::<span class="entity">thms</span><span class="main">)</span>
          <span class="main">|</span> <span class="entity">r</span> <span class="main">(</span><span class="entity">thm'</span>::<span class="entity">thms</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> try <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> RS<span class="main">)</span> <span class="main">(</span><span class="entity">thm</span><span class="main">,</span><span class="entity">thm'</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
              NONE <span class="main">=&gt;</span> <span class="entity">r</span> <span class="entity">thms</span> <span class="main">|</span> SOME <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">thm</span>
  
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">r</span> <span class="entity">thms</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">OF_fst</span> <span class="entity">thms</span> <span class="entity">insts</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">r</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> THM <span class="main">(</span><span class="inner_quoted">"OF_fst, no matches"</span><span class="main">,</span>length <span class="entity">thms</span><span class="main">,</span><span class="entity">thms</span>@<span class="entity">insts</span><span class="main">)</span>
          <span class="main">|</span> <span class="entity">r</span> <span class="main">(</span><span class="entity">thm</span>::<span class="entity">thms</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> try <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> OF<span class="main">)</span> <span class="main">(</span><span class="entity">thm</span><span class="main">,</span><span class="entity">insts</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
              NONE <span class="main">=&gt;</span> <span class="entity">r</span> <span class="entity">thms</span> <span class="main">|</span> SOME <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">thm</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">r</span> <span class="entity">thms</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="comment1">(* Map [] to z, and [x1,...,xN] to f(...f(f(x1,x2),x3)...) *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">list_binop_left</span> <span class="entity">z</span> <span class="entity">f</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">r</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="entity">z</span>
          <span class="main">|</span> <span class="entity">r</span> <span class="main">[</span><span class="entity">T</span><span class="main">]</span> <span class="main">=</span> <span class="entity">T</span>
          <span class="main">|</span> <span class="entity">r</span> <span class="main">(</span><span class="entity">T</span>::<span class="entity">Ts</span><span class="main">)</span> <span class="main">=</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">r</span> <span class="entity">Ts</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">l</span> <span class="main">=&gt;</span> <span class="entity">r</span> <span class="main">(</span>rev <span class="entity">l</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>    

      <span class="comment1">(* Map [] to z, [x] to i x, [x1,...,xN] to f(...f(f(x1,x2),x3)...), thread state *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fold_binop_left</span> <span class="entity">z</span> <span class="entity">i</span> <span class="entity">f</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">r</span> <span class="main">[</span><span class="main">]</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">z</span> <span class="entity">ctxt</span>
          <span class="main">|</span> <span class="entity">r</span> <span class="main">[</span><span class="entity">T</span><span class="main">]</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">i</span> <span class="entity">T</span> <span class="entity">ctxt</span>
          <span class="main">|</span> <span class="entity">r</span> <span class="main">(</span><span class="entity">T</span>::<span class="entity">Ts</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> 
              <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">Ti</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> <span class="entity">i</span> <span class="entity">T</span> <span class="entity">ctxt</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">Tsi</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> <span class="entity">r</span> <span class="entity">Ts</span> <span class="entity">ctxt</span>
            <span class="keyword2"><span class="keyword">in</span></span>
              <span class="main">(</span><span class="entity">f</span> <span class="main">(</span><span class="entity">Tsi</span><span class="main">,</span><span class="entity">Ti</span><span class="main">)</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">l</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">r</span> <span class="main">(</span>rev <span class="entity">l</span><span class="main">)</span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">end</span></span>    

  
  
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">strip_prodT_left</span> <span class="main">(</span>Type <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">type_name</span> Product_Type.prod<span class="antiquote">}</span></span><span class="main">,</span><span class="main">[</span><span class="entity">A</span><span class="main">,</span><span class="entity">B</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">strip_prodT_left</span> <span class="entity">A</span> @ <span class="main">[</span><span class="entity">B</span><span class="main">]</span>
        <span class="main">|</span> <span class="entity">strip_prodT_left</span> <span class="main">(</span>Type <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">type_name</span> Product_Type.unit<span class="antiquote">}</span></span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
        <span class="main">|</span> <span class="entity">strip_prodT_left</span> <span class="entity">T</span> <span class="main">=</span> <span class="main">[</span><span class="entity">T</span><span class="main">]</span>
  
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">list_prodT_left</span> <span class="main">=</span> <span class="entity">list_binop_left</span> <span class="entity">HOLogic.unitT</span> <span class="entity">HOLogic.mk_prodT</span>

      <span class="comment1">(* Make tuple with left-bracket structure *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mk_ltuple</span> <span class="main">=</span> <span class="entity">list_binop_left</span> <span class="entity">HOLogic.unit</span> <span class="entity">HOLogic.mk_prod</span>


  
      <span class="comment1">(* Fix a tuple of new frees *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fix_left_tuple_from_Ts</span> <span class="entity">name</span> <span class="main">=</span> <span class="entity">fold_binop_left</span>
        <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">()</span>"</span><span class="antiquote">}</span></span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">T</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span> 
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> yield_singleton Variable.variant_fixes <span class="entity">name</span> <span class="entity">ctxt</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">x</span> <span class="main">=</span> Free <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span> 
            <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
        <span class="entity">HOLogic.mk_prod</span>  

      <span class="comment1">(* Replace all type-vars by dummyT *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">dummify_tvars</span> <span class="main">=</span> map_types <span class="main">(</span>map_type_tvar <span class="main">(</span>K dummyT<span class="main">)</span><span class="main">)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_itselfT</span> <span class="main">(</span>Type <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">type_name</span> itself<span class="antiquote">}</span></span><span class="main">,</span><span class="main">[</span><span class="entity">A</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">A</span>
        <span class="main">|</span> <span class="entity">dest_itselfT</span> <span class="entity">T</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TYPE<span class="main">(</span><span class="inner_quoted">"dest_itselfT"</span><span class="main">,</span><span class="main">[</span><span class="entity">T</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span>


      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">shift_lambda_left</span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">thm</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> shift_lambda_left<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">shift_lambda_leftN</span> <span class="entity">i</span> <span class="main">=</span> funpow <span class="entity">i</span> <span class="entity">shift_lambda_left</span>
  

      <span class="comment1">(* TODO: Naming should be without ' for basic parse, and with ' for context_parser! *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_bool_config'</span> <span class="entity">name</span> <span class="entity">cfg</span> <span class="main">=</span>
           <span class="main">(</span>Args.$$$ <span class="entity">name</span> #&gt;&gt; K <span class="main">(</span><span class="entity">cfg</span><span class="main">,</span>true<span class="main">)</span><span class="main">)</span>
        || <span class="main">(</span>Args.$$$ <span class="main">(</span><span class="inner_quoted">"no_"</span>^<span class="entity">name</span><span class="main">)</span> #&gt;&gt; K <span class="main">(</span><span class="entity">cfg</span><span class="main">,</span>false<span class="main">)</span><span class="main">)</span>  
  
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_paren_list'</span> <span class="entity">p</span> <span class="main">=</span> Scan.optional <span class="main">(</span>Args.parens <span class="main">(</span>Parse.enum1 <span class="inner_quoted">","</span> <span class="entity">p</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span>
  
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply_configs</span> <span class="entity">l</span> <span class="entity">ctxt</span> <span class="main">=</span> fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">cfg</span><span class="main">,</span><span class="entity">v</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> Config.put <span class="entity">cfg</span> <span class="entity">v</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">l</span> <span class="entity">ctxt</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lambda_tuple</span> <span class="main">[</span><span class="main">]</span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">t</span>
        <span class="main">|</span> <span class="entity">lambda_tuple</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="main">(</span><span class="var">?a</span><span class="main">,</span><span class="var">?b</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span></span>::<span class="entity">l</span><span class="main">)</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">body</span> <span class="main">=</span> <span class="entity">lambda_tuple</span> <span class="main">(</span><span class="entity">a</span>::<span class="entity">b</span>::<span class="entity">l</span><span class="main">)</span> <span class="entity">t</span>
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mk_term</span> <span class="quoted">"case_prod <span class="var">?body</span>"</span><span class="antiquote">}</span></span></span></span></span></span></span></span></span></span></span></span></span></span>
          <span class="keyword2"><span class="keyword">end</span></span>
        <span class="main">|</span> <span class="entity">lambda_tuple</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">l</span><span class="main">)</span> <span class="entity">t</span> <span class="main">=</span> lambda <span class="entity">x</span> <span class="main">(</span><span class="entity">lambda_tuple</span> <span class="entity">l</span> <span class="entity">t</span><span class="main">)</span>
  
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_tuple_inst</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">iname</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">argTs</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span> <span class="main">=</span> strip_type <span class="entity">T</span>
  
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cr</span> <span class="main">(</span>Type <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">type_name</span> prod<span class="antiquote">}</span></span><span class="main">,</span><span class="main">[</span><span class="entity">T1</span><span class="main">,</span><span class="entity">T2</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">x1</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> <span class="entity">cr</span> <span class="entity">T1</span> <span class="entity">ctxt</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">x2</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> <span class="entity">cr</span> <span class="entity">T2</span> <span class="entity">ctxt</span>
            <span class="keyword2"><span class="keyword">in</span></span>
              <span class="main">(</span><span class="entity">HOLogic.mk_prod</span> <span class="main">(</span><span class="entity">x1</span><span class="main">,</span><span class="entity">x2</span><span class="main">)</span><span class="main">,</span> <span class="entity">ctxt</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">end</span></span>
          <span class="main">|</span> <span class="entity">cr</span> <span class="entity">T</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> yield_singleton Variable.variant_fixes <span class="inner_quoted">"x"</span> <span class="entity">ctxt</span>
            <span class="keyword2"><span class="keyword">in</span></span>
              <span class="main">(</span>Free <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">end</span></span>
  
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Variable.set_body false <span class="entity">ctxt</span> <span class="comment1">(* Prevent generation of skolem-names *)</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">args</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> fold_map <span class="entity">cr</span> <span class="entity">argTs</span> <span class="entity">ctxt</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fl</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="main">(</span><span class="var">?x</span><span class="main">,</span><span class="var">?y</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="entity">fl</span> <span class="entity">x</span> @ <span class="entity">fl</span> <span class="entity">y</span>
          <span class="main">|</span> <span class="entity">fl</span> <span class="entity">t</span> <span class="main">=</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span>
  
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fargs</span> <span class="main">=</span> flat <span class="main">(</span>map <span class="entity">fl</span> <span class="entity">args</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fTs</span> <span class="main">=</span> map fastype_of <span class="entity">fargs</span>
  
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">v</span> <span class="main">=</span> Var <span class="main">(</span><span class="entity">iname</span><span class="main">,</span><span class="entity">fTs</span> ---&gt; <span class="entity">T</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">v</span> <span class="main">=</span> list_comb <span class="main">(</span><span class="entity">v</span><span class="main">,</span><span class="entity">fargs</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">v</span> <span class="main">=</span> <span class="entity">lambda_tuple</span> <span class="entity">args</span> <span class="entity">v</span>
      <span class="keyword2"><span class="keyword">in</span></span> 
        Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">v</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">instantiate_tuples</span> <span class="entity">ctxt</span> <span class="entity">inTs</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">inst</span> <span class="main">=</span> <span class="entity">inTs</span> ~~ map <span class="main">(</span><span class="entity">get_tuple_inst</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">inTs</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        Thm.instantiate <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="entity">inst</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">COND'</span>
  
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">instantiate_tuples_from_term_tac</span> <span class="entity">ctxt</span> <span class="entity">t</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vars</span> <span class="main">=</span> Term.add_vars <span class="entity">t</span> <span class="main">[</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        PRIMITIVE <span class="main">(</span><span class="entity">instantiate_tuples</span> <span class="entity">ctxt</span> <span class="entity">vars</span><span class="main">)</span> <span class="entity">st</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">instantiate_tuples_subgoal_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">WITH_subgoal</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> K <span class="main">(</span><span class="entity">instantiate_tuples_from_term_tac</span> <span class="entity">ctxt</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Basic_Refine_Util</span><span class="main">:</span> <span class="entity">BASIC_REFINE_UTIL</span> <span class="main">=</span> <span class="entity">Refine_Util</span>
  <span class="keyword3"><span class="keyword">open</span></span> <span class="entity">Basic_Refine_Util</span>

›</span>

<span class="keyword1"><span class="command">attribute_setup</span></span> zero_var_indexes <span class="main">=</span> <span class="quoted">‹
  Scan.succeed <span class="main">(</span>Thm.rule_attribute <span class="main">[</span><span class="main">]</span> <span class="main">(</span>K Drule.zero_var_indexes<span class="main">)</span><span class="main">)</span>
›</span> <span class="quoted">"Set variable indexes to zero, renaming to avoid clashes"</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Attr_Comb">
<div class="head">
<h1>Theory Attr_Comb</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Attribute Combinators›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Attr_Comb
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Refine_Util.html">Refine_Util</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">infixr</span></span> <span class="inner_numeral">5</span> THEN_ATTR
  <span class="keyword1"><span class="keyword">infixr</span></span> <span class="inner_numeral">4</span> ELSE_ATTR


  <span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">ATTR_COMB</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
    <span class="keyword1"><span class="keyword">exception</span></span> ATTR_EXC <span class="keyword2"><span class="keyword">of</span></span> string

    <span class="keyword1"><span class="keyword">val</span></span> NO_ATTR<span class="main">:</span> attribute
    <span class="keyword1"><span class="keyword">val</span></span> ID_ATTR<span class="main">:</span> attribute

    <span class="keyword1"><span class="keyword">val</span></span> ITE_ATTR'<span class="main">:</span> attribute <span class="main">-&gt;</span> attribute <span class="main">-&gt;</span> <span class="main">(</span>exn <span class="main">-&gt;</span> attribute<span class="main">)</span> <span class="main">-&gt;</span> attribute  
    <span class="keyword1"><span class="keyword">val</span></span> ITE_ATTR<span class="main">:</span> attribute <span class="main">-&gt;</span> attribute <span class="main">-&gt;</span> attribute <span class="main">-&gt;</span> attribute  

    <span class="keyword1"><span class="keyword">val</span></span> THEN_ATTR<span class="main">:</span> attribute * attribute <span class="main">-&gt;</span> attribute
    <span class="keyword1"><span class="keyword">val</span></span> ELSE_ATTR<span class="main">:</span> attribute * attribute <span class="main">-&gt;</span> attribute

    <span class="keyword1"><span class="keyword">val</span></span> TRY_ATTR<span class="main">:</span> attribute <span class="main">-&gt;</span> attribute
    <span class="keyword1"><span class="keyword">val</span></span> RPT_ATTR<span class="main">:</span> attribute <span class="main">-&gt;</span> attribute
    <span class="keyword1"><span class="keyword">val</span></span> RPT1_ATTR<span class="main">:</span> attribute <span class="main">-&gt;</span> attribute

    <span class="keyword1"><span class="keyword">val</span></span> EFF_ATTR<span class="main">:</span> <span class="main">(</span>Context.generic * thm <span class="main">-&gt;</span> 'a<span class="main">)</span> <span class="main">-&gt;</span> attribute
    <span class="keyword1"><span class="keyword">val</span></span> WARN_ATTR<span class="main">:</span> Context.generic <span class="main">-&gt;</span> string <span class="main">-&gt;</span> attribute
    <span class="keyword1"><span class="keyword">val</span></span> TRACE_ATTR<span class="main">:</span> string <span class="main">-&gt;</span> attribute <span class="main">-&gt;</span> attribute


    <span class="keyword1"><span class="keyword">val</span></span> IGNORE_THM<span class="main">:</span> attribute <span class="main">-&gt;</span> attribute

    <span class="keyword1"><span class="keyword">val</span></span> CHECK_PREPARE<span class="main">:</span> <span class="main">(</span>Context.generic * thm <span class="main">-&gt;</span> bool<span class="main">)</span> <span class="main">-&gt;</span> attribute <span class="main">-&gt;</span> attribute

    <span class="keyword1"><span class="keyword">val</span></span> COND_attr<span class="main">:</span> <span class="main">(</span>Context.generic * thm <span class="main">-&gt;</span> bool<span class="main">)</span> <span class="main">-&gt;</span> attribute
    <span class="keyword1"><span class="keyword">val</span></span> RS_attr<span class="main">:</span> thm <span class="main">-&gt;</span> attribute
    <span class="keyword1"><span class="keyword">val</span></span> RSm_attr<span class="main">:</span> thm <span class="main">-&gt;</span> attribute
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Attr_Comb</span> <span class="main">:</span><span class="entity">ATTR_COMB</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>

    <span class="keyword1"><span class="keyword">exception</span></span> <span class="entity">ATTR_EXC</span> <span class="keyword2"><span class="keyword">of</span></span> string
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">NO_ATTR</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> <span class="entity">ATTR_EXC</span> <span class="inner_quoted">"NO_ATTR"</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ID_ATTR</span> <span class="main">_</span> <span class="main">=</span> <span class="main">(</span>NONE<span class="main">,</span>NONE<span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ITE_ATTR'</span> <span class="entity">a</span> <span class="entity">b</span> <span class="entity">c</span> <span class="main">(</span><span class="entity">context</span><span class="main">,</span><span class="entity">thm</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dflt</span> <span class="entity">v</span> NONE <span class="main">=</span> SOME <span class="entity">v</span> <span class="main">|</span> <span class="entity">dflt</span> <span class="main">_</span> <span class="main">(</span>SOME <span class="entity">v</span><span class="main">)</span> <span class="main">=</span> SOME <span class="entity">v</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ccxt'</span> <span class="main">=</span> <span class="main">(</span>true<span class="main">,</span><span class="entity">a</span> <span class="main">(</span><span class="entity">context</span><span class="main">,</span><span class="entity">thm</span><span class="main">)</span><span class="main">)</span> 
        <span class="keyword3"><span class="keyword">handle</span></span> <span class="main">(</span><span class="entity">e</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="entity">ATTR_EXC</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>false<span class="main">,</span><span class="entity">c</span> <span class="entity">e</span> <span class="main">(</span><span class="entity">context</span><span class="main">,</span><span class="entity">thm</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">ccxt'</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="main">(</span>false<span class="main">,</span><span class="entity">cxt'</span><span class="main">)</span>       <span class="main">=&gt;</span> <span class="entity">cxt'</span>
      <span class="main">|</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">(</span>NONE        <span class="main">,</span> NONE    <span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">b</span> <span class="main">(</span><span class="entity">context</span><span class="main">,</span> <span class="entity">thm</span><span class="main">)</span>
      <span class="main">|</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">(</span>SOME <span class="entity">context</span><span class="main">,</span> NONE    <span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">b</span> <span class="main">(</span><span class="entity">context</span><span class="main">,</span> <span class="entity">thm</span><span class="main">)</span> |&gt;&gt; <span class="entity">dflt</span> <span class="entity">context</span>
      <span class="main">|</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">(</span>NONE        <span class="main">,</span> SOME <span class="entity">thm</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">b</span> <span class="main">(</span><span class="entity">context</span><span class="main">,</span> <span class="entity">thm</span><span class="main">)</span> ||&gt; <span class="entity">dflt</span> <span class="entity">thm</span>
      <span class="main">|</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">(</span>SOME <span class="entity">context</span><span class="main">,</span> SOME <span class="entity">thm</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> 
          <span class="entity">b</span> <span class="main">(</span><span class="entity">context</span><span class="main">,</span> <span class="entity">thm</span><span class="main">)</span> |&gt;&gt; <span class="entity">dflt</span> <span class="entity">context</span> ||&gt; <span class="entity">dflt</span> <span class="entity">thm</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ITE_ATTR</span> <span class="entity">a</span> <span class="entity">b</span> <span class="entity">c</span> <span class="main">=</span> <span class="entity">ITE_ATTR'</span> <span class="entity">a</span> <span class="entity">b</span> <span class="main">(</span>K <span class="entity">c</span><span class="main">)</span>

  
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="main">(</span><span class="entity">a</span> <span class="entity">THEN_ATTR</span> <span class="entity">b</span><span class="main">)</span> <span class="main">=</span> <span class="entity">ITE_ATTR'</span> <span class="entity">a</span> <span class="entity">b</span> Exn.reraise
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="main">(</span><span class="entity">a</span> <span class="entity">ELSE_ATTR</span> <span class="entity">b</span><span class="main">)</span> <span class="main">=</span> <span class="entity">ITE_ATTR</span> <span class="entity">a</span> <span class="entity">ID_ATTR</span> <span class="entity">b</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">TRY_ATTR</span> <span class="entity">a</span> <span class="main">=</span> <span class="entity">a</span> <span class="entity">ELSE_ATTR</span> <span class="entity">ID_ATTR</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">RPT_ATTR</span> <span class="entity">a</span> <span class="entity">cxt</span> <span class="main">=</span> <span class="main">(</span><span class="entity">ITE_ATTR</span> <span class="entity">a</span> <span class="main">(</span><span class="entity">RPT_ATTR</span> <span class="entity">a</span><span class="main">)</span> <span class="entity">ID_ATTR</span><span class="main">)</span> <span class="entity">cxt</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">RPT1_ATTR</span> <span class="entity">a</span> <span class="main">=</span> <span class="entity">a</span> <span class="entity">THEN_ATTR</span> <span class="entity">RPT_ATTR</span> <span class="entity">a</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">EFF_ATTR</span> <span class="entity">f</span> <span class="entity">cxt</span> <span class="main">=</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">cxt</span><span class="main">;</span> <span class="main">(</span>NONE<span class="main">,</span>NONE<span class="main">)</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">WARN_ATTR</span> <span class="entity">context</span> <span class="entity">msg</span> <span class="main">=</span> <span class="entity">EFF_ATTR</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">thm</span><span class="main">)</span> <span class="main">=&gt;</span> warning <span class="main">(</span><span class="entity">msg</span> ^ <span class="inner_quoted">": "</span> 
      ^ Thm.string_of_thm <span class="main">(</span>Context.proof_of <span class="entity">context</span><span class="main">)</span> <span class="entity">thm</span><span class="main">)</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">TRACE_ATTR</span> <span class="entity">msg</span> <span class="entity">a</span> <span class="entity">cxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> tracing <span class="main">(</span><span class="entity">msg</span> ^ <span class="inner_quoted">"\n"</span> ^ <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">make_string</span><span class="antiquote">}</span></span></span></span> <span class="entity">cxt</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">r</span> <span class="main">=</span> <span class="entity">a</span> <span class="entity">cxt</span> <span class="keyword3"><span class="keyword">handle</span></span> <span class="entity">ATTR_EXC</span> <span class="entity">m</span> <span class="main">=&gt;</span> <span class="main">(</span>
        tracing <span class="main">(</span><span class="inner_quoted">"EXC "</span>^<span class="entity">m</span>^<span class="inner_quoted">"("</span>^<span class="entity">msg</span>^<span class="inner_quoted">")"</span><span class="main">)</span><span class="main">;</span> 
        <span class="keyword3"><span class="keyword">raise</span></span> <span class="entity">ATTR_EXC</span> <span class="entity">m</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> tracing <span class="main">(</span><span class="inner_quoted">"YIELDS ("</span> ^ <span class="entity">msg</span> ^ <span class="inner_quoted">") "</span> ^ <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">make_string</span><span class="antiquote">}</span></span></span></span> <span class="entity">r</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">r</span> <span class="keyword2"><span class="keyword">end</span></span>
  
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">IGNORE_THM</span> <span class="entity">a</span> <span class="main">=</span> <span class="entity">a</span> #&gt; apsnd <span class="main">(</span>K NONE<span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">COND_attr</span> <span class="entity">cond</span> <span class="entity">cxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">cond</span> <span class="entity">cxt</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>NONE<span class="main">,</span>NONE<span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> 
      <span class="keyword3"><span class="keyword">raise</span></span> <span class="entity">ATTR_EXC</span> <span class="inner_quoted">"COND_attr"</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">CHECK_PREPARE</span> <span class="entity">check</span> <span class="entity">prep</span> <span class="main">=</span> 
      <span class="entity">ITE_ATTR</span> <span class="main">(</span><span class="entity">COND_attr</span> <span class="entity">check</span><span class="main">)</span> 
        <span class="entity">ID_ATTR</span> 
        <span class="main">(</span><span class="entity">prep</span> <span class="entity">THEN_ATTR</span> <span class="entity">COND_attr</span> <span class="entity">check</span><span class="main">)</span>

  
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">RS_attr</span> <span class="entity">thm</span> <span class="main">=</span> 
      Thm.rule_attribute <span class="main">[</span><span class="entity">thm</span><span class="main">]</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm'</span> <span class="main">=&gt;</span> <span class="main">(</span>
        <span class="entity">thm'</span> RS <span class="entity">thm</span> <span class="keyword3"><span class="keyword">handle</span></span> <span class="main">(</span><span class="entity">exc</span> <span class="keyword1"><span class="keyword">as</span></span> THM <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> 
          <span class="keyword3"><span class="keyword">raise</span></span> <span class="entity">ATTR_EXC</span> <span class="main">(</span><span class="inner_quoted">"RS_attr: "</span> ^ <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">make_string</span><span class="antiquote">}</span></span></span></span> <span class="entity">exc</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">RSm_attr</span> <span class="entity">thm</span> <span class="main">=</span> 
      Thm.rule_attribute <span class="main">[</span><span class="entity">thm</span><span class="main">]</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">context</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm'</span> <span class="main">=&gt;</span> <span class="main">(</span>
        <span class="entity">RSm</span> <span class="main">(</span>Context.proof_of <span class="entity">context</span><span class="main">)</span> <span class="entity">thm'</span> <span class="entity">thm</span> <span class="keyword3"><span class="keyword">handle</span></span> <span class="main">(</span><span class="entity">exc</span> <span class="keyword1"><span class="keyword">as</span></span> THM <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> 
          <span class="keyword3"><span class="keyword">raise</span></span> <span class="entity">ATTR_EXC</span> <span class="main">(</span><span class="inner_quoted">"RSm_attr: "</span> ^ <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">make_string</span><span class="antiquote">}</span></span></span></span> <span class="entity">exc</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Named_Sorted_Thms">
<div class="head">
<h1>Theory Named_Sorted_Thms</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Named Theorems with Explicit Filtering and Sorting›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Named_Sorted_Thms
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Attr_Comb.html">Attr_Comb</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">NAMED_SORTED_THMS</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">sig</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> member<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> bool
    <span class="keyword1"><span class="keyword">val</span></span> get<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm list
    <span class="keyword1"><span class="keyword">val</span></span> add_thm<span class="main">:</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
    <span class="keyword1"><span class="keyword">val</span></span> del_thm<span class="main">:</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
    <span class="keyword1"><span class="keyword">val</span></span> add<span class="main">:</span> attribute
    <span class="keyword1"><span class="keyword">val</span></span> del<span class="main">:</span> attribute
    <span class="keyword1"><span class="keyword">val</span></span> setup<span class="main">:</span> theory <span class="main">-&gt;</span> theory
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">functor</span></span> <span class="entity">Named_Sorted_Thms</span><span class="main">(</span>
    <span class="keyword1"><span class="keyword">val</span></span> name<span class="main">:</span> binding 
    <span class="keyword1"><span class="keyword">val</span></span> description<span class="main">:</span> string
    <span class="keyword1"><span class="keyword">val</span></span> sort<span class="main">:</span> Context.generic <span class="main">-&gt;</span> thm list <span class="main">-&gt;</span> thm list
    <span class="keyword1"><span class="keyword">val</span></span> transform<span class="main">:</span> Context.generic <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm list 
      <span class="comment1">(* Raise THM on invalid thm *)</span>
    <span class="main">)</span><span class="main">:</span> <span class="entity">NAMED_SORTED_THMS</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">struct</span></span>

    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Data</span> <span class="main">=</span> Generic_Data
    <span class="main">(</span>
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> thm Item_Net.T<span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> Thm.full_rules<span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I<span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">merge</span> <span class="main">=</span> Item_Net.merge<span class="main">;</span>
    <span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">member</span> <span class="main">=</span> Item_Net.member o Data.get o Context.Proof<span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">content</span> <span class="entity">context</span> <span class="main">=</span> <span class="entity">sort</span> <span class="entity">context</span> <span class="main">(</span>Item_Net.content <span class="main">(</span>Data.get <span class="entity">context</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">get</span> <span class="main">=</span> <span class="entity">content</span> o Context.Proof<span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">wrap</span> <span class="entity">upd</span> <span class="main">=</span> Thm.declaration_attribute <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">context</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">warn</span> <span class="main">(</span><span class="entity">msg</span><span class="main">,</span><span class="entity">i</span><span class="main">,</span><span class="entity">thms</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Context.proof_of <span class="entity">context</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pt</span> <span class="main">=</span> Pretty.block <span class="main">[</span>
          Pretty.str <span class="entity">msg</span><span class="main">,</span> 
          Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span>
          Pretty.block 
            <span class="main">[</span>Pretty.str <span class="inner_quoted">"("</span><span class="main">,</span>Pretty.str <span class="main">(</span>string_of_int <span class="entity">i</span><span class="main">)</span><span class="main">,</span>Pretty.str <span class="inner_quoted">")"</span><span class="main">]</span><span class="main">,</span>
          Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span>
          Pretty.block <span class="main">(</span>Pretty.fbreaks <span class="main">(</span>map <span class="main">(</span>Thm.pretty_thm <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">thms</span><span class="main">)</span><span class="main">)</span>
        <span class="main">]</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        warning <span class="main">(</span>Pretty.string_of <span class="entity">pt</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thms</span> <span class="main">=</span> <span class="main">(</span><span class="entity">transform</span> <span class="entity">context</span> <span class="entity">thm</span><span class="main">)</span> <span class="keyword3"><span class="keyword">handle</span></span> THM <span class="entity">e</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">warn</span> <span class="entity">e</span><span class="main">;</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      fold <span class="entity">upd</span> <span class="entity">thms</span> <span class="entity">context</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">add</span> <span class="main">=</span> <span class="entity">wrap</span> <span class="main">(</span>Data.map o Item_Net.update<span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">del</span> <span class="main">=</span> <span class="entity">wrap</span> <span class="main">(</span>Data.map o Item_Net.remove<span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_thm</span> <span class="entity">thm</span> <span class="main">=</span> Thm.apply_attribute <span class="main">(</span><span class="entity">add</span><span class="main">)</span> <span class="entity">thm</span> #&gt; snd
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">del_thm</span> <span class="entity">thm</span> <span class="main">=</span> Thm.apply_attribute <span class="main">(</span><span class="entity">del</span><span class="main">)</span> <span class="entity">thm</span> #&gt; snd

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">setup</span> <span class="main">=</span>
      <span class="entity">Attrib.setup</span> <span class="entity">name</span> <span class="main">(</span><span class="entity">Attrib.add_del</span> <span class="entity">add</span> <span class="entity">del</span><span class="main">)</span> 
        <span class="main">(</span><span class="inner_quoted">"declaration of "</span> ^ <span class="entity">description</span><span class="main">)</span> 
      #&gt; Global_Theory.add_thms_dynamic <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">content</span><span class="main">)</span><span class="main">;</span>

  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Prio_List">
<div class="head">
<h1>Theory Prio_List</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Priority Lists›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Prio_List
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="comment1">(*
    We provide a list of items with insertion operation relative to other
    items (after, before) and relative to absolute positions (first, last).
  *)</span>
  <span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">PRIO_LIST</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">item</span>

    <span class="keyword1"><span class="keyword">val</span></span> empty<span class="main">:</span> <span class="entity">T</span>
    <span class="keyword1"><span class="keyword">val</span></span> add_first<span class="main">:</span> <span class="entity">T</span> <span class="main">-&gt;</span> <span class="entity">item</span> <span class="main">-&gt;</span> <span class="entity">T</span>
    <span class="keyword1"><span class="keyword">val</span></span> add_last<span class="main">:</span> <span class="entity">T</span> <span class="main">-&gt;</span> <span class="entity">item</span> <span class="main">-&gt;</span> <span class="entity">T</span>
    <span class="keyword1"><span class="keyword">val</span></span> add_before<span class="main">:</span> <span class="entity">T</span> <span class="main">-&gt;</span> <span class="entity">item</span> <span class="main">-&gt;</span> <span class="entity">item</span> <span class="main">-&gt;</span> <span class="entity">T</span>
    <span class="keyword1"><span class="keyword">val</span></span> add_after<span class="main">:</span> <span class="entity">T</span> <span class="main">-&gt;</span> <span class="entity">item</span> <span class="main">-&gt;</span> <span class="entity">item</span> <span class="main">-&gt;</span> <span class="entity">T</span>

    <span class="keyword1"><span class="keyword">val</span></span> delete<span class="main">:</span> <span class="entity">item</span> <span class="main">-&gt;</span> <span class="entity">T</span> <span class="main">-&gt;</span> <span class="entity">T</span>

    <span class="keyword1"><span class="keyword">val</span></span> prio_of<span class="main">:</span> <span class="main">(</span><span class="entity">item</span> <span class="main">-&gt;</span> bool<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span><span class="entity">item</span> * <span class="entity">item</span> <span class="main">-&gt;</span> bool<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">T</span> <span class="main">-&gt;</span> int
    <span class="keyword1"><span class="keyword">val</span></span> contains<span class="main">:</span> <span class="entity">T</span> <span class="main">-&gt;</span> <span class="entity">item</span> <span class="main">-&gt;</span> bool

    <span class="keyword1"><span class="keyword">val</span></span> dest<span class="main">:</span> <span class="entity">T</span> <span class="main">-&gt;</span> <span class="entity">item</span> list

    <span class="keyword1"><span class="keyword">val</span></span> merge<span class="main">:</span> <span class="entity">T</span> * <span class="entity">T</span> <span class="main">-&gt;</span> <span class="entity">T</span>  <span class="comment1">(* Ignore conflicts *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> merge'<span class="main">:</span> <span class="entity">T</span> * <span class="entity">T</span> <span class="main">-&gt;</span> <span class="entity">item</span> list * <span class="entity">T</span> <span class="comment1">(* Return conflicting items *)</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">functor</span></span> <span class="entity">Prio_List</span> <span class="main">(</span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">item</span><span class="main">;</span> 
    <span class="keyword1"><span class="keyword">val</span></span> eq<span class="main">:</span> <span class="entity">item</span> * <span class="entity">item</span> <span class="main">-&gt;</span> bool
  <span class="main">)</span><span class="main">:</span> <span class="entity">PRIO_LIST</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">item</span> <span class="main">=</span> <span class="entity">item</span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="entity">item</span> list

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_first</span> <span class="entity">l</span> <span class="entity">e</span> <span class="main">=</span> remove <span class="entity">eq</span> <span class="entity">e</span> <span class="entity">l</span>@<span class="main">[</span><span class="entity">e</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_last</span> <span class="entity">l</span> <span class="entity">e</span> <span class="main">=</span> <span class="entity">e</span>::remove <span class="entity">eq</span> <span class="entity">e</span> <span class="entity">l</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_before</span> <span class="entity">l</span> <span class="entity">e</span> <span class="entity">a</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> 
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">l</span> <span class="main">=</span> remove <span class="entity">eq</span> <span class="entity">e</span> <span class="entity">l</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">l1</span><span class="main">,</span><span class="main">(</span><span class="entity">l2</span><span class="main">,</span><span class="entity">l3</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> chop_prefix <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> not <span class="main">(</span><span class="entity">eq</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">l</span> ||&gt; chop <span class="inner_numeral">1</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">l1</span>@<span class="entity">l2</span>@<span class="entity">e</span>::<span class="entity">l3</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_after</span> <span class="entity">l</span> <span class="entity">e</span> <span class="entity">b</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> 
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">l</span> <span class="main">=</span> remove <span class="entity">eq</span> <span class="entity">e</span> <span class="entity">l</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">l1</span><span class="main">,</span><span class="entity">l2</span><span class="main">)</span> <span class="main">=</span> chop_prefix <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> not <span class="main">(</span><span class="entity">eq</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">l</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">l1</span>@<span class="entity">e</span>::<span class="entity">l2</span> <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">delete</span> <span class="main">=</span> remove <span class="entity">eq</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prio_of</span> <span class="entity">P</span> <span class="entity">prefer</span> <span class="entity">l</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">do_prefer</span> <span class="main">_</span> NONE <span class="main">=</span> true
        <span class="main">|</span> <span class="entity">do_prefer</span> <span class="entity">x</span> <span class="main">(</span>SOME <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">prefer</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pr</span> <span class="main">[</span><span class="main">]</span> <span class="main">_</span> <span class="entity">st</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">st</span> <span class="keyword2"><span class="keyword">of</span></span> NONE <span class="main">=&gt;</span> <span class="inner_numeral">~1</span> <span class="main">|</span> SOME <span class="main">(</span><span class="entity">i</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">i</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">pr</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">l</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">P</span> <span class="entity">x</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">do_prefer</span> <span class="entity">x</span> <span class="entity">st</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="entity">pr</span> <span class="entity">l</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span> <span class="main">(</span>SOME <span class="main">(</span><span class="entity">i</span><span class="main">,</span><span class="entity">x</span><span class="main">)</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">else</span></span>
            <span class="entity">pr</span> <span class="entity">l</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">st</span>

    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">pr</span> <span class="entity">l</span> <span class="inner_numeral">0</span> NONE
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">contains</span> <span class="main">=</span> member <span class="entity">eq</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest</span> <span class="entity">l</span> <span class="main">=</span> <span class="entity">l</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">merge'</span> <span class="main">(</span><span class="entity">l1</span><span class="main">,</span><span class="entity">l2</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">l1'</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ty</span> <span class="main">=&gt;</span> <span class="main">(</span>Library.member <span class="entity">eq</span> <span class="entity">l2</span> <span class="entity">ty</span><span class="main">,</span><span class="entity">ty</span><span class="main">)</span><span class="main">)</span> <span class="entity">l1</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">l2'</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ty</span> <span class="main">=&gt;</span> <span class="main">(</span>Library.member <span class="entity">eq</span> <span class="entity">l1</span> <span class="entity">ty</span><span class="main">,</span><span class="entity">ty</span><span class="main">)</span><span class="main">)</span> <span class="entity">l2</span><span class="main">;</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">m</span> <span class="main">[</span><span class="main">]</span>                <span class="main">[</span><span class="main">]</span>               <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
        <span class="main">|</span> <span class="entity">m</span> <span class="main">[</span><span class="main">]</span>                <span class="entity">l</span>                <span class="main">=</span> map <span class="main">(</span>apfst <span class="main">(</span>K false<span class="main">)</span><span class="main">)</span> <span class="entity">l</span>
        <span class="main">|</span> <span class="entity">m</span> <span class="entity">l</span>                 <span class="main">[</span><span class="main">]</span>               <span class="main">=</span> map <span class="main">(</span>apfst <span class="main">(</span>K false<span class="main">)</span><span class="main">)</span> <span class="entity">l</span>
        <span class="main">|</span> <span class="entity">m</span> <span class="main">(</span><span class="main">(</span>true<span class="main">,</span><span class="entity">t1</span><span class="main">)</span>::<span class="entity">l1</span><span class="main">)</span>   <span class="main">(</span><span class="main">(</span>true<span class="main">,</span><span class="entity">t2</span><span class="main">)</span>::<span class="entity">l2</span><span class="main">)</span>  <span class="main">=</span> 
          <span class="main">(</span>not <span class="main">(</span><span class="entity">eq</span> <span class="main">(</span><span class="entity">t1</span><span class="main">,</span><span class="entity">t2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="entity">t2</span><span class="main">)</span> :: <span class="entity">m</span> <span class="entity">l1</span> <span class="entity">l2</span> 
        <span class="main">|</span> <span class="entity">m</span> <span class="main">(</span><span class="main">(</span>false<span class="main">,</span><span class="entity">t1</span><span class="main">)</span>::<span class="entity">l1</span><span class="main">)</span>  <span class="main">(</span><span class="main">(</span>true<span class="main">,</span><span class="entity">t2</span><span class="main">)</span>::<span class="entity">l2</span><span class="main">)</span>  <span class="main">=</span> 
          <span class="main">(</span>false<span class="main">,</span><span class="entity">t1</span><span class="main">)</span> :: <span class="entity">m</span> <span class="entity">l1</span> <span class="main">(</span><span class="main">(</span>true<span class="main">,</span><span class="entity">t2</span><span class="main">)</span>::<span class="entity">l2</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">m</span> <span class="main">(</span><span class="main">(</span>true<span class="main">,</span><span class="entity">t1</span><span class="main">)</span>::<span class="entity">l1</span><span class="main">)</span>   <span class="main">(</span><span class="main">(</span>false<span class="main">,</span><span class="entity">t2</span><span class="main">)</span>::<span class="entity">l2</span><span class="main">)</span> <span class="main">=</span> 
          <span class="main">(</span>false<span class="main">,</span><span class="entity">t2</span><span class="main">)</span> :: <span class="entity">m</span> <span class="main">(</span><span class="main">(</span>true<span class="main">,</span><span class="entity">t1</span><span class="main">)</span>::<span class="entity">l1</span><span class="main">)</span> <span class="entity">l2</span>
        <span class="main">|</span> <span class="entity">m</span> <span class="main">(</span><span class="main">(</span>false<span class="main">,</span><span class="entity">t1</span><span class="main">)</span>::<span class="entity">l1</span><span class="main">)</span>  <span class="main">(</span><span class="main">(</span>false<span class="main">,</span><span class="entity">t2</span><span class="main">)</span>::<span class="entity">l2</span><span class="main">)</span> <span class="main">=</span> 
          <span class="main">(</span>false<span class="main">,</span><span class="entity">t2</span><span class="main">)</span>::<span class="main">(</span>false<span class="main">,</span><span class="entity">t1</span><span class="main">)</span>::<span class="entity">m</span> <span class="entity">l1</span> <span class="entity">l2</span>
  
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">r</span> <span class="main">=</span> <span class="entity">m</span> <span class="entity">l1'</span> <span class="entity">l2'</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="main">(</span>map <span class="main">#</span><span class="inner_numeral">2</span> <span class="main">(</span>filter <span class="main">#</span><span class="inner_numeral">1</span> <span class="entity">r</span><span class="main">)</span><span class="main">,</span> map <span class="main">#</span><span class="inner_numeral">2</span> <span class="entity">r</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">merge</span> <span class="main">(</span><span class="entity">l1</span><span class="main">,</span><span class="entity">l2</span><span class="main">)</span> <span class="main">=</span> <span class="main">#</span><span class="inner_numeral">2</span> <span class="main">(</span><span class="entity">merge'</span> <span class="main">(</span><span class="entity">l1</span><span class="main">,</span><span class="entity">l2</span><span class="main">)</span><span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Tagged_Solver">
<div class="head">
<h1>Theory Tagged_Solver</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Tagged_Solver
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Refine_Util.html">Refine_Util</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* TODO/FIXME:
  A solver is some named entity, and it should be possible to
  reference it by its short/long name like a constant or a theorem!
*)</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">TAGGED_SOLVER</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">solver</span> <span class="main">=</span> thm list * string * string * <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span><span class="main">)</span>
    
    <span class="keyword1"><span class="keyword">val</span></span> get_solvers<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">solver</span> list
    <span class="keyword1"><span class="keyword">val</span></span> declare_solver<span class="main">:</span> thm list <span class="main">-&gt;</span> binding <span class="main">-&gt;</span> string 
      <span class="main">-&gt;</span> <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span><span class="main">)</span> <span class="main">-&gt;</span> morphism 
      <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic

    <span class="keyword1"><span class="keyword">val</span></span> lookup_solver<span class="main">:</span> string <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> <span class="entity">solver</span> option
    <span class="keyword1"><span class="keyword">val</span></span> add_triggers<span class="main">:</span> string <span class="main">-&gt;</span> thm list <span class="main">-&gt;</span> morphism <span class="main">-&gt;</span>
      Context.generic <span class="main">-&gt;</span> Context.generic

    <span class="keyword1"><span class="keyword">val</span></span> delete_solver<span class="main">:</span> string <span class="main">-&gt;</span> morphism <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic

    <span class="keyword1"><span class="keyword">val</span></span> tac_of_solver<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">solver</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>

    <span class="keyword1"><span class="keyword">val</span></span> get_potential_solvers<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> <span class="entity">solver</span> list
    <span class="keyword1"><span class="keyword">val</span></span> get_potential_tacs<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> <span class="entity">tactic'</span> list

    <span class="keyword1"><span class="keyword">val</span></span> solve_greedy_step_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> solve_greedy_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> solve_greedy_keep_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>

    <span class="keyword1"><span class="keyword">val</span></span> solve_full_step_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> solve_full_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> solve_full_keep_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>

    <span class="keyword1"><span class="keyword">val</span></span> cfg_keep<span class="main">:</span> bool Config.T
    <span class="keyword1"><span class="keyword">val</span></span> cfg_trace<span class="main">:</span> bool Config.T
    <span class="keyword1"><span class="keyword">val</span></span> cfg_full<span class="main">:</span> bool Config.T
    <span class="keyword1"><span class="keyword">val</span></span> cfg_step<span class="main">:</span> bool Config.T

    <span class="keyword1"><span class="keyword">val</span></span> solve_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>

    <span class="keyword1"><span class="keyword">val</span></span> pretty_solvers<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> Pretty.T
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Tagged_Solver</span> <span class="main">:</span> <span class="entity">TAGGED_SOLVER</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">solver</span> <span class="main">=</span> thm list * string * string * <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">solvers</span> <span class="main">=</span> Generic_Data <span class="main">(</span>
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="entity">solver</span> Item_Net.T * <span class="entity">solver</span> Symtab.table
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> <span class="main">(</span>Item_Net.init 
        <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> o apply2 <span class="main">#</span><span class="inner_numeral">2</span><span class="main">)</span> 
        <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">p</span><span class="main">:</span><span class="entity">solver</span> <span class="main">=&gt;</span> <span class="main">#</span><span class="inner_numeral">1</span> <span class="entity">p</span> |&gt; map Thm.concl_of<span class="main">)</span>
      <span class="main">,</span>
        Symtab.empty
      <span class="main">)</span>
  
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">merge</span> <span class="main">(</span><span class="main">(</span><span class="entity">n1</span><span class="main">,</span><span class="entity">t1</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">n2</span><span class="main">,</span><span class="entity">t2</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">=</span> <span class="main">(</span>Item_Net.merge <span class="main">(</span><span class="entity">n1</span><span class="main">,</span><span class="entity">n2</span><span class="main">)</span><span class="main">,</span> Symtab.merge <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> o apply2 <span class="main">#</span><span class="inner_numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="entity">t1</span><span class="main">,</span><span class="entity">t2</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I 
    <span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_solvers</span> <span class="entity">ctxt</span> <span class="main">=</span> solvers.get <span class="main">(</span>Context.Proof <span class="entity">ctxt</span><span class="main">)</span> 
      |&gt; <span class="main">#</span><span class="inner_numeral">2</span> |&gt; Symtab.dest |&gt; map <span class="main">#</span><span class="inner_numeral">2</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lookup_solver</span> <span class="entity">n</span> <span class="entity">context</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tab</span> <span class="main">=</span> solvers.get <span class="entity">context</span> |&gt; <span class="main">#</span><span class="inner_numeral">2</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      Symtab.lookup <span class="entity">tab</span> <span class="entity">n</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_triggers</span> <span class="entity">n</span> <span class="entity">thms</span> <span class="entity">phi</span> <span class="entity">context</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">lookup_solver</span> <span class="entity">n</span> <span class="entity">context</span> <span class="keyword2"><span class="keyword">of</span></span>
        NONE <span class="main">=&gt;</span> 
          error <span class="main">(</span><span class="inner_quoted">"Undefined solver: "</span> ^ <span class="entity">n</span><span class="main">)</span>
      <span class="main">|</span> SOME <span class="main">(</span><span class="entity">trigs</span><span class="main">,</span><span class="entity">n</span><span class="main">,</span><span class="entity">desc</span><span class="main">,</span><span class="entity">tac</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thms</span> <span class="main">=</span> map <span class="main">(</span>Morphism.thm <span class="entity">phi</span><span class="main">)</span> <span class="entity">thms</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">trigs</span> <span class="main">=</span> <span class="entity">thms</span> @ <span class="entity">trigs</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">solver</span> <span class="main">=</span> <span class="main">(</span><span class="entity">trigs</span><span class="main">,</span><span class="entity">n</span><span class="main">,</span><span class="entity">desc</span><span class="main">,</span><span class="entity">tac</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">in</span></span> 
          solvers.map <span class="main">(</span>Item_Net.update <span class="entity">solver</span> <span class="entity">##</span> Symtab.update <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">solver</span><span class="main">)</span><span class="main">)</span> 
            <span class="entity">context</span>
        <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">declare_solver</span> <span class="entity">thms</span> <span class="entity">n</span> <span class="entity">desc</span> <span class="entity">tac</span> <span class="entity">phi</span> <span class="entity">context</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thms</span> <span class="main">=</span> map <span class="main">(</span>Morphism.thm <span class="entity">phi</span><span class="main">)</span> <span class="entity">thms</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> Morphism.binding <span class="entity">phi</span> <span class="entity">n</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> Context.cases Sign.full_name Proof_Context.full_name <span class="entity">context</span> <span class="entity">n</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">if</span></span> Symtab.defined <span class="main">(</span>solvers.get <span class="entity">context</span> |&gt; <span class="main">#</span><span class="inner_numeral">2</span><span class="main">)</span> <span class="entity">n</span> <span class="keyword2"><span class="keyword">then</span></span>
          error <span class="main">(</span><span class="inner_quoted">"Duplicate solver "</span> ^ <span class="entity">n</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">solver</span> <span class="main">=</span> <span class="main">(</span><span class="entity">thms</span><span class="main">,</span><span class="entity">n</span><span class="main">,</span><span class="entity">desc</span><span class="main">,</span><span class="entity">tac</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      solvers.map <span class="main">(</span>Item_Net.update <span class="entity">solver</span> <span class="entity">##</span> Symtab.update <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="entity">solver</span><span class="main">)</span><span class="main">)</span> <span class="entity">context</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">delete_solver</span> <span class="entity">n</span> <span class="main">_</span> <span class="entity">context</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">lookup_solver</span> <span class="entity">n</span> <span class="entity">context</span> <span class="keyword2"><span class="keyword">of</span></span>
        NONE <span class="main">=&gt;</span> error <span class="main">(</span><span class="inner_quoted">"Undefined solver: "</span> ^ <span class="entity">n</span><span class="main">)</span>
      <span class="main">|</span> SOME <span class="entity">solver</span> <span class="main">=&gt;</span> 
          solvers.map <span class="main">(</span>Item_Net.remove <span class="entity">solver</span> <span class="entity">##</span> Symtab.delete <span class="main">(</span><span class="main">#</span><span class="inner_numeral">2</span> <span class="entity">solver</span><span class="main">)</span><span class="main">)</span>
            <span class="entity">context</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cfg_keep</span> <span class="main">=</span> 
      <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> tagged_solver_keep<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cfg_trace</span> <span class="main">=</span> 
      <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> tagged_solver_trace<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cfg_step</span> <span class="main">=</span> 
      <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> tagged_solver_step<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cfg_full</span> <span class="main">=</span> 
      <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> tagged_solver_full<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span>



    <span class="comment1">(* Get potential solvers. Overapproximation caused by net *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_potential_solvers</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">concl</span> <span class="main">=</span> Logic.concl_of_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">net</span> <span class="main">=</span> solvers.get <span class="main">(</span>Context.Proof <span class="entity">ctxt</span><span class="main">)</span> |&gt; <span class="main">#</span><span class="inner_numeral">1</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">solvers</span> <span class="main">=</span> Item_Net.retrieve <span class="entity">net</span> <span class="entity">concl</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">solvers</span> <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">notrace_tac_of_solver</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">thms</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="entity">tac</span><span class="main">)</span> <span class="main">=</span> 
      match_tac <span class="entity">ctxt</span> <span class="entity">thms</span> THEN' <span class="entity">tac</span> <span class="entity">ctxt</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">trace_tac_of_solver</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">thms</span><span class="main">,</span><span class="entity">name</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="entity">tac</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> tracing <span class="main">(</span><span class="inner_quoted">"Trying solver "</span> ^ <span class="entity">name</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">r</span> <span class="main">=</span> match_tac <span class="entity">ctxt</span> <span class="entity">thms</span> <span class="entity">i</span> <span class="entity">st</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword2"><span class="keyword">case</span></span> Seq.pull <span class="entity">r</span> <span class="keyword2"><span class="keyword">of</span></span> 
          NONE <span class="main">=&gt;</span> <span class="main">(</span>tracing <span class="inner_quoted">"  No trigger"</span><span class="main">;</span> Seq.empty<span class="main">)</span>
        <span class="main">|</span> SOME <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span> 
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">r</span> <span class="main">=</span> Seq.maps <span class="main">(</span><span class="entity">tac</span> <span class="entity">ctxt</span> <span class="entity">i</span><span class="main">)</span> <span class="entity">r</span>
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="keyword2"><span class="keyword">case</span></span> Seq.pull <span class="entity">r</span> <span class="keyword2"><span class="keyword">of</span></span> 
              NONE <span class="main">=&gt;</span> <span class="main">(</span>tracing <span class="main">(</span><span class="inner_quoted">"  No solution ("</span> ^ <span class="entity">name</span> ^ <span class="inner_quoted">")"</span><span class="main">)</span><span class="main">;</span> Seq.empty<span class="main">)</span>
            <span class="main">|</span> SOME <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">(</span>tracing <span class="main">(</span><span class="inner_quoted">"  OK ("</span> ^ <span class="entity">name</span> ^ <span class="inner_quoted">")"</span><span class="main">)</span><span class="main">;</span> <span class="entity">r</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tac_of_solver</span> <span class="entity">ctxt</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">if</span></span> Config.get <span class="entity">ctxt</span> <span class="entity">cfg_trace</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="entity">trace_tac_of_solver</span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        <span class="entity">notrace_tac_of_solver</span> <span class="entity">ctxt</span>
    
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_potential_tacs</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &lt;= Thm.nprems_of <span class="entity">st</span> <span class="keyword2"><span class="keyword">then</span></span>
        eq_assume_tac :: <span class="main">(</span>
          <span class="entity">get_potential_solvers</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span>
          |&gt; map <span class="main">(</span><span class="entity">tac_of_solver</span> <span class="entity">ctxt</span><span class="main">)</span>
        <span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">]</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">solve_greedy_step_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> 
      <span class="main">(</span>FIRST' <span class="main">(</span><span class="entity">get_potential_tacs</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">solve_full_step_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> 
      <span class="main">(</span><span class="entity">APPEND_LIST'</span> <span class="main">(</span><span class="entity">get_potential_tacs</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span><span class="main">)</span>

    <span class="comment1">(* Try to solve, take first matching tactic, but allow backtracking over
       its results *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">solve_greedy_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tacs</span> <span class="main">=</span> <span class="entity">get_potential_tacs</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="main">(</span>FIRST' <span class="entity">tacs</span> <span class="entity">THEN_ALL_NEW_FWD</span> <span class="entity">solve_greedy_tac</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="comment1">(* Try to solve. Allow backtracking over matching tactics. *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">solve_full_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tacs</span> <span class="main">=</span> <span class="entity">get_potential_tacs</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="main">(</span><span class="entity">APPEND_LIST'</span> <span class="entity">tacs</span> <span class="entity">THEN_ALL_NEW_FWD</span> <span class="entity">solve_full_tac</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">solve_greedy_keep_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tacs</span> <span class="main">=</span> <span class="entity">get_potential_tacs</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="main">(</span>FIRST' <span class="entity">tacs</span> <span class="entity">THEN_ALL_NEW_FWD</span> <span class="main">(</span>TRY o <span class="entity">solve_greedy_keep_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">solve_full_keep_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tacs</span> <span class="main">=</span> <span class="entity">get_potential_tacs</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="main">(</span><span class="entity">APPEND_LIST'</span> <span class="entity">tacs</span> <span class="entity">THEN_ALL_NEW_FWD</span> <span class="main">(</span>TRY o <span class="entity">solve_full_keep_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">solve_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span>Config.get <span class="entity">ctxt</span> <span class="entity">cfg_keep</span><span class="main">,</span> Config.get <span class="entity">ctxt</span> <span class="entity">cfg_step</span><span class="main">,</span> 
            Config.get <span class="entity">ctxt</span> <span class="entity">cfg_full</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="main">(</span><span class="main">_</span><span class="main">,</span>true<span class="main">,</span>false<span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">solve_greedy_step_tac</span> <span class="entity">ctxt</span>
      <span class="main">|</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span>true<span class="main">,</span>true<span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">solve_full_step_tac</span> <span class="entity">ctxt</span>
      <span class="main">|</span> <span class="main">(</span>true<span class="main">,</span>false<span class="main">,</span>false<span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">solve_greedy_keep_tac</span> <span class="entity">ctxt</span>
      <span class="main">|</span> <span class="main">(</span>false<span class="main">,</span>false<span class="main">,</span>false<span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">solve_greedy_tac</span> <span class="entity">ctxt</span>
      <span class="main">|</span> <span class="main">(</span>true<span class="main">,</span>false<span class="main">,</span>true<span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">solve_full_keep_tac</span> <span class="entity">ctxt</span>
      <span class="main">|</span> <span class="main">(</span>false<span class="main">,</span>false<span class="main">,</span>true<span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">solve_full_tac</span> <span class="entity">ctxt</span>


    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty_solvers</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty_solver</span> <span class="main">(</span><span class="entity">ts</span><span class="main">,</span><span class="entity">name</span><span class="main">,</span><span class="entity">desc</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=</span> Pretty.block <span class="main">(</span>
        Pretty.str <span class="main">(</span><span class="entity">name</span> ^ <span class="inner_quoted">": "</span> ^ <span class="entity">desc</span><span class="main">)</span> :: Pretty.fbrk 
        :: Pretty.str <span class="main">(</span><span class="inner_quoted">"Triggers: "</span><span class="main">)</span>
        :: Pretty.commas <span class="main">(</span>map <span class="main">(</span>Thm.pretty_thm <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">ts</span><span class="main">)</span><span class="main">)</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">solvers</span> <span class="main">=</span> <span class="entity">get_solvers</span> <span class="entity">ctxt</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      Pretty.big_list <span class="inner_quoted">"Solvers:"</span> <span class="main">(</span>map <span class="entity">pretty_solver</span> <span class="entity">solvers</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">method_setup</span></span> tagged_solver <span class="main">=</span> <span class="quoted">‹<span class="keyword2"><span class="keyword">let</span></span>
  <span class="keyword3"><span class="keyword">open</span></span> Refine_Util
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">flags</span> <span class="main">=</span> 
        <span class="entity">parse_bool_config</span> <span class="inner_quoted">"keep"</span> <span class="entity">Tagged_Solver.cfg_keep</span>
    ||  <span class="entity">parse_bool_config</span> <span class="inner_quoted">"trace"</span> <span class="entity">Tagged_Solver.cfg_trace</span>
    ||  <span class="entity">parse_bool_config</span> <span class="inner_quoted">"full"</span> <span class="entity">Tagged_Solver.cfg_full</span>
    ||  <span class="entity">parse_bool_config</span> <span class="inner_quoted">"step"</span> <span class="entity">Tagged_Solver.cfg_step</span>

<span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">parse_paren_lists</span> <span class="entity">flags</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> 
    <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span><span class="entity">Tagged_Solver.solve_tac</span> <span class="entity">ctxt</span><span class="main">)</span>
  <span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>
›</span> <span class="quoted">"Select tactic to solve goal by pattern"</span>


<span class="keyword1"><span class="command">term</span></span> <span class="quoted">True</span>
<span class="comment1">(* Localization Test *)</span>
<span class="comment1">(*
locale foo = 
  fixes A b
  assumes A: "A x = True"
begin
  definition "B == A"

  lemma AI: "A x" unfolding A ..
  lemma A_trig: "A x ==&gt; A x" .
  lemma BI: "A x ==&gt; B x" unfolding B_def .
  lemma B_trig: "B x ==&gt; B x" .
  
  declaration {* fn phi =&gt;
    Tagged_Solver.declare_solver @{thms A_trig} 
      @{binding "A_solver"} "description" 
      (K (rtac (Morphism.thm phi @{thm AI}))) phi
    *}

  ML_val {*
    Tagged_Solver.pretty_solvers @{context} |&gt; Pretty.writeln
    *}

  (* FIXME: Does not work because of improper naming!
  declaration {*
    Tagged_Solver.add_triggers "local.A_solver" @{thms A_trig}
    *}
  *)

  declaration {* fn phi =&gt;
    Tagged_Solver.declare_solver @{thms B_trig} 
      @{binding "B_solver"} "description" 
      (K (rtac (Morphism.thm phi @{thm BI}))) phi
    *}

  ML_val {*
    Tagged_Solver.pretty_solvers @{context} |&gt; Pretty.writeln
    *}

end

definition "TAG x == True"
interpretation tag: foo TAG 1
  apply unfold_locales
  unfolding TAG_def by simp

ML_val {*
  Tagged_Solver.pretty_solvers @{context} |&gt; Pretty.writeln
  *}

definition "TAG' x == True"
interpretation tag': foo TAG' 2
  apply unfold_locales
  unfolding TAG'_def by simp

interpretation tag2: foo TAG 3
  by unfold_locales

ML_val {*
  Tagged_Solver.pretty_solvers @{context} |&gt; Pretty.writeln
  *}


lemma "tag.B undefined"
  by (tagged_solver (keep))

declaration {* Tagged_Solver.delete_solver "Tagged_Solver.tag.B_solver" *}

ML_val {*
  Tagged_Solver.pretty_solvers @{context} |&gt; Pretty.writeln
  *}
*)</span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Anti_Unification">
<div class="head">
<h1>Theory Anti_Unification</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Anti-Unification›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Anti_Unification
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Refine_Util.html">Refine_Util</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We implement a simple anti-unification.
    Currently, we do not handle lambdas, nor sorts, and avoid
    higher-order variables, i.e.,
    f x and g x will be unified to ?v, not ?v x, and existing higher-order
    patterns will be collapsed, e.g.: ?f x and ?f x will become ?v.
›</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">ANTI_UNIFICATION</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">typ_env</span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">term_env</span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">env</span> <span class="main">=</span> <span class="entity">typ_env</span> * <span class="entity">term_env</span>

    <span class="keyword1"><span class="keyword">val</span></span> empty_typ<span class="main">:</span> <span class="entity">typ_env</span>
    <span class="keyword1"><span class="keyword">val</span></span> empty_term<span class="main">:</span> <span class="entity">term_env</span>
    <span class="keyword1"><span class="keyword">val</span></span> empty<span class="main">:</span> <span class="entity">env</span>

    <span class="keyword1"><span class="keyword">val</span></span> anti_unifyT<span class="main">:</span> typ * typ <span class="main">-&gt;</span> <span class="entity">typ_env</span> <span class="main">-&gt;</span> typ * <span class="entity">typ_env</span>
    <span class="keyword1"><span class="keyword">val</span></span> anti_unify_env<span class="main">:</span> term * term <span class="main">-&gt;</span> <span class="entity">env</span> <span class="main">-&gt;</span> term * <span class="entity">env</span>
    <span class="keyword1"><span class="keyword">val</span></span> anti_unify<span class="main">:</span> term * term <span class="main">-&gt;</span> term
    <span class="keyword1"><span class="keyword">val</span></span> anti_unify_list<span class="main">:</span> term list <span class="main">-&gt;</span> term

    <span class="keyword1"><span class="keyword">val</span></span> specialize_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm list <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> specialize_net_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="main">(</span>int * thm<span class="main">)</span> Net.net <span class="main">-&gt;</span> <span class="entity">tactic'</span>
  <span class="keyword2"><span class="keyword">end</span></span>


  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Anti_Unification</span> <span class="main">:</span><span class="entity">ANTI_UNIFICATION</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Term2tab</span> <span class="main">=</span> Table <span class="main">(</span>
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">key</span> <span class="main">=</span> term * term
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ord</span> <span class="main">=</span> prod_ord Term_Ord.fast_term_ord Term_Ord.fast_term_ord
    <span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Typ2tab</span> <span class="main">=</span> Table <span class="main">(</span>
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">key</span> <span class="main">=</span> typ * typ
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ord</span> <span class="main">=</span> prod_ord Term_Ord.typ_ord Term_Ord.typ_ord
    <span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">typ_env</span> <span class="main">=</span> <span class="main">(</span>typ Typ2tab.table * int<span class="main">)</span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">term_env</span> <span class="main">=</span> <span class="main">(</span>term Term2tab.table * int<span class="main">)</span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">env</span> <span class="main">=</span> <span class="entity">typ_env</span> * <span class="entity">term_env</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty_typ</span> <span class="main">=</span> <span class="main">(</span>Typ2tab.empty<span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty_term</span> <span class="main">=</span> <span class="main">(</span>Term2tab.empty<span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> <span class="main">(</span><span class="entity">empty_typ</span><span class="main">,</span><span class="entity">empty_term</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tvar_pair</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">vtab</span><span class="main">,</span><span class="entity">idx</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">case</span></span> Typ2tab.lookup <span class="entity">vtab</span> <span class="entity">p</span> <span class="keyword2"><span class="keyword">of</span></span>
        NONE <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tv</span> <span class="main">=</span> TVar <span class="main">(</span><span class="main">(</span><span class="inner_quoted">"T"</span><span class="main">,</span><span class="entity">idx</span><span class="main">)</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vtab</span> <span class="main">=</span> Typ2tab.update <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">tv</span><span class="main">)</span> <span class="entity">vtab</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="main">(</span><span class="entity">tv</span><span class="main">,</span><span class="main">(</span><span class="entity">vtab</span><span class="main">,</span><span class="entity">idx</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> SOME <span class="entity">tv</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">tv</span><span class="main">,</span><span class="main">(</span><span class="entity">vtab</span><span class="main">,</span><span class="entity">idx</span><span class="main">)</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">anti_unifyT</span> <span class="main">(</span>TFree <span class="entity">v1</span><span class="main">,</span> TFree <span class="entity">v2</span><span class="main">)</span> <span class="entity">dt</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">v1</span> <span class="main">=</span> <span class="entity">v2</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>TFree <span class="entity">v1</span><span class="main">,</span><span class="entity">dt</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">tvar_pair</span> <span class="main">(</span>TFree <span class="entity">v1</span><span class="main">,</span> TFree <span class="entity">v2</span><span class="main">)</span> <span class="entity">dt</span>
      <span class="main">|</span> <span class="entity">anti_unifyT</span> <span class="main">(</span><span class="entity">p</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span>Type <span class="main">(</span><span class="entity">n1</span><span class="main">,</span><span class="entity">l1</span><span class="main">)</span><span class="main">,</span> Type <span class="main">(</span><span class="entity">n2</span><span class="main">,</span><span class="entity">l2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">dt</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n1</span> <span class="main">=</span> <span class="entity">n2</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="main">(</span>length <span class="entity">l1</span> <span class="main">=</span> length <span class="entity">l2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span><span class="entity">dt</span><span class="main">)</span> <span class="main">=</span> fold_map <span class="entity">anti_unifyT</span> <span class="main">(</span><span class="entity">l1</span>~~<span class="entity">l2</span><span class="main">)</span> <span class="entity">dt</span>
          <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span>Type <span class="main">(</span><span class="entity">n1</span><span class="main">,</span><span class="entity">l</span><span class="main">)</span><span class="main">,</span><span class="entity">dt</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
        <span class="keyword2"><span class="keyword">else</span></span>
          <span class="entity">tvar_pair</span> <span class="entity">p</span> <span class="entity">dt</span>
      <span class="main">|</span> <span class="entity">anti_unifyT</span> <span class="entity">p</span> <span class="entity">dt</span> <span class="main">=</span> <span class="entity">tvar_pair</span> <span class="entity">p</span> <span class="entity">dt</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">var_pair</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">tdt</span><span class="main">,</span><span class="main">(</span><span class="entity">vtab</span><span class="main">,</span><span class="entity">idx</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">case</span></span> Term2tab.lookup <span class="entity">vtab</span> <span class="entity">p</span> <span class="keyword2"><span class="keyword">of</span></span>
        NONE <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">T</span><span class="main">,</span><span class="entity">tdt</span><span class="main">)</span> <span class="main">=</span> <span class="entity">anti_unifyT</span> <span class="main">(</span>apply2 fastype_of <span class="entity">p</span><span class="main">)</span> <span class="entity">tdt</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">v</span> <span class="main">=</span> Var <span class="main">(</span><span class="main">(</span><span class="inner_quoted">"v"</span><span class="main">,</span><span class="entity">idx</span><span class="main">)</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vtab</span> <span class="main">=</span> Term2tab.update <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">v</span><span class="main">)</span> <span class="entity">vtab</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="main">(</span><span class="entity">v</span><span class="main">,</span><span class="main">(</span><span class="entity">tdt</span><span class="main">,</span><span class="main">(</span><span class="entity">vtab</span><span class="main">,</span><span class="entity">idx</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> SOME <span class="entity">v</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">v</span><span class="main">,</span><span class="main">(</span><span class="entity">tdt</span><span class="main">,</span><span class="main">(</span><span class="entity">vtab</span><span class="main">,</span><span class="entity">idx</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">anti_unify_env</span> <span class="main">(</span><span class="entity">p</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span>Free <span class="main">(</span><span class="entity">n1</span><span class="main">,</span><span class="entity">T1</span><span class="main">)</span><span class="main">,</span> Free <span class="main">(</span><span class="entity">n2</span><span class="main">,</span><span class="entity">T2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">tdt</span><span class="main">,</span><span class="entity">dt</span><span class="main">)</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n1</span> <span class="main">=</span> <span class="entity">n2</span> <span class="keyword2"><span class="keyword">then</span></span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">T</span><span class="main">,</span><span class="entity">tdt</span><span class="main">)</span> <span class="main">=</span> <span class="entity">anti_unifyT</span> <span class="main">(</span><span class="entity">T1</span><span class="main">,</span><span class="entity">T2</span><span class="main">)</span> <span class="entity">tdt</span>
          <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span>Free <span class="main">(</span><span class="entity">n1</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">tdt</span><span class="main">,</span><span class="entity">dt</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
        <span class="keyword2"><span class="keyword">else</span></span>
          <span class="entity">var_pair</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">tdt</span><span class="main">,</span><span class="entity">dt</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">anti_unify_env</span> <span class="main">(</span><span class="entity">p</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span>Const <span class="main">(</span><span class="entity">n1</span><span class="main">,</span><span class="entity">T1</span><span class="main">)</span><span class="main">,</span> Const <span class="main">(</span><span class="entity">n2</span><span class="main">,</span><span class="entity">T2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">tdt</span><span class="main">,</span><span class="entity">dt</span><span class="main">)</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n1</span> <span class="main">=</span> <span class="entity">n2</span> <span class="keyword2"><span class="keyword">then</span></span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">T</span><span class="main">,</span><span class="entity">tdt</span><span class="main">)</span> <span class="main">=</span> <span class="entity">anti_unifyT</span> <span class="main">(</span><span class="entity">T1</span><span class="main">,</span><span class="entity">T2</span><span class="main">)</span> <span class="entity">tdt</span>
          <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span>Const <span class="main">(</span><span class="entity">n1</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">tdt</span><span class="main">,</span><span class="entity">dt</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
        <span class="keyword2"><span class="keyword">else</span></span>
          <span class="entity">var_pair</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">tdt</span><span class="main">,</span><span class="entity">dt</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">anti_unify_env</span> <span class="main">(</span><span class="entity">p</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">f1</span>$<span class="entity">x1</span><span class="main">,</span><span class="entity">f2</span>$<span class="entity">x2</span><span class="main">)</span><span class="main">)</span> <span class="entity">dtp</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">dtp</span><span class="main">)</span> <span class="main">=</span> <span class="entity">anti_unify_env</span> <span class="main">(</span><span class="entity">f1</span><span class="main">,</span><span class="entity">f2</span><span class="main">)</span> <span class="entity">dtp</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="keyword2"><span class="keyword">if</span></span> is_Var <span class="entity">f</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="entity">var_pair</span> <span class="entity">p</span> <span class="entity">dtp</span>
          <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">dtp</span><span class="main">)</span> <span class="main">=</span> <span class="entity">anti_unify_env</span> <span class="main">(</span><span class="entity">x1</span><span class="main">,</span><span class="entity">x2</span><span class="main">)</span> <span class="entity">dtp</span>
          <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">f</span>$<span class="entity">x</span><span class="main">,</span><span class="entity">dtp</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
        <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> <span class="entity">anti_unify_env</span> <span class="entity">p</span> <span class="entity">dtp</span> <span class="main">=</span> <span class="entity">var_pair</span> <span class="entity">p</span> <span class="entity">dtp</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">anti_unify</span> <span class="entity">p</span> <span class="main">=</span> <span class="entity">anti_unify_env</span> <span class="entity">p</span> <span class="entity">empty</span> |&gt; <span class="main">#</span><span class="inner_numeral">1</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">anti_unify_list</span> <span class="entity">l</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">f</span> <span class="main">[</span><span class="main">]</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"anti_unify_list: Empty"</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">f</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span> <span class="entity">dt</span> <span class="main">=</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="entity">dt</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">t1</span>::<span class="entity">t2</span>::<span class="entity">ts</span><span class="main">)</span> <span class="entity">dt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="entity">dt</span><span class="main">)</span> <span class="main">=</span> <span class="entity">anti_unify_env</span> <span class="main">(</span><span class="entity">t1</span><span class="main">,</span><span class="entity">t2</span><span class="main">)</span> <span class="entity">dt</span>
          <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">f</span> <span class="main">(</span><span class="entity">t</span>::<span class="entity">ts</span><span class="main">)</span> <span class="entity">dt</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">f</span> <span class="entity">l</span> <span class="entity">empty</span> |&gt; <span class="main">#</span><span class="inner_numeral">1</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword2"><span class="keyword">local</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">specialize_aux_tac</span> <span class="entity">ctxt</span> <span class="entity">get_candidates</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">maxidx</span> <span class="main">=</span> Thm.maxidx_of <span class="entity">st</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">concl</span> <span class="main">=</span> Logic.concl_of_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pre_candidates</span> <span class="main">=</span> <span class="entity">get_candidates</span> <span class="entity">concl</span>
          |&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span>
               <span class="keyword2"><span class="keyword">let</span></span>
                 <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tidx</span> <span class="main">=</span> Thm.maxidx_of <span class="entity">thm</span>
                 <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> Thm.incr_indexes <span class="main">(</span><span class="entity">maxidx</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">thm</span> |&gt; Thm.concl_of
               <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">maxidx</span> + <span class="entity">tidx</span> + <span class="inner_numeral">1</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>

        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unifies</span> <span class="main">(</span><span class="entity">idx</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span>
          <span class="main">=</span> can <span class="main">(</span>Pattern.unify <span class="main">(</span>Context.Proof <span class="entity">ctxt</span><span class="main">)</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="entity">concl</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Envir.empty <span class="entity">idx</span><span class="main">)</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">candidates</span> <span class="main">=</span> filter <span class="entity">unifies</span> <span class="entity">pre_candidates</span> |&gt; map <span class="main">#</span><span class="inner_numeral">2</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">candidates</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> Seq.single <span class="entity">st</span>
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pattern</span> <span class="main">=</span> <span class="entity">anti_unify_list</span> <span class="entity">candidates</span>
              |&gt; Thm.cterm_of <span class="entity">ctxt</span> |&gt; Thm.trivial
          <span class="keyword2"><span class="keyword">in</span></span>
            resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">pattern</span><span class="main">]</span> <span class="entity">i</span> <span class="entity">st</span>
          <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">specialize_tac</span> <span class="entity">ctxt</span> <span class="entity">thms</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_candidates</span> <span class="entity">concl</span> <span class="main">=</span>
          filter <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> Term.could_unify <span class="main">(</span>Thm.concl_of <span class="entity">thm</span><span class="main">,</span> <span class="entity">concl</span><span class="main">)</span><span class="main">)</span> <span class="entity">thms</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">specialize_aux_tac</span> <span class="entity">ctxt</span> <span class="entity">get_candidates</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">specialize_net_tac</span> <span class="entity">ctxt</span> <span class="entity">net</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_candidates</span> <span class="entity">concl</span> <span class="main">=</span> Net.unify_term <span class="entity">net</span> <span class="entity">concl</span> |&gt; map <span class="main">#</span><span class="inner_numeral">2</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">specialize_aux_tac</span> <span class="entity">ctxt</span> <span class="entity">get_candidates</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">end</span></span>



  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Misc">
<div class="head">
<h1>Theory Misc</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Miscellaneous Definitions and Lemmas
    Author:      Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
    Maintainer:  Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
                 Thomas Tuerk &lt;tuerk@in.tum.de&gt;
*)</span>

<span class="comment1">(*
  CHANGELOG:
    2010-05-09: Removed AC, AI locales, they are superseeded by concepts
                  from OrderedGroups
    2010-09-22: Merges with ext/Aux
    2017-06-12: Added a bunch of lemmas from various other projects

*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Miscellaneous Definitions and Lemmas›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Misc
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-ex/Quicksort.html">HOL-ex.Quicksort</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Option_ord.html">HOL-Library.Option_ord</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Infinite_Set.html">HOL-Library.Infinite_Set</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Eisbach/Eisbach.html">HOL-Eisbach.Eisbach</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{thy:Misc}›</span></span>

  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Isabelle Distribution Move Proposals›</span></span>  

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pure›</span></span>  
<span class="keyword1" id="Misc-TERMI"><span class="command">lemma</span></span> TERMI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Pure.term_def <span class="keyword1"><span class="command">.</span></span>
  
  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹HOL›</span></span>  
<span class="comment1">(* Stronger disjunction elimination rules. *)</span>
<span class="keyword1" id="Misc-disjE1"><span class="command">lemma</span></span> disjE1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">∨</span> <span class="free">Q</span><span class="main">;</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">R</span><span class="main">;</span> <span class="main">⟦</span><span class="main">¬</span><span class="free">P</span><span class="main">;</span><span class="free">Q</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1" id="Misc-disjE2"><span class="command">lemma</span></span> disjE2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">∨</span> <span class="free">Q</span><span class="main">;</span> <span class="main">⟦</span><span class="free">P</span><span class="main">;</span> <span class="main">¬</span><span class="free">Q</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">R</span><span class="main">;</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Misc-imp_mp_iff"><span class="command">lemma</span></span> imp_mp_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∧</span> <span class="main">(</span><span class="free">a</span> <span class="main">⟶</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">b</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">⟶</span> <span class="free">b</span><span class="main">)</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">b</span>"</span></span> <span class="comment1">(* is Inductive.imp_conj_iff, but not in simpset by default *)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    
<span class="keyword1" id="Misc-atomize_Trueprop_eq"><span class="command">lemma</span></span> atomize_Trueprop_eq<span class="main">[</span><span class="operator">atomize</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Trueprop <span class="free">x</span> <span class="main">≡</span> Trueprop <span class="free">y</span><span class="main">)</span> <span class="main">≡</span> Trueprop <span class="main">(</span><span class="free">x</span><span class="main">=</span><span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> equal_elim_rule1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> equal_elim_rule2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Set›</span></span>    
<span class="keyword1" id="Misc-inter_compl_diff_conv"><span class="command">lemma</span></span> inter_compl_diff_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="main">-</span><span class="free">B</span> <span class="main">=</span> <span class="free">A</span> <span class="main">-</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="Misc-pair_set_inverse"><span class="command">lemma</span></span> pair_set_inverse<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span><span class="main">¯</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-card_doubleton_eq_2_iff"><span class="command">lemma</span></span> card_doubleton_eq_2_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">}</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⟷</span> <span class="free">a</span><span class="main">≠</span><span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹List›</span></span>  
<span class="comment1">(* TODO: Move, analogous to List.length_greater_0_conv *)</span> 
<span class="keyword1"><span class="command">thm</span></span> List.length_greater_0_conv  
<span class="keyword1" id="Misc-length_ge_1_conv"><span class="command">lemma</span></span> length_ge_1_conv<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">≤</span> length <span class="free">l</span> <span class="main">⟷</span> <span class="free">l</span><span class="main">≠</span><span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>
  
<span class="comment1">― ‹Obtains a list from the pointwise characterization of its elements›</span>
<span class="keyword1" id="Misc-obtain_list_from_elements"><span class="command">lemma</span></span> obtain_list_from_elements<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">li</span><span class="main">.</span> <span class="free">P</span> <span class="bound">li</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">l</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="bound">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span><span class="main">=</span><span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">l</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="free">P</span><span class="main">(</span><span class="skolem">l</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ln</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">ln</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">l</span><span class="main">@</span><span class="main">[</span><span class="skolem">ln</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="free">P</span><span class="main">(</span><span class="main">(</span><span class="skolem">l</span><span class="main">@</span><span class="main">[</span><span class="skolem">ln</span><span class="main">]</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_antisym<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="Misc-distinct_sorted_mono"><span class="command">lemma</span></span> distinct_sorted_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span>length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">!</span><span class="free">i</span> <span class="main">&lt;</span> <span class="free">l</span><span class="main">!</span><span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> S B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">!</span><span class="free">i</span> <span class="main">≤</span> <span class="free">l</span><span class="main">!</span><span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_iff_nth_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> nth_eq_iff_index_eq<span class="main">[</span><span class="operator">OF</span> D<span class="main">]</span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">!</span><span class="free">i</span> <span class="main">≠</span> <span class="free">l</span><span class="main">!</span><span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-distinct_sorted_strict_mono_iff"><span class="command">lemma</span></span> distinct_sorted_strict_mono_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"sorted <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span>length <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span>length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">!</span><span class="free">i</span><span class="main">&lt;</span><span class="free">l</span><span class="main">!</span><span class="free">j</span> <span class="main">⟷</span> <span class="free">i</span><span class="main">&lt;</span><span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct_sorted_mono leI less_le_not_le
    order.strict_iff_order<span class="main">)</span>

<span class="keyword1" id="Misc-distinct_sorted_mono_iff"><span class="command">lemma</span></span> distinct_sorted_mono_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"sorted <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span>length <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span>length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">!</span><span class="free">i</span><span class="main">≤</span><span class="free">l</span><span class="main">!</span><span class="free">j</span> <span class="main">⟷</span> <span class="free">i</span><span class="main">≤</span><span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms distinct_sorted_strict_mono_iff leD le_less_linear<span class="main">)</span>
  
    
<span class="comment1">(* List.thy has:
 declare map_eq_Cons_D [dest!]  Cons_eq_map_D [dest!] 

  We could, analogously, declare rules for "map _ _ = _@_" as dest!,
  or use elim!, or declare the _conv-rule as simp
*)</span>  
   
<span class="keyword1" id="Misc-map_eq_appendE"><span class="command">lemma</span></span> map_eq_appendE<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="free">ls</span> <span class="main">=</span> <span class="free">fl</span><span class="main">@</span><span class="free">fl'</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">l</span> <span class="free">l'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ls</span><span class="main">=</span><span class="free">l</span><span class="main">@</span><span class="free">l'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="free">l</span><span class="main">=</span><span class="free">fl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="free">l'</span> <span class="main">=</span> <span class="free">fl'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms  
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">fl</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ls</span></span> <span class="quoted"><span class="free">thesis</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">ls'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ls</span> <span class="main">=</span> <span class="skolem">l</span><span class="main">#</span><span class="skolem">ls'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="skolem">ls'</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="free">fl'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> ll ll' <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">with</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">#</span><span class="skolem">ll</span>"</span></span> <span class="quoted"><span class="skolem">ll'</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="skolem">thesis</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-map_eq_append_conv"><span class="command">lemma</span></span> map_eq_append_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="free">ls</span> <span class="main">=</span> <span class="free">fl</span><span class="main">@</span><span class="free">fl'</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">l</span> <span class="bound">l'</span><span class="main">.</span> <span class="free">ls</span> <span class="main">=</span> <span class="bound">l</span><span class="main">@</span><span class="bound">l'</span> <span class="main">∧</span> map <span class="free">f</span> <span class="bound">l</span> <span class="main">=</span> <span class="free">fl</span> <span class="main">∧</span> map <span class="free">f</span> <span class="bound">l'</span> <span class="main">=</span> <span class="free">fl'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_eq_appendE<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemmas</span></span> append_eq_mapE <span class="main">=</span> map_eq_appendE<span class="main">[</span><span class="operator">OF</span> sym<span class="main">]</span>
  
<span class="keyword1" id="Misc-append_eq_map_conv"><span class="command">lemma</span></span> append_eq_map_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fl</span><span class="main">@</span><span class="free">fl'</span> <span class="main">=</span> map <span class="free">f</span> <span class="free">ls</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">l</span> <span class="bound">l'</span><span class="main">.</span> <span class="free">ls</span> <span class="main">=</span> <span class="bound">l</span><span class="main">@</span><span class="bound">l'</span> <span class="main">∧</span> map <span class="free">f</span> <span class="bound">l</span> <span class="main">=</span> <span class="free">fl</span> <span class="main">∧</span> map <span class="free">f</span> <span class="bound">l'</span> <span class="main">=</span> <span class="free">fl'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> append_eq_mapE<span class="main">)</span>
  
  
<span class="keyword1" id="Misc-distinct_mapI"><span class="command">lemma</span></span> distinct_mapI<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map <span class="free">f</span> <span class="free">l</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>
    
<span class="keyword1" id="Misc-map_distinct_upd_conv"><span class="command">lemma</span></span> map_distinct_upd_conv<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">i</span><span class="main">&lt;</span>length <span class="free">l</span><span class="main">;</span> distinct <span class="free">l</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">l</span><span class="main">)</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> map <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="free">i</span> <span class="main">:=</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span>"</span></span>
  <span class="comment1">― ‹Updating a mapped distinct list is equal to updating the 
    mapping function›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_eq_iff_index_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>

    
<span class="keyword1" id="Misc-zip_inj"><span class="command">lemma</span></span> zip_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>length <span class="free">a</span> <span class="main">=</span> length <span class="free">b</span><span class="main">;</span> length <span class="free">a'</span> <span class="main">=</span> length <span class="free">b'</span><span class="main">;</span> zip <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> zip <span class="free">a'</span> <span class="free">b'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">=</span><span class="free">a'</span> <span class="main">∧</span> <span class="free">b</span><span class="main">=</span><span class="free">b'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a'</span></span> <span class="quoted"><span class="free">b'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">b'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">b'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-zip_eq_zip_same_len"><span class="command">lemma</span></span> zip_eq_zip_same_len<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> length <span class="free">a</span> <span class="main">=</span> length <span class="free">b</span><span class="main">;</span> length <span class="free">a'</span> <span class="main">=</span> length <span class="free">b'</span> <span class="main">⟧</span> <span class="main">⟹</span>
  zip <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> zip <span class="free">a'</span> <span class="free">b'</span> <span class="main">⟷</span> <span class="free">a</span><span class="main">=</span><span class="free">a'</span> <span class="main">∧</span> <span class="free">b</span><span class="main">=</span><span class="free">b'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> zip_inj<span class="main">)</span>
    
    
<span class="keyword1" id="Misc-upt_merge"><span class="command">lemma</span></span> upt_merge<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≤</span><span class="free">j</span> <span class="main">∧</span> <span class="free">j</span><span class="main">≤</span><span class="free">k</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span><span class="main">@</span><span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_Suc_ex upt_add_eq_append<span class="main">)</span>
  
<span class="comment1">(* Maybe this should go into List.thy, next to snoc_eq_iff_butlast *)</span>
<span class="keyword1" id="Misc-snoc_eq_iff_butlast'"><span class="command">lemma</span></span> snoc_eq_iff_butlast'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> butlast <span class="free">ys</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">∧</span> last <span class="free">ys</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* Case distinction how two elements of a list can be related to each other *)</span>
<span class="keyword1" id="Misc-list_match_lel_lel"><span class="command">lemma</span></span> list_match_lel_lel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">@</span> <span class="free">qs</span> <span class="main">#</span> <span class="free">c2</span> <span class="main">=</span> <span class="free">c1'</span> <span class="main">@</span> <span class="free">qs'</span> <span class="main">#</span> <span class="free">c2'</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span>
    <span class="main">(</span>left<span class="main">)</span> <span class="free">c21'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">=</span> <span class="free">c1'</span> <span class="main">@</span> <span class="free">qs'</span> <span class="main">#</span> <span class="free">c21'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2'</span> <span class="main">=</span> <span class="free">c21'</span> <span class="main">@</span> <span class="free">qs</span> <span class="main">#</span> <span class="free">c2</span>"</span></span>
  <span class="main">|</span> <span class="main">(</span>center<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">c1'</span> <span class="main">=</span> <span class="free">c1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">qs'</span> <span class="main">=</span> <span class="free">qs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2'</span> <span class="main">=</span> <span class="free">c2</span>"</span></span>
  <span class="main">|</span> <span class="main">(</span>right<span class="main">)</span> <span class="free">c21</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c1'</span> <span class="main">=</span> <span class="free">c1</span> <span class="main">@</span> <span class="free">qs</span> <span class="main">#</span> <span class="free">c21</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="main">=</span> <span class="free">c21</span> <span class="main">@</span> <span class="free">qs'</span> <span class="main">#</span> <span class="free">c2'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> append_eq_append_conv2<span class="main">)</span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> us <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">us</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>    
    
<span class="keyword1" id="Misc-xy_in_set_cases"><span class="command">lemma</span></span> xy_in_set_cases<span class="main">[</span><span class="operator">consumes</span> 2<span class="main">,</span> <span class="operator">case_names</span> EQ XY YX<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span>set <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">∈</span>set <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">l1</span> <span class="bound">l2</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">x</span><span class="main">=</span><span class="free">y</span><span class="main">;</span> <span class="free">l</span><span class="main">=</span><span class="bound">l1</span><span class="main">@</span><span class="free">y</span><span class="main">#</span><span class="bound">l2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">l1</span> <span class="bound">l2</span> <span class="bound">l3</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">x</span><span class="main">≠</span><span class="free">y</span><span class="main">;</span> <span class="free">l</span><span class="main">=</span><span class="bound">l1</span><span class="main">@</span><span class="free">x</span><span class="main">#</span><span class="bound">l2</span><span class="main">@</span><span class="free">y</span><span class="main">#</span><span class="bound">l3</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">l1</span> <span class="bound">l2</span> <span class="bound">l3</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">x</span><span class="main">≠</span><span class="free">y</span><span class="main">;</span> <span class="free">l</span><span class="main">=</span><span class="bound">l1</span><span class="main">@</span><span class="free">y</span><span class="main">#</span><span class="bound">l2</span><span class="main">@</span><span class="free">x</span><span class="main">#</span><span class="bound">l3</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span><span class="free">y</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> A<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">l2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">=</span><span class="skolem">l1</span><span class="main">@</span><span class="free">y</span><span class="main">#</span><span class="skolem">l2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> split_list<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> C<span class="main">(</span>1<span class="main">)</span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> A<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">l2</span></span> <span class="keyword2"><span class="keyword">where</span></span> S1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">=</span><span class="skolem">l1</span><span class="main">@</span><span class="free">x</span><span class="main">#</span><span class="skolem">l2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> split_list<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> A<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1'</span></span> <span class="skolem"><span class="skolem">l2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> S2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">=</span><span class="skolem">l1'</span><span class="main">@</span><span class="free">y</span><span class="main">#</span><span class="skolem">l2'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> split_list<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> S1 S2 <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l1</span><span class="main">@</span><span class="free">x</span><span class="main">#</span><span class="skolem">l2</span> <span class="main">=</span> <span class="skolem">l1'</span><span class="main">@</span><span class="free">y</span><span class="main">#</span><span class="skolem">l2'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_match_lel_lel<span class="main"><span class="main">[</span></span><span class="operator">consumes</span> 1<span class="main"><span class="main">,</span></span> <span class="operator">case_names</span> 1 2 3<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">c</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> S1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">=</span><span class="skolem">l1'</span><span class="main">@</span><span class="free">y</span><span class="main">#</span><span class="skolem">c</span><span class="main">@</span><span class="free">x</span><span class="main">#</span><span class="skolem">l2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> C<span class="main">(</span>3<span class="main">)</span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">c</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> S1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">=</span><span class="skolem">l1</span><span class="main">@</span><span class="free">x</span><span class="main">#</span><span class="skolem">c</span><span class="main">@</span><span class="free">y</span><span class="main">#</span><span class="skolem">l2'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> C<span class="main">(</span>2<span class="main">)</span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
    
    
<span class="keyword1" id="Misc-list_e_eq_lel"><span class="command">lemma</span></span> list_e_eq_lel<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">=</span> <span class="free">l1</span><span class="main">@</span><span class="free">e'</span><span class="main">#</span><span class="free">l2</span> <span class="main">⟷</span> <span class="free">l1</span><span class="main">=</span><span class="main">[]</span> <span class="main">∧</span> <span class="free">e'</span><span class="main">=</span><span class="free">e</span> <span class="main">∧</span> <span class="free">l2</span><span class="main">=</span><span class="main">[]</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1</span><span class="main">@</span><span class="free">e'</span><span class="main">#</span><span class="free">l2</span> <span class="main">=</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">⟷</span> <span class="free">l1</span><span class="main">=</span><span class="main">[]</span> <span class="main">∧</span> <span class="free">e'</span><span class="main">=</span><span class="free">e</span> <span class="main">∧</span> <span class="free">l2</span><span class="main">=</span><span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-list_ee_eq_leel"><span class="command">lemma</span></span> list_ee_eq_leel<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">e1</span><span class="main">,</span><span class="free">e2</span><span class="main">]</span> <span class="main">=</span> <span class="free">l1</span><span class="main">@</span><span class="free">e1'</span><span class="main">#</span><span class="free">e2'</span><span class="main">#</span><span class="free">l2</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">l1</span><span class="main">=</span><span class="main">[]</span> <span class="main">∧</span> <span class="free">e1</span><span class="main">=</span><span class="free">e1'</span> <span class="main">∧</span> <span class="free">e2</span><span class="main">=</span><span class="free">e2'</span> <span class="main">∧</span> <span class="free">l2</span><span class="main">=</span><span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l1</span><span class="main">@</span><span class="free">e1'</span><span class="main">#</span><span class="free">e2'</span><span class="main">#</span><span class="free">l2</span> <span class="main">=</span> <span class="main">[</span><span class="free">e1</span><span class="main">,</span><span class="free">e2</span><span class="main">]</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">l1</span><span class="main">=</span><span class="main">[]</span> <span class="main">∧</span> <span class="free">e1</span><span class="main">=</span><span class="free">e1'</span> <span class="main">∧</span> <span class="free">e2</span><span class="main">=</span><span class="free">e2'</span> <span class="main">∧</span> <span class="free">l2</span><span class="main">=</span><span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Transitive Closure›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A point-free induction rule for elements reachable from an initial set›</span></span>
<span class="keyword1" id="Misc-rtrancl_reachable_induct"><span class="command">lemma</span></span> rtrancl_reachable_induct<span class="main">[</span><span class="operator">consumes</span> 0<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="free">INV</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span><span class="main">``</span><span class="free">INV</span> <span class="main">⊆</span> <span class="free">INV</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="free">I</span> <span class="main">⊆</span> <span class="free">INV</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> I0 IS Image_closed_trancl Image_mono subset_refl<span class="main">)</span>
  

<span class="keyword1" id="Misc-acyclic_empty"><span class="command">lemma</span></span> acyclic_empty<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"acyclic <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> acyclic_def<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-acyclic_union"><span class="command">lemma</span></span> acyclic_union<span class="main">:</span>
  <span class="quoted"><span class="quoted">"acyclic <span class="main">(</span><span class="free">A</span><span class="main">∪</span><span class="free">B</span><span class="main">)</span> <span class="main">⟹</span> acyclic <span class="free">A</span>"</span></span>
  <span class="quoted"><span class="quoted">"acyclic <span class="main">(</span><span class="free">A</span><span class="main">∪</span><span class="free">B</span><span class="main">)</span> <span class="main">⟹</span> acyclic <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_upper1 Un_upper2 acyclic_subset<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    
    
    
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lattice Syntax›</span></span>    
<span class="comment1">(* Providing the syntax in a locale makes it more usable, without polluting the global namespace*)</span>    
<span class="keyword1"><span class="command">locale</span></span> Lattice_Syntax <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">notation</span></span>
    bot <span class="main">(</span><span class="quoted">"<span class="keyword1">⊥</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    top <span class="main">(</span><span class="quoted">"<span class="keyword1">⊤</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    inf  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊓</span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    sup  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊔</span>"</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    Inf  <span class="main">(</span><span class="quoted">"<span class="keyword1">⨅</span>_"</span> <span class="main">[</span>900<span class="main">]</span> 900<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    Sup  <span class="main">(</span><span class="quoted">"<span class="keyword1">⨆</span>_"</span> <span class="main">[</span>900<span class="main">]</span> 900<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
    
    
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Here we provide a collection of miscellaneous definitions and helper lemmas›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Miscellaneous (1)"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This stuff is used in this theory itself, and thus occurs in first place or is simply not sorted into any other section of this theory.›</span></span>

<span class="keyword1" id="Misc-IdD"><span class="command">lemma</span></span> IdD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span>Id <span class="main">⟹</span> <span class="free">a</span><span class="main">=</span><span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Conversion Tag›</span></span>    
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CNV</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="keyword1" id="Misc-CNV_I"><span class="command">lemma</span></span> CNV_I<span class="main">:</span> <span class="quoted"><span class="quoted">"CNV <span class="free">x</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1" id="Misc-CNV_eqD"><span class="command">lemma</span></span> CNV_eqD<span class="main">:</span> <span class="quoted"><span class="quoted">"CNV <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">=</span><span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1" id="Misc-CNV_meqD"><span class="command">lemma</span></span> CNV_meqD<span class="main">:</span> <span class="quoted"><span class="quoted">"CNV <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">≡</span><span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
   
<span class="comment1">(* TODO: Move. Shouldn't this be detected by simproc? *)</span>
<span class="keyword1" id="Misc-ex_b_b_and_simp"><span class="command">lemma</span></span> ex_b_b_and_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">Q</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="Misc-ex_b_not_b_and_simp"><span class="command">lemma</span></span> ex_b_not_b_and_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span><span class="bound">b</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">Q</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
<span class="keyword1"><span class="command">method</span></span> repeat_all_new <span class="keyword2"><span class="keyword">methods</span></span> m <span class="main">=</span> <span class="operator">m</span><span class="main"><span class="keyword3">;</span></span><span class="main">(</span><span class="operator">repeat_all_new</span> <span class="quoted">‹<span class="operator">m</span>›</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span>
    
    
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"AC-operators"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Locale to declare AC-laws as simplification rules›</span></span>
<span class="keyword1"><span class="command">locale</span></span> Assoc <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> assoc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span> <span class="main">(</span><span class="free">f</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> AC <span class="main">=</span> Assoc <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> commute<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="free">f</span> <span class="free">y</span> <span class="free">x</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> AC<span class="main">)</span> left_commute<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">(</span><span class="free">f</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">y</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> AC<span class="main">)</span> AC_simps <span class="main">=</span> commute assoc left_commute

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Locale to define functions from surjective, unique relations›</span></span>
<span class="keyword1"><span class="command">locale</span></span> su_rel_fun <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> unique<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">)</span><span class="main">∈</span><span class="free">F</span><span class="main">;</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">B'</span><span class="main">)</span><span class="main">∈</span><span class="free">F</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">B</span><span class="main">=</span><span class="free">B'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> surjective<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">!!</span><span class="bound">B</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="bound">B</span><span class="main">)</span><span class="main">∈</span><span class="free">F</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">A</span> <span class="main">==</span> <span class="keyword1">THE</span> <span class="bound">B</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="bound">B</span><span class="main">)</span><span class="main">∈</span><span class="free">F</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> su_rel_fun<span class="main">)</span> repr1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">f</span> <span class="free">A</span><span class="main">)</span><span class="main">∈</span><span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> f_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="skolem">B</span><span class="main">)</span><span class="main">∈</span><span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> surjective<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> theI<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">B</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="bound">B</span><span class="main">)</span><span class="main">∈</span><span class="free">F</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="keyword1">THE</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> unique<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> su_rel_fun<span class="main">)</span> repr2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">)</span><span class="main">∈</span><span class="free">F</span> <span class="main">⟹</span> <span class="free">B</span><span class="main">=</span><span class="free">f</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> repr1
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> unique<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> su_rel_fun<span class="main">)</span> repr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">)</span><span class="main">∈</span><span class="free">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> repr1 repr2
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

    <span class="comment1">― ‹Contract quantification over two variables to pair›</span>
<span class="keyword1" id="Misc-Ex_prod_contract"><span class="command">lemma</span></span> Ex_prod_contract<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>fst <span class="bound">z</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-All_prod_contract"><span class="command">lemma</span></span> All_prod_contract<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">z</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>fst <span class="bound">z</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1" id="Misc-nat_geq_1_eq_neqz"><span class="command">lemma</span></span> nat_geq_1_eq_neqz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">≥</span><span class="main">1</span> <span class="main">⟷</span> <span class="free">x</span><span class="main">≠</span><span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-nat_in_between_eq"><span class="command">lemma</span></span> nat_in_between_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">&lt;</span><span class="free">b</span> <span class="main">∧</span> <span class="free">b</span><span class="main">≤</span>Suc <span class="free">a</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">=</span> Suc <span class="free">a</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">≤</span><span class="free">b</span> <span class="main">∧</span> <span class="free">b</span><span class="main">&lt;</span>Suc <span class="free">a</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-Suc_n_minus_m_eq"><span class="command">lemma</span></span> Suc_n_minus_m_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">n</span><span class="main">≥</span><span class="free">m</span><span class="main">;</span> <span class="free">m</span><span class="main">&gt;</span><span class="main">1</span> <span class="main">⟧</span> <span class="main">⟹</span> Suc <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-Suc_to_right"><span class="command">lemma</span></span> Suc_to_right<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span> <span class="main">=</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">=</span> <span class="free">m</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1" id="Misc-Suc_diff"><span class="command">lemma</span></span> Suc_diff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">n</span><span class="main">≥</span><span class="bound">m</span> <span class="main">⟹</span> <span class="bound">m</span><span class="main">≥</span><span class="main">1</span> <span class="main">⟹</span> Suc <span class="main">(</span><span class="bound">n</span> <span class="main">-</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> <span class="bound">n</span> <span class="main">-</span> <span class="main">(</span><span class="bound">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-if_not_swap"><span class="command">lemma</span></span> if_not_swap<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="main">¬</span><span class="free">c</span> <span class="keyword1">then</span> <span class="free">a</span> <span class="keyword1">else</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">c</span> <span class="keyword1">then</span> <span class="free">b</span> <span class="keyword1">else</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="Misc-all_to_meta"><span class="command">lemma</span></span> all_to_meta<span class="main">:</span> <span class="quoted"><span class="quoted">"Trueprop <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-imp_to_meta"><span class="command">lemma</span></span> imp_to_meta<span class="main">:</span> <span class="quoted"><span class="quoted">"Trueprop <span class="main">(</span><span class="free">P</span><span class="main">⟶</span><span class="free">Q</span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="free">P</span><span class="main">⟹</span><span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="comment1">(* for some reason, there is no such rule in HOL *)</span>
<span class="keyword1" id="Misc-iffI2"><span class="command">lemma</span></span> iffI2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">P</span> <span class="main">⟹</span> <span class="free">Q</span><span class="main">;</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">Q</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟷</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Misc-iffExI"><span class="command">lemma</span></span> iffExI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Misc-bex2I"><span class="command">lemma</span></span> bex2I<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span><span class="main">;</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    
<span class="comment1">(* TODO: Move lemma to HOL! *)</span>  
<span class="keyword1" id="Misc-cnv_conj_to_meta"><span class="command">lemma</span></span> cnv_conj_to_meta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">∧</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="keyword1">PROP</span> <span class="free">X</span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⟦</span><span class="free">P</span><span class="main">;</span><span class="free">Q</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="keyword1">PROP</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> BNF_Fixpoint_Base.conj_imp_eq_imp_imp<span class="main">)</span>
    
    

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sets›</span></span>
  <span class="keyword1" id="Misc-remove_subset"><span class="command">lemma</span></span> remove_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⊂</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Misc-subset_minus_empty"><span class="command">lemma</span></span> subset_minus_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">⊆</span><span class="free">B</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">-</span><span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Misc-insert_minus_eq"><span class="command">lemma</span></span> insert_minus_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">≠</span><span class="free">y</span> <span class="main">⟹</span> insert <span class="free">x</span> <span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
  <span class="keyword1" id="Misc-set_notEmptyE"><span class="command">lemma</span></span> set_notEmptyE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">S</span><span class="main">≠</span><span class="main">{}</span><span class="main">;</span> <span class="main">!!</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> equals0I<span class="main">)</span>

  <span class="keyword1" id="Misc-subset_Collect_conv"><span class="command">lemma</span></span> subset_Collect_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> Collect <span class="free">P</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Misc-memb_imp_not_empty"><span class="command">lemma</span></span> memb_imp_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="free">S</span><span class="main">≠</span><span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Misc-disjoint_mono"><span class="command">lemma</span></span> disjoint_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span><span class="main">⊆</span><span class="free">a'</span><span class="main">;</span> <span class="free">b</span><span class="main">⊆</span><span class="free">b'</span><span class="main">;</span> <span class="free">a'</span><span class="main">∩</span><span class="free">b'</span><span class="main">=</span><span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">∩</span><span class="free">b</span><span class="main">=</span><span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Misc-disjoint_alt_simp1"><span class="command">lemma</span></span> disjoint_alt_simp1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">-</span><span class="free">B</span> <span class="main">=</span> <span class="free">A</span> <span class="main">⟷</span> <span class="free">A</span><span class="main">∩</span><span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Misc-disjoint_alt_simp2"><span class="command">lemma</span></span> disjoint_alt_simp2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">-</span><span class="free">B</span> <span class="main">≠</span> <span class="free">A</span> <span class="main">⟷</span> <span class="free">A</span><span class="main">∩</span><span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Misc-disjoint_alt_simp3"><span class="command">lemma</span></span> disjoint_alt_simp3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">-</span><span class="free">B</span> <span class="main">⊂</span> <span class="free">A</span> <span class="main">⟷</span> <span class="free">A</span><span class="main">∩</span><span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Misc-disjointI"><span class="command">lemma</span></span> disjointI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span><span class="main">∈</span><span class="free">a</span><span class="main">;</span> <span class="bound">x</span><span class="main">∈</span><span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> False <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">∩</span><span class="free">b</span><span class="main">=</span><span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


  <span class="keyword1"><span class="command">lemmas</span></span> set_simps <span class="main">=</span> subset_minus_empty disjoint_alt_simp1 disjoint_alt_simp2 disjoint_alt_simp3 Un_absorb1 Un_absorb2

  <span class="keyword1" id="Misc-set_minus_singleton_eq"><span class="command">lemma</span></span> set_minus_singleton_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∉</span><span class="free">X</span> <span class="main">⟹</span> <span class="free">X</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Misc-set_diff_diff_left"><span class="command">lemma</span></span> set_diff_diff_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">-</span><span class="free">B</span><span class="main">-</span><span class="free">C</span> <span class="main">=</span> <span class="free">A</span><span class="main">-</span><span class="main">(</span><span class="free">B</span><span class="main">∪</span><span class="free">C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


  <span class="keyword1" id="Misc-image_update"><span class="command">lemma</span></span> image_update<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∉</span><span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">n</span><span class="main">)</span><span class="main">`</span><span class="free">A</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Misc-eq_or_mem_image_simp"><span class="command">lemma</span></span> eq_or_mem_image_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">f</span> <span class="bound">l</span> <span class="main">|</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∨</span> <span class="bound">l</span><span class="main">∈</span><span class="free">B</span><span class="main">}</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">{</span><span class="free">f</span> <span class="bound">l</span><span class="main">|</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span><span class="main">∈</span><span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      
  <span class="keyword1" id="Misc-set_union_code"><span class="command">lemma</span></span> set_union_code <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">ys</span> <span class="main">=</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Misc-in_fst_imageE"><span class="command">lemma</span></span> in_fst_imageE<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> fst<span class="main">`</span><span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Misc-in_snd_imageE"><span class="command">lemma</span></span> in_snd_imageE<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> snd<span class="main">`</span><span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Misc-fst_image_mp"><span class="command">lemma</span></span> fst_image_mp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>fst<span class="main">`</span><span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">;</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span><span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Domain.DomainI fst_eq_Domain in_mono<span class="main">)</span>

  <span class="keyword1" id="Misc-snd_image_mp"><span class="command">lemma</span></span> snd_image_mp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>snd<span class="main">`</span><span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">;</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">y</span><span class="main">∈</span><span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Range.intros rev_subsetD snd_eq_Range<span class="main">)</span>

  <span class="keyword1" id="Misc-inter_eq_subsetI"><span class="command">lemma</span></span> inter_eq_subsetI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">S</span><span class="main">⊆</span><span class="free">S'</span><span class="main">;</span> <span class="free">A</span><span class="main">∩</span><span class="free">S'</span> <span class="main">=</span> <span class="free">B</span><span class="main">∩</span><span class="free">S'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">∩</span><span class="free">S</span> <span class="main">=</span> <span class="free">B</span><span class="main">∩</span><span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Decompose general union over sum types.
›</span></span>
<span class="keyword1" id="Misc-Union_plus"><span class="command">lemma</span></span> Union_plus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">&lt;+&gt;</span> <span class="free">B</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>Inl <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">b</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>Inr <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-Union_sum"><span class="command">lemma</span></span> Union_sum<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">+</span><span class="tfree">'b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">l</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>Inl <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>Inr <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span> <span class="main">∈</span> UNIV <span class="main">&lt;+&gt;</span> UNIV<span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Union_plus<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

  


  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Finite Sets›</span></span>

  <span class="keyword1" id="Misc-card_1_singletonI"><span class="command">lemma</span></span> card_1_singletonI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>finite <span class="free">S</span><span class="main">;</span> card <span class="free">S</span> <span class="main">=</span> <span class="main">1</span><span class="main">;</span> <span class="free">x</span><span class="main">∈</span><span class="free">S</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">S</span><span class="main">=</span><span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">x'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Misc-card_insert_disjoint'"><span class="command">lemma</span></span> card_insert_disjoint'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>finite <span class="free">A</span><span class="main">;</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">A</span><span class="main">⟧</span> <span class="main">⟹</span> card <span class="main">(</span>insert <span class="free">x</span> <span class="free">A</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">=</span> card <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> card_insert_disjoint<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1" id="Misc-card_eq_UNIV"><span class="command">lemma</span></span> card_eq_UNIV<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">S</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>finite set<span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⟷</span> <span class="free">S</span><span class="main">=</span>UNIV"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">S</span> <span class="main">=</span> card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∉</span><span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">⊂</span>UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> psubset_card_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted">UNIV</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">S</span> <span class="main">&lt;</span> card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Misc-card_eq_UNIV2"><span class="command">lemma</span></span> card_eq_UNIV2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="main">=</span> card <span class="main">(</span><span class="free">S</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>finite set<span class="main">)</span> <span class="main">⟷</span> <span class="free">S</span><span class="main">=</span>UNIV"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_eq_UNIV<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1" id="Misc-card_ge_UNIV"><span class="command">lemma</span></span> card_ge_UNIV<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>finite set<span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="free">S</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⟷</span> <span class="free">S</span><span class="main">=</span>UNIV"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"UNIV<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>finite set"</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemmas</span></span> length_remdups_card <span class="main">=</span> length_remdups_concat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">l</span><span class="main">]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">l</span>

  <span class="keyword1" id="Misc-fs_contract"><span class="command">lemma</span></span> fs_contract<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> <span class="main">{</span> <span class="bound">p</span> <span class="main">|</span> <span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">}</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">a</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_Collect<span class="main">)</span>

<span class="keyword1" id="Misc-finite_Collect"><span class="command">lemma</span></span> finite_Collect<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> inj <span class="free">f</span> <span class="main">⟹</span> finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">:</span> <span class="free">S</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_vimageI vimage_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="comment1">― ‹Finite sets have an injective mapping to an initial segments of the
      natural numbers›</span>
  <span class="comment1">(* This lemma is also in the standard library (from Isabelle2009-1 on)
      as @{thm [source] Finite_Set.finite_imp_inj_to_nat_seg}. However, it is formulated with HOL's
      ∃ there rather then with the meta-logic obtain *)</span>
  <span class="keyword1" id="Misc-finite_imp_inj_to_nat_seg'"><span class="command">lemma</span></span> finite_imp_inj_to_nat_seg'<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> A finite_imp_inj_to_nat_seg<span class="main">)</span>

  <span class="keyword1" id="Misc-lists_of_len_fin1"><span class="command">lemma</span></span> lists_of_len_fin1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">P</span> <span class="main">⟹</span> finite <span class="main">(</span>lists <span class="free">P</span> <span class="main">∩</span> <span class="main">{</span> <span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="free">n</span> <span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lists <span class="free">P</span> <span class="main">∩</span> <span class="main">{</span> <span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> Suc <span class="skolem">n</span> <span class="main">}</span>
          <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span><span class="main">#</span><span class="bound">l</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">P</span> <span class="main">×</span> <span class="main">(</span>lists <span class="free">P</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="skolem">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Misc-lists_of_len_fin2"><span class="command">lemma</span></span> lists_of_len_fin2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">P</span> <span class="main">⟹</span> finite <span class="main">(</span>lists <span class="free">P</span> <span class="main">∩</span> <span class="main">{</span> <span class="bound">l</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> length <span class="bound">l</span> <span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound">l</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> length <span class="bound">l</span> <span class="main">}</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="free">n</span> <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>lists <span class="free">P</span> <span class="main">∩</span> <span class="main">{</span> <span class="bound">l</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> length <span class="bound">l</span> <span class="main">}</span><span class="main">)</span>
      <span class="main">⟷</span> finite <span class="main">(</span>lists <span class="free">P</span> <span class="main">∩</span> <span class="main">{</span> <span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="free">n</span> <span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> S<span class="main">)</span> <span class="operator">simp</span>

    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lists_of_len_fin1<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> lists_of_len_fin <span class="main">=</span> lists_of_len_fin1 lists_of_len_fin2


  <span class="comment1">(* Try (simp only: cset_fin_simps, fastforce intro: cset_fin_intros) when reasoning about finiteness of collected sets *)</span>
  <span class="keyword1"><span class="command">lemmas</span></span> cset_fin_simps <span class="main">=</span> Ex_prod_contract fs_contract<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> image_Collect<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> cset_fin_intros <span class="main">=</span> finite_imageI finite_Collect inj_onI


<span class="keyword1" id="Misc-Un_interval"><span class="command">lemma</span></span> Un_interval<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span><span class="main">≤</span><span class="free">b2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b2</span><span class="main">≤</span><span class="free">b3</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="free">b1</span><span class="main">≤</span><span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">b2</span> <span class="main">}</span> <span class="main">∪</span> <span class="main">{</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="free">b2</span><span class="main">≤</span><span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">b3</span> <span class="main">}</span>
    <span class="main">=</span> <span class="main">{</span><span class="free">f</span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="free">b1</span><span class="main">≤</span><span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">b3</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span><span class="main">&lt;</span><span class="free">b2</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The standard library proves that a generalized union is finite
  if the index set is finite and if for every index the component
  set is itself finite. Conversely, we show that every component
  set must be finite when the union is finite.
›</span></span>
<span class="keyword1" id="Misc-finite_UNION_then_finite"><span class="command">lemma</span></span> finite_UNION_then_finite<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">B</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> finite <span class="main">(</span><span class="free">B</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Set.set_insert UN_insert Un_infinite<span class="main">)</span>

<span class="keyword1" id="Misc-finite_if_eq_beyond_finite"><span class="command">lemma</span></span> finite_if_eq_beyond_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> finite <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">-</span> <span class="free">S</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">-</span> <span class="free">S</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∪</span> <span class="main">(</span><span class="free">s'</span> <span class="main">-</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> Pow <span class="free">S</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">-</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">-</span> <span class="free">S</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">-</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∪</span> <span class="main">(</span><span class="free">s'</span> <span class="main">-</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> Pow <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Misc-distinct_finite_subset"><span class="command">lemma</span></span> distinct_finite_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">ys</span><span class="main">.</span> set <span class="bound">ys</span> <span class="main">⊆</span> <span class="free">x</span> <span class="main">∧</span> distinct <span class="bound">ys</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">ys</span><span class="main">.</span> set <span class="bound">ys</span> <span class="main">⊆</span> <span class="free">x</span> <span class="main">∧</span> length <span class="bound">ys</span> <span class="main">≤</span> card <span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> distinct_card card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">...</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_lists_length_le<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-distinct_finite_set"><span class="command">lemma</span></span> distinct_finite_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">ys</span><span class="main">.</span> set <span class="bound">ys</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> distinct <span class="bound">ys</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">x</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">ys</span><span class="main">.</span> set <span class="bound">ys</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">ys</span><span class="main">.</span> set <span class="bound">ys</span> <span class="main">⊆</span> <span class="free">x</span> <span class="main">∧</span> length <span class="bound">ys</span> <span class="main">≤</span> card <span class="free">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> distinct_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">...</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_lists_length_le<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-finite_set_image"><span class="command">lemma</span></span> finite_set_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> distinct <span class="bound">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> f <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set <span class="main">-`</span> <span class="main">(</span>set <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> distinct <span class="bound">xs</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set <span class="main">-`</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> distinct <span class="bound">xs</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vimage_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Collect_conj_eq distinct_finite_set<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> insert <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> vimage_insert<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Int_Un_distrib2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_UnI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> dist <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="main">...</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vimage_image_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Infinite Set›</span></span>
<span class="keyword1" id="Misc-INFM_nat_inductI"><span class="command">lemma</span></span> INFM_nat_inductI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> PS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">j</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">j</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="skolem">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">j</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">j</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> PS<span class="main">[</span><span class="operator">OF</span> P0<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> PS Suc_lessI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> INFM_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Functions›</span></span>

<span class="keyword1" id="Misc-fun_neq_ext_iff"><span class="command">lemma</span></span> fun_neq_ext_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">≠</span><span class="free">m'</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">m</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">m'</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv_on</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">==</span> <span class="keyword1">SOME</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1" id="Misc-inv_on_f_f"><span class="command">lemma</span></span> inv_on_f_f<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>inj_on <span class="free">f</span> <span class="free">A</span><span class="main">;</span> <span class="free">x</span><span class="main">∈</span><span class="free">A</span><span class="main">⟧</span> <span class="main">⟹</span> inv_on <span class="free">f</span> <span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_on_def inj_on_def<span class="main">)</span>

<span class="keyword1" id="Misc-f_inv_on_f"><span class="command">lemma</span></span> f_inv_on_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">y</span><span class="main">∈</span><span class="free">f</span><span class="main">`</span><span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span>inv_on <span class="free">f</span> <span class="free">A</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI2<span class="main">)</span>

<span class="keyword1" id="Misc-inv_on_f_range"><span class="command">lemma</span></span> inv_on_f_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">f</span><span class="main">`</span><span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> inv_on <span class="free">f</span> <span class="free">A</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI2<span class="main">)</span>

<span class="keyword1" id="Misc-inj_on_map_inv_f"><span class="command">lemma</span></span> inj_on_map_inv_f <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>set <span class="free">l</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">;</span> inj_on <span class="free">f</span> <span class="free">A</span><span class="main">⟧</span> <span class="main">⟹</span> map <span class="main">(</span>inv_on <span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-comp_cong_right"><span class="command">lemma</span></span> comp_cong_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="keyword1">o</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="keyword1">o</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1" id="Misc-comp_cong_left"><span class="command">lemma</span></span> comp_cong_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">o</span> <span class="free">f</span> <span class="main">=</span> <span class="free">y</span> <span class="keyword1">o</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Misc-fun_comp_eq_conv"><span class="command">lemma</span></span> fun_comp_eq_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">o</span> <span class="free">g</span> <span class="main">=</span> <span class="free">fg</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">fg</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">comp2</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">oo</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1"><span class="free">oo</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">o</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">comp3</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">ooo</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1"><span class="free">ooo</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">oo</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span>
  comp2  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∘∘</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  comp3  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∘∘∘</span>"</span> 55<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">code_unfold</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">swap_args2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Multisets›</span></span>

<span class="comment1">(*
  The following is a syntax extension for multisets. Unfortunately, it depends on a change in the Library/Multiset.thy, so it is commented out here, until it will be incorporated
  into Library/Multiset.thy by its maintainers.

  The required change in Library/Multiset.thy is removing the syntax for single:
     - single :: "'a =&gt; 'a multiset"    ("{#_#}")
     + single :: "'a =&gt; 'a multiset"

  And adding the following translations instead:

     + syntax
     + "_multiset" :: "args ⇒ 'a multiset" ("{#(_)#}")

     + translations
     +   "{#x, xs#}" == "{#x#} + {#xs#}"
     +   "{# x #}" == "single x"

  This translates "{# … #}" into a sum of singletons, that is parenthesized to the right. ?? Can we also achieve left-parenthesizing ??

*)</span>


  <span class="comment1">(* Let's try what happens if declaring AC-rules for multiset union as simp-rules *)</span>
<span class="comment1">(*declare union_ac[simp] -- don't do it !*)</span>


<span class="keyword1" id="Misc-count_mset_set_finite_iff"><span class="command">lemma</span></span> count_mset_set_finite_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> count <span class="main">(</span>mset_set <span class="free">S</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-ex_Melem_conv"><span class="command">lemma</span></span> ex_Melem_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">≠</span> <span class="main">{#}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ex_in_conv<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Count›</span></span>
        <span class="keyword1" id="Misc-count_ne_remove"><span class="command">lemma</span></span> count_ne_remove<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">~=</span> <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> count <span class="free">S</span> <span class="free">x</span> <span class="main">=</span> count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span> <span class="free">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Misc-mset_empty_count"><span class="command">lemma</span></span> mset_empty_count<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> count <span class="free">M</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M</span><span class="main">=</span><span class="main">{#}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> multiset_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Union, difference and intersection›</span></span>

  <span class="keyword1" id="Misc-size_diff_se"><span class="command">lemma</span></span> size_diff_se<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈#</span> <span class="free">S</span> <span class="main">⟹</span> size <span class="free">S</span> <span class="main">=</span> size <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> size_multiset_overloaded_eq<span class="main">)</span>
                <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?SIZE</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>count <span class="free">S</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">S</span><span class="main">)</span>"</span></span>
                <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈#</span> <span class="free">S</span>"</span></span>
                <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> SPLITPRE<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_mset <span class="free">S</span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">⊆</span><span class="main">(</span>set_mset <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?SIZE</span> <span class="main">=</span> sum <span class="main">(</span>count <span class="free">S</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> sum <span class="main">(</span>count <span class="free">S</span><span class="main">)</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sum.subset_diff<span class="main">)</span>
                <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?SIZE</span> <span class="main">=</span> sum <span class="main">(</span>count <span class="free">S</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> count <span class="main">(</span><span class="free">S</span><span class="main">)</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="free">S</span> <span class="free">t</span> <span class="main">=</span> count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span> <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?SIZE</span> <span class="main">=</span> sum <span class="main">(</span>count <span class="free">S</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span> <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">arith</span><span class="main">)</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>count <span class="free">S</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span>count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span>set_mset <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> count <span class="free">S</span> <span class="bound">x</span> <span class="main">=</span> count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> count_ne_remove<span class="main">)</span>
                        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?SIZE</span> <span class="main">=</span> sum <span class="main">(</span>count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span> <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
                <span class="keyword1"><span class="command">moreover</span></span>
                <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∉#</span> <span class="free">S</span> <span class="main">-</span> <span class="main">{#</span><span class="free">t</span><span class="main">#}</span>"</span></span>
                        <span class="keyword1"><span class="command">from</span></span> CASE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span> <span class="main">=</span> set_mset <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span>"</span></span>
                          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_diff_count <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
                        <span class="keyword1"><span class="command">with</span></span> CASE D <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?SIZE</span> <span class="main">=</span> sum <span class="main">(</span>count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
                          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_in_iff<span class="main">)</span>
                <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">moreover</span></span>
                <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈#</span> <span class="free">S</span> <span class="main">-</span> <span class="main">{#</span><span class="free">t</span><span class="main">#}</span>"</span></span>
                        <span class="keyword1"><span class="command">from</span></span> CASE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈#</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> in_diffD<span class="main">)</span>
                        <span class="keyword1"><span class="command">with</span></span> CASE <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="free">S</span> <span class="main">=</span> set_mset <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span>"</span></span>
                          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_diff_count <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
                        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> D <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?SIZE</span> <span class="main">=</span> sum <span class="main">(</span>count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> sum <span class="main">(</span>count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> SPLITPRE sum.subset_diff <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">S</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span>count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> sum <span class="main">(</span>count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
                        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?SIZE</span> <span class="main">=</span> sum <span class="main">(</span>count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?SIZE</span> <span class="main">=</span> sum <span class="main">(</span>count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">(* TODO: Check whether this proof can be done simpler *)</span>
  <span class="keyword1" id="Misc-mset_union_diff_comm"><span class="command">lemma</span></span> mset_union_diff_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈#</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">T</span> <span class="main">+</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">T</span> <span class="main">+</span> <span class="free">S</span><span class="main">)</span> <span class="main">-</span> <span class="main">{#</span><span class="free">t</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈#</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> add_mset <span class="free">t</span> <span class="skolem">S'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_DiffM<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*  lemma mset_diff_diff_left: "A-B-C = A-((B::'a multiset)+C)" proof -
    have "∀e . count (A-B-C) e = count (A-(B+C)) e" by auto
    thus ?thesis by (simp add: multiset_eq_conv_count_eq)
  qed

  lemma mset_diff_commute: "A-B-C = A-C-(B::'a multiset)" proof -
    have "A-B-C = A-(B+C)" by (simp add: mset_diff_diff_left)
    also have "… = A-(C+B)" by (simp add: union_commute)
    thus ?thesis by (simp add: mset_diff_diff_left)
  qed

  lemma mset_diff_same_empty[simp]: "(S::'a multiset) - S = {#}"
  proof -
    have "∀e . count (S-S) e = 0" by auto
    hence "∀e . ~ (e : set_mset (S-S))" by auto
    hence "set_mset (S-S) = {}" by blast
    thus ?thesis by (auto)
  qed
*)</span>
    
  <span class="keyword1" id="Misc-mset_right_cancel_union"><span class="command">lemma</span></span> mset_right_cancel_union<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">+</span><span class="free">B</span><span class="main">;</span> <span class="main">~</span><span class="main">(</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">B</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">∈#</span><span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1" id="Misc-mset_left_cancel_union"><span class="command">lemma</span></span> mset_left_cancel_union<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">+</span><span class="free">B</span><span class="main">;</span> <span class="main">~</span><span class="main">(</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">∈#</span><span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> mset_cancel_union <span class="main">=</span> mset_right_cancel_union mset_left_cancel_union

  <span class="keyword1" id="Misc-mset_right_cancel_elem"><span class="command">lemma</span></span> mset_right_cancel_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">+</span><span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">;</span> <span class="free">a</span><span class="main">~=</span><span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">∈#</span><span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Misc-mset_left_cancel_elem"><span class="command">lemma</span></span> mset_left_cancel_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">∈#</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">+</span><span class="free">A</span><span class="main">;</span> <span class="free">a</span><span class="main">~=</span><span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">∈#</span><span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">lemmas</span></span> mset_cancel_elem <span class="main">=</span> mset_right_cancel_elem mset_left_cancel_elem

  <span class="keyword1" id="Misc-mset_diff_cancel1elem"><span class="command">lemma</span></span> mset_diff_cancel1elem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span><span class="main">(</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">B</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">-</span><span class="free">B</span> <span class="main">=</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_in_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multiset_eqI<span class="main">)</span>

<span class="comment1">(*  lemma diff_union_inverse[simp]: "A + B - B = (A::'a multiset)"
    by (auto iff add: multiset_eq_conv_count_eq)

  lemma diff_union_inverse2[simp]: "B + A - B = (A::'a multiset)"
    by (auto iff add: multiset_eq_conv_count_eq)
*)</span>
  <span class="comment1">(*lemma union_diff_assoc_se2: "t ∈# A ⟹ (A+B)-{#t#} = (A-{#t#}) + B"
    by (auto iff add: multiset_eq_conv_count_eq)
  lemmas union_diff_assoc_se = union_diff_assoc_se1 union_diff_assoc_se2*)</span>

        <span class="keyword1" id="Misc-union_diff_assoc"><span class="command">lemma</span></span> union_diff_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">-</span><span class="free">B</span><span class="main">=</span><span class="main">{#}</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">A</span><span class="main">+</span><span class="free">B</span><span class="main">)</span><span class="main">-</span><span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">+</span> <span class="main">(</span><span class="free">B</span><span class="main">-</span><span class="free">C</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> multiset_eq_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> mset_neutral_cancel1 <span class="main">=</span> union_left_cancel<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> union_right_cancel<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> mset_neutral_cancel1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

  <span class="keyword1" id="Misc-mset_union_2_elem"><span class="command">lemma</span></span> mset_union_2_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">#}</span> <span class="main">=</span> add_mset <span class="free">c</span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">=</span><span class="free">M</span> <span class="main">&amp;</span> <span class="free">b</span><span class="main">=</span><span class="free">c</span> <span class="main">|</span> <span class="free">a</span><span class="main">=</span><span class="free">c</span> <span class="main">&amp;</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">=</span><span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_eq_conv_diff<span class="main">)</span>

  <span class="keyword1" id="Misc-mset_un_cases"><span class="command">lemma</span></span> mset_un_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> left right<span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">;</span> <span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> <span class="free">a</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Misc-mset_unplusm_dist_cases"><span class="command">lemma</span></span> mset_unplusm_dist_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> left right<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="free">A</span> <span class="main">=</span> <span class="free">B</span><span class="main">+</span><span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">B</span><span class="main">=</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">;</span> <span class="free">A</span><span class="main">=</span><span class="main">(</span><span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">+</span><span class="free">C</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">C</span><span class="main">=</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="free">C</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">;</span> <span class="free">A</span><span class="main">=</span><span class="free">B</span><span class="main">+</span><span class="main">(</span><span class="free">C</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> A<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈#</span> <span class="free">B</span><span class="main">+</span><span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mset_un_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> left <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">=</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="free">A</span> <span class="main">=</span> <span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="main">(</span><span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">+</span><span class="free">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">+</span><span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> L<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> right <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">=</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="free">C</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="free">A</span> <span class="main">=</span> <span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="free">B</span><span class="main">+</span><span class="main">(</span><span class="free">C</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">B</span><span class="main">+</span><span class="main">(</span><span class="free">C</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> R<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Misc-mset_unplusm_dist_cases2"><span class="command">lemma</span></span> mset_unplusm_dist_cases2<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> left right<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">+</span><span class="free">C</span> <span class="main">=</span> <span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">B</span><span class="main">=</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">;</span> <span class="free">A</span><span class="main">=</span><span class="main">(</span><span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">+</span><span class="free">C</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">C</span><span class="main">=</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="free">C</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">;</span> <span class="free">A</span><span class="main">=</span><span class="free">B</span><span class="main">+</span><span class="main">(</span><span class="free">C</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
    <span class="keyword1"><span class="command">using</span></span> mset_unplusm_dist_cases<span class="main">[</span><span class="operator">OF</span> A<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> L R <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1" id="Misc-mset_single_cases"><span class="command">lemma</span></span> mset_single_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> loc env<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">s</span> <span class="free">c</span> <span class="main">=</span> add_mset <span class="free">r'</span> <span class="free">c'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> CASES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span><span class="main">=</span><span class="free">r'</span><span class="main">;</span> <span class="free">c</span><span class="main">=</span><span class="free">c'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c'</span><span class="main">=</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="free">c'</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">;</span> <span class="free">c</span><span class="main">=</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="free">c</span><span class="main">-</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span><span class="main">)</span><span class="main">;</span> <span class="free">c</span><span class="main">-</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span> <span class="main">=</span> <span class="free">c'</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">=</span><span class="free">r'</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">=</span><span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> CASE CASES <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">≠</span><span class="free">r'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈#</span> <span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈#</span> <span class="main">{#</span><span class="free">r'</span><span class="main">#}</span><span class="main">+</span><span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> CASE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈#</span> <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">=</span> <span class="main">{#</span><span class="free">s</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="free">c'</span> <span class="main">-</span> <span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="free">c</span> <span class="main">=</span> <span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="free">c'</span> <span class="main">-</span> <span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">=</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="free">c'</span> <span class="main">-</span> <span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">-</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span> <span class="main">=</span> <span class="main">(</span><span class="free">c'</span> <span class="main">-</span> <span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> 1 2 3 CASES <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Misc-mset_single_cases'"><span class="command">lemma</span></span> mset_single_cases'<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> loc env<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">s</span> <span class="free">c</span> <span class="main">=</span> add_mset <span class="free">r'</span> <span class="free">c'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> CASES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span><span class="main">=</span><span class="free">r'</span><span class="main">;</span> <span class="free">c</span><span class="main">=</span><span class="free">c'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">cc</span><span class="main">.</span> <span class="main">⟦</span><span class="free">c'</span><span class="main">=</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="bound">cc</span><span class="main">;</span> <span class="free">c</span><span class="main">=</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span><span class="main">+</span><span class="bound">cc</span><span class="main">;</span> <span class="free">c'</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">=</span><span class="bound">cc</span><span class="main">;</span> <span class="free">c</span><span class="main">-</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span><span class="main">=</span><span class="bound">cc</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A  CASES <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mset_single_cases<span class="main">)</span>

  <span class="keyword1" id="Misc-mset_single_cases2"><span class="command">lemma</span></span> mset_single_cases2<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> loc env<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">s</span> <span class="free">c</span> <span class="main">=</span> add_mset <span class="free">r'</span> <span class="free">c'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> CASES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span><span class="main">=</span><span class="free">r'</span><span class="main">;</span> <span class="free">c</span><span class="main">=</span><span class="free">c'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c'</span><span class="main">=</span><span class="main">(</span><span class="free">c'</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">+</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">;</span> <span class="free">c</span><span class="main">=</span><span class="main">(</span><span class="free">c</span><span class="main">-</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span><span class="main">)</span><span class="main">+</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span><span class="main">;</span> <span class="free">c</span><span class="main">-</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span> <span class="main">=</span> <span class="free">c'</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="free">s</span> <span class="free">c</span> <span class="main">=</span> add_mset <span class="free">r'</span> <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> CASES <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mset_single_cases<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Misc-mset_single_cases2'"><span class="command">lemma</span></span> mset_single_cases2'<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> loc env<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">s</span> <span class="free">c</span> <span class="main">=</span> add_mset <span class="free">r'</span> <span class="free">c'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> CASES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span><span class="main">=</span><span class="free">r'</span><span class="main">;</span> <span class="free">c</span><span class="main">=</span><span class="free">c'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">cc</span><span class="main">.</span> <span class="main">⟦</span><span class="free">c'</span><span class="main">=</span><span class="bound">cc</span><span class="main">+</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">;</span> <span class="free">c</span><span class="main">=</span><span class="bound">cc</span><span class="main">+</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span><span class="main">;</span> <span class="free">c'</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">=</span><span class="bound">cc</span><span class="main">;</span> <span class="free">c</span><span class="main">-</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span><span class="main">=</span><span class="bound">cc</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A  CASES <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mset_single_cases2<span class="main">)</span>

  <span class="keyword1" id="Misc-mset_un_single_un_cases"><span class="command">lemma</span></span> mset_un_single_un_cases <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> left right<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">a</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span> <span class="main">+</span> <span class="free">C</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> CASES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span> <span class="main">+</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span> <span class="main">+</span> <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">+</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> <span class="free">B</span><span class="main">+</span><span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mset_un_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> left <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">=</span><span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">+</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span><span class="main">+</span><span class="free">C</span><span class="main">+</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">=</span><span class="main">(</span><span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span><span class="main">+</span><span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> CASES<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> left<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> right <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">=</span><span class="free">C</span><span class="main">-</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">+</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">=</span> <span class="free">B</span><span class="main">+</span><span class="main">(</span><span class="free">C</span><span class="main">-</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span><span class="main">+</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">=</span><span class="free">B</span><span class="main">+</span><span class="main">(</span><span class="free">C</span><span class="main">-</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> CASES<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> right<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

      <span class="comment1">(* TODO: Can this proof be done more automatically ? *)</span>
  <span class="keyword1" id="Misc-mset_distrib"><span class="command">lemma</span></span> mset_distrib<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> dist<span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span><span class="main">+</span><span class="free">B</span> <span class="main">=</span> <span class="free">M</span><span class="main">+</span><span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">Am</span> <span class="bound">An</span> <span class="bound">Bm</span> <span class="bound">Bn</span><span class="main">.</span> <span class="main">⟦</span><span class="free">A</span><span class="main">=</span><span class="bound">Am</span><span class="main">+</span><span class="bound">An</span><span class="main">;</span> <span class="free">B</span><span class="main">=</span><span class="bound">Bm</span><span class="main">+</span><span class="bound">Bn</span><span class="main">;</span> <span class="free">M</span><span class="main">=</span><span class="bound">Am</span><span class="main">+</span><span class="bound">Bm</span><span class="main">;</span> <span class="free">N</span><span class="main">=</span><span class="bound">An</span><span class="main">+</span><span class="bound">Bn</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> BN_MA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">-</span> <span class="free">N</span> <span class="main">=</span> <span class="free">M</span> <span class="main">-</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add_diff_cancel_right assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> union_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">A</span><span class="main">∩#</span> <span class="skolem">C</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">∩#</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">+</span> <span class="skolem">B</span> <span class="main">=</span> <span class="skolem">C</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">C</span> <span class="skolem">D</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute diff_intersect_left_idem mset_subset_eq_add_left subset_eq_diff_conv
          subset_mset.add_diff_inverse subset_mset.inf_absorb1 subset_mset.inf_le1 that<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">A</span><span class="main">∩#</span> <span class="free">M</span> <span class="main">+</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">M</span><span class="main">)</span> <span class="main">∩#</span> <span class="free">N</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A<span class="main">(</span>1<span class="main">)</span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> B'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">N</span><span class="main">)</span> <span class="main">∩#</span> <span class="free">M</span> <span class="main">+</span> <span class="free">B</span><span class="main">∩#</span> <span class="free">N</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A<span class="main">(</span>1<span class="main">)</span> H<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∩#</span> <span class="free">M</span> <span class="main">+</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">N</span><span class="main">)</span> <span class="main">∩#</span> <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> H<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> BN_MA<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> A<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> diff_intersect_left_idem
          diff_union_cancelR multiset_inter_commute subset_mset.diff_add subset_mset.inf.cobounded1
          union_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">M</span><span class="main">)</span> <span class="main">∩#</span> <span class="free">N</span> <span class="main">+</span> <span class="free">B</span> <span class="main">∩#</span> <span class="free">N</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> A' assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> diff_union_cancelL inter_union_distrib_left inter_union_distrib_right
          mset_subset_eq_multiset_union_diff_commute subset_mset.inf.cobounded1 subset_mset.inf.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">P</span></span>
      <span class="keyword1"><span class="command">using</span></span> A<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Singleton multisets›</span></span>

<span class="keyword1" id="Misc-mset_size_le1_cases"><span class="command">lemma</span></span> mset_size_le1_cases<span class="main">[</span><span class="operator">case_names</span> empty singleton<span class="main">,</span><span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> size <span class="free">M</span> <span class="main">≤</span> Suc <span class="main">0</span><span class="main">;</span> <span class="free">M</span><span class="main">=</span><span class="main">{#}</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> <span class="main">!!</span><span class="bound">m</span><span class="main">.</span> <span class="free">M</span><span class="main">=</span><span class="main">{#</span><span class="bound">m</span><span class="main">#}</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-diff_union_single_conv2"><span class="command">lemma</span></span> diff_union_single_conv2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> <span class="free">J</span> <span class="main">⟹</span> <span class="free">J</span> <span class="main">+</span> <span class="free">I</span> <span class="main">-</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">=</span> <span class="main">(</span><span class="free">J</span> <span class="main">-</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span> <span class="main">+</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> diff_union_single_convs <span class="main">=</span> diff_union_single_conv diff_union_single_conv2

<span class="keyword1" id="Misc-mset_contains_eq"><span class="command">lemma</span></span> mset_contains_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{#</span><span class="free">m</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="free">M</span><span class="main">-</span><span class="main">{#</span><span class="free">m</span><span class="main">#}</span><span class="main">)</span><span class="main">=</span><span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> diff_single_trivial <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pointwise ordering›</span></span>


  <span class="comment1">(*declare mset_le_trans[trans] Seems to be in there now. Why is this not done in Multiset.thy or order-class ? *)</span>

  <span class="keyword1" id="Misc-mset_le_incr_right1"><span class="command">lemma</span></span> mset_le_incr_right1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">⊆#</span><span class="main">(</span><span class="free">b</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">⊆#</span><span class="free">b</span><span class="main">+</span><span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset_subset_eq_mono_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1" id="Misc-mset_le_incr_right2"><span class="command">lemma</span></span> mset_le_incr_right2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">⊆#</span><span class="main">(</span><span class="free">b</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">⊆#</span><span class="free">c</span><span class="main">+</span><span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset_le_incr_right1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">lemmas</span></span> mset_le_incr_right <span class="main">=</span> mset_le_incr_right1 mset_le_incr_right2

  <span class="keyword1" id="Misc-mset_le_decr_left1"><span class="command">lemma</span></span> mset_le_decr_left1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">+</span><span class="free">c</span><span class="main">⊆#</span><span class="main">(</span><span class="free">b</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">⊆#</span><span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset_le_incr_right1 mset_subset_eq_mono_add_right_cancel
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1" id="Misc-mset_le_decr_left2"><span class="command">lemma</span></span> mset_le_decr_left2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">+</span><span class="free">a</span><span class="main">⊆#</span><span class="main">(</span><span class="free">b</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">⊆#</span><span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset_le_decr_left1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
  <span class="keyword1" id="Misc-mset_le_add_mset_decr_left1"><span class="command">lemma</span></span> mset_le_add_mset_decr_left1<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">c</span> <span class="free">a</span><span class="main">⊆#</span><span class="main">(</span><span class="free">b</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">⊆#</span><span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_subset_eq_insertD subset_mset.dual_order.strict_implies_order<span class="main">)</span>
  <span class="keyword1" id="Misc-mset_le_add_mset_decr_left2"><span class="command">lemma</span></span> mset_le_add_mset_decr_left2<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">c</span> <span class="free">a</span><span class="main">⊆#</span><span class="main">(</span><span class="free">b</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main">⟹</span> <span class="main">{#</span><span class="free">c</span><span class="main">#}</span><span class="main">⊆#</span><span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_subset_eq_insertD subset_mset.dual_order.strict_implies_order<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> mset_le_decr_left <span class="main">=</span> mset_le_decr_left1 mset_le_decr_left2 mset_le_add_mset_decr_left1
    mset_le_add_mset_decr_left2

  <span class="keyword1" id="Misc-mset_le_subtract"><span class="command">lemma</span></span> mset_le_subtract<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">⊆#</span><span class="free">B</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">-</span><span class="free">C</span> <span class="main">⊆#</span> <span class="free">B</span><span class="main">-</span><span class="main">(</span><span class="free">C</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> subseteq_mset_def count_diff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"count <span class="free">A</span> <span class="improper">a</span> <span class="main">≤</span> count <span class="free">B</span> <span class="improper">a</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Misc-mset_union_subset"><span class="command">lemma</span></span> mset_union_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">+</span><span class="free">B</span> <span class="main">⊆#</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">⊆#</span><span class="free">C</span> <span class="main">∧</span> <span class="free">B</span><span class="main">⊆#</span><span class="main">(</span><span class="free">C</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_le_decr_left<span class="main">)</span>

  <span class="keyword1" id="Misc-mset_le_add_mset"><span class="command">lemma</span></span> mset_le_add_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">x</span> <span class="free">B</span> <span class="main">⊆#</span> <span class="free">C</span> <span class="main">⟹</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span><span class="main">⊆#</span><span class="free">C</span> <span class="main">∧</span> <span class="free">B</span><span class="main">⊆#</span><span class="main">(</span><span class="free">C</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_le_decr_left<span class="main">)</span>

  <span class="keyword1" id="Misc-mset_le_subtract_left"><span class="command">lemma</span></span> mset_le_subtract_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">+</span><span class="free">B</span> <span class="main">⊆#</span> <span class="main">(</span><span class="free">X</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆#</span> <span class="free">X</span><span class="main">-</span><span class="free">A</span> <span class="main">∧</span> <span class="free">A</span><span class="main">⊆#</span><span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_le_subtract<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">+</span><span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span>"</span></span><span class="main"><span class="main">]</span></span> mset_union_subset<span class="main">)</span>
  <span class="keyword1" id="Misc-mset_le_subtract_right"><span class="command">lemma</span></span> mset_le_subtract_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">+</span><span class="free">B</span> <span class="main">⊆#</span> <span class="main">(</span><span class="free">X</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊆#</span> <span class="free">X</span><span class="main">-</span><span class="free">B</span> <span class="main">∧</span> <span class="free">B</span><span class="main">⊆#</span><span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_le_subtract<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">+</span><span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span>"</span></span><span class="main"><span class="main">]</span></span> mset_union_subset<span class="main">)</span>

  <span class="keyword1" id="Misc-mset_le_subtract_add_mset_left"><span class="command">lemma</span></span> mset_le_subtract_add_mset_left<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">x</span> <span class="free">B</span> <span class="main">⊆#</span> <span class="main">(</span><span class="free">X</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆#</span> <span class="free">X</span><span class="main">-</span><span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">∧</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span><span class="main">⊆#</span><span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_le_subtract<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">x</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">x</span><span class="main">#}</span>"</span></span><span class="main"><span class="main">]</span></span> mset_le_add_mset<span class="main">)</span>

  <span class="keyword1" id="Misc-mset_le_subtract_add_mset_right"><span class="command">lemma</span></span> mset_le_subtract_add_mset_right<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">x</span> <span class="free">B</span> <span class="main">⊆#</span> <span class="main">(</span><span class="free">X</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main">⟹</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free">X</span><span class="main">-</span><span class="free">B</span> <span class="main">∧</span> <span class="free">B</span><span class="main">⊆#</span><span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_le_subtract<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">x</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span>"</span></span><span class="main"><span class="main">]</span></span> mset_le_add_mset<span class="main">)</span>

  <span class="keyword1" id="Misc-mset_le_addE"><span class="command">lemma</span></span> mset_le_addE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">xs</span> <span class="main">⊆#</span> <span class="main">(</span><span class="free">ys</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span><span class="main">;</span> <span class="main">!!</span><span class="bound">zs</span><span class="main">.</span> <span class="free">ys</span><span class="main">=</span><span class="free">xs</span><span class="main">+</span><span class="bound">zs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset_subset_eq_exists_conv
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">declare</span></span> subset_mset.diff_add<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span>

  <span class="keyword1" id="Misc-mset_2dist2_cases"><span class="command">lemma</span></span> mset_2dist2_cases<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free">A</span><span class="main">+</span><span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> CASES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">;</span> <span class="free">b</span> <span class="main">∈#</span> <span class="free">B</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">B</span><span class="main">;</span> <span class="free">b</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">-</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> mset_subset_eq_mono_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">b</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">-</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">b</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">-</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="free">B</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_union_single_conv2 mset_le_subtract_left mset_subset_eq_insertD mset_un_cases<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> <span class="free">B</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_subset_eqD<span class="main">)</span>
       <span class="keyword1"><span class="command">with</span></span> C mset_subset_eq_mono_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">b</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">b</span> <span class="main">∈#</span> <span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">∈#</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mset_subset_eq_insertD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_union_subset_iff<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mset_diff_cancel1elem mset_le_subtract_left multiset_diff_union_assoc
            single_subset_iff subset_eq_diff_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword1"><span class="command">using</span></span> CASES <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>


  <span class="keyword1" id="Misc-mset_union_subset_s"><span class="command">lemma</span></span> mset_union_subset_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">+</span><span class="free">B</span> <span class="main">⊆#</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">⊆#</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> mset_union_subset<span class="main">)</span> <span class="operator">simp</span>

  <span class="comment1">(* TODO: Check which of these lemmas are already introduced by order-classes ! *)</span>


  <span class="keyword1" id="Misc-mset_le_single_cases"><span class="command">lemma</span></span> mset_le_single_cases<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> empty singleton<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">M</span><span class="main">⊆#</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">;</span> <span class="free">M</span><span class="main">=</span><span class="main">{#}</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> <span class="free">M</span><span class="main">=</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1" id="Misc-mset_le_distrib"><span class="command">lemma</span></span> mset_le_distrib<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> dist<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">X</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span><span class="main">⊆#</span><span class="free">A</span><span class="main">+</span><span class="free">B</span><span class="main">;</span> <span class="main">!!</span><span class="bound">Xa</span> <span class="bound">Xb</span><span class="main">.</span> <span class="main">⟦</span><span class="free">X</span><span class="main">=</span><span class="bound">Xa</span><span class="main">+</span><span class="bound">Xb</span><span class="main">;</span> <span class="bound">Xa</span><span class="main">⊆#</span><span class="free">A</span><span class="main">;</span> <span class="bound">Xb</span><span class="main">⊆#</span><span class="free">B</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mset_le_addE mset_distrib<span class="main">)</span>

<span class="keyword1" id="Misc-mset_le_mono_add_single"><span class="command">lemma</span></span> mset_le_mono_add_single<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">ys</span><span class="main">;</span> <span class="free">b</span> <span class="main">∈#</span> <span class="free">ws</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free">ys</span> <span class="main">+</span> <span class="free">ws</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> mset_subset_eq_mono_add single_subset_iff<span class="main">)</span>

  <span class="keyword1" id="Misc-mset_size1elem"><span class="command">lemma</span></span> mset_size1elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>size <span class="free">P</span> <span class="main">≤</span> <span class="main">1</span><span class="main">;</span> <span class="free">q</span> <span class="main">∈#</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">=</span><span class="main">{#</span><span class="free">q</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mset_size_le1_cases<span class="main">)</span>
  <span class="keyword1" id="Misc-mset_size2elem"><span class="command">lemma</span></span> mset_size2elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>size <span class="free">P</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">;</span> <span class="main">{#</span><span class="free">q</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span><span class="free">q'</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">=</span><span class="main">{#</span><span class="free">q</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span><span class="free">q'</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mset_le_addE<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Image under function›</span></span>

<span class="keyword1"><span class="command">notation</span></span> image_mset <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">`#</span>"</span> 90<span class="main">)</span>

<span class="keyword1" id="Misc-mset_map_split_orig"><span class="command">lemma</span></span> mset_map_split_orig<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">M1</span> <span class="bound">M2</span><span class="main">.</span> <span class="main">⟦</span><span class="free">f</span> <span class="main">`#</span> <span class="free">P</span> <span class="main">=</span> <span class="bound">M1</span><span class="main">+</span><span class="bound">M2</span><span class="main">;</span> <span class="main">!!</span><span class="bound">P1</span> <span class="bound">P2</span><span class="main">.</span> <span class="main">⟦</span><span class="free">P</span><span class="main">=</span><span class="bound">P1</span><span class="main">+</span><span class="bound">P2</span><span class="main">;</span> <span class="free">f</span> <span class="main">`#</span> <span class="bound">P1</span> <span class="main">=</span> <span class="bound">M1</span><span class="main">;</span> <span class="free">f</span> <span class="main">`#</span> <span class="bound">P2</span> <span class="main">=</span> <span class="bound">M2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mset_un_single_un_cases<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Misc-mset_map_id"><span class="command">lemma</span></span> mset_map_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">!!</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">`#</span> <span class="free">g</span> <span class="main">`#</span> <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following is a very specialized lemma. Intuitively, it splits the original multiset
  by a splitting of some pointwise supermultiset of its image.

  Application:
  This lemma came in handy when proving the correctness of a constraint system that collects at most k sized submultisets of the sets of spawned threads.
›</span></span>
<span class="keyword1" id="Misc-mset_map_split_orig_le"><span class="command">lemma</span></span> mset_map_split_orig_le<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`#</span> <span class="free">P</span> <span class="main">⊆#</span> <span class="free">M1</span><span class="main">+</span><span class="free">M2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> EX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">P1</span> <span class="bound">P2</span><span class="main">.</span> <span class="main">⟦</span><span class="free">P</span><span class="main">=</span><span class="bound">P1</span><span class="main">+</span><span class="bound">P2</span><span class="main">;</span> <span class="free">f</span> <span class="main">`#</span> <span class="bound">P1</span> <span class="main">⊆#</span> <span class="free">M1</span><span class="main">;</span> <span class="free">f</span> <span class="main">`#</span> <span class="bound">P2</span> <span class="main">⊆#</span> <span class="free">M2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> A EX <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mset_le_distrib mset_map_split_orig<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lists›</span></span>


<span class="keyword1" id="Misc-len_greater_imp_nonempty"><span class="command">lemma</span></span> len_greater_imp_nonempty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">&gt;</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">l</span><span class="main">≠</span><span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-list_take_induct_tl2"><span class="command">lemma</span></span> list_take_induct_tl2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span><span class="main">;</span> <span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="main">∀</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> length <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="main">(</span>tl <span class="free">ys</span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-not_distinct_split_distinct"><span class="command">lemma</span></span> not_distinct_split_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="free">ys</span> <span class="free">zs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">@</span><span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-distinct_length_le"><span class="command">lemma</span></span> distinct_length_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">ys</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> d <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> card <span class="main">(</span>set <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_card<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> eq List.card_set <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>remdups <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-find_SomeD"><span class="command">lemma</span></span> find_SomeD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"List.find <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"List.find <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span>set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_Some_iff<span class="main">)</span>

<span class="keyword1" id="Misc-in_hd_or_tl_conv"><span class="command">lemma</span></span> in_hd_or_tl_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">≠</span><span class="main">[]</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">=</span>hd <span class="free">l</span> <span class="main">∨</span> <span class="free">x</span><span class="main">∈</span>set <span class="main">(</span>tl <span class="free">l</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span><span class="main">∈</span>set <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-length_dropWhile_takeWhile"><span class="command">lemma</span></span> length_dropWhile_takeWhile<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> length <span class="main">(</span>dropWhile <span class="free">P</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> length <span class="main">(</span>takeWhile <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Elim-version of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> neq_Nil_conv<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>  
<span class="keyword1" id="Misc-neq_NilE"><span class="command">lemma</span></span> neq_NilE<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">≠</span><span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span> <span class="free">xs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">=</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.exhaust<span class="main">)</span>

    
<span class="keyword1" id="Misc-length_Suc_rev_conv"><span class="command">lemma</span></span> length_Suc_rev_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> Suc <span class="free">n</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ys</span> <span class="bound">y</span><span class="main">.</span> <span class="free">xs</span><span class="main">=</span><span class="bound">ys</span><span class="main">@</span><span class="main">[</span><span class="bound">y</span><span class="main">]</span> <span class="main">∧</span> length <span class="bound">ys</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="operator">auto</span>

    
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹List Destructors›</span></span>
<span class="keyword1" id="Misc-not_hd_in_tl"><span class="command">lemma</span></span> not_hd_in_tl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> hd <span class="free">xs</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Misc-distinct_hd_tl"><span class="command">lemma</span></span> distinct_hd_tl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> hd <span class="free">xs</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> set <span class="main">(</span>tl <span class="main">(</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Misc-in_set_tlD"><span class="command">lemma</span></span> in_set_tlD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Misc-nth_tl"><span class="command">lemma</span></span> nth_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> tl <span class="free">xs</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> Suc <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Misc-tl_subset"><span class="command">lemma</span></span> tl_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> set <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_tlD rev_subsetD subsetI<span class="main">)</span>

<span class="keyword1" id="Misc-tl_last"><span class="command">lemma</span></span> tl_last<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tl <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> last <span class="free">xs</span> <span class="main">=</span> last <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Misc-tl_obtain_elem"><span class="command">lemma</span></span> tl_obtain_elem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"tl <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">e</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_nonempty_induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Misc-butlast_subset"><span class="command">lemma</span></span> butlast_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> set <span class="main">(</span>butlast <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_butlastD rev_subsetD subsetI<span class="main">)</span>

<span class="keyword1" id="Misc-butlast_rev_tl"><span class="command">lemma</span></span> butlast_rev_tl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> butlast <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Misc-hd_butlast"><span class="command">lemma</span></span> hd_butlast<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟹</span> hd <span class="main">(</span>butlast <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> hd <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Misc-butlast_upd_last_eq"><span class="command">lemma</span></span> butlast_upd_last_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">⟹</span>
  <span class="main">(</span>butlast <span class="free">l</span><span class="main">)</span> <span class="main">[</span> length <span class="free">l</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">:=</span> <span class="free">x</span> <span class="main">]</span> <span class="main">=</span> take <span class="main">(</span>length <span class="free">l</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-distinct_butlast_swap"><span class="command">lemma</span></span> distinct_butlast_swap<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"distinct <span class="free">pq</span> <span class="main">⟹</span> distinct <span class="main">(</span>butlast <span class="main">(</span><span class="free">pq</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> last <span class="free">pq</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">pq</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_update_append distinct_list_update <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Splitting list according to structure of other list›</span></span>
<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">SPLIT_ACCORDING</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> length <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Misc-SPLIT_ACCORDINGE"><span class="command">lemma</span></span> SPLIT_ACCORDINGE<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">m</span> <span class="main">=</span> length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"SPLIT_ACCORDING <span class="free">m</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SPLIT_ACCORDING_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Misc-SPLIT_ACCORDING_simp"><span class="command">lemma</span></span> SPLIT_ACCORDING_simp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"SPLIT_ACCORDING <span class="free">m</span> <span class="main">(</span><span class="free">l1</span><span class="main">@</span><span class="free">l2</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m1</span> <span class="bound">m2</span><span class="main">.</span> <span class="free">m</span><span class="main">=</span><span class="bound">m1</span><span class="main">@</span><span class="bound">m2</span> <span class="main">∧</span> SPLIT_ACCORDING <span class="bound">m1</span> <span class="free">l1</span> <span class="main">∧</span> SPLIT_ACCORDING <span class="bound">m2</span> <span class="free">l2</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"SPLIT_ACCORDING <span class="free">m</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">l'</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span> <span class="bound">m'</span><span class="main">.</span> <span class="free">m</span><span class="main">=</span><span class="bound">y</span><span class="main">#</span><span class="bound">m'</span> <span class="main">∧</span> SPLIT_ACCORDING <span class="bound">m'</span> <span class="free">l'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SPLIT_ACCORDING_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="free">l1</span><span class="main">)</span> <span class="free">m</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>length <span class="free">l1</span><span class="main">)</span> <span class="free">m</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SPLIT_ACCORDING_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Split structure of list <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> according to structure of list <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">l</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">method</span></span> split_list_according <span class="keyword2"><span class="keyword">for</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">l</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> list"</span></span> <span class="main">=</span>
  <span class="main">(</span><span class="operator">rule</span> SPLIT_ACCORDINGE<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
    <span class="main">(</span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> SPLIT_ACCORDING_simp<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">elim</span> exE conjE<span class="main"><span class="keyword3">,</span></span> 
      <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> SPLIT_ACCORDING_def
    <span class="main">)</span>
  <span class="main">)</span> 
<span class="keyword2"><span class="keyword">end</span></span>
  
    
    
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>list_all2›</span></span></span></span>›</span></span>
<span class="keyword1" id="Misc-list_all2_induct"><span class="command">lemma</span></span> list_all2_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Nil Cons<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="free">l</span> <span class="free">l'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span> <span class="bound">ls</span> <span class="bound">ls'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">x'</span><span class="main">;</span> list_all2 <span class="free">P</span> <span class="bound">ls</span> <span class="bound">ls'</span><span class="main">;</span> <span class="free">Q</span> <span class="bound">ls</span> <span class="bound">ls'</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">x</span><span class="main">#</span><span class="bound">ls</span><span class="main">)</span> <span class="main">(</span><span class="bound">x'</span><span class="main">#</span><span class="bound">ls'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">l</span> <span class="free">l'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> list_all2_lengthD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Indexing›</span></span>    

<span class="keyword1" id="Misc-ran_nth_set_encoding_conv"><span class="command">lemma</span></span> ran_nth_set_encoding_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"ran <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">l</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">=</span> set <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ranI<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-nth_image_indices"><span class="command">lemma</span></span> nth_image_indices<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(!)</span> <span class="free">l</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">}</span> <span class="main">=</span> set <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>

<span class="keyword1" id="Misc-nth_update_invalid"><span class="command">lemma</span></span> nth_update_invalid<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">i</span><span class="main">&lt;</span>length <span class="free">l</span> <span class="main">⟹</span> <span class="free">l</span><span class="main">[</span><span class="free">j</span><span class="main">:=</span><span class="free">x</span><span class="main">]</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> <span class="free">l</span><span class="main">!</span><span class="free">i</span>"</span></span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-nth_list_update'"><span class="command">lemma</span></span> nth_list_update'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">[</span><span class="free">i</span><span class="main">:=</span><span class="free">x</span><span class="main">]</span><span class="main">!</span><span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span><span class="main">=</span><span class="free">j</span> <span class="main">∧</span> <span class="free">i</span><span class="main">&lt;</span>length <span class="free">l</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span> <span class="free">l</span><span class="main">!</span><span class="free">j</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-last_take_nth_conv"><span class="command">lemma</span></span> last_take_nth_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">l</span> <span class="main">⟹</span> <span class="free">n</span><span class="main">≠</span><span class="main">0</span> <span class="main">⟹</span> last <span class="main">(</span>take <span class="free">n</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span><span class="main">!</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-nth_append_first"><span class="command">lemma</span></span> nth_append_first<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span>length <span class="free">l</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="free">l'</span><span class="main">)</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> <span class="free">l</span><span class="main">!</span><span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span> 
    
<span class="keyword1" id="Misc-in_set_image_conv_nth"><span class="command">lemma</span></span> in_set_image_conv_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">f</span><span class="main">`</span>set <span class="free">l</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">l</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> image_eqI nth_mem<span class="main">)</span>

<span class="keyword1" id="Misc-set_image_eq_pointwiseI"><span class="command">lemma</span></span> set_image_eq_pointwiseI<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">=</span> length <span class="free">l'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">l</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">l'</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span>set <span class="free">l</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span>set <span class="free">l'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth in_set_image_conv_nth<span class="main">)</span>
  
<span class="keyword1" id="Misc-insert_swap_set_eq"><span class="command">lemma</span></span> insert_swap_set_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span>length <span class="free">l</span> <span class="main">⟹</span> insert <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="free">i</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="free">l</span><span class="main">[</span><span class="free">i</span><span class="main">:=</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span>set <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth nth_list_update <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    
    
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Reverse lists›</span></span>
  <span class="keyword1" id="Misc-neq_Nil_revE"><span class="command">lemma</span></span> neq_Nil_revE<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">≠</span><span class="main">[]</span>"</span></span> 
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">ll</span> <span class="free">e</span>  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="free">ll</span><span class="main">@</span><span class="main">[</span><span class="free">e</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="operator">auto</span>
      
  <span class="keyword1" id="Misc-neq_Nil_rev_conv"><span class="command">lemma</span></span> neq_Nil_rev_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">≠</span><span class="main">[]</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">xs</span> <span class="bound">x</span><span class="main">.</span> <span class="free">l</span> <span class="main">=</span> <span class="bound">xs</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Caution: Same order of case variables in snoc-case as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] rev_exhaust<span class="antiquote"><span class="antiquote">}</span></span></span></span>, the other way round than <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] rev_induct<span class="antiquote"><span class="antiquote">}</span></span></span></span> !›</span></span>
  <span class="keyword1" id="Misc-length_compl_rev_induct"><span class="command">lemma</span></span> length_compl_rev_induct<span class="main">[</span><span class="operator">case_names</span> Nil snoc<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">P</span> <span class="main">[]</span><span class="main">;</span> <span class="main">!!</span> <span class="bound">l</span> <span class="bound">e</span> <span class="main">.</span> <span class="main">⟦</span><span class="main">!!</span> <span class="bound">ll</span> <span class="main">.</span> length <span class="bound">ll</span> <span class="main">&lt;=</span> length <span class="bound">l</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ll</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">l</span><span class="main">@</span><span class="main">[</span><span class="bound">e</span><span class="main">]</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">l</span></span></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">xs</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Misc-list_append_eq_Cons_cases"><span class="command">lemma</span></span> list_append_eq_Cons_cases<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">ys</span><span class="main">@</span><span class="free">zs</span> <span class="main">=</span> <span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">;</span> <span class="main">⟦</span><span class="free">ys</span><span class="main">=</span><span class="main">[]</span><span class="main">;</span> <span class="free">zs</span><span class="main">=</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> <span class="main">!!</span><span class="bound">ys'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">ys</span><span class="main">=</span><span class="free">x</span><span class="main">#</span><span class="bound">ys'</span><span class="main">;</span> <span class="bound">ys'</span><span class="main">@</span><span class="free">zs</span><span class="main">=</span><span class="free">xs</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eq_Cons_conv<span class="main">)</span>
  <span class="keyword1" id="Misc-list_Cons_eq_append_cases"><span class="command">lemma</span></span> list_Cons_eq_append_cases<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span><span class="main">@</span><span class="free">zs</span><span class="main">;</span> <span class="main">⟦</span><span class="free">ys</span><span class="main">=</span><span class="main">[]</span><span class="main">;</span> <span class="free">zs</span><span class="main">=</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> <span class="main">!!</span><span class="bound">ys'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">ys</span><span class="main">=</span><span class="free">x</span><span class="main">#</span><span class="bound">ys'</span><span class="main">;</span> <span class="bound">ys'</span><span class="main">@</span><span class="free">zs</span><span class="main">=</span><span class="free">xs</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_eq_append_conv<span class="main">)</span>

<span class="keyword1" id="Misc-map_of_rev_distinct"><span class="command">lemma</span></span> map_of_rev_distinct<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> map_of <span class="main">(</span>rev <span class="free">m</span><span class="main">)</span> <span class="main">=</span> map_of <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_add_comm<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="comment1">― ‹Tail-recursive, generalized <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> rev<span class="antiquote">}</span></span>. May also be used for
      tail-recursively getting a list with all elements of the two
      operands, if the order does not matter, e.g. when implementing
      sets by lists.›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">revg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">revg</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">revg</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="free">revg</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Misc-revg_fun"><span class="command">lemma</span></span> revg_fun<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"revg <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> rev <span class="free">a</span> <span class="main">@</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
      <span class="operator">auto</span>

<span class="keyword1" id="Misc-rev_split_conv"><span class="command">lemma</span></span> rev_split_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> rev <span class="main">(</span>tl <span class="free">l</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>hd <span class="free">l</span><span class="main">]</span> <span class="main">=</span> rev <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Misc-rev_butlast_is_tl_rev"><span class="command">lemma</span></span> rev_butlast_is_tl_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="main">(</span>butlast <span class="free">l</span><span class="main">)</span> <span class="main">=</span> tl <span class="main">(</span>rev <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-hd_last_singletonI"><span class="command">lemma</span></span> hd_last_singletonI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> hd <span class="free">xs</span> <span class="main">=</span> last <span class="free">xs</span><span class="main">;</span> distinct <span class="free">xs</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[</span>hd <span class="free">xs</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_nonempty_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-last_filter"><span class="command">lemma</span></span> last_filter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> <span class="free">P</span> <span class="main">(</span>last <span class="free">xs</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> last <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> last <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_nonempty_induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="comment1">(* As the following two rules are similar in nature to list_induct2',
   they are named accordingly. *)</span>
<span class="keyword1" id="Misc-rev_induct2'"><span class="command">lemma</span></span> rev_induct2' <span class="main">[</span><span class="operator">case_names</span> empty snocl snocr snoclr<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> snocl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> snocr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">P</span> <span class="main">[]</span> <span class="main">(</span><span class="bound">ys</span><span class="main">@</span><span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> snoclr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span>  <span class="free">P</span> <span class="bound">xs</span> <span class="bound">ys</span>  <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="bound">ys</span><span class="main">@</span><span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> empty snocr
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_exhaust<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> snoc <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> snocl snoclr
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_exhaust<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-rev_nonempty_induct2'"><span class="command">lemma</span></span> rev_nonempty_induct2' <span class="main">[</span><span class="operator">case_names</span> single snocl snocr snoclr<span class="main">,</span> <span class="operator">consumes</span> 2<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> single'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> snocl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> snocr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="bound">ys</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">(</span><span class="bound">ys</span><span class="main">@</span><span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> snoclr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">⟦</span><span class="free">P</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">;</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> <span class="bound">ys</span><span class="main">≠</span><span class="main">[]</span><span class="main">⟧</span>  <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="bound">ys</span><span class="main">@</span><span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_nonempty_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> single <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">zs</span><span class="main">@</span><span class="main">[</span><span class="skolem">z</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rev_exhaust<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> single' snocr
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> zs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">zs</span><span class="main">@</span><span class="main">[</span><span class="skolem">z</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rev_exhaust<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> snocl snoclr snoc
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Folding"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Ugly lemma about foldl over associative operator with left and right neutral element"</span></span>
<span class="keyword1" id="Misc-foldl_A1_eq"><span class="command">lemma</span></span> foldl_A1_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">!!</span> <span class="bound">e</span><span class="main">.</span> <span class="free">f</span> <span class="free">n</span> <span class="bound">e</span> <span class="main">=</span> <span class="bound">e</span><span class="main">;</span> <span class="main">!!</span> <span class="bound">e</span><span class="main">.</span> <span class="free">f</span> <span class="bound">e</span> <span class="free">n</span> <span class="main">=</span> <span class="bound">e</span><span class="main">;</span> <span class="main">!!</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">c</span> <span class="main">⟧</span> <span class="main">⟹</span> foldl <span class="free">f</span> <span class="bound">i</span> <span class="free">ww</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">(</span>foldl <span class="free">f</span> <span class="free">n</span> <span class="free">ww</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ww</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">ww</span> <span class="skolem">i</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span><span class="main">=</span>this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldl <span class="free">f</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">ww</span><span class="main">)</span> <span class="main">=</span> foldl <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">i</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">ww</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> IHP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">i</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>foldl <span class="free">f</span> <span class="free">n</span> <span class="skolem">ww</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">i</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span> <span class="main">(</span>foldl <span class="free">f</span> <span class="free">n</span> <span class="skolem">ww</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> IHP<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">i</span> <span class="main">(</span>foldl <span class="free">f</span> <span class="skolem">a</span> <span class="skolem">ww</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">i</span> <span class="main">(</span>foldl <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="free">n</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">ww</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">i</span> <span class="main">(</span>foldl <span class="free">f</span> <span class="free">n</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">ww</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemmas</span></span> foldl_conc_empty_eq <span class="main">=</span> foldl_A1_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(@)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> foldl_un_empty_eq <span class="main">=</span> foldl_A1_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(∪)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> Un_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>

<span class="keyword1" id="Misc-foldl_set"><span class="command">lemma</span></span> foldl_set<span class="main">:</span> <span class="quoted"><span class="quoted">"foldl <span class="main">(∪)</span> <span class="main">{}</span> <span class="free">l</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>set <span class="free">l</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> foldl_un_empty_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monoid_mult<span class="main">)</span> foldl_absorb1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">*</span>foldl <span class="main">(*)</span> <span class="main">1</span> <span class="free">zs</span> <span class="main">=</span> foldl <span class="main">(*)</span> <span class="free">x</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> foldl_A1_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.assoc<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Towards an invariant rule for foldl›</span></span>
<span class="keyword1" id="Misc-foldl_rule_aux"><span class="command">lemma</span></span> foldl_rule_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'σ</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> initial<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">σ0</span> <span class="free">l0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">l1</span> <span class="bound">l2</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">l0</span><span class="main">=</span><span class="bound">l1</span><span class="main">@</span><span class="bound">x</span><span class="main">#</span><span class="bound">l2</span><span class="main">;</span> <span class="free">I</span> <span class="bound">σ</span> <span class="main">(</span><span class="bound">x</span><span class="main">#</span><span class="bound">l2</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">(</span><span class="free">f</span> <span class="bound">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">l2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">(</span>foldl <span class="free">f</span> <span class="free">σ0</span> <span class="free">l0</span><span class="main">)</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> initial step
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l0</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ0</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-foldl_rule_aux_P"><span class="command">lemma</span></span> foldl_rule_aux_P<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'σ</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> initial<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">σ0</span> <span class="free">l0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">l1</span> <span class="bound">l2</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">l0</span><span class="main">=</span><span class="bound">l1</span><span class="main">@</span><span class="bound">x</span><span class="main">#</span><span class="bound">l2</span><span class="main">;</span> <span class="free">I</span> <span class="bound">σ</span> <span class="main">(</span><span class="bound">x</span><span class="main">#</span><span class="bound">l2</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">(</span><span class="free">f</span> <span class="bound">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">l2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> final<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">σ</span><span class="main">.</span> <span class="free">I</span> <span class="bound">σ</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>foldl <span class="free">f</span> <span class="free">σ0</span> <span class="free">l0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> foldl_rule_aux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">σ0</span></span> <span class="quoted"><span class="free">l0</span></span><span class="main">,</span> <span class="operator">OF</span> initial<span class="main">,</span> <span class="operator">OF</span> step<span class="main">]</span> final
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1" id="Misc-foldl_rule"><span class="command">lemma</span></span> foldl_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'σ</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> initial<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">σ0</span> <span class="main">[]</span> <span class="free">l0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">l1</span> <span class="bound">l2</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">l0</span><span class="main">=</span><span class="bound">l1</span><span class="main">@</span><span class="bound">x</span><span class="main">#</span><span class="bound">l2</span><span class="main">;</span> <span class="free">I</span> <span class="bound">σ</span> <span class="bound">l1</span> <span class="main">(</span><span class="bound">x</span><span class="main">#</span><span class="bound">l2</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">(</span><span class="free">f</span> <span class="bound">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">l1</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="bound">l2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">(</span>foldl <span class="free">f</span> <span class="free">σ0</span> <span class="free">l0</span><span class="main">)</span> <span class="free">l0</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> initial step
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span> <span class="bound">lr</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ll</span><span class="main">.</span> <span class="free">l0</span><span class="main">=</span><span class="bound">ll</span><span class="main">@</span><span class="bound">lr</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">σ</span> <span class="bound">ll</span> <span class="bound">lr</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> foldl_rule_aux_P<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Invariant rule for foldl. The invariant is parameterized with
  the state, the list of items that have already been processed and
  the list of items that still have to be processed.
›</span></span>
<span class="keyword1" id="Misc-foldl_rule_P"><span class="command">lemma</span></span> foldl_rule_P<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'σ</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
  <span class="comment1">― ‹The invariant holds for the initial state, no items processed yet and all items to be processed:›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> initial<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">σ0</span> <span class="main">[]</span> <span class="free">l0</span>"</span></span>
  <span class="comment1">― ‹The invariant remains valid if one item from the list is processed›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">l1</span> <span class="bound">l2</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">l0</span><span class="main">=</span><span class="bound">l1</span><span class="main">@</span><span class="bound">x</span><span class="main">#</span><span class="bound">l2</span><span class="main">;</span> <span class="free">I</span> <span class="bound">σ</span> <span class="bound">l1</span> <span class="main">(</span><span class="bound">x</span><span class="main">#</span><span class="bound">l2</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">(</span><span class="free">f</span> <span class="bound">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">l1</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="bound">l2</span>"</span></span>
  <span class="comment1">― ‹The proposition follows from the invariant in the final state, i.e. all items processed and nothing to be processed›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> final<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">σ</span><span class="main">.</span> <span class="free">I</span> <span class="bound">σ</span> <span class="free">l0</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>foldl <span class="free">f</span> <span class="free">σ0</span> <span class="free">l0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> foldl_rule<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span><span class="main">,</span> <span class="operator">OF</span> initial step<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> final<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariant reasoning over <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> foldl<span class="antiquote"><span class="antiquote">}</span></span></span></span> for distinct lists. Invariant rule makes no
  assumptions about ordering.›</span></span>
<span class="keyword1" id="Misc-distinct_foldl_invar"><span class="command">lemma</span></span> distinct_foldl_invar<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> distinct <span class="free">S</span><span class="main">;</span> <span class="free">I</span> <span class="main">(</span>set <span class="free">S</span><span class="main">)</span> <span class="free">σ0</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">x</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> <span class="bound">it</span><span class="main">;</span> <span class="bound">it</span> <span class="main">⊆</span> set <span class="free">S</span><span class="main">;</span> <span class="free">I</span> <span class="bound">it</span> <span class="bound">σ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">(</span><span class="bound">it</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">σ</span> <span class="bound">x</span><span class="main">)</span>
   <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">{}</span> <span class="main">(</span>foldl <span class="free">f</span> <span class="free">σ0</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ0</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">S</span><span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> Cons.prems<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">simplified</span><span class="main">]</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons.hyps<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">S</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span>
                       <span class="operator">OF</span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">(</span>set <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">σ0</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xx</span> <span class="skolem">it</span> <span class="skolem">σ</span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xx</span><span class="main">∈</span><span class="skolem">it</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">it</span> <span class="main">⊆</span> set <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">it</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">(</span><span class="skolem">it</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">xx</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">σ</span> <span class="skolem">xx</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> Cons.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-foldl_length_aux"><span class="command">lemma</span></span> foldl_length_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"foldl <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="free">a</span> <span class="free">l</span> <span class="main">=</span> <span class="free">a</span> <span class="main">+</span> length <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> foldl_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> foldl_length_aux<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="Misc-foldr_length_aux"><span class="command">lemma</span></span> foldr_length_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"foldr <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="free">l</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a</span> <span class="main">+</span> length <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> foldr_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> foldr_length_aux<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span> comp_fun_commute <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Misc-foldl_f_commute"><span class="command">lemma</span></span> foldl_f_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">a</span> <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="bound">b</span> <span class="bound">a</span><span class="main">)</span> <span class="free">b</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="bound">b</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_left_comm<span class="main">)</span>

<span class="keyword1" id="Misc-foldr_conv_foldl"><span class="command">lemma</span></span> foldr_conv_foldl<span class="main">:</span> <span class="quoted"><span class="quoted">"foldr <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span> <span class="main">=</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="bound">b</span> <span class="bound">a</span><span class="main">)</span> <span class="free">a</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldl_f_commute<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Misc-filter_conv_foldr"><span class="command">lemma</span></span> filter_conv_foldr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> foldr <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">P</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="keyword1">else</span> <span class="bound">xs</span><span class="main">)</span> <span class="free">xs</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Misc-foldr_Cons"><span class="command">lemma</span></span> foldr_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"foldr Cons <span class="free">xs</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Misc-foldr_snd_zip"><span class="command">lemma</span></span> foldr_snd_zip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≥</span> length <span class="free">ys</span> <span class="main">⟹</span> foldr <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="free">b</span> <span class="main">=</span> foldr <span class="free">f</span> <span class="free">ys</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-foldl_snd_zip"><span class="command">lemma</span></span> foldl_snd_zip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≥</span> length <span class="free">ys</span> <span class="main">⟹</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">b</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">b</span> <span class="bound">y</span><span class="main">)</span> <span class="free">b</span> <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> foldl <span class="free">f</span> <span class="free">b</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-fst_foldl"><span class="command">lemma</span></span> fst_foldl<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> foldl <span class="free">f</span> <span class="free">a</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Misc-foldl_foldl_conv_concat"><span class="command">lemma</span></span> foldl_foldl_conv_concat<span class="main">:</span> <span class="quoted"><span class="quoted">"foldl <span class="main">(</span>foldl <span class="free">f</span><span class="main">)</span> <span class="free">a</span> <span class="free">xs</span> <span class="main">=</span> foldl <span class="free">f</span> <span class="free">a</span> <span class="main">(</span>concat <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Misc-foldl_list_update"><span class="command">lemma</span></span> foldl_list_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> foldl <span class="free">f</span> <span class="free">a</span> <span class="main">(</span><span class="free">xs</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> foldl <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>foldl <span class="free">f</span> <span class="free">a</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upd_conv_take_nth_drop<span class="main">)</span>

<span class="keyword1" id="Misc-map_by_foldl"><span class="command">lemma</span></span> map_by_foldl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">l</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(</span><span class="main">λ</span><span class="bound">l</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">l</span><span class="main">@</span><span class="main">[</span><span class="free">f</span> <span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">[]</span> <span class="free">l</span> <span class="main">=</span> map <span class="free">f</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l'</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(</span><span class="main">λ</span><span class="bound">l</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">l</span><span class="main">@</span><span class="main">[</span><span class="free">f</span> <span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">l'</span> <span class="free">l</span> <span class="main">=</span> <span class="skolem">l'</span><span class="main">@</span>map <span class="free">f</span> <span class="free">l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">l'</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Sorting›</span></span>

<span class="keyword1" id="Misc-sorted_in_between"><span class="command">lemma</span></span> sorted_in_between<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span>length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">!</span><span class="free">i</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">&lt;</span><span class="free">l</span><span class="main">!</span><span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≤</span><span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">&lt;</span><span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">!</span><span class="free">k</span><span class="main">≤</span><span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">&lt;</span><span class="free">l</span><span class="main">!</span><span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A E <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span><span class="main">≤</span><span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span><span class="main">&lt;</span><span class="free">j</span> <span class="main">∧</span> <span class="free">l</span><span class="main">!</span><span class="bound">k</span><span class="main">≤</span><span class="free">x</span> <span class="main">∧</span> <span class="free">x</span><span class="main">&lt;</span><span class="free">l</span><span class="main">!</span><span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">-</span><span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">!</span><span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> True Suc.hyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">+</span><span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems Suc_eq_plus1 Suc_lessI not_less<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">≤</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">≤</span><span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">&lt;</span><span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">!</span><span class="skolem">k</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">&lt;</span><span class="free">l</span><span class="main">!</span><span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc.hyps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">+</span><span class="main">1</span>"</span></span><span class="main">]</span> Suc.prems True
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Suc_leD<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">&lt;</span><span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">from</span></span> True Suc.hyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> True Suc.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 Suc_lessI diff_Suc_1 less_diff_conv not_le<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> True Suc.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">≤</span><span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">&lt;</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">!</span><span class="skolem">k</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">&lt;</span><span class="free">l</span><span class="main">!</span><span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Suc.hyps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> Suc.prems True
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Suc_leD<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_leI add_0_iff add_diff_inverse diff_Suc_1 le_add2 lessI
              not0_implies_Suc not_less<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-sorted_hd_last"><span class="command">lemma</span></span> sorted_hd_last<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>sorted <span class="free">l</span><span class="main">;</span> <span class="free">l</span><span class="main">≠</span><span class="main">[]</span><span class="main">⟧</span> <span class="main">⟹</span> hd <span class="free">l</span> <span class="main">≤</span> last <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_iff hd_Cons_tl last_in_set not_hd_in_tl sorted.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> linorder<span class="main">)</span> sorted_hd_min<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> sorted <span class="free">xs</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> hd <span class="free">xs</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Misc-sorted_append_bigger"><span class="command">lemma</span></span> sorted_append_bigger<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>sorted <span class="free">xs</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">y</span><span class="main">⟧</span> <span class="main">⟹</span> sorted <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> s a<span class="main">]</span> Cons<span class="main">(</span>2-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-sorted_filter'"><span class="command">lemma</span></span> sorted_filter'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted <span class="free">l</span> <span class="main">⟹</span> sorted <span class="main">(</span>filter <span class="free">P</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sorted_filter<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted">id</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Map›</span></span>
<span class="comment1">(* List.thy has:
 declare map_eq_Cons_D [dest!]  Cons_eq_map_D [dest!] *)</span>  
<span class="keyword1" id="Misc-map_eq_consE"><span class="command">lemma</span></span> map_eq_consE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>map <span class="free">f</span> <span class="free">ls</span> <span class="main">=</span> <span class="free">fa</span><span class="main">#</span><span class="free">fl</span><span class="main">;</span> <span class="main">!!</span><span class="bound">a</span> <span class="bound">l</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">ls</span><span class="main">=</span><span class="bound">a</span><span class="main">#</span><span class="bound">l</span><span class="main">;</span> <span class="free">f</span> <span class="bound">a</span><span class="main">=</span><span class="free">fa</span><span class="main">;</span> map <span class="free">f</span> <span class="bound">l</span> <span class="main">=</span> <span class="free">fl</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-map_fst_mk_snd"><span class="command">lemma</span></span> map_fst_mk_snd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map fst <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Misc-map_snd_mk_fst"><span class="command">lemma</span></span> map_snd_mk_fst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Misc-map_fst_mk_fst"><span class="command">lemma</span></span> map_fst_mk_fst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map fst <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span>length <span class="free">l</span><span class="main">)</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Misc-map_snd_mk_snd"><span class="command">lemma</span></span> map_snd_mk_snd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span>length <span class="free">l</span><span class="main">)</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-map_zip1"><span class="command">lemma</span></span> map_zip1<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> zip <span class="free">l</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="free">l</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Misc-map_zip2"><span class="command">lemma</span></span> map_zip2<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> zip <span class="main">(</span>replicate <span class="main">(</span>length <span class="free">l</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemmas</span></span> map_zip<span class="main">=</span>map_zip1 map_zip2

<span class="comment1">(* TODO/FIXME: hope nobody changes nth to be underdefined! *)</span>
<span class="keyword1" id="Misc-map_eq_nth_eq"><span class="command">lemma</span></span> map_eq_nth_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="free">l</span> <span class="main">=</span> map <span class="free">f</span> <span class="free">l'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">l'</span><span class="main">!</span><span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">=</span> length <span class="free">l'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-map_upd_eq"><span class="command">lemma</span></span> map_upd_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">i</span><span class="main">&lt;</span>length <span class="free">l</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span><span class="main">⟧</span> <span class="main">⟹</span> map <span class="free">f</span> <span class="main">(</span><span class="free">l</span><span class="main">[</span><span class="free">i</span><span class="main">:=</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> map <span class="free">f</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_update_beyond list_update_id map_update not_le_imp_less<span class="main">)</span>




<span class="keyword1" id="Misc-inj_map_inv_f"><span class="command">lemma</span></span> inj_map_inv_f <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span> <span class="main">⟹</span> map <span class="main">(</span>inv <span class="free">f</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Misc-inj_on_map_the"><span class="command">lemma</span></span> inj_on_map_the<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">D</span> <span class="main">⊆</span> dom <span class="free">m</span><span class="main">;</span> inj_on <span class="free">m</span> <span class="free">D</span><span class="main">⟧</span> <span class="main">⟹</span> inj_on <span class="main">(</span>the<span class="main">∘</span><span class="free">m</span><span class="main">)</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="improper">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="improper">y</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_onD<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_onD<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="improper">y</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_onD<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inj_onD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    

<span class="keyword1" id="Misc-map_consI"><span class="command">lemma</span></span> map_consI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">=</span>map <span class="free">f</span> <span class="free">ww</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">a</span><span class="main">#</span><span class="free">w</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">ww</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">@</span><span class="free">l</span><span class="main">=</span>map <span class="free">f</span> <span class="free">ww</span><span class="main">@</span><span class="free">l</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">a</span><span class="main">#</span><span class="free">w</span><span class="main">@</span><span class="free">l</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">ww</span><span class="main">)</span><span class="main">@</span><span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1" id="Misc-restrict_map_subset_eq"><span class="command">lemma</span></span> restrict_map_subset_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">m</span> <span class="main">|`</span> <span class="free">R</span> <span class="main">=</span> <span class="free">m'</span><span class="main">;</span> <span class="free">R'</span><span class="main">⊆</span><span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span><span class="main">|`</span> <span class="free">R'</span> <span class="main">=</span> <span class="free">m'</span> <span class="main">|`</span> <span class="free">R'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_absorb1<span class="main">)</span>

<span class="keyword1" id="Misc-restrict_map_self"><span class="command">lemma</span></span> restrict_map_self<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">|`</span> dom <span class="free">m</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="improper">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_map_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-restrict_map_UNIV"><span class="command">lemma</span></span> restrict_map_UNIV<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">|`</span> UNIV <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_map_def<span class="main">)</span>

<span class="keyword1" id="Misc-restrict_map_inv"><span class="command">lemma</span></span> restrict_map_inv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">|`</span> <span class="main">(</span><span class="main">-</span> dom <span class="free">f</span><span class="main">)</span> <span class="main">=</span> Map.empty"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_map_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1" id="Misc-restrict_map_upd"><span class="command">lemma</span></span> restrict_map_upd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">|`</span> <span class="free">S</span><span class="main">)</span><span class="main">(</span><span class="free">k</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span><span class="main">(</span><span class="free">k</span><span class="main">↦</span><span class="free">v</span><span class="main">)</span> <span class="main">|`</span> <span class="main">(</span>insert <span class="free">k</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_map_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1" id="Misc-map_upd_eq_restrict"><span class="command">lemma</span></span> map_upd_eq_restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">(</span><span class="free">x</span><span class="main">:=</span>None<span class="main">)</span> <span class="main">=</span> <span class="free">m</span> <span class="main">|`</span> <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> Map.finite_dom_map_of <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span>

<span class="keyword1" id="Misc-dom_const'"><span class="command">lemma</span></span> dom_const'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Some <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-restrict_map_eq"><span class="command">lemma</span></span> restrict_map_eq <span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">m</span> <span class="main">|`</span> <span class="free">A</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">k</span> <span class="main">∉</span> dom <span class="free">m</span> <span class="main">∩</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">m</span> <span class="main">|`</span> <span class="free">A</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">m</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> restrict_map_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_def<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rel_of</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">==</span> <span class="main">{</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">k</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1" id="Misc-rel_of_empty"><span class="command">lemma</span></span> rel_of_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_of Map.empty <span class="free">P</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_of_def<span class="main">)</span>

<span class="keyword1" id="Misc-remove1_tl"><span class="command">lemma</span></span> remove1_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> remove1 <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> tl <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-set_oo_map_alt"><span class="command">lemma</span></span> set_oo_map_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="main">∘∘</span> map<span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> set <span class="bound">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Filter and Revert"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">filter_rev_aux</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">filter_rev_aux</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">filter_rev_aux</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free">filter_rev_aux</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">else</span> <span class="free">filter_rev_aux</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Misc-filter_rev_aux_alt"><span class="command">lemma</span></span> filter_rev_aux_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"filter_rev_aux <span class="free">a</span> <span class="free">P</span> <span class="free">l</span> <span class="main">=</span> filter <span class="free">P</span> <span class="main">(</span>rev <span class="free">l</span><span class="main">)</span> <span class="main">@</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">filter_rev</span> <span class="main">==</span> filter_rev_aux <span class="main">[]</span>"</span></span>
<span class="keyword1" id="Misc-filter_rev_alt"><span class="command">lemma</span></span> filter_rev_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"filter_rev <span class="free">P</span> <span class="free">l</span> <span class="main">=</span> filter <span class="free">P</span> <span class="main">(</span>rev <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> filter_rev_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_rev_aux_alt<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">remove_rev</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">==</span> filter_rev <span class="main">(</span>Not <span class="keyword1">o</span> <span class="main">(=)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1" id="Misc-remove_rev_alt_def"><span class="command">lemma</span></span> remove_rev_alt_def <span class="main">:</span>
  <span class="quoted"><span class="quoted">"remove_rev <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> remove_rev_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_rev_alt comp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"zip"</span></span>

<span class="keyword1"><span class="command">declare</span></span> zip_map_fst_snd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>  

<span class="keyword1" id="Misc-pair_list_split"><span class="command">lemma</span></span> pair_list_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">!!</span><span class="bound">l1</span> <span class="bound">l2</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">l</span> <span class="main">=</span> zip <span class="bound">l1</span> <span class="bound">l2</span><span class="main">;</span> length <span class="bound">l1</span><span class="main">=</span>length <span class="bound">l2</span><span class="main">;</span> length <span class="free">l</span><span class="main">=</span>length <span class="bound">l2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> Cons.hyps <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">l2</span></span> <span class="keyword2"><span class="keyword">where</span></span> IHAPP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">=</span>zip <span class="skolem">l1</span> <span class="skolem">l2</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l1</span> <span class="main">=</span> length <span class="skolem">l2</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span><span class="main">=</span>length <span class="skolem">l2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="skolem"><span class="skolem">a2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="main">(</span><span class="skolem">a1</span><span class="main">,</span><span class="skolem">a2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> IHAPP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span> <span class="main">=</span> zip <span class="main">(</span><span class="skolem">a1</span><span class="main">#</span><span class="skolem">l1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a2</span><span class="main">#</span><span class="skolem">l2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">a1</span><span class="main">#</span><span class="skolem">l1</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">a2</span><span class="main">#</span><span class="skolem">l2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">a2</span><span class="main">#</span><span class="skolem">l2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_use</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Cons.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-set_zip_cart"><span class="command">lemma</span></span> set_zip_cart<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="free">l</span> <span class="free">l'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span>set <span class="free">l</span> <span class="main">×</span> set <span class="free">l'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_zip<span class="main">)</span>


<span class="keyword1" id="Misc-map_prod_fun_zip"><span class="command">lemma</span></span> map_prod_fun_zip<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> zip <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>map <span class="free">g</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Generalized Zip›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Zip two lists element-wise, where the combination of two elements is specified by a function. Note that this function is underdefined for lists of different length.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">zipf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'b</span><span class="main">⇒</span><span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'c</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zipf</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">zipf</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free">zipf</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span>"</span></span>


<span class="keyword1" id="Misc-zipf_zip"><span class="command">lemma</span></span> zipf_zip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>length <span class="free">l1</span> <span class="main">=</span> length <span class="free">l2</span><span class="main">⟧</span> <span class="main">⟹</span> zipf Pair <span class="free">l1</span> <span class="free">l2</span> <span class="main">=</span> zip <span class="free">l1</span> <span class="free">l2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l2</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">l2</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="comment1">― ‹All quantification over zipped lists›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">list_all_zip</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_all_zip</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">list_all_zip</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> <span class="free">list_all_zip</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">list_all_zip</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> False"</span></span>

<span class="keyword1" id="Misc-list_all_zip_alt"><span class="command">lemma</span></span> list_all_zip_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all_zip <span class="free">P</span> <span class="free">as</span> <span class="free">bs</span> <span class="main">⟷</span> length <span class="free">as</span> <span class="main">=</span> length <span class="free">bs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">as</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">as</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">bs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="skolem">P</span><span class="main"><span class="main">≡</span></span><span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all_zip.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-list_all_zip_map1"><span class="command">lemma</span></span> list_all_zip_map1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all_zip <span class="free">P</span> <span class="main">(</span>List.map <span class="free">f</span> <span class="free">as</span><span class="main">)</span> <span class="free">bs</span> <span class="main">⟷</span> list_all_zip <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span> <span class="free">as</span> <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">bs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">bs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-list_all_zip_map2"><span class="command">lemma</span></span> list_all_zip_map2<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all_zip <span class="free">P</span> <span class="free">as</span> <span class="main">(</span>List.map <span class="free">f</span> <span class="free">bs</span><span class="main">)</span> <span class="main">⟷</span> list_all_zip <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="free">as</span> <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">bs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">bs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> list_all_zip_alt<span class="main">[</span><span class="operator">mono</span><span class="main">]</span>

<span class="keyword1" id="Misc-lazI"><span class="command">lemma</span></span> lazI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> length <span class="free">a</span> <span class="main">=</span> length <span class="free">b</span><span class="main">;</span> <span class="main">!!</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">b</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="free">a</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> list_all_zip <span class="free">P</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_zip_alt<span class="main">)</span>

<span class="keyword1" id="Misc-laz_conj"><span class="command">lemma</span></span> laz_conj<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"list_all_zip <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">a</span> <span class="free">b</span>
                       <span class="main">⟷</span> list_all_zip <span class="free">P</span> <span class="free">a</span> <span class="free">b</span> <span class="main">∧</span> list_all_zip <span class="free">Q</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_zip_alt<span class="main">)</span>

<span class="keyword1" id="Misc-laz_len"><span class="command">lemma</span></span> laz_len<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all_zip <span class="free">P</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> length <span class="free">a</span> <span class="main">=</span> length <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_zip_alt<span class="main">)</span>

<span class="keyword1" id="Misc-laz_eq"><span class="command">lemma</span></span> laz_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all_zip <span class="main">(=)</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">a</span><span class="main">=</span><span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="Misc-laz_swap_ex"><span class="command">lemma</span></span> laz_swap_ex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all_zip <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">∃</span><span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">C</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"list_all_zip <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">c</span><span class="main">.</span> <span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span> <span class="free">A</span> <span class="free">C</span>"</span></span>
    <span class="quoted"><span class="quoted">"list_all_zip <span class="main">(</span><span class="main">λ</span><span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span> <span class="free">B</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span>
    <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">A</span> <span class="main">=</span> length <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    IC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">B</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ci</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">A</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="bound">ci</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_zip_alt<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> obtain_list_from_elements<span class="main">[</span><span class="operator">OF</span> IC<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"length <span class="skolem">C</span> <span class="main">=</span> length <span class="free">B</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">B</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">A</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">C</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> that<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_zip_alt<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-laz_weak_Pa"><span class="command">lemma</span></span> laz_weak_Pa<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all_zip <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span><span class="main">)</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟷</span> <span class="main">(</span>length <span class="free">A</span> <span class="main">=</span> length <span class="free">B</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_zip_alt set_conv_nth<span class="main">)</span>

<span class="keyword1" id="Misc-laz_weak_Pb"><span class="command">lemma</span></span> laz_weak_Pb<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all_zip <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="bound">b</span><span class="main">)</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟷</span> <span class="main">(</span>length <span class="free">A</span> <span class="main">=</span> length <span class="free">B</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">b</span><span class="main">∈</span>set <span class="free">B</span><span class="main">.</span> <span class="free">P</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_zip_alt set_conv_nth<span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Collecting Sets over Lists"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">list_collect_set</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">==</span> <span class="main">⋃</span><span class="main">{</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="main">|</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">}</span>"</span></span>
<span class="keyword1" id="Misc-list_collect_set_simps"><span class="command">lemma</span></span> list_collect_set_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_collect_set <span class="free">f</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"list_collect_set <span class="free">f</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span>"</span></span>
  <span class="quoted"><span class="quoted">"list_collect_set <span class="free">f</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span> <span class="main">∪</span> list_collect_set <span class="free">f</span> <span class="free">l</span>"</span></span>
  <span class="quoted"><span class="quoted">"list_collect_set <span class="free">f</span> <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="free">l'</span><span class="main">)</span> <span class="main">=</span> list_collect_set <span class="free">f</span> <span class="free">l</span> <span class="main">∪</span> list_collect_set <span class="free">f</span> <span class="free">l'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> list_collect_set_def<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-list_collect_set_map_simps"><span class="command">lemma</span></span> list_collect_set_map_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_collect_set <span class="free">f</span> <span class="main">(</span>map <span class="free">x</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"list_collect_set <span class="free">f</span> <span class="main">(</span>map <span class="free">x</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"list_collect_set <span class="free">f</span> <span class="main">(</span>map <span class="free">x</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="free">a</span><span class="main">)</span> <span class="main">∪</span> list_collect_set <span class="free">f</span> <span class="main">(</span>map <span class="free">x</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"list_collect_set <span class="free">f</span> <span class="main">(</span>map <span class="free">x</span> <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="free">l'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> list_collect_set <span class="free">f</span> <span class="main">(</span>map <span class="free">x</span> <span class="free">l</span><span class="main">)</span> <span class="main">∪</span> list_collect_set <span class="free">f</span> <span class="main">(</span>map <span class="free">x</span> <span class="free">l'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Misc-list_collect_set_alt"><span class="command">lemma</span></span> list_collect_set_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"list_collect_set <span class="free">f</span> <span class="free">l</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span> <span class="free">f</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">l</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="improper">l</span><span class="main">!</span><span class="improper">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-list_collect_set_as_map"><span class="command">lemma</span></span> list_collect_set_as_map<span class="main">:</span> <span class="quoted"><span class="quoted">"list_collect_set <span class="free">f</span> <span class="free">l</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map <span class="free">f</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> list_collect_set_def<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Sorted List with arbitrary Relations›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> linorder<span class="main">)</span> sorted_wrt_rev_linord <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(≥)</span> <span class="free">l</span> <span class="main">⟷</span> sorted <span class="main">(</span>rev <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_sorted_wrt sorted_wrt_rev<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> linorder<span class="main">)</span> sorted_wrt_map_linord <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">≤</span> fst <span class="bound">y</span><span class="main">)</span> <span class="free">l</span>
  <span class="main">⟷</span> sorted <span class="main">(</span>map fst <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_sorted_wrt sorted_wrt_map<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> linorder<span class="main">)</span> sorted_wrt_map_rev_linord <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">≥</span> fst <span class="bound">y</span><span class="main">)</span> <span class="free">l</span>
  <span class="main">⟷</span> sorted <span class="main">(</span>rev <span class="main">(</span>map fst <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_append<span class="main">)</span>

    
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Take and Drop›</span></span>
  <span class="keyword1" id="Misc-take_update"><span class="command">lemma</span></span> take_update<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="main">(</span><span class="free">l</span><span class="main">[</span><span class="free">i</span><span class="main">:=</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">l</span><span class="main">)</span><span class="main">[</span><span class="free">i</span><span class="main">:=</span><span class="free">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">n</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">n</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Misc-take_update_last"><span class="command">lemma</span></span> take_update_last<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">list</span><span class="main">&gt;</span><span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">list</span><span class="main">)</span> <span class="main">[</span><span class="free">n</span><span class="main">:=</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> take <span class="free">n</span> <span class="free">list</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">list</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

  <span class="keyword1" id="Misc-drop_upd_irrelevant"><span class="command">lemma</span></span> drop_upd_irrelevant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> drop <span class="free">n</span> <span class="main">(</span><span class="free">l</span><span class="main">[</span><span class="free">m</span><span class="main">:=</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> drop <span class="free">n</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">l</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-set_drop_conv"><span class="command">lemma</span></span> set_drop_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>drop <span class="free">n</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span>  <span class="main">{</span> <span class="free">l</span><span class="main">!</span><span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="free">n</span><span class="main">≤</span><span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span><span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="var">?L</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span>length <span class="free">l</span> <span class="main">-</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> drop <span class="free">n</span> <span class="free">l</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> X
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">l</span><span class="main">!</span><span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">≤</span><span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span>length <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="free">l</span><span class="main">!</span><span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> X
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> drop <span class="free">n</span> <span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">-</span><span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">-</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="var">?L</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-filter_upt_take_conv"><span class="command">lemma</span></span> filter_upt_take_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">i</span><span class="main">←</span><span class="main">[</span><span class="free">n</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>take <span class="free">m</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">i</span><span class="main">←</span><span class="main">[</span><span class="free">n</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> filter_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Misc-in_set_drop_conv_nth"><span class="command">lemma</span></span> in_set_drop_conv_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="free">n</span> <span class="free">l</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span><span class="main">≤</span><span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">l</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="free">l</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> le_add2 less_diff_conv add.commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">i</span><span class="main">-</span><span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-Union_take_drop_id"><span class="command">lemma</span></span> Union_take_drop_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>drop <span class="free">n</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>take <span class="free">n</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Union_Un_distrib append_take_drop_id set_union_code sup_commute<span class="main">)</span>


<span class="keyword1" id="Misc-Un_set_drop_extend"><span class="command">lemma</span></span> Un_set_drop_extend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">j</span><span class="main">≥</span>Suc <span class="main">0</span><span class="main">;</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span><span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>drop <span class="free">j</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>drop <span class="main">(</span><span class="free">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> diff_Suc_Suc diff_zero gr0_implies_Suc in_set_drop_conv_nth
    le_refl less_eq_Suc_le order.strict_iff_order<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Nat.diff_le_self set_drop_subset_set_drop subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_Suc_Suc gr0_implies_Suc in_set_drop_conv_nth
    less_eq_Suc_le order.strict_iff_order minus_nat.diff_0<span class="main">)</span>

<span class="keyword1" id="Misc-drop_take_drop_unsplit"><span class="command">lemma</span></span> drop_take_drop_unsplit<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≤</span><span class="free">j</span> <span class="main">⟹</span> drop <span class="free">i</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">l</span><span class="main">)</span> <span class="main">@</span> drop <span class="free">j</span> <span class="free">l</span> <span class="main">=</span> drop <span class="free">i</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">skf</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="skolem">skf</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_iff_add<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">i</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">l</span><span class="main">)</span> <span class="main">@</span> drop <span class="free">j</span> <span class="free">l</span> <span class="main">=</span> drop <span class="free">i</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id diff_add_inverse drop_drop drop_take
      add.commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-drop_last_conv"><span class="command">lemma</span></span> drop_last_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">≠</span><span class="main">[]</span> <span class="main">⟹</span> drop <span class="main">(</span>length <span class="free">l</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> <span class="main">[</span>last <span class="free">l</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-take_butlast_conv"><span class="command">lemma</span></span> take_butlast_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="free">l</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> butlast <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1" id="Misc-drop_takeWhile"><span class="command">lemma</span></span> drop_takeWhile<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≤</span>length <span class="main">(</span>takeWhile <span class="free">P</span> <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">i</span> <span class="main">(</span>takeWhile <span class="free">P</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> takeWhile <span class="free">P</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">l</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">l</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>    
  
<span class="keyword1" id="Misc-less_length_takeWhile_conv"><span class="command">lemma</span></span> less_length_takeWhile_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>takeWhile <span class="free">P</span> <span class="free">l</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">i</span><span class="main">&lt;</span>length <span class="free">l</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> length_takeWhile_le less_le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.strict_trans2 nth_mem set_takeWhileD takeWhile_nth<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> less_le_trans not_le_imp_less nth_length_takeWhile<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1" id="Misc-eq_len_takeWhile_conv"><span class="command">lemma</span></span> eq_len_takeWhile_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">=</span>length <span class="main">(</span>takeWhile <span class="free">P</span> <span class="free">l</span><span class="main">)</span> 
  <span class="main">⟷</span> <span class="free">i</span><span class="main">≤</span>length <span class="free">l</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">i</span><span class="main">&lt;</span>length <span class="free">l</span> <span class="main">⟶</span> <span class="main">¬</span><span class="free">P</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> length_takeWhile_le less_le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_length_takeWhile_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> nth_length_takeWhile <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_takeWhile_le nth_length_takeWhile order.order_iff_strict<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.strict_trans2 leI less_length_takeWhile_conv linorder_neqE_nat nth_length_takeWhile<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
    
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Up-to›</span></span>

<span class="keyword1" id="Misc-upt_eq_append_conv"><span class="command">lemma</span></span> upt_eq_append_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≤</span><span class="free">j</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="main">=</span> <span class="free">xs</span><span class="main">@</span><span class="free">ys</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span><span class="main">≤</span><span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span><span class="main">≤</span><span class="free">j</span> <span class="main">∧</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="bound">k</span><span class="main">]</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">∧</span> <span class="main">[</span><span class="bound">k</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="main">=</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span>"</span></span>  
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≤</span><span class="free">j</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">∧</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="bound">k</span><span class="main">]</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">∧</span> <span class="main">[</span><span class="bound">k</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upt_eq_Cons_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Suc_le_eq less_imp_le_nat<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  
<span class="keyword1" id="Misc-map_nth_upt_drop_take_conv"><span class="command">lemma</span></span> map_nth_upt_drop_take_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≤</span> length <span class="free">l</span> <span class="main">⟹</span> map <span class="main">(</span>nth <span class="free">l</span><span class="main">)</span> <span class="main">[</span><span class="free">M</span><span class="main">..&lt;</span><span class="free">N</span><span class="main">]</span> <span class="main">=</span> drop <span class="free">M</span> <span class="main">(</span>take <span class="free">N</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">N</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth<span class="main">)</span>
    
<span class="keyword1" id="Misc-upt_eq_lel_conv"><span class="command">lemma</span></span> upt_eq_lel_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">]</span> <span class="main">=</span> <span class="free">is1</span><span class="main">@</span><span class="free">i</span><span class="main">#</span><span class="free">is2</span> <span class="main">⟷</span> <span class="free">is1</span> <span class="main">=</span> <span class="main">[</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span> <span class="main">∧</span> <span class="free">is2</span> <span class="main">=</span> <span class="main">[</span>Suc <span class="free">i</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">]</span> <span class="main">∧</span> <span class="free">l</span><span class="main">≤</span><span class="free">i</span> <span class="main">∧</span> <span class="free">i</span><span class="main">&lt;</span><span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">is1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upt_eq_Cons_conv<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upt_eq_Cons_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Suc_le_eq upt_rec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upt_conv_Cons<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

   
<span class="keyword1" id="Misc-map_add_upt'"><span class="command">lemma</span></span> map_add_upt'<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">+</span> <span class="free">ofs</span><span class="main">)</span> <span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">+</span><span class="free">ofs</span><span class="main">..&lt;</span><span class="free">b</span> <span class="main">+</span> <span class="free">ofs</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    
    
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Last and butlast›</span></span>
<span class="keyword1" id="Misc-butlast_upt"><span class="command">lemma</span></span> butlast_upt<span class="main">:</span> <span class="quoted"><span class="quoted">"butlast <span class="main">[</span><span class="free">m</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">m</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">&lt;</span><span class="free">n</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*lemma butlast_upt: "n&lt;m ⟹ butlast [n..&lt;m] = [n..&lt;m - 1]"
  apply (cases "[n..&lt;m]" rule: rev_cases)
  apply simp
  apply (cases m)
  apply simp
  apply simp
  done*)</span>

<span class="keyword1" id="Misc-butlast_update'"><span class="command">lemma</span></span> butlast_update'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>butlast <span class="free">l</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">:=</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> butlast <span class="main">(</span><span class="free">l</span><span class="main">[</span><span class="free">i</span><span class="main">:=</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> butlast_conv_take butlast_list_update length_butlast take_update<span class="main">)</span>


<span class="keyword1" id="Misc-take_minus_one_conv_butlast"><span class="command">lemma</span></span> take_minus_one_conv_butlast<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">≤</span>length <span class="free">l</span> <span class="main">⟹</span> take <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> butlast <span class="main">(</span>take <span class="free">n</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> butlast_take<span class="main">)</span>

<span class="keyword1" id="Misc-butlast_eq_cons_conv"><span class="command">lemma</span></span> butlast_eq_cons_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"butlast <span class="free">l</span> <span class="main">=</span> <span class="free">x</span><span class="main">#</span><span class="free">xs</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">xl</span><span class="main">.</span> <span class="free">l</span><span class="main">=</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="bound">xl</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons_eq_appendI append_butlast_last_id butlast.simps
    butlast_snoc eq_Nil_appendI<span class="main">)</span>

<span class="keyword1" id="Misc-butlast_eq_consE"><span class="command">lemma</span></span> butlast_eq_consE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"butlast <span class="free">l</span> <span class="main">=</span> <span class="free">x</span><span class="main">#</span><span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">xl</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">=</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">xl</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> butlast_eq_cons_conv<span class="main">)</span>

<span class="keyword1" id="Misc-drop_eq_ConsD"><span class="command">lemma</span></span> drop_eq_ConsD<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs'</span> <span class="main">⟹</span> drop <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_Cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹List Slices›</span></span>  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Based on Lars Hupel's code.›</span></span>  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">slice</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">slice</span> <span class="free"><span class="bound"><span class="entity">from</span></span></span> <span class="free"><span class="bound"><span class="entity">to</span></span></span> <span class="free"><span class="bound"><span class="entity">list</span></span></span> <span class="main">=</span> take <span class="main">(</span><span class="free"><span class="bound"><span class="entity">to</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">from</span></span></span><span class="main">)</span> <span class="main">(</span>drop <span class="free"><span class="bound"><span class="entity">from</span></span></span> <span class="free"><span class="bound"><span class="entity">list</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Misc-slice_len"><span class="command">lemma</span></span> slice_len<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">from</span> <span class="main">≤</span> <span class="free">to</span><span class="main">;</span> <span class="free">to</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟧</span> <span class="main">⟹</span> length <span class="main">(</span>slice <span class="free">from</span> <span class="free">to</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">to</span> <span class="main">-</span> <span class="free">from</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> slice_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-slice_head"><span class="command">lemma</span></span> slice_head<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">from</span> <span class="main">&lt;</span> <span class="free">to</span><span class="main">;</span> <span class="free">to</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟧</span> <span class="main">⟹</span> hd <span class="main">(</span>slice <span class="free">from</span> <span class="free">to</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">from</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> slice_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">from</span> <span class="main">&lt;</span> <span class="free">to</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">to</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">to</span> <span class="main">-</span> <span class="main">(</span><span class="free">to</span> <span class="main">-</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>take <span class="free">to</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> slice_def diff_le_self drop_take length_drop slice_len<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>take <span class="main">(</span><span class="free">to</span> <span class="main">-</span> <span class="free">from</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">from</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">from</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_diff_cancel drop_take hd_drop_conv_nth leI le_antisym less_or_eq_imp_le nth_take<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-slice_eq_bounds_empty"><span class="command">lemma</span></span> slice_eq_bounds_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"slice <span class="free">i</span> <span class="free">i</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> slice_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-slice_nth"><span class="command">lemma</span></span> slice_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">from</span> <span class="main">&lt;</span> <span class="free">to</span><span class="main">;</span> <span class="free">to</span> <span class="main">≤</span> length <span class="free">xs</span><span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">to</span> <span class="main">-</span> <span class="free">from</span> <span class="main">⟧</span> <span class="main">⟹</span> slice <span class="free">from</span> <span class="free">to</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span><span class="free">from</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> slice_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">to</span> <span class="main">-</span> <span class="free">from</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="free">from</span>"</span></span> <span class="quoted"><span class="free">to</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Misc-slice_prepend"><span class="command">lemma</span></span> slice_prepend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">k</span><span class="main">;</span> <span class="free">k</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="keyword1">let</span> <span class="bound">p</span> <span class="main">=</span> length <span class="free">ys</span> <span class="keyword1">in</span> slice <span class="free">i</span> <span class="free">k</span> <span class="free">xs</span> <span class="main">=</span> slice <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> slice_def Let_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Misc-slice_Nil"><span class="command">lemma</span></span> slice_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"slice <span class="free">begin</span> <span class="free">end</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>  
  <span class="keyword1"><span class="command">unfolding</span></span> slice_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1" id="Misc-slice_Cons"><span class="command">lemma</span></span> slice_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"slice <span class="free">begin</span> <span class="free">end</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> 
  <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">begin</span><span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="free">end</span><span class="main">&gt;</span><span class="main">0</span> <span class="keyword1">then</span> <span class="free">x</span><span class="main">#</span>slice <span class="free">begin</span> <span class="main">(</span><span class="free">end</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">xs</span> <span class="keyword1">else</span> slice <span class="main">(</span><span class="free">begin</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">end</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> slice_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Cons' drop_Cons'<span class="main">)</span>

<span class="keyword1" id="Misc-slice_complete"><span class="command">lemma</span></span> slice_complete<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"slice <span class="main">0</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> slice_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  
  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Miscellaneous›</span></span>
  <span class="keyword1" id="Misc-length_compl_induct"><span class="command">lemma</span></span> length_compl_induct<span class="main">[</span><span class="operator">case_names</span> Nil Cons<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">P</span> <span class="main">[]</span><span class="main">;</span> <span class="main">!!</span> <span class="bound">e</span> <span class="bound">l</span> <span class="main">.</span> <span class="main">⟦</span><span class="main">!!</span> <span class="bound">ll</span> <span class="main">.</span> length <span class="bound">ll</span> <span class="main">&lt;=</span> length <span class="bound">l</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ll</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">e</span><span class="main">#</span><span class="bound">l</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">l</span></span></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">xs</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Misc-in_set_list_format"><span class="command">lemma</span></span> in_set_list_format<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">e</span><span class="main">∈</span>set <span class="free">l</span><span class="main">;</span> <span class="main">!!</span><span class="bound">l1</span> <span class="bound">l2</span><span class="main">.</span> <span class="free">l</span><span class="main">=</span><span class="bound">l1</span><span class="main">@</span><span class="free">e</span><span class="main">#</span><span class="bound">l2</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="free">e</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">∈</span>set <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> Cons.hyps <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">l2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">=</span><span class="skolem">l1</span><span class="main">@</span><span class="free">e</span><span class="main">#</span><span class="skolem">l2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l1</span><span class="main">)</span><span class="main">@</span><span class="free">e</span><span class="main">#</span><span class="skolem">l2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-in_set_upd_cases"><span class="command">lemma</span></span> in_set_upd_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span>set <span class="main">(</span><span class="free">l</span><span class="main">[</span><span class="free">i</span><span class="main">:=</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span>length <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span><span class="free">y</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span>set <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms in_set_conv_nth length_list_update nth_list_update_eq
    nth_list_update_neq<span class="main">)</span>

<span class="keyword1" id="Misc-in_set_upd_eq_aux"><span class="command">lemma</span></span> in_set_upd_eq_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span>length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span>set <span class="main">(</span><span class="free">l</span><span class="main">[</span><span class="free">i</span><span class="main">:=</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span><span class="main">=</span><span class="free">y</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="free">x</span><span class="main">∈</span>set <span class="main">(</span><span class="free">l</span><span class="main">[</span><span class="free">i</span><span class="main">:=</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_upd_cases assms list_update_overwrite
    set_update_memI<span class="main">)</span>

<span class="keyword1" id="Misc-in_set_upd_eq"><span class="command">lemma</span></span> in_set_upd_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span>length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span>set <span class="main">(</span><span class="free">l</span><span class="main">[</span><span class="free">i</span><span class="main">:=</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span><span class="main">=</span><span class="free">y</span> <span class="main">∨</span> <span class="main">(</span><span class="free">x</span><span class="main">∈</span>set <span class="free">l</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="free">x</span><span class="main">∈</span>set <span class="main">(</span><span class="free">l</span><span class="main">[</span><span class="free">i</span><span class="main">:=</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_upd_cases in_set_upd_eq_aux assms<span class="main">)</span>


  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simultaneous induction over two lists, prepending an element to one of the lists in each step›</span></span>
  <span class="keyword1" id="Misc-list_2pre_induct"><span class="command">lemma</span></span> list_2pre_induct<span class="main">[</span><span class="operator">case_names</span> base left right<span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> BASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> LEFT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">e</span> <span class="bound">w1'</span> <span class="bound">w2</span><span class="main">.</span> <span class="free">P</span> <span class="bound">w1'</span> <span class="bound">w2</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">e</span><span class="main">#</span><span class="bound">w1'</span><span class="main">)</span> <span class="bound">w2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> RIGHT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">e</span> <span class="bound">w1</span> <span class="bound">w2'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">w1</span> <span class="bound">w2'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">w1</span> <span class="main">(</span><span class="bound">e</span><span class="main">#</span><span class="bound">w2'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">w1</span> <span class="free">w2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="comment1">― ‹The proof is done by induction over the sum of the lengths of the lists›</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">w1</span> <span class="bound">w2</span><span class="main">.</span> <span class="main">⟦</span>length <span class="bound">w1</span> <span class="main">+</span> length <span class="bound">w2</span> <span class="main">=</span> <span class="skolem">n</span><span class="main">;</span> <span class="free">P</span> <span class="main">[]</span> <span class="main">[]</span><span class="main">;</span> <span class="main">!!</span><span class="bound">e</span> <span class="bound">w1'</span> <span class="bound">w2</span><span class="main">.</span> <span class="free">P</span> <span class="bound">w1'</span> <span class="bound">w2</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">e</span><span class="main">#</span><span class="bound">w1'</span><span class="main">)</span> <span class="bound">w2</span><span class="main">;</span> <span class="main">!!</span><span class="bound">e</span> <span class="bound">w1</span> <span class="bound">w2'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">w1</span> <span class="bound">w2'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">w1</span> <span class="main">(</span><span class="bound">e</span><span class="main">#</span><span class="bound">w2'</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">w1</span> <span class="bound">w2</span> "</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">w1</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">w2</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">OF</span> _ BASE LEFT RIGHT<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>


  <span class="keyword1" id="Misc-list_decomp_1"><span class="command">lemma</span></span> list_decomp_1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">l</span><span class="main">=</span><span class="main">1</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">l</span><span class="main">=</span><span class="main">[</span><span class="bound">a</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Misc-list_decomp_2"><span class="command">lemma</span></span> list_decomp_2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">l</span><span class="main">=</span><span class="numeral">2</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">l</span><span class="main">=</span><span class="main">[</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_decomp_1<span class="main">)</span>



  <span class="keyword1" id="Misc-list_rest_coinc"><span class="command">lemma</span></span> list_rest_coinc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>length <span class="free">s2</span> <span class="main">≤</span> length <span class="free">s1</span><span class="main">;</span> <span class="free">s1</span><span class="main">@</span><span class="free">r1</span> <span class="main">=</span> <span class="free">s2</span><span class="main">@</span><span class="free">r2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">r1p</span><span class="main">.</span> <span class="free">r2</span><span class="main">=</span><span class="bound">r1p</span><span class="main">@</span><span class="free">r1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_append_conv_if<span class="main">)</span>

  <span class="keyword1" id="Misc-list_tail_coinc"><span class="command">lemma</span></span> list_tail_coinc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n1</span><span class="main">#</span><span class="free">r1</span> <span class="main">=</span> <span class="free">n2</span><span class="main">#</span><span class="free">r2</span> <span class="main">⟹</span> <span class="free">n1</span><span class="main">=</span><span class="free">n2</span> <span class="main">&amp;</span> <span class="free">r1</span><span class="main">=</span><span class="free">r2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


  <span class="keyword1" id="Misc-last_in_set"><span class="command">lemma</span></span> last_in_set<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">l</span><span class="main">≠</span><span class="main">[]</span><span class="main">⟧</span> <span class="main">⟹</span> last <span class="free">l</span> <span class="main">∈</span> set <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1" id="Misc-empty_append_eq_id"><span class="command">lemma</span></span> empty_append_eq_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(@)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
  <span class="keyword1" id="Misc-op_conc_empty_img_id"><span class="command">lemma</span></span> op_conc_empty_img_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(@)</span> <span class="main">[]</span> <span class="main">`</span> <span class="free">L</span><span class="main">)</span> <span class="main">=</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


  <span class="keyword1" id="Misc-distinct_match"><span class="command">lemma</span></span> distinct_match<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> distinct <span class="main">(</span><span class="free">al</span><span class="main">@</span><span class="free">e</span><span class="main">#</span><span class="free">bl</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">al</span><span class="main">@</span><span class="free">e</span><span class="main">#</span><span class="free">bl</span> <span class="main">=</span> <span class="free">al'</span><span class="main">@</span><span class="free">e</span><span class="main">#</span><span class="free">bl'</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">al</span><span class="main">=</span><span class="free">al'</span> <span class="main">∧</span> <span class="free">bl</span><span class="main">=</span><span class="free">bl'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">al</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">al'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">al'</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">al</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> Cprems<span class="main">=</span>Cons.prems <span class="keyword1"><span class="command">note</span></span> Chyps<span class="main">=</span>Cons.hyps
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">al'</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> Cprems <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">a'</span> <span class="skolem">all'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Cprems <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="skolem">a'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">al</span><span class="main">@</span><span class="free">e</span><span class="main">#</span><span class="free">bl</span> <span class="main">=</span> <span class="skolem">all'</span><span class="main">@</span><span class="free">e</span><span class="main">#</span><span class="free">bl'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> Cprems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="skolem">al</span><span class="main">@</span><span class="free">e</span><span class="main">#</span><span class="free">bl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> Chyps<span class="main">[</span><span class="operator">OF</span> D P<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">al</span><span class="main">=</span><span class="skolem">all'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bl</span><span class="main">=</span><span class="free">bl'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>


  <span class="keyword1" id="Misc-prop_match"><span class="command">lemma</span></span> prop_match<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> list_all <span class="free">P</span> <span class="free">al</span><span class="main">;</span> <span class="main">¬</span><span class="free">P</span> <span class="free">e</span><span class="main">;</span> <span class="main">¬</span><span class="free">P</span> <span class="free">e'</span><span class="main">;</span> list_all <span class="free">P</span> <span class="free">bl</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">al</span><span class="main">@</span><span class="free">e</span><span class="main">#</span><span class="free">bl</span> <span class="main">=</span> <span class="free">al'</span><span class="main">@</span><span class="free">e'</span><span class="main">#</span><span class="free">bl'</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">al</span><span class="main">=</span><span class="free">al'</span> <span class="main">∧</span> <span class="free">e</span><span class="main">=</span><span class="free">e'</span> <span class="main">∧</span> <span class="free">bl</span><span class="main">=</span><span class="free">bl'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">al</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">al'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="free">al'</span></span></span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> prop_matchD <span class="main">=</span> rev_iffD1<span class="main">[</span><span class="operator">OF</span> _ prop_match<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">P</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">P</span>

  <span class="keyword1"><span class="command">declare</span></span> distinct_tl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>


<span class="keyword1" id="Misc-list_se_match"><span class="command">lemma</span></span> list_se_match<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l1</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">l1</span><span class="main">@</span><span class="free">l2</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">⟷</span> <span class="free">l1</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">∧</span> <span class="free">l2</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">l1</span><span class="main">@</span><span class="free">l2</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">⟷</span> <span class="free">l1</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">l2</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">=</span> <span class="free">l1</span><span class="main">@</span><span class="free">l2</span> <span class="main">⟷</span> <span class="free">l1</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">∧</span> <span class="free">l2</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">=</span> <span class="free">l1</span><span class="main">@</span><span class="free">l2</span> <span class="main">⟷</span> <span class="free">l1</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">l2</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>





    <span class="comment1">(* Placed here because it depends on xy_in_set_cases *)</span>
<span class="keyword1" id="Misc-distinct_map_eq"><span class="command">lemma</span></span> distinct_map_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> distinct <span class="main">(</span>List.map <span class="free">f</span> <span class="free">l</span><span class="main">)</span><span class="main">;</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">y</span><span class="main">;</span> <span class="free">x</span><span class="main">∈</span>set <span class="free">l</span><span class="main">;</span> <span class="free">y</span><span class="main">∈</span>set <span class="free">l</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">=</span><span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> xy_in_set_cases<span class="main">)</span> <span class="operator">auto</span>



<span class="keyword1" id="Misc-upt_append"><span class="command">lemma</span></span> upt_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">@</span><span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">=</span><span class="improper">j</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1" id="Misc-upt_filter_extend"><span class="command">lemma</span></span> upt_filter_extend<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> LE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">≤</span><span class="free">u'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> NP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">u</span><span class="main">≤</span><span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">u'</span> <span class="main">⟶</span> <span class="main">¬</span><span class="free">P</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">i</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">u</span><span class="main">]</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">i</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">u'</span><span class="main">]</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">=</span><span class="free">u'</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">&lt;</span><span class="free">u'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LE <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">u'</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">u</span><span class="main">]</span><span class="main">@</span><span class="main">[</span><span class="free">u</span> <span class="main">..&lt;</span><span class="free">u'</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_append<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">i</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">u'</span><span class="main">]</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">i</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">u</span><span class="main">]</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="bound">i</span><span class="main">←</span><span class="main">[</span><span class="free">u</span><span class="main">..&lt;</span><span class="free">u'</span><span class="main">]</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">i</span><span class="main">←</span><span class="main">[</span><span class="free">u</span><span class="main">..&lt;</span><span class="free">u'</span><span class="main">]</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> NP
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filter_empty_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Misc-filter_upt_last"><span class="command">lemma</span></span> filter_upt_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">k</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span> <span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">k</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="free">js</span> <span class="main">@</span> <span class="main">[</span><span class="free">j</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span><span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span>length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">@</span><span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">&lt;</span>length <span class="free">l</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_append<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span> <span class="main">=</span> <span class="free">i</span><span class="main">#</span><span class="main">[</span>Suc <span class="free">i</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">&lt;</span>length <span class="free">l</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upt_conv_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">k</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span> <span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">k</span><span class="main">)</span><span class="main">]</span><span class="main">@</span><span class="free">i</span><span class="main">#</span><span class="main">[</span><span class="bound">k</span><span class="main">←</span><span class="main">[</span>Suc <span class="free">i</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span> <span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">k</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="free">js</span><span class="main">@</span><span class="main">[</span><span class="free">j</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> E<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="free">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> last <span class="main">(</span><span class="free">i</span><span class="main">#</span><span class="main">[</span><span class="bound">k</span><span class="main">←</span><span class="main">[</span>Suc <span class="free">i</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span> <span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">k</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last_appendR last_snoc list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≥</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span><span class="free">i</span><span class="main">#</span><span class="main">[</span><span class="bound">k</span><span class="main">←</span><span class="main">[</span>Suc <span class="free">i</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span> <span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">k</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"sorted <span class="var">?l</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_filter<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">id</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"hd <span class="var">?l</span> <span class="main">≤</span> last <span class="var">?l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_hd_last<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≤</span><span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span><span class="main">&lt;</span><span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-all_set_conv_nth"><span class="command">lemma</span></span> all_set_conv_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">l</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">l</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> all_nth_imp_all_set<span class="main">)</span>

<span class="comment1">(* TODO: Special case of upt_eq_Nil_conv. Find cases where the latter does not work …
*)</span>    
<span class="keyword1" id="Misc-upt_0_eq_Nil_conv"><span class="command">lemma</span></span> upt_0_eq_Nil_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">j</span><span class="main">=</span><span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-filter_eq_snocD"><span class="command">lemma</span></span> filter_eq_snocD<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="free">l</span> <span class="main">=</span> <span class="free">l'</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span>set <span class="free">l</span> <span class="main">∧</span> <span class="free">P</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="free">l</span> <span class="main">=</span> <span class="free">l'</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span>set <span class="main">(</span>filter <span class="free">P</span> <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-lists_image_witness"><span class="command">lemma</span></span> lists_image_witness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span>lists <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">xo</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xo</span><span class="main">∈</span>lists <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span>map <span class="free">f</span> <span class="free">xo</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span><span class="main">∈</span>lists <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">Q</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">xo</span><span class="main">∈</span>lists <span class="free">Q</span><span class="main">.</span> <span class="free">x</span><span class="main">=</span>map <span class="free">f</span> <span class="bound">xo</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xos</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xos</span><span class="main">∈</span>lists <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span><span class="main">=</span>map <span class="free">f</span> <span class="skolem">xos</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">f</span><span class="main">`</span><span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xo</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xo</span><span class="main">∈</span><span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="free">f</span> <span class="skolem">xo</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">xo</span><span class="main">#</span><span class="skolem">xos</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> bexE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> that<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Misc-map_of_None_filterD"><span class="command">lemma</span></span> map_of_None_filterD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_of <span class="free">xs</span> <span class="free">x</span> <span class="main">=</span> None <span class="main">⟹</span> map_of <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-map_of_concat"><span class="command">lemma</span></span> map_of_concat<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>concat <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> foldr <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">++</span> map_of <span class="bound">xs</span><span class="main">)</span> <span class="free">xss</span> Map.empty"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xss</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Misc-map_of_Some_split"><span class="command">lemma</span></span> map_of_Some_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_of <span class="free">xs</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="bound">zs</span> <span class="main">∧</span> map_of <span class="bound">ys</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">=</span> <span class="free">k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span>›</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">[]</span> <span class="free">k</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span>›</span></span> x
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">xs</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹map_of <span class="skolem">xs</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="bound">zs</span> <span class="main">∧</span> map_of <span class="bound">ys</span> <span class="free">k</span> <span class="main">=</span> None›</span></span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">ys</span> <span class="free">k</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> False x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-map_add_find_left"><span class="command">lemma</span></span> map_add_find_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">k</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="main">++</span> <span class="free">g</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> <span class="free">f</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_def<span class="main">)</span>

<span class="keyword1" id="Misc-map_add_left_None"><span class="command">lemma</span></span> map_add_left_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">k</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="main">++</span> <span class="free">g</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> <span class="free">g</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1" id="Misc-map_of_Some_filter_not_in"><span class="command">lemma</span></span> map_of_Some_filter_not_in<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> map_of <span class="free">xs</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">;</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span><span class="main">;</span> distinct <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> map_of <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_eq_None_iff<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-distinct_map_fst_filterI"><span class="command">lemma</span></span> distinct_map_fst_filterI<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="main">(</span>map fst <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-distinct_map_fstD"><span class="command">lemma</span></span> distinct_map_fstD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> distinct <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">;</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> notE rev_image_eqI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>



<span class="keyword1" id="Misc-concat_filter_neq_Nil"><span class="command">lemma</span></span> concat_filter_neq_Nil<span class="main">:</span>
  <span class="quoted"><span class="quoted">"concat <span class="main">[</span><span class="bound">ys</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">ys</span> <span class="main">≠</span> Nil<span class="main">]</span> <span class="main">=</span> concat <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Misc-distinct_concat'"><span class="command">lemma</span></span> distinct_concat'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>distinct <span class="main">[</span><span class="bound">ys</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">ys</span> <span class="main">≠</span> Nil<span class="main">]</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">ys</span><span class="main">.</span> <span class="bound">ys</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> distinct <span class="bound">ys</span><span class="main">;</span>
   <span class="main">⋀</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">ys</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">;</span> <span class="bound">zs</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">;</span> <span class="bound">ys</span> <span class="main">≠</span> <span class="bound">zs</span><span class="main">⟧</span> <span class="main">⟹</span> set <span class="bound">ys</span> <span class="main">∩</span> set <span class="bound">zs</span> <span class="main">=</span> <span class="main">{}</span><span class="main">⟧</span>
  <span class="main">⟹</span> distinct <span class="main">(</span>concat <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">erule</span> distinct_concat<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">ys</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">ys</span> <span class="main">≠</span> Nil<span class="main">]</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> concat_filter_neq_Nil<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-distinct_idx"><span class="command">lemma</span></span> distinct_idx<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map <span class="free">f</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span>length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span>length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">=</span><span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms distinct_conv_nth length_map nth_map<span class="main">)</span>

<span class="keyword1" id="Misc-replicate_Suc_conv_snoc"><span class="command">lemma</span></span> replicate_Suc_conv_snoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"replicate <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> replicate <span class="free">n</span> <span class="free">x</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> replicate_Suc replicate_append_same<span class="main">)</span>


<span class="keyword1" id="Misc-filter_nth_ex_nth"><span class="command">lemma</span></span> filter_nth_ex_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="free">n</span> <span class="main">≤</span> <span class="bound">m</span> <span class="main">∧</span> <span class="bound">m</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">∧</span> filter <span class="free">P</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">m</span> <span class="main">∧</span> filter <span class="free">P</span> <span class="main">(</span>take <span class="bound">m</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> take <span class="free">n</span> <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> False
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&lt;</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">≥</span><span class="free">n</span><span class="main">.</span> <span class="bound">m</span> <span class="main">&lt;</span> length <span class="skolem">xs</span> <span class="main">∧</span> filter <span class="free">P</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">m</span> <span class="main">∧</span> filter <span class="free">P</span> <span class="main">(</span>take <span class="bound">m</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> take <span class="free">n</span> <span class="main">(</span>filter <span class="free">P</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> snoc<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&lt;</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">≥</span><span class="free">n</span><span class="main">.</span> <span class="bound">m</span> <span class="main">&lt;</span> length <span class="skolem">xs</span> <span class="main">∧</span> filter <span class="free">P</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">m</span> <span class="main">∧</span> filter <span class="free">P</span> <span class="main">(</span>take <span class="bound">m</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> take <span class="free">n</span> <span class="main">(</span>filter <span class="free">P</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> snoc<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">≥</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> take <span class="free">n</span> <span class="main">(</span>filter <span class="free">P</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-set_map_filter"><span class="command">lemma</span></span> set_map_filter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>List.map_filter <span class="free">g</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> List.map_filter_def set_eq_iff<span class="main">)</span>

    
    
    
    

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Quicksort by Relation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A functional implementation of quicksort on lists. It it similar to the
one in Isabelle/HOL's example directory. However, it uses tail-recursion for append and arbitrary
relations.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">partition_rev</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">partition_rev</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">yes</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">no</span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">yes</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">no</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">partition_rev</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">yes</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">no</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
      <span class="free">partition_rev</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">yes</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">no</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">yes</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">no</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1" id="Misc-partition_rev_filter_conv"><span class="command">lemma</span></span> partition_rev_filter_conv <span class="main">:</span>
  <span class="quoted"><span class="quoted">"partition_rev <span class="free">P</span> <span class="main">(</span><span class="free">yes</span><span class="main">,</span> <span class="free">no</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span>rev <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="free">yes</span><span class="main">,</span>  rev <span class="main">(</span>filter <span class="main">(</span>Not <span class="main">∘</span> <span class="free">P</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="free">no</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">yes</span></span> <span class="quoted"><span class="free">no</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">quicksort_by_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">quicksort_by_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">sl</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">sl</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">quicksort_by_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">sl</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs_s</span><span class="main">,</span> <span class="bound">xs_b</span><span class="main">)</span> <span class="main">=</span> partition_rev <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">y</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">in</span>
    <span class="free">quicksort_by_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="main">(</span><span class="free">quicksort_by_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">sl</span></span></span> <span class="bound">xs_b</span><span class="main">)</span><span class="main">)</span> <span class="bound">xs_s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span><span class="main">.</span> length <span class="bound">xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_rev_filter_conv less_Suc_eq_le<span class="main">)</span>

<span class="keyword1" id="Misc-quicksort_by_rel_remove_acc"><span class="command">lemma</span></span> quicksort_by_rel_remove_acc <span class="main">:</span>
  <span class="quoted"><span class="quoted">"quicksort_by_rel <span class="free">R</span> <span class="free">sl</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span>quicksort_by_rel <span class="free">R</span> <span class="main">[]</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">sl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">sl</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ind_hyp <span class="main">=</span> this

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> xs_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> this

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs1</span></span> <span class="skolem"><span class="skolem">xs2</span></span> <span class="keyword2"><span class="keyword">where</span></span> part_rev_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"partition_rev <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="bound">y</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">xs'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs1</span><span class="main">,</span> <span class="skolem">xs2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.exhaust<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> part_rev_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> length_le<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs1</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs2</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> partition_rev_filter_conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_Suc_eq_le<span class="main">)</span>

    <span class="keyword1"><span class="command">note</span></span> ind_hyp1a <span class="main">=</span> ind_hyp<span class="main">[</span><span class="operator">OF</span> length_le<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> quicksort_by_rel <span class="free">R</span> <span class="main">[]</span> <span class="skolem">xs2</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> ind_hyp1b <span class="main">=</span> ind_hyp<span class="main">[</span><span class="operator">OF</span> length_le<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> quicksort_by_rel <span class="free">R</span> <span class="main">[]</span> <span class="skolem">xs2</span> <span class="main">@</span> <span class="skolem">sl</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> ind_hyp2 <span class="main">=</span> ind_hyp<span class="main">[</span><span class="operator">OF</span> length_le<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">sl</span></span><span class="main">]</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ind_hyp1a ind_hyp1b ind_hyp2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-quicksort_by_rel_remove_acc_guared"><span class="command">lemma</span></span> quicksort_by_rel_remove_acc_guared <span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> quicksort_by_rel <span class="free">R</span> <span class="free">sl</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span>quicksort_by_rel <span class="free">R</span> <span class="main">[]</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">sl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> quicksort_by_rel_remove_acc<span class="main">)</span>

<span class="keyword1" id="Misc-quicksort_by_rel_permutes"><span class="command">lemma</span></span> quicksort_by_rel_permutes <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="main">(</span>quicksort_by_rel <span class="free">R</span> <span class="free">sl</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">sl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">sl</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ind_hyp <span class="main">=</span> this

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> xs_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> this

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs1</span></span> <span class="skolem"><span class="skolem">xs2</span></span> <span class="keyword2"><span class="keyword">where</span></span> part_rev_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"partition_rev <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="bound">y</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">xs'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs1</span><span class="main">,</span> <span class="skolem">xs2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.exhaust<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> part_rev_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> xs'_multi_eq <span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="skolem">xs'</span> <span class="main">=</span> mset <span class="skolem">xs1</span> <span class="main">+</span> mset <span class="skolem">xs2</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> partition_rev_filter_conv
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_filter<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> part_rev_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> length_le<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs1</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs2</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> partition_rev_filter_conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_Suc_eq_le<span class="main">)</span>

    <span class="keyword1"><span class="command">note</span></span> ind_hyp<span class="main">[</span><span class="operator">OF</span> length_le<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> ind_hyp<span class="main">[</span><span class="operator">OF</span> length_le<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xs'_multi_eq union_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-set_quicksort_by_rel"><span class="command">lemma</span></span> set_quicksort_by_rel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>quicksort_by_rel <span class="free">R</span> <span class="free">sl</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">sl</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_mset_comp_mset <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> o_apply <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-sorted_wrt_quicksort_by_rel"><span class="command">lemma</span></span> sorted_wrt_quicksort_by_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> <span class="main">⇒</span> <span class="tfree">'x</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lin <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">R</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> trans_R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="main">(</span>quicksort_by_rel <span class="free">R</span> <span class="main">[]</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ind_hyp <span class="main">=</span> this

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> xs_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> this

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs1</span></span> <span class="skolem"><span class="skolem">xs2</span></span> <span class="keyword2"><span class="keyword">where</span></span> part_rev_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"partition_rev <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="bound">y</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">xs'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs1</span><span class="main">,</span> <span class="skolem">xs2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.exhaust<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> part_rev_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> xs1_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="skolem">xs1</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">R</span> <span class="bound">y</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
                                     xs2_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="skolem">xs2</span> <span class="main">⟹</span> <span class="main">¬</span><span class="main">(</span><span class="free">R</span> <span class="bound">y</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> partition_rev_filter_conv
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

    <span class="keyword1"><span class="command">from</span></span> xs2_props lin <span class="keyword1"><span class="command">have</span></span> xs2_props'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="skolem">xs2</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">R</span> <span class="skolem">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> xs2_props' xs1_props trans_R <span class="keyword1"><span class="command">have</span></span> xs1_props'<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y1</span> <span class="bound">y2</span><span class="main">.</span> <span class="bound">y1</span> <span class="main">∈</span> set <span class="skolem">xs1</span> <span class="main">⟹</span> <span class="bound">y2</span> <span class="main">∈</span> set <span class="skolem">xs2</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">R</span> <span class="bound">y1</span> <span class="bound">y2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">from</span></span> part_rev_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> length_le<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs1</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs2</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> partition_rev_filter_conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_Suc_eq_le<span class="main">)</span>

    <span class="keyword1"><span class="command">note</span></span> ind_hyps <span class="main">=</span> ind_hyp<span class="main">[</span><span class="operator">OF</span> length_le<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> ind_hyp<span class="main">[</span><span class="operator">OF</span> length_le<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_by_rel_remove_acc_guared sorted_wrt_append Ball_def
                    xs1_props xs2_props' xs1_props'<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-sorted_quicksort_by_rel"><span class="command">lemma</span></span> sorted_quicksort_by_rel<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>quicksort_by_rel <span class="main">(≤)</span> <span class="main">[]</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> sorted_sorted_wrt
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_wrt_quicksort_by_rel<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-sort_quicksort_by_rel"><span class="command">lemma</span></span> sort_quicksort_by_rel<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sort <span class="main">=</span> quicksort_by_rel <span class="main">(≤)</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> properties_for_sort<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_quicksort_by_rel<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"quicksort <span class="main">=</span> quicksort_by_rel <span class="main">(≤)</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sort_quicksort<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sort_quicksort_by_rel<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Mergesort by Relation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A functional implementation of mergesort on lists. It it similar to the
one in Isabelle/HOL's example directory. However, it uses tail-recursion for append and arbitrary
relations.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mergesort_by_rel_split</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">mergesort_by_rel_split</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs2</span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs2</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mergesort_by_rel_split</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs2</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs2</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mergesort_by_rel_split</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="free">mergesort_by_rel_split</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1" id="Misc-list_induct_first2"><span class="command">lemma</span></span> list_induct_first2 <span class="main">[</span><span class="operator">consumes</span> 0<span class="main">,</span> <span class="operator">case_names</span> Nil Sing Cons2<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">xs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x1</span> <span class="main">#</span> <span class="bound">x2</span> <span class="main">#</span><span class="bound">xs</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> ind_hyp <span class="main">=</span> this

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x1</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> xs_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> this
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs'</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x2</span> <span class="skolem">xs''</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> xs'_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ind_hyp assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-mergesort_by_rel_split_length"><span class="command">lemma</span></span> mergesort_by_rel_split_length <span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="main">(</span>mergesort_by_rel_split <span class="main">(</span><span class="free">xs1</span><span class="main">,</span> <span class="free">xs2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs1</span> <span class="main">+</span> <span class="main">(</span>length <span class="free">xs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>length <span class="free">xs</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">∧</span>
   length <span class="main">(</span>snd <span class="main">(</span>mergesort_by_rel_split <span class="main">(</span><span class="free">xs1</span><span class="main">,</span> <span class="free">xs2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs2</span> <span class="main">+</span> <span class="main">(</span>length <span class="free">xs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs1</span></span> <span class="quoted"><span class="free">xs2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_first2<span class="main">)</span>
   <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Misc-mset_mergesort_by_rel_split"><span class="command">lemma</span></span> mset_mergesort_by_rel_split <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="main">(</span>fst <span class="main">(</span>mergesort_by_rel_split <span class="main">(</span><span class="free">xs1</span><span class="main">,</span> <span class="free">xs2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
   mset <span class="main">(</span>snd <span class="main">(</span>mergesort_by_rel_split <span class="main">(</span><span class="free">xs1</span><span class="main">,</span> <span class="free">xs2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   mset <span class="free">xs</span> <span class="main">+</span> mset <span class="free">xs1</span> <span class="main">+</span> mset <span class="free">xs2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs1</span></span> <span class="quoted"><span class="free">xs2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_first2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mergesort_by_rel_merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mergesort_by_rel_merge</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">mergesort_by_rel_merge</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free">mergesort_by_rel_merge</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mergesort_by_rel_merge</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mergesort_by_rel_merge</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> mergesort_by_rel_merge.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span>

<span class="keyword1" id="Misc-mergesort_by_rel_merge_simps"><span class="command">lemma</span></span> mergesort_by_rel_merge_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"mergesort_by_rel_merge <span class="free">R</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">y</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free">R</span> <span class="free">x</span> <span class="free">y</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="main">#</span> mergesort_by_rel_merge <span class="free">R</span> <span class="free">xs</span> <span class="main">(</span><span class="free">y</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">y</span> <span class="main">#</span> mergesort_by_rel_merge <span class="free">R</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"mergesort_by_rel_merge <span class="free">R</span> <span class="free">xs</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="quoted"><span class="quoted">"mergesort_by_rel_merge <span class="free">R</span> <span class="main">[]</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mergesort_by_rel_merge.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mergesort_by_rel_merge.simps<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-mergesort_by_rel_merge_induct"><span class="command">lemma</span></span> mergesort_by_rel_merge_induct <span class="main">[</span><span class="operator">consumes</span> 0<span class="main">,</span> <span class="operator">case_names</span> Nil1 Nil2 Cons1 Cons2<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">::</span><span class="tfree">'a</span> list<span class="main">.</span> <span class="free">P</span> <span class="bound">xs</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys</span><span class="main">::</span><span class="tfree">'b</span> list<span class="main">.</span> <span class="free">P</span> <span class="main">[]</span> <span class="bound">ys</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">xs</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> P_xs <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> P_x_xs_ys <span class="main">=</span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">xs</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ys</span></span></span></span><span class="main">]</span> P_x_xs_ys P_xs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-mset_mergesort_by_rel_merge"><span class="command">lemma</span></span> mset_mergesort_by_rel_merge <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="main">(</span>mergesort_by_rel_merge <span class="free">R</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span> <span class="main">+</span> mset <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mergesort_by_rel_merge.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Misc-set_mergesort_by_rel_merge"><span class="command">lemma</span></span> set_mergesort_by_rel_merge <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>mergesort_by_rel_merge <span class="free">R</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mergesort_by_rel_merge.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-sorted_wrt_mergesort_by_rel_merge"><span class="command">lemma</span></span> sorted_wrt_mergesort_by_rel_merge <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lin <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">R</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> trans_R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="main">(</span>mergesort_by_rel_merge <span class="free">R</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟷</span>
          sorted_wrt <span class="free">R</span> <span class="free">xs</span> <span class="main">∧</span> sorted_wrt <span class="free">R</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mergesort_by_rel_merge_induct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free">R</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Nil2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons1 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ball_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> trans_R<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons2 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ball_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> lin<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> lin trans_R<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">mergesort_by_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mergesort_by_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">else</span>
     <span class="main">(</span>mergesort_by_rel_merge <span class="free"><span class="bound"><span class="entity">R</span></span></span>
       <span class="main">(</span><span class="free">mergesort_by_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>fst <span class="main">(</span>mergesort_by_rel_split <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span><span class="free">mergesort_by_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>snd <span class="main">(</span>mergesort_by_rel_split <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span><span class="main">.</span> length <span class="bound">xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mergesort_by_rel_split_length not_less minus_div_mult_eq_mod <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> mergesort_by_rel.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="Misc-mergesort_by_rel_simps"><span class="command">lemma</span></span> mergesort_by_rel_simps <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"mergesort_by_rel <span class="free">R</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="quoted"><span class="quoted">"mergesort_by_rel <span class="free">R</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="quoted"><span class="quoted">"mergesort_by_rel <span class="free">R</span> <span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">x2</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs1</span><span class="main">,</span> <span class="bound">xs2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mergesort_by_rel_split <span class="main">(</span><span class="main">[</span><span class="free">x1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="free">x2</span><span class="main">]</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="keyword1">in</span>
   mergesort_by_rel_merge <span class="free">R</span> <span class="main">(</span>mergesort_by_rel <span class="free">R</span> <span class="bound">xs1</span><span class="main">)</span> <span class="main">(</span>mergesort_by_rel <span class="free">R</span> <span class="bound">xs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mergesort_by_rel.simps<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mergesort_by_rel.simps<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mergesort_by_rel.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">#</span> <span class="free">x2</span> <span class="main">#</span> <span class="free">xs</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-mergesort_by_rel_permutes"><span class="command">lemma</span></span> mergesort_by_rel_permutes <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="main">(</span>mergesort_by_rel <span class="free">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> ind_hyp <span class="main">=</span> this

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x1</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> xs_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs'</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x2</span> <span class="skolem">xs''</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> xs'_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> this

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="main">(</span>mergesort_by_rel_split <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
           <span class="quoted"><span class="quoted">"length <span class="main">(</span>snd <span class="main">(</span>mergesort_by_rel_split <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mergesort_by_rel_split_length<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> ind_hyp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mergesort_by_rel.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-set_mergesort_by_rel"><span class="command">lemma</span></span> set_mergesort_by_rel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>mergesort_by_rel <span class="free">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_mset_comp_mset <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> o_apply <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-sorted_wrt_mergesort_by_rel"><span class="command">lemma</span></span> sorted_wrt_mergesort_by_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> <span class="main">⇒</span> <span class="tfree">'x</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lin <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">R</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> trans_R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="main">(</span>mergesort_by_rel <span class="free">R</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ind_hyp <span class="main">=</span> this

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> xs_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> this
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs'</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x2</span> <span class="skolem">xs''</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> xs'_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> this

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="main">(</span>mergesort_by_rel_split <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
           <span class="quoted"><span class="quoted">"length <span class="main">(</span>snd <span class="main">(</span>mergesort_by_rel_split <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mergesort_by_rel_split_length<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> ind_hyp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mergesort_by_rel.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_wrt_mergesort_by_rel_merge<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lin trans_R<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-sorted_mergesort_by_rel"><span class="command">lemma</span></span> sorted_mergesort_by_rel<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>mergesort_by_rel <span class="main">(≤)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> sorted_sorted_wrt
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_wrt_mergesort_by_rel<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-sort_mergesort_by_rel"><span class="command">lemma</span></span> sort_mergesort_by_rel<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sort <span class="main">=</span> mergesort_by_rel <span class="main">(≤)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> properties_for_sort<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_mergesort_by_rel<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mergesort</span> <span class="main">=</span> mergesort_by_rel <span class="main">(≤)</span>"</span></span>

<span class="keyword1" id="Misc-sort_mergesort"><span class="command">lemma</span></span> sort_mergesort<span class="main">:</span> <span class="quoted"><span class="quoted">"sort <span class="main">=</span> mergesort"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mergesort_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sort_mergesort_by_rel<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Mergesort with Remdup›</span></span>
<span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="free">merge</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="main">#</span> <span class="main">(</span><span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="main">#</span> <span class="main">(</span><span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="main">#</span> <span class="main">(</span><span class="free">merge</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Misc-merge_correct"><span class="command">lemma</span></span> merge_correct <span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> l1_OK<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">l1</span> <span class="main">∧</span> sorted <span class="free">l1</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> l2_OK<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">l2</span> <span class="main">∧</span> sorted <span class="free">l2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>merge <span class="free">l1</span> <span class="free">l2</span><span class="main">)</span> <span class="main">∧</span> sorted <span class="main">(</span>merge <span class="free">l1</span> <span class="free">l2</span><span class="main">)</span> <span class="main">∧</span> set <span class="main">(</span>merge <span class="free">l1</span> <span class="free">l2</span><span class="main">)</span> <span class="main">=</span> set <span class="free">l1</span> <span class="main">∪</span> set <span class="free">l2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x1</span> <span class="skolem">l1</span> <span class="skolem">l2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> x1_l1_props <span class="main">=</span> Cons<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> l2_props <span class="main">=</span> Cons<span class="main">(</span>3<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> x1_l1_props <span class="keyword1"><span class="command">have</span></span> l1_props<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">l1</span> <span class="main">∧</span> sorted <span class="skolem">l1</span>"</span></span>
                    <span class="keyword2"><span class="keyword">and</span></span> x1_nin_l1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">∉</span> set <span class="skolem">l1</span>"</span></span>
                    <span class="keyword2"><span class="keyword">and</span></span> x1_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">l1</span> <span class="main">⟹</span> <span class="skolem">x1</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ball_def<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> ind_hyp_l1 <span class="main">=</span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> l1_props<span class="main">]</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> l2_props
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">l2</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> x1_l1_props <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x2</span> <span class="skolem">l2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> x2_l2_props <span class="main">=</span> Cons<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> x2_l2_props <span class="keyword1"><span class="command">have</span></span> l2_props<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">l2</span> <span class="main">∧</span> sorted <span class="skolem">l2</span>"</span></span>
                    <span class="keyword2"><span class="keyword">and</span></span> x2_nin_l2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x2</span> <span class="main">∉</span> set <span class="skolem">l2</span>"</span></span>
                    <span class="keyword2"><span class="keyword">and</span></span> x2_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">l2</span> <span class="main">⟹</span> <span class="skolem">x2</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ball_def<span class="main">)</span>

    <span class="keyword1"><span class="command">note</span></span> ind_hyp_l2 <span class="main">=</span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> l2_props<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">&lt;</span> <span class="skolem">x2</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> x1_less_x2 <span class="main">=</span> this

      <span class="keyword1"><span class="command">from</span></span> ind_hyp_l1<span class="main">[</span><span class="operator">OF</span> x2_l2_props<span class="main">]</span> x1_less_x2 x1_nin_l1 x1_le x2_le
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ball_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> linorder_not_le<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> linorder_not_less xt1<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> xt1<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> x2_le_x1 <span class="main">=</span> this

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">=</span> <span class="skolem">x2</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> x1_eq_x2 <span class="main">=</span> this

        <span class="keyword1"><span class="command">from</span></span> ind_hyp_l1<span class="main">[</span><span class="operator">OF</span> l2_props<span class="main">]</span> x1_le x2_le x2_nin_l2 x1_eq_x2 x1_nin_l1
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x1_eq_x2 Ball_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> x1_neq_x2 <span class="main">=</span> this
        <span class="keyword1"><span class="command">with</span></span> x2_le_x1 <span class="keyword1"><span class="command">have</span></span> x2_less_x1 <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x2</span> <span class="main">&lt;</span> <span class="skolem">x1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">from</span></span> ind_hyp_l2 x2_le_x1 x1_neq_x2 x2_le x2_nin_l2 x1_le
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x2_less_x1 Ball_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> linorder_not_le x2_less_x1 xt1<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">merge_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">}</span> list list <span class="main">⇒</span> <span class="tfree">'a</span> list list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">merge_list</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_list</span> <span class="main">[]</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">la</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">acc2</span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">merge_list</span> <span class="main">[]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">la</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">acc2</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">la</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">acc2</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="free">merge_list</span> <span class="main">[]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">la</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">acc2</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_list</span> <span class="free"><span class="bound"><span class="entity">acc2</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="free">merge_list</span> <span class="main">(</span><span class="main">(</span>merge <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">acc2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">acc</span><span class="main">,</span> <span class="bound">ls</span><span class="main">)</span><span class="main">.</span> <span class="numeral">3</span> <span class="main">*</span> length <span class="bound">acc</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> length <span class="bound">ls</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Misc-merge_list_correct"><span class="command">lemma</span></span> merge_list_correct <span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> ls_OK<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span> set <span class="free">ls</span> <span class="main">⟹</span> distinct <span class="bound">l</span> <span class="main">∧</span> sorted <span class="bound">l</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> as_OK<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span> set <span class="free">as</span> <span class="main">⟹</span> distinct <span class="bound">l</span> <span class="main">∧</span> sorted <span class="bound">l</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>merge_list <span class="free">as</span> <span class="free">ls</span><span class="main">)</span> <span class="main">∧</span> sorted <span class="main">(</span>merge_list <span class="free">as</span> <span class="free">ls</span><span class="main">)</span> <span class="main">∧</span>
       set <span class="main">(</span>merge_list <span class="free">as</span> <span class="free">ls</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>concat <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">ls</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_list.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">acc</span> <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="skolem">ls</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ind_hyp <span class="main">=</span> 5<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> l12_l_OK <span class="main">=</span> 5<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> acc_OK <span class="main">=</span> 5<span class="main">(</span>3<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> l12_l_OK acc_OK merge_correct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">l2</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> set_merge_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>merge <span class="skolem">l1</span> <span class="skolem">l2</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">l1</span> <span class="main">∪</span> set <span class="skolem">l2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> l12_l_OK acc_OK merge_correct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">l2</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>merge_list <span class="main">(</span>merge <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="main">#</span> <span class="skolem">acc</span><span class="main">)</span> <span class="skolem">ls</span><span class="main">)</span> <span class="main">∧</span>
        sorted <span class="main">(</span>merge_list <span class="main">(</span>merge <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="main">#</span> <span class="skolem">acc</span><span class="main">)</span> <span class="skolem">ls</span><span class="main">)</span> <span class="main">∧</span>
        set <span class="main">(</span>merge_list <span class="main">(</span>merge <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="main">#</span> <span class="skolem">acc</span><span class="main">)</span> <span class="skolem">ls</span><span class="main">)</span> <span class="main">=</span>
        set <span class="main">(</span>concat <span class="main">(</span><span class="main">(</span>merge <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="main">#</span> <span class="skolem">acc</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ls</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> ind_hyp<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> set_merge_eq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mergesort_remdups</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mergesort_remdups</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> merge_list <span class="main">[]</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Misc-mergesort_remdups_correct"><span class="command">lemma</span></span> mergesort_remdups_correct <span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>mergesort_remdups <span class="free">l</span><span class="main">)</span>
  <span class="main">∧</span> sorted <span class="main">(</span>mergesort_remdups <span class="free">l</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span>set <span class="main">(</span>mergesort_remdups <span class="free">l</span><span class="main">)</span> <span class="main">=</span> set <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="free">l</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> set <span class="var">?l'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span> <span class="main">∧</span> sorted <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> l'_OK <span class="main">=</span> this

  <span class="keyword1"><span class="command">from</span></span> merge_list_correct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?l'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> l'_OK<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mergesort_remdups_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1" id="Misc-ex1_eqI"><span class="command">lemma</span></span> ex1_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">∃!</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">;</span> <span class="free">P</span> <span class="free">a</span><span class="main">;</span> <span class="free">P</span> <span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">=</span><span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Misc-remdup_sort_mergesort_remdups"><span class="command">lemma</span></span> remdup_sort_mergesort_remdups<span class="main">:</span>
  <span class="quoted"><span class="quoted">"remdups <span class="keyword1">o</span> sort <span class="main">=</span> mergesort_remdups"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span><span class="main">=</span><span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="var">?lhs</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span><span class="var">?lhs</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="var">?lhs</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> mergesort_remdups_correct
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">l</span> <span class="main">=</span> <span class="var">?rhs</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ex1_eqI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_sorted_distinct_unique<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> finite_set<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Native Integers›</span></span>  
<span class="keyword1" id="Misc-int_of_integer_less_iff"><span class="command">lemma</span></span> int_of_integer_less_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"int_of_integer <span class="free">x</span> <span class="main">&lt;</span> int_of_integer <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span><span class="main">&lt;</span><span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_integer_def<span class="main">)</span>

<span class="keyword1" id="Misc-nat_of_integer_less_iff"><span class="command">lemma</span></span> nat_of_integer_less_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">≥</span><span class="main">0</span> <span class="main">⟹</span> <span class="free">y</span><span class="main">≥</span><span class="main">0</span> <span class="main">⟹</span> nat_of_integer <span class="free">x</span> <span class="main">&lt;</span> nat_of_integer <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span><span class="main">&lt;</span><span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nat_of_integer.rep_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> int_of_integer_less_iff nat_less_eq_zless int_of_integer_less_iff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Natural Numbers"</span></span>
<span class="keyword1" id="Misc-exists_leI"><span class="command">lemma</span></span> exists_leI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n'</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">n'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="free">n</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n'</span></span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> contra<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n'</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n'</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">n'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hyp<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n'</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Induction on nat›</span></span>
  <span class="keyword1" id="Misc-nat_compl_induct"><span class="command">lemma</span></span> nat_compl_induct<span class="main">[</span><span class="operator">case_names</span> 0 Suc<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">P</span> <span class="main">0</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">n</span> <span class="main">.</span> <span class="main">∀</span><span class="bound">nn</span><span class="main">.</span> <span class="bound">nn</span> <span class="main">≤</span> <span class="bound">n</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">nn</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">n</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Misc-nat_compl_induct'"><span class="command">lemma</span></span> nat_compl_induct'<span class="main">[</span><span class="operator">case_names</span> 0 Suc<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">P</span> <span class="main">0</span><span class="main">;</span> <span class="main">!!</span> <span class="bound">n</span> <span class="main">.</span> <span class="main">⟦</span><span class="main">!!</span> <span class="bound">nn</span> <span class="main">.</span> <span class="bound">nn</span> <span class="main">≤</span> <span class="bound">n</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">nn</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">n</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Misc-nz_le_conv_less"><span class="command">lemma</span></span> nz_le_conv_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">&lt;</span><span class="free">k</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
  <span class="keyword1" id="Misc-min_Suc_gt"><span class="command">lemma</span></span> min_Suc_gt<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">&lt;</span><span class="free">b</span> <span class="main">⟹</span> min <span class="main">(</span>Suc <span class="free">a</span><span class="main">)</span> <span class="free">b</span> <span class="main">=</span> Suc <span class="free">a</span>"</span></span>  
    <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">&lt;</span><span class="free">b</span> <span class="main">⟹</span> min <span class="free">b</span> <span class="main">(</span>Suc <span class="free">a</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">a</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Integer›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some setup from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>int›</span></span></span></span> transferred to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>integer›</span></span></span></span>›</span></span>

<span class="keyword1" id="Misc-atLeastLessThanPlusOne_atLeastAtMost_integer"><span class="command">lemma</span></span> atLeastLessThanPlusOne_atLeastAtMost_integer<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">u</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="main">(</span><span class="free">u</span><span class="main">::</span>integer<span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atLeastAtMost_def atLeastLessThan_def<span class="main">)</span>
  <span class="keyword1"><span class="command">including</span></span> integer.lifting
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-atLeastPlusOneAtMost_greaterThanAtMost_integer"><span class="command">lemma</span></span> atLeastPlusOneAtMost_greaterThanAtMost_integer<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">l</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">u</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">l</span><span class="main">&lt;..</span><span class="main">(</span><span class="free">u</span><span class="main">::</span>integer<span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> integer.lifting
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atLeastAtMost_def greaterThanAtMost_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Misc-atLeastPlusOneLessThan_greaterThanLessThan_integer"><span class="command">lemma</span></span> atLeastPlusOneLessThan_greaterThanLessThan_integer<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">l</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">u</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">l</span><span class="main">&lt;..&lt;</span><span class="free">u</span><span class="main">::</span>integer<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> integer.lifting
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atLeastLessThan_def greaterThanLessThan_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Misc-image_atLeastZeroLessThan_integer"><span class="command">lemma</span></span> image_atLeastZeroLessThan_integer<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">u</span> <span class="main">⟹</span>
    <span class="main">{</span><span class="main">(</span><span class="main">0</span><span class="main">::</span>integer<span class="main">)</span><span class="main">..&lt;</span><span class="free">u</span><span class="main">}</span> <span class="main">=</span> of_nat <span class="main">`</span> <span class="main">{..&lt;</span>nat_of_integer <span class="free">u</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> integer.lifting
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> image_def lessThan_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"nat_of_integer <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zless_nat_eq_int_zless <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-image_add_integer_atLeastLessThan"><span class="command">lemma</span></span> image_add_integer_atLeastLessThan<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">%</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="main">(</span><span class="free">l</span><span class="main">::</span>integer<span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">u</span><span class="main">-</span><span class="free">l</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">u</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">-</span> <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-finite_atLeastZeroLessThan_integer"><span class="command">lemma</span></span> finite_atLeastZeroLessThan_integer<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="main">0</span><span class="main">::</span>integer<span class="main">)</span><span class="main">..&lt;</span><span class="free">u</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">u</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> image_atLeastZeroLessThan_integer<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_imageI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-finite_atLeastLessThan_integer"><span class="command">lemma</span></span> finite_atLeastLessThan_integer <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">u</span><span class="main">::</span>integer<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">%</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">l</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">u</span><span class="main">-</span><span class="free">l</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">u</span><span class="main">}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_imageI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_atLeastZeroLessThan_integer<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> image_add_integer_atLeastLessThan<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-finite_atLeastAtMost_integer"><span class="command">lemma</span></span> finite_atLeastAtMost_integer <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="main">(</span><span class="free">u</span><span class="main">::</span>integer<span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> atLeastLessThanPlusOne_atLeastAtMost_integer <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Misc-finite_greaterThanAtMost_integer"><span class="command">lemma</span></span> finite_greaterThanAtMost_integer <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="free">l</span><span class="main">&lt;..</span><span class="main">(</span><span class="free">u</span><span class="main">::</span>integer<span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> atLeastPlusOneAtMost_greaterThanAtMost_integer <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Misc-finite_greaterThanLessThan_integer"><span class="command">lemma</span></span> finite_greaterThanLessThan_integer <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="free">l</span><span class="main">&lt;..&lt;</span><span class="free">u</span><span class="main">::</span>integer<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> atLeastPlusOneLessThan_greaterThanLessThan_integer <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Functions of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"bool<span class="main"><span class="main">⇒</span></span>bool"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
  <span class="keyword1" id="Misc-boolfun_cases_helper"><span class="command">lemma</span></span> boolfun_cases_helper<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> False<span class="main">)</span> <span class="main">|</span> <span class="free">g</span><span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">|</span> <span class="free">g</span><span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span> <span class="main">|</span> <span class="free">g</span><span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span><span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> True"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">g</span> True"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span><span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">g</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> True"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">g</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">g</span> True"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> False<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Misc-boolfun_cases"><span class="command">lemma</span></span> boolfun_cases<span class="main">[</span><span class="operator">case_names</span> False Id True Neg<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">g</span><span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> False<span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> <span class="free">g</span><span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> <span class="free">g</span><span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> <span class="free">g</span><span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span><span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> boolfun_cases_helper<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> False<span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span><span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definite and indefinite description›</span></span>
        <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Combined definite and indefinite description for binary predicate"</span></span>
  <span class="keyword1" id="Misc-some_theI"><span class="command">lemma</span></span> some_theI<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> EX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> BUN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">b1</span> <span class="bound">b2</span> <span class="main">.</span> <span class="main">⟦</span><span class="main">∃</span><span class="bound">a</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b1</span><span class="main">;</span> <span class="main">∃</span><span class="bound">a</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">b1</span><span class="main">=</span><span class="bound">b2</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">a</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">b</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">b</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">a</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">from</span></span> EX <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">a</span><span class="main">.</span> <span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main">)</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> EX <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> BUN theI'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">b</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> Ex1_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> BUN
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Misc-some_insert_self"><span class="command">lemma</span></span> some_insert_self<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">≠</span><span class="main">{}</span> <span class="main">⟹</span> insert <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">)</span> <span class="free">S</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI<span class="main">)</span>

  <span class="keyword1" id="Misc-some_elem"><span class="command">lemma</span></span> some_elem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">≠</span><span class="main">{}</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Hilbert Choice with option›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Eps_Opt</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Eps_Opt</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1" id="Misc-some_opt_eq_trivial"><span class="command">lemma</span></span> some_opt_eq_trivial<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"Eps_Opt <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Eps_Opt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-some_opt_sym_eq_trivial"><span class="command">lemma</span></span> some_opt_sym_eq_trivial<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"Eps_Opt <span class="main">(</span><span class="main">(=)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Eps_Opt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-some_opt_false_trivial"><span class="command">lemma</span></span> some_opt_false_trivial<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"Eps_Opt <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Eps_Opt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-Eps_Opt_eq_None"><span class="command">lemma</span></span> Eps_Opt_eq_None<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"Eps_Opt <span class="free">P</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="main">¬</span><span class="main">(</span>Ex <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Eps_Opt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-Eps_Opt_eq_Some_implies"><span class="command">lemma</span></span> Eps_Opt_eq_Some_implies <span class="main">:</span>
  <span class="quoted"><span class="quoted">"Eps_Opt <span class="free">P</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Eps_Opt_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.inject option.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> someI_ex<span class="main">)</span>

<span class="keyword1" id="Misc-Eps_Opt_eq_Some"><span class="command">lemma</span></span> Eps_Opt_eq_Some <span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> P_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x'</span><span class="main">.</span> <span class="free">P</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="bound">x'</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Eps_Opt <span class="free">P</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟷</span> <span class="free">P</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> P_prop
<span class="keyword1"><span class="command">unfolding</span></span> Eps_Opt_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.inject option.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> someI_ex<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Product Type›</span></span>

<span class="keyword1" id="Misc-nested_case_prod_simp"><span class="command">lemma</span></span> nested_case_prod_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="bound">c</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span>
  <span class="main">(</span>case_prod <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span> <span class="free">y</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1" id="Misc-fn_fst_conv"><span class="command">lemma</span></span> fn_fst_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="Misc-fn_snd_conv"><span class="command">lemma</span></span> fn_snd_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pairself</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pairself</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Misc-pairself_image_eq"><span class="command">lemma</span></span> pairself_image_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pairself <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">,</span> <span class="free">f</span> <span class="bound">b</span><span class="main">)</span><span class="main">|</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Misc-pairself_image_cart"><span class="command">lemma</span></span> pairself_image_cart<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pairself <span class="free">f</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span><span class="main">×</span><span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="free">A</span> <span class="main">×</span> <span class="free">f</span><span class="main">`</span><span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>

<span class="keyword1" id="Misc-in_prod_fst_sndI"><span class="command">lemma</span></span> in_prod_fst_sndI<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> snd <span class="free">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span><span class="free">A</span><span class="main">×</span><span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-inj_Pair"><span class="command">lemma</span></span> inj_Pair<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="free">c</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span>"</span></span>
  <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">c</span> <span class="bound">x</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inj_onI<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> Product_Type.swap_inj_on<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="Misc-img_fst"><span class="command">lemma</span></span> img_fst <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ assms<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-img_snd"><span class="command">lemma</span></span> img_snd <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ assms<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-range_prod"><span class="command">lemma</span></span> range_prod<span class="main">:</span>
  <span class="quoted"><span class="quoted">"range <span class="free">f</span> <span class="main">⊆</span> <span class="main">(</span>range <span class="main">(</span>fst <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span>range <span class="main">(</span>snd <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> range <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span>fst<span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">,</span> snd<span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span>range <span class="main">(</span>fst <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span>range <span class="main">(</span>snd <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-finite_range_prod"><span class="command">lemma</span></span> finite_range_prod<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fst<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="main">(</span>fst <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     snd<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="main">(</span>snd <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> fst snd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="main">(</span>fst <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">×</span> range <span class="main">(</span>snd <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_SigmaI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> range_prod<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-fstE"><span class="command">lemma</span></span> fstE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv<span class="main">)</span>

<span class="keyword1" id="Misc-sndE"><span class="command">lemma</span></span> sndE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>snd <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> snd_conv<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Uncurrying›</span></span>

<span class="comment1">(* TODO: Move to HOL/Product_Type? Lars H: "It's equal to case_prod, should use an abbreviation"*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">uncurry</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">uncurry</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>

<span class="keyword1" id="Misc-uncurry_apply"><span class="command">lemma</span></span> uncurry_apply<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"uncurry <span class="free">f</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> uncurry_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-curry_uncurry_id"><span class="command">lemma</span></span> curry_uncurry_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"curry <span class="main">(</span>uncurry <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> uncurry_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-uncurry_curry_id"><span class="command">lemma</span></span> uncurry_curry_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"uncurry <span class="main">(</span>curry <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> uncurry_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-do_curry"><span class="command">lemma</span></span> do_curry<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> curry <span class="free">f</span> <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1" id="Misc-do_uncurry"><span class="command">lemma</span></span> do_uncurry<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> uncurry <span class="free">f</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sum Type›</span></span>    
<span class="keyword1" id="Misc-map_sum_Inr_conv"><span class="command">lemma</span></span> map_sum_Inr_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"map_sum <span class="free">fl</span> <span class="free">fr</span> <span class="free">s</span> <span class="main">=</span> Inr <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">s</span><span class="main">=</span>Inr <span class="bound">x</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="free">fr</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Misc-map_sum_Inl_conv"><span class="command">lemma</span></span> map_sum_Inl_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"map_sum <span class="free">fl</span> <span class="free">fr</span> <span class="free">s</span> <span class="main">=</span> Inl <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">s</span><span class="main">=</span>Inl <span class="bound">x</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="free">fl</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Directed Graphs and Relations›</span></span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Reflexive-Transitive Closure"</span></span>
  <span class="keyword1" id="Misc-r_le_rtrancl"><span class="command">lemma</span></span> r_le_rtrancl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">⊆</span><span class="free">S</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Misc-rtrancl_mono_rightI"><span class="command">lemma</span></span> rtrancl_mono_rightI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">⊆</span><span class="free">S'</span> <span class="main">⟹</span> <span class="free">S</span><span class="main">⊆</span><span class="free">S'</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Misc-trancl_sub"><span class="command">lemma</span></span> trancl_sub<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊆</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Misc-trancl_single"><span class="command">lemma</span></span> trancl_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trancl_insert<span class="main">)</span>


  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pick first non-reflexive step›</span></span>
  <span class="keyword1" id="Misc-converse_rtranclE'"><span class="command">lemma</span></span> converse_rtranclE'<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">=</span><span class="free">v</span>"</span></span>
    <span class="main">|</span> <span class="free">vh</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">≠</span><span class="free">vh</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">vh</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">vh</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtrancl_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">y</span><span class="main">=</span><span class="improper">z</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Misc-in_rtrancl_insert"><span class="command">lemma</span></span> in_rtrancl_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span><span class="main">(</span>insert <span class="free">r</span> <span class="free">R</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_mono rtrancl_mono subset_insertI<span class="main">)</span>


  <span class="keyword1" id="Misc-rtrancl_apply_insert"><span class="command">lemma</span></span> rtrancl_apply_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="main">(</span><span class="free">S</span><span class="main">∪</span><span class="free">R</span><span class="main">``</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> converse_rtranclE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> converse_rtranclE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> converse_rtrancl_into_rtrancl<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>




  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A path in a graph either does not use nodes from S at all, or it has a prefix leading to a node in S and a suffix that does not use nodes in S›</span></span>
  <span class="keyword1" id="Misc-rtrancl_last_visit"><span class="command">lemma</span></span> rtrancl_last_visit<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> no_visit last_visit_point<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span><span class="free">q'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">;</span>
       <span class="main">(</span><span class="free">q</span><span class="main">,</span><span class="free">q'</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">R</span><span class="main">-</span>UNIV<span class="main">×</span><span class="free">S</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span>
       <span class="main">!!</span><span class="bound">qt</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">qt</span><span class="main">∈</span><span class="free">S</span><span class="main">;</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span><span class="bound">qt</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">;</span> <span class="main">(</span><span class="bound">qt</span><span class="main">,</span><span class="free">q'</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">R</span><span class="main">-</span>UNIV<span class="main">×</span><span class="free">S</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>
     <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtrancl_induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> refl step<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> refl <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">q</span> <span class="skolem">qh</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> step.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">qh</span><span class="main">,</span><span class="free">q'</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">R</span><span class="main">-</span>UNIV<span class="main">×</span><span class="free">S</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">qh</span><span class="main">∈</span><span class="free">S</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> step.hyps<span class="main">(</span>1<span class="main">)</span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span><span class="main">,</span><span class="free">q'</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">R</span><span class="main">-</span>UNIV<span class="main">×</span><span class="free">S</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> converse_rtrancl_into_rtrancl<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> step.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">from</span></span> step.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span><span class="main">,</span><span class="skolem">qh</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> step.prems<span class="main">(</span>2<span class="main">)</span> True A <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">qt</span>
      <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qt</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">qh</span><span class="main">,</span><span class="skolem">qt</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">qt</span><span class="main">,</span><span class="free">q'</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">R</span><span class="main">-</span>UNIV<span class="main">×</span><span class="free">S</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> step.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span><span class="main">,</span><span class="skolem">qt</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> step.prems<span class="main">(</span>2<span class="main">)</span> A<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Less general version of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rtrancl_last_visit›</span></span></span></span>, but there's a short automatic proof›</span></span>
  <span class="keyword1" id="Misc-rtrancl_last_visit'"><span class="command">lemma</span></span> rtrancl_last_visit'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span><span class="free">q'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">;</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span><span class="free">q'</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">R</span><span class="main">-</span>UNIV<span class="main">×</span><span class="free">S</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> <span class="main">!!</span><span class="bound">qt</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">qt</span><span class="main">∈</span><span class="free">S</span><span class="main">;</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span><span class="bound">qt</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">;</span> <span class="main">(</span><span class="bound">qt</span><span class="main">,</span><span class="free">q'</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">R</span><span class="main">-</span>UNIV<span class="main">×</span><span class="free">S</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtrancl_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> converse_rtrancl_into_rtrancl<span class="main">)</span>

  <span class="keyword1" id="Misc-rtrancl_last_visit_node"><span class="command">lemma</span></span> rtrancl_last_visit_node<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">≠</span><span class="free">sh</span> <span class="main">∧</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">sh</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∨</span>
            <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∧</span> <span class="main">(</span><span class="free">sh</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">sh</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtrancl_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">s</span> <span class="skolem">st</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">st</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">-</span> <span class="main">{</span><span class="free">sh</span><span class="main">}</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span><span class="main">=</span><span class="free">sh</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> step <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span><span class="main">≠</span><span class="free">sh</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">st</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">st</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">R</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">-</span> <span class="main">{</span><span class="free">sh</span><span class="main">}</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> P
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="free">sh</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∧</span> <span class="main">(</span><span class="free">sh</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">-</span> <span class="main">{</span><span class="free">sh</span><span class="main">}</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> step<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> converse_rtrancl_into_rtrancl<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Find last point where a path touches a set›</span></span>
  <span class="keyword1" id="Misc-rtrancl_last_touch"><span class="command">lemma</span></span> rtrancl_last_touch<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span><span class="free">q'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">;</span> <span class="free">q</span><span class="main">∈</span><span class="free">S</span><span class="main">;</span> <span class="main">!!</span><span class="bound">qt</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">qt</span><span class="main">∈</span><span class="free">S</span><span class="main">;</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span><span class="bound">qt</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">;</span> <span class="main">(</span><span class="bound">qt</span><span class="main">,</span><span class="free">q'</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">R</span><span class="main">-</span>UNIV<span class="main">×</span><span class="free">S</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_last_visit'<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A path either goes over edge once, or not at all›</span></span>
  <span class="keyword1" id="Misc-trancl_over_edgeE"><span class="command">lemma</span></span> trancl_over_edgeE<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">w</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span>insert <span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">w</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v1</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v2</span><span class="main">,</span><span class="free">w</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">z</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insertE prod.inject r_into_trancl' rtrancl_eq_or_trancl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span>
        Pair_inject insertE rtrancl.simps trancl.simps trancl_into_rtrancl<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Misc-rtrancl_image_advance"><span class="command">lemma</span></span> rtrancl_image_advance<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">q</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="free">Q0</span><span class="main">;</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="free">Q0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtrancl_into_rtrancl<span class="main">)</span>

  <span class="keyword1" id="Misc-trancl_image_by_rtrancl"><span class="command">lemma</span></span> trancl_image_by_rtrancl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span><span class="main">``</span><span class="free">Vi</span> <span class="main">∪</span> <span class="free">Vi</span> <span class="main">=</span> <span class="main">(</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">``</span><span class="free">Vi</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Image_Id Un_Image rtrancl_trancl_reflcl<span class="main">)</span>

  <span class="keyword1" id="Misc-reachable_mono"><span class="command">lemma</span></span> reachable_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">R</span><span class="main">⊆</span><span class="free">R'</span><span class="main">;</span> <span class="free">X</span><span class="main">⊆</span><span class="free">X'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="free">X</span> <span class="main">⊆</span> <span class="free">R'</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="free">X'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Image_mono rtrancl_mono<span class="main">)</span>

  <span class="keyword1" id="Misc-finite_reachable_advance"><span class="command">lemma</span></span> finite_reachable_advance<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="main">(</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="main">{</span><span class="free">v0</span><span class="main">}</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="free">v0</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟧</span> <span class="main">⟹</span> finite <span class="main">(</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="main">{</span><span class="free">v</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-rtrancl_mono_mp"><span class="command">lemma</span></span> rtrancl_mono_mp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span><span class="main">⊆</span><span class="free">V</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span><span class="free">U</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span><span class="free">V</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_mono rtrancl_mono<span class="main">)</span>
<span class="keyword1" id="Misc-trancl_mono_mp"><span class="command">lemma</span></span> trancl_mono_mp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span><span class="main">⊆</span><span class="free">V</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span><span class="free">U</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span><span class="free">V</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> trancl_mono<span class="main">)</span>

<span class="keyword1" id="Misc-rtrancl_mapI"><span class="command">lemma</span></span> rtrancl_mapI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">,</span> <span class="free">f</span> <span class="free">b</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span>pairself <span class="free">f</span> <span class="main">`</span><span class="free">E</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtrancl.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-rtrancl_image_advance_rtrancl"><span class="command">lemma</span></span> rtrancl_image_advance_rtrancl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="free">Q0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">q</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="free">Q0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rtrancl_idemp rtrancl_image_advance<span class="main">)</span>

<span class="keyword1" id="Misc-nth_step_trancl"><span class="command">lemma</span></span> nth_step_trancl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">m</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> Suc <span class="bound">n</span><span class="main">,</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="bound">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">n</span><span class="main">,</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="skolem">xs</span> <span class="main">-</span> <span class="main">1</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> Suc <span class="bound">n</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def diff_Suc_eq_diff_pred nth_Cons_Suc zero_less_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this<span class="main">[</span><span class="operator">THEN</span> Cons.IH<span class="main">]</span>

  <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> n'<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n'</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"0"</span> <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"0"</span> Cons.prems<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="skolem">xs</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">n</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="skolem">xs</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">n</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> trancl_into_trancl gr0I r_into_trancl'<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="quoted">"0"</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m'</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> Cons.prems n' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">&lt;</span> <span class="skolem">n'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">n'</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">m'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> Suc n' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-Image_empty_trancl_Image_empty"><span class="command">lemma</span></span> Image_empty_trancl_Image_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">``</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Image_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> converse_tranclE<span class="main">)</span>

<span class="keyword1" id="Misc-Image_empty_rtrancl_Image_id"><span class="command">lemma</span></span> Image_empty_rtrancl_Image_id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">``</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Image_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> converse_rtranclE<span class="main">)</span>

<span class="keyword1" id="Misc-trans_rtrancl_eq_reflcl"><span class="command">lemma</span></span> trans_rtrancl_eq_reflcl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"trans <span class="free">A</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">^*</span> <span class="main">=</span> <span class="free">A</span><span class="main">^=</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rtrancl_trancl_reflcl<span class="main">)</span>

<span class="keyword1" id="Misc-refl_on_reflcl_Image"><span class="command">lemma</span></span> refl_on_reflcl_Image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"refl_on <span class="free">B</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">^=</span> <span class="main">``</span> <span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">``</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Image_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> refl_onD<span class="main">)</span>

<span class="keyword1" id="Misc-Image_absorb_rtrancl"><span class="command">lemma</span></span> Image_absorb_rtrancl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trans <span class="free">A</span><span class="main">;</span> refl_on <span class="free">B</span> <span class="free">A</span><span class="main">;</span> <span class="free">C</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">^*</span> <span class="main">``</span> <span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">``</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trans_rtrancl_eq_reflcl refl_on_reflcl_Image<span class="main">)</span>

<span class="keyword1" id="Misc-trancl_Image_unfold_left"><span class="command">lemma</span></span> trancl_Image_unfold_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">``</span><span class="free">S</span> <span class="main">=</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="free">E</span><span class="main">``</span><span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trancl_unfold_left<span class="main">)</span>

<span class="keyword1" id="Misc-trancl_Image_unfold_right"><span class="command">lemma</span></span> trancl_Image_unfold_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">``</span><span class="free">S</span> <span class="main">=</span> <span class="free">E</span><span class="main">``</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trancl_unfold_right<span class="main">)</span>

<span class="keyword1" id="Misc-trancl_Image_advance_ss"><span class="command">lemma</span></span> trancl_Image_advance_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span> <span class="main">⟹</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">``</span><span class="main">{</span><span class="free">v</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">``</span><span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-rtrancl_Image_advance_ss"><span class="command">lemma</span></span> rtrancl_Image_advance_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span> <span class="main">⟹</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="main">{</span><span class="free">v</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* FIXME: nicer name *)</span>
<span class="keyword1" id="Misc-trancl_union_outside"><span class="command">lemma</span></span> trancl_union_outside<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">w</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">E</span><span class="main">∪</span><span class="free">U</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">w</span><span class="main">)</span> <span class="main">∉</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">E</span><span class="main">∪</span><span class="free">U</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="free">w</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">E</span><span class="main">∪</span><span class="free">U</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">w</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="skolem">w</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="skolem">w</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">E</span><span class="main">∪</span><span class="free">U</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> True step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span><span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff trancl.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">E</span><span class="main">∪</span><span class="free">U</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> step.IH <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">E</span><span class="main">∪</span><span class="free">U</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">w</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">E</span><span class="main">∪</span><span class="free">U</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">E</span><span class="main">∪</span><span class="free">U</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rtrancl_into_rtrancl<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-trancl_restrict_reachable"><span class="command">lemma</span></span> trancl_restrict_reachable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span><span class="main">``</span><span class="free">S</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">∈</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">E</span><span class="main">∩</span><span class="free">S</span><span class="main">×</span><span class="free">S</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_trancl_induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trancl_into_trancl2<span class="main">)</span>

<span class="keyword1" id="Misc-rtrancl_image_unfold_right"><span class="command">lemma</span></span> rtrancl_image_unfold_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span><span class="main">``</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="free">V</span> <span class="main">⊆</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtrancl_into_rtrancl<span class="main">)</span>


<span class="keyword1" id="Misc-trancl_Image_in_Range"><span class="command">lemma</span></span> trancl_Image_in_Range<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">``</span> <span class="free">V</span> <span class="main">⊆</span> Range <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> trancl.induct<span class="main">)</span>

<span class="keyword1" id="Misc-rtrancl_Image_in_Field"><span class="command">lemma</span></span> rtrancl_Image_in_Field<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="free">V</span> <span class="main">⊆</span> Field <span class="free">R</span> <span class="main">∪</span> <span class="free">V</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> trancl_Image_in_Range <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">``</span> <span class="free">V</span> <span class="main">⊆</span> Field <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Field_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">``</span> <span class="free">V</span> <span class="main">∪</span> <span class="free">V</span> <span class="main">⊆</span> Field <span class="free">R</span> <span class="main">∪</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> trancl_image_by_rtrancl <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-rtrancl_sub_insert_rtrancl"><span class="command">lemma</span></span> rtrancl_sub_insert_rtrancl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⊆</span> <span class="main">(</span>insert <span class="free">x</span> <span class="free">R</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rtrancl.induct rtrancl_into_rtrancl<span class="main">)</span>

<span class="keyword1" id="Misc-trancl_sub_insert_trancl"><span class="command">lemma</span></span> trancl_sub_insert_trancl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⊆</span> <span class="main">(</span>insert <span class="free">x</span> <span class="free">R</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> trancl.induct trancl_into_trancl<span class="main">)</span>

<span class="keyword1" id="Misc-Restr_rtrancl_mono"><span class="command">lemma</span></span> Restr_rtrancl_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">w</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>Restr <span class="free">E</span> <span class="free">U</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟹</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inf_le1 rtrancl_mono subsetCE<span class="main">)</span>

<span class="keyword1" id="Misc-Restr_trancl_mono"><span class="command">lemma</span></span> Restr_trancl_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">w</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>Restr <span class="free">E</span> <span class="free">U</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟹</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inf_le1 trancl_mono<span class="main">)</span>








  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Converse Relation"</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> converse_add_simps <span class="main">=</span> converse_Times trancl_converse<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> converse_Un converse_Int

  <span class="keyword1" id="Misc-dom_ran_disj_comp"><span class="command">lemma</span></span> dom_ran_disj_comp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Domain <span class="free">R</span> <span class="main">∩</span> Range <span class="free">R</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">R</span> <span class="keyword1">O</span> <span class="free">R</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Misc-below_Id_inv"><span class="command">lemma</span></span> below_Id_inv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">¯</span><span class="main">⊆</span>Id <span class="main">⟷</span> <span class="free">R</span><span class="main">⊆</span>Id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    
    
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Cyclicity"</span></span>

  <span class="keyword1" id="Misc-cyclicE"><span class="command">lemma</span></span> cyclicE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span>acyclic <span class="free">g</span><span class="main">;</span> <span class="main">!!</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> acyclic_def<span class="main">)</span> <span class="operator">blast</span>

  <span class="keyword1" id="Misc-acyclic_insert_cyclic"><span class="command">lemma</span></span> acyclic_insert_cyclic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>acyclic <span class="free">g</span><span class="main">;</span> <span class="main">¬</span>acyclic <span class="main">(</span>insert <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">∈</span><span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> acyclic_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trancl_insert<span class="main">)</span>


  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    This lemma makes a case distinction about a path in a graph where a couple of edges with the same
    endpoint have been inserted: If there is a path from a to b, then there's such a path in the original graph, or
    there's a path that uses an inserted edge only once.

    Originally, this lemma was used to reason about the graph of an updated acquisition history. Any path in
    this graph is either already contained in the original graph, or passes via an
    inserted edge. Because all the inserted edges point to the same target node, in the
    second case, the path can be short-circuited to use exactly one inserted edge.
›</span></span>
  <span class="keyword1" id="Misc-trancl_multi_insert"><span class="command">lemma</span></span> trancl_multi_insert<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> orig via<span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">r</span><span class="main">∪</span><span class="free">X</span><span class="main">×</span><span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">;</span>
      <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span>
       <span class="main">!!</span><span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">;</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">;</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>
    <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trancl_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">b</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> step.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span><span class="main">∈</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
      <span class="keyword1"><span class="command">note</span></span> step.hyps<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">∈</span><span class="free">r</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">∈</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> step.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">∈</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">=</span><span class="free">m</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
      <span class="keyword1"><span class="command">note</span></span> step.hyps<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">∈</span><span class="free">r</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> A<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">∈</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> step.prems<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> A<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">∈</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">=</span><span class="free">m</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    Version of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] trancl_multi_insert<span class="antiquote"><span class="antiquote">}</span></span></span></span> for inserted edges with the same startpoint.
›</span></span>
  <span class="keyword1" id="Misc-trancl_multi_insert2"><span class="command">lemma</span></span> trancl_multi_insert2<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> orig via<span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">r</span><span class="main">∪</span><span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">×</span><span class="free">X</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">;</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> <span class="main">!!</span><span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">;</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">m</span><span class="main">)</span><span class="main">∈</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">;</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">goal_cases</span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> 1 <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main">∪</span><span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">×</span><span class="free">X</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span><span class="main">¯</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main">∪</span><span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">×</span><span class="free">X</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span><span class="main">¯</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span><span class="main">¯</span><span class="main">∪</span><span class="free">X</span><span class="main">×</span><span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> converse_add_simps<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">r</span><span class="main">¯</span> <span class="main">∪</span> <span class="free">X</span> <span class="main">×</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trancl_multi_insert
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span>
            <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trancl_converse rtrancl_converse
    <span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-cyclic_subset"><span class="command">lemma</span></span> cyclic_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span> acyclic <span class="free">R</span><span class="main">;</span> <span class="free">R</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">¬</span> acyclic <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> acyclic_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trancl_mono<span class="main">)</span>





  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Wellfoundedness›</span></span>
  <span class="keyword1" id="Misc-wf_min"><span class="command">lemma</span></span> wf_min<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">≠</span><span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span><span class="main">∈</span>Domain <span class="free">R</span> <span class="main">-</span> Range <span class="free">R</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">x</span><span class="main">.</span> wf <span class="free">R</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟶</span> <span class="bound">x</span><span class="main">∈</span>Domain <span class="free">R</span> <span class="main">-</span> Range <span class="free">R</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span><span class="main">∈</span>Domain <span class="free">R</span> <span class="main">-</span> Range <span class="free">R</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> wf_induct_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟶</span> <span class="bound">x</span><span class="main">∈</span>Domain <span class="free">R</span> <span class="main">-</span> Range <span class="free">R</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span><span class="main">∈</span>Domain <span class="free">R</span> <span class="main">-</span> Range <span class="free">R</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> A<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> A<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> H <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Misc-finite_wf_eq_wf_converse"><span class="command">lemma</span></span> finite_wf_eq_wf_converse<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">R</span> <span class="main">⟹</span> wf <span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">)</span> <span class="main">⟷</span> wf <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> acyclic_converse finite_acyclic_wf finite_acyclic_wf_converse wf_acyclic<span class="main">)</span>

  <span class="keyword1" id="Misc-wf_max"><span class="command">lemma</span></span> wf_max<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">≠</span><span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span><span class="main">∈</span>Range <span class="free">R</span> <span class="main">-</span> Domain <span class="free">R</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> A<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> NE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">¯</span><span class="main">≠</span><span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> wf_min<span class="main">[</span><span class="operator">OF</span> A<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> NE<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">∈</span>Range <span class="free">R</span> <span class="main">-</span> Domain <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> C<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

    <span class="comment1">― ‹Useful lemma to show well-foundedness of some process approaching a finite upper bound›</span>
  <span class="keyword1" id="Misc-wf_bounded_supset"><span class="command">lemma</span></span> wf_bounded_supset<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> wf <span class="main">{</span><span class="main">(</span><span class="bound">Q'</span><span class="main">,</span><span class="bound">Q</span><span class="main">)</span><span class="main">.</span> <span class="bound">Q'</span><span class="main">⊃</span><span class="bound">Q</span> <span class="main">∧</span> <span class="bound">Q'</span><span class="main">⊆</span> <span class="free">S</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">x</span><span class="main">.</span> finite <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">Q'</span><span class="main">,</span><span class="bound">Q</span><span class="main">)</span><span class="main">.</span> <span class="bound">Q</span><span class="main">⊂</span><span class="bound">Q'</span> <span class="main">∧</span> <span class="bound">Q'</span><span class="main">⊆</span> <span class="free">S</span><span class="main">}</span> <span class="main">⊆</span> inv_image <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">s'</span><span class="main">::</span>nat<span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="bound">s'</span><span class="main">&lt;</span><span class="bound">s</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">Q</span><span class="main">.</span> card <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="bound">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">⊂</span><span class="skolem">a</span> <span class="main">∧</span> <span class="skolem">a</span><span class="main">⊆</span><span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">-</span><span class="skolem">a</span> <span class="main">⊂</span> <span class="free">S</span><span class="main">-</span><span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="skolem">a</span><span class="main">)</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> psubset_card_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">s'</span><span class="main">::</span>nat<span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="bound">s'</span><span class="main">&lt;</span><span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_less<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_inv_image wf_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Misc-wf_no_path"><span class="command">lemma</span></span> wf_no_path<span class="main">:</span> <span class="quoted"><span class="quoted">"Domain <span class="free">R</span> <span class="main">∩</span> Range <span class="free">R</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> wf <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_no_loop<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Extend a wf-relation by a break-condition›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">brk_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span>
    <span class="main">{</span><span class="main">(</span><span class="main">(</span>False<span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>False<span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">}</span>
  <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span>True<span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>False<span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

<span class="keyword1" id="Misc-brk_rel_wf"><span class="command">lemma</span></span> brk_rel_wf<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WF<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>brk_rel <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="main">(</span>False<span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>False<span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="main">(</span>False<span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>False<span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">}</span> <span class="main">⊆</span> inv_image <span class="free">R</span> snd"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> wf_subset<span class="main">[</span><span class="operator">OF</span> wf_inv_image<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WF<span class="main"><span class="main">]</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="main">(</span>True<span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>False<span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_no_path<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> brk_rel_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Un_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_Un<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Restrict Relation›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rel_restrict</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rel_restrict</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">w</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> <span class="bound">w</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Misc-rel_restrict_alt_def"><span class="command">lemma</span></span> rel_restrict_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_restrict <span class="free">R</span> <span class="free">A</span> <span class="main">=</span> <span class="free">R</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">A</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="main">-</span><span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rel_restrict_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-rel_restrict_empty"><span class="command">lemma</span></span> rel_restrict_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_restrict <span class="free">R</span> <span class="main">{}</span> <span class="main">=</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_restrict_def<span class="main">)</span>

<span class="keyword1" id="Misc-rel_restrict_notR"><span class="command">lemma</span></span> rel_restrict_notR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> rel_restrict <span class="free">A</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">unfolding</span></span> rel_restrict_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-rel_restrict_sub"><span class="command">lemma</span></span> rel_restrict_sub<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_restrict <span class="free">R</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rel_restrict_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-rel_restrict_Int_empty"><span class="command">lemma</span></span> rel_restrict_Int_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> Field <span class="free">R</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> rel_restrict <span class="free">R</span> <span class="free">A</span> <span class="main">=</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rel_restrict_def Field_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-Domain_rel_restrict"><span class="command">lemma</span></span> Domain_rel_restrict<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Domain <span class="main">(</span>rel_restrict <span class="free">R</span> <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> Domain <span class="free">R</span> <span class="main">-</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rel_restrict_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-Range_rel_restrict"><span class="command">lemma</span></span> Range_rel_restrict<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Range <span class="main">(</span>rel_restrict <span class="free">R</span> <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> Range <span class="free">R</span> <span class="main">-</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rel_restrict_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-Field_rel_restrict"><span class="command">lemma</span></span> Field_rel_restrict<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Field <span class="main">(</span>rel_restrict <span class="free">R</span> <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> Field <span class="free">R</span> <span class="main">-</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rel_restrict_def Field_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-rel_restrict_compl"><span class="command">lemma</span></span> rel_restrict_compl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_restrict <span class="free">R</span> <span class="free">A</span> <span class="main">∩</span> rel_restrict <span class="free">R</span> <span class="main">(</span><span class="main">-</span><span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rel_restrict_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-finite_rel_restrict"><span class="command">lemma</span></span> finite_rel_restrict<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">R</span> <span class="main">⟹</span> finite <span class="main">(</span>rel_restrict <span class="free">R</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_subset rel_restrict_sub<span class="main">)</span>

<span class="keyword1" id="Misc-R_subset_Field"><span class="command">lemma</span></span> R_subset_Field<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊆</span> Field <span class="free">R</span> <span class="main">×</span> Field <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Field_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-homo_rel_restrict_mono"><span class="command">lemma</span></span> homo_rel_restrict_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">×</span> <span class="free">B</span> <span class="main">⟹</span> rel_restrict <span class="free">R</span> <span class="free">A</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">×</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Field <span class="free">R</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Field_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Field_rel_restrict <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Field <span class="main">(</span>rel_restrict <span class="free">R</span> <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">-</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_mono order_refl order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> R_subset_Field <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-rel_restrict_union"><span class="command">lemma</span></span> rel_restrict_union<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_restrict <span class="free">R</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> rel_restrict <span class="main">(</span>rel_restrict <span class="free">R</span> <span class="free">A</span><span class="main">)</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rel_restrict_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-rel_restrictI"><span class="command">lemma</span></span> rel_restrictI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">R</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∉</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> rel_restrict <span class="free">E</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rel_restrict_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-rel_restrict_lift"><span class="command">lemma</span></span> rel_restrict_lift<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> rel_restrict <span class="free">E</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rel_restrict_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-rel_restrict_trancl_mem"><span class="command">lemma</span></span> rel_restrict_trancl_mem<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>rel_restrict <span class="free">A</span> <span class="free">R</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∈</span> rel_restrict <span class="main">(</span><span class="free">A</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trancl_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_restrict_def<span class="main">)</span>

<span class="keyword1" id="Misc-rel_restrict_trancl_sub"><span class="command">lemma</span></span> rel_restrict_trancl_sub<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_restrict <span class="free">A</span> <span class="free">R</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⊆</span> rel_restrict <span class="main">(</span><span class="free">A</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subrelI rel_restrict_trancl_mem<span class="main">)</span>

<span class="keyword1" id="Misc-rel_restrict_mono"><span class="command">lemma</span></span> rel_restrict_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> rel_restrict <span class="free">A</span> <span class="free">R</span> <span class="main">⊆</span> rel_restrict <span class="free">B</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rel_restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-rel_restrict_mono2"><span class="command">lemma</span></span> rel_restrict_mono2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> rel_restrict <span class="free">A</span> <span class="free">S</span> <span class="main">⊆</span> rel_restrict <span class="free">A</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rel_restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-rel_restrict_Sigma_sub"><span class="command">lemma</span></span> rel_restrict_Sigma_sub<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_restrict <span class="main">(</span><span class="main">(</span><span class="free">A</span><span class="main">×</span><span class="free">A</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span> <span class="free">R</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">R</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rel_restrict_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> DiffI converse_tranclE mem_Sigma_iff r_into_trancl tranclE<span class="main">)</span>


<span class="keyword1" id="Misc-finite_reachable_restrictedI"><span class="command">lemma</span></span> finite_reachable_restrictedI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span><span class="main">⊆</span><span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"Range <span class="free">E</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> I R <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="free">I</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rtrancl.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> F
  <span class="keyword1"><span class="command">finally</span></span> <span class="main">(</span>finite_subset<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Misc-rtrancl_restrictI_aux"><span class="command">lemma</span></span> rtrancl_restrictI_aux<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">E</span><span class="main">-</span>UNIV<span class="main">×</span><span class="free">R</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">∉</span><span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span>rel_restrict <span class="free">E</span> <span class="free">R</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∧</span> <span class="free">v</span><span class="main">∉</span><span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_restrict_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtrancl.intros<span class="main">)</span>

  <span class="keyword1"><span class="command">corollary</span></span> rtrancl_restrictI<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">E</span><span class="main">-</span>UNIV<span class="main">×</span><span class="free">R</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">∉</span><span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span>rel_restrict <span class="free">E</span> <span class="free">R</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rtrancl_restrictI_aux<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Misc-E_closed_restr_reach_cases"><span class="command">lemma</span></span> E_closed_restr_reach_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> CL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span><span class="main">``</span><span class="free">R</span> <span class="main">⊆</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="free">R</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">∉</span><span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span>rel_restrict <span class="free">E</span> <span class="free">R</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> P
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_last_visit<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">R</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> no_visit
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">∈</span><span class="free">R</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> P <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="free">R</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rtrancl_reachable_induct<span class="main">[</span><span class="operator">OF</span> _ CL<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> no_visit <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span>rel_restrict <span class="free">E</span> <span class="free">R</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_restrictI<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>last_visit_point <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">E</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="free">R</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_mono_mp<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">∈</span><span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rtrancl_reachable_induct<span class="main">[</span><span class="operator">OF</span> _ CL<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-rel_restrict_trancl_notR"><span class="command">lemma</span></span> rel_restrict_trancl_notR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">w</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>rel_restrict <span class="free">E</span> <span class="free">R</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∉</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rel_restrict_trancl_mem rel_restrict_notR<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Misc-rel_restrict_tranclI"><span class="command">lemma</span></span> rel_restrict_tranclI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">``</span> <span class="free">R</span> <span class="main">⊆</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>rel_restrict <span class="free">E</span> <span class="free">R</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> r_into_trancl rel_restrictI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> trancl_into_trancl rel_restrictI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Single-Valued Relations›</span></span>
<span class="keyword1" id="Misc-single_valued_inter1"><span class="command">lemma</span></span> single_valued_inter1<span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="free">R</span> <span class="main">⟹</span> single_valued <span class="main">(</span><span class="free">R</span><span class="main">∩</span><span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> single_valuedI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD<span class="main">)</span>

<span class="keyword1" id="Misc-single_valued_inter2"><span class="command">lemma</span></span> single_valued_inter2<span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="free">R</span> <span class="main">⟹</span> single_valued <span class="main">(</span><span class="free">S</span><span class="main">∩</span><span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> single_valuedI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD<span class="main">)</span>

<span class="keyword1" id="Misc-single_valued_below_Id"><span class="command">lemma</span></span> single_valued_below_Id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">⊆</span>Id <span class="main">⟹</span> single_valued <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> single_valuedI<span class="main">)</span>
  

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Bijective Relations›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bijective</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⟶</span> <span class="bound">y</span><span class="main">=</span><span class="bound">z</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⟶</span> <span class="bound">x</span><span class="main">=</span><span class="bound">y</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Misc-bijective_alt"><span class="command">lemma</span></span> bijective_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"bijective <span class="free">R</span> <span class="main">⟷</span> single_valued <span class="free">R</span> <span class="main">∧</span> single_valued <span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bijective_def single_valued_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Misc-bijective_Id"><span class="command">lemma</span></span> bijective_Id<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bijective Id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bijective_def<span class="main">)</span>

<span class="keyword1" id="Misc-bijective_Empty"><span class="command">lemma</span></span> bijective_Empty<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bijective <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bijective_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Miscellaneous›</span></span>

  <span class="keyword1" id="Misc-pair_vimage_is_Image"><span class="command">lemma</span></span> pair_vimage_is_Image<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Pair <span class="free">u</span> <span class="main">-`</span> <span class="free">E</span><span class="main">)</span> <span class="main">=</span> <span class="free">E</span><span class="main">``</span><span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-fst_in_Field"><span class="command">lemma</span></span> fst_in_Field<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> <span class="free">R</span> <span class="main">⊆</span> Field <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Field_def fst_eq_Domain<span class="main">)</span>

<span class="keyword1" id="Misc-snd_in_Field"><span class="command">lemma</span></span> snd_in_Field<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> <span class="free">R</span> <span class="main">⊆</span> Field <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Field_def snd_eq_Range<span class="main">)</span>

<span class="keyword1" id="Misc-ran_map_of"><span class="command">lemma</span></span> ran_map_of<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ran <span class="main">(</span>map_of <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> snd <span class="main">`</span> set <span class="main">(</span><span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_def<span class="main">)</span>

<span class="keyword1" id="Misc-Image_subset_snd_image"><span class="command">lemma</span></span> Image_subset_snd_image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">``</span> <span class="free">B</span> <span class="main">⊆</span> snd <span class="main">`</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Image_def image_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Misc-finite_Image_subset"><span class="command">lemma</span></span> finite_Image_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">``</span> <span class="free">B</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> finite <span class="main">(</span><span class="free">C</span> <span class="main">``</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Image_mono order_refl rev_finite_subset<span class="main">)</span>

<span class="keyword1" id="Misc-finite_Field_eq_finite"><span class="command">lemma</span></span> finite_Field_eq_finite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Field <span class="free">R</span><span class="main">)</span> <span class="main">⟷</span> finite <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_cartesian_product finite_subset R_subset_Field finite_Field<span class="main">)</span>



<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fun_of_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>

<span class="keyword1" id="Misc-for_in_RI"><span class="command">lemma</span></span> for_in_RI<span class="comment1">(*[intro]*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span>Domain <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span>fun_of_rel <span class="free">R</span> <span class="free">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fun_of_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI<span class="main">)</span>

<span class="keyword1" id="Misc-Field_not_elem"><span class="command">lemma</span></span> Field_not_elem<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> Field <span class="free">R</span> <span class="main">⟹</span> <span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">v</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Field_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-Sigma_UNIV_cancel"><span class="command">lemma</span></span> Sigma_UNIV_cancel<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">X</span> <span class="main">-</span> <span class="free">A</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-same_fst_trancl"><span class="command">lemma</span></span> same_fst_trancl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>same_fst <span class="free">P</span> <span class="free">R</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">=</span> same_fst <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">R</span> <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span>same_fst <span class="free">P</span> <span class="free">R</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span><span class="main">∈</span>same_fst <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">R</span> <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> same_fst_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">x</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">f'</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>same_fst <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">R</span> <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span><span class="main">=</span><span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">R</span> <span class="skolem">f</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> same_fst_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">x</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">f'</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span>same_fst <span class="free">P</span> <span class="free">R</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induction</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> r_into_trancl<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> trancl_into_trancl<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>  
    

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>option›</span></span></span></span> Datatype›</span></span>
<span class="keyword1" id="Misc-le_some_optE"><span class="command">lemma</span></span> le_some_optE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Some <span class="free">m</span><span class="main">≤</span><span class="free">x</span><span class="main">;</span> <span class="main">!!</span><span class="bound">m'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">x</span><span class="main">=</span>Some <span class="bound">m'</span><span class="main">;</span> <span class="free">m</span><span class="main">≤</span><span class="bound">m'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1" id="Misc-not_Some_eq2"><span class="command">lemma</span></span> not_Some_eq2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">v</span> <span class="main">≠</span> Some <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Maps"</span></span>
  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">the_default</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">the_default</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">the_default</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> None <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">declare</span></span> map_add_dom_app_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>  
  <span class="keyword1"><span class="command">declare</span></span> map_add_upd_left<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>  

  <span class="keyword1" id="Misc-ran_add"><span class="command">lemma</span></span> ran_add<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">∩</span> dom <span class="free">g</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> ran <span class="main">(</span><span class="free">f</span><span class="main">++</span><span class="free">g</span><span class="main">)</span> <span class="main">=</span> ran <span class="free">f</span> <span class="main">∪</span> ran <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_def map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm option.split<span class="main">)</span>

  <span class="keyword1" id="Misc-nempty_dom"><span class="command">lemma</span></span> nempty_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">e</span><span class="main">≠</span>Map.empty<span class="main">;</span> <span class="main">!!</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span><span class="main">∈</span>dom <span class="free">e</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"dom <span class="free">e</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>



  <span class="keyword1" id="Misc-le_map_dom_mono"><span class="command">lemma</span></span> le_map_dom_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">≤</span><span class="free">m'</span> <span class="main">⟹</span> dom <span class="free">m</span> <span class="main">⊆</span> dom <span class="free">m'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> le_funD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> le_some_optE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Misc-map_add_first_le"><span class="command">lemma</span></span> map_add_first_le<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇀</span><span class="main">(</span><span class="tfree">'b</span><span class="main">::</span>order<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m</span><span class="main">≤</span><span class="free">m'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span><span class="main">++</span><span class="free">n</span> <span class="main">≤</span> <span class="free">m'</span><span class="main">++</span><span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> le_funE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Misc-map_add_distinct_le"><span class="command">lemma</span></span> map_add_distinct_le<span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m</span><span class="main">≤</span><span class="free">m'</span><span class="main">;</span> <span class="free">n</span><span class="main">≤</span><span class="free">n'</span><span class="main">;</span> dom <span class="free">m'</span> <span class="main">∩</span> dom <span class="free">n'</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span><span class="main">++</span><span class="free">n</span> <span class="main">≤</span> <span class="free">m'</span><span class="main">++</span><span class="free">n'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> le_funE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> le_map_dom_mono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> le_map_dom_mono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="improper">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_map_dom_mono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> le_funE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> le_funE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Misc-map_add_left_comm"><span class="command">lemma</span></span> map_add_left_comm<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">A</span> <span class="main">∩</span> dom <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">++</span> <span class="main">(</span><span class="free">B</span> <span class="main">++</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="main">++</span> <span class="main">(</span><span class="free">A</span> <span class="main">++</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">++</span> <span class="main">(</span><span class="free">B</span> <span class="main">++</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span><span class="main">++</span><span class="free">B</span><span class="main">)</span><span class="main">++</span><span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span><span class="main">++</span><span class="free">A</span><span class="main">)</span><span class="main">++</span><span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_comm<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">B</span><span class="main">++</span><span class="main">(</span><span class="free">A</span><span class="main">++</span><span class="free">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">lemmas</span></span> map_add_ac <span class="main">=</span> map_add_assoc map_add_comm map_add_left_comm

  <span class="keyword1" id="Misc-le_map_restrict"><span class="command">lemma</span></span> le_map_restrict<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇀</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">::</span>order<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">|`</span> <span class="free">X</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_map_def<span class="main">)</span>

<span class="keyword1" id="Misc-map_of_distinct_upd"><span class="command">lemma</span></span> map_of_distinct_upd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">x</span> <span class="main">↦</span> <span class="free">y</span><span class="main">]</span> <span class="main">++</span> map_of <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span>map_of <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_upd_twist<span class="main">)</span>

<span class="keyword1" id="Misc-map_of_distinct_upd2"><span class="command">lemma</span></span> map_of_distinct_upd2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set<span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map_of <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">insert</span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-map_of_distinct_upd3"><span class="command">lemma</span></span> map_of_distinct_upd3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set<span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map_of <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y'</span><span class="main">)</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">insert</span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-map_of_distinct_upd4"><span class="command">lemma</span></span> map_of_distinct_upd4<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set<span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map_of <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_of_eq_None_iff<span class="main">)</span>

<span class="keyword1" id="Misc-map_of_distinct_lookup"><span class="command">lemma</span></span> map_of_distinct_lookup<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set<span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map_of <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms map_of_distinct_upd2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-ran_distinct"><span class="command">lemma</span></span> ran_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">al</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ran <span class="main">(</span>map_of <span class="free">al</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">`</span> set <span class="free">al</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">al</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">kv</span> <span class="skolem">al</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ran <span class="main">(</span>map_of <span class="skolem">al</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">`</span> set <span class="skolem">al</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">al</span> <span class="main">(</span>fst <span class="skolem">kv</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_eq_None_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> map_of.simps ran_map_upd<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-ran_is_image"><span class="command">lemma</span></span> ran_is_image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ran <span class="free">M</span> <span class="main">=</span> <span class="main">(</span>the <span class="main">∘</span> <span class="free">M</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>dom <span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> ran_def dom_def image_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-map_card_eq_iff"><span class="command">lemma</span></span> map_card_eq_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> card_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>dom <span class="free">M</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>ran <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> indom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> dom <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span> <span class="free">x</span> <span class="main">=</span> <span class="free">M</span> <span class="free">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ran_is_image finite card_eq <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>the <span class="main">∘</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>dom <span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_card_imp_inj_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> dom <span class="free">M</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> indom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> indom <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">M</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="free">M</span> <span class="free">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inj_on_eq_iff<span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-map_dom_ran_finite"><span class="command">lemma</span></span> map_dom_ran_finite<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">M</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>ran <span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_is_image<span class="main">)</span>

<span class="keyword1" id="Misc-map_update_eta_repair"><span class="command">lemma</span></span> map_update_eta_repair<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="comment1">(* An update operation may get simplified, if it happens to be eta-expanded.
    This lemma tries to repair some common expressions *)</span>
  <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span><span class="main">=</span><span class="free">k</span> <span class="keyword1">then</span> Some <span class="free">v</span> <span class="keyword1">else</span> <span class="free">m</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">k</span> <span class="main">(</span>dom <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">k</span> <span class="main">=</span> None <span class="main">⟹</span> ran <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span><span class="main">=</span><span class="free">k</span> <span class="keyword1">then</span> Some <span class="free">v</span> <span class="keyword1">else</span> <span class="free">m</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">v</span> <span class="main">(</span>ran <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-map_leI"><span class="command">lemma</span></span> map_leI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">v</span><span class="main">.</span> <span class="free">m1</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟹</span> <span class="free">m2</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m1</span><span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span><span class="free">m2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_le_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1" id="Misc-map_leD"><span class="command">lemma</span></span> map_leD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m1</span><span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span><span class="free">m2</span> <span class="main">⟹</span> <span class="free">m1</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="free">m2</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_le_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    
<span class="keyword1" id="Misc-map_restrict_insert_none_simp"><span class="command">lemma</span></span> map_restrict_insert_none_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">x</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">m</span><span class="main">|`</span><span class="main">(</span><span class="main">-</span>insert <span class="free">x</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span><span class="main">|`</span><span class="main">(</span><span class="main">-</span><span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>restrict_map_def<span class="main">)</span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1" id="Misc-eq_f_restr_conv"><span class="command">lemma</span></span> eq_f_restr_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">⊆</span>dom <span class="main">(</span><span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> <span class="free">f</span> <span class="free">A</span> <span class="main">|`</span> <span class="main">(</span><span class="main">-</span><span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">A</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">f</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">=</span> dom <span class="main">(</span><span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">-</span> dom <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> map_leI restrict_map_eq<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ComplD restrict_map_eq<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Compl_iff restrict_in<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_le_def restrict_map_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">corollary</span></span> eq_f_restr_ss_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span><span class="main">⊆</span>dom <span class="main">(</span><span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">f</span> <span class="free">A</span> <span class="main">|`</span> <span class="main">(</span><span class="main">-</span><span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">A</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">f</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">=</span> dom <span class="main">(</span><span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">-</span> dom <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eq_f_restr_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
    
    
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Simultaneous Map Update›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_mmupd</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>
  <span class="keyword1" id="Misc-map_mmupd_empty"><span class="command">lemma</span></span> map_mmupd_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_mmupd <span class="free">m</span> <span class="main">{}</span> <span class="free">v</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_mmupd_def<span class="main">)</span>

  <span class="keyword1" id="Misc-mmupd_in_upd"><span class="command">lemma</span></span> mmupd_in_upd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">∈</span><span class="free">K</span> <span class="main">⟹</span> map_mmupd <span class="free">m</span> <span class="free">K</span> <span class="free">v</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_mmupd_def<span class="main">)</span>

  <span class="keyword1" id="Misc-mmupd_notin_upd"><span class="command">lemma</span></span> mmupd_notin_upd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">∉</span><span class="free">K</span> <span class="main">⟹</span> map_mmupd <span class="free">m</span> <span class="free">K</span> <span class="free">v</span> <span class="free">k</span> <span class="main">=</span> <span class="free">m</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_mmupd_def<span class="main">)</span>

  <span class="keyword1" id="Misc-map_mmupdE"><span class="command">lemma</span></span> map_mmupdE<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map_mmupd <span class="free">m</span> <span class="free">K</span> <span class="free">v</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">∉</span><span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
          <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">∈</span><span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span><span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_mmupd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>      

  <span class="keyword1" id="Misc-dom_mmupd"><span class="command">lemma</span></span> dom_mmupd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>map_mmupd <span class="free">m</span> <span class="free">K</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">m</span> <span class="main">∪</span> <span class="free">K</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_mmupd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>      

  <span class="keyword1" id="Misc-le_map_mmupd_not_dom"><span class="command">lemma</span></span> le_map_mmupd_not_dom<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> map_mmupd <span class="free">m</span> <span class="main">(</span><span class="free">K</span><span class="main">-</span>dom <span class="free">m</span><span class="main">)</span> <span class="free">v</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_le_def<span class="main">)</span>

  <span class="keyword1" id="Misc-map_mmupd_update_less"><span class="command">lemma</span></span> map_mmupd_update_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">K</span><span class="main">⊆</span><span class="free">K'</span> <span class="main">⟹</span> map_mmupd <span class="free">m</span> <span class="main">(</span><span class="free">K</span> <span class="main">-</span> dom <span class="free">m</span><span class="main">)</span> <span class="free">v</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> map_mmupd <span class="free">m</span> <span class="main">(</span><span class="free">K'</span><span class="main">-</span>dom <span class="free">m</span><span class="main">)</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_le_def map_mmupd_def<span class="main">)</span>

    

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Connection between Maps and Sets of Key-Value Pairs›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map_to_set</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_to_set</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">k</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">set_to_map</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">set_to_map</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> Eps_Opt <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Misc-set_to_map_simp"><span class="command">lemma</span></span> set_to_map_simp <span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> inj_on_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on fst <span class="free">S</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set_to_map <span class="free">S</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">note</span></span> kv_ex <span class="main">=</span> this
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> kv'_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">with</span></span> inj_on_fst <span class="keyword1"><span class="command">have</span></span> kv''_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v''</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="bound">v''</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟷</span> <span class="skolem">v'</span> <span class="main">=</span> <span class="bound">v''</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def Ball_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> set_to_map_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kv_ex kv''_in<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> kv''_nin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v''</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="bound">v''</span><span class="main">)</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_to_map_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-inj_on_fst_map_to_set"><span class="command">lemma</span></span> inj_on_fst_map_to_set <span class="main">:</span>
  <span class="quoted"><span class="quoted">"inj_on fst <span class="main">(</span>map_to_set <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> map_to_set_def inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-map_to_set_inverse"><span class="command">lemma</span></span> map_to_set_inverse <span class="main">:</span>
   <span class="quoted"><span class="quoted">"set_to_map <span class="main">(</span>map_to_set <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set_to_map <span class="main">(</span>map_to_set <span class="free">m</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">m</span> <span class="skolem">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">note</span></span> mk_eq <span class="main">=</span> this
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∉</span> map_to_set <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> map_to_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> set_to_map_simp <span class="main">[</span><span class="operator">OF</span> inj_on_fst_map_to_set<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mk_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">v</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> mk_eq <span class="main">=</span> this
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> map_to_set <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> map_to_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> set_to_map_simp <span class="main">[</span><span class="operator">OF</span> inj_on_fst_map_to_set<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mk_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-set_to_map_inverse"><span class="command">lemma</span></span> set_to_map_inverse <span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> inj_on_fst_S<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on fst <span class="free">S</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_to_set <span class="main">(</span>set_to_map <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">kv</span>
  <span class="keyword1"><span class="command">from</span></span> set_to_map_simp <span class="main">[</span><span class="operator">OF</span> inj_on_fst_S<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">kv</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">kv</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">kv</span> <span class="main">∈</span> map_to_set <span class="main">(</span>set_to_map <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">kv</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_to_set_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-map_to_set_empty"><span class="command">lemma</span></span> map_to_set_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_to_set Map.empty <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_to_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-set_to_map_empty"><span class="command">lemma</span></span> set_to_map_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set_to_map <span class="main">{}</span> <span class="main">=</span> Map.empty"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_to_map_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-map_to_set_empty_iff"><span class="command">lemma</span></span> map_to_set_empty_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"map_to_set <span class="free">m</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">=</span> Map.empty"</span></span>
                            <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">=</span> map_to_set <span class="free">m</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">=</span> Map.empty"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_to_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-set_to_map_empty_iff"><span class="command">lemma</span></span> set_to_map_empty_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"set_to_map <span class="free">S</span> <span class="main">=</span> Map.empty <span class="main">⟷</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?T1</span></span></span><span class="main">)</span>
                            <span class="quoted"><span class="quoted">"Map.empty <span class="main">=</span> set_to_map <span class="free">S</span> <span class="main">⟷</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?T2</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> T1<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?T1</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> set_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_to_map_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> T1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?T2</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-map_to_set_upd"><span class="command">lemma</span></span> map_to_set_upd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_to_set <span class="main">(</span><span class="free">m</span> <span class="main">(</span><span class="free">k</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>map_to_set <span class="free">m</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">|</span><span class="bound">v'</span><span class="main">.</span> True<span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_to_set_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-set_to_map_insert"><span class="command">lemma</span></span> set_to_map_insert<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> k_nin<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="free">kv</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="free">S</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_to_map <span class="main">(</span>insert <span class="free">kv</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>set_to_map <span class="free">S</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">kv</span> <span class="main">↦</span> snd <span class="free">kv</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k'</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> kv_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">kv</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.exhaust<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> k_nin <span class="keyword1"><span class="command">have</span></span> k_nin'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff Ball_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set_to_map <span class="main">(</span>insert <span class="free">kv</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="main">(</span>set_to_map <span class="free">S</span><span class="main">(</span>fst <span class="free">kv</span> <span class="main">↦</span> snd <span class="free">kv</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_to_map_def k_nin'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-map_to_set_dom"><span class="command">lemma</span></span> map_to_set_dom <span class="main">:</span>
  <span class="quoted"><span class="quoted">"dom <span class="free">m</span> <span class="main">=</span> fst <span class="main">`</span> <span class="main">(</span>map_to_set <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> dom_def map_to_set_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>

<span class="keyword1" id="Misc-map_to_set_ran"><span class="command">lemma</span></span> map_to_set_ran <span class="main">:</span>
  <span class="quoted"><span class="quoted">"ran <span class="free">m</span> <span class="main">=</span> snd <span class="main">`</span> <span class="main">(</span>map_to_set <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> ran_def map_to_set_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>

<span class="keyword1" id="Misc-set_to_map_dom"><span class="command">lemma</span></span> set_to_map_dom <span class="main">:</span>
  <span class="quoted"><span class="quoted">"dom <span class="main">(</span>set_to_map <span class="free">S</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">`</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> set_to_map_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> dom_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff Bex_def<span class="main">)</span>

<span class="keyword1" id="Misc-set_to_map_ran"><span class="command">lemma</span></span> set_to_map_ran <span class="main">:</span>
  <span class="quoted"><span class="quoted">"ran <span class="main">(</span>set_to_map <span class="free">S</span><span class="main">)</span> <span class="main">⊆</span> snd <span class="main">`</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> set_to_map_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> ran_def subset_iff
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff Bex_def<span class="main">)</span>
   <span class="main">(</span><span class="operator">metis</span> Eps_Opt_eq_Some<span class="main">)</span>

<span class="keyword1" id="Misc-finite_map_to_set"><span class="command">lemma</span></span> finite_map_to_set<span class="main">:</span>
<span class="quoted"><span class="quoted">"finite <span class="main">(</span>map_to_set <span class="free">m</span><span class="main">)</span> <span class="main">=</span> finite <span class="main">(</span>dom <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> map_to_set_def map_to_set_dom
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> iffI finite_imageI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_imageD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">fst</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-card_map_to_set"><span class="command">lemma</span></span> card_map_to_set <span class="main">:</span>
  <span class="quoted"><span class="quoted">"card <span class="main">(</span>map_to_set <span class="free">m</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>dom <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> map_to_set_def map_to_set_dom
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> card_image<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Misc-map_of_map_to_set"><span class="command">lemma</span></span> map_of_map_to_set <span class="main">:</span>
<span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">l</span><span class="main">)</span> <span class="main">⟹</span>
 map_of <span class="free">l</span> <span class="main">=</span> <span class="free">m</span> <span class="main">⟷</span> set <span class="free">l</span> <span class="main">=</span> map_to_set <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_to_set_empty_iff<span class="main">)</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">kv</span> <span class="skolem">l</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> kv_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">kv</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.exhaust<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> dist_l<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> kv'_nin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ind_hyp <span class="main">=</span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> dist_l<span class="main">]</span>

  <span class="keyword1"><span class="command">from</span></span> kv'_nin <span class="keyword1"><span class="command">have</span></span> l_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">kv</span> <span class="main">#</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> map_to_set <span class="skolem">m</span> <span class="main">⟷</span> <span class="main">(</span>set <span class="skolem">l</span> <span class="main">=</span> map_to_set <span class="main">(</span><span class="skolem">m</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">m</span> <span class="skolem">k</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_to_set_def restrict_map_def set_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> option.inject<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">from</span></span> kv'_nin <span class="keyword1"><span class="command">have</span></span> m_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span><span class="skolem">kv</span> <span class="main">#</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">m</span> <span class="main">⟷</span> map_of <span class="skolem">l</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">m</span> <span class="skolem">k</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff restrict_map_def map_of_eq_None_iff image_iff Ball_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> m_eq l_eq
    <span class="keyword1"><span class="command">using</span></span> ind_hyp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">:=</span> None<span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-map_to_set_map_of"><span class="command">lemma</span></span> map_to_set_map_of <span class="main">:</span>
<span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">l</span><span class="main">)</span> <span class="main">⟹</span> map_to_set <span class="main">(</span>map_of <span class="free">l</span><span class="main">)</span> <span class="main">=</span> set <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> map_of_map_to_set<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Mapping empty set to None›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">dflt_None_set</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">=</span><span class="main">{}</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1" id="Misc-the_dflt_None_empty"><span class="command">lemma</span></span> the_dflt_None_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dflt_None_set <span class="main">{}</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dflt_None_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-the_dflt_None_nonempty"><span class="command">lemma</span></span> the_dflt_None_nonempty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">≠</span><span class="main">{}</span> <span class="main">⟹</span> dflt_None_set <span class="free">S</span> <span class="main">=</span> Some <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dflt_None_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Misc-the_dflt_None_set"><span class="command">lemma</span></span> the_dflt_None_set<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"the_default <span class="main">{}</span> <span class="main">(</span>dflt_None_set <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dflt_None_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Orderings›</span></span>

  
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> min_arg_le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> min <span class="free">m</span> <span class="free">n</span> <span class="main">⟷</span> min <span class="free">m</span> <span class="free">n</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> min <span class="free">m</span> <span class="free">n</span> <span class="main">⟷</span> min <span class="free">m</span> <span class="free">n</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> linorder<span class="main">)</span> min_arg_not_ge<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> min <span class="free">m</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟷</span> min <span class="free">m</span> <span class="free">n</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> min <span class="free">m</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟷</span> min <span class="free">m</span> <span class="free">n</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> linorder<span class="main">)</span> min_eq_arg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"min <span class="free">m</span> <span class="free">n</span> <span class="main">=</span> <span class="free">m</span> <span class="main">⟷</span> <span class="free">m</span><span class="main">≤</span><span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"min <span class="free">m</span> <span class="free">n</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟷</span> <span class="free">n</span><span class="main">≤</span><span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_def<span class="main">)</span>

<span class="keyword1" id="Misc-min_simps"><span class="command">lemma</span></span> min_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">&lt;</span><span class="main">(</span><span class="free">b</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>order<span class="main">)</span> <span class="main">⟹</span> min <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">&lt;</span><span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>order<span class="main">)</span> <span class="main">⟹</span> min <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_imp_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> min_less_self_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"min <span class="free">a</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="main">_</span><span class="main">::</span>linorder<span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"min <span class="free">a</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">b</span><span class="main">::</span><span class="main">_</span><span class="main">::</span>linorder<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_def<span class="main">)</span>
    
<span class="keyword1" id="Misc-ord_eq_le_eq_trans"><span class="command">lemma</span></span> ord_eq_le_eq_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span><span class="main">=</span><span class="free">b</span><span class="main">;</span> <span class="free">b</span><span class="main">≤</span><span class="free">c</span><span class="main">;</span> <span class="free">c</span><span class="main">=</span><span class="free">d</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">≤</span><span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Misc-zero_comp_diff_simps"><span class="command">lemma</span></span> zero_comp_diff_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>linordered_idom<span class="main">)</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">a</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>linordered_idom<span class="main">)</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Termination Measures›</span></span>    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lexicographic measure, assuming upper bound for second component›</span></span>
<span class="keyword1" id="Misc-mlex_fst_decrI"><span class="command">lemma</span></span> mlex_fst_decrI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">a'</span> <span class="free">b</span> <span class="free">b'</span> <span class="free">N</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">&lt;</span><span class="free">a'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">&lt;</span><span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b'</span><span class="main">&lt;</span><span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">*</span><span class="free">N</span> <span class="main">+</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">a'</span><span class="main">*</span><span class="free">N</span> <span class="main">+</span> <span class="free">b'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">*</span><span class="free">N</span> <span class="main">+</span> <span class="free">b</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">a</span><span class="main">*</span><span class="free">N</span> <span class="main">+</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">b</span><span class="main">&lt;</span><span class="free">N</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">a'</span><span class="main">*</span><span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span><span class="main">&lt;</span><span class="free">a'</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_leI ab_semigroup_add_class.add.commute 
      ab_semigroup_mult_class.mult.commute mult_Suc_right mult_le_mono2<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">a'</span><span class="main">*</span><span class="free">N</span> <span class="main">+</span> <span class="free">b'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>      
  
<span class="keyword1" id="Misc-mlex_leI"><span class="command">lemma</span></span> mlex_leI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">a'</span> <span class="free">b</span> <span class="free">b'</span> <span class="free">N</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">≤</span><span class="free">a'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">≤</span><span class="free">b'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">*</span><span class="free">N</span> <span class="main">+</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">a'</span><span class="main">*</span><span class="free">N</span> <span class="main">+</span> <span class="free">b'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_mono<span class="main">)</span>
    
<span class="keyword1" id="Misc-mlex_snd_decrI"><span class="command">lemma</span></span> mlex_snd_decrI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">a'</span> <span class="free">b</span> <span class="free">b'</span> <span class="free">N</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">=</span><span class="free">a'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">&lt;</span><span class="free">b'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">*</span><span class="free">N</span> <span class="main">+</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">a'</span><span class="main">*</span><span class="free">N</span> <span class="main">+</span> <span class="free">b'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Misc-mlex_bound"><span class="command">lemma</span></span> mlex_bound<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">&lt;</span><span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">&lt;</span><span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">*</span><span class="free">N</span> <span class="main">+</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">A</span><span class="main">*</span><span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">using</span></span> mlex_fst_decrI <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹CCPOs›</span></span>

<span class="keyword1"><span class="command">context</span></span> ccpo
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Misc-ccpo_Sup_mono"><span class="command">lemma</span></span> ccpo_Sup_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"Complete_Partial_Order.chain <span class="main">(≤)</span> <span class="free">A</span>"</span></span>
    <span class="quoted"><span class="quoted">"Complete_Partial_Order.chain <span class="main">(≤)</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="bound">x</span><span class="main">≤</span><span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Sup <span class="free">A</span> <span class="main">≤</span> Sup <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccpo_Sup_least<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> B <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span><span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">≤</span><span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> L
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> I ccpo_Sup_upper <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">≤</span>Sup <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> C<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">≤</span>Sup <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> C<span class="main">)</span>

<span class="keyword1" id="Misc-fixp_mono"><span class="command">lemma</span></span> fixp_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"monotone <span class="main">(≤)</span> <span class="main">(≤)</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"monotone <span class="main">(≤)</span> <span class="main">(≤)</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> LE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Z</span><span class="main">.</span> <span class="free">f</span> <span class="bound">Z</span> <span class="main">≤</span> <span class="free">g</span> <span class="bound">Z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ccpo_class.fixp <span class="free">f</span> <span class="main">≤</span> ccpo_class.fixp <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fixp_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccpo_Sup_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> chain_iterates M<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">rule</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>ccpo_class.iterates <span class="free">f</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">∈</span>ccpo_class.iterates <span class="free">g</span><span class="main">.</span> <span class="skolem">x</span><span class="main">≤</span><span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span>ccpo_class.iterates <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">≤</span><span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">y</span> <span class="main">∈</span> ccpo_class.iterates <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">g</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> iterates.step<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> monotoneD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> M<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> LE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">∈</span>ccpo_class.iterates <span class="free">g</span><span class="main">.</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Sup <span class="skolem">M</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> <span class="main">{</span><span class="keyword1">SOME</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span><span class="main">∈</span>ccpo_class.iterates <span class="free">g</span> <span class="main">∧</span> <span class="bound">x</span><span class="main">≤</span><span class="bound">y</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="skolem">M</span><span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> N1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">N</span><span class="main">.</span> <span class="bound">y</span><span class="main">∈</span>ccpo_class.iterates <span class="free">g</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">M</span><span class="main">.</span> <span class="bound">x</span><span class="main">≤</span><span class="bound">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> N_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> Sup.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tfl_some<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> Sup.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tfl_some<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> N2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">M</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">N</span><span class="main">.</span> <span class="bound">x</span><span class="main">≤</span><span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> N_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> Sup.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tfl_some<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">⊆</span> ccpo_class.iterates <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Sup
      <span class="keyword1"><span class="command">using</span></span> N1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> C_chain<span class="main">:</span> <span class="quoted"><span class="quoted">"Complete_Partial_Order.chain <span class="main">(≤)</span> <span class="skolem">N</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> chain_iterates<span class="main">[</span><span class="operator">OF</span> M<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> chain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup <span class="skolem">N</span> <span class="main">∈</span> ccpo_class.iterates <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Sup <span class="skolem">M</span> <span class="main">≤</span> Sup <span class="skolem">N</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iterates.Sup<span class="main"><span class="main">[</span></span><span class="operator">OF</span> C_chain<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> N1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccpo_Sup_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup.hyps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> C_chain<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> N2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Code›</span></span>  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Constant for code-abort. If that gets executed, an abort-exception is raised.›</span></span>  
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CODE_ABORT</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">()</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">abort</span><span class="main"><span class="main">:</span></span> <span class="quoted">CODE_ABORT</span><span class="main">]</span><span class="main">]</span>
  
  
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Foldi">
<div class="head">
<h1>Theory Foldi</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Interuptible Fold
    Author:      Thomas Tuerk &lt;tuerk@in.tum.de&gt;
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Interuptible Fold›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Foldi
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Left folding›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">foldli</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">foldli</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">foldli</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">then</span> <span class="free">foldli</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Foldi-foldli_not_cond"><span class="command">lemma</span></span> foldli_not_cond <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">c</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⟹</span>foldli <span class="free">xs</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Foldi-foldli_cong"><span class="command">lemma</span></span> foldli_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="free">l'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">=</span> <span class="free">σ'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ff'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">l'</span><span class="main">;</span> <span class="free">c'</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">x</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldli <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">=</span> foldli <span class="free">l'</span> <span class="free">c'</span> <span class="free">f'</span> <span class="free">σ'</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> assms <span class="keyword1"><span class="command">using</span></span> ff'
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ'</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Notice that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">foldli</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a generalisation of folding that respects the abortion condition.›</span></span>
<span class="keyword1" id="Foldi-foldli_foldl"><span class="command">lemma</span></span> foldli_foldl <span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldli <span class="free">xs</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">=</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">)</span> <span class="free">σ</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Foldi-foldli_append"><span class="command">lemma</span></span> foldli_append <span class="main">:</span>
   <span class="quoted"><span class="quoted">"foldli <span class="main">(</span><span class="free">xs1</span> <span class="main">@</span> <span class="free">xs2</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">=</span>
    foldli <span class="free">xs2</span> <span class="free">c</span> <span class="free">f</span> <span class="main">(</span>foldli <span class="free">xs1</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Foldi-foldli_concat"><span class="command">lemma</span></span> foldli_concat <span class="main">:</span>
   <span class="quoted"><span class="quoted">"foldli <span class="main">(</span>concat <span class="free">xs</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">=</span>
    foldli <span class="free">xs</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> foldli <span class="bound">x</span> <span class="free">c</span> <span class="free">f</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldli_append<span class="main">)</span>

<span class="keyword1" id="Foldi-foldli_map"><span class="command">lemma</span></span> foldli_map <span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldli <span class="main">(</span>map <span class="free">f1</span> <span class="free">xs</span><span class="main">)</span> <span class="free">c</span> <span class="free">f2</span> <span class="free">σ</span> <span class="main">=</span>
   foldli <span class="free">xs</span> <span class="free">c</span> <span class="main">(</span><span class="free">f2</span> <span class="main">∘</span> <span class="free">f1</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Foldi-foldli_snoc"><span class="command">lemma</span></span> foldli_snoc <span class="main">:</span>
   <span class="quoted"><span class="quoted">"foldli <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">c</span> <span class="main">(</span>foldli <span class="free">xs</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span><span class="main">)</span> <span class="keyword1">then</span> 
     <span class="free">f</span> <span class="free">x</span> <span class="main">(</span>foldli <span class="free">xs</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>foldli <span class="free">xs</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Foldi-foldli_snoc_id"><span class="command">lemma</span></span> foldli_snoc_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"foldli <span class="free">l</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="free">l0</span> <span class="main">=</span> <span class="free">l0</span><span class="main">@</span><span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l0</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

    
<span class="keyword1" id="Foldi-foldli_foldli_prod_conv"><span class="command">lemma</span></span> foldli_foldli_prod_conv<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"foldli <span class="free">l2</span> <span class="free">ctd</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> foldli <span class="free">l1</span> <span class="free">ctd</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> foldli <span class="main">(</span>List.product <span class="free">l2</span> <span class="free">l1</span><span class="main">)</span> <span class="free">ctd</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span><span class="main">=</span><span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"foldli <span class="main">(</span>map <span class="main">(</span>Pair <span class="skolem">a</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span> <span class="free">ctd</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> foldli <span class="skolem">l</span> <span class="free">ctd</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l2</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l1</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> foldli_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1" id="Foldi-fold_fold_prod_conv"><span class="command">lemma</span></span> fold_fold_prod_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> fold <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="free">l1</span><span class="main">)</span> <span class="free">l2</span> <span class="free">s</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>List.product <span class="free">l2</span> <span class="free">l1</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> foldli_foldli_prod_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l2</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span> <span class="quoted"><span class="free">l1</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldli_foldl foldl_conv_fold<span class="main">)</span>
    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Right folding›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">foldri</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'σ</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'x</span> <span class="main">⇒</span> <span class="tfree">'σ</span> <span class="main">⇒</span> <span class="tfree">'σ</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'σ</span> <span class="main">⇒</span> <span class="tfree">'σ</span>"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">foldri</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> foldli <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Foldi-foldri_simp"><span class="command">lemma</span></span> foldri_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"foldri <span class="main">[]</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"foldri <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">c</span> <span class="free">σ</span> <span class="keyword1">then</span> foldri <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="free">σ</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> foldri_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Foldi-foldri_simp_Cons"><span class="command">lemma</span></span> foldri_simp_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"foldri <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free">c</span> <span class="main">(</span>foldri <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>  <span class="free">f</span> <span class="free">x</span> <span class="main">(</span>foldri <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>foldri <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> foldri_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldli_append<span class="main">)</span>

<span class="keyword1" id="Foldi-foldri_code"><span class="command">lemma</span></span> foldri_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"foldri <span class="main">[]</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"foldri <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">σ'</span> <span class="main">=</span> foldri <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="free">c</span> <span class="bound">σ'</span> <span class="keyword1">then</span>  <span class="free">f</span> <span class="free">x</span> <span class="bound">σ'</span> <span class="keyword1">else</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Foldi-foldri_not_cond"><span class="command">lemma</span></span> foldri_not_cond <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">c</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⟹</span>foldri <span class="free">xs</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> foldri_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Foldi-foldri_cong"><span class="command">lemma</span></span> foldri_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="free">l'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">=</span> <span class="free">σ'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ff'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">l'</span><span class="main">;</span> <span class="free">c'</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">x</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldri <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">=</span> foldri <span class="free">l'</span> <span class="free">c'</span> <span class="free">f'</span> <span class="free">σ'</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> assms <span class="keyword1"><span class="command">using</span></span> ff'
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ'</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Notice that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">foldli</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a generalisation of folding that respects the abortion condition.›</span></span>
<span class="keyword1" id="Foldi-foldri_foldr"><span class="command">lemma</span></span> foldri_foldr <span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldri <span class="free">xs</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">=</span> foldr <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">σ</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span><span class="main">)</span> <span class="free">xs</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Foldi-foldri_append"><span class="command">lemma</span></span> foldri_append <span class="main">:</span>
   <span class="quoted"><span class="quoted">"foldri <span class="main">(</span><span class="free">xs1</span> <span class="main">@</span> <span class="free">xs2</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">=</span>
    foldri <span class="free">xs1</span> <span class="free">c</span> <span class="free">f</span> <span class="main">(</span>foldri <span class="free">xs2</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> foldri_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldli_append<span class="main">)</span>

<span class="keyword1" id="Foldi-foldri_concat"><span class="command">lemma</span></span> foldri_concat <span class="main">:</span>
   <span class="quoted"><span class="quoted">"foldri <span class="main">(</span>concat <span class="free">xs</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span> <span class="main">=</span>
    foldri <span class="free">xs</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> foldri <span class="bound">x</span> <span class="free">c</span> <span class="free">f</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> foldri_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_concat foldli_concat foldli_map o_def<span class="main">)</span>

<span class="keyword1" id="Foldi-foldri_map"><span class="command">lemma</span></span> foldri_map <span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldri <span class="main">(</span>map <span class="free">f1</span> <span class="free">xs</span><span class="main">)</span> <span class="free">c</span> <span class="free">f2</span> <span class="free">σ</span> <span class="main">=</span>
   foldri <span class="free">xs</span> <span class="free">c</span> <span class="main">(</span><span class="free">f2</span> <span class="main">∘</span> <span class="free">f1</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> foldri_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_map foldli_map<span class="main">)</span>

<span class="keyword1" id="Foldi-foldri_cons_id"><span class="command">lemma</span></span> foldri_cons_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"foldri <span class="free">l</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">x</span><span class="main">#</span><span class="bound">l</span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Indep_Vars">
<div class="head">
<h1>Theory Indep_Vars</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Indep_Vars
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="Refine_Util.html">Refine_Util</a> <a href="Mpat_Antiquot.html">Mpat_Antiquot</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">INDEP</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> True"</span></span>
<span class="keyword1" id="Indep_Vars-INDEPI"><span class="command">lemma</span></span> INDEPI<span class="main">:</span> <span class="quoted"><span class="quoted">"INDEP <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">INDEP_VARS</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> indep_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Indep_Vars</span><span class="main">:</span> <span class="entity">INDEP_VARS</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>

    <span class="keyword2"><span class="keyword">local</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">vsubterms</span> <span class="main">(</span>Abs <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">vsubterms</span> <span class="entity">t</span>
        <span class="main">|</span> <span class="entity">vsubterms</span> <span class="main">(</span><span class="entity">t</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="main">_</span>$<span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span> <span class="main">=</span> strip_comb <span class="entity">t</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">args_vsts</span> <span class="main">=</span> map <span class="entity">vsubterms</span> <span class="entity">args</span> |&gt; flat
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">f</span> <span class="keyword2"><span class="keyword">of</span></span>
              <span class="main">(</span>Var <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">vT</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">vT</span><span class="main">,</span>fastype_of <span class="entity">t</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span><span class="main">]</span>@<span class="entity">args_vsts</span>
            <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">vsubterms</span> <span class="entity">f</span> @ <span class="entity">args_vsts</span>
          <span class="keyword2"><span class="keyword">end</span></span>
        <span class="main">|</span> <span class="entity">vsubterms</span> <span class="main">_</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">indep_vars</span> <span class="entity">ctxt</span> <span class="entity">t</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cert</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span>

        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">inst_of</span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">vT</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Ts</span> <span class="main">=</span> map fastype_of <span class="entity">args</span> |&gt; rev
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t'</span> <span class="main">=</span> fold absdummy <span class="entity">Ts</span> <span class="main">(</span>Var <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">inst</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">vT</span><span class="main">)</span><span class="main">,</span> <span class="entity">cert</span> <span class="entity">t'</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">inst</span> <span class="keyword2"><span class="keyword">end</span></span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">inst</span> <span class="main">=</span> <span class="entity">vsubterms</span> <span class="entity">t</span>
          |&gt; distinct <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> o apply2 <span class="main">#</span><span class="inner_numeral">1</span><span class="main">)</span>
          |&gt; map <span class="entity">inst_of</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">st'</span> <span class="main">=</span> Drule.instantiate_normalize <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="entity">inst</span><span class="main">)</span> <span class="entity">st</span>
          |&gt; Conv.fconv_rule <span class="main">(</span>Thm.beta_conversion true<span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        Seq.single <span class="entity">st'</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">indep_tac_aux</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> Logic.concl_of_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span>INDEP <span class="var">?v</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span>
          <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">indep_vars</span> <span class="entity">ctxt</span> <span class="entity">v</span> THEN resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> INDEPI<span class="antiquote">}</span></span></span> <span class="entity">i</span><span class="main">)</span> <span class="entity">st</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Seq.empty

    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="comment1">(* Remove explicit parameters from schematic variable. *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">indep_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">IF_EXGOAL</span>
        <span class="main">(</span>CONVERSION Thm.eta_conversion THEN' <span class="entity">indep_tac_aux</span> <span class="entity">ctxt</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Select_Solve">
<div class="head">
<h1>Theory Select_Solve</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Select_Solve
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="Refine_Util.html">Refine_Util</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*
  Focus on subgoal, respect schematic variable instantiations.
  *** Be aware that this seems to be slower then to work with
    big subgoals! ***

*)</span>

<span class="keyword1" id="Select_Solve-retrofit_with_prems"><span class="command">lemma</span></span> retrofit_with_prems<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="free">Q</span> <span class="free">R</span> <span class="free">TAG</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"prop"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="free">P</span> <span class="main">==&gt;</span> <span class="keyword1">PROP</span> <span class="free">Q</span>"</span></span> <span class="comment1">(* Original goal state *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="free">R</span> <span class="main">==&gt;</span> <span class="keyword1">PROP</span> <span class="free">TAG</span> <span class="main">&amp;&amp;&amp;</span> <span class="keyword1">PROP</span> <span class="free">P</span>"</span></span> <span class="comment1">(* Result of first subgoal *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="free">R</span> <span class="main">==&gt;</span> <span class="keyword1">PROP</span> <span class="free">Q</span>"</span></span> <span class="comment1">(* New goal state with &amp;&amp;&amp;*)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">THEN</span> 2<span class="main">,</span> <span class="operator">THEN</span> conjunctionD2<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Select_Solve-retrofit_no_prems"><span class="command">lemma</span></span> retrofit_no_prems<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="free">Q</span> <span class="free">TAG</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"prop"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="free">P</span> <span class="main">==&gt;</span> <span class="keyword1">PROP</span> <span class="free">Q</span>"</span></span> <span class="comment1">(* Original goal state *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="free">TAG</span> <span class="main">&amp;&amp;&amp;</span> <span class="keyword1">PROP</span> <span class="free">P</span>"</span></span> <span class="comment1">(* Result of first subgoal *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="free">Q</span>"</span></span> <span class="comment1">(* New goal state *)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> conjunctionD2<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">consts</span></span> NO_TAG <span class="main">::</span> <span class="quoted"><span class="quoted">"prop"</span></span>


<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SELECT_SOLVE</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> PREFER_SOLVED<span class="main">:</span> tactic <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> IF_SUBGOAL_SOLVED<span class="main">:</span> tactic <span class="main">-&gt;</span> tactic <span class="main">-&gt;</span> tactic <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> TRY_SOLVE_FWD<span class="main">:</span> int <span class="main">-&gt;</span> tactic <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> SELECT_FIRST<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> tactic <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> AS_FIRSTGOAL<span class="main">:</span> tactic <span class="main">-&gt;</span> <span class="entity">tactic'</span>
  <span class="keyword1"><span class="keyword">val</span></span> REPEAT_SOLVE_FWD_SELECT<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> <span class="entity">tactic'</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span> 
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Select_Solve</span> <span class="main">:</span><span class="entity">SELECT_SOLVE</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">PREFER_SOLVED</span> <span class="entity">tac</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> Thm.nprems_of <span class="entity">st</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="entity">tac</span> <span class="entity">st</span>
    <span class="comment1">(*val res' = Seq.append 
      (Seq.filter (has_fewer_prems n) res)
      (Seq.filter (not o has_fewer_prems n) res)*)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res'</span> <span class="main">=</span> Seq.filter <span class="main">(</span>has_fewer_prems <span class="entity">n</span><span class="main">)</span> <span class="entity">res</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">res'</span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">IF_SUBGOAL_SOLVED</span> <span class="entity">tac1</span> <span class="entity">then_tac</span> <span class="entity">else_tac</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> Thm.nprems_of <span class="entity">st</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span><span class="entity">tac1</span> THEN COND <span class="main">(</span>has_fewer_prems <span class="entity">n</span><span class="main">)</span> <span class="entity">then_tac</span> <span class="entity">else_tac</span><span class="main">)</span> <span class="entity">st</span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">TRY_SOLVE_FWD</span> <span class="entity">i</span> <span class="entity">tac</span> <span class="entity">st</span> <span class="main">=</span> 
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &lt;= <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> 
      Seq.single <span class="entity">st</span> 
    <span class="keyword2"><span class="keyword">else</span></span>
      IF_UNSOLVED <span class="main">(</span>
        <span class="entity">IF_SUBGOAL_SOLVED</span> <span class="entity">tac</span> <span class="main">(</span><span class="entity">TRY_SOLVE_FWD</span> <span class="main">(</span><span class="entity">i</span>-<span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">tac</span><span class="main">)</span> all_tac
      <span class="main">)</span> <span class="entity">st</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">TRY_SOLVE_ALL_NEW_FWD</span> <span class="entity">tac1</span> <span class="entity">tac2</span> <span class="entity">tac3</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> Thm.nprems_of <span class="entity">st</span>
  <span class="keyword2"><span class="keyword">in</span></span> 
    <span class="main">(</span>
      <span class="entity">tac1</span> THEN_ELSE 
        <span class="main">(</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st'</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n'</span> <span class="main">=</span> Thm.nprems_of <span class="entity">st'</span> <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">TRY_SOLVE_FWD</span> <span class="main">(</span><span class="entity">n'</span> - <span class="entity">n</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">tac2</span> <span class="entity">st'</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">,</span>
          <span class="entity">tac3</span><span class="main">)</span>
    <span class="main">)</span> <span class="entity">st</span> 
  <span class="keyword2"><span class="keyword">end</span></span>


  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">SELECT_FIRST</span> <span class="entity">ctxt</span> <span class="entity">tac</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> Thm.nprems_of <span class="entity">st</span> &lt; <span class="inner_numeral">2</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">tac</span> <span class="entity">st</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="comment1">(*val _ = print_tac "Focusing" st*)</span>

    <span class="comment1">(* Extract first subgoal *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">P</span><span class="main">,</span><span class="entity">Q</span><span class="main">)</span> <span class="main">=</span> Thm.dest_implies <span class="main">(</span>Thm.cprop_of <span class="entity">st</span><span class="main">)</span>

    <span class="comment1">(*val _ = "Extracted: " ^ @{make_string} P |&gt; tracing*)</span>

    <span class="comment1">(* Prepare tag *)</span>
    <span class="keyword2"><span class="keyword">local</span></span> 
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">intr_bal</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> <span class="quoted">‹<span class="keyword1">TERM</span> NO_TAG›</span><span class="antiquote">}</span></span></span>
        <span class="main">|</span> <span class="entity">intr_bal</span> <span class="entity">l</span> <span class="main">=</span> Conjunction.intr_balanced <span class="entity">l</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> Thm.term_of <span class="entity">P</span> 

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vars</span> <span class="main">=</span> Term.add_vars <span class="entity">t</span> <span class="main">[</span><span class="main">]</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tvars</span> <span class="main">=</span> Term.add_tvars <span class="entity">t</span> <span class="main">[</span><span class="main">]</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vtvars</span> <span class="main">=</span> fold <span class="main">(</span>Term.add_tvarsT o <span class="main">#</span><span class="inner_numeral">2</span><span class="main">)</span> <span class="entity">vars</span> <span class="main">[</span><span class="main">]</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tvars</span> <span class="main">=</span> subtract <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">vtvars</span> <span class="entity">tvars</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tvars_tag</span> <span class="main">=</span> <span class="entity">tvars</span>
        |&gt; map <span class="main">(</span>Drule.mk_term o Thm.cterm_of <span class="entity">ctxt</span> o Logic.mk_type o TVar<span class="main">)</span>
        |&gt; <span class="entity">intr_bal</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vars_tag</span> <span class="main">=</span> <span class="entity">vars</span>
        |&gt; map <span class="main">(</span>Drule.mk_term o Thm.cterm_of <span class="entity">ctxt</span> o Var<span class="main">)</span>
        |&gt; <span class="entity">intr_bal</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tag_thm</span> <span class="main">=</span> Conjunction.intr <span class="entity">tvars_tag</span> <span class="entity">vars_tag</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">TAG</span> <span class="main">=</span> Thm.cprop_of <span class="entity">tag_thm</span>

    <span class="comment1">(* Prepare new proof state *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">st'</span> <span class="main">=</span> Conjunction.mk_conjunction <span class="main">(</span><span class="entity">TAG</span><span class="main">,</span> <span class="entity">P</span><span class="main">)</span>
      |&gt; Goal.init
      |&gt; Conjunction.curry_balanced <span class="inner_numeral">2</span>
      |&gt; Thm.elim_implies <span class="entity">tag_thm</span>

    <span class="comment1">(*val _ = "New proof state: " ^ @{make_string} st' |&gt; tracing*)</span>

    <span class="comment1">(*val _ = print_tac "New state" st'*)</span>

    <span class="comment1">(* Apply proof *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">seq</span> <span class="main">=</span> <span class="entity">tac</span> <span class="entity">st'</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">elim_implies</span> <span class="entity">thA</span> <span class="entity">thAB</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">case</span></span> try Thm.dest_implies <span class="main">(</span>Thm.cprop_of <span class="entity">thAB</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span> 
        SOME <span class="main">(</span><span class="entity">A</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>
          <span class="entity">A</span> aconvc Thm.cprop_of <span class="entity">thA</span>
            <span class="keyword1"><span class="keyword">orelse</span></span> <span class="main">(</span>
              <span class="comment1">(*tracing (@{make_string} (term_of A));
              tracing (@{make_string} (prop_of thA));*)</span>
              <span class="keyword3"><span class="keyword">raise</span></span> CTERM <span class="main">(</span><span class="inner_quoted">"implies_elim: No aconv"</span><span class="main">,</span><span class="main">[</span><span class="entity">A</span><span class="main">,</span>Thm.cprop_of <span class="entity">thA</span><span class="main">]</span><span class="main">)</span>
            <span class="main">)</span><span class="main">;</span>
          Thm.elim_implies <span class="entity">thA</span> <span class="entity">thAB</span>
        <span class="main">)</span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> THM <span class="main">(</span><span class="inner_quoted">"implies_elim: No impl"</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">,</span><span class="main">[</span><span class="entity">thAB</span><span class="main">,</span><span class="entity">thA</span><span class="main">]</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">retrofit</span> <span class="entity">st'</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">st'</span> <span class="main">=</span> Drule.incr_indexes <span class="entity">st</span> <span class="entity">st'</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> Thm.nprems_of <span class="entity">st'</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> Conjunction.uncurry_balanced <span class="entity">n</span> <span class="entity">st'</span>
        |&gt; Goal.conclude
        |&gt; Conv.fconv_rule <span class="main">(</span>Thm.beta_conversion true<span class="main">)</span>
      <span class="comment1">(*val _ = "Proved: " ^ @{make_string} thm |&gt; tracing*)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span><span class="main">=</span><span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> 
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">TAG'</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=</span> Conjunction.dest_conjunction <span class="main">(</span>Thm.cprop_of <span class="entity">thm</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">inst</span> <span class="main">=</span> Thm.match <span class="main">(</span><span class="entity">TAG</span><span class="main">,</span> <span class="entity">TAG'</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">st</span> <span class="main">=</span> Thm.instantiate <span class="entity">inst</span> <span class="entity">st</span> 
            |&gt; Conv.fconv_rule <span class="main">(</span>Thm.beta_conversion true<span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">P</span> <span class="main">=</span> Thm.instantiate_cterm <span class="entity">inst</span> <span class="entity">P</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Q</span> <span class="main">=</span> Thm.instantiate_cterm <span class="entity">inst</span> <span class="entity">Q</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> retrofit_no_prems<span class="antiquote">}</span></span></span>
          |&gt; Thm.instantiate' <span class="main">[</span><span class="main">]</span> <span class="main">[</span>SOME <span class="entity">P</span><span class="main">,</span> SOME <span class="entity">Q</span><span class="main">,</span> SOME <span class="entity">TAG'</span><span class="main">]</span> 
          |&gt; Conv.fconv_rule <span class="main">(</span>Thm.beta_conversion true<span class="main">)</span>
          |&gt; <span class="entity">elim_implies</span> <span class="entity">st</span>
          |&gt; <span class="entity">elim_implies</span> <span class="entity">thm</span>
        <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">else</span></span> 
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">R</span><span class="main">,</span><span class="entity">TP'</span><span class="main">)</span> <span class="main">=</span> Thm.dest_implies <span class="main">(</span>Thm.cprop_of <span class="entity">thm</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">TAG'</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=</span> Conjunction.dest_conjunction <span class="entity">TP'</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">inst</span> <span class="main">=</span> Thm.match <span class="main">(</span><span class="entity">TAG</span><span class="main">,</span> <span class="entity">TAG'</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">st</span> <span class="main">=</span> Thm.instantiate <span class="entity">inst</span> <span class="entity">st</span>
            |&gt; Conv.fconv_rule <span class="main">(</span>Thm.beta_conversion true<span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">P</span> <span class="main">=</span> Thm.instantiate_cterm <span class="entity">inst</span> <span class="entity">P</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Q</span> <span class="main">=</span> Thm.instantiate_cterm <span class="entity">inst</span> <span class="entity">Q</span>
        <span class="keyword2"><span class="keyword">in</span></span> 
          <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> retrofit_with_prems<span class="antiquote">}</span></span></span>
          |&gt; Thm.instantiate' <span class="main">[</span><span class="main">]</span> <span class="main">[</span>SOME <span class="entity">P</span><span class="main">,</span> SOME <span class="entity">Q</span><span class="main">,</span> SOME <span class="entity">R</span><span class="main">,</span> SOME <span class="entity">TAG'</span><span class="main">]</span>
          |&gt; Conv.fconv_rule <span class="main">(</span>Thm.beta_conversion true<span class="main">)</span>
          |&gt; <span class="entity">elim_implies</span> <span class="entity">st</span>
          |&gt; <span class="entity">elim_implies</span> <span class="entity">thm</span>
          |&gt; Conjunction.curry_balanced <span class="entity">n</span>
        <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword2"><span class="keyword">in</span></span>
    Seq.map <span class="entity">retrofit</span> <span class="entity">seq</span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">AS_FIRSTGOAL</span> <span class="entity">tac</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> 
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &lt;= Thm.nprems_of <span class="entity">st</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="main">(</span>PRIMITIVE <span class="main">(</span>Thm.permute_prems <span class="inner_numeral">0</span> <span class="main">(</span><span class="entity">i</span>-<span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span> 
      THEN <span class="entity">tac</span> 
      THEN PRIMITIVE <span class="main">(</span>Thm.permute_prems <span class="inner_numeral">0</span> <span class="main">(</span><span class="inner_numeral">1</span>-<span class="entity">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">st</span>
    <span class="keyword2"><span class="keyword">else</span></span> Seq.empty

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">REPEAT_SOLVE_FWD_SELECT</span> <span class="entity">ctxt</span> <span class="entity">bias</span> <span class="entity">tac</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">BIASED_SELECT</span> <span class="entity">tac</span> <span class="entity">st</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">if</span></span> Thm.nprems_of <span class="entity">st</span> &lt; <span class="inner_numeral">2</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">tac</span> <span class="entity">st</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">s</span> <span class="main">=</span> Drule.size_of_thm <span class="entity">st</span>
        <span class="comment1">(*val _ = if s&gt;100 then string_of_int s |&gt; tracing else ()*)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">s</span> &lt; <span class="entity">bias</span> <span class="keyword2"><span class="keyword">then</span></span> 
          <span class="entity">tac</span> <span class="entity">st</span> 
        <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">s1</span> <span class="main">=</span> Logic.dest_implies <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> |&gt; <span class="main">#</span><span class="inner_numeral">1</span> |&gt; size_of_term
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="inner_numeral">5</span> * <span class="entity">s1</span> &lt; <span class="inner_numeral">2</span> * <span class="entity">s</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="entity">SELECT_FIRST</span> <span class="entity">ctxt</span> <span class="entity">tac</span> <span class="entity">st</span>
          <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">tac</span> <span class="entity">st</span>
        <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">end</span></span>


    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sg_rec</span> <span class="entity">st</span> <span class="main">=</span> IF_UNSOLVED <span class="main">(</span><span class="entity">BIASED_SELECT</span> <span class="main">(</span>
        <span class="entity">PREFER_SOLVED</span> <span class="main">(</span>
          <span class="entity">TRY_SOLVE_ALL_NEW_FWD</span> <span class="main">(</span><span class="entity">tac</span> <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">sg_rec</span> all_tac
        <span class="main">)</span>
      <span class="main">)</span><span class="main">)</span> <span class="entity">st</span>

  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">AS_FIRSTGOAL</span> <span class="entity">sg_rec</span>
  <span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Mk_Record_Simp">
<div class="head">
<h1>Theory Mk_Record_Simp</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Mk_Record_Simp
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Refine_Util.html">Refine_Util</a> <a href="Mpat_Antiquot.html">Mpat_Antiquot</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*
  mk_record_simp: Converts a lemma of the form 
    "f s = x" to the form "r ≡ s ⟹ f r = x"
  
  This is used to fold the x.simp - lemmas of a record x with a definition
  of the form "r ≡ ⦇ ... ⦈".

  Usage example:
    record foo = ...
    definition c :: foo where "c ≡ ⦇ ... ⦈"
    lemmas c_simps[simp] = foo.simps[mk_record_simp, OF c_def]
*)</span>
<span class="keyword1" id="Mk_Record_Simp-mk_record_simp_thm"><span class="command">lemma</span></span> mk_record_simp_thm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">s</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≡</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">r</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_record_simp</span> <span class="entity">context</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Context.proof_of <span class="entity">context</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cert</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">case</span></span> Thm.concl_of <span class="entity">thm</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span><span class="var">?f</span> <span class="main">_</span><span class="main">=</span><span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span> <span class="main">=&gt;</span> 
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cf</span> <span class="main">=</span> <span class="entity">cert</span> <span class="entity">f</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">r</span> <span class="main">=</span> infer_instantiate <span class="entity">ctxt</span> <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="inner_quoted">"f"</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span> <span class="entity">cf</span><span class="main">)</span><span class="main">]</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> mk_record_simp_thm<span class="antiquote">}</span></span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">r</span> <span class="main">=</span> <span class="entity">r</span> OF <span class="main">[</span><span class="entity">thm</span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">r</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> THM<span class="main">(</span><span class="inner_quoted">""</span><span class="main">,</span><span class="inner_numeral">~1</span><span class="main">,</span><span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">attribute_setup</span></span> mk_record_simp <span class="main">=</span> 
  <span class="quoted">‹Scan.succeed <span class="main">(</span>Thm.rule_attribute <span class="main">[</span><span class="main">]</span> <span class="main">(</span><span class="entity">mk_record_simp</span><span class="main">)</span><span class="main">)</span>›</span>
  <span class="quoted">"Make simplification rule for record definition"</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Refine_Lib">
<div class="head">
<h1>Theory Refine_Lib</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Refine_Lib
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="Refine_Util.html">Refine_Util</a> 
  <a href="Attr_Comb.html">Attr_Comb</a> 
  <a href="Named_Sorted_Thms.html">Named_Sorted_Thms</a> 
  <a href="Prio_List.html">Prio_List</a> 
  <a href="Mpat_Antiquot.html">Mpat_Antiquot</a>
  <a href="Mk_Term_Antiquot.html">Mk_Term_Antiquot</a>
  <a href="Tagged_Solver.html">Tagged_Solver</a>
  <a href="Anti_Unification.html">Anti_Unification</a>
  <a href="Misc.html">Misc</a>
  <a href="Foldi.html">Foldi</a>
  <a href="Indep_Vars.html">Indep_Vars</a>
  <a href="Select_Solve.html">Select_Solve</a>
  <a href="Mk_Record_Simp.html">Mk_Record_Simp</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹Cond_Rewr_Conv.ML›</span>
  <span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹Revert_Abbrev.ML›</span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/Cond_Rewr_Conv.ML">
<div class="head">
<h1>File ‹Cond_Rewr_Conv.ML›</h1>
</div>
<pre class="source"><span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">COND_REWR_CONV</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> cond_rewr_conv<span class="main">:</span> tactic <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv
  <span class="keyword1"><span class="keyword">val</span></span> cond_rewrs_conv<span class="main">:</span> tactic <span class="main">-&gt;</span> thm list <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Cond_Rewr_Conv</span> <span class="main">:</span><span class="entity">COND_REWR_CONV</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
  <span class="keyword3"><span class="keyword">open</span></span> Refine_Util
  <span class="comment1">(* Conditional rewrite rule. tac used to discharge conditions *)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cond_rewr_conv_aux</span> <span class="entity">tac</span> <span class="entity">thm</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lhs</span> <span class="main">=</span> <span class="entity">thm</span> |&gt; Thm.concl_of |&gt; Logic.dest_equals |&gt; <span class="main">#</span><span class="inner_numeral">1</span> |&gt; Thm.cterm_of <span class="entity">ctxt</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">inst</span> <span class="main">=</span> Thm.match <span class="main">(</span><span class="entity">lhs</span><span class="main">,</span><span class="entity">ct</span><span class="main">)</span> 
      <span class="keyword3"><span class="keyword">handle</span></span> Pattern.MATCH <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> CTERM <span class="main">(</span><span class="inner_quoted">"dis_rewr_conv: MATCH"</span><span class="main">,</span><span class="main">[</span><span class="entity">lhs</span><span class="main">,</span><span class="entity">ct</span><span class="main">]</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm'</span> <span class="main">=</span> Thm.instantiate <span class="entity">inst</span> <span class="entity">thm</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">dprems</span> <span class="main">=</span> Thm.prems_of <span class="entity">thm'</span> 
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">dthms</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> 
      <span class="main">(</span>Goal.prove <span class="entity">ctxt</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="entity">t</span> <span class="main">(</span>K <span class="entity">tac</span><span class="main">)</span><span class="main">)</span> <span class="keyword3"><span class="keyword">handle</span></span> ERROR <span class="entity">s</span> 
        <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dis_rew_conv: "</span>^ <span class="entity">s</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="entity">dprems</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="entity">thm'</span> OF <span class="entity">dthms</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">res</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cond_rewr_conv</span> <span class="entity">tac</span> <span class="entity">thm</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">fix_conv</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">cond_rewr_conv_aux</span> <span class="entity">tac</span> <span class="entity">thm</span> <span class="entity">ctxt</span><span class="main">)</span>

  <span class="comment1">(*fun first_conv [] ct = Conv.no_conv ct
    | first_conv (cv::cvs) ct = (cv else_conv first_conv cvs) ct*)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cond_rewrs_conv</span> <span class="entity">tac</span> <span class="entity">thms</span> <span class="entity">ctxt</span> <span class="main">=</span> 
    Conv.first_conv <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">cond_rewr_conv</span> <span class="entity">tac</span> <span class="entity">thm</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">thms</span><span class="main">)</span> 

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/Revert_Abbrev.ML">
<div class="head">
<h1>File ‹Revert_Abbrev.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*
  Revert abbreviations.
 TODO: This is only a hack, a clean solution would somehow dock to the
   locale mechanism, and thus automatically consider new interpretations and
   extensions of the locale
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">REVERT_ABBREV</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> revert_abbrev_matching<span class="main">:</span> <span class="main">(</span>string <span class="main">-&gt;</span> bool<span class="main">)</span> <span class="main">-&gt;</span> theory <span class="main">-&gt;</span> theory
  <span class="keyword1"><span class="keyword">val</span></span> revert_abbrev<span class="main">:</span> string <span class="main">-&gt;</span> theory <span class="main">-&gt;</span> theory
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Revert_Abbrev</span> <span class="main">:</span><span class="entity">REVERT_ABBREV</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">match_string'</span> <span class="entity">pat</span> <span class="entity">str</span> <span class="main">=</span> match_string <span class="main">(</span><span class="inner_quoted">"^"</span>^<span class="entity">pat</span>^<span class="inner_quoted">"$"</span><span class="main">)</span> <span class="main">(</span><span class="inner_quoted">"^"</span>^<span class="entity">str</span>^<span class="inner_quoted">"$"</span><span class="main">)</span>

  <span class="comment1">(* Revert all abbreviations whose name matches the given matcher *)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">revert_abbrev_matching</span> <span class="entity">match_fun</span> <span class="entity">thy</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Proof_Context.init_global <span class="entity">thy</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span><span class="entity">const_space</span><span class="main">,</span> <span class="entity">constants</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> Sign.consts_of <span class="entity">thy</span> |&gt; Consts.dest<span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">names</span> <span class="main">=</span>
    Name_Space.extern_entries true <span class="entity">ctxt</span> <span class="entity">const_space</span> <span class="entity">constants</span>
    |&gt; map_filter <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> 
        <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> SOME <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">match_fun</span> <span class="entity">name</span> <span class="keyword2"><span class="keyword">then</span></span> SOME <span class="entity">name</span> <span class="keyword2"><span class="keyword">else</span></span> NONE
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> NONE<span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> null <span class="entity">names</span> <span class="keyword2"><span class="keyword">then</span></span> 
      warning <span class="main">(</span><span class="inner_quoted">"revert_abbrevs: No matching constants"</span><span class="main">)</span> 
    <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span> fold <span class="main">(</span>Sign.revert_abbrev <span class="inner_quoted">""</span><span class="main">)</span> <span class="entity">names</span> <span class="entity">thy</span> <span class="keyword2"><span class="keyword">end</span></span>

  <span class="comment1">(* Revert abbreviations matching anchored glob-pattern *)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">revert_abbrev</span> <span class="entity">pat</span> <span class="main">=</span> <span class="entity">revert_abbrev_matching</span> <span class="main">(</span><span class="entity">match_string'</span> <span class="entity">pat</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Param_Chapter">
<div class="head">
<h1>Theory Param_Chapter</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Parametricity Solver›</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Param_Chapter <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Relators">
<div class="head">
<h1>Theory Relators</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Relators›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Relators
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Refine_Lib.html">../Lib/Refine_Lib</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We define the concept of relators. The relation between a concrete type and
  an abstract type is expressed by a relation of type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>('c×'a) set›</span></span></span></span>.
  For each composed type, say <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'a list›</span></span></span></span>, we can define a {\em relator},
  that takes as argument a relation for the element type, and returns a relation
  for the list type. For most datatypes, there exists a {\em natural relator}.
  For algebraic datatypes, this is the relator that preserves the structure
  of the datatype, and changes the components. For example, 
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>list_rel::('c×'a) set ⇒ ('c list×'a list) set›</span></span></span></span> is the natural 
  relator for lists. 

  However, relators can also be used to change the representation, and thus 
  relate an implementation with an abstract type. For example, the relator
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>list_set_rel::('c×'a) set ⇒ ('c list×'a set) set›</span></span></span></span> relates lists
  with the set of their elements.

  In this theory, we define some basic notions for relators, and
  then define natural relators for all HOL-types, including the function type.
  For each relator, we also show a single-valuedness property, and initialize a
  solver for single-valued properties.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic Definitions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  For smoother handling of relator unification, we require relator arguments to
  be applied by a special operator, such that we avoid higher-order 
  unification problems. We try to set up some syntax to make this more 
  transparent, and give relators a type-like prefix-syntax.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">relAPP</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'c1</span><span class="main">×</span><span class="tfree">'a1</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c1</span><span class="main">×</span><span class="tfree">'a1</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">_</span>"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">relAPP</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_rel_APP"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">⟩</span>_"</span> <span class="main">[</span>0<span class="main">,</span>900<span class="main">]</span> 900<span class="main">)</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">⟨</span><span class="free">x</span><span class="main">,</span><span class="free">xs</span><span class="main">⟩</span><span class="free">R</span>"</span> <span class="main">==</span> <span class="quoted">"<span class="main">⟨</span><span class="free">xs</span><span class="main">⟩</span><span class="main">(</span><span class="keyword1">CONST</span> relAPP <span class="free">R</span> <span class="free">x</span><span class="main">)</span>"</span>
  <span class="quoted">"<span class="main">⟨</span><span class="free">x</span><span class="main">⟩</span><span class="free">R</span>"</span> <span class="main">==</span> <span class="quoted">"<span class="keyword1">CONST</span> relAPP <span class="free">R</span> <span class="free">x</span>"</span>


<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Refine_Relators_Thms</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">rel_comb_def_rules</span> <span class="main">=</span> <span class="entity">Named_Thms</span> <span class="main">(</span> 
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> refine_rel_defs<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Refinement Framework: "</span> ^
          <span class="inner_quoted">"Relator definitions"</span> 
    <span class="main">)</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="entity">Refine_Relators_Thms.rel_comb_def_rules.setup</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic HOL Relators›</span></span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Function›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fun_rel</span> <span class="keyword2"><span class="keyword">where</span></span> 
  fun_rel_def_internal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fun_rel</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">f'</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">f'</span> <span class="bound">a'</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fun_rel_syn</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">→</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main"><span class="free">→</span></span><span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⟩</span>fun_rel"</span></span>

<span class="keyword1" id="Relators-fun_rel_def"><span class="command">lemma</span></span> fun_rel_def<span class="main">[</span><span class="operator">refine_rel_defs</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">→</span><span class="free">B</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">f'</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">f'</span> <span class="bound">a'</span><span class="main">)</span><span class="main">∈</span><span class="free">B</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> relAPP_def fun_rel_def_internal<span class="main">)</span>

<span class="keyword1" id="Relators-fun_relI"><span class="command">lemma</span></span> fun_relI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">a'</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">,</span><span class="free">f'</span> <span class="bound">a'</span><span class="main">)</span><span class="main">∈</span><span class="free">B</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">f'</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span><span class="main">→</span><span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-fun_relD"><span class="command">lemma</span></span> fun_relD<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">f'</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">A</span><span class="main">→</span><span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-fun_relD1"><span class="command">lemma</span></span> fun_relD1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">f'</span><span class="main">)</span><span class="main">∈</span><span class="free">Ra</span><span class="main">→</span><span class="free">Rr</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">Ra</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rr</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-fun_relD2"><span class="command">lemma</span></span> fun_relD2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">f'</span><span class="main">)</span><span class="main">∈</span><span class="free">Ra</span><span class="main">→</span><span class="free">Rr</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="free">x'</span> <span class="main">=</span> <span class="free">r'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">Ra</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span><span class="free">r'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rr</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-fun_relE1"><span class="command">lemma</span></span> fun_relE1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">f'</span><span class="main">)</span><span class="main">∈</span>Id <span class="main">→</span> <span class="free">Rv</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">=</span> <span class="free">f'</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">,</span><span class="free">t'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rv</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>

<span class="keyword1" id="Relators-fun_relE2"><span class="command">lemma</span></span> fun_relE2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">f'</span><span class="main">)</span><span class="main">∈</span>Id <span class="main">→</span> <span class="free">Rv</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">f'</span> <span class="free">x</span><span class="main">)</span><span class="main">∈</span><span class="free">Rv</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Terminal Types›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">unit_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>unit<span class="main">×</span>unit<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">unit_rel</span> <span class="main">==</span> Id"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">nat_rel</span> <span class="main">≡</span> Id<span class="main">::</span><span class="main">(</span>nat<span class="main">×</span><span class="main">_</span><span class="main">)</span> set"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">int_rel</span> <span class="main">≡</span> Id<span class="main">::</span><span class="main">(</span>int<span class="main">×</span><span class="main">_</span><span class="main">)</span> set"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">bool_rel</span> <span class="main">≡</span> Id<span class="main">::</span><span class="main">(</span>bool<span class="main">×</span><span class="main">_</span><span class="main">)</span> set"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Product›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prod_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  prod_rel_def_internal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prod_rel</span> <span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="free"><span class="bound"><span class="entity">R2</span></span></span> 
    <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">b'</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R1</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">b'</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R2</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">prod_rel_syn</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="keyword1"><span class="free">×<span class="hidden">⇩</span><sub>r</sub></span></span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">⟩</span>prod_rel"</span></span> 

<span class="keyword1" id="Relators-prod_rel_def"><span class="command">lemma</span></span> prod_rel_def<span class="main">[</span><span class="operator">refine_rel_defs</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="free">R1</span><span class="main">,</span><span class="free">R2</span><span class="main">⟩</span>prod_rel<span class="main">)</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">b'</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span><span class="main">∈</span><span class="free">R1</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">b'</span><span class="main">)</span><span class="main">∈</span><span class="free">R2</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_rel_def_internal relAPP_def<span class="main">)</span>

<span class="keyword1" id="Relators-prod_relI"><span class="command">lemma</span></span> prod_relI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">a'</span><span class="main">)</span><span class="main">∈</span><span class="free">R1</span><span class="main">;</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">b'</span><span class="main">)</span><span class="main">∈</span><span class="free">R2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">a'</span><span class="main">,</span><span class="free">b'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R1</span><span class="main">,</span><span class="free">R2</span><span class="main">⟩</span>prod_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_rel_def<span class="main">)</span>
<span class="keyword1" id="Relators-prod_relE"><span class="command">lemma</span></span> prod_relE<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">p'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R1</span><span class="main">,</span><span class="free">R2</span><span class="main">⟩</span>prod_rel"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="free">b</span> <span class="free">a'</span> <span class="free">b'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span><span class="main">=</span><span class="main">(</span><span class="free">a'</span><span class="main">,</span><span class="free">b'</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">a'</span><span class="main">)</span><span class="main">∈</span><span class="free">R1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">b'</span><span class="main">)</span><span class="main">∈</span><span class="free">R2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-prod_rel_simp"><span class="command">lemma</span></span> prod_rel_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">a'</span><span class="main">,</span><span class="free">b'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R1</span><span class="main">,</span><span class="free">R2</span><span class="main">⟩</span>prod_rel <span class="main">⟷</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">a'</span><span class="main">)</span><span class="main">∈</span><span class="free">R1</span> <span class="main">∧</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">b'</span><span class="main">)</span><span class="main">∈</span><span class="free">R2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prod_relI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> prod_relE<span class="main">)</span>

<span class="keyword1" id="Relators-in_Domain_prod_rel_iff"><span class="command">lemma</span></span> in_Domain_prod_rel_iff<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span>Domain <span class="main">(</span><span class="free">A</span><span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span><span class="free">B</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">a</span><span class="main">∈</span>Domain <span class="free">A</span> <span class="main">∧</span> <span class="free">b</span><span class="main">∈</span>Domain <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-prod_rel_comp"><span class="command">lemma</span></span> prod_rel_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">B</span><span class="main">)</span> <span class="keyword1">O</span> <span class="main">(</span><span class="free">C</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">O</span> <span class="free">C</span><span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">O</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prod_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Option›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">option_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  option_rel_def_internal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">option_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span>Some <span class="bound">a</span><span class="main">,</span>Some <span class="bound">a'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">a</span> <span class="bound">a'</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span>None<span class="main">,</span>None<span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Relators-option_rel_def"><span class="command">lemma</span></span> option_rel_def<span class="main">[</span><span class="operator">refine_rel_defs</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span>Some <span class="bound">a</span><span class="main">,</span>Some <span class="bound">a'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">a</span> <span class="bound">a'</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span>None<span class="main">,</span>None<span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option_rel_def_internal relAPP_def<span class="main">)</span>

<span class="keyword1" id="Relators-option_relI"><span class="command">lemma</span></span> option_relI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>None<span class="main">,</span>None<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span> option_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">a'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>Some <span class="free">a</span><span class="main">,</span> Some <span class="free">a'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-option_relE"><span class="command">lemma</span></span> option_relE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span>None"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x'</span><span class="main">=</span>None"</span></span>
  <span class="main">|</span> <span class="free">a</span> <span class="free">a'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span>Some <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x'</span><span class="main">=</span>Some <span class="free">a'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">a'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-option_rel_simp"><span class="command">lemma</span></span> option_rel_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>None<span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel <span class="main">⟷</span> <span class="free">a</span><span class="main">=</span>None"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span>None<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel <span class="main">⟷</span> <span class="free">c</span><span class="main">=</span>None"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="free">x</span><span class="main">,</span>Some <span class="free">y</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> option_relI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> option_relE<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Sum›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sum_rel</span> <span class="keyword2"><span class="keyword">where</span></span> sum_rel_def_internal<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">sum_rel</span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span> <span class="free"><span class="bound"><span class="entity">Rr</span></span></span> 
   <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span>Inl <span class="bound">a</span><span class="main">,</span> Inl <span class="bound">a'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">a</span> <span class="bound">a'</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Rl</span></span></span> <span class="main">}</span> <span class="main">∪</span>
     <span class="main">{</span> <span class="main">(</span>Inr <span class="bound">a</span><span class="main">,</span> Inr <span class="bound">a'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">a</span> <span class="bound">a'</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Rr</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="Relators-sum_rel_def"><span class="command">lemma</span></span> sum_rel_def<span class="main">[</span><span class="operator">refine_rel_defs</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel <span class="main">≡</span> 
     <span class="main">{</span> <span class="main">(</span>Inl <span class="bound">a</span><span class="main">,</span> Inl <span class="bound">a'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">a</span> <span class="bound">a'</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rl</span> <span class="main">}</span> <span class="main">∪</span>
     <span class="main">{</span> <span class="main">(</span>Inr <span class="bound">a</span><span class="main">,</span> Inr <span class="bound">a'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">a</span> <span class="bound">a'</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rr</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_rel_def_internal relAPP_def<span class="main">)</span>

<span class="keyword1" id="Relators-sum_rel_simp"><span class="command">lemma</span></span> sum_rel_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">a'</span><span class="main">.</span> <span class="main">(</span>Inl <span class="bound">a</span><span class="main">,</span> Inl <span class="bound">a'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel <span class="main">⟷</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rl</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">a'</span><span class="main">.</span> <span class="main">(</span>Inr <span class="bound">a</span><span class="main">,</span> Inr <span class="bound">a'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel <span class="main">⟷</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rr</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">a'</span><span class="main">.</span> <span class="main">(</span>Inl <span class="bound">a</span><span class="main">,</span> Inr <span class="bound">a'</span><span class="main">)</span> <span class="main">∉</span> <span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">a'</span><span class="main">.</span> <span class="main">(</span>Inr <span class="bound">a</span><span class="main">,</span> Inl <span class="bound">a'</span><span class="main">)</span> <span class="main">∉</span> <span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sum_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relators-sum_relI"><span class="command">lemma</span></span> sum_relI<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">l'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rl</span> <span class="main">⟹</span> <span class="main">(</span>Inl <span class="free">l</span><span class="main">,</span> Inl <span class="free">l'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">r'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rr</span> <span class="main">⟹</span> <span class="main">(</span>Inr <span class="free">r</span><span class="main">,</span> Inr <span class="free">r'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  
<span class="keyword1" id="Relators-sum_relE"><span class="command">lemma</span></span> sum_relE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> 
    <span class="free">l</span> <span class="free">l'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span>Inl <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x'</span><span class="main">=</span>Inl <span class="free">l'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">l'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rl</span>"</span></span>
  <span class="main">|</span> <span class="free">r</span> <span class="free">r'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span>Inr <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x'</span><span class="main">=</span>Inr <span class="free">r'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">r'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rr</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_rel_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lists›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_rel</span> <span class="keyword2"><span class="keyword">where</span></span> list_rel_def_internal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">list_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">l'</span><span class="main">)</span><span class="main">.</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="bound">l</span> <span class="bound">l'</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Relators-list_rel_def"><span class="command">lemma</span></span> list_rel_def<span class="main">[</span><span class="operator">refine_rel_defs</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">l'</span><span class="main">)</span><span class="main">.</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span> <span class="bound">l</span> <span class="bound">l'</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_rel_def_internal relAPP_def<span class="main">)</span>

<span class="keyword1" id="Relators-list_rel_induct"><span class="command">lemma</span></span> list_rel_induct<span class="main">[</span><span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Nil Cons<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">l'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span> list_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span> <span class="bound">l</span> <span class="bound">l'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">l'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel<span class="main">;</span> <span class="free">P</span> <span class="bound">l</span> <span class="bound">l'</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span><span class="main">#</span><span class="bound">l</span><span class="main">)</span> <span class="main">(</span><span class="bound">x'</span><span class="main">#</span><span class="bound">l'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">l</span> <span class="free">l'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> list_rel_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> list_all2_induct<span class="main">)</span>

<span class="keyword1" id="Relators-list_rel_eq_listrel"><span class="command">lemma</span></span> list_rel_eq_listrel<span class="main">:</span> <span class="quoted"><span class="quoted">"list_rel <span class="main">=</span> listrel"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">goal_cases</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_rel_def_internal
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all2_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> listrel.intros<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_def_internal<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Relators-list_relI"><span class="command">lemma</span></span> list_relI<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">l'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">l</span><span class="main">,</span><span class="free">x'</span><span class="main">#</span><span class="free">l'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-list_rel_simp"><span class="command">lemma</span></span> list_rel_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">l'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">⟷</span> <span class="free">l'</span><span class="main">=</span><span class="main">[]</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">⟷</span> <span class="free">l</span><span class="main">=</span><span class="main">[]</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">l</span><span class="main">,</span><span class="free">x'</span><span class="main">#</span><span class="free">l'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">l'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-list_relE1"><span class="command">lemma</span></span> list_relE1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">=</span><span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relators-list_relE2"><span class="command">lemma</span></span> list_relE2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">l</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">=</span><span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relators-list_relE3"><span class="command">lemma</span></span> list_relE3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">,</span><span class="free">l'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x'</span> <span class="free">xs'</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">l'</span><span class="main">=</span><span class="free">x'</span><span class="main">#</span><span class="free">xs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span><span class="free">xs'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Relators-list_relE4"><span class="command">lemma</span></span> list_relE4<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">x'</span><span class="main">#</span><span class="free">xs'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span> <span class="free">xs</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">=</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span><span class="free">xs'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> list_relE <span class="main">=</span> list_relE1 list_relE2 list_relE3 list_relE4

<span class="keyword1" id="Relators-list_rel_imp_same_length"><span class="command">lemma</span></span> list_rel_imp_same_length<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">l'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">⟹</span> length <span class="free">l</span> <span class="main">=</span> length <span class="free">l'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> list_rel_eq_listrel relAPP_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> listrel_eq_len<span class="main">)</span>

<span class="keyword1" id="Relators-list_rel_split_right_iff"><span class="command">lemma</span></span> list_rel_split_right_iff<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">,</span><span class="free">l</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">l</span><span class="main">=</span><span class="bound">y</span><span class="main">#</span><span class="bound">ys</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span><span class="bound">ys</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="Relators-list_rel_split_left_iff"><span class="command">lemma</span></span> list_rel_split_left_iff<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">y</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="free">l</span><span class="main">=</span><span class="bound">x</span><span class="main">#</span><span class="bound">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="free">ys</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>
    
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Sets›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pointwise refinement: The abstract set is the image of
  the concrete set, and the concrete set only contains elements that
  have an abstract counterpart›</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">set_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  set_rel_def_internal<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">set_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span><span class="bound">B</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="bound">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">∈</span><span class="bound">B</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">B</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>
  
<span class="keyword1"><span class="command">term</span></span> <span class="quoted">set_rel</span>    
    
<span class="keyword1" id="Relators-set_rel_def"><span class="command">lemma</span></span> set_rel_def<span class="main">[</span><span class="operator">refine_rel_defs</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span><span class="bound">B</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="bound">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">∈</span><span class="bound">B</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="bound">B</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_rel_def_internal relAPP_def<span class="main">)</span>
    
<span class="keyword1" id="Relators-set_rel_alt"><span class="command">lemma</span></span> set_rel_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span><span class="bound">B</span><span class="main">)</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="free">R</span><span class="main">¯</span><span class="main">``</span><span class="bound">B</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">⊆</span> <span class="free">R</span><span class="main">``</span><span class="bound">A</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    
    
<span class="keyword1" id="Relators-set_relI"><span class="command">lemma</span></span> set_relI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">y</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span><span class="main">∈</span><span class="free">B</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel"</span></span>  
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> set_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Original definition of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>set_rel›</span></span></span></span> in refinement framework. 
  Abandoned in favour of more symmetric definition above: ›</span></span>    
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">old_set_rel</span> <span class="keyword2"><span class="keyword">where</span></span> old_set_rel_def_internal<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">old_set_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span><span class="bound">S'</span><span class="main">)</span><span class="main">.</span> <span class="bound">S'</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">``</span><span class="bound">S</span> <span class="main">∧</span> <span class="bound">S</span><span class="main">⊆</span>Domain <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Relators-old_set_rel_def"><span class="command">lemma</span></span> old_set_rel_def<span class="main">[</span><span class="operator">refine_rel_defs</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>old_set_rel <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span><span class="bound">S'</span><span class="main">)</span><span class="main">.</span> <span class="bound">S'</span><span class="main">=</span><span class="free">R</span><span class="main">``</span><span class="bound">S</span> <span class="main">∧</span> <span class="bound">S</span><span class="main">⊆</span>Domain <span class="free">R</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> old_set_rel_def_internal relAPP_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Old definition coincides with new definition for single-valued 
  element relations. This is probably the reason why the old definition worked 
  for most applications.›</span></span>
<span class="keyword1" id="Relators-old_set_rel_sv_eq"><span class="command">lemma</span></span> old_set_rel_sv_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="free">R</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>old_set_rel <span class="main">=</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_rel_def old_set_rel_def single_valued_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  

<span class="keyword1" id="Relators-set_rel_simp"><span class="command">lemma</span></span> set_rel_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-set_rel_empty_iff"><span class="command">lemma</span></span> set_rel_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>set_rel <span class="main">⟷</span> <span class="free">y</span><span class="main">=</span><span class="main">{}</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>set_rel <span class="main">⟷</span> <span class="free">x</span><span class="main">=</span><span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_rel_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    
    
<span class="keyword1" id="Relators-set_relD1"><span class="command">lemma</span></span> set_relD1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span><span class="free">s</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x'</span><span class="main">∈</span><span class="free">s'</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Relators-set_relD2"><span class="command">lemma</span></span> set_relD2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel <span class="main">⟹</span> <span class="free">x'</span><span class="main">∈</span><span class="free">s'</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Relators-set_relE1"><span class="command">lemma</span></span> set_relE1<span class="main">[</span><span class="operator">consumes</span> 2<span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x'</span><span class="main">∈</span><span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> set_relD1<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Relators-set_relE2"><span class="command">lemma</span></span> set_relE2<span class="main">[</span><span class="operator">consumes</span> 2<span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x'</span><span class="main">∈</span><span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> set_relD2<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Automation›</span></span> 
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹A solver for relator properties›</span></span>
<span class="keyword1" id="Relators-relprop_triggers"><span class="command">lemma</span></span> relprop_triggers<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">R</span><span class="main">.</span> single_valued <span class="bound">R</span> <span class="main">⟹</span> single_valued <span class="bound">R</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">R</span><span class="main">.</span> <span class="bound">R</span><span class="main">=</span>Id <span class="main">⟹</span> <span class="bound">R</span><span class="main">=</span>Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">R</span><span class="main">.</span> <span class="bound">R</span><span class="main">=</span>Id <span class="main">⟹</span> Id<span class="main">=</span><span class="bound">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">R</span><span class="main">.</span> Range <span class="bound">R</span> <span class="main">=</span> UNIV <span class="main">⟹</span> Range <span class="bound">R</span> <span class="main">=</span> UNIV"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">R</span><span class="main">.</span> Range <span class="bound">R</span> <span class="main">=</span> UNIV <span class="main">⟹</span> UNIV <span class="main">=</span> Range <span class="bound">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">R</span> <span class="bound">R'</span><span class="main">.</span> <span class="bound">R</span><span class="main">⊆</span><span class="bound">R'</span> <span class="main">⟹</span> <span class="bound">R</span><span class="main">⊆</span><span class="bound">R'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">relator_props</span> <span class="main">=</span> <span class="entity">Named_Thms</span> <span class="main">(</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> relator_props<span class="antiquote">}</span></span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Additional relator properties"</span>
  <span class="main">)</span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">solve_relator_props</span> <span class="main">=</span> <span class="entity">Named_Thms</span> <span class="main">(</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> solve_relator_props<span class="antiquote">}</span></span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Relator properties that solve goal"</span>
  <span class="main">)</span>

›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="entity">relator_props.setup</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="entity">solve_relator_props.setup</span>

<span class="keyword1"><span class="command">declaration</span></span> <span class="quoted">‹
  <span class="entity">Tagged_Solver.declare_solver</span> 
    <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> relprop_triggers<span class="antiquote">}</span></span></span> 
    <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> relator_props_solver<span class="antiquote">}</span></span></span>
    <span class="inner_quoted">"Additional relator properties solver"</span>
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="main">(</span>REPEAT_ALL_NEW <span class="main">(</span>CHANGED o <span class="main">(</span>
      match_tac <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">solve_relator_props.get</span> <span class="entity">ctxt</span><span class="main">)</span> ORELSE'
      match_tac <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">relator_props.get</span> <span class="entity">ctxt</span><span class="main">)</span>
    <span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">declaration</span></span> <span class="quoted">‹
  <span class="entity">Tagged_Solver.declare_solver</span> 
    <span class="main">[</span><span class="main">]</span>
    <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> force_relator_props_solver<span class="antiquote">}</span></span></span>
    <span class="inner_quoted">"Additional relator properties solver (instantiate schematics)"</span>
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="main">(</span>REPEAT_ALL_NEW <span class="main">(</span>CHANGED o <span class="main">(</span>
      resolve_tac <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">solve_relator_props.get</span> <span class="entity">ctxt</span><span class="main">)</span> ORELSE'
      match_tac <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">relator_props.get</span> <span class="entity">ctxt</span><span class="main">)</span>
    <span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
›</span>

<span class="keyword1" id="Relators-relprop_id_orient"><span class="command">lemma</span></span> 
  relprop_id_orient<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">=</span>Id <span class="main">⟹</span> Id<span class="main">=</span><span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  relprop_eq_refl<span class="main">[</span><span class="operator">solve_relator_props</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relators-relprop_UNIV_orient"><span class="command">lemma</span></span> 
  relprop_UNIV_orient<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">=</span>UNIV <span class="main">⟹</span> UNIV<span class="main">=</span><span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ML-Level utilities›</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">RELATORS</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> mk_relT<span class="main">:</span> typ * typ <span class="main">-&gt;</span> typ
    <span class="keyword1"><span class="keyword">val</span></span> dest_relT<span class="main">:</span> typ <span class="main">-&gt;</span> typ * typ

    <span class="keyword1"><span class="keyword">val</span></span> mk_relAPP<span class="main">:</span> term <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term
    <span class="keyword1"><span class="keyword">val</span></span> list_relAPP<span class="main">:</span> term list <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term
    <span class="keyword1"><span class="keyword">val</span></span> strip_relAPP<span class="main">:</span> term <span class="main">-&gt;</span> term list * term 
    <span class="keyword1"><span class="keyword">val</span></span> mk_fun_rel<span class="main">:</span> term <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term

    <span class="keyword1"><span class="keyword">val</span></span> list_rel<span class="main">:</span> term list <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term

    <span class="keyword1"><span class="keyword">val</span></span> rel_absT<span class="main">:</span> term <span class="main">-&gt;</span> typ
    <span class="keyword1"><span class="keyword">val</span></span> rel_concT<span class="main">:</span> term <span class="main">-&gt;</span> typ

    <span class="keyword1"><span class="keyword">val</span></span> mk_prodrel<span class="main">:</span> term * term <span class="main">-&gt;</span> term
    <span class="keyword1"><span class="keyword">val</span></span> is_prodrel<span class="main">:</span> term <span class="main">-&gt;</span> bool
    <span class="keyword1"><span class="keyword">val</span></span> dest_prodrel<span class="main">:</span> term <span class="main">-&gt;</span> term * term

    <span class="keyword1"><span class="keyword">val</span></span> strip_prodrel_left<span class="main">:</span> term <span class="main">-&gt;</span> term list
    <span class="keyword1"><span class="keyword">val</span></span> list_prodrel_left<span class="main">:</span> term list <span class="main">-&gt;</span> term


    <span class="keyword1"><span class="keyword">val</span></span> declare_natural_relator<span class="main">:</span> 
      <span class="main">(</span>string*string<span class="main">)</span> <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
    <span class="keyword1"><span class="keyword">val</span></span> remove_natural_relator<span class="main">:</span> string <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
    <span class="keyword1"><span class="keyword">val</span></span> natural_relator_of<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> string <span class="main">-&gt;</span> string option

    <span class="keyword1"><span class="keyword">val</span></span> mk_natural_relator<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> term list <span class="main">-&gt;</span> string <span class="main">-&gt;</span> term option

    <span class="keyword1"><span class="keyword">val</span></span> setup<span class="main">:</span> theory <span class="main">-&gt;</span> theory
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Relators</span> <span class="main">:</span><span class="entity">RELATORS</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mk_relT</span> <span class="main">=</span> <span class="entity">HOLogic.mk_prodT</span> #&gt; <span class="entity">HOLogic.mk_setT</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_relT</span> <span class="main">(</span>Type <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">type_name</span> set<span class="antiquote">}</span></span><span class="main">,</span><span class="main">[</span>Type <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">type_name</span> prod<span class="antiquote">}</span></span><span class="main">,</span><span class="main">[</span><span class="entity">cT</span><span class="main">,</span><span class="entity">aT</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">=</span> <span class="main">(</span><span class="entity">cT</span><span class="main">,</span><span class="entity">aT</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">dest_relT</span> <span class="entity">ty</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TYPE <span class="main">(</span><span class="inner_quoted">"dest_relT"</span><span class="main">,</span><span class="main">[</span><span class="entity">ty</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_relAPP</span> <span class="entity">x</span> <span class="entity">f</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">xT</span> <span class="main">=</span> fastype_of <span class="entity">x</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fT</span> <span class="main">=</span> fastype_of <span class="entity">f</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rT</span> <span class="main">=</span> range_type <span class="entity">fT</span>
    <span class="keyword2"><span class="keyword">in</span></span> 
      Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> relAPP<span class="antiquote">}</span></span><span class="main">,</span><span class="entity">fT</span>--&gt;<span class="entity">xT</span>--&gt;<span class="entity">rT</span><span class="main">)</span>$<span class="entity">f</span>$<span class="entity">x</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">list_relAPP</span> <span class="main">=</span> fold <span class="entity">mk_relAPP</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">strip_relAPP</span> <span class="entity">R</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">aux</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="main">⟨</span><span class="var">?R</span><span class="main">⟩</span><span class="var">?S</span>"</span><span class="antiquote">}</span></span></span></span> <span class="entity">l</span> <span class="main">=</span> <span class="entity">aux</span> <span class="entity">S</span> <span class="main">(</span><span class="entity">R</span>::<span class="entity">l</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">aux</span> <span class="entity">R</span> <span class="entity">l</span> <span class="main">=</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">aux</span> <span class="entity">R</span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rel_absT</span> <span class="main">=</span> fastype_of #&gt; <span class="entity">HOLogic.dest_setT</span> #&gt; <span class="entity">HOLogic.dest_prodT</span> #&gt; snd
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rel_concT</span> <span class="main">=</span> fastype_of #&gt; <span class="entity">HOLogic.dest_setT</span> #&gt; <span class="entity">HOLogic.dest_prodT</span> #&gt; fst

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_fun_rel</span> <span class="entity">r1</span> <span class="entity">r2</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">r1T</span><span class="main">,</span><span class="entity">r2T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fastype_of <span class="entity">r1</span><span class="main">,</span>fastype_of <span class="entity">r2</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">c1T</span><span class="main">,</span><span class="entity">a1T</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_relT</span> <span class="entity">r1T</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">c2T</span><span class="main">,</span><span class="entity">a2T</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_relT</span> <span class="entity">r2T</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">cT</span><span class="main">,</span><span class="entity">aT</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">c1T</span> --&gt; <span class="entity">c2T</span><span class="main">,</span> <span class="entity">a1T</span> --&gt; <span class="entity">a2T</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rT</span> <span class="main">=</span> <span class="entity">mk_relT</span> <span class="main">(</span><span class="entity">cT</span><span class="main">,</span><span class="entity">aT</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span> 
      <span class="entity">list_relAPP</span> <span class="main">[</span><span class="entity">r1</span><span class="main">,</span><span class="entity">r2</span><span class="main">]</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> fun_rel<span class="antiquote">}</span></span><span class="main">,</span><span class="entity">r1T</span>--&gt;<span class="entity">r2T</span>--&gt;<span class="entity">rT</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">list_rel</span> <span class="main">=</span> fold_rev <span class="entity">mk_fun_rel</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_prodrel</span> <span class="main">(</span><span class="entity">A</span><span class="main">,</span><span class="entity">B</span><span class="main">)</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mk_term</span> <span class="quoted">"<span class="var">?A</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="var">?B</span>"</span><span class="antiquote">}</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_prodrel</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="main">_</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">_</span>"</span><span class="antiquote">}</span></span> <span class="main">=</span> true <span class="main">|</span> <span class="entity">is_prodrel</span> <span class="main">_</span> <span class="main">=</span> false
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_prodrel</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="var">?A</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="var">?B</span>"</span><span class="antiquote">}</span></span></span></span> <span class="main">=</span> <span class="main">(</span><span class="entity">A</span><span class="main">,</span><span class="entity">B</span><span class="main">)</span> <span class="main">|</span> <span class="entity">dest_prodrel</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM<span class="main">(</span><span class="inner_quoted">"dest_prodrel"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">strip_prodrel_left</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="var">?A</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="var">?B</span>"</span><span class="antiquote">}</span></span></span></span> <span class="main">=</span> <span class="entity">strip_prodrel_left</span> <span class="entity">A</span> @ <span class="main">[</span><span class="entity">B</span><span class="main">]</span>
      <span class="main">|</span> <span class="entity">strip_prodrel_left</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="main">(</span><span class="quasi_keyword">typs</span><span class="main">)</span> <span class="quoted">"unit_rel"</span><span class="antiquote">}</span></span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
      <span class="main">|</span> <span class="entity">strip_prodrel_left</span> <span class="entity">R</span> <span class="main">=</span> <span class="main">[</span><span class="entity">R</span><span class="main">]</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">list_prodrel_left</span> <span class="main">=</span> <span class="entity">Refine_Util.list_binop_left</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">unit_rel</span><span class="antiquote">}</span></span> <span class="entity">mk_prodrel</span>

    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">natural_relators</span> <span class="main">=</span> Generic_Data <span class="main">(</span>
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> string Symtab.table
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> Symtab.empty
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">merge</span> <span class="main">=</span> Symtab.join <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">cn</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">cn</span><span class="main">)</span>
    <span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">declare_natural_relator</span> <span class="entity">tcp</span> <span class="main">=</span>
      natural_relators.map <span class="main">(</span>Symtab.update <span class="entity">tcp</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">remove_natural_relator</span> <span class="entity">tname</span> <span class="main">=</span>
      natural_relators.map <span class="main">(</span>Symtab.delete_safe <span class="entity">tname</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">natural_relator_of</span> <span class="entity">ctxt</span> <span class="main">=</span>
      Symtab.lookup <span class="main">(</span>natural_relators.get <span class="main">(</span>Context.Proof <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>

    <span class="comment1">(* [R1,…,Rn] T is mapped to ⟨R1,…,Rn⟩ Trel *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_natural_relator</span> <span class="entity">ctxt</span> <span class="entity">args</span> <span class="entity">Tname</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">natural_relator_of</span> <span class="entity">ctxt</span> <span class="entity">Tname</span> <span class="keyword2"><span class="keyword">of</span></span>
        NONE <span class="main">=&gt;</span> NONE
      <span class="main">|</span> SOME <span class="entity">Cname</span> <span class="main">=&gt;</span> SOME <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">argsT</span> <span class="main">=</span> map fastype_of <span class="entity">args</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">cTs</span><span class="main">,</span> <span class="entity">aTs</span><span class="main">)</span> <span class="main">=</span> map <span class="entity">dest_relT</span> <span class="entity">argsT</span> |&gt; split_list
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">aT</span> <span class="main">=</span> Type <span class="main">(</span><span class="entity">Tname</span><span class="main">,</span><span class="entity">aTs</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cT</span> <span class="main">=</span> Type <span class="main">(</span><span class="entity">Tname</span><span class="main">,</span><span class="entity">cTs</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rT</span> <span class="main">=</span> <span class="entity">mk_relT</span> <span class="main">(</span><span class="entity">cT</span><span class="main">,</span><span class="entity">aT</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="entity">list_relAPP</span> <span class="entity">args</span> <span class="main">(</span>Const <span class="main">(</span><span class="entity">Cname</span><span class="main">,</span><span class="entity">argsT</span>---&gt;<span class="entity">rT</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> 
      <span class="entity">natural_relator_from_term</span> <span class="main">(</span><span class="entity">t</span> <span class="keyword1"><span class="keyword">as</span></span> Const <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">err</span> <span class="entity">msg</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="entity">msg</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>
  
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">argTs</span><span class="main">,</span><span class="entity">bodyT</span><span class="main">)</span> <span class="main">=</span> strip_type <span class="entity">T</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">conTs</span><span class="main">,</span><span class="entity">absTs</span><span class="main">)</span> <span class="main">=</span> <span class="entity">argTs</span> |&gt; map <span class="main">(</span><span class="entity">HOLogic.dest_setT</span> #&gt; <span class="entity">HOLogic.dest_prodT</span><span class="main">)</span> |&gt; split_list
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">bconT</span><span class="main">,</span><span class="entity">babsT</span><span class="main">)</span> <span class="main">=</span> <span class="entity">bodyT</span> |&gt; <span class="entity">HOLogic.dest_setT</span> |&gt; <span class="entity">HOLogic.dest_prodT</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">Tcon</span><span class="main">,</span><span class="entity">bconTs</span><span class="main">)</span> <span class="main">=</span> dest_Type <span class="entity">bconT</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">Tcon'</span><span class="main">,</span><span class="entity">babsTs</span><span class="main">)</span> <span class="main">=</span> dest_Type <span class="entity">babsT</span>
  
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">Tcon</span> <span class="main">=</span> <span class="entity">Tcon'</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">err</span> <span class="inner_quoted">"Type constructors do not match"</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">conTs</span> <span class="main">=</span> <span class="entity">bconTs</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">err</span> <span class="inner_quoted">"Concrete types do not match"</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">absTs</span> <span class="main">=</span> <span class="entity">babsTs</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">err</span> <span class="inner_quoted">"Abstract types do not match"</span>

      <span class="keyword2"><span class="keyword">in</span></span> 
        <span class="main">(</span><span class="entity">Tcon</span><span class="main">,</span><span class="entity">name</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">natural_relator_from_term</span> <span class="entity">t</span> <span class="main">=</span> 
        <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"Expected constant"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span> <span class="comment1">(* TODO: Localize this! *)</span>

    <span class="keyword2"><span class="keyword">local</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">decl_natrel_aux</span> <span class="entity">t</span> <span class="entity">context</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">warn</span> <span class="entity">msg</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tP</span> <span class="main">=</span> 
            Context.cases Syntax.pretty_term_global Syntax.pretty_term 
              <span class="entity">context</span> <span class="entity">t</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">m</span> <span class="main">=</span> Pretty.block <span class="main">[</span>
            Pretty.str <span class="inner_quoted">"Ignoring invalid natural_relator declaration:"</span><span class="main">,</span>
            Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span>
            Pretty.str <span class="entity">msg</span><span class="main">,</span>
            Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span>
            <span class="entity">tP</span>
          <span class="main">]</span> |&gt; Pretty.string_of
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> warning <span class="entity">m</span>
        <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">context</span> <span class="keyword2"><span class="keyword">end</span></span> 
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">declare_natural_relator</span> <span class="main">(</span><span class="entity">natural_relator_from_term</span> <span class="entity">t</span><span class="main">)</span> <span class="entity">context</span>
        <span class="keyword3"><span class="keyword">handle</span></span> 
          TERM <span class="main">(</span><span class="entity">msg</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">warn</span> <span class="entity">msg</span>
        <span class="main">|</span> <span class="entity">exn</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> Exn.is_interrupt <span class="entity">exn</span> <span class="keyword2"><span class="keyword">then</span></span> Exn.reraise <span class="entity">exn</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">warn</span> <span class="inner_quoted">""</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">natural_relator_attr</span> <span class="main">=</span> Scan.repeat1 Args.term &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ts</span> <span class="main">=&gt;</span> 
        Thm.declaration_attribute <span class="main">(</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> fold <span class="entity">decl_natrel_aux</span> <span class="entity">ts</span><span class="main">)</span>
      <span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">setup</span> <span class="main">=</span> I
      #&gt; <span class="entity">Attrib.setup</span> 
        <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> natural_relator<span class="antiquote">}</span></span></span> <span class="entity">natural_relator_attr</span> <span class="inner_quoted">"Declare natural relator"</span>

  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="entity">Relators.setup</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Setup›</span></span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Natural Relators"</span></span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">natural_relator</span> 
  <span class="quoted">unit_rel</span> <span class="quoted">int_rel</span> <span class="quoted">nat_rel</span> <span class="quoted">bool_rel</span>
  <span class="quoted">fun_rel</span> <span class="quoted">prod_rel</span> <span class="quoted">option_rel</span> <span class="quoted">sum_rel</span> <span class="quoted">list_rel</span>
  <span class="main">]</span><span class="main">]</span>

<span class="comment1">(*declaration {* let open Relators in 
  fn _ =&gt;
     declare_natural_relator (@{type_name unit},@{const_name unit_rel})
  #&gt; declare_natural_relator (@{type_name fun},@{const_name fun_rel})
  #&gt; declare_natural_relator (@{type_name prod},@{const_name prod_rel})
  #&gt; declare_natural_relator (@{type_name option},@{const_name option_rel})
  #&gt; declare_natural_relator (@{type_name sum},@{const_name sum_rel})
  #&gt; declare_natural_relator (@{type_name list},@{const_name list_rel})
  
end
*}*)</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹
  <span class="entity">Relators.mk_natural_relator</span> 
    <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> 
    <span class="main">[</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">Ra</span><span class="main">::</span><span class="main">(</span><span class="tfree">'c</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set"</span><span class="antiquote">}</span></span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">⟨</span><span class="free">Rb</span><span class="main">⟩</span>option_rel"</span><span class="antiquote">}</span></span><span class="main">]</span> 
    <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">type_name</span> prod<span class="antiquote">}</span></span>
  |&gt; the
  |&gt; Thm.cterm_of <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span>
<span class="main">;</span>
  <span class="entity">Relators.mk_fun_rel</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">⟨</span>Id<span class="main">⟩</span>option_rel"</span><span class="antiquote">}</span></span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">⟨</span>Id<span class="main">⟩</span>list_rel"</span><span class="antiquote">}</span></span>
  |&gt; Thm.cterm_of <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span>
›</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Additional Properties"</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span> <span class="main">=</span> 
  single_valued_Id
  subset_refl
  refl

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1" id="Relators-eq_UNIV_iff"><span class="command">lemma</span></span> eq_UNIV_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">=</span>UNIV <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relators-fun_rel_sv"><span class="command">lemma</span></span> fun_rel_sv<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> RAN<span class="main">:</span> <span class="quoted"><span class="quoted">"Range <span class="free">Ra</span> <span class="main">=</span> UNIV"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> SV<span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="free">Rv</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span><span class="free">Ra</span> <span class="main">→</span> <span class="free">Rv</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> single_valuedI ext impI allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="skolem">h</span> <span class="skolem">x'</span>
  <span class="keyword3"><span class="command">assume</span></span> R1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">g</span><span class="main">)</span><span class="main">∈</span><span class="free">Ra</span><span class="main">→</span><span class="free">Rv</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> R2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">h</span><span class="main">)</span><span class="main">∈</span><span class="free">Ra</span><span class="main">→</span><span class="free">Rv</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> RAN <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> AR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">Ra</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> fun_relD<span class="main">[</span><span class="operator">OF</span> R1 AR<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">,</span><span class="skolem">g</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Rv</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> fun_relD<span class="main">[</span><span class="operator">OF</span> R2 AR<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">,</span><span class="skolem">h</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Rv</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">h</span> <span class="skolem">x'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> SV <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span> <span class="main">=</span> Range_Id

<span class="keyword1" id="Relators-fun_rel_id"><span class="command">lemma</span></span> fun_rel_id<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">R1</span><span class="main">=</span>Id<span class="main">;</span> <span class="free">R2</span><span class="main">=</span>Id<span class="main">⟧</span> <span class="main">⟹</span> <span class="free">R1</span> <span class="main">→</span> <span class="free">R2</span> <span class="main">=</span> Id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-fun_rel_id_simp"><span class="command">lemma</span></span> fun_rel_id_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Id<span class="main">→</span>Id <span class="main">=</span> Id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">tagged_solver</span>

<span class="keyword1" id="Relators-fun_rel_comp_dist"><span class="command">lemma</span></span> fun_rel_comp_dist<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R1</span><span class="main">→</span><span class="free">R2</span><span class="main">)</span> <span class="keyword1">O</span> <span class="main">(</span><span class="free">R3</span><span class="main">→</span><span class="free">R4</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">(</span><span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R3</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">R2</span> <span class="keyword1">O</span> <span class="free">R4</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-fun_rel_mono"><span class="command">lemma</span></span> fun_rel_mono<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">R1</span><span class="main">⊆</span><span class="free">R2</span><span class="main">;</span> <span class="free">R3</span><span class="main">⊆</span><span class="free">R4</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">R2</span><span class="main">→</span><span class="free">R3</span> <span class="main">⊆</span> <span class="free">R1</span><span class="main">→</span><span class="free">R4</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_rel_def<span class="main">)</span>

    
<span class="keyword1" id="Relators-prod_rel_sv"><span class="command">lemma</span></span> prod_rel_sv<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>single_valued <span class="free">R1</span><span class="main">;</span> single_valued <span class="free">R2</span><span class="main">⟧</span> <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">R1</span><span class="main">,</span><span class="free">R2</span><span class="main">⟩</span>prod_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> single_valuedI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-prod_rel_id"><span class="command">lemma</span></span> prod_rel_id<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">R1</span><span class="main">=</span>Id<span class="main">;</span> <span class="free">R2</span><span class="main">=</span>Id<span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">R1</span><span class="main">,</span><span class="free">R2</span><span class="main">⟩</span>prod_rel <span class="main">=</span> Id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-prod_rel_id_simp"><span class="command">lemma</span></span> prod_rel_id_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id<span class="main">,</span>Id<span class="main">⟩</span>prod_rel <span class="main">=</span> Id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">tagged_solver</span>

<span class="keyword1" id="Relators-prod_rel_mono"><span class="command">lemma</span></span> prod_rel_mono<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">R2</span><span class="main">⊆</span><span class="free">R1</span><span class="main">;</span> <span class="free">R3</span><span class="main">⊆</span><span class="free">R4</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">R2</span><span class="main">,</span><span class="free">R3</span><span class="main">⟩</span>prod_rel <span class="main">⊆</span> <span class="main">⟨</span><span class="free">R1</span><span class="main">,</span><span class="free">R4</span><span class="main">⟩</span>prod_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-prod_rel_range"><span class="command">lemma</span></span> prod_rel_range<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Range <span class="free">Ra</span><span class="main">=</span>UNIV<span class="main">;</span> Range <span class="free">Rb</span><span class="main">=</span>UNIV<span class="main">⟧</span> 
  <span class="main">⟹</span> Range <span class="main">(</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>prod_rel<span class="main">)</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Range_iff UNIV_I<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
 
<span class="keyword1" id="Relators-option_rel_sv"><span class="command">lemma</span></span> option_rel_sv<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>single_valued <span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> single_valuedI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-option_rel_id"><span class="command">lemma</span></span> option_rel_id<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">=</span>Id <span class="main">⟹</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel <span class="main">=</span> Id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-option_rel_id_simp"><span class="command">lemma</span></span> option_rel_id_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id<span class="main">⟩</span>option_rel <span class="main">=</span> Id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">tagged_solver</span>

<span class="keyword1" id="Relators-option_rel_mono"><span class="command">lemma</span></span> option_rel_mono<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">⊆</span><span class="free">R'</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel <span class="main">⊆</span> <span class="main">⟨</span><span class="free">R'</span><span class="main">⟩</span>option_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-option_rel_range"><span class="command">lemma</span></span> option_rel_range<span class="main">:</span> <span class="quoted"><span class="quoted">"Range <span class="free">R</span> <span class="main">=</span> UNIV <span class="main">⟹</span> Range <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel<span class="main">)</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_rel_def Range_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Range_iff UNIV_I option.exhaust<span class="main">)</span>

<span class="keyword1" id="Relators-option_rel_inter"><span class="command">lemma</span></span> option_rel_inter<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">R1</span> <span class="main">∩</span> <span class="free">R2</span><span class="main">⟩</span>option_rel <span class="main">=</span> <span class="main">⟨</span><span class="free">R1</span><span class="main">⟩</span>option_rel <span class="main">∩</span> <span class="main">⟨</span><span class="free">R2</span><span class="main">⟩</span>option_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-option_rel_constraint"><span class="command">lemma</span></span> option_rel_constraint<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span>UNIV<span class="main">×</span><span class="free">C</span><span class="main">⟩</span>option_rel <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="free">x</span><span class="main">=</span>Some <span class="bound">v</span> <span class="main">⟶</span> <span class="bound">v</span><span class="main">∈</span><span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_rel_def<span class="main">)</span>
    
    
<span class="keyword1" id="Relators-sum_rel_sv"><span class="command">lemma</span></span> sum_rel_sv<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>single_valued <span class="free">Rl</span><span class="main">;</span> single_valued <span class="free">Rr</span><span class="main">⟧</span> <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> single_valuedI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-sum_rel_id"><span class="command">lemma</span></span> sum_rel_id<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Rl</span><span class="main">=</span>Id<span class="main">;</span> <span class="free">Rr</span><span class="main">=</span>Id<span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel <span class="main">=</span> Id"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sum_relE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Relators-sum_rel_id_simp"><span class="command">lemma</span></span> sum_rel_id_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id<span class="main">,</span>Id<span class="main">⟩</span>sum_rel <span class="main">=</span> Id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">tagged_solver</span>

<span class="keyword1" id="Relators-sum_rel_mono"><span class="command">lemma</span></span> sum_rel_mono<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rl</span><span class="main">⊆</span><span class="free">Rl'</span><span class="main">;</span> <span class="free">Rr</span><span class="main">⊆</span><span class="free">Rr'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel <span class="main">⊆</span> <span class="main">⟨</span><span class="free">Rl'</span><span class="main">,</span><span class="free">Rr'</span><span class="main">⟩</span>sum_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-sum_rel_range"><span class="command">lemma</span></span> sum_rel_range<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Range <span class="free">Rl</span><span class="main">=</span>UNIV<span class="main">;</span> Range <span class="free">Rr</span><span class="main">=</span>UNIV <span class="main">⟧</span> <span class="main">⟹</span> Range <span class="main">(</span><span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel<span class="main">)</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_rel_def Range_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Range_iff UNIV_I sumE<span class="main">)</span>

<span class="keyword1" id="Relators-list_rel_sv_iff"><span class="command">lemma</span></span> list_rel_sv_iff<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel<span class="main">)</span> <span class="main">⟷</span> single_valued <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> single_valuedI allI impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_def<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span>
  <span class="keyword3"><span class="command">assume</span></span> SV<span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="free">R</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">z</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">=</span><span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all2_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">z</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> single_valuedD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> SV<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span>
  <span class="keyword3"><span class="command">assume</span></span> SV<span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> single_valuedD<span class="main">[</span><span class="operator">OF</span> SV<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">=</span><span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Relators-list_rel_sv"><span class="command">lemma</span></span> list_rel_sv<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"single_valued <span class="free">R</span> <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_rel_sv_iff<span class="main">)</span>

<span class="keyword1" id="Relators-list_rel_id"><span class="command">lemma</span></span> list_rel_id<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">R</span><span class="main">=</span>Id<span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">=</span> Id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_rel_def list_all2_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Relators-list_rel_id_simp"><span class="command">lemma</span></span> list_rel_id_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id<span class="main">⟩</span>list_rel <span class="main">=</span> Id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">tagged_solver</span>

<span class="keyword1" id="Relators-list_rel_mono"><span class="command">lemma</span></span> list_rel_mono<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">⊆</span><span class="free">R'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">⊆</span> <span class="main">⟨</span><span class="free">R'</span><span class="main">⟩</span>list_rel"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="skolem">l'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">l'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">l'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R'</span><span class="main">⟩</span>list_rel"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induct</span>
    <span class="keyword1"><span class="command">using</span></span> A
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Relators-list_rel_range"><span class="command">lemma</span></span> list_rel_range<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"Range <span class="free">R</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Range <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel<span class="main">)</span> <span class="main">=</span> UNIV"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_UNIV_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">∈</span>Range <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> A<span class="main">[</span><span class="operator">unfolded</span> eq_UNIV_iff<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Range_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list_relI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Relators-bijective_imp_sv"><span class="command">lemma</span></span> bijective_imp_sv<span class="main">:</span>  
  <span class="quoted"><span class="quoted">"bijective <span class="free">R</span> <span class="main">⟹</span> single_valued <span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"bijective <span class="free">R</span> <span class="main">⟹</span> single_valued <span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bijective_alt<span class="main">)</span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1"><span class="command">declare</span></span> bijective_Id<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> bijective_Empty<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pointwise refinement for set types:›</span></span>
  
  
  
<span class="keyword1" id="Relators-set_rel_sv"><span class="command">lemma</span></span> set_rel_sv<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"single_valued <span class="free">R</span> <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> single_valued_def set_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Relators-set_rel_id"><span class="command">lemma</span></span> set_rel_id<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">=</span>Id <span class="main">⟹</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel <span class="main">=</span> Id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-set_rel_id_simp"><span class="command">lemma</span></span> set_rel_id_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id<span class="main">⟩</span>set_rel <span class="main">=</span> Id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">tagged_solver</span>

<span class="keyword1" id="Relators-set_rel_csv"><span class="command">lemma</span></span> set_rel_csv<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> single_valued <span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">)</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel<span class="main">)</span><span class="main">¯</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> single_valued_def set_rel_def converse_iff
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariant and Abstraction›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Quite often, a relation can be described as combination of an
  abstraction function and an invariant, such that the invariant describes valid
  values on the concrete domain, and the abstraction function maps valid 
  concrete values to its corresponding abstract value.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">build_rel</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">build_rel</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">.</span> <span class="bound">a</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="bound">c</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">c</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">br</span><span class="main">≡</span>build_rel"</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> br_def<span class="main">[</span><span class="operator">refine_rel_defs</span><span class="main">]</span> <span class="main">=</span> build_rel_def

<span class="keyword1" id="Relators-in_br_conv"><span class="command">lemma</span></span> in_br_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span>br <span class="free">α</span> <span class="free">I</span> <span class="main">⟷</span> <span class="free">a</span><span class="main">=</span><span class="free">α</span> <span class="free">c</span> <span class="main">∧</span> <span class="free">I</span> <span class="free">c</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> br_def<span class="main">)</span>
  
<span class="keyword1" id="Relators-brI"><span class="command">lemma</span></span> brI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span><span class="main">=</span><span class="free">α</span> <span class="free">c</span><span class="main">;</span> <span class="free">I</span> <span class="free">c</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span>br <span class="free">α</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> br_def<span class="main">)</span>

<span class="keyword1" id="Relators-br_id"><span class="command">lemma</span></span> br_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"br id <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">=</span> Id"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> build_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relators-br_chain"><span class="command">lemma</span></span> br_chain<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>build_rel <span class="free">β</span> <span class="free">J</span><span class="main">)</span> <span class="keyword1">O</span> <span class="main">(</span>build_rel <span class="free">α</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> build_rel <span class="main">(</span><span class="free">α</span><span class="main">∘</span><span class="free">β</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">J</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">I</span> <span class="main">(</span><span class="free">β</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> build_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relators-br_sv"><span class="command">lemma</span></span> br_sv<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span>br <span class="free">α</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> build_rel_def 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Relators-converse_br_sv_iff"><span class="command">lemma</span></span> converse_br_sv_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span>converse <span class="main">(</span>br <span class="free">α</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> inj_on <span class="free">α</span> <span class="main">(</span>Collect <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inj_onI single_valuedI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD inj_onD
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> br_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span> <span class="main">=</span> single_valued_relcomp

<span class="keyword1" id="Relators-br_comp_alt"><span class="command">lemma</span></span> br_comp_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"br <span class="free">α</span> <span class="free">I</span> <span class="keyword1">O</span> <span class="free">R</span> <span class="main">=</span> <span class="main">{</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">.</span> <span class="free">I</span> <span class="bound">c</span> <span class="main">∧</span> <span class="main">(</span><span class="free">α</span> <span class="bound">c</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> br_def<span class="main">)</span>

<span class="keyword1" id="Relators-br_comp_alt'"><span class="command">lemma</span></span> br_comp_alt'<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">.</span> <span class="bound">a</span><span class="main">=</span><span class="free">α</span> <span class="bound">c</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">c</span><span class="main">}</span> <span class="keyword1">O</span> <span class="free">R</span> <span class="main">=</span> <span class="main">{</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">.</span> <span class="free">I</span> <span class="bound">c</span> <span class="main">∧</span> <span class="main">(</span><span class="free">α</span> <span class="bound">c</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Relators-single_valued_as_brE"><span class="command">lemma</span></span> single_valued_as_brE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">α</span> <span class="free">invar</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">=</span>br <span class="free">α</span> <span class="free">invar</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">THE</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>Domain <span class="free">R</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> br_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD 
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> the_equality<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> theI<span class="main">)</span>

<span class="keyword1" id="Relators-sv_add_invar"><span class="command">lemma</span></span> sv_add_invar<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"single_valued <span class="free">R</span> <span class="main">⟹</span> single_valued <span class="main">{</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">c</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> single_valuedI<span class="main">)</span>

<span class="keyword1" id="Relators-br_Image_conv"><span class="command">lemma</span></span> br_Image_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"br <span class="free">α</span> <span class="free">I</span> <span class="main">``</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{</span><span class="free">α</span> <span class="bound">x</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> br_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Miscellanneous›</span></span>
<span class="keyword1" id="Relators-rel_cong"><span class="command">lemma</span></span> rel_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">g</span><span class="main">)</span><span class="main">∈</span>Id <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">∈</span>Id <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">,</span> <span class="free">g</span> <span class="free">y</span><span class="main">)</span><span class="main">∈</span>Id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1" id="Relators-rel_fun_cong"><span class="command">lemma</span></span> rel_fun_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">g</span><span class="main">)</span><span class="main">∈</span>Id <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">,</span> <span class="free">g</span> <span class="free">x</span><span class="main">)</span><span class="main">∈</span>Id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1" id="Relators-rel_arg_cong"><span class="command">lemma</span></span> rel_arg_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">∈</span>Id <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">,</span> <span class="free">f</span> <span class="free">y</span><span class="main">)</span><span class="main">∈</span>Id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Conversion between Predicate and Set Based Relators›</span></span>    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Autoref uses set-based relators of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'a</span></span><span class="main"><span class="main">×</span></span><span class="tfree"><span class="tfree">'b</span></span><span class="main"><span class="main">)</span></span> set›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, while the 
  transfer and lifting package of Isabelle/HOL uses predicate based relators
  of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">‹<span class="tfree"><span class="tfree">'a</span></span> <span class="main"><span class="main">⇒</span></span> <span class="tfree"><span class="tfree">'b</span></span> <span class="main"><span class="main">⇒</span></span> bool›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This section defines some utilities 
  to convert between the two.
›</span></span>  
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rel2p</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">p2rel</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Relators-rel2pD"><span class="command">lemma</span></span> rel2pD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>rel2p <span class="free">R</span> <span class="free">a</span> <span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel2p_def<span class="main">)</span>
<span class="keyword1" id="Relators-p2relD"><span class="command">lemma</span></span> p2relD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∈</span> p2rel <span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">R</span> <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p2rel_def<span class="main">)</span>

<span class="keyword1" id="Relators-rel2p_inv"><span class="command">lemma</span></span> rel2p_inv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel2p <span class="main">(</span>p2rel <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
  <span class="quoted"><span class="quoted">"p2rel <span class="main">(</span>rel2p <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel2p_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> p2rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">named_theorems</span></span> rel2p
<span class="keyword1"><span class="command">named_theorems</span></span> p2rel
  
<span class="keyword1" id="Relators-rel2p_dflt"><span class="command">lemma</span></span> rel2p_dflt<span class="main">[</span><span class="operator">rel2p</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel2p Id <span class="main">=</span> <span class="main">(=)</span>"</span></span>
  <span class="quoted"><span class="quoted">"rel2p <span class="main">(</span><span class="free">A</span><span class="main">→</span><span class="free">B</span><span class="main">)</span> <span class="main">=</span> rel_fun <span class="main">(</span>rel2p <span class="free">A</span><span class="main">)</span> <span class="main">(</span>rel2p <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"rel2p <span class="main">(</span><span class="free">A</span><span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span><span class="free">B</span><span class="main">)</span> <span class="main">=</span> rel_prod <span class="main">(</span>rel2p <span class="free">A</span><span class="main">)</span> <span class="main">(</span>rel2p <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"rel2p <span class="main">(</span><span class="main">⟨</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">⟩</span>sum_rel<span class="main">)</span> <span class="main">=</span> rel_sum <span class="main">(</span>rel2p <span class="free">A</span><span class="main">)</span> <span class="main">(</span>rel2p <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"rel2p <span class="main">(</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>option_rel<span class="main">)</span> <span class="main">=</span> rel_option <span class="main">(</span>rel2p <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"rel2p <span class="main">(</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_rel<span class="main">)</span> <span class="main">=</span> list_all2 <span class="main">(</span>rel2p <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel2p_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> 
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_rel_def rel_fun_def 
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_rel_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rel_sum.cases
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_rel_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> option.rel_cases
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_def
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_rel_def rel_set_def Image_def
    <span class="main">)</span>

 
  
<span class="keyword1" id="Relators-p2rel_dflt"><span class="command">lemma</span></span> p2rel_dflt<span class="main">[</span><span class="operator">p2rel</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"p2rel <span class="main">(=)</span> <span class="main">=</span> Id"</span></span>
  <span class="quoted"><span class="quoted">"p2rel <span class="main">(</span>rel_fun <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> p2rel <span class="free">A</span> <span class="main">→</span> p2rel <span class="free">B</span>"</span></span>
  <span class="quoted"><span class="quoted">"p2rel <span class="main">(</span>rel_prod <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> p2rel <span class="free">A</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> p2rel <span class="free">B</span>"</span></span>
  <span class="quoted"><span class="quoted">"p2rel <span class="main">(</span>rel_sum <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>p2rel <span class="free">A</span><span class="main">,</span> p2rel <span class="free">B</span><span class="main">⟩</span>sum_rel"</span></span>
  <span class="quoted"><span class="quoted">"p2rel <span class="main">(</span>rel_option <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>p2rel <span class="free">A</span><span class="main">⟩</span>option_rel"</span></span>
  <span class="quoted"><span class="quoted">"p2rel <span class="main">(</span>list_all2 <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>p2rel <span class="free">A</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p2rel_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> 
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_rel_def rel_fun_def 
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_rel_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rel_sum.cases
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_rel_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> option.rel_cases
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_def
    <span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">rel2p</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel2p <span class="main">(</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>set_rel<span class="main">)</span> <span class="main">=</span> rel_set <span class="main">(</span>rel2p <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_rel_def rel_set_def rel2p_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">p2rel</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"left_unique <span class="free">A</span> <span class="main">⟹</span> p2rel <span class="main">(</span>rel_set <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span>p2rel <span class="free">A</span><span class="main">⟩</span>set_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_rel_def rel_set_def p2rel_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  

<span class="keyword1" id="Relators-rel2p_comp"><span class="command">lemma</span></span> rel2p_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"rel2p <span class="free">A</span> <span class="keyword1">OO</span> rel2p <span class="free">B</span> <span class="main">=</span> rel2p <span class="main">(</span><span class="free">A</span> <span class="keyword1">O</span> <span class="free">B</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel2p_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1" id="Relators-rel2p_inj"><span class="command">lemma</span></span> rel2p_inj<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel2p <span class="free">A</span> <span class="main">=</span> rel2p <span class="free">B</span> <span class="main">⟷</span> <span class="free">A</span><span class="main">=</span><span class="free">B</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel2p_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">meson</span><span class="main">)</span>
    

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹More Properties›</span></span>    
<span class="comment1">(* TODO: Do compp-lemmas for other standard relations *)</span>
<span class="keyword1" id="Relators-list_rel_compp"><span class="command">lemma</span></span> list_rel_compp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">A</span> <span class="keyword1">O</span> <span class="free">B</span><span class="main">⟩</span>list_rel <span class="main">=</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_rel <span class="keyword1">O</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> list.rel_compp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rel2p <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"rel2p <span class="free">B</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">rel2p</span></span><span class="main"><span class="main">(</span></span>2-<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rel2p_comp<span class="main">)</span> <span class="comment1">(* TODO: Not very systematic proof *)</span>

<span class="keyword1" id="Relators-option_rel_compp"><span class="command">lemma</span></span> option_rel_compp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">A</span> <span class="keyword1">O</span> <span class="free">B</span><span class="main">⟩</span>option_rel <span class="main">=</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>option_rel <span class="keyword1">O</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span>option_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> option.rel_compp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rel2p <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"rel2p <span class="free">B</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">rel2p</span></span><span class="main"><span class="main">(</span></span>2-<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rel2p_comp<span class="main">)</span> <span class="comment1">(* TODO: Not very systematic proof *)</span>
    
<span class="keyword1" id="Relators-prod_rel_compp"><span class="command">lemma</span></span> prod_rel_compp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">A</span> <span class="keyword1">O</span> <span class="free">B</span><span class="main">,</span> <span class="free">C</span> <span class="keyword1">O</span> <span class="free">D</span><span class="main">⟩</span>prod_rel <span class="main">=</span> <span class="main">⟨</span><span class="free">A</span><span class="main">,</span><span class="free">C</span><span class="main">⟩</span>prod_rel <span class="keyword1">O</span> <span class="main">⟨</span><span class="free">B</span><span class="main">,</span><span class="free">D</span><span class="main">⟩</span>prod_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prod.rel_compp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rel2p <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"rel2p <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"rel2p <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"rel2p <span class="free">D</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">rel2p</span></span><span class="main"><span class="main">(</span></span>2-<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rel2p_comp<span class="main">)</span> <span class="comment1">(* TODO: Not very systematic proof *)</span>
    
<span class="keyword1" id="Relators-sum_rel_compp"><span class="command">lemma</span></span> sum_rel_compp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">A</span> <span class="keyword1">O</span> <span class="free">B</span><span class="main">,</span> <span class="free">C</span> <span class="keyword1">O</span> <span class="free">D</span><span class="main">⟩</span>sum_rel <span class="main">=</span> <span class="main">⟨</span><span class="free">A</span><span class="main">,</span><span class="free">C</span><span class="main">⟩</span>sum_rel <span class="keyword1">O</span> <span class="main">⟨</span><span class="free">B</span><span class="main">,</span><span class="free">D</span><span class="main">⟩</span>sum_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sum.rel_compp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rel2p <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"rel2p <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"rel2p <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"rel2p <span class="free">D</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">rel2p</span></span><span class="main"><span class="main">(</span></span>2-<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rel2p_comp<span class="main">)</span> <span class="comment1">(* TODO: Not very systematic proof *)</span>
    
<span class="keyword1" id="Relators-set_rel_compp"><span class="command">lemma</span></span> set_rel_compp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">A</span> <span class="keyword1">O</span> <span class="free">B</span><span class="main">⟩</span>set_rel <span class="main">=</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>set_rel <span class="keyword1">O</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span>set_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rel_set_OO<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rel2p <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"rel2p <span class="free">B</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">rel2p</span></span><span class="main"><span class="main">(</span></span>2-<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rel2p_comp<span class="main">)</span> <span class="comment1">(* TODO: Not very systematic proof *)</span>
    
    
<span class="keyword1" id="Relators-map_in_list_rel_conv"><span class="command">lemma</span></span> map_in_list_rel_conv<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> map <span class="free">α</span> <span class="free">l</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>br <span class="free">α</span> <span class="free">I</span><span class="main">⟩</span>list_rel <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">l</span><span class="main">.</span> <span class="free">I</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv<span class="main">)</span>
    
<span class="keyword1" id="Relators-br_set_rel_alt"><span class="command">lemma</span></span> br_set_rel_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span>br <span class="free">α</span> <span class="free">I</span><span class="main">⟩</span>set_rel <span class="main">⟷</span> <span class="main">(</span><span class="free">s</span><span class="main">=</span><span class="free">α</span><span class="main">`</span><span class="free">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">s'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_rel_def br_def<span class="main">)</span>
    
<span class="comment1">(* TODO: Find proof that does not depend on br, and move to Misc *)</span>    
<span class="keyword1" id="Relators-finite_Image_sv"><span class="command">lemma</span></span> finite_Image_sv<span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="free">R</span> <span class="main">⟹</span> finite <span class="free">s</span> <span class="main">⟹</span> finite <span class="main">(</span><span class="free">R</span><span class="main">``</span><span class="free">s</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> single_valued_as_brE<span class="main">)</span> <span class="operator">simp</span>  
    
<span class="keyword1" id="Relators-finite_set_rel_transfer"><span class="command">lemma</span></span> finite_set_rel_transfer<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel<span class="main">;</span> single_valued <span class="free">R</span><span class="main">;</span> finite <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> finite <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_rel_alt
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_Image_sv<span class="main"><span class="main">]</span></span><span class="main">)</span>  
    
<span class="keyword1" id="Relators-finite_set_rel_transfer_back"><span class="command">lemma</span></span> finite_set_rel_transfer_back<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel<span class="main">;</span> single_valued <span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">)</span><span class="main">;</span> finite <span class="free">s'</span><span class="main">⟧</span> <span class="main">⟹</span> finite <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_rel_alt
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_Image_sv<span class="main"><span class="main">]</span></span><span class="main">)</span>
    
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Param_Tool">
<div class="head">
<h1>Theory Param_Tool</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Basic Parametricity Reasoning›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Param_Tool
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Relators.html">Relators</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary Lemmas›</span></span>
  <span class="keyword1" id="Param_Tool-tag_both"><span class="command">lemma</span></span> tag_both<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span>Let <span class="free">x</span> <span class="free">f</span><span class="main">,</span>Let <span class="free">x'</span> <span class="free">f'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">,</span><span class="free">f'</span> <span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="Param_Tool-tag_rhs"><span class="command">lemma</span></span> tag_rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span>Let <span class="free">x</span> <span class="free">f</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="Param_Tool-tag_lhs"><span class="command">lemma</span></span> tag_lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span>Let <span class="free">x</span> <span class="free">f</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Param_Tool-tagged_fun_relD_both"><span class="command">lemma</span></span> tagged_fun_relD_both<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">f'</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span><span class="main">→</span><span class="free">B</span><span class="main">;</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>Let <span class="free">x</span> <span class="free">f</span><span class="main">,</span>Let <span class="free">x'</span> <span class="free">f'</span><span class="main">)</span><span class="main">∈</span><span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> tagged_fun_relD_rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">f'</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span><span class="main">→</span><span class="free">B</span><span class="main">;</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">,</span>Let <span class="free">x'</span> <span class="free">f'</span><span class="main">)</span><span class="main">∈</span><span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> tagged_fun_relD_lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">f'</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span><span class="main">→</span><span class="free">B</span><span class="main">;</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>Let <span class="free">x</span> <span class="free">f</span><span class="main">,</span><span class="free">f'</span> <span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> tagged_fun_relD_none<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">f'</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span><span class="main">→</span><span class="free">B</span><span class="main">;</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">,</span><span class="free">f'</span> <span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>


  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ML-Setup›</span></span>

  <span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
    <span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">PARAMETRICITY</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">param_ruleT</span> <span class="main">=</span> <span class="main">{</span>
        lhs<span class="main">:</span> term<span class="main">,</span>
        rhs<span class="main">:</span> term<span class="main">,</span>
        R<span class="main">:</span> term<span class="main">,</span>
        rhs_head<span class="main">:</span> term<span class="main">,</span>
        arity<span class="main">:</span> int
      <span class="main">}</span>
    
      <span class="keyword1"><span class="keyword">val</span></span> dest_param_term<span class="main">:</span> term <span class="main">-&gt;</span> <span class="entity">param_ruleT</span>
      <span class="keyword1"><span class="keyword">val</span></span> dest_param_rule<span class="main">:</span> thm <span class="main">-&gt;</span> <span class="entity">param_ruleT</span>
      <span class="keyword1"><span class="keyword">val</span></span> dest_param_goal<span class="main">:</span> int <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> <span class="entity">param_ruleT</span>

      <span class="keyword1"><span class="keyword">val</span></span> safe_fun_relD_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>

      <span class="keyword1"><span class="keyword">val</span></span> adjust_arity<span class="main">:</span> int <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm
      <span class="keyword1"><span class="keyword">val</span></span> adjust_arity_tac<span class="main">:</span> int <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
      <span class="keyword1"><span class="keyword">val</span></span> unlambda_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
      <span class="keyword1"><span class="keyword">val</span></span> prepare_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>

      <span class="keyword1"><span class="keyword">val</span></span> fo_rule<span class="main">:</span> thm <span class="main">-&gt;</span> thm

      <span class="comment1">(*** Basic tactics ***)</span>
      <span class="keyword1"><span class="keyword">val</span></span> param_rule_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> <span class="entity">tactic'</span>
      <span class="keyword1"><span class="keyword">val</span></span> param_rules_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm list <span class="main">-&gt;</span> <span class="entity">tactic'</span>
      <span class="keyword1"><span class="keyword">val</span></span> asm_param_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>


      <span class="comment1">(*** Nets of parametricity rules ***)</span>
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">param_net</span>
      <span class="keyword1"><span class="keyword">val</span></span> net_empty<span class="main">:</span> <span class="entity">param_net</span>
      <span class="keyword1"><span class="keyword">val</span></span> net_add<span class="main">:</span> thm <span class="main">-&gt;</span> <span class="entity">param_net</span> <span class="main">-&gt;</span> <span class="entity">param_net</span>
      <span class="keyword1"><span class="keyword">val</span></span> net_del<span class="main">:</span> thm <span class="main">-&gt;</span> <span class="entity">param_net</span> <span class="main">-&gt;</span> <span class="entity">param_net</span>
      <span class="keyword1"><span class="keyword">val</span></span> net_add_int<span class="main">:</span> Context.generic <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> <span class="entity">param_net</span> <span class="main">-&gt;</span> <span class="entity">param_net</span>
      <span class="keyword1"><span class="keyword">val</span></span> net_del_int<span class="main">:</span> Context.generic <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> <span class="entity">param_net</span> <span class="main">-&gt;</span> <span class="entity">param_net</span>
      <span class="keyword1"><span class="keyword">val</span></span> net_tac<span class="main">:</span> <span class="entity">param_net</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    
      <span class="comment1">(*** Default parametricity rules ***)</span>
      <span class="keyword1"><span class="keyword">val</span></span> add_dflt<span class="main">:</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
      <span class="keyword1"><span class="keyword">val</span></span> add_dflt_attr<span class="main">:</span> attribute
      <span class="keyword1"><span class="keyword">val</span></span> del_dflt<span class="main">:</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
      <span class="keyword1"><span class="keyword">val</span></span> del_dflt_attr<span class="main">:</span> attribute
      <span class="keyword1"><span class="keyword">val</span></span> get_dflt<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">param_net</span>

      <span class="comment1">(** Configuration **)</span>
      <span class="keyword1"><span class="keyword">val</span></span> cfg_use_asm<span class="main">:</span> bool Config.T
      <span class="keyword1"><span class="keyword">val</span></span> cfg_single_step<span class="main">:</span> bool Config.T

      <span class="comment1">(** Setup **)</span>
      <span class="keyword1"><span class="keyword">val</span></span> setup<span class="main">:</span> theory <span class="main">-&gt;</span> theory
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Parametricity</span> <span class="main">:</span> <span class="entity">PARAMETRICITY</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">param_ruleT</span> <span class="main">=</span> <span class="main">{</span>
        lhs<span class="main">:</span> term<span class="main">,</span>
        rhs<span class="main">:</span> term<span class="main">,</span>
        R<span class="main">:</span> term<span class="main">,</span>
        rhs_head<span class="main">:</span> term<span class="main">,</span>
        arity<span class="main">:</span> int
      <span class="main">}</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_param_term</span> <span class="entity">t</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">case</span></span> 
          strip_all_body <span class="entity">t</span> |&gt; Logic.strip_imp_concl |&gt; <span class="entity">HOLogic.dest_Trueprop</span>
        <span class="keyword2"><span class="keyword">of</span></span> 
          <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="main">(</span><span class="var">?lhs</span><span class="main">,</span><span class="var">?rhs</span><span class="main">)</span><span class="main">:</span><span class="var">?R</span>"</span><span class="antiquote">}</span></span></span></span></span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span> 
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">rhs_head</span><span class="main">,</span><span class="entity">arity</span><span class="main">)</span> <span class="main">=</span> 
              <span class="keyword2"><span class="keyword">case</span></span> strip_comb <span class="entity">rhs</span> <span class="keyword2"><span class="keyword">of</span></span>
                <span class="main">(</span><span class="entity">c</span> <span class="keyword1"><span class="keyword">as</span></span> Const <span class="main">_</span><span class="main">,</span><span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">c</span><span class="main">,</span>length <span class="entity">l</span><span class="main">)</span>
              <span class="main">|</span> <span class="main">(</span><span class="entity">c</span> <span class="keyword1"><span class="keyword">as</span></span> Free <span class="main">_</span><span class="main">,</span><span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">c</span><span class="main">,</span>length <span class="entity">l</span><span class="main">)</span>
              <span class="main">|</span> <span class="main">(</span><span class="entity">c</span> <span class="keyword1"><span class="keyword">as</span></span> Abs <span class="main">_</span><span class="main">,</span><span class="entity">l</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">c</span><span class="main">,</span>length <span class="entity">l</span><span class="main">)</span>
              <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dest_param_term: Head"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span> 
            <span class="main">{</span> lhs <span class="main">=</span> <span class="entity">lhs</span><span class="main">,</span> rhs <span class="main">=</span> <span class="entity">rhs</span><span class="main">,</span> R<span class="main">=</span><span class="entity">R</span><span class="main">,</span> rhs_head <span class="main">=</span> <span class="entity">rhs_head</span><span class="main">,</span> arity <span class="main">=</span> <span class="entity">arity</span> <span class="main">}</span>
          <span class="keyword2"><span class="keyword">end</span></span>
        <span class="main">|</span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dest_param_term: Expected (_,_):_"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">dest_param_rule</span> <span class="main">=</span> <span class="entity">dest_param_term</span> o Thm.prop_of
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_param_goal</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &gt; Thm.nprems_of <span class="entity">st</span> <span class="keyword2"><span class="keyword">then</span></span>
          <span class="keyword3"><span class="keyword">raise</span></span> THM <span class="main">(</span><span class="inner_quoted">"dest_param_goal"</span><span class="main">,</span><span class="entity">i</span><span class="main">,</span><span class="main">[</span><span class="entity">st</span><span class="main">]</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span>
          <span class="entity">dest_param_term</span> <span class="main">(</span>Logic.concl_of_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span><span class="main">)</span>


      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">safe_fun_relD_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">t</span> <span class="entity">a</span> <span class="entity">b</span> <span class="main">=</span> <span class="entity">fo_resolve_tac</span> <span class="main">[</span><span class="entity">a</span><span class="main">]</span> <span class="entity">ctxt</span> THEN' resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">b</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        DETERM o <span class="main">(</span>
          <span class="entity">t</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> tag_both<span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> tagged_fun_relD_both<span class="antiquote">}</span></span></span> ORELSE'
          <span class="entity">t</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> tag_rhs<span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> tagged_fun_relD_rhs<span class="antiquote">}</span></span></span> ORELSE'
          <span class="entity">t</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> tag_lhs<span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> tagged_fun_relD_lhs<span class="antiquote">}</span></span></span> ORELSE'
          resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> tagged_fun_relD_none<span class="antiquote">}</span></span></span>
        <span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">adjust_arity</span> <span class="entity">i</span> <span class="entity">thm</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">thm</span> 
        <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span>&lt;<span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> funpow <span class="main">(</span>~<span class="entity">i</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">thm</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> fun_relI<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">thm</span>
        <span class="keyword2"><span class="keyword">else</span></span> funpow <span class="entity">i</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">thm</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> fun_relD<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">thm</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">NTIMES</span> <span class="entity">k</span> <span class="entity">tac</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">k</span> &lt;= <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> K all_tac 
        <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">tac</span> THEN' <span class="entity">NTIMES</span> <span class="main">(</span><span class="entity">k</span>-<span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">tac</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">adjust_arity_tac</span> <span class="entity">n</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> 
        <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> K all_tac
        <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span>&gt;<span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">NTIMES</span> <span class="entity">n</span> <span class="main">(</span>DETERM o resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> fun_relI<span class="antiquote">}</span></span></span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">NTIMES</span> <span class="main">(</span>~<span class="entity">n</span><span class="main">)</span> <span class="main">(</span><span class="entity">safe_fun_relD_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unlambda_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">case</span></span> try <span class="main">(</span><span class="entity">dest_param_goal</span> <span class="entity">i</span><span class="main">)</span> <span class="entity">st</span> <span class="keyword2"><span class="keyword">of</span></span>
          NONE <span class="main">=&gt;</span> Seq.empty
        <span class="main">|</span> SOME <span class="entity">g</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> Term.strip_abs <span class="main">(</span><span class="main">#</span>rhs_head <span class="entity">g</span><span class="main">)</span> |&gt; <span class="main">#</span><span class="inner_numeral">1</span> |&gt; length
          <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">NTIMES</span> <span class="entity">n</span> <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> fun_relI<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span> <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prepare_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> 
        <span class="entity">Subgoal.FOCUS</span> <span class="main">(</span>K <span class="main">(</span>PRIMITIVE <span class="main">(</span>Drule.eta_contraction_rule<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span>
        THEN' <span class="entity">unlambda_tac</span> <span class="entity">ctxt</span>


      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">could_param_rl</span> <span class="entity">rl</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &gt; Thm.nprems_of <span class="entity">st</span> <span class="keyword2"><span class="keyword">then</span></span> NONE
        <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span>
          <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span>try <span class="main">(</span><span class="entity">dest_param_goal</span> <span class="entity">i</span><span class="main">)</span> <span class="entity">st</span><span class="main">,</span> try <span class="entity">dest_param_term</span> <span class="entity">rl</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
            <span class="main">(</span>SOME <span class="entity">g</span><span class="main">,</span> SOME <span class="entity">r</span><span class="main">)</span> <span class="main">=&gt;</span>
              <span class="keyword2"><span class="keyword">if</span></span> Term.could_unify <span class="main">(</span><span class="main">#</span>rhs_head <span class="entity">g</span><span class="main">,</span> <span class="main">#</span>rhs_head <span class="entity">r</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
                SOME <span class="main">(</span><span class="main">#</span>arity <span class="entity">r</span> - <span class="main">#</span>arity <span class="entity">g</span><span class="main">)</span>
              <span class="keyword2"><span class="keyword">else</span></span> NONE
          <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> NONE
        <span class="main">)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">param_rule_tac_aux</span> <span class="entity">ctxt</span> <span class="entity">rl</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">could_param_rl</span> <span class="main">(</span>Thm.prop_of <span class="entity">rl</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span> <span class="keyword2"><span class="keyword">of</span></span>
          SOME <span class="entity">adj</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">adjust_arity_tac</span> <span class="entity">adj</span> <span class="entity">ctxt</span> THEN' resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">rl</span><span class="main">]</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Seq.empty

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">param_rule_tac</span> <span class="entity">ctxt</span> <span class="entity">rl</span> <span class="main">=</span> 
        <span class="entity">prepare_tac</span> <span class="entity">ctxt</span> THEN' <span class="entity">param_rule_tac_aux</span> <span class="entity">ctxt</span> <span class="entity">rl</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">param_rules_tac</span> <span class="entity">ctxt</span> <span class="entity">rls</span> <span class="main">=</span> 
        <span class="entity">prepare_tac</span> <span class="entity">ctxt</span> THEN' FIRST' <span class="main">(</span>map <span class="main">(</span><span class="entity">param_rule_tac_aux</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">rls</span><span class="main">)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">asm_param_tac_aux</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &gt; Thm.nprems_of <span class="entity">st</span> <span class="keyword2"><span class="keyword">then</span></span> Seq.empty
        <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prems</span> <span class="main">=</span> Logic.prems_of_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span> |&gt; tag_list <span class="inner_numeral">1</span>
          
          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tac</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">could_param_rl</span> <span class="entity">t</span> <span class="entity">i</span> <span class="entity">st</span> <span class="keyword2"><span class="keyword">of</span></span>
            SOME <span class="entity">adj</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">adjust_arity_tac</span> <span class="entity">adj</span> <span class="entity">ctxt</span> THEN' <span class="entity">rprem_tac</span> <span class="entity">n</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>
          <span class="main">|</span> NONE <span class="main">=&gt;</span> Seq.empty
        <span class="keyword2"><span class="keyword">in</span></span>
          FIRST' <span class="main">(</span>map <span class="entity">tac</span> <span class="entity">prems</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>
        <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">asm_param_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">prepare_tac</span> <span class="entity">ctxt</span> THEN' <span class="entity">asm_param_tac_aux</span> <span class="entity">ctxt</span>
    
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">param_net</span> <span class="main">=</span> <span class="main">(</span><span class="entity">param_ruleT</span> * thm<span class="main">)</span> Item_Net.T

      <span class="keyword2"><span class="keyword">local</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">param_get_key</span> <span class="main">=</span> single o <span class="main">#</span>rhs_head o <span class="main">#</span><span class="inner_numeral">1</span>
      <span class="keyword2"><span class="keyword">in</span></span> 
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">net_empty</span> <span class="main">=</span> Item_Net.init <span class="main">(</span>Thm.eq_thm o apply2 <span class="main">#</span><span class="inner_numeral">2</span><span class="main">)</span> <span class="entity">param_get_key</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">wrap_pr_op</span> <span class="entity">f</span> <span class="entity">context</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> try <span class="main">(</span>`<span class="entity">dest_param_rule</span><span class="main">)</span> <span class="entity">thm</span> <span class="keyword2"><span class="keyword">of</span></span>
        NONE <span class="main">=&gt;</span> 
          <span class="keyword2"><span class="keyword">let</span></span> 
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">msg</span> <span class="main">=</span> <span class="inner_quoted">"Ignoring invalid parametricity theorem: "</span>
              ^ Thm.string_of_thm <span class="main">(</span>Context.proof_of <span class="entity">context</span><span class="main">)</span> <span class="entity">thm</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> warning <span class="entity">msg</span>
          <span class="keyword2"><span class="keyword">in</span></span> I <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> SOME <span class="entity">p</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="entity">p</span>
    
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">net_add_int</span> <span class="main">=</span> <span class="entity">wrap_pr_op</span> Item_Net.update 
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">net_del_int</span> <span class="main">=</span> <span class="entity">wrap_pr_op</span> Item_Net.remove

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">net_add</span> <span class="main">=</span> Item_Net.update o `<span class="entity">dest_param_rule</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">net_del</span> <span class="main">=</span> Item_Net.remove o `<span class="entity">dest_param_rule</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">net_tac_aux</span> <span class="entity">net</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &gt; Thm.nprems_of <span class="entity">st</span> <span class="keyword2"><span class="keyword">then</span></span> 
          Seq.empty 
        <span class="keyword2"><span class="keyword">else</span></span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">g</span> <span class="main">=</span> <span class="entity">dest_param_goal</span> <span class="entity">i</span> <span class="entity">st</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rls</span> <span class="main">=</span> Item_Net.retrieve <span class="entity">net</span> <span class="main">(</span><span class="main">#</span>rhs_head <span class="entity">g</span><span class="main">)</span>
        
            <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tac</span> <span class="main">(</span><span class="entity">r</span><span class="main">,</span><span class="entity">thm</span><span class="main">)</span> <span class="main">=</span> 
              <span class="entity">adjust_arity_tac</span> <span class="main">(</span><span class="main">#</span>arity <span class="entity">r</span> - <span class="main">#</span>arity <span class="entity">g</span><span class="main">)</span> <span class="entity">ctxt</span> 
              THEN' DETERM o resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">thm</span><span class="main">]</span>
          <span class="keyword2"><span class="keyword">in</span></span> 
            FIRST' <span class="main">(</span>map <span class="entity">tac</span> <span class="entity">rls</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>
          <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">net_tac</span> <span class="entity">net</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">prepare_tac</span> <span class="entity">ctxt</span> THEN' <span class="entity">net_tac_aux</span> <span class="entity">net</span> <span class="entity">ctxt</span>

      <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">dflt_rules</span> <span class="main">=</span> Generic_Data <span class="main">(</span>
        <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="entity">param_net</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> <span class="entity">net_empty</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">merge</span> <span class="main">=</span> Item_Net.merge
      <span class="main">)</span>
        
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_dflt</span> <span class="entity">thm</span> <span class="entity">context</span> <span class="main">=</span> dflt_rules.map <span class="main">(</span><span class="entity">net_add_int</span> <span class="entity">context</span> <span class="entity">thm</span><span class="main">)</span> <span class="entity">context</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">del_dflt</span> <span class="entity">thm</span> <span class="entity">context</span> <span class="main">=</span> dflt_rules.map <span class="main">(</span><span class="entity">net_del_int</span> <span class="entity">context</span> <span class="entity">thm</span><span class="main">)</span> <span class="entity">context</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">add_dflt_attr</span> <span class="main">=</span> Thm.declaration_attribute <span class="entity">add_dflt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">del_dflt_attr</span> <span class="main">=</span> Thm.declaration_attribute <span class="entity">del_dflt</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">get_dflt</span> <span class="main">=</span> dflt_rules.get o Context.Proof

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cfg_use_asm</span> <span class="main">=</span> 
        <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> param_use_asm<span class="antiquote">}</span></span></span> <span class="main">(</span>K true<span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cfg_single_step</span> <span class="main">=</span> 
        <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> param_single_step<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span>

      <span class="keyword2"><span class="keyword">local</span></span>
        <span class="keyword3"><span class="keyword">open</span></span> Refine_Util

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">param_modifiers</span> <span class="main">=</span>
          <span class="main">[</span>Args.add -- Args.colon &gt;&gt; K <span class="main">(</span><span class="entity">Method.modifier</span> <span class="entity">add_dflt_attr</span> <span class="antiquoted"><span class="operator"><span class="entity">⌂</span></span></span><span class="main">)</span><span class="main">,</span>
           Args.del -- Args.colon &gt;&gt; K <span class="main">(</span><span class="entity">Method.modifier</span> <span class="entity">del_dflt_attr</span> <span class="antiquoted"><span class="operator"><span class="entity">⌂</span></span></span><span class="main">)</span><span class="main">,</span>
           Args.$$$ <span class="inner_quoted">"only"</span> -- Args.colon &gt;&gt;
            K <span class="main">{</span>init <span class="main">=</span> Context.proof_map <span class="main">(</span>dflt_rules.map <span class="main">(</span>K <span class="entity">net_empty</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                attribute <span class="main">=</span> <span class="entity">add_dflt_attr</span><span class="main">,</span> pos <span class="main">=</span> <span class="antiquoted"><span class="operator"><span class="entity">⌂</span></span></span><span class="main">}</span><span class="main">]</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">param_flags</span> <span class="main">=</span> 
           <span class="entity">parse_bool_config</span> <span class="inner_quoted">"use_asm"</span> <span class="entity">cfg_use_asm</span>
        || <span class="entity">parse_bool_config</span> <span class="inner_quoted">"single_step"</span> <span class="entity">cfg_single_step</span>

      <span class="keyword2"><span class="keyword">in</span></span>
          
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parametricity_method</span> <span class="main">=</span> 
          <span class="entity">parse_paren_lists</span> <span class="entity">param_flags</span> |-- <span class="entity">Method.sections</span> <span class="entity">param_modifiers</span> &gt;&gt; 
          <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> 
            <span class="keyword2"><span class="keyword">let</span></span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">net2</span> <span class="main">=</span> <span class="entity">get_dflt</span> <span class="entity">ctxt</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">asm_tac</span> <span class="main">=</span> 
                <span class="keyword2"><span class="keyword">if</span></span> Config.get <span class="entity">ctxt</span> <span class="entity">cfg_use_asm</span> <span class="keyword2"><span class="keyword">then</span></span> 
                  <span class="entity">asm_param_tac</span> <span class="entity">ctxt</span>
                <span class="keyword2"><span class="keyword">else</span></span> K no_tac
   
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">RPT</span> <span class="main">=</span> 
                <span class="keyword2"><span class="keyword">if</span></span> Config.get <span class="entity">ctxt</span> <span class="entity">cfg_single_step</span> <span class="keyword2"><span class="keyword">then</span></span> I
                <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">REPEAT_ALL_NEW_FWD</span>
  
            <span class="keyword2"><span class="keyword">in</span></span>
              <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span>
                <span class="entity">RPT</span> <span class="main">(</span>
                  <span class="main">(</span>assume_tac <span class="entity">ctxt</span> 
                    ORELSE' <span class="entity">net_tac</span> <span class="entity">net2</span> <span class="entity">ctxt</span>
                    ORELSE' <span class="entity">asm_tac</span><span class="main">)</span>
                <span class="main">)</span> 
              <span class="main">)</span>
            <span class="keyword2"><span class="keyword">end</span></span>
          <span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fo_rule</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> Thm.concl_of <span class="entity">thm</span> <span class="keyword2"><span class="keyword">of</span></span>
            <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">∈</span><span class="main">_</span><span class="main">→</span><span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span> <span class="main">=&gt;</span> <span class="entity">fo_rule</span> <span class="main">(</span><span class="entity">thm</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> fun_relD<span class="antiquote">}</span></span></span><span class="main">)</span>
          <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">thm</span> 
          
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">param_fo_attr</span> <span class="main">=</span> Scan.succeed <span class="main">(</span>Thm.rule_attribute <span class="main">[</span><span class="main">]</span> <span class="main">(</span>K <span class="entity">fo_rule</span><span class="main">)</span><span class="main">)</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">setup</span> <span class="main">=</span> I
        #&gt; <span class="entity">Attrib.setup</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> param<span class="antiquote">}</span></span></span> 
            <span class="main">(</span><span class="entity">Attrib.add_del</span> <span class="entity">add_dflt_attr</span> <span class="entity">del_dflt_attr</span><span class="main">)</span>
            <span class="inner_quoted">"declaration of parametricity theorem"</span>
        #&gt; Global_Theory.add_thms_dynamic <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> param<span class="antiquote">}</span></span></span><span class="main">,</span> 
             map <span class="main">#</span><span class="inner_numeral">2</span> o Item_Net.content o dflt_rules.get<span class="main">)</span>
        #&gt; <span class="entity">Method.setup</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> parametricity<span class="antiquote">}</span></span></span> <span class="entity">parametricity_method</span> 
             <span class="inner_quoted">"Parametricity solver"</span>
        #&gt; <span class="entity">Attrib.setup</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> param_fo<span class="antiquote">}</span></span></span> <span class="entity">param_fo_attr</span> 
             <span class="inner_quoted">"Parametricity: Rule in first-order form"</span>

    <span class="keyword2"><span class="keyword">end</span></span>
›</span>

  <span class="keyword1"><span class="command">setup</span></span> <span class="entity">Parametricity.setup</span>



  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Convenience Tools›</span></span>

  <span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
    <span class="comment1">(* Prefix p_ or wrong type supresses generation of relAPP *)</span>
  
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cnv_relAPP</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">consider</span> <span class="main">(</span>Var <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">if</span></span> String.isPrefix <span class="inner_quoted">"p_"</span> <span class="entity">name</span> <span class="keyword2"><span class="keyword">then</span></span> false   
        <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span>
          <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">T</span> <span class="keyword2"><span class="keyword">of</span></span>
            Type<span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">type_name</span> set<span class="antiquote">}</span></span><span class="main">,</span><span class="main">[</span>Type<span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">type_name</span> prod<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> true
          <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false<span class="main">)</span>
      <span class="main">|</span> <span class="entity">consider</span> <span class="main">_</span> <span class="main">=</span> true
  
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">strip_rcomb</span> <span class="entity">u</span> <span class="main">:</span> term * term list <span class="main">=</span>
        <span class="keyword2"><span class="keyword">let</span></span> 
          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">stripc</span> <span class="main">(</span><span class="entity">x</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">f</span>$<span class="entity">t</span><span class="main">,</span> <span class="entity">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
            <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">consider</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">stripc</span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span> <span class="entity">t</span>::<span class="entity">ts</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">x</span>
          <span class="main">|</span> <span class="entity">stripc</span>  <span class="entity">x</span> <span class="main">=</span>  <span class="entity">x</span>
        <span class="keyword2"><span class="keyword">in</span></span>  <span class="entity">stripc</span><span class="main">(</span><span class="entity">u</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span>  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
  
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">a</span><span class="main">)</span> <span class="main">=</span> <span class="entity">strip_rcomb</span> <span class="entity">t</span>
    <span class="keyword2"><span class="keyword">in</span></span> 
      <span class="entity">Relators.list_relAPP</span> <span class="entity">a</span> <span class="entity">f</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">to_relAPP_conv</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">Refine_Util.f_tac_conv</span> <span class="entity">ctxt</span> 
      <span class="entity">cnv_relAPP</span> 
      <span class="main">(</span>ALLGOALS <span class="main">(</span><span class="entity">simp_tac</span> 
        <span class="main">(</span>put_simpset <span class="entity">HOL_basic_ss</span> <span class="entity">ctxt</span> addsimps <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> relAPP_def<span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  
  
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">to_relAPP_attr</span> <span class="main">=</span> Thm.rule_attribute <span class="main">[</span><span class="main">]</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">context</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Context.proof_of <span class="entity">context</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      Conv.fconv_rule <span class="main">(</span>Conv.arg1_conv <span class="main">(</span><span class="entity">to_relAPP_conv</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
›</span>
  
  <span class="keyword1"><span class="command">attribute_setup</span></span> to_relAPP <span class="main">=</span> <span class="quoted">‹Scan.succeed <span class="main">(</span><span class="entity">to_relAPP_attr</span><span class="main">)</span>›</span> 
    <span class="quoted">"Convert relator definition to prefix-form"</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Param_HOL">
<div class="head">
<h1>Theory Param_HOL</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Parametricity Theorems for HOL›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Param_HOL
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Param_Tool.html">Param_Tool</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sets›</span></span>

<span class="keyword1" id="Param_HOL-param_empty"><span class="command">lemma</span></span> param_empty<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_rel_def<span class="main">)</span>

<span class="keyword1" id="Param_HOL-param_member"><span class="command">lemma</span></span> param_member<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>single_valued <span class="free">R</span><span class="main">;</span> single_valued <span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(∈)</span><span class="main">,</span> <span class="main">(∈)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel <span class="main">→</span> bool_rel"</span></span>  
  <span class="keyword1"><span class="command">unfolding</span></span> set_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD<span class="main">)</span>

    
<span class="keyword1" id="Param_HOL-param_insert"><span class="command">lemma</span></span> param_insert<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>insert<span class="main">,</span>insert<span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">→</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel<span class="main">→</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_rel_def<span class="main">)</span>

<span class="keyword1" id="Param_HOL-param_union"><span class="command">lemma</span></span> param_union<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(∪)</span><span class="main">,</span> <span class="main">(∪)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_rel_def<span class="main">)</span>

<span class="keyword1" id="Param_HOL-param_inter"><span class="command">lemma</span></span> param_inter<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(∩)</span><span class="main">,</span> <span class="main">(∩)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms  
  <span class="keyword1"><span class="command">unfolding</span></span> set_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD<span class="main">)</span>

<span class="keyword1" id="Param_HOL-param_diff"><span class="command">lemma</span></span> param_diff<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(-)</span><span class="main">,</span> <span class="main">(-)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">unfolding</span></span> set_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD<span class="main">)</span>
    
<span class="keyword1" id="Param_HOL-param_subseteq"><span class="command">lemma</span></span> param_subseteq<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>single_valued <span class="free">R</span><span class="main">;</span> single_valued <span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(⊆)</span><span class="main">,</span> <span class="main">(⊆)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD<span class="main">)</span>

<span class="keyword1" id="Param_HOL-param_subset"><span class="command">lemma</span></span> param_subset<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>single_valued <span class="free">R</span><span class="main">;</span> single_valued <span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(⊂)</span><span class="main">,</span> <span class="main">(⊂)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_rel_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD<span class="main">)</span>

<span class="keyword1" id="Param_HOL-param_Ball"><span class="command">lemma</span></span> param_Ball<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Ball<span class="main">,</span>Ball<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span>set_rel<span class="main">→</span><span class="main">(</span><span class="free">Ra</span><span class="main">→</span>Id<span class="main">)</span><span class="main">→</span>Id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_rel_alt <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span> 
  
<span class="keyword1" id="Param_HOL-param_Bex"><span class="command">lemma</span></span> param_Bex<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Bex<span class="main">,</span>Bex<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span>set_rel<span class="main">→</span><span class="main">(</span><span class="free">Ra</span><span class="main">→</span>Id<span class="main">)</span><span class="main">→</span>Id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_rel_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>
    
    
<span class="keyword1" id="Param_HOL-param_set"><span class="command">lemma</span></span> param_set<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"single_valued <span class="free">Ra</span> <span class="main">⟹</span> <span class="main">(</span>set<span class="main">,</span>set<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span>set_rel"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="skolem">l'</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="free">Ra</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">l'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="skolem">l</span><span class="main">,</span> set <span class="skolem">l'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span>set_rel"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">parametricity</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="Param_HOL-param_Collect"><span class="command">lemma</span></span> param_Collect<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Domain <span class="free">A</span> <span class="main">=</span> UNIV<span class="main">;</span> Range <span class="free">A</span> <span class="main">=</span> UNIV<span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>Collect<span class="main">,</span>Collect<span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">A</span><span class="main">→</span>bool_rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>set_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_rel_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> fun_relD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> fun_relD2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  
  
<span class="keyword1" id="Param_HOL-param_finite"><span class="command">lemma</span></span> param_finite<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
    single_valued <span class="free">R</span><span class="main">;</span> single_valued <span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">)</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>finite<span class="main">,</span>finite<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>set_rel <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_set_rel_transfer finite_set_rel_transfer_back <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Standard HOL Constructs›</span></span>  
  
<span class="keyword1" id="Param_HOL-param_if"><span class="command">lemma</span></span> param_if<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>Id"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span><span class="main">;</span><span class="free">c'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">t'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span><span class="free">c</span><span class="main">;</span><span class="main">¬</span><span class="free">c'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span><span class="free">e'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>If <span class="free">c</span> <span class="free">t</span> <span class="free">e</span><span class="main">,</span> If <span class="free">c'</span> <span class="free">t'</span> <span class="free">e'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Param_HOL-param_Let"><span class="command">lemma</span></span> param_Let<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Let<span class="main">,</span>Let<span class="main">)</span><span class="main">∈</span><span class="free">Ra</span> <span class="main">→</span> <span class="main">(</span><span class="free">Ra</span><span class="main">→</span><span class="free">Rr</span><span class="main">)</span> <span class="main">→</span> <span class="free">Rr</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Functions›</span></span>  
    
<span class="keyword1" id="Param_HOL-param_id"><span class="command">lemma</span></span> param_id<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>id<span class="main">,</span>id<span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">→</span><span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

<span class="keyword1" id="Param_HOL-param_fun_comp"><span class="command">lemma</span></span> param_fun_comp<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">(o)</span><span class="main">,</span> <span class="keyword1">(o)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">Ra</span><span class="main">→</span><span class="free">Rb</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">Rc</span><span class="main">→</span><span class="free">Ra</span><span class="main">)</span> <span class="main">→</span> <span class="free">Rc</span><span class="main">→</span><span class="free">Rb</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> comp_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

<span class="keyword1" id="Param_HOL-param_fun_upd"><span class="command">lemma</span></span> param_fun_upd<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span><span class="main">(=)</span><span class="main">,</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ra</span><span class="main">→</span><span class="free">Ra</span><span class="main">→</span>Id 
  <span class="main">⟹</span> <span class="main">(</span>fun_upd<span class="main">,</span>fun_upd<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">Ra</span><span class="main">→</span><span class="free">Rb</span><span class="main">)</span> <span class="main">→</span> <span class="free">Ra</span> <span class="main">→</span> <span class="free">Rb</span> <span class="main">→</span> <span class="free">Ra</span> <span class="main">→</span> <span class="free">Rb</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fun_upd_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">parametricity</span><span class="main">)</span>


    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Boolean›</span></span>  
    
<span class="keyword1" id="Param_HOL-rec_bool_is_case"><span class="command">lemma</span></span> rec_bool_is_case<span class="main">:</span> <span class="quoted"><span class="quoted">"old.rec_bool <span class="main">=</span> case_bool"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bool.split<span class="main">)</span>

<span class="keyword1" id="Param_HOL-param_bool"><span class="command">lemma</span></span> param_bool<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>True<span class="main">,</span>True<span class="main">)</span><span class="main">∈</span>Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>False<span class="main">,</span>False<span class="main">)</span><span class="main">∈</span>Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>conj<span class="main">,</span>conj<span class="main">)</span><span class="main">∈</span>Id<span class="main">→</span>Id<span class="main">→</span>Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>disj<span class="main">,</span>disj<span class="main">)</span><span class="main">∈</span>Id<span class="main">→</span>Id<span class="main">→</span>Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Not<span class="main">,</span>Not<span class="main">)</span><span class="main">∈</span>Id<span class="main">→</span>Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>case_bool<span class="main">,</span>case_bool<span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">→</span><span class="free">R</span><span class="main">→</span>Id<span class="main">→</span><span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>old.rec_bool<span class="main">,</span>old.rec_bool<span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">→</span><span class="free">R</span><span class="main">→</span>Id<span class="main">→</span><span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(⟷)</span><span class="main">,</span> <span class="main">(⟷)</span><span class="main">)</span><span class="main">∈</span>Id<span class="main">→</span>Id<span class="main">→</span>Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(⟶)</span><span class="main">,</span> <span class="main">(⟶)</span><span class="main">)</span><span class="main">∈</span>Id<span class="main">→</span>Id<span class="main">→</span>Id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bool.split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rec_bool_is_case<span class="main">)</span>

<span class="keyword1" id="Param_HOL-param_and_cong1"><span class="command">lemma</span></span> param_and_cong1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">a'</span><span class="main">)</span><span class="main">∈</span>bool_rel<span class="main">;</span> <span class="main">⟦</span><span class="free">a</span><span class="main">;</span> <span class="free">a'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">b'</span><span class="main">)</span><span class="main">∈</span>bool_rel <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">∧</span><span class="free">b</span><span class="main">,</span><span class="free">a'</span><span class="main">∧</span><span class="free">b'</span><span class="main">)</span><span class="main">∈</span>bool_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1" id="Param_HOL-param_and_cong2"><span class="command">lemma</span></span> param_and_cong2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">a'</span><span class="main">)</span><span class="main">∈</span>bool_rel<span class="main">;</span> <span class="main">⟦</span><span class="free">a</span><span class="main">;</span> <span class="free">a'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">b'</span><span class="main">)</span><span class="main">∈</span>bool_rel <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">b</span><span class="main">∧</span><span class="free">a</span><span class="main">,</span><span class="free">b'</span><span class="main">∧</span><span class="free">a'</span><span class="main">)</span><span class="main">∈</span>bool_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Nat›</span></span>  
    
<span class="keyword1" id="Param_HOL-param_nat1"><span class="command">lemma</span></span> param_nat1<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">∈</span> Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc<span class="main">,</span> Suc<span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">∈</span> Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>numeral <span class="free">n</span><span class="main">::</span>nat<span class="main">,</span>numeral <span class="free">n</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">∈</span> Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(&lt;)</span><span class="main">,</span> <span class="main">(&lt;)</span> <span class="main">::</span>nat <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> Id <span class="main">→</span> Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(≤)</span><span class="main">,</span> <span class="main">(≤)</span> <span class="main">::</span>nat <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> Id <span class="main">→</span> Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span><span class="main">,</span> <span class="main">(=)</span> <span class="main">::</span>nat <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> Id <span class="main">→</span> Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(+)</span> <span class="main">::</span>nat<span class="main">⇒</span><span class="main">_</span><span class="main">,</span><span class="main">(+)</span><span class="main">)</span><span class="main">∈</span>Id<span class="main">→</span>Id<span class="main">→</span>Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(-)</span> <span class="main">::</span>nat<span class="main">⇒</span><span class="main">_</span><span class="main">,</span><span class="main">(-)</span><span class="main">)</span><span class="main">∈</span>Id<span class="main">→</span>Id<span class="main">→</span>Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(*)</span> <span class="main">::</span>nat<span class="main">⇒</span><span class="main">_</span><span class="main">,</span><span class="main">(*)</span><span class="main">)</span><span class="main">∈</span>Id<span class="main">→</span>Id<span class="main">→</span>Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">(div)</span> <span class="main">::</span>nat<span class="main">⇒</span><span class="main">_</span><span class="main">,</span><span class="keyword1">(div)</span><span class="main">)</span><span class="main">∈</span>Id<span class="main">→</span>Id<span class="main">→</span>Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">(mod)</span> <span class="main">::</span>nat<span class="main">⇒</span><span class="main">_</span><span class="main">,</span><span class="keyword1">(mod)</span><span class="main">)</span><span class="main">∈</span>Id<span class="main">→</span>Id<span class="main">→</span>Id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Param_HOL-param_case_nat"><span class="command">lemma</span></span> param_case_nat<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>case_nat<span class="main">,</span>case_nat<span class="main">)</span><span class="main">∈</span><span class="free">Ra</span> <span class="main">→</span> <span class="main">(</span>Id <span class="main">→</span> <span class="free">Ra</span><span class="main">)</span> <span class="main">→</span> Id <span class="main">→</span> <span class="free">Ra</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Param_HOL-param_rec_nat"><span class="command">lemma</span></span> param_rec_nat<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rec_nat<span class="main">,</span>rec_nat<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">→</span> <span class="main">(</span>Id <span class="main">→</span> <span class="free">R</span> <span class="main">→</span> <span class="free">R</span><span class="main">)</span> <span class="main">→</span> Id <span class="main">→</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">n</span> <span class="skolem">n'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_rel_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Int›</span></span>  
  
<span class="keyword1" id="Param_HOL-param_int"><span class="command">lemma</span></span> param_int<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">::</span>int<span class="main">)</span> <span class="main">∈</span> Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">::</span>int<span class="main">)</span> <span class="main">∈</span> Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>numeral <span class="free">n</span><span class="main">::</span>int<span class="main">,</span>numeral <span class="free">n</span><span class="main">::</span>int<span class="main">)</span> <span class="main">∈</span> Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(&lt;)</span><span class="main">,</span> <span class="main">(&lt;)</span> <span class="main">::</span>int <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> Id <span class="main">→</span> Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(≤)</span><span class="main">,</span> <span class="main">(≤)</span> <span class="main">::</span>int <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> Id <span class="main">→</span> Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span><span class="main">,</span> <span class="main">(=)</span> <span class="main">::</span>int <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> Id <span class="main">→</span> Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(+)</span> <span class="main">::</span>int<span class="main">⇒</span><span class="main">_</span><span class="main">,</span><span class="main">(+)</span><span class="main">)</span><span class="main">∈</span>Id<span class="main">→</span>Id<span class="main">→</span>Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(-)</span> <span class="main">::</span>int<span class="main">⇒</span><span class="main">_</span><span class="main">,</span><span class="main">(-)</span><span class="main">)</span><span class="main">∈</span>Id<span class="main">→</span>Id<span class="main">→</span>Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(*)</span> <span class="main">::</span>int<span class="main">⇒</span><span class="main">_</span><span class="main">,</span><span class="main">(*)</span><span class="main">)</span><span class="main">∈</span>Id<span class="main">→</span>Id<span class="main">→</span>Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">(div)</span> <span class="main">::</span>int<span class="main">⇒</span><span class="main">_</span><span class="main">,</span><span class="keyword1">(div)</span><span class="main">)</span><span class="main">∈</span>Id<span class="main">→</span>Id<span class="main">→</span>Id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">(mod)</span> <span class="main">::</span>int<span class="main">⇒</span><span class="main">_</span><span class="main">,</span><span class="keyword1">(mod)</span><span class="main">)</span><span class="main">∈</span>Id<span class="main">→</span>Id<span class="main">→</span>Id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Product›</span></span>  
    
<span class="keyword1" id="Param_HOL-param_unit"><span class="command">lemma</span></span> param_unit<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">()</span><span class="main">,</span><span class="main">()</span><span class="main">)</span><span class="main">∈</span>unit_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
<span class="keyword1" id="Param_HOL-rec_prod_is_case"><span class="command">lemma</span></span> rec_prod_is_case<span class="main">:</span> <span class="quoted"><span class="quoted">"old.rec_prod <span class="main">=</span> case_prod"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bool.split<span class="main">)</span>

<span class="keyword1" id="Param_HOL-param_prod"><span class="command">lemma</span></span> param_prod<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Pair<span class="main">,</span>Pair<span class="main">)</span><span class="main">∈</span><span class="free">Ra</span> <span class="main">→</span> <span class="free">Rb</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>prod_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>case_prod<span class="main">,</span>case_prod<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">Ra</span> <span class="main">→</span> <span class="free">Rb</span> <span class="main">→</span> <span class="free">Rr</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>prod_rel <span class="main">→</span> <span class="free">Rr</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>old.rec_prod<span class="main">,</span>old.rec_prod<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">Ra</span> <span class="main">→</span> <span class="free">Rb</span> <span class="main">→</span> <span class="free">Rr</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>prod_rel <span class="main">→</span> <span class="free">Rr</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>fst<span class="main">,</span>fst<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>prod_rel <span class="main">→</span> <span class="free">Ra</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>snd<span class="main">,</span>snd<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>prod_rel <span class="main">→</span> <span class="free">Rb</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split 
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_rel_def rec_prod_is_case<span class="main">)</span>

<span class="keyword1" id="Param_HOL-param_case_prod'"><span class="command">lemma</span></span> param_case_prod'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">p'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>prod_rel<span class="main">;</span>
     <span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">a'</span> <span class="bound">b'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">p</span><span class="main">=</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">;</span> <span class="free">p'</span><span class="main">=</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">b'</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span><span class="main">∈</span><span class="free">Ra</span><span class="main">;</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">b'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rb</span> <span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">,</span> <span class="free">f'</span> <span class="bound">a'</span> <span class="bound">b'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
    <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>case_prod <span class="free">f</span> <span class="free">p</span><span class="main">,</span> case_prod <span class="free">f'</span> <span class="free">p'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1" id="Param_HOL-param_case_prod''"><span class="command">lemma</span></span> param_case_prod''<span class="main">:</span> <span class="comment1">(* TODO: Really needed? *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> 
    <span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">a'</span> <span class="bound">b'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">p</span><span class="main">=</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">;</span> <span class="free">p'</span><span class="main">=</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">b'</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">,</span><span class="free">f'</span> <span class="bound">a'</span> <span class="bound">b'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>  
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>case_prod <span class="free">f</span> <span class="free">p</span><span class="main">,</span> case_prod <span class="free">f'</span> <span class="free">p'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>


<span class="keyword1" id="Param_HOL-param_map_prod"><span class="command">lemma</span></span> param_map_prod<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>map_prod<span class="main">,</span> map_prod<span class="main">)</span> 
  <span class="main">∈</span> <span class="main">(</span><span class="free">Ra</span><span class="main">→</span><span class="free">Rb</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">Rc</span><span class="main">→</span><span class="free">Rd</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rc</span><span class="main">⟩</span>prod_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">Rb</span><span class="main">,</span><span class="free">Rd</span><span class="main">⟩</span>prod_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_prod_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

<span class="keyword1" id="Param_HOL-param_apfst"><span class="command">lemma</span></span> param_apfst<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>apfst<span class="main">,</span>apfst<span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">Ra</span><span class="main">→</span><span class="free">Rb</span><span class="main">)</span><span class="main">→</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rc</span><span class="main">⟩</span>prod_rel<span class="main">→</span><span class="main">⟨</span><span class="free">Rb</span><span class="main">,</span><span class="free">Rc</span><span class="main">⟩</span>prod_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> apfst_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

<span class="keyword1" id="Param_HOL-param_apsnd"><span class="command">lemma</span></span> param_apsnd<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>apsnd<span class="main">,</span>apsnd<span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">Rb</span><span class="main">→</span><span class="free">Rc</span><span class="main">)</span><span class="main">→</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>prod_rel<span class="main">→</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rc</span><span class="main">⟩</span>prod_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> apsnd_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

<span class="keyword1" id="Param_HOL-param_curry"><span class="command">lemma</span></span> param_curry<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>curry<span class="main">,</span>curry<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>prod_rel <span class="main">→</span> <span class="free">Rc</span><span class="main">)</span> <span class="main">→</span> <span class="free">Ra</span> <span class="main">→</span> <span class="free">Rb</span> <span class="main">→</span> <span class="free">Rc</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> curry_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

<span class="keyword1" id="Param_HOL-param_uncurry"><span class="command">lemma</span></span> param_uncurry<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>uncurry<span class="main">,</span>uncurry<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">A</span><span class="main">→</span><span class="free">B</span><span class="main">→</span><span class="free">C</span><span class="main">)</span> <span class="main">→</span> <span class="free">A</span><span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span><span class="free">B</span><span class="main">→</span><span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> uncurry_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
    
<span class="keyword1" id="Param_HOL-param_prod_swap"><span class="command">lemma</span></span> param_prod_swap<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prod.swap<span class="main">,</span> prod.swap<span class="main">)</span><span class="main">∈</span><span class="free">A</span><span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span><span class="free">B</span> <span class="main">→</span> <span class="free">B</span><span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span><span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
<span class="keyword1"><span class="command">context</span></span> partial_function_definitions <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"monotone le_fun le_fun <span class="free">F</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> M'<span class="main">:</span> <span class="quoted"><span class="quoted">"monotone le_fun le_fun <span class="free">F'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> ADM<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"admissible <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Rb</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">a</span> <span class="bound">x</span><span class="main">,</span> fixp_fun <span class="free">F'</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ra</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> bot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Rb</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">lub</span> <span class="main">{}</span><span class="main">,</span> fixp_fun <span class="free">F'</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ra</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">F'</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">Rb</span><span class="main">→</span><span class="free">Ra</span><span class="main">)</span><span class="main">→</span><span class="free">Rb</span><span class="main">→</span><span class="free">Ra</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rb</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fixp_fun <span class="free">F</span> <span class="free">x</span><span class="main">,</span> fixp_fun <span class="free">F'</span> <span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">Ra</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">x'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ccpo.fixp_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccpo _ M<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ADM<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_lub_def bot<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ccpo.fixp_unfold<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ccpo M'<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">parametricity</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Option›</span></span>  

<span class="keyword1" id="Param_HOL-param_option"><span class="command">lemma</span></span> param_option<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>None<span class="main">,</span>None<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Some<span class="main">,</span>Some<span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>case_option<span class="main">,</span>case_option<span class="main">)</span><span class="main">∈</span><span class="free">Rr</span><span class="main">→</span><span class="main">(</span><span class="free">R</span> <span class="main">→</span> <span class="free">Rr</span><span class="main">)</span><span class="main">→</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel <span class="main">→</span> <span class="free">Rr</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rec_option<span class="main">,</span>rec_option<span class="main">)</span><span class="main">∈</span><span class="free">Rr</span><span class="main">→</span><span class="main">(</span><span class="free">R</span> <span class="main">→</span> <span class="free">Rr</span><span class="main">)</span><span class="main">→</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel <span class="main">→</span> <span class="free">Rr</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split 
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_rel_def case_option_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>
  
<span class="keyword1" id="Param_HOL-param_map_option"><span class="command">lemma</span></span> param_map_option<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map_option<span class="main">,</span> map_option<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">A</span> <span class="main">→</span> <span class="free">B</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>option_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span>option_rel"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option_relE <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Param_HOL-param_case_option'"><span class="command">lemma</span></span> param_case_option'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>option_rel<span class="main">;</span> 
     <span class="main">⟦</span><span class="free">x</span><span class="main">=</span>None<span class="main">;</span> <span class="free">x'</span><span class="main">=</span>None <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">fn</span><span class="main">,</span><span class="free">fn'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span>  
     <span class="main">⋀</span><span class="bound">v</span> <span class="bound">v'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">x</span><span class="main">=</span>Some <span class="bound">v</span><span class="main">;</span> <span class="free">x'</span><span class="main">=</span>Some <span class="bound">v'</span><span class="main">;</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">v'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rv</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">fs</span> <span class="bound">v</span><span class="main">,</span> <span class="free">fs'</span> <span class="bound">v'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
   <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>case_option <span class="free">fn</span> <span class="free">fs</span> <span class="free">x</span><span class="main">,</span> case_option <span class="free">fn'</span> <span class="free">fs'</span> <span class="free">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1" id="Param_HOL-the_paramL"><span class="command">lemma</span></span> the_paramL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">l</span><span class="main">≠</span>None<span class="main">;</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">r</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel<span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>the <span class="free">l</span><span class="main">,</span> the <span class="free">r</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> option_relE<span class="main">)</span>

<span class="keyword1" id="Param_HOL-the_paramR"><span class="command">lemma</span></span> the_paramR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">r</span><span class="main">≠</span>None<span class="main">;</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">r</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel<span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>the <span class="free">l</span><span class="main">,</span> the <span class="free">r</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> option_relE<span class="main">)</span>

<span class="keyword1" id="Param_HOL-the_default_param"><span class="command">lemma</span></span> the_default_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>the_default<span class="main">,</span> the_default<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel <span class="main">→</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> the_default_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sum›</span></span>  
    
<span class="keyword1" id="Param_HOL-rec_sum_is_case"><span class="command">lemma</span></span> rec_sum_is_case<span class="main">:</span> <span class="quoted"><span class="quoted">"old.rec_sum <span class="main">=</span> case_sum"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>

<span class="keyword1" id="Param_HOL-param_sum"><span class="command">lemma</span></span> param_sum<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Inl<span class="main">,</span>Inl<span class="main">)</span> <span class="main">∈</span> <span class="free">Rl</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Inr<span class="main">,</span>Inr<span class="main">)</span> <span class="main">∈</span> <span class="free">Rr</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>case_sum<span class="main">,</span>case_sum<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">Rl</span> <span class="main">→</span> <span class="free">R</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">Rr</span> <span class="main">→</span> <span class="free">R</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel <span class="main">→</span> <span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>old.rec_sum<span class="main">,</span>old.rec_sum<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">Rl</span> <span class="main">→</span> <span class="free">R</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">Rr</span> <span class="main">→</span> <span class="free">R</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel <span class="main">→</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD 
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rec_sum_is_case<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Param_HOL-param_case_sum'"><span class="command">lemma</span></span> param_case_sum'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel<span class="main">;</span>
     <span class="main">⋀</span><span class="bound">l</span> <span class="bound">l'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">s</span><span class="main">=</span>Inl <span class="bound">l</span><span class="main">;</span> <span class="free">s'</span><span class="main">=</span>Inl <span class="bound">l'</span><span class="main">;</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">l'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rl</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">fl</span> <span class="bound">l</span><span class="main">,</span> <span class="free">fl'</span> <span class="bound">l'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">s</span><span class="main">=</span>Inr <span class="bound">r</span><span class="main">;</span> <span class="free">s'</span><span class="main">=</span>Inr <span class="bound">r'</span><span class="main">;</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rr</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">fr</span> <span class="bound">r</span><span class="main">,</span> <span class="free">fr'</span> <span class="bound">r'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>
   <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>case_sum <span class="free">fl</span> <span class="free">fr</span> <span class="free">s</span><span class="main">,</span> case_sum <span class="free">fl'</span> <span class="free">fr'</span> <span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">is_Inl</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_Inl</span> <span class="main">(</span>Inl <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_Inl</span> <span class="main">(</span>Inr <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">is_Inr</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_Inr</span> <span class="main">(</span>Inr <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_Inr</span> <span class="main">(</span>Inl <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>

<span class="keyword1" id="Param_HOL-is_Inl_param"><span class="command">lemma</span></span> is_Inl_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>is_Inl<span class="main">,</span>is_Inl<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>sum_rel <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_Inl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
<span class="keyword1" id="Param_HOL-is_Inr_param"><span class="command">lemma</span></span> is_Inr_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>is_Inr<span class="main">,</span>is_Inr<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>sum_rel <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_Inr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

<span class="keyword1" id="Param_HOL-sum_projl_param"><span class="command">lemma</span></span> sum_projl_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_Inl <span class="free">s</span><span class="main">;</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>sum_rel<span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span>Sum_Type.sum.projl <span class="free">s'</span><span class="main">,</span>Sum_Type.sum.projl <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ra</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sum_relE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Param_HOL-sum_projr_param"><span class="command">lemma</span></span> sum_projr_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_Inr <span class="free">s</span><span class="main">;</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>sum_rel<span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span>Sum_Type.sum.projr <span class="free">s'</span><span class="main">,</span>Sum_Type.sum.projr <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Rb</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sum_relE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹List›</span></span>  
        
<span class="keyword1" id="Param_HOL-list_rel_append1"><span class="command">lemma</span></span> list_rel_append1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">bs</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel 
  <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">cs</span> <span class="bound">ds</span><span class="main">.</span> <span class="free">l</span> <span class="main">=</span> <span class="bound">cs</span><span class="main">@</span><span class="bound">ds</span> <span class="main">∧</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span><span class="bound">cs</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">∧</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span><span class="bound">ds</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_rel_def list_all2_append1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> list_all2_lengthD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Param_HOL-list_rel_append2"><span class="command">lemma</span></span> list_rel_append2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">as</span> <span class="main">@</span> <span class="free">bs</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel 
  <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">cs</span> <span class="bound">ds</span><span class="main">.</span> <span class="free">l</span> <span class="main">=</span> <span class="bound">cs</span><span class="main">@</span><span class="bound">ds</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">cs</span><span class="main">,</span><span class="free">as</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">∧</span> <span class="main">(</span><span class="bound">ds</span><span class="main">,</span><span class="free">bs</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_rel_def list_all2_append2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> list_all2_lengthD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="Param_HOL-param_append"><span class="command">lemma</span></span> param_append<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>append<span class="main">,</span> append<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_def list_all2_appendI<span class="main">)</span>

<span class="keyword1" id="Param_HOL-param_list1"><span class="command">lemma</span></span> param_list1<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Nil<span class="main">,</span>Nil<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Cons<span class="main">,</span>Cons<span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>case_list<span class="main">,</span>case_list<span class="main">)</span><span class="main">∈</span><span class="free">Rr</span><span class="main">→</span><span class="main">(</span><span class="free">R</span><span class="main">→</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel<span class="main">→</span><span class="free">Rr</span><span class="main">)</span><span class="main">→</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel<span class="main">→</span><span class="free">Rr</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Param_HOL-param_rec_list"><span class="command">lemma</span></span> param_rec_list<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rec_list<span class="main">,</span>rec_list<span class="main">)</span> 
  <span class="main">∈</span> <span class="free">Ra</span> <span class="main">→</span> <span class="main">(</span><span class="free">Rb</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rb</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="free">Ra</span> <span class="main">→</span> <span class="free">Ra</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rb</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="free">Ra</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">a</span> <span class="skolem">a'</span> <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">l</span> <span class="skolem">l'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">a'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Param_HOL-param_case_list'"><span class="command">lemma</span></span> param_case_list'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">l'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Rb</span><span class="main">⟩</span>list_rel<span class="main">;</span>
     <span class="main">⟦</span><span class="free">l</span><span class="main">=</span><span class="main">[]</span><span class="main">;</span> <span class="free">l'</span><span class="main">=</span><span class="main">[]</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span><span class="free">n'</span><span class="main">)</span><span class="main">∈</span><span class="free">Ra</span><span class="main">;</span>  
     <span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span> <span class="bound">x'</span> <span class="bound">xs'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">l</span><span class="main">=</span><span class="bound">x</span><span class="main">#</span><span class="bound">xs</span><span class="main">;</span> <span class="free">l'</span><span class="main">=</span><span class="bound">x'</span><span class="main">#</span><span class="bound">xs'</span><span class="main">;</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rb</span><span class="main">;</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">xs'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Rb</span><span class="main">⟩</span>list_rel <span class="main">⟧</span> 
     <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span> <span class="bound">x</span> <span class="bound">xs</span><span class="main">,</span> <span class="free">c'</span> <span class="bound">x'</span> <span class="bound">xs'</span><span class="main">)</span><span class="main">∈</span><span class="free">Ra</span>
   <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>case_list <span class="free">n</span> <span class="free">c</span> <span class="free">l</span><span class="main">,</span> case_list <span class="free">n'</span> <span class="free">c'</span> <span class="free">l'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ra</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split<span class="main">)</span>
    
<span class="keyword1" id="Param_HOL-param_map"><span class="command">lemma</span></span> param_map<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>map<span class="main">,</span>map<span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">R1</span><span class="main">→</span><span class="free">R2</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R1</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R2</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_rec<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">parametricity</span><span class="main">)</span>
    
<span class="keyword1" id="Param_HOL-param_fold"><span class="command">lemma</span></span> param_fold<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>fold<span class="main">,</span>fold<span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">Re</span><span class="main">→</span><span class="free">Rs</span><span class="main">→</span><span class="free">Rs</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="free">Rs</span> <span class="main">→</span> <span class="free">Rs</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>foldl<span class="main">,</span>foldl<span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">Rs</span><span class="main">→</span><span class="free">Re</span><span class="main">→</span><span class="free">Rs</span><span class="main">)</span> <span class="main">→</span> <span class="free">Rs</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="free">Rs</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>foldr<span class="main">,</span>foldr<span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">Re</span><span class="main">→</span><span class="free">Rs</span><span class="main">→</span><span class="free">Rs</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="free">Rs</span> <span class="main">→</span> <span class="free">Rs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> List.fold_def List.foldr_def List.foldl_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">parametricity</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1" id="Param_HOL-param_list_all"><span class="command">lemma</span></span> param_list_all<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>list_all<span class="main">,</span>list_all<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">A</span><span class="main">→</span>bool_rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_rel <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> rel2p_def<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">rel2p</span></span> List.list_all_transfer<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">list_all2_alt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">list_all2_alt</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">list_all2_alt</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> False <span class="main">|</span> <span class="bound">y</span><span class="main">#</span><span class="bound">ys</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">list_all2_alt</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="bound">ys</span><span class="main">)</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Param_HOL-list_all2_alt"><span class="command">lemma</span></span> list_all2_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> list_all2_alt <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
  
  <span class="keyword1" id="Param_HOL-param_list_all2"><span class="command">lemma</span></span> param_list_all2<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>list_all2<span class="main">,</span> list_all2<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">A</span><span class="main">→</span><span class="free">B</span><span class="main">→</span>bool_rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span>list_rel <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_all2_alt<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> list_all2_alt_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  
<span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword1" id="Param_HOL-param_hd"><span class="command">lemma</span></span> param_hd<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">≠</span><span class="main">[]</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">l'</span><span class="main">,</span><span class="free">l</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_rel <span class="main">⟹</span> <span class="main">(</span>hd <span class="free">l'</span><span class="main">,</span> hd <span class="free">l</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> hd_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

<span class="keyword1" id="Param_HOL-param_last"><span class="command">lemma</span></span> param_last<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_rel"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>last <span class="free">x</span><span class="main">,</span> last <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_rel_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Param_HOL-param_rotate1"><span class="command">lemma</span></span> param_rotate1<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rotate1<span class="main">,</span> rotate1<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rotate1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
    
<span class="keyword1"><span class="command">schematic_goal</span></span> param_take<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take<span class="main">,</span>take<span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="var">?R</span><span class="main">::</span><span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="main">_</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> take_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">parametricity</span><span class="main">)</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> param_drop<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drop<span class="main">,</span>drop<span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="var">?R</span><span class="main">::</span><span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="main">_</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> drop_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">parametricity</span><span class="main">)</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> param_length<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>length<span class="main">,</span>length<span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="var">?R</span><span class="main">::</span><span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="main">_</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> size_list_overloaded_def size_list_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">parametricity</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">list_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">⟷</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">list_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span> 
     <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="keyword1">then</span> <span class="free">list_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="keyword1">else</span> False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">list_eq</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> False"</span></span>

<span class="keyword1" id="Param_HOL-param_list_eq"><span class="command">lemma</span></span> param_list_eq<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span>list_eq<span class="main">,</span>list_eq<span class="main">)</span> <span class="main">∈</span> 
    <span class="main">(</span><span class="free">R</span> <span class="main">→</span> <span class="free">R</span> <span class="main">→</span> Id<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> Id"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">eq</span> <span class="skolem">eq'</span> <span class="skolem">l1</span> <span class="skolem">l1'</span> <span class="skolem">l2</span> <span class="skolem">l2'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">eq'</span></span> <span class="quoted"><span class="skolem">l1'</span></span> <span class="quoted"><span class="skolem">l2'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">l2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_eq.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> list_eq.simps <span class="main"><span class="keyword3">|</span></span>
      <span class="operator">elim</span> list_relE <span class="main"><span class="keyword3">|</span></span>
      <span class="operator">parametricity</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Param_HOL-id_list_eq_aux"><span class="command">lemma</span></span> id_list_eq_aux<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>list_eq <span class="main">(=)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(=)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_eq <span class="main">(=)</span> <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l1</span> <span class="main">=</span> <span class="skolem">l2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">l2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_eq.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Param_HOL-param_list_equals"><span class="command">lemma</span></span> param_list_equals<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="main">(=)</span><span class="main">,</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">→</span><span class="free">R</span><span class="main">→</span>Id <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span><span class="main">(=)</span><span class="main">,</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> Id"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> id_list_eq_aux<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">parametricity</span><span class="main">)</span> 

<span class="keyword1" id="Param_HOL-param_tl"><span class="command">lemma</span></span> param_tl<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>tl<span class="main">,</span>tl<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tl_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">parametricity</span><span class="main">)</span>


<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">list_all_rec</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_all_rec</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">[]</span> <span class="main">⟷</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">list_all_rec</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∧</span> <span class="free">list_all_rec</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">list_ex_rec</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_ex_rec</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">[]</span> <span class="main">⟷</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">list_ex_rec</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∨</span> <span class="free">list_ex_rec</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1" id="Param_HOL-list_all_rec_eq"><span class="command">lemma</span></span> list_all_rec_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">l</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> list_all_rec <span class="free">P</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Param_HOL-list_ex_rec_eq"><span class="command">lemma</span></span> list_ex_rec_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">l</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> list_ex_rec <span class="free">P</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Param_HOL-param_list_ball"><span class="command">lemma</span></span> param_list_ball<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">P</span><span class="main">,</span><span class="free">P'</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">Ra</span><span class="main">→</span>Id<span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">l'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span> list_rel<span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">l</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">,</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">l'</span><span class="main">.</span> <span class="free">P'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> Id"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> list_all_rec_eq
  <span class="keyword1"><span class="command">unfolding</span></span> list_all_rec_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">parametricity</span><span class="main">)</span>

<span class="keyword1" id="Param_HOL-param_list_bex"><span class="command">lemma</span></span> param_list_bex<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">P</span><span class="main">,</span><span class="free">P'</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">Ra</span><span class="main">→</span>Id<span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">l'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span> list_rel<span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">l</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">,</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">l'</span><span class="main">.</span> <span class="free">P'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> Id"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> list_ex_rec_eq<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> list_ex_rec_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">parametricity</span><span class="main">)</span>

<span class="keyword1" id="Param_HOL-param_rev"><span class="command">lemma</span></span> param_rev<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rev<span class="main">,</span>rev<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rev_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">parametricity</span><span class="main">)</span>
  
<span class="keyword1" id="Param_HOL-param_foldli"><span class="command">lemma</span></span> param_foldli<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>foldli<span class="main">,</span> foldli<span class="main">)</span> 
  <span class="main">∈</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">(</span><span class="free">Rs</span><span class="main">→</span>Id<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">Re</span><span class="main">→</span><span class="free">Rs</span><span class="main">→</span><span class="free">Rs</span><span class="main">)</span> <span class="main">→</span> <span class="free">Rs</span> <span class="main">→</span> <span class="free">Rs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> foldli_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

<span class="keyword1" id="Param_HOL-param_foldri"><span class="command">lemma</span></span> param_foldri<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>foldri<span class="main">,</span> foldri<span class="main">)</span> 
  <span class="main">∈</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">(</span><span class="free">Rs</span><span class="main">→</span>Id<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">Re</span><span class="main">→</span><span class="free">Rs</span><span class="main">→</span><span class="free">Rs</span><span class="main">)</span> <span class="main">→</span> <span class="free">Rs</span> <span class="main">→</span> <span class="free">Rs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> foldri_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

<span class="keyword1" id="Param_HOL-param_nth"><span class="command">lemma</span></span> param_nth<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i'</span><span class="main">&lt;</span>length <span class="free">l'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">i'</span><span class="main">)</span><span class="main">∈</span>nat_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> LR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">l'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="free">i</span><span class="main">,</span><span class="free">l'</span><span class="main">!</span><span class="free">i'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> LR I IR
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">i'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_rel_induct<span class="main">)</span> 
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1" id="Param_HOL-param_replicate"><span class="command">lemma</span></span> param_replicate<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>replicate<span class="main">,</span>replicate<span class="main">)</span> <span class="main">∈</span> nat_rel <span class="main">→</span> <span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> replicate_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

<span class="keyword1"><span class="command">term</span></span> <span class="quoted">list_update</span>
<span class="keyword1" id="Param_HOL-param_list_update"><span class="command">lemma</span></span> param_list_update<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>list_update<span class="main">,</span>list_update<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span>list_rel <span class="main">→</span> nat_rel <span class="main">→</span> <span class="free">Ra</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> list_update_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

<span class="keyword1" id="Param_HOL-param_zip"><span class="command">lemma</span></span> param_zip<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>zip<span class="main">,</span> zip<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">Rb</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>prod_rel<span class="main">⟩</span>list_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> zip_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

<span class="keyword1" id="Param_HOL-param_upt"><span class="command">lemma</span></span> param_upt<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>upt<span class="main">,</span> upt<span class="main">)</span> <span class="main">∈</span> nat_rel <span class="main">→</span> nat_rel <span class="main">→</span> <span class="main">⟨</span>nat_rel<span class="main">⟩</span>list_rel"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> upt_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

<span class="keyword1" id="Param_HOL-param_concat"><span class="command">lemma</span></span> param_concat<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>concat<span class="main">,</span> concat<span class="main">)</span> <span class="main">∈</span> 
    <span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel<span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> concat_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

<span class="keyword1" id="Param_HOL-param_all_interval_nat"><span class="command">lemma</span></span> param_all_interval_nat<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>List.all_interval_nat<span class="main">,</span> List.all_interval_nat<span class="main">)</span> 
  <span class="main">∈</span> <span class="main">(</span>nat_rel <span class="main">→</span> bool_rel<span class="main">)</span> <span class="main">→</span> nat_rel <span class="main">→</span> nat_rel <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> List.all_interval_nat_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">parametricity</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Param_HOL-param_dropWhile"><span class="command">lemma</span></span> param_dropWhile<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>dropWhile<span class="main">,</span> dropWhile<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">a</span> <span class="main">→</span> bool_rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">a</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">a</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dropWhile_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

<span class="keyword1" id="Param_HOL-param_takeWhile"><span class="command">lemma</span></span> param_takeWhile<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>takeWhile<span class="main">,</span> takeWhile<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">a</span> <span class="main">→</span> bool_rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">a</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">a</span><span class="main">⟩</span>list_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> takeWhile_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Parametricity">
<div class="head">
<h1>Theory Parametricity</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Parametricity
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Param_Tool.html">Param_Tool</a> <a href="Param_HOL.html">Param_HOL</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Autoref_Phases">
<div class="head">
<h1>Theory Autoref_Phases</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Infrastructure for Multi-Phase Methods›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Autoref_Phases
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Refine_Lib.html">../Lib/Refine_Lib</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹

  <span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">AUTOREF_PHASES</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">phase</span> <span class="main">=</span> <span class="main">{</span>
      init<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span><span class="main">,</span>
      tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic<span class="main">,</span>
      analyze<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> int <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> bool<span class="main">,</span>
      pretty_failure<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> int <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> Pretty.T
    <span class="main">}</span>

    <span class="keyword1"><span class="keyword">val</span></span> register_phase<span class="main">:</span> string <span class="main">-&gt;</span> int <span class="main">-&gt;</span> <span class="entity">phase</span> <span class="main">-&gt;</span>
      morphism <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
    <span class="keyword1"><span class="keyword">val</span></span> delete_phase<span class="main">:</span> string <span class="main">-&gt;</span> morphism <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
    <span class="keyword1"><span class="keyword">val</span></span> get_phases<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="main">(</span>string * int * <span class="entity">phase</span><span class="main">)</span> list

    <span class="keyword1"><span class="keyword">val</span></span> get_phase<span class="main">:</span> string <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="main">(</span>string * int * <span class="entity">phase</span><span class="main">)</span> option

    <span class="keyword1"><span class="keyword">val</span></span> init_phase<span class="main">:</span> <span class="main">(</span>string * int * <span class="entity">phase</span><span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span>
    <span class="keyword1"><span class="keyword">val</span></span> init_phases<span class="main">:</span> 
      <span class="main">(</span>string * int * <span class="entity">phase</span><span class="main">)</span> list <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span>

    <span class="keyword1"><span class="keyword">val</span></span> init_data<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span>

    <span class="keyword1"><span class="keyword">val</span></span> declare_solver<span class="main">:</span> thm list <span class="main">-&gt;</span> binding <span class="main">-&gt;</span> string
      <span class="main">-&gt;</span> <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span><span class="main">)</span> <span class="main">-&gt;</span> morphism
      <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic

    <span class="keyword1"><span class="keyword">val</span></span> phase_tac<span class="main">:</span> <span class="main">(</span>string * int * <span class="entity">phase</span><span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> phases_tac<span class="main">:</span> <span class="main">(</span>string * int * <span class="entity">phase</span><span class="main">)</span> list <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> all_phases_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>

    <span class="keyword1"><span class="keyword">val</span></span> phases_tacN<span class="main">:</span> string list <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> phase_tacN<span class="main">:</span> string <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>

    <span class="keyword1"><span class="keyword">val</span></span> cfg_debug<span class="main">:</span> bool Config.T
    <span class="keyword1"><span class="keyword">val</span></span> cfg_trace<span class="main">:</span> bool Config.T
    <span class="keyword1"><span class="keyword">val</span></span> cfg_keep_goal<span class="main">:</span> bool Config.T

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Autoref_Phases</span> <span class="main">:</span><span class="entity">AUTOREF_PHASES</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">phase</span> <span class="main">=</span> <span class="main">{</span>
      init<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span><span class="main">,</span>
      tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic<span class="main">,</span>
      analyze<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> int <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> bool<span class="main">,</span>
      pretty_failure<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> int <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> Pretty.T
    <span class="main">}</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">phase_order</span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">i1</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">i2</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>int_ord <span class="main">(</span><span class="entity">i1</span><span class="main">,</span><span class="entity">i2</span><span class="main">)</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">phase_data</span> <span class="main">=</span> Generic_Data <span class="main">(</span>
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="main">(</span>string * int * <span class="entity">phase</span><span class="main">)</span> list
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">merge</span> <span class="main">=</span> Ord_List.merge <span class="entity">phase_order</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I
    <span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cfg_debug</span> <span class="main">=</span> <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_dbg<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cfg_trace</span> <span class="main">=</span> <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_trace<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cfg_keep_goal</span> <span class="main">=</span> 
      <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_keep_goal<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">register_phase</span> <span class="entity">n</span> <span class="entity">i</span> <span class="entity">p</span> <span class="main">_</span> <span class="main">=</span> 
      phase_data.map <span class="main">(</span>Ord_List.insert <span class="entity">phase_order</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="entity">i</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">delete_phase</span> <span class="entity">n</span> <span class="main">_</span> <span class="main">=</span> 
      phase_data.map <span class="main">(</span>filter <span class="main">(</span>curry <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">n</span> o <span class="main">#</span><span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">get_phases</span> <span class="main">=</span> phase_data.get o Context.Proof

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_phase</span> <span class="entity">name</span> <span class="entity">ctxt</span> <span class="main">=</span> phase_data.get <span class="main">(</span>Context.Proof <span class="entity">ctxt</span><span class="main">)</span> 
      |&gt; find_first <span class="main">(</span>curry <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">name</span> o <span class="main">#</span><span class="inner_numeral">1</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">init_phase</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="main">#</span>init <span class="entity">p</span> <span class="entity">ctxt</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">init_phases</span> <span class="main">=</span> fold <span class="entity">init_phase</span> 

    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">autoref_state</span> <span class="main">=</span> Proof_Data <span class="main">(</span>
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> bool
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">init</span> <span class="main">_</span> <span class="main">=</span> false
    <span class="main">)</span>

    <span class="comment1">(* TODO: Workaround to have enough data for solvers in context *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">init_data</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> autoref_state.get <span class="entity">ctxt</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">ctxt</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">init_phases</span> <span class="main">(</span><span class="entity">get_phases</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> autoref_state.put true <span class="entity">ctxt</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">ctxt</span> <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">declare_solver</span> <span class="entity">triggers</span> <span class="entity">name</span> <span class="entity">desc</span> <span class="entity">tac</span> <span class="entity">phi</span> <span class="entity">context</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name_s</span> <span class="main">=</span> Morphism.binding <span class="entity">phi</span> <span class="entity">name</span> |&gt;
        Context.cases Sign.full_name Proof_Context.full_name <span class="entity">context</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tac'</span> <span class="entity">ctxt</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">if</span></span> autoref_state.get <span class="entity">ctxt</span> <span class="keyword2"><span class="keyword">then</span></span> 
          <span class="entity">tac</span> <span class="entity">ctxt</span>
        <span class="keyword2"><span class="keyword">else</span></span> 
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> warning <span class="main">(</span><span class="inner_quoted">"Autoref-Solver "</span> ^ <span class="entity">name_s</span> 
              ^ <span class="inner_quoted">" invoked outside autoref context."</span> 
              ^ <span class="inner_quoted">" Initializing new context (slow)"</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span> 
            <span class="entity">tac</span> <span class="main">(</span><span class="entity">init_data</span> <span class="entity">ctxt</span><span class="main">)</span> 
          <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">Tagged_Solver.declare_solver</span> <span class="entity">triggers</span> <span class="entity">name</span> <span class="entity">desc</span> <span class="entity">tac'</span> <span class="entity">phi</span> <span class="entity">context</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword2"><span class="keyword">local</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">handle_fail_tac</span> <span class="entity">pname</span> <span class="entity">p</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">j</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">dbg_info</span> <span class="main">=</span> Config.get <span class="entity">ctxt</span> <span class="entity">cfg_debug</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">keep_goal</span> <span class="main">=</span> Config.get <span class="entity">ctxt</span> <span class="entity">cfg_keep_goal</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prt_term</span> <span class="main">=</span> Syntax.pretty_term <span class="entity">ctxt</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty_subgoal</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">A</span><span class="main">)</span> <span class="main">=</span>
          Pretty.markup <span class="main">(</span>Markup.subgoal <span class="inner_quoted">""</span><span class="main">)</span>
            <span class="main">[</span>Pretty.str <span class="main">(</span><span class="inner_quoted">" "</span> ^ string_of_int <span class="entity">n</span> ^ <span class="inner_quoted">". "</span><span class="main">)</span><span class="main">,</span> <span class="entity">prt_term</span> <span class="entity">A</span><span class="main">]</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty_subgoals</span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">As</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=</span> Logic.strip_horn <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">As</span> <span class="main">=</span> drop <span class="main">(</span><span class="entity">i</span> - <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">As</span> |&gt; take <span class="main">(</span><span class="entity">j</span> - <span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">in</span></span> 
          map <span class="entity">pretty_subgoal</span> <span class="main">(</span><span class="inner_numeral">1</span> upto length <span class="entity">As</span> ~~ <span class="entity">As</span><span class="main">)</span> 
          |&gt; Pretty.fbreaks |&gt; Pretty.block
        <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">dbg_info</span> <span class="keyword2"><span class="keyword">then</span></span> 
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pt</span> <span class="main">=</span> <span class="main">#</span>pretty_failure <span class="entity">p</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">j</span> <span class="entity">st</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> tracing <span class="main">(</span><span class="inner_quoted">"Phase \""</span> ^ <span class="entity">pname</span> ^ <span class="inner_quoted">"\" failed"</span>  <span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> tracing <span class="main">(</span>Pretty.string_of <span class="entity">pt</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> tracing <span class="inner_quoted">"Remaining goals:"</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> tracing <span class="main">(</span>Pretty.string_of <span class="main">(</span><span class="entity">pretty_subgoals</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span><span class="main">;</span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">keep_goal</span> <span class="keyword2"><span class="keyword">then</span></span> Seq.single <span class="entity">st</span> <span class="keyword2"><span class="keyword">else</span></span> Seq.empty
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ite_succeed_tac</span> <span class="entity">p</span> <span class="entity">tac1</span> <span class="entity">tac2</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">j</span> <span class="entity">st</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">if</span></span> <span class="main">#</span>analyze <span class="entity">p</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">j</span> <span class="entity">st</span> <span class="keyword2"><span class="keyword">then</span></span>
          <span class="entity">tac1</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">j</span> <span class="entity">st</span>
        <span class="keyword2"><span class="keyword">else</span></span> 
          <span class="entity">tac2</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">j</span> <span class="entity">st</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">do_phase</span> <span class="main">(</span><span class="entity">pname</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="entity">tac1</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">do_trace</span> <span class="main">=</span> Config.get <span class="entity">ctxt</span> <span class="entity">cfg_trace</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tr</span> <span class="entity">msg</span> <span class="entity">tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">j</span> <span class="entity">st</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">do_trace</span> <span class="keyword2"><span class="keyword">then</span></span>
          tracing <span class="entity">msg</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span><span class="main">;</span> <span class="entity">tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">j</span> <span class="entity">st</span><span class="main">)</span>

        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ptac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">=</span> DETERM <span class="main">(</span><span class="main">#</span>tac <span class="entity">p</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">j</span><span class="main">)</span>
          THEN <span class="main">(</span><span class="main">(</span>PRIMITIVE <span class="main">(</span>Drule.zero_var_indexes<span class="main">)</span><span class="main">)</span><span class="main">)</span>

        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">timed_ptac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tac</span> <span class="main">=</span> <span class="entity">ptac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">j</span>
        <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">start</span> <span class="main">=</span> Timing.start <span class="main">(</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="entity">tac</span> <span class="entity">st</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">timing</span> <span class="main">=</span> Timing.result <span class="entity">start</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">do_trace</span> <span class="keyword2"><span class="keyword">then</span></span> Timing.message <span class="entity">timing</span> |&gt; tracing <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> 
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="entity">res</span>
          <span class="keyword2"><span class="keyword">end</span></span>
        <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="main">(</span> <span class="entity">tr</span> <span class="main">(</span><span class="inner_quoted">"Phase \""</span> ^ <span class="entity">pname</span> ^ <span class="inner_quoted">"\""</span><span class="main">)</span> <span class="entity">timed_ptac</span> <span class="entity">ctxt</span><span class="main">)</span>
        <span class="entity">THEN_INTERVAL</span> 
          <span class="entity">ite_succeed_tac</span> <span class="entity">p</span>
            <span class="main">(</span> <span class="entity">tr</span> <span class="main">(</span><span class="inner_quoted">"Success (Phase \""</span> ^ <span class="entity">pname</span> ^ <span class="inner_quoted">"\")"</span><span class="main">)</span> <span class="entity">tac1</span><span class="main">)</span> 
            <span class="main">(</span> <span class="entity">tr</span> <span class="main">(</span><span class="inner_quoted">"Fail (Phase \""</span> ^ <span class="entity">pname</span> ^ <span class="inner_quoted">"\")"</span><span class="main">)</span> <span class="main">(</span><span class="entity">handle_fail_tac</span> <span class="entity">pname</span> <span class="entity">p</span><span class="main">)</span><span class="main">)</span>
            <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">end</span></span>
        
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">do_phases</span> <span class="main">[</span><span class="main">]</span> <span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> Seq.single<span class="main">)</span>
        <span class="main">|</span> <span class="entity">do_phases</span> <span class="main">(</span><span class="entity">p</span>::<span class="entity">ps</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">do_phase</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">do_phases</span> <span class="entity">ps</span><span class="main">)</span> <span class="entity">ctxt</span>


      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_sorted</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> true
        <span class="main">|</span> <span class="entity">is_sorted</span> <span class="main">_</span> <span class="main">[</span><span class="main">_</span><span class="main">]</span> <span class="main">=</span> true
        <span class="main">|</span> <span class="entity">is_sorted</span> <span class="entity">ord</span> <span class="main">(</span><span class="entity">a</span>::<span class="entity">b</span>::<span class="entity">l</span><span class="main">)</span> <span class="main">=</span> 
            <span class="entity">ord</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span> &lt;&gt; GREATER <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">is_sorted</span> <span class="entity">ord</span> <span class="main">(</span><span class="entity">b</span>::<span class="entity">l</span><span class="main">)</span>

    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">phase_tac</span> <span class="entity">p</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">init_phase</span> <span class="entity">p</span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">SINGLE_INTERVAL</span>
          <span class="main">(</span><span class="entity">do_phase</span> <span class="entity">p</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> all_tac<span class="main">)</span> <span class="entity">ctxt</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">phases_tac</span> <span class="entity">ps</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">init_phases</span> <span class="entity">ps</span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">SINGLE_INTERVAL</span> <span class="main">(</span><span class="entity">do_phases</span> <span class="entity">ps</span> <span class="entity">ctxt</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">all_phases_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">phases_tac</span> <span class="main">(</span><span class="entity">get_phases</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">ctxt</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_phase_err</span> <span class="entity">ctxt</span> <span class="entity">name</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">get_phase</span> <span class="entity">name</span> <span class="entity">ctxt</span> <span class="keyword2"><span class="keyword">of</span></span>
        NONE <span class="main">=&gt;</span> error <span class="main">(</span><span class="inner_quoted">"Unknown phase: "</span> ^ <span class="entity">name</span><span class="main">)</span>
      <span class="main">|</span> SOME <span class="entity">p</span> <span class="main">=&gt;</span> <span class="entity">p</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">phase_tacN</span> <span class="entity">name</span> <span class="entity">ctxt</span> <span class="main">=</span> 
        <span class="entity">phase_tac</span> <span class="main">(</span><span class="entity">get_phase_err</span> <span class="entity">ctxt</span> <span class="entity">name</span><span class="main">)</span> <span class="entity">ctxt</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">phases_tacN</span> <span class="entity">names</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ps</span> <span class="main">=</span> map <span class="main">(</span><span class="entity">get_phase_err</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">names</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_sorted</span> <span class="entity">phase_order</span> <span class="entity">ps</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="main">)</span> 
          <span class="keyword2"><span class="keyword">else</span></span> warning <span class="inner_quoted">"Non-standard phase order"</span>
          
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">phases_tac</span> <span class="entity">ps</span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">end</span></span> 
  
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>

›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Autoref_Data">
<div class="head">
<h1>Theory Autoref_Data</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Autoref_Data
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="Refine_Util.html">../Lib/Refine_Util</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">AUTOREF_DATA</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span>
    <span class="keyword1"><span class="keyword">exception</span></span> exNULL
    <span class="keyword1"><span class="keyword">exception</span></span> exCIRCULAR
    <span class="keyword1"><span class="keyword">val</span></span> get<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">T</span>
    <span class="keyword1"><span class="keyword">val</span></span> init<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">functor</span></span> <span class="entity">Autoref_Data</span> <span class="main">(</span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span>
    <span class="keyword1"><span class="keyword">val</span></span> compute<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">T</span>
    <span class="keyword1"><span class="keyword">val</span></span> prereq<span class="main">:</span> <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span><span class="main">)</span> list
  <span class="main">)</span> <span class="main">:</span> <span class="entity">AUTOREF_DATA</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="entity">T</span>
    <span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">state</span> <span class="main">=</span> <span class="entity">NULL</span> <span class="main">|</span> <span class="entity">INITIALIZING</span> <span class="main">|</span> <span class="entity">INIT</span> <span class="keyword2"><span class="keyword">of</span></span> T
    <span class="keyword1"><span class="keyword">exception</span></span> <span class="entity">exNULL</span>
    <span class="keyword1"><span class="keyword">exception</span></span> <span class="entity">exCIRCULAR</span>

    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">data</span> <span class="main">=</span> Proof_Data <span class="main">(</span> 
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="entity">state</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">init</span> <span class="main">_</span> <span class="main">=</span> <span class="entity">NULL</span>
    <span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> data.get <span class="entity">ctxt</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="entity">NULL</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> <span class="entity">exNULL</span>
    <span class="main">|</span> <span class="entity">INITIALIZING</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> <span class="entity">exCIRCULAR</span>
    <span class="main">|</span> <span class="entity">INIT</span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">x</span>
      
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">init</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> data.get <span class="entity">ctxt</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="entity">INITIALIZING</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> <span class="entity">exCIRCULAR</span>
    <span class="main">|</span> <span class="entity">INIT</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">ctxt</span>
    <span class="main">|</span> <span class="entity">NULL</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> data.put <span class="entity">INITIALIZING</span> <span class="entity">ctxt</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">f</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">prereq</span> <span class="entity">ctxt</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> data.put <span class="main">(</span><span class="entity">INIT</span> <span class="main">(</span><span class="entity">compute</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="entity">ctxt</span>
        <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Autoref_Tagging">
<div class="head">
<h1>Theory Autoref_Tagging</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Tagging of Terms›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Autoref_Tagging
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Refine_Lib.html">../Lib/Refine_Lib</a>"</span> 
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We provide a mechanism to tag terms, that supports relator annotations,
  and introduces tags to protect operations, function applications, and 
  abstractions from automatic beta and eta conversions.
›</span></span>


<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Autoref_Tag_Defs</span> <span class="main">=</span> <span class="entity">Named_Thms</span> <span class="main">(</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_tag_defs<span class="antiquote">}</span></span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Autoref: Definitions of internal tags"</span>
  <span class="main">)</span>
›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="entity">Autoref_Tag_Defs.setup</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹General protection tag›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PROTECT</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">autoref_tag_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">PROTECT</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹General annotation tag›</span></span>
<span class="keyword1"><span class="command">typedecl</span></span> annot
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ANNOT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> annot <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">autoref_tag_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ANNOT</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Operation-tag, Autoref does not look beyond this›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">OP</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">autoref_tag_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">OP</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protected function application›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">APP</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">$</span>"</span> 900<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">autoref_tag_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main"><span class="free">$</span></span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protected abstraction›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ABS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'b</span><span class="main">)</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">binder</span></span> <span class="quoted">"<span class="keyword1">λ''</span>"</span> 10<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ABS</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> PROTECT <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> PROTECT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1" id="Autoref_Tagging-ABS_beta"><span class="command">lemma</span></span> ABS_beta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ'</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">$</span><span class="free">x</span> <span class="main">≡</span> <span class="free">f</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1" id="Autoref_Tagging-ABS_eta"><span class="command">lemma</span></span> ABS_eta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">λ'</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">$</span><span class="bound">x</span><span class="main">)</span> <span class="main">≡</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This tag is used to highlight failures during operation 
  identification›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ID_FAIL</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> ID_FAIL <span class="main">(</span><span class="quoted">"<span class="keyword1">FAIL</span> <span class="keyword1">***</span> _ <span class="keyword1">***</span>"</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Relator annotation›</span></span>
<span class="keyword1"><span class="command">consts</span></span> rel_annot <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> annot"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_ANNOT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">:::</span>"</span> 10<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">:::</span></span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> ANNOT <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>rel_annot <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Autoref_Tagging-rel_ANNOT_eq"><span class="command">lemma</span></span> rel_ANNOT_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≡</span> <span class="free">t</span><span class="main">:::</span><span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Indirect annotation›</span></span>
<span class="keyword1"><span class="command">typedecl</span></span> rel_name
<span class="keyword1"><span class="command">consts</span></span> ind_annot <span class="main">::</span> <span class="quoted"><span class="quoted">"rel_name <span class="main">⇒</span> annot"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ind_ANNOT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> rel_name <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">::#</span>"</span> 10<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">::#</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> ANNOT <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>ind_annot <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>





<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">AUTOREF_TAGGING</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> term_of_tagged<span class="main">:</span> term <span class="main">-&gt;</span> term
    <span class="keyword1"><span class="keyword">val</span></span> is_valid_tagged<span class="main">:</span> term <span class="main">-&gt;</span> bool

    <span class="keyword1"><span class="keyword">val</span></span> mk_APP<span class="main">:</span> term <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term
    <span class="keyword1"><span class="keyword">val</span></span> mk_OP<span class="main">:</span> term <span class="main">-&gt;</span> term
    <span class="keyword1"><span class="keyword">val</span></span> lambda'<span class="main">:</span> string * typ <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term

    <span class="keyword1"><span class="keyword">val</span></span> list_APP<span class="main">:</span> term * term list <span class="main">-&gt;</span> term
    <span class="keyword1"><span class="keyword">val</span></span> strip_app<span class="main">:</span> term <span class="main">-&gt;</span> term * term list

    <span class="keyword1"><span class="keyword">val</span></span> untag_conv<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv

    <span class="keyword1"><span class="keyword">val</span></span> mk_APP_conv<span class="main">:</span> conv
    <span class="keyword1"><span class="keyword">val</span></span> mk_OP_conv<span class="main">:</span> conv
    <span class="keyword1"><span class="keyword">val</span></span> mk_ABS_conv<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv
    <span class="keyword1"><span class="keyword">val</span></span> mk_ANNOT_conv<span class="main">:</span> cterm <span class="main">-&gt;</span> conv
    <span class="keyword1"><span class="keyword">val</span></span> mk_rel_ANNOT_conv<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> cterm <span class="main">-&gt;</span> conv

    <span class="keyword1"><span class="keyword">val</span></span> ABS_beta_conv<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv

    <span class="keyword1"><span class="keyword">val</span></span> rhs_conv<span class="main">:</span> <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv
  <span class="keyword2"><span class="keyword">end</span></span>


  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Autoref_Tagging</span> <span class="main">:</span><span class="entity">AUTOREF_TAGGING</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">term_of_tagged</span> <span class="main">(</span>Free <span class="entity">v</span><span class="main">)</span> <span class="main">=</span> Free <span class="entity">v</span>
      <span class="main">|</span> <span class="entity">term_of_tagged</span> <span class="main">(</span>Var <span class="entity">v</span><span class="main">)</span> <span class="main">=</span> Var <span class="entity">v</span>
      <span class="main">|</span> <span class="entity">term_of_tagged</span> <span class="main">(</span>Bound <span class="entity">i</span><span class="main">)</span> <span class="main">=</span> Bound <span class="entity">i</span>
      <span class="main">|</span> <span class="entity">term_of_tagged</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"OP <span class="var">?t</span>"</span><span class="antiquote">}</span></span></span> <span class="main">=</span> <span class="entity">t</span>
      <span class="main">|</span> <span class="entity">term_of_tagged</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"ANNOT <span class="var">?t</span> <span class="main">_</span>"</span><span class="antiquote">}</span></span></span> <span class="main">=</span> <span class="entity">term_of_tagged</span> <span class="entity">t</span>
      <span class="main">|</span> <span class="entity">term_of_tagged</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="var">?f</span><span class="main">$</span><span class="var">?x</span>"</span><span class="antiquote">}</span></span></span></span> <span class="main">=</span> <span class="entity">term_of_tagged</span> <span class="entity">f</span> $ <span class="entity">term_of_tagged</span> <span class="entity">x</span>
      <span class="main">|</span> <span class="entity">term_of_tagged</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"PROTECT <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> PROTECT <span class="var">?t</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span></span></span> 
        <span class="main">=</span> Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">x_T</span><span class="main">,</span><span class="entity">term_of_tagged</span> <span class="entity">t</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">term_of_tagged</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="main">(</span><span class="quasi_keyword">typs</span><span class="main">)</span> <span class="quoted">"PROTECT <span class="main">(</span>PROTECT<span class="main">::</span><span class="tvar">?'v_T</span><span class="main">⇒</span><span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span> 
        <span class="main">=</span> Abs <span class="main">(</span><span class="inner_quoted">"x"</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span>Bound <span class="inner_numeral">0</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">term_of_tagged</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"term_of_tagged"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_valid_tagged</span> <span class="main">(</span>Free <span class="main">_</span><span class="main">)</span> <span class="main">=</span> true
      <span class="main">|</span> <span class="entity">is_valid_tagged</span> <span class="main">(</span>Var <span class="main">_</span><span class="main">)</span> <span class="main">=</span> true
      <span class="main">|</span> <span class="entity">is_valid_tagged</span> <span class="main">(</span>Bound <span class="main">_</span><span class="main">)</span> <span class="main">=</span> true
      <span class="main">|</span> <span class="entity">is_valid_tagged</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"OP <span class="main">_</span>"</span><span class="antiquote">}</span></span> <span class="main">=</span> true
      <span class="main">|</span> <span class="entity">is_valid_tagged</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"ANNOT <span class="var">?t</span> <span class="main">_</span>"</span><span class="antiquote">}</span></span></span> <span class="main">=</span> <span class="entity">is_valid_tagged</span> <span class="entity">t</span>
      <span class="main">|</span> <span class="entity">is_valid_tagged</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="var">?f</span><span class="main">$</span><span class="var">?x</span>"</span><span class="antiquote">}</span></span></span></span> 
        <span class="main">=</span> <span class="entity">is_valid_tagged</span> <span class="entity">f</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">is_valid_tagged</span> <span class="entity">x</span>
      <span class="main">|</span> <span class="entity">is_valid_tagged</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"PROTECT <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> PROTECT <span class="var">?t</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span> <span class="main">=</span> <span class="entity">is_valid_tagged</span> <span class="entity">t</span>
      <span class="main">|</span> <span class="entity">is_valid_tagged</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"PROTECT PROTECT"</span><span class="antiquote">}</span></span> <span class="main">=</span> true
      <span class="main">|</span> <span class="entity">is_valid_tagged</span> <span class="main">_</span> <span class="main">=</span> false

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_APP</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fT</span> <span class="main">=</span> fastype_of <span class="entity">f</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">xT</span> <span class="main">=</span> fastype_of <span class="entity">x</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rT</span> <span class="main">=</span> range_type <span class="entity">fT</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> APP<span class="antiquote">}</span></span><span class="main">,</span><span class="entity">fT</span> --&gt; <span class="entity">xT</span> --&gt; <span class="entity">rT</span><span class="main">)</span>$<span class="entity">f</span>$<span class="entity">x</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_OP</span> <span class="entity">x</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> 
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">T</span> <span class="main">=</span> fastype_of <span class="entity">x</span> 
    <span class="keyword2"><span class="keyword">in</span></span> 
      Const<span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> OP<span class="antiquote">}</span></span><span class="main">,</span><span class="entity">T</span>--&gt;<span class="entity">T</span><span class="main">)</span>$<span class="entity">x</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lambda'</span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tT</span> <span class="main">=</span> fastype_of <span class="entity">t</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t'</span> <span class="main">=</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> PROTECT<span class="antiquote">}</span></span><span class="main">,</span><span class="entity">tT</span> --&gt; <span class="entity">tT</span><span class="main">)</span>$
        abstract_over <span class="main">(</span>Free <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t'</span> <span class="main">=</span> 
        Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> PROTECT<span class="antiquote">}</span></span><span class="main">,</span><span class="main">(</span><span class="entity">T</span> --&gt; <span class="entity">tT</span><span class="main">)</span> --&gt; <span class="entity">T</span> --&gt; <span class="entity">tT</span><span class="main">)</span>$Abs <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">t'</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">t'</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">list_APP</span> <span class="main">=</span> Library.foldl <span class="main">(</span>uncurry <span class="entity">mk_APP</span><span class="main">)</span>

    <span class="comment1">(* f$x1$...$xn goes to (f,[x1,...,xn]*)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">strip_app</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">strip_app_aux</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="var">?f</span><span class="main">$</span><span class="var">?x</span>"</span><span class="antiquote">}</span></span></span></span> <span class="entity">args</span> <span class="main">=</span> <span class="entity">strip_app_aux</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">args</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">strip_app_aux</span> <span class="entity">t</span> <span class="entity">args</span> <span class="main">=</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">strip_app_aux</span> <span class="entity">t</span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">end</span></span>
      
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">untag_conv</span> <span class="entity">ctxt</span> <span class="main">=</span> Raw_Simplifier.rewrite <span class="entity">ctxt</span>
      true <span class="main">(</span><span class="entity">Autoref_Tag_Defs.get</span> <span class="entity">ctxt</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ABS_beta_conv</span> <span class="entity">ctxt</span> <span class="main">=</span> Raw_Simplifier.rewrite <span class="entity">ctxt</span>
      true <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> ABS_beta<span class="antiquote">}</span></span></span>
  
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mk_PROTECT_conv</span> <span class="main">=</span> Conv.rewr_conv <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> PROTECT_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="antiquote">}</span></span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mk_APP_conv</span> <span class="main">=</span> Conv.rewr_conv <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> APP_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="antiquote">}</span></span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mk_OP_conv</span> <span class="main">=</span> Conv.rewr_conv <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> OP_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="antiquote">}</span></span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_ABS_conv</span> <span class="entity">ctxt</span> <span class="main">=</span> Conv.abs_conv <span class="main">(</span>K <span class="entity">mk_PROTECT_conv</span><span class="main">)</span> <span class="entity">ctxt</span>
      then_conv <span class="entity">mk_PROTECT_conv</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_ANNOT_conv</span> <span class="entity">a</span> <span class="entity">ct</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Tt</span> <span class="main">=</span> Thm.ctyp_of_cterm <span class="entity">ct</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> Thm.instantiate' <span class="main">[</span>SOME <span class="entity">Tt</span><span class="main">]</span> <span class="main">[</span>SOME <span class="entity">ct</span><span class="main">,</span>SOME <span class="entity">a</span><span class="main">]</span> 
        <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> ANNOT_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="antiquote">}</span></span></span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">thm</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_rel_ANNOT_conv</span> <span class="entity">ctxt</span> <span class="entity">a</span> <span class="entity">ct</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">T</span> <span class="main">=</span> Thm.typ_of_cterm <span class="entity">a</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">Tc</span><span class="main">,</span><span class="entity">Ta</span><span class="main">)</span> <span class="main">=</span> <span class="entity">HOLogic.dest_setT</span> <span class="entity">T</span> 
        |&gt; <span class="entity">HOLogic.dest_prodT</span> 
        |&gt; apply2 <span class="main">(</span>Thm.ctyp_of <span class="entity">ctxt</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> Thm.instantiate' <span class="main">[</span>SOME <span class="entity">Ta</span><span class="main">,</span> SOME <span class="entity">Tc</span><span class="main">]</span> <span class="main">[</span>SOME <span class="entity">ct</span><span class="main">,</span>SOME <span class="entity">a</span><span class="main">]</span> 
        <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> rel_ANNOT_eq<span class="antiquote">}</span></span></span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">thm</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="comment1">(* Convert right hand side of refinement statement *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rhs_conv</span> <span class="entity">conv</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> 
      <span class="keyword3"><span class="keyword">open</span></span> Conv Refine_Util 
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">case</span></span> Logic.strip_imp_concl <span class="main">(</span>Thm.term_of <span class="entity">ct</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">∈</span><span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span> <span class="main">=&gt;</span>
          <span class="entity">HOL_concl_conv</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="main">(</span>arg1_conv <span class="main">(</span>arg_conv <span class="main">(</span><span class="entity">conv</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="entity">ct</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> CTERM <span class="main">(</span><span class="inner_quoted">"rhs_conv"</span><span class="main">,</span><span class="main">[</span><span class="entity">ct</span><span class="main">]</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>

›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹
  <span class="entity">Autoref_Tagging.mk_ANNOT_conv</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">cterm</span> <span class="quoted">"<span class="free">bar</span><span class="main">::</span>annot"</span><span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">cterm</span> <span class="quoted">"<span class="free">foo</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>type"</span><span class="antiquote">}</span></span></span><span class="main">;</span>
›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹
  <span class="entity">Autoref_Tagging.mk_rel_ANNOT_conv</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span>
    <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">cterm</span> <span class="quoted">"<span class="free">bar</span><span class="main">::</span><span class="main">(</span><span class="tfree">'c</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set"</span><span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">cterm</span> <span class="quoted">"<span class="free">foo</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>type"</span><span class="antiquote">}</span></span></span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Autoref_Id_Ops">
<div class="head">
<h1>Theory Autoref_Id_Ops</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Operation Identification›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Autoref_Id_Ops
<span class="keyword2"><span class="keyword">imports</span></span> 
  <span class="quoted">"<a href="Refine_Lib.html">../Lib/Refine_Lib</a>"</span> 
  <a href="Autoref_Phases.html">Autoref_Phases</a>
  <a href="Autoref_Data.html">Autoref_Data</a>
  <a href="Autoref_Tagging.html">Autoref_Tagging</a>
  <span class="quoted">"<a href="Parametricity.html">../Parametricity/Parametricity</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Main Tool›</span></span>

<span class="keyword1"><span class="command">typedecl</span></span> interface

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">intfAPP</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>interface <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">⇒</span> interface <span class="main">⇒</span> <span class="main">_</span>"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">intfAPP</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_intf_APP"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>_"</span> <span class="main">[</span>0<span class="main">,</span>900<span class="main">]</span> 900<span class="main">)</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">⟨</span><span class="free">x</span><span class="main">,</span><span class="free">xs</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span><span class="free">R</span>"</span> <span class="main">==</span> <span class="quoted">"<span class="main">⟨</span><span class="free">xs</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span><span class="main">(</span><span class="keyword1">CONST</span> intfAPP <span class="free">R</span> <span class="free">x</span><span class="main">)</span>"</span>
  <span class="quoted">"<span class="main">⟨</span><span class="free">x</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span><span class="free">R</span>"</span> <span class="main">==</span> <span class="quoted">"<span class="keyword1">CONST</span> intfAPP <span class="free">R</span> <span class="free">x</span>"</span>

<span class="keyword1"><span class="command">consts</span></span>
  i_fun <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface <span class="main">⇒</span> interface"</span></span> 

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">i_fun_app</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">i1</span></span></span><span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>i</sub></span></span><span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="main">≡</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">i1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">i2</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_fun"</span></span>

<span class="keyword1"><span class="command">consts</span></span> 
  i_annot <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> annot"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">i_ANNOT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> interface <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span>"</span> 10<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="keyword1"><span class="free">:::<span class="hidden">⇩</span><sub>i</sub></span></span><span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> ANNOT <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>i_annot <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Declaration of interface-type for constant›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CONST_INTF</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> interface <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span>"</span> 10<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="keyword1"><span class="free">::<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> True"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Predicate for operation identification. <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ID_OP t t' I›</span></span></span></span> means
  that term <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t›</span></span></span></span> has been annotated as <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t'›</span></span></span></span>, and its interface
  is <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>I›</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ID_OP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> interface <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ID_OP</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Interface inference rules. 
  Caution: Some of these must be applied with custom unification!
›</span></span>
<span class="keyword1" id="Autoref_Id_Ops-ID_abs"><span class="command">lemma</span></span> ID_abs<span class="main">:</span> <span class="comment1">― ‹Tag abs first›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> ID_OP <span class="bound">x</span> <span class="bound">x</span> <span class="free">I1</span> <span class="main">⟹</span> ID_OP <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x</span><span class="main">)</span> <span class="free">I2</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> ID_OP <span class="main">(</span><span class="main">λ'</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ'</span><span class="bound">x</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">I1</span><span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span><span class="free">I2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Autoref_Id_Ops-ID_app"><span class="command">lemma</span></span> ID_app<span class="main">:</span> <span class="comment1">― ‹Tag app first›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> INDEP <span class="free">I1</span><span class="main">;</span> ID_OP <span class="free">x</span> <span class="free">x'</span> <span class="free">I1</span><span class="main">;</span> ID_OP <span class="free">f</span> <span class="free">f'</span> <span class="main">(</span><span class="free">I1</span><span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span><span class="free">I2</span><span class="main">)</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> ID_OP <span class="main">(</span><span class="free">f</span><span class="main">$</span><span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span><span class="main">$</span><span class="free">x'</span><span class="main">)</span> <span class="free">I2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Autoref_Id_Ops-ID_const"><span class="command">lemma</span></span> ID_const<span class="main">:</span> <span class="comment1">― ‹Only if c is constant or free variable›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">c</span> <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="main">⟧</span> <span class="main">⟹</span> ID_OP <span class="free">c</span> <span class="main">(</span>OP <span class="free">c</span> <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span><span class="main">)</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ID_TAG</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="keyword1" id="Autoref_Id_Ops-ID_const_any"><span class="command">lemma</span></span> ID_const_any<span class="main">:</span> <span class="comment1">― ‹Only if no typing for constant exists›</span>
  <span class="quoted"><span class="quoted">"ID_OP <span class="free">c</span> <span class="main">(</span>OP <span class="main">(</span>ID_TAG <span class="free">c</span><span class="main">)</span> <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span><span class="main">)</span> <span class="free">I</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Autoref_Id_Ops-ID_const_check_known"><span class="command">lemma</span></span> ID_const_check_known<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">c</span> <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I'</span> <span class="main">⟧</span> <span class="main">⟹</span> ID_OP <span class="free">c</span> <span class="free">c</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Autoref_Id_Ops-ID_tagged_OP"><span class="command">lemma</span></span> ID_tagged_OP<span class="main">:</span> <span class="comment1">― ‹Try first›</span>
  <span class="quoted"><span class="quoted">"ID_OP <span class="main">(</span>OP <span class="free">f</span> <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>OP <span class="free">f</span> <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span><span class="main">)</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Autoref_Id_Ops-ID_is_tagged_OP"><span class="command">lemma</span></span> ID_is_tagged_OP<span class="main">:</span> <span class="quoted"><span class="quoted">"ID_OP <span class="main">(</span>OP <span class="free">c</span><span class="main">)</span> <span class="free">t'</span> <span class="free">I</span> <span class="main">⟹</span> ID_OP <span class="main">(</span>OP <span class="free">c</span><span class="main">)</span> <span class="free">t'</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Autoref_Id_Ops-ID_tagged_OP_no_annot"><span class="command">lemma</span></span> ID_tagged_OP_no_annot<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="main">⟹</span> ID_OP <span class="main">(</span>OP <span class="free">c</span><span class="main">)</span> <span class="main">(</span>OP <span class="free">c</span> <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span><span class="main">)</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> ID_tagged <span class="main">=</span> ID_tagged_OP ID_abs ID_app

<span class="keyword1" id="Autoref_Id_Ops-ID_annotated"><span class="command">lemma</span></span> ID_annotated<span class="main">:</span> <span class="comment1">― ‹Try second›</span>
  <span class="quoted"><span class="quoted">"ID_OP <span class="free">t</span> <span class="free">t'</span> <span class="free">I</span> <span class="main">⟹</span> ID_OP <span class="main">(</span><span class="free">t</span> <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span><span class="main">)</span> <span class="free">t'</span> <span class="free">I</span>"</span></span>
  <span class="quoted"><span class="quoted">"ID_OP <span class="free">t</span> <span class="free">t'</span> <span class="free">I</span> <span class="main">⟹</span> ID_OP <span class="main">(</span>ANNOT <span class="free">t</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>ANNOT <span class="free">t'</span> <span class="free">A</span><span class="main">)</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>


<span class="keyword1" id="Autoref_Id_Ops-ID_init"><span class="command">lemma</span></span> ID_init<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ID_OP <span class="free">a</span> <span class="free">a'</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">a'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Autoref_Id_Ops-itypeI"><span class="command">lemma</span></span> itypeI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">::</span><span class="tfree">'t</span><span class="main">)</span> <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">consts</span></span> depth_limit_dummy <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> depth_limit_dummy <span class="main">(</span><span class="quoted">"<span class="keyword1">…</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">limit_depth</span> <span class="main">_</span> <span class="main">(</span><span class="entity">t</span> <span class="keyword1"><span class="keyword">as</span></span> Const <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">t</span>
    <span class="main">|</span> <span class="entity">limit_depth</span> <span class="main">_</span> <span class="main">(</span><span class="entity">t</span> <span class="keyword1"><span class="keyword">as</span></span> Var <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">t</span>
    <span class="main">|</span> <span class="entity">limit_depth</span> <span class="main">_</span> <span class="main">(</span><span class="entity">t</span> <span class="keyword1"><span class="keyword">as</span></span> Free <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">t</span>
    <span class="main">|</span> <span class="entity">limit_depth</span> <span class="main">_</span> <span class="main">(</span><span class="entity">t</span> <span class="keyword1"><span class="keyword">as</span></span> Bound <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">t</span>
    <span class="main">|</span> <span class="entity">limit_depth</span> <span class="inner_numeral">0</span> <span class="entity">t</span> <span class="main">=</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> depth_limit_dummy<span class="antiquote">}</span></span><span class="main">,</span>fastype_of <span class="entity">t</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">limit_depth</span> <span class="entity">i</span> <span class="main">(</span><span class="entity">t</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">_</span>$<span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span> <span class="main">=</span> strip_comb <span class="entity">t</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">f</span> <span class="main">=</span> <span class="entity">limit_depth</span> <span class="main">(</span><span class="entity">i</span> - <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">f</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">args</span> <span class="main">=</span> map <span class="main">(</span><span class="entity">limit_depth</span> <span class="main">(</span><span class="entity">i</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span> <span class="entity">args</span>
      <span class="keyword2"><span class="keyword">in</span></span> 
        list_comb <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">limit_depth</span> <span class="entity">i</span> <span class="main">(</span>Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">limit_depth</span> <span class="main">(</span><span class="entity">i</span> - <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">t</span><span class="main">)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">depth_of</span> <span class="main">(</span><span class="entity">t</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">_</span>$<span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span> <span class="main">=</span> strip_comb <span class="entity">t</span>
      <span class="keyword2"><span class="keyword">in</span></span> 
        Integer.max <span class="main">(</span><span class="entity">depth_of</span> <span class="entity">f</span><span class="main">)</span> <span class="main">(</span>fold <span class="main">(</span>Integer.max o <span class="entity">depth_of</span><span class="main">)</span> <span class="entity">args</span> <span class="inner_numeral">0</span><span class="main">)</span> + <span class="inner_numeral">1</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">depth_of</span> <span class="main">(</span>Abs <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">depth_of</span> <span class="entity">t</span> + <span class="inner_numeral">1</span>
    <span class="main">|</span> <span class="entity">depth_of</span> <span class="main">_</span> <span class="main">=</span> <span class="inner_numeral">0</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">depth_of_lhs</span> <span class="main">=</span> <span class="entity">depth_of</span> o Thm.term_of o Thm.lhs_of
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">depth_of_rhs</span> <span class="main">=</span> <span class="entity">depth_of</span> o Thm.term_of o Thm.rhs_of

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty_rewrite</span> <span class="entity">ctxt</span> <span class="entity">thm</span> <span class="entity">rthm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lhsd</span> <span class="main">=</span> <span class="entity">depth_of_lhs</span> <span class="entity">thm</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> Thm.lhs_of <span class="entity">rthm</span> |&gt; Thm.term_of |&gt; <span class="entity">limit_depth</span> <span class="entity">lhsd</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rhsd</span> <span class="main">=</span> <span class="entity">depth_of_rhs</span> <span class="entity">thm</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t'</span> <span class="main">=</span> Thm.rhs_of <span class="entity">rthm</span> |&gt; Thm.term_of |&gt; <span class="entity">limit_depth</span> <span class="entity">rhsd</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    Pretty.block <span class="main">[</span>
      Syntax.pretty_term <span class="entity">ctxt</span> <span class="entity">t</span><span class="main">,</span> 
      Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span> Pretty.str <span class="inner_quoted">"-&gt;"</span><span class="main">,</span> Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span>
      Syntax.pretty_term <span class="entity">ctxt</span> <span class="entity">t'</span>
    <span class="main">]</span>
  <span class="keyword2"><span class="keyword">end</span></span>


›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹
  <span class="entity">depth_of</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">f</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span> <span class="main">[</span><span class="numeral">2</span><span class="main">]</span> <span class="main">[]</span>"</span><span class="antiquote">}</span></span><span class="main">;</span>

  <span class="entity">limit_depth</span> <span class="inner_numeral">2</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">6</span><span class="main">,</span><span class="numeral">7</span><span class="main">]</span>"</span><span class="antiquote">}</span></span>
  |&gt; Thm.cterm_of <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span>

›</span>


<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">index_rewr_thms</span> <span class="entity">thms</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lhs</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> Thm.concl_of <span class="entity">thm</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="var">?lhs</span> <span class="main">==</span> <span class="main">_</span>"</span><span class="antiquote">}</span></span></span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">lhs</span><span class="main">]</span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">net</span> <span class="main">=</span> Item_Net.init Thm.eq_thm_prop <span class="entity">lhs</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">net</span> <span class="main">=</span> fold_rev Item_Net.update <span class="entity">thms</span> <span class="entity">net</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">net</span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">net_rewr_tac</span> <span class="entity">net</span> <span class="entity">get_pat</span> <span class="entity">frame_conv</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">IF_EXGOAL</span> <span class="main">(</span>
    <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">g</span> <span class="main">=</span> Logic.concl_of_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span> |&gt; <span class="entity">get_pat</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thms</span> <span class="main">=</span> Item_Net.retrieve <span class="entity">net</span> <span class="entity">g</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cnv</span> <span class="main">=</span> map 
        <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> CONVERSION <span class="main">(</span><span class="entity">frame_conv</span> <span class="main">(</span>Conv.rewr_conv <span class="entity">thm</span><span class="main">)</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span> <span class="entity">thms</span>
      |&gt; <span class="entity">APPEND_LIST'</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">cnv</span> <span class="entity">i</span> <span class="entity">st</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">)</span>

›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">AUTOREF_ID_OPS</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> id_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>

    <span class="keyword1"><span class="keyword">val</span></span> id_phase<span class="main">:</span> <span class="entity">Autoref_Phases.phase</span>

    <span class="keyword1"><span class="keyword">val</span></span> mk_const_intf<span class="main">:</span> term <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term
    <span class="keyword1"><span class="keyword">val</span></span> mk_const_intf_thm<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term <span class="main">-&gt;</span> thm

    <span class="keyword1"><span class="keyword">val</span></span> dest_const_intf<span class="main">:</span> term <span class="main">-&gt;</span> term * term
    <span class="keyword1"><span class="keyword">val</span></span> dest_const_intf_thm<span class="main">:</span> thm <span class="main">-&gt;</span> term * term

    <span class="keyword1"><span class="keyword">val</span></span> cfg_trace_intf_unif<span class="main">:</span> bool Config.T
    <span class="keyword1"><span class="keyword">val</span></span> cfg_trace_failed_id<span class="main">:</span> bool Config.T
    <span class="keyword1"><span class="keyword">val</span></span> cfg_ss_id_op<span class="main">:</span> bool Config.T
    <span class="keyword1"><span class="keyword">val</span></span> cfg_trace_patterns<span class="main">:</span> bool Config.T
    <span class="keyword1"><span class="keyword">val</span></span> cfg_use_id_tags<span class="main">:</span> bool Config.T
    <span class="keyword1"><span class="keyword">val</span></span> cfg_trace_id_tags<span class="main">:</span> bool Config.T

    <span class="keyword1"><span class="keyword">val</span></span> typ_thms_of_seq<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> term <span class="main">-&gt;</span> thm Seq.seq
    <span class="keyword1"><span class="keyword">val</span></span> has_typ_thms<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> term <span class="main">-&gt;</span> bool

    <span class="keyword1"><span class="keyword">val</span></span> decl_derived_typing<span class="main">:</span> bool <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term 
      <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic

    <span class="keyword1"><span class="keyword">val</span></span> setup<span class="main">:</span> theory <span class="main">-&gt;</span> theory
  <span class="keyword2"><span class="keyword">end</span></span>
  

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Autoref_Id_Ops</span> <span class="main">:</span><span class="entity">AUTOREF_ID_OPS</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword3"><span class="keyword">open</span></span> Refine_Util Autoref_Tagging


    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_const_intf</span> <span class="entity">c</span> <span class="entity">I</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Tc</span> <span class="main">=</span> fastype_of <span class="entity">c</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="entity">Tc</span> --&gt; <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">interface</span><span class="antiquote">}</span></span> --&gt; <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">bool</span><span class="antiquote">}</span></span>
    <span class="keyword2"><span class="keyword">in</span></span> 
      Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> CONST_INTF<span class="antiquote">}</span></span><span class="main">,</span><span class="entity">T</span><span class="main">)</span>$<span class="entity">c</span>$<span class="entity">I</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_const_intf_thm</span> <span class="entity">ctxt</span> <span class="entity">f</span> <span class="entity">I</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fT</span> <span class="main">=</span> fastype_of <span class="entity">f</span> |&gt; Thm.ctyp_of <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">f</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">f</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">I</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">I</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> Thm.instantiate' <span class="main">[</span>SOME <span class="entity">fT</span><span class="main">]</span> <span class="main">[</span>SOME <span class="entity">f</span><span class="main">,</span> SOME <span class="entity">I</span><span class="main">]</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> itypeI<span class="antiquote">}</span></span></span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">thm</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_const_intf</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="var">?c</span><span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span><span class="var">?I</span>"</span><span class="antiquote">}</span></span></span></span> <span class="main">=</span> <span class="main">(</span><span class="entity">c</span><span class="main">,</span><span class="entity">I</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">dest_const_intf</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dest_const_intf"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">dest_const_intf_thm</span> <span class="main">=</span> Thm.concl_of 
      #&gt; <span class="entity">HOLogic.dest_Trueprop</span> 
      #&gt; <span class="entity">dest_const_intf</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">LHS_COND'</span> <span class="entity">P</span> <span class="main">=</span> <span class="entity">CONCL_COND'</span>
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span>ID_OP <span class="var">?lhs</span> <span class="main">_</span> <span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span> <span class="main">=&gt;</span> <span class="entity">P</span> <span class="entity">lhs</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false<span class="main">)</span>
    
    <span class="keyword2"><span class="keyword">local</span></span> <span class="keyword3"><span class="keyword">open</span></span> Conv <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">id_op_lhs_conv</span> <span class="entity">cnv</span> <span class="entity">ct</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> Thm.term_of <span class="entity">ct</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"ID_OP <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>"</span><span class="antiquote">}</span></span> <span class="main">=&gt;</span> <span class="main">(</span>fun_conv <span class="main">(</span>fun_conv <span class="main">(</span>arg_conv <span class="entity">cnv</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">ct</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> CTERM <span class="main">(</span><span class="inner_quoted">"id_op_lhs_conv"</span><span class="main">,</span><span class="main">[</span><span class="entity">ct</span><span class="main">]</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">intf_types</span> <span class="main">=</span> <span class="entity">Named_Thms</span> <span class="main">(</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_itype<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Interface type declaration"</span>
    <span class="main">)</span>

    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">op_patterns</span> <span class="main">=</span> <span class="entity">Named_Thms</span> <span class="main">(</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_op_pat<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Operation patterns"</span>
    <span class="main">)</span>

    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">op_patterns_def</span> <span class="main">=</span> <span class="entity">Named_Thms</span> <span class="main">(</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_op_pat_def<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Definitive operation patterns"</span>
    <span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cfg_trace_intf_unif</span> <span class="main">=</span> 
      <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_trace_intf_unif<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cfg_trace_failed_id</span> <span class="main">=</span> 
      <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_trace_failed_id<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cfg_ss_id_op</span> <span class="main">=</span> 
      <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_ss_id_op<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cfg_trace_patterns</span> <span class="main">=</span> 
      <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_trace_pat<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cfg_use_id_tags</span> <span class="main">=</span> 
      <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_use_id_tags<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cfg_trace_id_tags</span> <span class="main">=</span> 
      <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_trace_id_tags<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_typ_net</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thy</span> <span class="main">=</span> Proof_Context.theory_of <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">typ_net</span> <span class="main">=</span> <span class="entity">intf_types.get</span> <span class="entity">ctxt</span>
        |&gt; <span class="entity">Refine_Util.subsume_sort</span> Thm.concl_of <span class="entity">thy</span>
        |&gt; Tactic.build_net
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">typ_net</span> <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">typ_thms_of_seq'</span> <span class="entity">ctxt</span> <span class="entity">typ_net</span> <span class="entity">c</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">idx</span> <span class="main">=</span> Term.maxidx_of_term <span class="entity">c</span> + <span class="inner_numeral">1</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">typ_thms</span> <span class="main">=</span> <span class="entity">mk_const_intf</span> <span class="entity">c</span> <span class="main">(</span>Var <span class="main">(</span><span class="main">(</span><span class="inner_quoted">"I"</span><span class="main">,</span><span class="entity">idx</span><span class="main">)</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">interface</span><span class="antiquote">}</span></span><span class="main">)</span><span class="main">)</span>
        |&gt; <span class="entity">HOLogic.mk_Trueprop</span>
        |&gt; Thm.cterm_of <span class="entity">ctxt</span>
        |&gt; Goal.init
        |&gt; resolve_from_net_tac <span class="entity">ctxt</span> <span class="entity">typ_net</span> <span class="inner_numeral">1</span>
        |&gt; Seq.map Goal.conclude
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">typ_thms</span> <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">typ_thms_of_seq</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">typ_thms_of_seq'</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">get_typ_net</span> <span class="entity">ctxt</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">has_typ_thms'</span> <span class="entity">thy</span> <span class="entity">typ_net</span> <span class="main">=</span> 
      <span class="entity">typ_thms_of_seq'</span> <span class="entity">thy</span> <span class="entity">typ_net</span> #&gt; Seq.pull #&gt; is_some
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">has_typ_thms</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">has_typ_thms'</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">get_typ_net</span> <span class="entity">ctxt</span><span class="main">)</span>
  
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">id_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thy</span> <span class="main">=</span> Proof_Context.theory_of <span class="entity">ctxt</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">typ_net</span> <span class="main">=</span> <span class="entity">get_typ_net</span> <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">typ_thms_seq_of</span> <span class="main">=</span> <span class="entity">typ_thms_of_seq'</span> <span class="entity">ctxt</span> <span class="entity">typ_net</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">typ_thms_of</span> <span class="main">=</span> <span class="entity">typ_thms_seq_of</span> #&gt; Seq.list_of

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty_typ_thms</span> <span class="entity">l</span> <span class="main">=</span> 
        <span class="entity">l</span>
        |&gt; map <span class="main">(</span>Thm.pretty_thm <span class="entity">ctxt</span><span class="main">)</span>
        |&gt; Pretty.fbreaks |&gt; Pretty.block


      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tr_iu</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">if</span></span> Config.get <span class="entity">ctxt</span> <span class="entity">cfg_trace_intf_unif</span> <span class="keyword2"><span class="keyword">then</span></span>
          <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">(</span>
            <span class="keyword2"><span class="keyword">case</span></span> Logic.concl_of_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span> <span class="keyword2"><span class="keyword">of</span></span>
              <span class="main">(</span><span class="entity">t</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span><span class="var">?c</span><span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span><span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">typ_thms_of</span> <span class="entity">c</span> <span class="keyword2"><span class="keyword">of</span></span>
                <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">)</span>
              <span class="main">|</span> <span class="entity">tts</span> <span class="main">=&gt;</span> Pretty.block <span class="main">[</span>
                  Pretty.block <span class="main">[</span>
                    Pretty.str <span class="inner_quoted">"Interface unification failed:"</span><span class="main">,</span>
                    Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span>
                    Syntax.pretty_term <span class="entity">ctxt</span> <span class="entity">t</span>
                  <span class="main">]</span><span class="main">,</span> 
                  Pretty.fbrk<span class="main">,</span>
                  Pretty.str <span class="inner_quoted">"  "</span><span class="main">,</span>
                  Pretty.block <span class="main">[</span>
                    Pretty.str <span class="inner_quoted">"Candidates: "</span><span class="main">,</span> 
                    Pretty.fbrk<span class="main">,</span>
                    <span class="entity">pretty_typ_thms</span> <span class="entity">tts</span>
                  <span class="main">]</span>
                <span class="main">]</span>
                |&gt; Pretty.string_of |&gt; tracing
              <span class="main">)</span>
            <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">)</span>
          <span class="main">)</span><span class="main">;</span> Seq.empty<span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span> K no_tac

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">id_typ</span> <span class="main">=</span> 
        resolve_from_net_tac <span class="entity">ctxt</span> <span class="entity">typ_net</span>
        ORELSE' <span class="entity">tr_iu</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pat_net</span> <span class="main">=</span> <span class="entity">op_patterns.get</span> <span class="entity">ctxt</span> 
        |&gt; <span class="entity">Refine_Util.subsume_sort</span> <span class="main">(</span>Thm.concl_of #&gt; Logic.dest_equals #&gt; <span class="main">#</span><span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">thy</span>
        |&gt; <span class="entity">index_rewr_thms</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">def_pat_net</span> <span class="main">=</span> <span class="entity">op_patterns_def.get</span> <span class="entity">ctxt</span>
        |&gt; <span class="entity">Refine_Util.subsume_sort</span> <span class="main">(</span>Thm.concl_of #&gt; Logic.dest_equals #&gt; <span class="main">#</span><span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">thy</span>
        |&gt; <span class="entity">index_rewr_thms</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">id_abs</span> <span class="main">=</span> CONVERSION <span class="main">(</span><span class="entity">HOL_concl_conv</span> 
        <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">id_op_lhs_conv</span> <span class="main">(</span><span class="entity">mk_ABS_conv</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span><span class="main">)</span>
        THEN' resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> ID_abs<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">id_app</span> <span class="main">=</span> CONVERSION <span class="main">(</span><span class="entity">HOL_concl_conv</span> 
        <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">id_op_lhs_conv</span> <span class="main">(</span><span class="entity">mk_APP_conv</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span><span class="main">)</span>
        THEN' resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> ID_app<span class="antiquote">}</span></span></span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">id_tag_tac</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">trace</span> <span class="main">=</span> Config.get <span class="entity">ctxt</span> <span class="entity">cfg_trace_id_tags</span>
      <span class="keyword2"><span class="keyword">in</span></span> 
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">trace</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">IF_EXGOAL</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tr_tac</span> <span class="main">_</span> <span class="entity">st'</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">goal</span> <span class="main">=</span> Logic.get_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">concl</span> <span class="main">=</span> Logic.concl_of_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">concl</span> <span class="keyword2"><span class="keyword">of</span></span>
                  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span>ID_OP <span class="var">?lhs</span> <span class="main">_</span> <span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span> <span class="main">=&gt;</span>
                    tracing <span class="main">(</span><span class="inner_quoted">"ID_TAG: "</span> ^ <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">make_string</span><span class="antiquote">}</span></span></span></span> <span class="entity">lhs</span><span class="main">)</span> 
                <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> tracing <span class="inner_quoted">"ID_TAG: LHS???"</span>

              <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> Pretty.block <span class="main">[</span>
                Pretty.str <span class="inner_quoted">"ID_TAG: "</span><span class="main">,</span> Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span>
                Syntax.pretty_term <span class="entity">ctxt</span> <span class="entity">goal</span>
              <span class="main">]</span> |&gt; Pretty.string_of |&gt; tracing
            <span class="keyword2"><span class="keyword">in</span></span> 
              Seq.single <span class="entity">st'</span>
            <span class="keyword2"><span class="keyword">end</span></span>
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> ID_const_any<span class="antiquote">}</span></span></span> THEN' <span class="entity">tr_tac</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>
          <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span> 
        <span class="keyword2"><span class="keyword">else</span></span>
          resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> ID_const_any<span class="antiquote">}</span></span></span>

      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">id_const</span> <span class="main">=</span> 
        <span class="entity">LHS_COND'</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> is_Const <span class="entity">t</span> <span class="keyword1"><span class="keyword">orelse</span></span> is_Free <span class="entity">t</span><span class="main">)</span>
        THEN' <span class="main">(</span>
          <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> ID_const<span class="antiquote">}</span></span></span> THEN' <span class="entity">id_typ</span><span class="main">)</span> <span class="comment1">(* Try to find type *)</span>
          ORELSE' <span class="main">(</span>
            <span class="keyword2"><span class="keyword">if</span></span> Config.get <span class="entity">ctxt</span> <span class="entity">cfg_use_id_tags</span> <span class="keyword2"><span class="keyword">then</span></span>
              <span class="entity">CAN'</span> <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> ID_const_check_known<span class="antiquote">}</span></span></span> THEN' <span class="entity">id_typ</span><span class="main">)</span>
              <span class="entity">THEN_ELSE'</span> <span class="main">(</span>
                K no_tac<span class="main">,</span>
                <span class="entity">id_tag_tac</span>
              <span class="main">)</span>
            <span class="keyword2"><span class="keyword">else</span></span> K no_tac
          <span class="main">)</span>
        <span class="main">)</span>
  
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">id_tagged</span> <span class="main">=</span> resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> ID_tagged<span class="antiquote">}</span></span></span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">id_annotated</span> <span class="main">=</span> resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> ID_annotated<span class="antiquote">}</span></span></span>

      <span class="comment1">(*
      val traced_rewr_conv = if Config.get ctxt cfg_trace_patterns then
        fn ctxt =&gt; fn thm =&gt; fn ct =&gt; let
          val rthm = Conv.rewr_conv thm ct
          val _ = Pretty.block [
            Pretty.str "Trying (-pat:)", Pretty.brk 1, 
            pretty_rewrite ctxt thm rthm
          ] |&gt; Pretty.string_of |&gt; tracing
        in
          rthm
        end
      else
        K Conv.rewr_conv
      *)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_rewr_pat</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span>ID_OP <span class="var">?lhs</span> <span class="main">_</span> <span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span> <span class="main">=</span> <span class="entity">lhs</span>
        <span class="main">|</span> <span class="entity">get_rewr_pat</span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">t</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rewr_frame_conv</span> <span class="entity">conv</span> <span class="main">=</span> <span class="entity">HOL_concl_conv</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">id_op_lhs_conv</span> <span class="entity">conv</span><span class="main">)</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">def_id_pat</span> <span class="main">=</span> 
        DETERM o <span class="entity">net_rewr_tac</span> <span class="entity">def_pat_net</span> <span class="entity">get_rewr_pat</span> <span class="entity">rewr_frame_conv</span> <span class="entity">ctxt</span>
  
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">id_pat</span> <span class="main">=</span> 
        <span class="entity">net_rewr_tac</span> <span class="entity">pat_net</span> <span class="entity">get_rewr_pat</span> <span class="entity">rewr_frame_conv</span> <span class="entity">ctxt</span>
  
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">id_dflt</span> <span class="main">=</span> FIRST' <span class="main">[</span><span class="entity">id_app</span><span class="main">,</span><span class="entity">id_const</span><span class="main">,</span><span class="entity">id_abs</span><span class="main">]</span>
    
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">id_fail</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> Config.get <span class="entity">ctxt</span> <span class="entity">cfg_trace_failed_id</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="entity">IF_EXGOAL</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st</span> <span class="main">=&gt;</span> 
          <span class="keyword2"><span class="keyword">let</span></span> 
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pat</span> <span class="main">=</span> Logic.concl_of_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span>
                  |&gt; <span class="entity">get_rewr_pat</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> Pretty.block <span class="main">[</span> 
                Pretty.str <span class="inner_quoted">"Failed to identify: "</span><span class="main">,</span>
                Syntax.pretty_term <span class="entity">ctxt</span> <span class="entity">pat</span>
              <span class="main">]</span>
            |&gt; Pretty.string_of |&gt; tracing
          <span class="keyword2"><span class="keyword">in</span></span>
            Seq.empty
          <span class="keyword2"><span class="keyword">end</span></span>
        <span class="main">)</span> 
      <span class="keyword2"><span class="keyword">else</span></span> K no_tac

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ss</span> <span class="main">=</span> Config.get <span class="entity">ctxt</span> <span class="entity">cfg_ss_id_op</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">step_tac</span> <span class="main">=</span> 
        FIRST' <span class="main">[</span>
          assume_tac <span class="entity">ctxt</span><span class="main">,</span>
          <span class="entity">id_tagged</span><span class="main">,</span>
          resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> ID_is_tagged_OP<span class="antiquote">}</span></span></span> <span class="entity">THEN_ELSE'</span> <span class="main">(</span>
            resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> ID_tagged_OP_no_annot<span class="antiquote">}</span></span></span> THEN' <span class="entity">id_typ</span><span class="main">,</span>
            FIRST' <span class="main">[</span>
              <span class="entity">Indep_Vars.indep_tac</span> <span class="entity">ctxt</span><span class="main">,</span>
              <span class="entity">id_annotated</span><span class="main">,</span>
              <span class="entity">def_id_pat</span><span class="main">,</span>
              <span class="entity">id_pat</span> APPEND' <span class="entity">id_dflt</span><span class="main">,</span>
              <span class="entity">id_fail</span>
            <span class="main">]</span>
          <span class="main">)</span>
        <span class="main">]</span> 

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rec_tac</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="main">(</span>
        <span class="entity">step_tac</span> <span class="entity">THEN_ALL_NEW_FWD</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">ss</span> <span class="keyword2"><span class="keyword">then</span></span> K all_tac <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">rec_tac</span><span class="main">)</span>
      <span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>

    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">rec_tac</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">id_analyze</span> <span class="main">_</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="entity">i</span> <span class="main">=</span> <span class="entity">j</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">id_pretty_failure</span> <span class="main">_</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">_</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">j</span> <span class="keyword2"><span class="keyword">then</span></span>
        Pretty.str <span class="inner_quoted">"No failure"</span>
      <span class="keyword2"><span class="keyword">else</span></span> 
        Pretty.str <span class="inner_quoted">"Interface typing error. Enable tracing for more information"</span>


    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">id_phase</span> <span class="main">=</span> <span class="main">{</span>
      init <span class="main">=</span> I<span class="main">,</span>
      tac <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> Seq.INTERVAL <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> ID_init<span class="antiquote">}</span></span></span> THEN' <span class="entity">id_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      analyze <span class="main">=</span> <span class="entity">id_analyze</span><span class="main">,</span>
      pretty_failure <span class="main">=</span> <span class="entity">id_pretty_failure</span>
    <span class="main">}</span>


    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">decl_derived_typing</span> <span class="entity">overl</span> <span class="entity">c</span> <span class="entity">I</span> <span class="entity">context</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Context.proof_of <span class="entity">context</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">typ_thms</span> <span class="main">=</span> <span class="entity">intf_types.get</span> <span class="entity">ctxt</span> 
        <span class="comment1">(* TODO: Use net cached in ctxt here! *)</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">mk_const_intf_thm</span> <span class="entity">ctxt</span> <span class="entity">c</span> <span class="entity">I</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">st</span> <span class="main">=</span> Thm.cprop_of <span class="entity">thm</span> |&gt; Goal.init
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">has_t</span> <span class="main">=</span> SOLVED' <span class="main">(</span>match_tac <span class="entity">ctxt</span> <span class="entity">typ_thms</span><span class="main">)</span> <span class="inner_numeral">1</span> <span class="entity">st</span> |&gt; Seq.pull |&gt; is_some
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">has_t</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">context</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span>
        not <span class="entity">overl</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">has_typ_thms</span> <span class="entity">ctxt</span> <span class="entity">c</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="main">(</span>warning <span class="main">(</span>
          Pretty.block <span class="main">[</span>
            Pretty.str <span class="inner_quoted">"Adding overloaded interface type to constant:"</span><span class="main">,</span>
            Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span>
            Thm.pretty_thm <span class="entity">ctxt</span> <span class="entity">thm</span>
          <span class="main">]</span> |&gt; Pretty.string_of
        <span class="main">)</span><span class="main">;</span> true<span class="main">)</span><span class="main">;</span>
        <span class="entity">intf_types.add_thm</span> <span class="entity">thm</span> <span class="entity">context</span> 
      <span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">setup</span> <span class="main">=</span> I
      #&gt; <span class="entity">intf_types.setup</span>
      #&gt; <span class="entity">op_patterns.setup</span>
      #&gt; <span class="entity">op_patterns_def.setup</span>

  <span class="keyword2"><span class="keyword">end</span></span>


›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="entity">Autoref_Id_Ops.setup</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">IND_FACT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rel_name <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">#</span>_<span class="keyword1">=</span>_"</span> 10<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">#</span></span><span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main"><span class="free">=</span></span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> True"</span></span>

<span class="keyword1" id="Autoref_Id_Ops-REL_INDIRECT"><span class="command">lemma</span></span> REL_INDIRECT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">#</span><span class="free">name</span><span class="main">=</span><span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CNV_ANNOT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CNV_ANNOT</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">REL_OF_INTF</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">REL_OF_INTF</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> True"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">REL_OF_INTF_P</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> True"</span></span> <span class="comment1">― ‹Version to resolve relator arguments›</span>

<span class="keyword1" id="Autoref_Id_Ops-CNV_ANNOT"><span class="command">lemma</span></span> CNV_ANNOT<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">f'</span> <span class="bound">a</span> <span class="bound">a'</span><span class="main">.</span> <span class="main">⟦</span> CNV_ANNOT <span class="bound">a</span> <span class="bound">a'</span> <span class="free">Ra</span><span class="main">;</span> CNV_ANNOT <span class="bound">f</span> <span class="bound">f'</span> <span class="main">(</span><span class="free">Ra</span><span class="main">→</span><span class="free">Rr</span><span class="main">)</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> CNV_ANNOT <span class="main">(</span><span class="bound">f</span><span class="main">$</span><span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="bound">f'</span><span class="main">$</span><span class="bound">a'</span><span class="main">)</span> <span class="main">(</span><span class="free">Rr</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">f'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> CNV_ANNOT <span class="bound">x</span> <span class="bound">x</span> <span class="free">Ra</span> <span class="main">⟹</span> CNV_ANNOT <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">f'</span> <span class="bound">x</span><span class="main">)</span> <span class="free">Rr</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> CNV_ANNOT <span class="main">(</span><span class="main">λ'</span><span class="bound">x</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ'</span><span class="bound">x</span><span class="main">.</span> <span class="bound">f'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">Ra</span><span class="main">→</span><span class="free">Rr</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">f</span> <span class="bound">I</span> <span class="bound">R</span><span class="main">.</span> <span class="main">⟦</span>undefined <span class="main">(</span><span class="inner_quoted">''Id tag not yet supported''</span><span class="main">,</span><span class="bound">f</span><span class="main">)</span><span class="main">⟧</span> 
    <span class="main">⟹</span> CNV_ANNOT <span class="main">(</span>OP <span class="main">(</span>ID_TAG <span class="bound">f</span><span class="main">)</span> <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">I</span><span class="main">)</span> <span class="bound">f</span> <span class="bound">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">I</span> <span class="bound">R</span><span class="main">.</span> <span class="main">⟦</span> INDEP <span class="bound">R</span><span class="main">;</span> REL_OF_INTF <span class="bound">I</span> <span class="bound">R</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> CNV_ANNOT <span class="main">(</span>OP <span class="bound">f</span> <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">I</span><span class="main">)</span> <span class="main">(</span>OP <span class="bound">f</span> <span class="main">:::</span> <span class="bound">R</span><span class="main">)</span> <span class="bound">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">t'</span> <span class="bound">R</span><span class="main">.</span> CNV_ANNOT <span class="bound">t</span> <span class="bound">t'</span> <span class="bound">R</span> <span class="main">⟹</span> CNV_ANNOT <span class="main">(</span><span class="bound">t</span> <span class="main">:::</span> <span class="bound">R</span><span class="main">)</span> <span class="bound">t'</span> <span class="bound">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">t'</span> <span class="bound">name</span> <span class="bound">R</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">#</span><span class="bound">name</span><span class="main">=</span><span class="bound">R</span><span class="main">;</span> CNV_ANNOT <span class="bound">t</span> <span class="bound">t'</span> <span class="bound">R</span> <span class="main">⟧</span> <span class="main">⟹</span> CNV_ANNOT <span class="main">(</span><span class="bound">t</span> <span class="main">::#</span><span class="bound">name</span><span class="main">)</span> <span class="bound">t'</span> <span class="bound">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">consts</span></span> i_of_rel <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>

<span class="keyword1" id="Autoref_Id_Ops-ROI_P_app"><span class="command">lemma</span></span> ROI_P_app<span class="main">:</span> <span class="comment1">― ‹Only if interface is really application›</span>
  <span class="quoted"><span class="quoted">"REL_OF_INTF_P <span class="free">I</span> <span class="free">R</span> <span class="main">⟹</span> REL_OF_INTF <span class="free">I</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Autoref_Id_Ops-ROI_app"><span class="command">lemma</span></span> ROI_app<span class="main">:</span> <span class="comment1">― ‹Only if interface is really application›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> REL_OF_INTF <span class="free">I</span> <span class="free">R</span><span class="main">;</span> REL_OF_INTF_P <span class="free">J</span> <span class="free">S</span> <span class="main">⟧</span> <span class="main">⟹</span> REL_OF_INTF_P <span class="main">(</span><span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span><span class="free">J</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span><span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Autoref_Id_Ops-ROI_i_of_rel"><span class="command">lemma</span></span> ROI_i_of_rel<span class="main">:</span>
  <span class="quoted"><span class="quoted">"REL_OF_INTF_P <span class="main">(</span>i_of_rel <span class="free">S</span><span class="main">)</span> <span class="free">S</span>"</span></span>
  <span class="quoted"><span class="quoted">"REL_OF_INTF <span class="main">(</span>i_of_rel <span class="free">R</span><span class="main">)</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Autoref_Id_Ops-ROI_const"><span class="command">lemma</span></span> ROI_const<span class="main">:</span>
  <span class="quoted"><span class="quoted">"REL_OF_INTF_P <span class="free">J</span> <span class="free">S</span>"</span></span>
  <span class="quoted"><span class="quoted">"REL_OF_INTF <span class="free">I</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Autoref_Id_Ops-ROI_init"><span class="command">lemma</span></span> ROI_init<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"CNV_ANNOT <span class="free">a</span> <span class="free">a'</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">a'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Autoref_Id_Ops-REL_OF_INTF_I"><span class="command">lemma</span></span> REL_OF_INTF_I<span class="main">:</span> <span class="quoted"><span class="quoted">"REL_OF_INTF <span class="free">I</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">AUTOREF_REL_INF</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> roi_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
  <span class="keyword1"><span class="keyword">val</span></span> roi_step_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
  <span class="keyword1"><span class="keyword">val</span></span> roi_phase<span class="main">:</span> <span class="entity">Autoref_Phases.phase</span>
  <span class="keyword1"><span class="keyword">val</span></span> cfg_sbias<span class="main">:</span> int Config.T

  <span class="keyword1"><span class="keyword">val</span></span> setup<span class="main">:</span> theory <span class="main">-&gt;</span> theory
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Autoref_Rel_Inf</span> <span class="main">:</span><span class="entity">AUTOREF_REL_INF</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cfg_sbias</span> <span class="main">=</span> 
    <span class="entity">Attrib.setup_config_int</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_sbias<span class="antiquote">}</span></span></span> <span class="main">(</span>K <span class="inner_numeral">100</span><span class="main">)</span>


  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">rel_indirect</span> <span class="main">=</span> <span class="entity">Named_Thms</span> <span class="main">(</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_rel_indirect<span class="antiquote">}</span></span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Indirect relator bindings"</span>
  <span class="main">)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rel_of_intf_thm</span> <span class="entity">ctxt</span> <span class="entity">I</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> 
      <span class="entity">roi</span> <span class="main">(</span>Free <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> 
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">Rn</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> yield_singleton Variable.variant_fixes <span class="main">(</span><span class="inner_quoted">"R_"</span> ^ <span class="entity">n</span><span class="main">)</span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span>Free <span class="main">(</span><span class="entity">Rn</span><span class="main">,</span>dummyT<span class="main">)</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">roi</span> <span class="main">(</span>Const <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> 
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> Long_Name.base_name <span class="entity">n</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">Rn</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> yield_singleton Variable.variant_fixes <span class="main">(</span><span class="inner_quoted">"R_"</span> ^ <span class="entity">n</span><span class="main">)</span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span>Free <span class="main">(</span><span class="entity">Rn</span><span class="main">,</span>dummyT<span class="main">)</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">roi</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="main">⟨</span><span class="var">?Ia</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span><span class="var">?Ib</span>"</span><span class="antiquote">}</span></span></span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">Ra</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> <span class="entity">roi</span> <span class="entity">Ia</span> <span class="entity">ctxt</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">Rb</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> <span class="entity">roi</span> <span class="entity">Ib</span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">in</span></span> 
        <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> relAPP<span class="antiquote">}</span></span><span class="main">,</span>dummyT<span class="main">)</span>$<span class="entity">Rb</span>$<span class="entity">Ra</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">roi</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"i_of_rel <span class="var">?R</span>"</span><span class="antiquote">}</span></span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="main">(</span><span class="entity">R</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">roi</span> <span class="entity">t</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"rel_of_intf: Unexpected interface"</span><span class="main">,</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">orig_ctxt</span> <span class="main">=</span> <span class="entity">ctxt</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">I</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> yield_singleton <span class="main">(</span>Variable.import_terms true<span class="main">)</span> <span class="entity">I</span> <span class="entity">ctxt</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">R</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> <span class="entity">roi</span> <span class="entity">I</span> <span class="entity">ctxt</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> REL_OF_INTF<span class="antiquote">}</span></span><span class="main">,</span>dummyT<span class="main">)</span>$<span class="entity">I</span>$<span class="entity">R</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> Syntax.check_term <span class="entity">ctxt</span> <span class="entity">res</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> singleton <span class="main">(</span>Variable.export_terms <span class="entity">ctxt</span> <span class="entity">orig_ctxt</span><span class="main">)</span> <span class="entity">res</span>
      |&gt; <span class="entity">HOLogic.mk_Trueprop</span>
      |&gt; Thm.cterm_of <span class="entity">ctxt</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> Goal.prove_internal <span class="entity">ctxt</span> <span class="main">[</span><span class="main">]</span> <span class="entity">res</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> REL_OF_INTF_I<span class="antiquote">}</span></span></span> <span class="inner_numeral">1</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">thm</span> <span class="keyword2"><span class="keyword">end</span></span>


  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">roi_step_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ind_net</span> <span class="main">=</span> <span class="entity">rel_indirect.get</span> <span class="entity">ctxt</span> |&gt; Tactic.build_net
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">IF_EXGOAL</span> <span class="main">(</span>
      assume_tac <span class="entity">ctxt</span>
      ORELSE'
      <span class="entity">Indep_Vars.indep_tac</span> <span class="entity">ctxt</span>
      ORELSE' resolve_from_net_tac <span class="entity">ctxt</span> <span class="entity">ind_net</span>
      ORELSE'
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st</span> <span class="main">=&gt;</span> 
        <span class="keyword2"><span class="keyword">case</span></span> Logic.concl_of_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span>CNV_ANNOT <span class="main">_</span> <span class="main">_</span> <span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span> <span class="main">=&gt;</span> 
            resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> CNV_ANNOT<span class="antiquote">}</span></span></span> <span class="entity">i</span> <span class="entity">st</span>
        <span class="main">|</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span>REL_OF_INTF <span class="var">?I</span> <span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span> <span class="main">=&gt;</span> 
            resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">rel_of_intf_thm</span> <span class="entity">ctxt</span> <span class="entity">I</span><span class="main">]</span> <span class="entity">i</span> <span class="entity">st</span>
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Seq.empty
      

      <span class="comment1">(*
        | @{mpat "Trueprop (REL_OF_INTF (⟨_⟩<span class="hidden">⇩</span><sub>i</sub>_) _)"} =&gt; 
            rtac @{thm ROI_P_app} i st
        | @{mpat "Trueprop (REL_OF_INTF_P (⟨_⟩<span class="hidden">⇩</span><sub>i</sub>_) _)"} =&gt; 
            rtac @{thm ROI_app} i st
        | @{mpat "Trueprop (REL_OF_INTF_P (i_of_rel _) _)"} =&gt; 
            resolve_tac ctxt @{thms ROI_i_of_rel} i st
        | @{mpat "Trueprop (REL_OF_INTF (i_of_rel _) _)"} =&gt; 
            resolve_tac ctxt @{thms ROI_i_of_rel} i st
        | _ =&gt; resolve_tac ctxt @{thms ROI_const} i st
      *)</span>
      <span class="main">)</span>
    <span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">roi_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> 
    <span class="entity">REPEAT_ALL_NEW_FWD</span> <span class="main">(</span>DETERM o <span class="entity">roi_step_tac</span> <span class="entity">ctxt</span><span class="main">)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">roi_analyze</span> <span class="main">_</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="entity">i</span> <span class="main">=</span> <span class="entity">j</span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">roi_pretty_failure</span> <span class="main">_</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">_</span> <span class="main">=</span> 
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">j</span> <span class="keyword2"><span class="keyword">then</span></span>
      Pretty.str <span class="inner_quoted">"No failure"</span>
    <span class="keyword2"><span class="keyword">else</span></span> 
      Pretty.str <span class="inner_quoted">"Relator inference error"</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">roi_phase</span> <span class="main">=</span> <span class="main">{</span>
    init <span class="main">=</span> I<span class="main">,</span>
    tac <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> Seq.INTERVAL <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> ROI_init<span class="antiquote">}</span></span></span> THEN' <span class="entity">roi_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    analyze <span class="main">=</span> <span class="entity">roi_analyze</span><span class="main">,</span>
    pretty_failure <span class="main">=</span> <span class="entity">roi_pretty_failure</span>
  <span class="main">}</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">setup</span> <span class="main">=</span> <span class="entity">rel_indirect.setup</span>

<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="entity">Autoref_Rel_Inf.setup</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Autoref_Fix_Rel">
<div class="head">
<h1>Theory Autoref_Fix_Rel</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Relator Fixing›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Autoref_Fix_Rel
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Autoref_Id_Ops.html">Autoref_Id_Ops</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">"<span class="inner_numeral">2</span> upto <span class="inner_numeral">5</span>"</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Priority tags›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Priority tags are used to influence the ordering of refinement theorems.
  A priority tag defines two numeric priorities, a major and a minor priority.
  The major priority is considered first, the minor priority last, i.e., after
  the homogenity and relator-priority criteria.
  The default value for both priorities is 0.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PRIO_TAG</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">PRIO_TAG</span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="main">≡</span> True"</span></span>
<span class="keyword1" id="Autoref_Fix_Rel-PRIO_TAGI"><span class="command">lemma</span></span> PRIO_TAGI<span class="main">:</span> <span class="quoted"><span class="quoted">"PRIO_TAG <span class="free">ma</span> <span class="free">mi</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">MAJOR_PRIO_TAG</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> PRIO_TAG <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">MINOR_PRIO_TAG</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> PRIO_TAG <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">DFLT_PRIO_TAG</span> <span class="main">≡</span> PRIO_TAG <span class="main">0</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some standard tags›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">PRIO_TAG_OPTIMIZATION</span> <span class="main">≡</span> MINOR_PRIO_TAG <span class="numeral">10</span>"</span></span>
  <span class="comment1">― ‹Optimized version of an algorithm, with additional side-conditions›</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">PRIO_TAG_GEN_ALGO</span> <span class="main">≡</span> MINOR_PRIO_TAG <span class="main">(</span><span class="main">-</span> <span class="numeral">10</span><span class="main">)</span>"</span></span>
  <span class="comment1">― ‹Generic algorithm, considered to be less efficient than default algorithm›</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Solving Relator Constraints›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this phase, we try to instantiate the annotated relators, using
  the available refinement rules.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CONSTRAINT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CONSTRAINT</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> True"</span></span>

<span class="keyword1" id="Autoref_Fix_Rel-CONSTRAINTI"><span class="command">lemma</span></span> CONSTRAINTI<span class="main">:</span> <span class="quoted"><span class="quoted">"CONSTRAINT <span class="free">f</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Autoref_Rules</span> <span class="main">=</span> <span class="entity">Named_Thms</span> <span class="main">(</span> 
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_rules_raw<span class="antiquote">}</span></span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Refinement Framework: "</span> ^
        <span class="inner_quoted">"Automatic refinement rules"</span> 
  <span class="main">)</span><span class="main">;</span>
›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="entity">Autoref_Rules.setup</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Generic algorithm tags have to be defined here, as we need them for
  relator fixing !›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PREFER_tag</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">autoref_tag_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">PREFER_tag</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">DEFER_tag</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">autoref_tag_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">DEFER_tag</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1" id="Autoref_Fix_Rel-PREFER_tagI"><span class="command">lemma</span></span> PREFER_tagI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⟹</span> PREFER_tag <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1" id="Autoref_Fix_Rel-DEFER_tagI"><span class="command">lemma</span></span> DEFER_tagI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⟹</span> DEFER_tag <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemmas</span></span> SIDEI <span class="main">=</span> PREFER_tagI DEFER_tagI

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">autoref_tag_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">GEN_OP_tag</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">==</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>
<span class="keyword1" id="Autoref_Fix_Rel-GEN_OP_tagI"><span class="command">lemma</span></span> GEN_OP_tagI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">==&gt;</span> GEN_OP_tag <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">SIDE_GEN_OP</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">==</span> PREFER_tag <span class="main">(</span>GEN_OP_tag <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Shortcut for assuming an operation in a generic algorithm lemma›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">GEN_OP</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> SIDE_GEN_OP <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>OP <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">:::</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">TYREL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">TYREL</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> True"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">TYREL_DOMAIN</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> itself <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">TYREL_DOMAIN</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> True"</span></span>

<span class="keyword1" id="Autoref_Fix_Rel-TYREL_RES"><span class="command">lemma</span></span> TYREL_RES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> TYREL_DOMAIN <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">;</span> TYREL <span class="main">(</span><span class="free">R</span><span class="main">::</span><span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set<span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> TYREL <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Autoref_Fix_Rel-DOMAIN_OF_TYREL"><span class="command">lemma</span></span> DOMAIN_OF_TYREL<span class="main">:</span> <span class="quoted"><span class="quoted">"TYREL <span class="main">(</span><span class="free">R</span><span class="main">::</span><span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set<span class="main">)</span> 
  <span class="main">⟹</span> TYREL_DOMAIN <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Autoref_Fix_Rel-TYRELI"><span class="command">lemma</span></span> TYRELI<span class="main">:</span> <span class="quoted"><span class="quoted">"TYREL <span class="main">(</span><span class="free">R</span><span class="main">::</span><span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Autoref_Fix_Rel-ty_REL"><span class="command">lemma</span></span> ty_REL<span class="main">:</span> <span class="quoted"><span class="quoted">"TYREL <span class="main">(</span><span class="free">R</span><span class="main">::</span><span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  
  <span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">AUTOREF_FIX_REL</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
    
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">constraint</span> <span class="main">=</span> <span class="main">(</span>term * term<span class="main">)</span> list * <span class="main">(</span>term * term<span class="main">)</span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">thm_pairs</span> <span class="main">=</span> <span class="main">(</span><span class="entity">constraint</span> option * thm<span class="main">)</span> list 
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">hom_net</span> <span class="main">=</span> <span class="main">(</span>int * thm<span class="main">)</span> Net.net

    <span class="keyword1"><span class="keyword">val</span></span> thm_pairsD_init<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span>
    <span class="keyword1"><span class="keyword">val</span></span> thm_pairsD_get<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">thm_pairs</span>

    <span class="keyword1"><span class="keyword">val</span></span> constraints_of_term<span class="main">:</span> term <span class="main">-&gt;</span> <span class="main">(</span>term * term<span class="main">)</span> list
    <span class="keyword1"><span class="keyword">val</span></span> constraints_of_goal<span class="main">:</span> int <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> <span class="main">(</span>term * term<span class="main">)</span> list

    <span class="keyword1"><span class="keyword">val</span></span> mk_CONSTRAINT<span class="main">:</span> term * term <span class="main">-&gt;</span> term 
    <span class="keyword1"><span class="keyword">val</span></span> mk_CONSTRAINT_rl<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">constraint</span> <span class="main">-&gt;</span> thm

    <span class="keyword1"><span class="keyword">val</span></span> insert_CONSTRAINTS_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>

    <span class="keyword1"><span class="keyword">val</span></span> constraint_of_thm<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> <span class="entity">constraint</span>

    <span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">prio_relpos</span> <span class="main">=</span> 
      <span class="entity">PR_FIRST</span> 
    <span class="main">|</span> <span class="entity">PR_LAST</span> 
    <span class="main">|</span> <span class="entity">PR_BEFORE</span> <span class="keyword2"><span class="keyword">of</span></span> string 
    <span class="main">|</span> <span class="entity">PR_AFTER</span> <span class="keyword2"><span class="keyword">of</span></span> string

    <span class="keyword1"><span class="keyword">val</span></span> declare_prio<span class="main">:</span> string <span class="main">-&gt;</span> term <span class="main">-&gt;</span> <span class="entity">prio_relpos</span> <span class="main">-&gt;</span> local_theory <span class="main">-&gt;</span> local_theory
    <span class="keyword1"><span class="keyword">val</span></span> delete_prio<span class="main">:</span> string <span class="main">-&gt;</span> local_theory <span class="main">-&gt;</span> local_theory

    <span class="keyword1"><span class="keyword">val</span></span> print_prios<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> unit

    <span class="keyword1"><span class="keyword">val</span></span> compute_hom_net<span class="main">:</span> <span class="entity">thm_pairs</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">hom_net</span>

    <span class="keyword1"><span class="keyword">val</span></span> add_hom_rule<span class="main">:</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
    <span class="keyword1"><span class="keyword">val</span></span> del_hom_rule<span class="main">:</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
    <span class="keyword1"><span class="keyword">val</span></span> get_hom_rules<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm list

    <span class="keyword1"><span class="keyword">val</span></span> add_tyrel_rule<span class="main">:</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
    <span class="keyword1"><span class="keyword">val</span></span> del_tyrel_rule<span class="main">:</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
    <span class="keyword1"><span class="keyword">val</span></span> get_tyrel_rules<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm list


    <span class="keyword1"><span class="keyword">val</span></span> insert_tyrel_tac <span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> int <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> solve_tyrel_tac <span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> tyrel_tac <span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">itactic</span>


    <span class="keyword1"><span class="keyword">val</span></span> internal_hom_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">itactic</span>
    <span class="keyword1"><span class="keyword">val</span></span> internal_spec_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">itactic</span>
    <span class="keyword1"><span class="keyword">val</span></span> internal_solve_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">itactic</span>

    <span class="keyword1"><span class="keyword">val</span></span> guess_relators_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">itactic</span>
  
    <span class="keyword1"><span class="keyword">val</span></span> pretty_constraint<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">constraint</span> <span class="main">-&gt;</span> Pretty.T
    <span class="keyword1"><span class="keyword">val</span></span> pretty_constraints<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">constraint</span> list <span class="main">-&gt;</span> Pretty.T

    <span class="keyword1"><span class="keyword">val</span></span> pretty_thm_pair<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="main">(</span><span class="entity">constraint</span> option * thm<span class="main">)</span> <span class="main">-&gt;</span> Pretty.T
    <span class="keyword1"><span class="keyword">val</span></span> pretty_thm_pairs<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">thm_pairs</span> <span class="main">-&gt;</span> Pretty.T

    <span class="keyword1"><span class="keyword">val</span></span> analyze<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> int <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> bool
    <span class="keyword1"><span class="keyword">val</span></span> pretty_failure<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> int <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> Pretty.T

    <span class="keyword1"><span class="keyword">val</span></span> try_solve_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> solve_step_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> phase<span class="main">:</span> <span class="entity">Autoref_Phases.phase</span>

    <span class="keyword1"><span class="keyword">val</span></span> setup<span class="main">:</span> theory <span class="main">-&gt;</span> theory
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Autoref_Fix_Rel</span> <span class="main">:</span><span class="entity">AUTOREF_FIX_REL</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>

    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">constraint</span> <span class="main">=</span> <span class="main">(</span>term * term<span class="main">)</span> list * <span class="main">(</span>term * term<span class="main">)</span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">thm_pairs</span> <span class="main">=</span> <span class="main">(</span><span class="entity">constraint</span> option * thm<span class="main">)</span> list 
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">hom_net</span> <span class="main">=</span> <span class="main">(</span>int * thm<span class="main">)</span> Net.net


    <span class="comment1">(*********************)</span>
    <span class="comment1">(*    Constraints    *)</span>
    <span class="comment1">(*********************)</span>
    <span class="keyword2"><span class="keyword">local</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fix_loose_bvars</span> <span class="entity">env</span> <span class="entity">t</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">if</span></span> Term.is_open <span class="entity">t</span> <span class="keyword2"><span class="keyword">then</span></span> 
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">frees</span> <span class="main">=</span> tag_list <span class="inner_numeral">0</span> <span class="entity">env</span> 
              |&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">i</span><span class="main">,</span><span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> Free <span class="main">(</span><span class="inner_quoted">":"</span>^string_of_int <span class="entity">i</span> ^ <span class="inner_quoted">"_"</span> ^ <span class="entity">n</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">)</span> 
          <span class="keyword2"><span class="keyword">in</span></span>
            subst_bounds <span class="main">(</span><span class="entity">frees</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">end</span></span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">t</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">constraints</span> <span class="entity">env</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"OP <span class="var">?f</span> <span class="main">:::</span> <span class="var">?R</span>"</span><span class="antiquote">}</span></span></span></span> <span class="main">=</span> 
          <span class="main">(</span> Term.is_open <span class="entity">R</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"Loose bvar in relator"</span><span class="main">,</span><span class="main">[</span><span class="entity">R</span><span class="main">]</span><span class="main">)</span><span class="main">;</span>
            <span class="main">[</span><span class="main">(</span><span class="entity">fix_loose_bvars</span> <span class="entity">env</span> <span class="entity">f</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span><span class="main">]</span>
          <span class="main">)</span>
        <span class="main">|</span> <span class="entity">constraints</span> <span class="main">_</span> <span class="main">(</span>Free <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
        <span class="main">|</span> <span class="entity">constraints</span> <span class="main">_</span> <span class="main">(</span>Bound <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
        <span class="main">|</span> <span class="entity">constraints</span> <span class="entity">env</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="var">?f</span> <span class="main">:::</span> <span class="main">_</span>"</span><span class="antiquote">}</span></span></span> <span class="main">=</span> <span class="entity">constraints</span> <span class="entity">env</span> <span class="entity">f</span>
        <span class="main">|</span> <span class="entity">constraints</span> <span class="entity">env</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="var">?f</span><span class="main">$</span><span class="var">?x</span>"</span><span class="antiquote">}</span></span></span></span> 
          <span class="main">=</span> <span class="entity">constraints</span> <span class="entity">env</span> <span class="entity">x</span> @ <span class="entity">constraints</span> <span class="entity">env</span> <span class="entity">f</span>
        <span class="main">|</span> <span class="entity">constraints</span> <span class="entity">env</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"PROTECT <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> PROTECT <span class="var">?t</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span></span></span> 
          <span class="main">=</span> <span class="entity">constraints</span> <span class="main">(</span><span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">x_T</span><span class="main">)</span>::<span class="entity">env</span><span class="main">)</span> <span class="entity">t</span>
        <span class="main">|</span> <span class="entity">constraints</span> <span class="main">_</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"PROTECT PROTECT"</span><span class="antiquote">}</span></span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
        <span class="main">|</span> <span class="entity">constraints</span> <span class="main">_</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"constraints_of_term"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span> 
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">constraints_of_term</span> <span class="main">=</span> <span class="entity">constraints</span> <span class="main">[</span><span class="main">]</span> 
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">constraints_of_goal</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">case</span></span> Logic.concl_of_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="var">?a</span><span class="main">)</span><span class="main">∈</span><span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span> <span class="main">=&gt;</span> <span class="entity">constraints_of_term</span> <span class="entity">a</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> THM <span class="main">(</span><span class="inner_quoted">"constraints_of_goal"</span><span class="main">,</span><span class="entity">i</span><span class="main">,</span><span class="main">[</span><span class="entity">st</span><span class="main">]</span><span class="main">)</span>


    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_CONSTRAINT</span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fT</span> <span class="main">=</span> fastype_of <span class="entity">f</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">RT</span> <span class="main">=</span> fastype_of <span class="entity">R</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> CONSTRAINT<span class="antiquote">}</span></span><span class="main">,</span><span class="entity">fT</span> --&gt; <span class="entity">RT</span> --&gt; <span class="entity">HOLogic.boolT</span><span class="main">)</span>
        $<span class="entity">f</span>$<span class="entity">R</span>
    <span class="keyword2"><span class="keyword">in</span></span> 
      <span class="entity">res</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

    <span class="comment1">(* Types of f and R must match! *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_CONSTRAINT_rl</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">ps</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ps</span> <span class="main">=</span> map <span class="main">(</span><span class="entity">mk_CONSTRAINT</span> #&gt; <span class="entity">HOLogic.mk_Trueprop</span><span class="main">)</span> <span class="entity">ps</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">c</span> <span class="main">=</span> <span class="entity">mk_CONSTRAINT</span> <span class="entity">c</span> |&gt; <span class="entity">HOLogic.mk_Trueprop</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">g</span> <span class="main">=</span> Logic.list_implies <span class="main">(</span><span class="entity">ps</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      Goal.prove <span class="entity">ctxt</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="entity">g</span>
        <span class="main">(</span>K <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> CONSTRAINTI<span class="antiquote">}</span></span></span> <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

    <span class="comment1">(* Internal use for hom-patterns, f and R are unified *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_CONSTRAINT_rl_atom</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ts</span> <span class="main">=</span> map <span class="main">(</span>SOME o Thm.cterm_of <span class="entity">ctxt</span><span class="main">)</span> <span class="main">[</span><span class="entity">f</span><span class="main">,</span><span class="entity">R</span><span class="main">]</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">idx</span> <span class="main">=</span> Term.maxidx_term <span class="entity">f</span> <span class="main">(</span>Term.maxidx_of_term <span class="entity">R</span><span class="main">)</span> + <span class="inner_numeral">1</span>
    <span class="keyword2"><span class="keyword">in</span></span> 
      infer_instantiate' <span class="entity">ctxt</span> <span class="entity">ts</span> <span class="main">(</span>Thm.incr_indexes <span class="entity">idx</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> CONSTRAINTI<span class="antiquote">}</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">insert_CONSTRAINTS_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cs</span> <span class="main">=</span> <span class="entity">constraints_of_goal</span> <span class="entity">i</span> <span class="entity">st</span> 
      |&gt; map <span class="main">(</span><span class="entity">mk_CONSTRAINT</span> #&gt; <span class="entity">HOLogic.mk_Trueprop</span> #&gt; Thm.cterm_of <span class="entity">ctxt</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">Refine_Util.insert_subgoals_tac</span> <span class="entity">cs</span> <span class="entity">i</span> <span class="entity">st</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">constraint_of_thm</span> <span class="entity">ctxt</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> 
      <span class="keyword1"><span class="keyword">exception</span></span> <span class="entity">NO_REL</span> <span class="keyword2"><span class="keyword">of</span></span> term
      <span class="keyword3"><span class="keyword">open</span></span> Autoref_Tagging

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">extract_entry</span> <span class="entity">t</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">case</span></span> Logic.strip_imp_concl <span class="main">(</span>strip_all_body <span class="entity">t</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="var">?f</span><span class="main">)</span><span class="main">∈</span><span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span> <span class="main">=&gt;</span> SOME <span class="main">(</span>fst <span class="main">(</span><span class="entity">strip_app</span> <span class="entity">f</span><span class="main">)</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span>
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> NONE

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">relator_of</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="comment1">(*val _ = tracing (Syntax.string_of_term @{context} t)*)</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> strip_all_body <span class="entity">t</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prems</span> <span class="main">=</span> Logic.strip_imp_prems <span class="entity">t</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">concl</span> <span class="main">=</span> Logic.strip_imp_concl <span class="entity">t</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">concl</span> <span class="keyword2"><span class="keyword">of</span></span> 
          <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="var">?t</span><span class="main">)</span><span class="main">∈</span><span class="var">?R</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span></span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span> <span class="main">=</span> <span class="entity">strip_app</span> <span class="entity">t</span>
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">f</span> <span class="keyword2"><span class="keyword">of</span></span> 
              <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"OP <span class="var">?f</span><span class="main">:::</span><span class="var">?rel</span>"</span><span class="antiquote">}</span></span></span></span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">rel</span><span class="main">)</span>
            <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rels</span> <span class="main">=</span> map_filter <span class="entity">extract_entry</span> <span class="entity">prems</span>
                <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">find_rel</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> filter <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">t'</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">t</span><span class="main">=</span><span class="entity">t'</span><span class="main">)</span> <span class="entity">rels</span> <span class="keyword2"><span class="keyword">of</span></span>
                  <span class="main">[</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">]</span> <span class="main">=&gt;</span> snd <span class="main">(</span><span class="entity">relator_of</span> <span class="entity">t</span><span class="main">)</span>
                <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> <span class="entity">NO_REL</span> <span class="entity">t</span>

                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">argrels</span> <span class="main">=</span> map <span class="entity">find_rel</span> <span class="entity">args</span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rel</span> <span class="main">=</span> fold <span class="entity">Relators.mk_fun_rel</span> <span class="main">(</span>rev <span class="entity">argrels</span><span class="main">)</span> <span class="entity">R</span>
              <span class="keyword2"><span class="keyword">in</span></span>
                <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">rel</span><span class="main">)</span>
              <span class="keyword2"><span class="keyword">end</span></span>
          <span class="keyword2"><span class="keyword">end</span></span>
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> THM <span class="main">(</span><span class="inner_quoted">"constraint_of_thm: Invalid concl"</span><span class="main">,</span><span class="inner_numeral">~1</span><span class="main">,</span><span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">rel</span><span class="main">)</span> <span class="main">=</span> <span class="entity">relator_of</span> <span class="main">(</span>Thm.prop_of <span class="entity">thm</span><span class="main">)</span> 
        <span class="keyword3"><span class="keyword">handle</span></span> <span class="entity">exc</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">NO_REL</span> <span class="entity">t</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>
          warning <span class="main">(</span>
            <span class="inner_quoted">"Could not infer unique higher-order relator for "</span>
            ^ <span class="inner_quoted">"refinement rule: \n"</span>
            ^ Thm.string_of_thm <span class="entity">ctxt</span> <span class="entity">thm</span>
            ^ <span class="inner_quoted">"\n for argument: "</span> 
            ^ Syntax.string_of_term <span class="entity">ctxt</span> <span class="entity">t</span>
          <span class="main">)</span><span class="main">;</span> 
          Exn.reraise <span class="entity">exc</span><span class="main">)</span>

      <span class="comment1">(* Extract GEN_OP-tags *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> 
        <span class="entity">genop_cs</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span>SIDE_GEN_OP <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span>OP <span class="var">?f</span> <span class="main">:::</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span><span class="main">)</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span></span> <span class="main">=</span> 
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">has_Var</span> <span class="entity">f</span> <span class="keyword2"><span class="keyword">then</span></span> NONE <span class="keyword2"><span class="keyword">else</span></span> SOME <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">genop_cs</span> <span class="main">_</span> <span class="main">=</span> NONE

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">gen_ops</span> <span class="main">=</span> Thm.prems_of <span class="entity">thm</span>
        |&gt; map_filter <span class="entity">genop_cs</span>

    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="main">(</span><span class="entity">gen_ops</span><span class="main">,</span><span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">rel</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="comment1">(*********************)</span>
    <span class="comment1">(*    Priorities     *)</span>
    <span class="comment1">(*********************)</span>
    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Rel_Prio_List</span> <span class="main">=</span> <span class="entity">Prio_List</span> <span class="main">(</span>
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">item</span> <span class="main">=</span> string * term
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eq</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> o apply2 fst 
    <span class="main">)</span>

    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Rel_Prio</span> <span class="main">=</span> Generic_Data <span class="main">(</span>
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="entity">Rel_Prio_List.T</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> <span class="entity">Rel_Prio_List.empty</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">merge</span> <span class="main">=</span> <span class="entity">Rel_Prio_List.merge</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I
    <span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty_rel_prio</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span> <span class="main">=</span> Pretty.block <span class="main">[</span>
      Pretty.str <span class="entity">s</span><span class="main">,</span> Pretty.str <span class="inner_quoted">":"</span><span class="main">,</span> Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span>
      Syntax.pretty_term <span class="entity">ctxt</span> <span class="entity">t</span>
    <span class="main">]</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_prios</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rpl</span> <span class="main">=</span> Rel_Prio.get <span class="main">(</span>Context.Proof <span class="entity">ctxt</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="main">(</span>map <span class="main">(</span><span class="entity">pretty_rel_prio</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">rpl</span><span class="main">)</span>
      |&gt; Pretty.big_list <span class="inner_quoted">"Relator Priorities"</span>
      |&gt; Pretty.string_of
      |&gt; warning
    <span class="keyword2"><span class="keyword">end</span></span>


    <span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">prio_relpos</span> <span class="main">=</span> 
      <span class="entity">PR_FIRST</span> 
    <span class="main">|</span> <span class="entity">PR_LAST</span> 
    <span class="main">|</span> <span class="entity">PR_BEFORE</span> <span class="keyword2"><span class="keyword">of</span></span> string 
    <span class="main">|</span> <span class="entity">PR_AFTER</span> <span class="keyword2"><span class="keyword">of</span></span> string

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">declare_prio</span> <span class="entity">name</span> <span class="entity">pat0</span> <span class="entity">relpos</span> <span class="entity">lthy</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pat1</span> <span class="main">=</span> Proof_Context.cert_term <span class="entity">lthy</span> <span class="entity">pat0</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pat2</span> <span class="main">=</span> singleton <span class="main">(</span>Variable.export_terms <span class="main">(</span>Proof_Context.augment <span class="entity">pat1</span> <span class="entity">lthy</span><span class="main">)</span> <span class="entity">lthy</span><span class="main">)</span> <span class="entity">pat1</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">lthy</span> |&gt; Local_Theory.declaration <span class="main">{</span>syntax <span class="main">=</span> false<span class="main">,</span> pervasive <span class="main">=</span> false<span class="main">}</span>
          <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">phi</span> <span class="main">=&gt;</span>
            <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">item</span> <span class="main">=</span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span> Morphism.term <span class="entity">phi</span> <span class="entity">pat2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
              Rel_Prio.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">rpl</span> <span class="main">=&gt;</span>
                <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">relpos</span> <span class="keyword2"><span class="keyword">of</span></span>
                  <span class="entity">PR_FIRST</span> <span class="main">=&gt;</span> <span class="entity">Rel_Prio_List.add_first</span> <span class="entity">rpl</span> <span class="entity">item</span>
                <span class="main">|</span> <span class="entity">PR_LAST</span> <span class="main">=&gt;</span> <span class="entity">Rel_Prio_List.add_last</span> <span class="entity">rpl</span> <span class="entity">item</span>
                <span class="main">|</span> <span class="entity">PR_BEFORE</span> <span class="entity">n</span> <span class="main">=&gt;</span> <span class="entity">Rel_Prio_List.add_before</span> <span class="entity">rpl</span> <span class="entity">item</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span>Term.dummy<span class="main">)</span>
                <span class="main">|</span> <span class="entity">PR_AFTER</span> <span class="entity">n</span> <span class="main">=&gt;</span> <span class="entity">Rel_Prio_List.add_after</span> <span class="entity">rpl</span> <span class="entity">item</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span>Term.dummy<span class="main">)</span>
              <span class="main">)</span>
            <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">delete_prio</span> <span class="entity">name</span> <span class="main">=</span> Local_Theory.declaration <span class="main">{</span>syntax <span class="main">=</span> false<span class="main">,</span> pervasive <span class="main">=</span> false<span class="main">}</span>
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">phi</span> <span class="main">=&gt;</span> Rel_Prio.map <span class="main">(</span><span class="entity">Rel_Prio_List.delete</span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span> Term.dummy<span class="main">)</span><span class="main">)</span><span class="main">)</span>

    <span class="keyword2"><span class="keyword">local</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">relators_of</span> <span class="entity">R</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">f</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="var">?R1.0</span><span class="main">→</span><span class="var">?R2.0</span>"</span><span class="antiquote">}</span></span></span></span> <span class="main">=</span> <span class="entity">f</span> <span class="entity">R1</span> @ <span class="entity">f</span> <span class="entity">R2</span>
          <span class="main">|</span> <span class="entity">f</span> <span class="entity">R</span> <span class="main">=</span> <span class="main">[</span><span class="entity">R</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">f</span> <span class="entity">R</span> |&gt; map <span class="entity">Refine_Util.anorm_term</span> |&gt; distinct <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_prio_tag</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span>PRIO_TAG <span class="var">?ma</span> <span class="var">?mi</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span></span> <span class="main">=</span> 
            apply2 <span class="main">(</span><span class="main">#</span><span class="inner_numeral">2</span> o <span class="entity">HOLogic.dest_number</span><span class="main">)</span> <span class="main">(</span><span class="entity">ma</span><span class="main">,</span><span class="entity">mi</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">dest_prio_tag</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dest_prio_tag"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_tagged_prios</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prems</span> <span class="main">=</span> Thm.prems_of <span class="entity">thm</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">r</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="inner_numeral">0</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span>
          <span class="main">|</span> <span class="entity">r</span> <span class="main">(</span><span class="entity">prem</span>::<span class="entity">prems</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
              <span class="keyword2"><span class="keyword">case</span></span> try <span class="entity">dest_prio_tag</span> <span class="entity">prem</span> <span class="keyword2"><span class="keyword">of</span></span>
                NONE <span class="main">=&gt;</span> <span class="entity">r</span> <span class="entity">prems</span>
              <span class="main">|</span> SOME <span class="entity">p</span> <span class="main">=&gt;</span> <span class="entity">p</span>
            <span class="main">)</span> 

      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">r</span> <span class="entity">prems</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prio_order_of</span> <span class="entity">ctxt</span> <span class="main">(</span>SOME <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="entity">thm</span><span class="main">)</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rels</span> <span class="main">=</span> <span class="entity">relators_of</span> <span class="entity">R</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">hom</span> <span class="main">=</span> length <span class="entity">rels</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">major_prio</span><span class="main">,</span><span class="entity">minor_prio</span><span class="main">)</span> <span class="main">=</span> <span class="entity">get_tagged_prios</span> <span class="entity">thm</span>

          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rpl</span> <span class="main">=</span> Rel_Prio.get <span class="main">(</span>Context.Proof <span class="entity">ctxt</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">matches</span> <span class="main">=</span> Pattern.matches <span class="main">(</span>Proof_Context.theory_of <span class="entity">ctxt</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prefer</span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">p1</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">p2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">matches</span> <span class="main">(</span><span class="entity">p2</span><span class="main">,</span><span class="entity">p1</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prio_of</span> <span class="entity">R</span> 
            <span class="main">=</span> <span class="entity">Rel_Prio_List.prio_of</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">pat</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">matches</span> <span class="main">(</span><span class="entity">pat</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span><span class="main">)</span> <span class="entity">prefer</span> <span class="entity">rpl</span> 
              + <span class="inner_numeral">1</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prio</span> <span class="main">=</span> fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">R</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> <span class="entity">prio_of</span> <span class="entity">R</span> + <span class="entity">s</span><span class="main">)</span> <span class="entity">rels</span> <span class="inner_numeral">0</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="main">(</span><span class="entity">major_prio</span><span class="main">,</span> <span class="main">(</span><span class="entity">hom</span><span class="main">,</span><span class="main">(</span><span class="entity">prio</span><span class="main">,</span><span class="entity">minor_prio</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> <span class="entity">prio_order_of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Match

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prio_order</span> <span class="main">=</span> 
        prod_ord
          <span class="main">(</span>rev_order o int_ord<span class="main">)</span>
          <span class="main">(</span>prod_ord 
            int_ord
            <span class="main">(</span>prod_ord <span class="main">(</span>rev_order o int_ord<span class="main">)</span> <span class="main">(</span>rev_order o int_ord<span class="main">)</span><span class="main">)</span><span class="main">)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">annotate_thm_pair</span> <span class="entity">ctxt</span> <span class="main">(</span>SOME <span class="main">(</span><span class="entity">ps</span><span class="main">,</span><span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="entity">thm</span><span class="main">)</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword3"><span class="keyword">open</span></span> Autoref_Tagging  Conv

          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">warn</span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> warning <span class="main">(</span><span class="inner_quoted">"Error annotating refinement theorem: "</span>
            ^ Thm.string_of_thm <span class="entity">ctxt</span> <span class="entity">thm</span>
          <span class="main">)</span>

          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">R_cert</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">R</span>

          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cnv</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> Thm.term_of <span class="entity">ct</span> <span class="keyword2"><span class="keyword">of</span></span>
            <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"OP <span class="main">_</span> <span class="main">:::</span> <span class="main">_</span>"</span><span class="antiquote">}</span></span> <span class="main">=&gt;</span> all_conv
          <span class="main">|</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"OP <span class="main">_</span>"</span><span class="antiquote">}</span></span> <span class="main">=&gt;</span> <span class="entity">mk_rel_ANNOT_conv</span> <span class="entity">ctxt</span> <span class="entity">R_cert</span>
          <span class="main">|</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="main">_</span> <span class="main">$</span> <span class="main">_</span>"</span><span class="antiquote">}</span></span> <span class="main">=&gt;</span> arg1_conv <span class="main">(</span><span class="entity">cnv</span> <span class="entity">ctxt</span><span class="main">)</span>
          <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">mk_OP_conv</span> then_conv <span class="entity">mk_rel_ANNOT_conv</span> <span class="entity">ctxt</span> <span class="entity">R_cert</span>

          <span class="main">)</span> <span class="entity">ct</span>

          <span class="comment1">(*val _ = tracing ("ANNOT: " ^ @{make_string} thm)*)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> <span class="main">(</span>fconv_rule <span class="main">(</span><span class="entity">rhs_conv</span> <span class="entity">cnv</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span> <span class="entity">thm</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> try <span class="main">(</span>fconv_rule <span class="main">(</span><span class="entity">rhs_conv</span> <span class="entity">cnv</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span> <span class="entity">thm</span> <span class="keyword2"><span class="keyword">of</span></span>
            NONE <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">warn</span> <span class="main">(</span><span class="main">)</span><span class="main">;</span> <span class="entity">thm</span><span class="main">)</span>
          <span class="main">|</span> SOME <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">thm</span>
          <span class="comment1">(*val _ = tracing ("RES: " ^ @{make_string} thm)*)</span>

        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="main">(</span>SOME <span class="main">(</span><span class="entity">ps</span><span class="main">,</span><span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="entity">thm</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> <span class="entity">annotate_thm_pair</span> <span class="main">_</span> <span class="entity">p</span> <span class="main">=</span> <span class="entity">p</span>

    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">compute_thm_pairs</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rules</span> <span class="main">=</span> <span class="entity">Autoref_Rules.get</span> <span class="entity">ctxt</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_o</span> <span class="entity">p</span> <span class="main">=</span> <span class="main">(</span><span class="entity">prio_order_of</span> <span class="entity">ctxt</span> <span class="entity">p</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pairs</span> <span class="main">=</span> <span class="entity">rules</span>
          |&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="main">(</span>try <span class="main">(</span><span class="entity">constraint_of_thm</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">thm</span><span class="main">,</span><span class="entity">thm</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">spairs</span> <span class="main">=</span> filter <span class="main">(</span>is_some o <span class="main">#</span><span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">pairs</span>
          |&gt; map <span class="entity">add_o</span> 
          |&gt; sort <span class="main">(</span><span class="entity">prio_order</span> o apply2 <span class="main">#</span><span class="inner_numeral">1</span><span class="main">)</span>
          |&gt; map <span class="main">#</span><span class="inner_numeral">2</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">npairs</span> <span class="main">=</span> filter <span class="main">(</span>is_none o <span class="main">#</span><span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">pairs</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">spairs</span>@<span class="entity">npairs</span> |&gt; map <span class="main">(</span><span class="entity">annotate_thm_pair</span> <span class="entity">ctxt</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">thm_pairsD</span> <span class="main">=</span> <span class="entity">Autoref_Data</span> <span class="main">(</span>
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="entity">thm_pairs</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">compute</span> <span class="main">=</span> <span class="entity">compute_thm_pairs</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prereq</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
    <span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm_pairsD_init</span> <span class="main">=</span> <span class="entity">thm_pairsD.init</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm_pairsD_get</span> <span class="main">=</span> <span class="entity">thm_pairsD.get</span>

    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">hom_rules</span> <span class="main">=</span> <span class="entity">Named_Sorted_Thms</span> <span class="main">(</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_hom<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Autoref: Homogenity rules"</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sort</span> <span class="main">=</span> K I
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">transform</span> <span class="main">=</span> K <span class="main">(</span>
        <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">case</span></span> Thm.concl_of <span class="entity">thm</span> <span class="keyword2"><span class="keyword">of</span></span> 
          <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span>CONSTRAINT <span class="main">_</span> <span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">thm</span><span class="main">]</span>
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> THM <span class="main">(</span><span class="inner_quoted">"Invalid homogenity rule"</span><span class="main">,</span><span class="inner_numeral">~1</span><span class="main">,</span><span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span>
      <span class="main">)</span>
    <span class="main">)</span>
  
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">add_hom_rule</span> <span class="main">=</span> <span class="entity">hom_rules.add_thm</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">del_hom_rule</span> <span class="main">=</span> <span class="entity">hom_rules.del_thm</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">get_hom_rules</span> <span class="main">=</span> <span class="entity">hom_rules.get</span>

    <span class="keyword2"><span class="keyword">local</span></span>
      <span class="keyword3"><span class="keyword">open</span></span> Relators
      <span class="keyword1"><span class="keyword">fun</span></span> 
        <span class="entity">repl</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="var">?R</span><span class="main">→</span><span class="var">?S</span>"</span><span class="antiquote">}</span></span></span></span> <span class="entity">ctab</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">R</span><span class="main">,</span><span class="entity">ctab</span><span class="main">)</span> <span class="main">=</span> <span class="entity">repl</span> <span class="entity">R</span> <span class="entity">ctab</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">S</span><span class="main">,</span><span class="entity">ctab</span><span class="main">)</span> <span class="main">=</span> <span class="entity">repl</span> <span class="entity">S</span> <span class="entity">ctab</span>
        <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">mk_fun_rel</span> <span class="entity">R</span> <span class="entity">S</span><span class="main">,</span><span class="entity">ctab</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> <span class="entity">repl</span> <span class="entity">R</span> <span class="entity">ctab</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">args</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span> <span class="main">=</span> <span class="entity">strip_relAPP</span> <span class="entity">R</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">args</span><span class="main">,</span><span class="entity">ctab</span><span class="main">)</span> <span class="main">=</span> fold_map <span class="entity">repl</span> <span class="entity">args</span> <span class="entity">ctab</span> 
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">tab</span><span class="main">)</span> <span class="main">=</span> <span class="entity">ctab</span>

          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">R</span><span class="main">,</span><span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">tab</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> Termtab.lookup <span class="entity">tab</span> <span class="entity">R</span> <span class="keyword2"><span class="keyword">of</span></span>
            SOME <span class="entity">R</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">R</span><span class="main">,</span><span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">tab</span><span class="main">)</span><span class="main">)</span>
          <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">aT</span> <span class="main">=</span> fastype_of <span class="entity">R</span> |&gt; strip_type |&gt; <span class="main">#</span><span class="inner_numeral">2</span> 
                |&gt; <span class="entity">HOLogic.dest_setT</span> |&gt; <span class="entity">HOLogic.dest_prodT</span> |&gt; <span class="main">#</span><span class="inner_numeral">2</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">cT</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> yield_singleton Variable.invent_types <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">sort</span> <span class="quoted">type</span><span class="antiquote">}</span></span> <span class="entity">ctxt</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cT</span> <span class="main">=</span> TFree <span class="entity">cT</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">T</span> <span class="main">=</span> map fastype_of <span class="entity">args</span> ---&gt; <span class="entity">HOLogic.mk_setT</span> <span class="main">(</span><span class="entity">HOLogic.mk_prodT</span> <span class="main">(</span><span class="entity">cT</span><span class="main">,</span><span class="entity">aT</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">R'</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> yield_singleton Variable.variant_fixes <span class="inner_quoted">"R"</span> <span class="entity">ctxt</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">R'</span> <span class="main">=</span> <span class="entity">list_relAPP</span> <span class="entity">args</span> <span class="main">(</span>Free <span class="main">(</span><span class="entity">R'</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tab</span> <span class="main">=</span> Termtab.update <span class="main">(</span><span class="entity">R</span><span class="main">,</span><span class="entity">R'</span><span class="main">)</span> <span class="entity">tab</span>
            <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">R'</span><span class="main">,</span><span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">tab</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
        <span class="keyword2"><span class="keyword">in</span></span> 
          <span class="main">(</span><span class="entity">R</span><span class="main">,</span><span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">tab</span><span class="main">)</span><span class="main">)</span>   
        <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">hom_pat_of_rel</span> <span class="entity">ctxt</span> <span class="entity">R</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">R</span><span class="main">,</span><span class="main">(</span><span class="entity">ctxt'</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">repl</span> <span class="entity">R</span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span>Termtab.empty<span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">R</span> <span class="main">=</span> singleton <span class="main">(</span>Variable.export_terms <span class="entity">ctxt'</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">R</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">Refine_Util.anorm_term</span> <span class="entity">R</span>
      <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">compute_hom_net</span> <span class="entity">pairs</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cs</span> <span class="main">=</span> map_filter <span class="main">#</span><span class="inner_numeral">1</span> <span class="entity">pairs</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cs'</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">hom_pat_of_rel</span> <span class="entity">ctxt</span> <span class="entity">R</span><span class="main">)</span><span class="main">)</span> <span class="entity">cs</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thms</span> <span class="main">=</span> <span class="entity">get_hom_rules</span> <span class="entity">ctxt</span> @ map <span class="main">(</span><span class="entity">mk_CONSTRAINT_rl_atom</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">cs'</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thms</span> <span class="main">=</span> map <span class="main">(</span>Thm.cprop_of #&gt; Thm.trivial<span class="main">)</span> <span class="entity">thms</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">net</span> <span class="main">=</span> Tactic.build_net <span class="entity">thms</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">net</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">hom_netD</span> <span class="main">=</span> <span class="entity">Autoref_Data</span> <span class="main">(</span>
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="entity">hom_net</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">compute</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">compute_hom_net</span> <span class="main">(</span><span class="entity">thm_pairsD.get</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prereq</span> <span class="main">=</span> <span class="main">[</span> <span class="entity">thm_pairsD.init</span> <span class="main">]</span>
    <span class="main">)</span>

    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">tyrel_rules</span> <span class="main">=</span> <span class="entity">Named_Sorted_Thms</span> <span class="main">(</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_tyrel<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Autoref: Type-based relator fixing rules"</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sort</span> <span class="main">=</span> K I

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">transform</span> <span class="main">=</span> K <span class="main">(</span>
        <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">case</span></span> Thm.prop_of <span class="entity">thm</span> <span class="keyword2"><span class="keyword">of</span></span> 
          <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span>TYREL <span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">thm</span><span class="main">]</span>
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> THM <span class="main">(</span><span class="inner_quoted">"Invalid tyrel-rule"</span><span class="main">,</span><span class="inner_numeral">~1</span><span class="main">,</span><span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span>
      <span class="main">)</span>
    <span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">add_tyrel_rule</span> <span class="main">=</span> <span class="entity">tyrel_rules.add_thm</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">del_tyrel_rule</span> <span class="main">=</span> <span class="entity">tyrel_rules.del_thm</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">get_tyrel_rules</span> <span class="main">=</span> <span class="entity">tyrel_rules.get</span>

    <span class="keyword2"><span class="keyword">local</span></span>
      <span class="comment1">(*fun rel_annots @{mpat "_ ::: ?R"} = [R]
        | rel_annots @{mpat "?f$?x"} = rel_annots f @ rel_annots x
        | rel_annots @{mpat "PROTECT (λ_. PROTECT ?t)"} = rel_annots t
        | rel_annots @{mpat "PROTECT PROTECT"} = []
        | rel_annots (Free _) = []
        | rel_annots (Bound _) = []
        | rel_annots t = raise TERM ("rel_annots",[t])
      *)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_relators</span> <span class="entity">t</span> <span class="entity">acc</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword3"><span class="keyword">open</span></span> Relators
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">args</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">strip_relAPP</span> <span class="entity">t</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> fold <span class="entity">add_relators</span> <span class="entity">args</span> <span class="entity">acc</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> insert <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">t</span> <span class="entity">res</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">res</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_relators_of_subgoal</span> <span class="entity">st</span> <span class="entity">i</span> <span class="entity">acc</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">case</span></span> Logic.concl_of_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span>CONSTRAINT <span class="main">_</span> <span class="var">?R</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span> <span class="main">=&gt;</span> <span class="entity">add_relators</span> <span class="entity">R</span> <span class="entity">acc</span>
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">acc</span>
  
    <span class="keyword2"><span class="keyword">in</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">insert_tyrel_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">j</span> <span class="entity">k</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_constraint</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">T</span> <span class="main">=</span> fastype_of <span class="entity">t</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> TYREL<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">T</span> --&gt; <span class="entity">HOLogic.boolT</span><span class="main">)</span> $ <span class="entity">t</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="entity">res</span> |&gt; <span class="entity">HOLogic.mk_Trueprop</span> |&gt; Thm.cterm_of <span class="entity">ctxt</span>
        <span class="keyword2"><span class="keyword">end</span></span>
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">relators</span> <span class="main">=</span> fold <span class="main">(</span><span class="entity">add_relators_of_subgoal</span> <span class="entity">st</span><span class="main">)</span> <span class="main">(</span><span class="entity">i</span> upto <span class="entity">j</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tyrels</span> <span class="main">=</span> map <span class="entity">get_constraint</span> <span class="entity">relators</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">Refine_Util.insert_subgoals_tac</span> <span class="entity">tyrels</span> <span class="entity">k</span> <span class="entity">st</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">solve_tyrel_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_tac</span> <span class="entity">rl</span> <span class="main">=</span> resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> TYREL_RES<span class="antiquote">}</span></span></span> 
        THEN' match_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">rl</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> DOMAIN_OF_TYREL<span class="antiquote">}</span></span></span><span class="main">]</span>
        THEN' resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">rl</span><span class="main">]</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tac</span> <span class="main">=</span> FIRST' <span class="main">(</span>map <span class="entity">mk_tac</span> <span class="main">(</span><span class="entity">tyrel_rules.get</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      DETERM o <span class="entity">tac</span> ORELSE' <span class="main">(</span>TRY o resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> TYRELI<span class="antiquote">}</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
    
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tyrel_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">=</span>
      <span class="main">(</span><span class="entity">insert_tyrel_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">j</span>
      <span class="entity">THEN_ALL_NEW_FWD</span> <span class="entity">solve_tyrel_tac</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">i</span>



    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">internal_hom_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">hom_net</span> <span class="main">=</span> <span class="entity">hom_netD.get</span> <span class="entity">ctxt</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      Seq.INTERVAL <span class="main">(</span>TRY o DETERM o resolve_from_net_tac <span class="entity">ctxt</span> <span class="entity">hom_net</span><span class="main">)</span>    
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">internal_spec_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pairs</span> <span class="main">=</span> <span class="entity">thm_pairsD.get</span> <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">net</span> <span class="main">=</span> <span class="entity">pairs</span>
        |&gt; map_filter <span class="main">(</span>fst #&gt; <span class="entity">map_option</span> <span class="main">(</span>snd #&gt; <span class="entity">mk_CONSTRAINT_rl_atom</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
        |&gt; Tactic.build_net
    <span class="keyword2"><span class="keyword">in</span></span> 
      <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">j</span> <span class="main">=&gt;</span> REPEAT <span class="main">(</span>CHANGED 
        <span class="main">(</span>Seq.INTERVAL <span class="main">(</span>DETERM o <span class="entity">Anti_Unification.specialize_net_tac</span> <span class="entity">ctxt</span> <span class="entity">net</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">j</span><span class="main">)</span>
      <span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply_to_constraints</span> <span class="entity">tac</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">no_CONSTRAINT_tac</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">case</span></span> Logic.concl_of_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span>CONSTRAINT <span class="main">_</span> <span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span> <span class="main">=&gt;</span> Seq.empty
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Seq.single <span class="entity">st</span>  

    <span class="keyword2"><span class="keyword">in</span></span>
      Seq.INTERVAL <span class="main">(</span><span class="entity">no_CONSTRAINT_tac</span> ORELSE' <span class="entity">tac</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">internal_solve_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pairs</span> <span class="main">=</span> <span class="entity">thm_pairsD.get</span> <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">net</span> <span class="main">=</span> <span class="entity">pairs</span>
        |&gt; map_filter <span class="main">(</span>fst #&gt; <span class="entity">map_option</span> <span class="main">(</span><span class="entity">mk_CONSTRAINT_rl</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
        |&gt; Tactic.build_net

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">s_tac</span> <span class="main">=</span> SOLVED' <span class="main">(</span>REPEAT_ALL_NEW <span class="main">(</span>resolve_from_net_tac <span class="entity">ctxt</span> <span class="entity">net</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span> 
      <span class="entity">apply_to_constraints</span> <span class="entity">s_tac</span>
      <span class="entity">ORELSE_INTERVAL</span> 
      <span class="entity">apply_to_constraints</span> <span class="main">(</span>TRY o DETERM o <span class="entity">s_tac</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">guess_relators_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pairs</span> <span class="main">=</span> <span class="entity">thm_pairsD.get</span> <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">net</span> <span class="main">=</span> <span class="entity">pairs</span>
        |&gt; map_filter <span class="main">(</span>fst #&gt; <span class="entity">map_option</span> <span class="main">(</span><span class="entity">mk_CONSTRAINT_rl</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
        |&gt; Tactic.build_net

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">hom_net</span> <span class="main">=</span> <span class="entity">hom_netD.get</span> <span class="entity">ctxt</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">hom_tac</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">=</span> Seq.INTERVAL 
        <span class="main">(</span>TRY o DETERM o resolve_from_net_tac <span class="entity">ctxt</span> <span class="entity">hom_net</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">j</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">spec_tac</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">=</span> 
        REPEAT <span class="main">(</span>CHANGED 
          <span class="main">(</span>Seq.INTERVAL <span class="main">(</span>DETERM o <span class="entity">Anti_Unification.specialize_net_tac</span> <span class="entity">ctxt</span> <span class="entity">net</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">j</span><span class="main">)</span>
        <span class="main">)</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">solve_tac</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> 
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">s_tac</span> <span class="main">=</span> SOLVED' <span class="main">(</span>REPEAT_ALL_NEW <span class="main">(</span>resolve_from_net_tac <span class="entity">ctxt</span> <span class="entity">net</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>   
        <span class="entity">apply_to_constraints</span> <span class="entity">s_tac</span>
        <span class="entity">ORELSE_INTERVAL</span> 
        <span class="entity">apply_to_constraints</span> <span class="main">(</span>TRY o DETERM o <span class="entity">s_tac</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">in</span></span>
      Seq.INTERVAL <span class="main">(</span><span class="entity">insert_CONSTRAINTS_tac</span> <span class="entity">ctxt</span><span class="main">)</span>
      <span class="entity">THEN_INTERVAL</span> <span class="entity">hom_tac</span>
      <span class="entity">THEN_INTERVAL</span> <span class="entity">spec_tac</span>
      <span class="entity">THEN_INTERVAL</span> <span class="main">(</span><span class="entity">tyrel_tac</span> <span class="entity">ctxt</span><span class="main">)</span>
      <span class="entity">THEN_INTERVAL</span> <span class="entity">solve_tac</span>
    <span class="keyword2"><span class="keyword">end</span></span>


    <span class="comment1">(*********************)</span>
    <span class="comment1">(*  Pretty Printing  *)</span>
    <span class="comment1">(*********************)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty_constraint_atom</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span> <span class="main">=</span> Pretty.block 
      <span class="main">[</span> Syntax.pretty_term <span class="entity">ctxt</span> <span class="entity">f</span><span class="main">,</span>
        Pretty.str <span class="inner_quoted">" :: "</span><span class="main">,</span>
        Syntax.pretty_typ <span class="entity">ctxt</span> <span class="main">(</span>fastype_of <span class="entity">f</span><span class="main">)</span><span class="main">,</span>
        Pretty.str <span class="inner_quoted">" ::: "</span><span class="main">,</span>
        Syntax.pretty_term <span class="entity">ctxt</span> <span class="entity">R</span><span class="main">]</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty_constraint</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">ps</span><span class="main">,</span><span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">ps</span> <span class="keyword2"><span class="keyword">of</span></span> 
        <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">pretty_constraint_atom</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Pretty.block <span class="main">[</span>
               map <span class="main">(</span><span class="entity">pretty_constraint_atom</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">ps</span> 
               |&gt; Pretty.separate <span class="inner_quoted">"; "</span> 
               |&gt; Pretty.enclose <span class="inner_quoted">"⟦"</span> <span class="inner_quoted">"⟧"</span><span class="main">,</span>
               Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span> Pretty.str <span class="inner_quoted">"⟹"</span><span class="main">,</span> Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span>
               <span class="entity">pretty_constraint_atom</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span>
             <span class="main">]</span>


    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty_constraints</span> <span class="entity">ctxt</span> <span class="entity">l</span> <span class="main">=</span> Pretty.big_list <span class="inner_quoted">"Constraints"</span> 
      <span class="main">(</span>map <span class="main">(</span><span class="entity">pretty_constraint</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">l</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty_thm_pair</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">c</span><span class="main">,</span><span class="entity">thm</span><span class="main">)</span> <span class="main">=</span> Pretty.block <span class="main">[</span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">c</span> <span class="keyword2"><span class="keyword">of</span></span> 
        NONE <span class="main">=&gt;</span> Pretty.str <span class="inner_quoted">"NONE"</span>
      <span class="main">|</span> SOME <span class="entity">c</span> <span class="main">=&gt;</span> <span class="entity">pretty_constraint</span> <span class="entity">ctxt</span> <span class="entity">c</span><span class="main">,</span>
      Pretty.brk <span class="inner_numeral">2</span><span class="main">,</span> Pretty.str <span class="inner_quoted">"---"</span><span class="main">,</span> Pretty.brk <span class="inner_numeral">2</span><span class="main">,</span>
      Thm.pretty_thm <span class="entity">ctxt</span> <span class="entity">thm</span>
    <span class="main">]</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty_thm_pairs</span> <span class="entity">ctxt</span> <span class="entity">pairs</span> <span class="main">=</span> Pretty.big_list <span class="inner_quoted">"Thm-Pairs"</span>
      <span class="main">(</span>map <span class="main">(</span><span class="entity">pretty_thm_pair</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">pairs</span><span class="main">)</span>

    <span class="keyword2"><span class="keyword">local</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unifies</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">t1</span><span class="main">,</span> <span class="entity">t2</span><span class="main">)</span> <span class="main">=</span> Term.could_unify <span class="main">(</span><span class="entity">t1</span><span class="main">,</span> <span class="entity">t2</span><span class="main">)</span> <span class="keyword1"><span class="keyword">andalso</span></span>
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">idx1</span> <span class="main">=</span> Term.maxidx_of_term <span class="entity">t1</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t2</span> <span class="main">=</span> Logic.incr_indexes <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="entity">idx1</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">t2</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">idx2</span> <span class="main">=</span> Term.maxidx_of_term <span class="entity">t2</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          can <span class="main">(</span>Pattern.unify <span class="main">(</span>Context.Proof <span class="entity">ctxt</span><span class="main">)</span> <span class="main">(</span><span class="entity">t1</span><span class="main">,</span><span class="entity">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Envir.empty <span class="entity">idx2</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">analyze_possible_problems</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>

        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">strange_aux</span> <span class="entity">sf</span> <span class="entity">R</span> <span class="main">=</span> 
        <span class="main">(</span> 
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">sf</span> <span class="keyword2"><span class="keyword">then</span></span> 
            <span class="keyword2"><span class="keyword">let</span></span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">T</span> <span class="main">=</span> fastype_of <span class="entity">R</span>
            <span class="keyword2"><span class="keyword">in</span></span> 
              <span class="keyword2"><span class="keyword">case</span></span> try <span class="main">(</span><span class="entity">HOLogic.dest_prodT</span> o <span class="entity">HOLogic.dest_setT</span><span class="main">)</span> <span class="entity">T</span> <span class="keyword2"><span class="keyword">of</span></span>
                SOME <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span>
              <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="main">[</span>Pretty.block <span class="main">[</span>
                  Pretty.str <span class="inner_quoted">"Strange relator type, expected plain relation: "</span><span class="main">,</span>
                  Syntax.pretty_term <span class="main">(</span>Config.put show_types true <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">R</span>
                <span class="main">]</span><span class="main">]</span>
            <span class="keyword2"><span class="keyword">end</span></span>
          <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">]</span>
        <span class="main">)</span> @ <span class="main">(</span> 
          <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">R</span> <span class="keyword2"><span class="keyword">of</span></span>
            <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="main">⟨</span><span class="var">?R</span><span class="main">⟩</span><span class="var">?S</span>"</span><span class="antiquote">}</span></span></span></span> <span class="main">=&gt;</span> <span class="entity">strange_aux</span> true <span class="entity">R</span> @ <span class="entity">strange_aux</span> false <span class="entity">S</span>
          <span class="main">|</span> Var <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>
              <span class="keyword2"><span class="keyword">case</span></span> 
                try <span class="main">(</span><span class="entity">HOLogic.dest_prodT</span> o <span class="entity">HOLogic.dest_setT</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span><span class="inner_numeral">2</span> <span class="main">(</span>strip_type <span class="entity">T</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword2"><span class="keyword">of</span></span>
                SOME <span class="main">(</span>TFree <span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">[</span>Pretty.block <span class="main">[</span>
                  Pretty.str <span class="inner_quoted">"Fixed concrete type on schematic relator: "</span><span class="main">,</span>
                  Syntax.pretty_term <span class="main">(</span>Config.put show_types true <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">R</span>
                <span class="main">]</span><span class="main">]</span>
              <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span>
            <span class="main">)</span>
          <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span>
        <span class="main">)</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">strange</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">strange_aux</span> true <span class="entity">R</span> <span class="keyword2"><span class="keyword">of</span></span> 
          <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> NONE
        <span class="main">|</span> <span class="entity">l</span> <span class="main">=&gt;</span> SOME <span class="main">(</span>Pretty.block <span class="entity">l</span><span class="main">)</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">folded_relator</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">fun</span></span> 
            <span class="entity">match</span> <span class="main">(</span>Type <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span><span class="main">)</span> <span class="entity">R</span> <span class="main">=</span> 
              <span class="keyword2"><span class="keyword">let</span></span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">Rargs</span><span class="main">,</span><span class="entity">Rhd</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Relators.strip_relAPP</span> <span class="entity">R</span>
              <span class="keyword2"><span class="keyword">in</span></span> 
                <span class="keyword2"><span class="keyword">if</span></span> is_Var <span class="entity">Rhd</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span>
                <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> length <span class="entity">args</span> &lt;&gt; length <span class="entity">Rargs</span> <span class="keyword2"><span class="keyword">then</span></span>
                  <span class="main">[</span>Pretty.block <span class="main">[</span> 
                    Pretty.str <span class="inner_quoted">"Type/relator arity mismatch:"</span><span class="main">,</span>
                    Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span>
                    Pretty.block <span class="main">[</span>
                      Pretty.str <span class="entity">name</span><span class="main">,</span> Pretty.str <span class="inner_quoted">"/"</span><span class="main">,</span> 
                      Pretty.str <span class="main">(</span>string_of_int <span class="main">(</span>length <span class="entity">args</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">]</span><span class="main">,</span>
                    Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span>Pretty.str <span class="inner_quoted">"vs."</span><span class="main">,</span>Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span>
                    Pretty.block <span class="main">[</span>
                      Syntax.pretty_term <span class="entity">ctxt</span> <span class="entity">Rhd</span><span class="main">,</span> Pretty.str <span class="inner_quoted">"/"</span><span class="main">,</span> 
                      Pretty.str <span class="main">(</span>string_of_int <span class="main">(</span>length <span class="entity">Rargs</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">]</span>
                  <span class="main">]</span><span class="main">]</span>
                <span class="keyword2"><span class="keyword">else</span></span>
                  <span class="entity">args</span> ~~ <span class="entity">Rargs</span> |&gt; map <span class="main">(</span>uncurry <span class="entity">match</span><span class="main">)</span> |&gt; flat

              <span class="keyword2"><span class="keyword">end</span></span>
          <span class="main">|</span> <span class="entity">match</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>   

        <span class="keyword2"><span class="keyword">in</span></span> 
          <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">match</span> <span class="main">(</span>fastype_of <span class="entity">f</span><span class="main">)</span> <span class="entity">R</span> <span class="keyword2"><span class="keyword">of</span></span>
            <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> NONE 
          <span class="main">|</span> <span class="entity">l</span> <span class="main">=&gt;</span> SOME <span class="main">(</span>Pretty.block <span class="main">(</span>Pretty.fbreaks <span class="entity">l</span> @ <span class="main">[</span>Pretty.fbrk<span class="main">,</span>
              Pretty.str <span class="main">(</span><span class="inner_quoted">"Explanation: This may be due to using polymorphic "</span>
              ^ <span class="inner_quoted">"relators like Id on non-terminal types."</span> 
              ^ <span class="inner_quoted">"A problem usually occurs when "</span>
              ^ <span class="inner_quoted">"this relator has to be matched against a fully unfolded one."</span>
              ^ <span class="inner_quoted">"This warning is also issued on partially parametric relators "</span>
              ^ <span class="inner_quoted">"like br. However, the refinement rules are usually set up to "</span>
              ^ <span class="inner_quoted">"compensate for this, so this is probably not the cause for an "</span>
              ^ <span class="inner_quoted">"unsolved constraint"</span><span class="main">)</span>
            <span class="main">]</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>


        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">issues</span> <span class="main">=</span> <span class="main">[</span><span class="entity">strange</span><span class="main">,</span> <span class="entity">folded_relator</span><span class="main">]</span>
          |&gt; map_filter I
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">issues</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> NONE
        <span class="main">|</span> <span class="entity">l</span> <span class="main">=&gt;</span> SOME <span class="main">(</span>Pretty.big_list <span class="inner_quoted">"Possible problems"</span> <span class="entity">l</span><span class="main">)</span>

      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty_try_candidates</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &gt; Thm.nprems_of <span class="entity">st</span> <span class="keyword2"><span class="keyword">then</span></span>
        Pretty.str <span class="inner_quoted">"Goal number out of range"</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        <span class="keyword2"><span class="keyword">case</span></span> Logic.concl_of_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span>CONSTRAINT <span class="var">?f</span> <span class="var">?R</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span></span> <span class="main">=&gt;</span>
            <span class="keyword2"><span class="keyword">let</span></span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pairs</span> <span class="main">=</span> <span class="entity">thm_pairsD.get</span> <span class="entity">ctxt</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">st</span> <span class="main">=</span> Drule.zero_var_indexes <span class="entity">st</span>

              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pt_hd</span> <span class="main">=</span> Pretty.block <span class="main">[</span>
                Pretty.str <span class="inner_quoted">"Head: "</span><span class="main">,</span> Pretty.fbrk<span class="main">,</span>
                <span class="entity">pretty_constraint_atom</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span>
              <span class="main">]</span>

              <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">isc</span> <span class="main">(</span>SOME <span class="main">(</span><span class="entity">ps</span><span class="main">,</span><span class="main">(</span><span class="entity">fp</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=</span> 
                    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">unifies</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">fp</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> SOME <span class="main">(</span><span class="entity">ps</span><span class="main">,</span><span class="main">(</span><span class="entity">fp</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> NONE
                <span class="main">|</span> <span class="entity">isc</span> <span class="main">_</span> <span class="main">=</span> NONE

              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">candidates</span> <span class="main">=</span> <span class="entity">pairs</span> |&gt; map_filter <span class="entity">isc</span>

              <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">try_c</span> <span class="entity">c</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pt1</span> <span class="main">=</span> Pretty.block <span class="main">[</span>
                  Pretty.str <span class="inner_quoted">"Trying "</span><span class="main">,</span>
                  <span class="entity">pretty_constraint</span> <span class="entity">ctxt</span> <span class="entity">c</span>
                <span class="main">]</span>

                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rl</span> <span class="main">=</span> <span class="entity">mk_CONSTRAINT_rl</span> <span class="entity">ctxt</span> <span class="entity">c</span> 
                   |&gt; Drule.zero_var_indexes
                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="main">(</span>SOLVED' <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">rl</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>
                  |&gt; Seq.pull |&gt; is_some

                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pt2</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">res</span> <span class="keyword2"><span class="keyword">then</span></span> Pretty.str <span class="inner_quoted">"OK"</span> <span class="keyword2"><span class="keyword">else</span></span> Pretty.str <span class="inner_quoted">"ERR"</span><span class="main">)</span>
                  
              <span class="keyword2"><span class="keyword">in</span></span>
                Pretty.block <span class="main">[</span><span class="entity">pt1</span><span class="main">,</span>Pretty.fbrk<span class="main">,</span><span class="entity">pt2</span><span class="main">]</span>
              <span class="keyword2"><span class="keyword">end</span></span>

              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> Pretty.block <span class="main">(</span>
                Pretty.fbreaks <span class="main">[</span><span class="entity">pt_hd</span><span class="main">,</span>
                  Pretty.big_list <span class="inner_quoted">"Solving Attempts"</span> 
                    <span class="main">(</span>map <span class="entity">try_c</span> <span class="entity">candidates</span><span class="main">)</span><span class="main">]</span>
              <span class="main">)</span>

            <span class="keyword2"><span class="keyword">in</span></span> 
              <span class="entity">res</span>
            <span class="keyword2"><span class="keyword">end</span></span>
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Pretty.str <span class="inner_quoted">"Unexpected goal format"</span>


      <span class="keyword1"><span class="keyword">exception</span></span> <span class="entity">ERR</span> <span class="keyword2"><span class="keyword">of</span></span> Pretty.T
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">analyze'</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">j</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">As</span> <span class="main">=</span> Logic.strip_horn <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> |&gt; <span class="main">#</span><span class="inner_numeral">1</span> 
          |&gt; drop <span class="main">(</span><span class="entity">i</span>-<span class="inner_numeral">1</span><span class="main">)</span> |&gt; take <span class="main">(</span><span class="entity">j</span>-<span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span>
          |&gt; map <span class="main">(</span>strip_all_body #&gt; Logic.strip_imp_concl<span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Cs</span> <span class="main">=</span> map_filter <span class="main">(</span>
            <span class="keyword1"><span class="keyword">fn</span></span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span>CONSTRAINT <span class="var">?f</span> <span class="var">?R</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span></span> <span class="main">=&gt;</span> SOME <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span>
             <span class="main">|</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">∈</span><span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span> <span class="main">=&gt;</span> NONE
             <span class="main">|</span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> <span class="entity">ERR</span> <span class="main">(</span>Pretty.block <span class="main">[</span>
                 Pretty.str <span class="inner_quoted">"Internal: Unexpected goal format: "</span><span class="main">,</span>
                 Syntax.pretty_term <span class="entity">ctxt</span> <span class="entity">t</span>
               <span class="main">]</span><span class="main">)</span>
          <span class="main">)</span> <span class="entity">As</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Cs_problems</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">c</span> <span class="main">=&gt;</span> 
          <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">analyze_possible_problems</span> <span class="entity">ctxt</span> <span class="entity">c</span> <span class="keyword2"><span class="keyword">of</span></span>
            NONE <span class="main">=&gt;</span> <span class="entity">pretty_constraint_atom</span> <span class="entity">ctxt</span> <span class="entity">c</span>
          <span class="main">|</span> SOME <span class="entity">p</span> <span class="main">=&gt;</span> Pretty.block <span class="main">[</span><span class="entity">pretty_constraint_atom</span> <span class="entity">ctxt</span> <span class="entity">c</span><span class="main">,</span>Pretty.fbrk<span class="main">,</span><span class="entity">p</span><span class="main">]</span>
        <span class="main">)</span> <span class="entity">Cs</span>
 
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Cs_pretty</span> <span class="main">=</span> Pretty.big_list <span class="inner_quoted">"Constraints"</span> <span class="entity">Cs_problems</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">Cs</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">)</span>
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> <span class="entity">ERR</span> <span class="main">(</span>Pretty.block <span class="main">[</span>
            Pretty.str 
              <span class="inner_quoted">"Could not infer all relators, some constraints remaining"</span><span class="main">,</span>
            Pretty.fbrk<span class="main">,</span>
            <span class="entity">Cs_pretty</span><span class="main">,</span>
            Pretty.fbrk<span class="main">,</span>
            Pretty.block <span class="main">[</span>
              Pretty.str <span class="inner_quoted">"Trying to solve first constraint"</span><span class="main">,</span>
              Pretty.fbrk<span class="main">,</span>
              <span class="entity">pretty_try_candidates</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span>
            <span class="main">]</span>
          <span class="main">]</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">analyze</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">j</span> <span class="entity">st</span> <span class="main">=</span> can <span class="main">(</span><span class="entity">analyze'</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">j</span><span class="main">)</span> <span class="entity">st</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty_failure</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">j</span> <span class="entity">st</span> <span class="main">=</span> 
        <span class="main">(</span><span class="entity">analyze'</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">j</span> <span class="entity">st</span><span class="main">;</span> Pretty.str <span class="inner_quoted">"No failure"</span><span class="main">)</span> <span class="keyword3"><span class="keyword">handle</span></span> <span class="entity">ERR</span> <span class="entity">p</span> <span class="main">=&gt;</span> <span class="entity">p</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">try_solve_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span>  
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &gt; Thm.nprems_of <span class="entity">st</span> <span class="keyword2"><span class="keyword">then</span></span>
          <span class="main">(</span>tracing <span class="inner_quoted">"Goal number out of range"</span><span class="main">;</span> Seq.empty<span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span>
          <span class="keyword2"><span class="keyword">case</span></span> Logic.concl_of_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span> <span class="keyword2"><span class="keyword">of</span></span>
            <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span>CONSTRAINT <span class="var">?f</span> <span class="var">?R</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span></span> <span class="main">=&gt;</span>
              <span class="keyword2"><span class="keyword">let</span></span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pairs</span> <span class="main">=</span> <span class="entity">thm_pairsD.get</span> <span class="entity">ctxt</span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">st</span> <span class="main">=</span> Drule.zero_var_indexes <span class="entity">st</span>

                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pt</span> <span class="main">=</span> Pretty.block <span class="main">[</span>
                  Pretty.str <span class="inner_quoted">"Head: "</span><span class="main">,</span> Pretty.fbrk<span class="main">,</span>
                  <span class="entity">pretty_constraint_atom</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span>
                <span class="main">]</span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> tracing <span class="main">(</span>Pretty.string_of <span class="entity">pt</span><span class="main">)</span>

                <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">analyze_possible_problems</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
                  NONE <span class="main">=&gt;</span> <span class="main">(</span><span class="main">)</span>
                <span class="main">|</span> SOME <span class="entity">p</span> <span class="main">=&gt;</span> tracing <span class="main">(</span>Pretty.string_of <span class="entity">p</span><span class="main">)</span>
            
                <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">isc</span> <span class="main">(</span>SOME <span class="main">(</span><span class="entity">ps</span><span class="main">,</span><span class="main">(</span><span class="entity">fp</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=</span> 
                      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">unifies</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">fp</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> SOME <span class="main">(</span><span class="entity">ps</span><span class="main">,</span><span class="main">(</span><span class="entity">fp</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> NONE
                  <span class="main">|</span> <span class="entity">isc</span> <span class="main">_</span> <span class="main">=</span> NONE

                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">net</span> <span class="main">=</span> <span class="entity">pairs</span>
                  |&gt; map_filter <span class="main">(</span>fst #&gt; <span class="entity">map_option</span> <span class="main">(</span><span class="entity">mk_CONSTRAINT_rl</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
                  |&gt; Tactic.build_net


                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">candidates</span> <span class="main">=</span> <span class="entity">pairs</span> |&gt; map_filter <span class="entity">isc</span>

                <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">try_c</span> <span class="entity">c</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
                  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> Pretty.block <span class="main">[</span>
                    Pretty.str <span class="inner_quoted">"Trying "</span><span class="main">,</span>
                    <span class="entity">pretty_constraint</span> <span class="entity">ctxt</span> <span class="entity">c</span>
                  <span class="main">]</span> |&gt; Pretty.string_of |&gt; tracing

                  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rl</span> <span class="main">=</span> <span class="entity">mk_CONSTRAINT_rl</span> <span class="entity">ctxt</span> <span class="entity">c</span> 
                     |&gt; Drule.zero_var_indexes
                  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="main">(</span>SOLVED' <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">rl</span><span class="main">]</span> 
                      THEN_ALL_NEW <span class="main">(</span>REPEAT_ALL_NEW <span class="main">(</span>resolve_from_net_tac <span class="entity">ctxt</span> <span class="entity">net</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">)</span> <span class="entity">i</span> <span class="entity">st</span>
                    |&gt; Seq.pull |&gt; is_some

                  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">res</span> <span class="keyword2"><span class="keyword">then</span></span> Pretty.str <span class="inner_quoted">"OK"</span> <span class="keyword2"><span class="keyword">else</span></span> Pretty.str <span class="inner_quoted">"ERR"</span><span class="main">)</span>
                    |&gt; Pretty.string_of |&gt; tracing
                <span class="keyword2"><span class="keyword">in</span></span>
                  <span class="main">(</span><span class="main">)</span>
                <span class="keyword2"><span class="keyword">end</span></span>

                <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> map <span class="entity">try_c</span> <span class="entity">candidates</span>
              <span class="keyword2"><span class="keyword">in</span></span> 
                Seq.single <span class="entity">st</span>
              <span class="keyword2"><span class="keyword">end</span></span>

          <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Seq.empty


    <span class="keyword2"><span class="keyword">end</span></span>


    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">solve_step_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pairs</span> <span class="main">=</span> <span class="entity">thm_pairsD.get</span> <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">net</span> <span class="main">=</span> <span class="entity">pairs</span>
        |&gt; map_filter <span class="main">(</span>fst #&gt; <span class="entity">map_option</span> <span class="main">(</span><span class="entity">mk_CONSTRAINT_rl</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
        |&gt; Tactic.build_net
    <span class="keyword2"><span class="keyword">in</span></span> 
      resolve_from_net_tac <span class="entity">ctxt</span> <span class="entity">net</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">phase</span> <span class="main">=</span> <span class="main">{</span>
      init <span class="main">=</span> <span class="entity">thm_pairsD.init</span> #&gt; <span class="entity">hom_netD.init</span><span class="main">,</span>
      tac <span class="main">=</span> <span class="entity">guess_relators_tac</span><span class="main">,</span>
      analyze <span class="main">=</span> <span class="entity">analyze</span><span class="main">,</span>
      pretty_failure <span class="main">=</span> <span class="entity">pretty_failure</span>
    <span class="main">}</span>


    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">setup</span> <span class="main">=</span> <span class="entity">hom_rules.setup</span> #&gt; <span class="entity">tyrel_rules.setup</span>
  <span class="keyword2"><span class="keyword">end</span></span>

›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="entity">Autoref_Fix_Rel.setup</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Autoref_Relator_Interface">
<div class="head">
<h1>Theory Autoref_Relator_Interface</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Autoref_Relator_Interface
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="Autoref_Id_Ops.html">Autoref_Id_Ops</a> <a href="Autoref_Fix_Rel.html">Autoref_Fix_Rel</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">REL_INTF</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> True"</span></span>
<span class="keyword1" id="Autoref_Relator_Interface-REL_INTFI"><span class="command">lemma</span></span> REL_INTFI<span class="main">:</span> <span class="quoted"><span class="quoted">"REL_INTF <span class="free">R</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="comment1">(* Keeping track of relator - interface bindings *)</span>
  <span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">AUTOREF_RELATOR_INTERFACE</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> mk_intfAPP<span class="main">:</span> term <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term

    <span class="keyword1"><span class="keyword">val</span></span> declare_rel_intf<span class="main">:</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
    <span class="keyword1"><span class="keyword">val</span></span> delete_rel_intf<span class="main">:</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
    <span class="keyword1"><span class="keyword">val</span></span> get_rel_intfs<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm list

    <span class="keyword1"><span class="keyword">val</span></span> intf_of_rel<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term
    <span class="keyword1"><span class="keyword">val</span></span> list_invented_intf<span class="main">:</span> term <span class="main">-&gt;</span> term list
    <span class="keyword1"><span class="keyword">val</span></span> warn_invented_intf<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> term <span class="main">-&gt;</span> unit

    <span class="keyword1"><span class="keyword">val</span></span> itype_of_rule<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> <span class="main">(</span>term * term<span class="main">)</span> option

    <span class="keyword1"><span class="keyword">val</span></span> setup<span class="main">:</span> theory <span class="main">-&gt;</span> theory
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Autoref_Relator_Interface</span> <span class="main">:</span><span class="entity">AUTOREF_RELATOR_INTERFACE</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>

    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">relator_intf</span> <span class="main">=</span> <span class="entity">Named_Thms</span> <span class="main">(</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_rel_intf<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Relator interface declaration"</span>
    <span class="main">)</span>
  
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">declare_rel_intf</span> <span class="main">=</span> <span class="entity">relator_intf.add_thm</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">delete_rel_intf</span> <span class="main">=</span> <span class="entity">relator_intf.del_thm</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">get_rel_intfs</span> <span class="main">=</span> <span class="entity">relator_intf.get</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_intfAPP</span> <span class="entity">I</span> <span class="entity">J</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">JT</span> <span class="main">=</span> fastype_of <span class="entity">J</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rT</span> <span class="main">=</span> range_type <span class="entity">JT</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> intfAPP<span class="antiquote">}</span></span><span class="main">,</span><span class="entity">JT</span> --&gt; <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">interface</span><span class="antiquote">}</span></span> --&gt; <span class="entity">rT</span><span class="main">)</span> $ <span class="entity">J</span> $ <span class="entity">I</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">intf_of_rel</span> <span class="entity">ctxt</span> <span class="entity">R</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_ri</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> Thm.prop_of <span class="entity">thm</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span>REL_INTF <span class="var">?R</span> <span class="var">?I</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span></span> <span class="main">=&gt;</span> SOME <span class="main">(</span><span class="entity">R</span><span class="main">,</span><span class="entity">I</span><span class="main">)</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> NONE

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rel_intfs</span> <span class="main">=</span> <span class="entity">relator_intf.get</span> <span class="entity">ctxt</span>
        |&gt; map Drule.zero_var_indexes
        |&gt; map_filter <span class="entity">dest_ri</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thy</span> <span class="main">=</span> Proof_Context.theory_of <span class="entity">ctxt</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_ri</span> <span class="entity">R</span> <span class="main">=</span> 
        find_first <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> Pattern.matches <span class="entity">thy</span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span><span class="main">)</span> <span class="entity">rel_intfs</span>
      |&gt; <span class="entity">map_option</span> <span class="main">#</span><span class="inner_numeral">2</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">idx</span> <span class="main">=</span> Term.maxidx_of_term <span class="entity">R</span> + <span class="inner_numeral">1</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_i_of</span> <span class="entity">R</span> <span class="entity">T</span> <span class="main">=</span> 
        Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> i_of_rel<span class="antiquote">}</span></span><span class="main">,</span> fastype_of <span class="entity">R</span> --&gt; <span class="entity">T</span><span class="main">)</span>$<span class="entity">R</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">r</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"<span class="main">⟨</span><span class="var">?Ra</span><span class="main">⟩</span><span class="var">?Rf</span>"</span><span class="antiquote">}</span></span></span></span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">mk_intfAPP</span> <span class="main">(</span><span class="entity">r</span> <span class="entity">Ra</span> <span class="inner_numeral">0</span><span class="main">)</span> <span class="main">(</span><span class="entity">r</span> <span class="entity">Rf</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">r</span> <span class="entity">R</span> <span class="entity">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">get_ri</span> <span class="entity">R</span> <span class="keyword2"><span class="keyword">of</span></span> 
            SOME <span class="entity">I</span> <span class="main">=&gt;</span> <span class="entity">I</span> |&gt; Logic.incr_indexes <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="entity">idx</span><span class="main">)</span>
          <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">T</span> <span class="main">=</span> replicate <span class="entity">i</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">interface</span><span class="antiquote">}</span></span> ---&gt; <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">interface</span><span class="antiquote">}</span></span>
            <span class="keyword2"><span class="keyword">in</span></span> 
              <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">R</span> <span class="keyword2"><span class="keyword">of</span></span>
                Free <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">mk_i_of</span> <span class="entity">R</span> <span class="entity">T</span>
              <span class="main">|</span> Var <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">idx'</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> Var <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">idx</span>+<span class="entity">idx'</span>+<span class="inner_numeral">2</span><span class="main">)</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span>
              <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">mk_i_of</span> <span class="entity">R</span> <span class="entity">T</span>
            <span class="keyword2"><span class="keyword">end</span></span>
          <span class="main">)</span>

    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">r</span> <span class="entity">R</span> <span class="inner_numeral">0</span>
    |&gt; Term_Subst.zero_var_indexes 
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> 
      <span class="entity">list_invented_intf</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"i_of_rel <span class="var">?c</span>"</span><span class="antiquote">}</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="entity">c</span><span class="main">]</span> 
    <span class="main">|</span> <span class="entity">list_invented_intf</span> <span class="main">(</span><span class="entity">f</span>$<span class="entity">x</span><span class="main">)</span> <span class="main">=</span>
        <span class="entity">list_invented_intf</span> <span class="entity">f</span> @ <span class="entity">list_invented_intf</span> <span class="entity">x</span>
    <span class="main">|</span> <span class="entity">list_invented_intf</span> <span class="main">(</span>Abs <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">list_invented_intf</span> <span class="entity">t</span>
    <span class="main">|</span> <span class="entity">list_invented_intf</span> <span class="main">_</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">warn_invented_intf</span> <span class="entity">ctxt</span> <span class="entity">I</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">list_invented_intf</span> <span class="entity">I</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">l</span> <span class="main">=&gt;</span> Pretty.block <span class="main">[</span>
        Pretty.str <span class="inner_quoted">"No interfaces known for constant(s):"</span><span class="main">,</span>
        Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span>
        Pretty.block <span class="main">(</span>Pretty.commas <span class="main">(</span>map <span class="main">(</span>Syntax.pretty_term <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">l</span><span class="main">)</span><span class="main">)</span>
      <span class="main">]</span> |&gt; Pretty.string_of |&gt; warning

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">itype_of_rule</span> <span class="entity">ctxt</span> <span class="entity">thm</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">case</span></span> try <span class="main">(</span><span class="entity">Autoref_Fix_Rel.constraint_of_thm</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">thm</span> <span class="keyword2"><span class="keyword">of</span></span>
        NONE <span class="main">=&gt;</span> NONE
      <span class="main">|</span> SOME <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">R</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">I</span> <span class="main">=</span> <span class="entity">intf_of_rel</span> <span class="entity">ctxt</span> <span class="entity">R</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          SOME <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">I</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>

  
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">setup</span> <span class="main">=</span> <span class="entity">relator_intf.setup</span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="entity">Autoref_Relator_Interface.setup</span>

<span class="keyword1"><span class="command">attribute_setup</span></span> autoref_rules <span class="main">=</span> <span class="quoted">‹
  Scan.lift <span class="main">(</span>Args.mode <span class="inner_quoted">"overloaded"</span><span class="main">)</span>
  &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">overl</span> <span class="main">=&gt;</span> Thm.declaration_attribute <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">context</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">context</span> <span class="main">=</span> <span class="entity">Autoref_Rules.add_thm</span> <span class="entity">thm</span> <span class="entity">context</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Context.proof_of <span class="entity">context</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">Autoref_Relator_Interface.itype_of_rule</span> <span class="entity">ctxt</span> <span class="entity">thm</span> <span class="keyword2"><span class="keyword">of</span></span>
      NONE <span class="main">=&gt;</span> <span class="main">(</span>warning <span class="inner_quoted">"Strange autoref rule: Could not infer relator"</span><span class="main">;</span> <span class="entity">context</span><span class="main">)</span>
    <span class="main">|</span> SOME <span class="main">(</span><span class="entity">c</span><span class="main">,</span><span class="entity">I</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">Autoref_Id_Ops.decl_derived_typing</span> <span class="entity">overl</span> <span class="entity">c</span> <span class="entity">I</span> <span class="entity">context</span>
  <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">)</span><span class="main">)</span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Autoref_Translate">
<div class="head">
<h1>Theory Autoref_Translate</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Autoref_Translate
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Autoref_Fix_Rel.html">Autoref_Fix_Rel</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definitions›</span></span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹APP and ABS Rules›</span></span>
<span class="keyword1" id="Autoref_Translate-autoref_ABS"><span class="command">lemma</span></span> autoref_ABS<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">Ra</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span> <span class="bound">x</span><span class="main">,</span> <span class="free">a</span> <span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rr</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="main">λ'</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">Ra</span><span class="main">→</span><span class="free">Rr</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="Autoref_Translate-autoref_APP"><span class="command">lemma</span></span> autoref_APP<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="free">Ra</span><span class="main">→</span><span class="free">Rr</span><span class="main">;</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">Ra</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span><span class="main">$</span><span class="free">x</span><span class="main">,</span> <span class="free">a</span> <span class="main">$</span> <span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rr</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>
<span class="comment1">(*lemma autoref_ANNOT:
  "⟦ (x,x')∈R ⟧ ⟹ (x,x':::R)∈R" by (auto simp: ANNOT_def)
*)</span>

<span class="keyword1" id="Autoref_Translate-autoref_beta"><span class="command">lemma</span></span> autoref_beta<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">a</span> <span class="free">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="main">(</span><span class="main">λ'</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">$</span><span class="free">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> dflt_trans_rules <span class="main">=</span> autoref_beta autoref_ABS autoref_APP

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Side Conditions›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Rules can have prefer and defer side-conditions. Prefer conditions must
  be solvable in order for the rule to apply, and defer conditions must
  hold after the rule has been applied and the recursive translations have been
  performed. Thus, prefer-conditions typically restrict on the abstract 
  expression, while defer conditions restrict the translated expression.

  In order to solve the actual side conditions, we use the 
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Tagged_Solver›</span></span></span></span>-infrastructure. The solvers are applied after 
  the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>PREFER›</span></span></span></span>/<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>DEFER›</span></span></span></span> tag has been removed.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Tag to remove internal stuff from term.
  Before a prefer/defer side condition is evaluated, all terms inside these 
  tags are purged from autoref-specific annotations, i.e., operator-annotations,
  relator annotations, and tagged applications.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">autoref_tag_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">REMOVE_INTERNAL</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Useful abbreviation to require some property that is not related
  to teh refinement framework›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">PREFER</span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="main">≡</span> PREFER_tag <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">(</span>REMOVE_INTERNAL <span class="free"><span class="bound"><span class="entity">Φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">DEFER</span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="main">≡</span> DEFER_tag <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">(</span>REMOVE_INTERNAL <span class="free"><span class="bound"><span class="entity">Φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">REMOVE_INTERNAL_EQ</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="keyword1" id="Autoref_Translate-REMOVE_INTERNAL_EQI"><span class="command">lemma</span></span> REMOVE_INTERNAL_EQI<span class="main">:</span> <span class="quoted"><span class="quoted">"REMOVE_INTERNAL_EQ <span class="free">a</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Autoref_Translate-autoref_REMOVE_INTERNAL_EQ"><span class="command">lemma</span></span> autoref_REMOVE_INTERNAL_EQ<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"REMOVE_INTERNAL_EQ <span class="free">c</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c'</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">AUTOREF_TACTICALS</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> is_prefer_cond<span class="main">:</span> int <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> bool
    <span class="keyword1"><span class="keyword">val</span></span> is_defer_cond<span class="main">:</span> int <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> bool

    <span class="keyword1"><span class="keyword">val</span></span> REPEAT_INTERVAL<span class="main">:</span> <span class="entity">tactic'</span> <span class="main">-&gt;</span> <span class="entity">itactic</span>
    <span class="keyword1"><span class="keyword">val</span></span> COND''<span class="main">:</span> <span class="main">(</span>int <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> bool<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> REPEAT_ON_SUBGOAL<span class="main">:</span> <span class="entity">tactic'</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> IF_SOLVED<span class="main">:</span> <span class="entity">tactic'</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Autoref_Tacticals</span> <span class="main">:</span><span class="entity">AUTOREF_TACTICALS</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_prefer_cond</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">case</span></span> Logic.concl_of_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span>PREFER_tag <span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span> <span class="main">=&gt;</span> true
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_defer_cond</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">case</span></span> Logic.concl_of_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span>DEFER_tag <span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span> <span class="main">=&gt;</span> true
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">REPEAT_INTERVAL</span> <span class="entity">tac</span> <span class="entity">i</span> <span class="entity">j</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> Thm.nprems_of <span class="entity">st</span> - <span class="main">(</span><span class="entity">j</span> - <span class="entity">i</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">r</span> <span class="entity">st</span> <span class="main">=</span> <span class="main">(</span>
        COND 
          <span class="main">(</span>has_fewer_prems <span class="entity">n</span><span class="main">)</span> 
          <span class="main">(</span>all_tac<span class="main">)</span> 
          <span class="main">(</span><span class="entity">tac</span> <span class="entity">i</span> THEN_ELSE <span class="main">(</span><span class="entity">r</span><span class="main">,</span>all_tac<span class="main">)</span><span class="main">)</span>
        <span class="main">)</span> <span class="entity">st</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">r</span> <span class="entity">st</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">COND''</span> <span class="entity">cond</span> <span class="entity">tac1</span> <span class="entity">tac2</span> <span class="main">=</span> <span class="entity">IF_EXGOAL</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st</span> <span class="main">=&gt;</span> 
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">cond</span> <span class="entity">i</span> <span class="entity">st</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">tac1</span> <span class="entity">i</span> <span class="entity">st</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">tac2</span> <span class="entity">i</span> <span class="entity">st</span>
    <span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">REPEAT_ON_SUBGOAL</span> <span class="entity">tac</span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">REPEAT_INTERVAL</span> <span class="entity">tac</span> <span class="entity">i</span> <span class="entity">i</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">IF_SOLVED</span> <span class="entity">tac</span> <span class="entity">tac1</span> <span class="entity">tac2</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> Thm.nprems_of <span class="entity">st</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="main">(</span><span class="entity">tac</span> <span class="entity">i</span> THEN COND <span class="main">(</span>has_fewer_prems <span class="entity">n</span><span class="main">)</span> <span class="main">(</span><span class="entity">tac1</span> <span class="entity">i</span><span class="main">)</span> <span class="main">(</span><span class="entity">tac2</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="entity">st</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>


  <span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">AUTOREF_TRANSLATE</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">trans_net</span> <span class="main">=</span> <span class="main">(</span>int * thm<span class="main">)</span> Net.net

    <span class="keyword1"><span class="keyword">val</span></span> add_post_rule<span class="main">:</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
    <span class="keyword1"><span class="keyword">val</span></span> delete_post_rule<span class="main">:</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
    <span class="keyword1"><span class="keyword">val</span></span> get_post_rules<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm list

    <span class="keyword1"><span class="keyword">val</span></span> compute_trans_net<span class="main">:</span> <span class="entity">Autoref_Fix_Rel.thm_pairs</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span>
      <span class="main">-&gt;</span> <span class="entity">trans_net</span>

    <span class="keyword1"><span class="keyword">val</span></span> side_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> side_dbg_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>

    <span class="keyword1"><span class="keyword">val</span></span> trans_step_only_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> trans_dbg_step_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> trans_step_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">tactic'</span>
    <span class="keyword1"><span class="keyword">val</span></span> trans_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">itactic</span>

    <span class="keyword1"><span class="keyword">val</span></span> trans_analyze<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> int <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> bool
    <span class="keyword1"><span class="keyword">val</span></span> trans_pretty_failure<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> int <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> Pretty.T

    <span class="keyword1"><span class="keyword">val</span></span> trans_phase<span class="main">:</span> <span class="entity">Autoref_Phases.phase</span>

    <span class="keyword1"><span class="keyword">val</span></span> setup<span class="main">:</span> theory <span class="main">-&gt;</span> theory
  <span class="keyword2"><span class="keyword">end</span></span>


  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Autoref_Translate</span> <span class="main">:</span><span class="entity">AUTOREF_TRANSLATE</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">trans_net</span> <span class="main">=</span> <span class="main">(</span>int * thm<span class="main">)</span> Net.net


    <span class="comment1">(**************************)</span>
    <span class="comment1">(*       Translation      *)</span>
    <span class="comment1">(**************************)</span>
    
    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">autoref_post_simps</span> <span class="main">=</span> <span class="entity">Named_Thms</span> <span class="main">(</span> 
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_post_simps<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Refinement Framework: "</span> ^
          <span class="inner_quoted">"Automatic refinement post simplification rules"</span> 
    <span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">add_post_rule</span> <span class="main">=</span> <span class="entity">autoref_post_simps.add_thm</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">delete_post_rule</span> <span class="main">=</span> <span class="entity">autoref_post_simps.del_thm</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">get_post_rules</span> <span class="main">=</span> <span class="entity">autoref_post_simps.get</span>


    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">compute_trans_net</span> <span class="entity">thm_pairs</span> <span class="main">_</span> <span class="main">=</span> 
      <span class="entity">thm_pairs</span>
      |&gt; map <span class="main">#</span><span class="inner_numeral">2</span>
      |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thms</span> <span class="main">=&gt;</span> <span class="entity">thms</span> @ <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> dflt_trans_rules<span class="antiquote">}</span></span></span><span class="main">)</span>
      |&gt; Tactic.build_net 

    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">trans_netD</span> <span class="main">=</span> <span class="entity">Autoref_Data</span> <span class="main">(</span>
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="entity">trans_net</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">compute</span> <span class="entity">ctxt</span> <span class="main">=</span> 
        <span class="entity">compute_trans_net</span> <span class="main">(</span><span class="entity">Autoref_Fix_Rel.thm_pairsD_get</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prereq</span> <span class="main">=</span> <span class="main">[</span><span class="entity">Autoref_Fix_Rel.thm_pairsD_init</span><span class="main">]</span>
    <span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">REMOVE_INTERNAL_conv</span> <span class="entity">ctxt</span> <span class="main">=</span> 
      Conv.top_sweep_conv <span class="main">(</span>
        <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ct</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> Thm.term_of <span class="entity">ct</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"REMOVE_INTERNAL <span class="main">_</span>"</span><span class="antiquote">}</span></span> <span class="main">=&gt;</span> 
            Conv.rewr_conv <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> REMOVE_INTERNAL_def<span class="antiquote">}</span></span></span>
            then_conv <span class="entity">Autoref_Tagging.untag_conv</span> <span class="entity">ctxt</span>
          <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Conv.no_conv<span class="main">)</span> <span class="entity">ct</span>
      <span class="main">)</span> <span class="entity">ctxt</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">REMOVE_INTERNAL_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> CONVERSION <span class="main">(</span><span class="entity">REMOVE_INTERNAL_conv</span> <span class="entity">ctxt</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">side_tac</span> <span class="entity">ctxt</span> <span class="main">=</span>
      resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> SIDEI<span class="antiquote">}</span></span></span>
      THEN' <span class="entity">REMOVE_INTERNAL_tac</span> <span class="entity">ctxt</span>
      THEN' <span class="entity">Tagged_Solver.solve_tac</span> <span class="entity">ctxt</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">side_dbg_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Config.put <span class="entity">Tagged_Solver.cfg_keep</span> true <span class="entity">ctxt</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> SIDEI<span class="antiquote">}</span></span></span>
      THEN' <span class="entity">REMOVE_INTERNAL_tac</span> <span class="entity">ctxt</span>
      THEN' TRY o <span class="entity">Tagged_Solver.solve_tac</span> <span class="entity">ctxt</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword2"><span class="keyword">local</span></span>
      <span class="keyword3"><span class="keyword">open</span></span> <span class="entity">Autoref_Tacticals</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">trans_rule_tac</span> <span class="entity">ctxt</span> <span class="entity">net</span> <span class="main">=</span> resolve_from_net_tac <span class="entity">ctxt</span> <span class="entity">net</span>
        THEN_ALL_NEW <span class="main">(</span>TRY o match_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> PRIO_TAGI<span class="antiquote">}</span></span></span><span class="main">]</span><span class="main">)</span>

    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="comment1">(* Do not even attempt to solve side conditions *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">trans_step_only_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">net</span> <span class="main">=</span> <span class="entity">trans_netD.get</span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="main">(</span>
          <span class="entity">COND''</span> <span class="entity">is_defer_cond</span> 
            <span class="main">(</span>K no_tac<span class="main">)</span>
            <span class="main">(</span>assume_tac <span class="entity">ctxt</span> ORELSE' <span class="entity">trans_rule_tac</span> <span class="entity">ctxt</span> <span class="entity">net</span><span class="main">)</span>
        <span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="comment1">(* Leave unsolved side conditions *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">trans_dbg_step_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">net</span> <span class="main">=</span> <span class="entity">trans_netD.get</span> <span class="entity">ctxt</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">s_tac</span> <span class="main">=</span> <span class="entity">side_tac</span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">in</span></span> DETERM o <span class="main">(</span>
        <span class="entity">COND''</span> <span class="entity">is_defer_cond</span> 
          <span class="main">(</span>SOLVED' <span class="entity">s_tac</span><span class="main">)</span>
          <span class="main">(</span>
            assume_tac <span class="entity">ctxt</span>
            ORELSE'
            <span class="main">(</span><span class="entity">trans_rule_tac</span> <span class="entity">ctxt</span> <span class="entity">net</span> 
              <span class="entity">THEN_ALL_NEW_FWD</span> 
                <span class="entity">COND''</span> <span class="entity">is_prefer_cond</span>
                  <span class="main">(</span>TRY o DETERM o SOLVED' <span class="entity">s_tac</span><span class="main">)</span>
                  <span class="main">(</span>K all_tac<span class="main">)</span>
            <span class="main">)</span>
          <span class="main">)</span>
        <span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">trans_step_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">net</span> <span class="main">=</span> <span class="entity">trans_netD.get</span> <span class="entity">ctxt</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">s_tac</span> <span class="main">=</span> <span class="entity">side_tac</span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">in</span></span> DETERM o <span class="main">(</span>
        <span class="entity">COND''</span> <span class="entity">is_defer_cond</span> 
          <span class="main">(</span>SOLVED' <span class="entity">s_tac</span><span class="main">)</span>
          <span class="main">(</span>
            assume_tac <span class="entity">ctxt</span>
            ORELSE'
            <span class="main">(</span><span class="entity">trans_rule_tac</span> <span class="entity">ctxt</span> <span class="entity">net</span> 
              <span class="entity">THEN_ALL_NEW_FWD</span> 
                <span class="entity">COND''</span> <span class="entity">is_prefer_cond</span>
                  <span class="main">(</span>DETERM o SOLVED' <span class="entity">s_tac</span><span class="main">)</span>
                  <span class="main">(</span>K all_tac<span class="main">)</span>
            <span class="main">)</span>
          <span class="main">)</span>
        <span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">trans_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ss</span> <span class="main">=</span> put_simpset <span class="entity">HOL_basic_ss</span> <span class="entity">ctxt</span>
          addsimps <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> APP_def PROTECT_def ANNOT_def<span class="antiquote">}</span></span></span>
          addsimps <span class="entity">get_post_rules</span> <span class="entity">ctxt</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">trans_opt_tac</span> <span class="main">=</span> 
          resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> autoref_REMOVE_INTERNAL_EQ<span class="antiquote">}</span></span></span> 
          THEN' 
          <span class="entity">IF_SOLVED</span> <span class="main">(</span><span class="entity">REPEAT_ON_SUBGOAL</span> <span class="main">(</span><span class="entity">trans_step_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span><span class="entity">simp_tac</span> <span class="entity">ss</span> THEN' resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> REMOVE_INTERNAL_EQI<span class="antiquote">}</span></span></span><span class="main">)</span>
            <span class="main">(</span>K all_tac<span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        Seq.INTERVAL <span class="entity">trans_opt_tac</span>
      <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">trans_analyze</span> <span class="main">_</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">_</span> <span class="main">=</span> <span class="entity">j</span> &lt; <span class="entity">i</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">trans_pretty_failure</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">j</span> <span class="entity">st</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">j</span> &lt; <span class="entity">i</span> <span class="keyword2"><span class="keyword">then</span></span> Pretty.str <span class="inner_quoted">"No failure"</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">goal</span> <span class="main">=</span> Logic.get_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="entity">i</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">concl</span> <span class="main">=</span> strip_all_body <span class="entity">goal</span> |&gt; Logic.strip_imp_concl

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">msg</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">concl</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span>DEFER_tag <span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span> 
            <span class="main">=&gt;</span> Pretty.str <span class="inner_quoted">"Could not solve defered side condition"</span>
        <span class="main">|</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">∈</span><span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span> 
            <span class="main">=&gt;</span> Pretty.str <span class="inner_quoted">"Could not refine subterm"</span>
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Pretty.str <span class="inner_quoted">"Internal: Unexpected goal"</span>
      <span class="keyword2"><span class="keyword">in</span></span> 
        Pretty.block <span class="main">[</span>
          <span class="entity">msg</span><span class="main">,</span>
          Pretty.fbrk<span class="main">,</span>
          Syntax.pretty_term <span class="entity">ctxt</span> <span class="entity">goal</span>
        <span class="main">]</span>
      <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">trans_phase</span> <span class="main">=</span> <span class="main">{</span>
      init <span class="main">=</span> <span class="entity">trans_netD.init</span><span class="main">,</span>
      tac <span class="main">=</span> <span class="entity">trans_tac</span><span class="main">,</span>
      analyze <span class="main">=</span> <span class="entity">trans_analyze</span><span class="main">,</span>
      pretty_failure <span class="main">=</span> <span class="entity">trans_pretty_failure</span>
    <span class="main">}</span>


    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">setup</span> <span class="main">=</span> I
      #&gt; <span class="entity">autoref_post_simps.setup</span> 

  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="entity">Autoref_Translate.setup</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Standard side-tactics›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Preconditions›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">autoref_tag_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">PRECOND_tag</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">==</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>
<span class="keyword1" id="Autoref_Translate-PRECOND_tagI"><span class="command">lemma</span></span> PRECOND_tagI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">==&gt;</span> PRECOND_tag <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">SIDE_PRECOND</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">==</span> PREFER PRECOND_tag <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">declaration</span></span> <span class="quoted">‹
  <span class="entity">Tagged_Solver.declare_solver</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> PRECOND_tagI<span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> PRECOND<span class="antiquote">}</span></span></span> 
    <span class="inner_quoted">"Refinement: Solve preconditions"</span> 
    <span class="main">(</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> SOLVED' <span class="main">(</span>
        SELECT_GOAL <span class="main">(</span><span class="entity">auto_tac</span> <span class="entity">ctxt</span><span class="main">)</span>
      <span class="main">)</span>
    <span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Optional preconditions›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">autoref_tag_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">PRECOND_OPT_tag</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">==</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>
<span class="keyword1" id="Autoref_Translate-PRECOND_OPT_tagI"><span class="command">lemma</span></span> PRECOND_OPT_tagI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">==&gt;</span> PRECOND_OPT_tag <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">SIDE_PRECOND_OPT</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">==</span> PREFER PRECOND_OPT_tag <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>
<span class="keyword1"><span class="command">declaration</span></span> <span class="quoted">‹
  <span class="entity">Tagged_Solver.declare_solver</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> PRECOND_OPT_tagI<span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> PRECOND_OPT<span class="antiquote">}</span></span></span> 
    <span class="inner_quoted">"Refinement: Solve optional preconditions"</span> 
    <span class="main">(</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> SOLVED' <span class="main">(</span><span class="entity">asm_full_simp_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Autoref_Gen_Algo">
<div class="head">
<h1>Theory Autoref_Gen_Algo</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Infrastructure for Generic Algorithms›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Autoref_Gen_Algo
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Autoref_Translate.html">Autoref_Translate</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* TODO/FIXME: The priority ordering is not yet suited for generic
  algorithms! If a refinement rule is generic, the homogenity and relator
  measures make no sense, as they are applied to schematic variables.
  However, currently generic algorithms seem to have lower priority than
  specific ones, so we can probably live with this problem for a while.
*)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">autoref_tag_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">GEN_ALGO_tag</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">==</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>
<span class="keyword1" id="Autoref_Gen_Algo-GEN_ALGO_tagI"><span class="command">lemma</span></span> GEN_ALGO_tagI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">==&gt;</span> GEN_ALGO_tag <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">SIDE_GEN_ALGO</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">==</span> PREFER_tag <span class="main">(</span>GEN_ALGO_tag <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Autoref_Gen_Algo</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span> 

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">transform_ga_rule</span> <span class="entity">context</span> <span class="entity">rl</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Context.proof_of <span class="entity">context</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">warn</span> <span class="entity">msg</span> <span class="main">=</span> Pretty.block <span class="main">[</span>
        Pretty.str <span class="entity">msg</span><span class="main">,</span> 
        Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span>
        Pretty.str <span class="inner_quoted">"("</span><span class="main">,</span>
        Thm.pretty_thm <span class="entity">ctxt</span> <span class="entity">rl</span><span class="main">,</span>
        Pretty.str <span class="inner_quoted">")"</span>
        <span class="main">]</span>
      |&gt; Pretty.string_of |&gt; warning
   
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_side_prem</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span>PREFER_tag <span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span> <span class="main">=</span> true
        <span class="main">|</span> <span class="entity">is_side_prem</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span>DEFER_tag <span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span> <span class="main">=</span> true
        <span class="main">|</span> <span class="entity">is_side_prem</span> <span class="main">_</span> <span class="main">=</span> false
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> exists <span class="entity">is_side_prem</span> <span class="main">(</span>Thm.prems_of <span class="entity">rl</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="entity">warn</span> <span class="main">(</span><span class="inner_quoted">"autoref_ga_rules: SIDE condition premise not allowed here"</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
      <span class="main">;</span>
      <span class="keyword2"><span class="keyword">case</span></span> Thm.concl_of <span class="entity">rl</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">∈</span><span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span> <span class="main">=&gt;</span> 
          <span class="entity">warn</span> <span class="main">(</span><span class="inner_quoted">"autoref_ga_rules: Refinement condition conclusion. Did you"</span>
            ^<span class="inner_quoted">" mean an autoref_rule?"</span><span class="main">)</span>  
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">)</span>
      <span class="main">;</span>
      <span class="main">[</span><span class="entity">rl</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">ga_side_thms</span> <span class="main">=</span> <span class="entity">Named_Sorted_Thms</span> <span class="main">(</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_ga_rules<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Additional rules for generic algorithm side conditions"</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sort</span> <span class="main">=</span> K I
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">transform</span> <span class="main">=</span> <span class="entity">transform_ga_rule</span>
    <span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">side_ga_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> resolve_tac <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">ga_side_thms.get</span> <span class="entity">ctxt</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">side_ga_op_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> 
      SOLVED' <span class="main">(</span><span class="entity">Autoref_Tacticals.REPEAT_ON_SUBGOAL</span> 
        <span class="main">(</span><span class="entity">Autoref_Translate.trans_step_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>


    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">setup</span> <span class="main">=</span> <span class="entity">ga_side_thms.setup</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">decl_setup</span> <span class="entity">phi</span> <span class="main">=</span> I
    #&gt; <span class="entity">Tagged_Solver.declare_solver</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> GEN_ALGO_tagI<span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> GEN_ALGO<span class="antiquote">}</span></span></span> 
        <span class="inner_quoted">"Autoref: Generic algorithm side condition solver"</span> 
        <span class="main">(</span> <span class="entity">side_ga_tac</span><span class="main">)</span> <span class="entity">phi</span>
    #&gt; <span class="entity">Autoref_Phases.declare_solver</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> GEN_OP_tagI<span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> GEN_OP<span class="antiquote">}</span></span></span> 
        <span class="inner_quoted">"Autoref: Generic algorithm operation instantiation"</span> 
        <span class="main">(</span> <span class="entity">side_ga_op_tac</span><span class="main">)</span> <span class="entity">phi</span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>  

<span class="keyword1"><span class="command">setup</span></span> <span class="entity">Autoref_Gen_Algo.setup</span>
<span class="keyword1"><span class="command">declaration</span></span> <span class="entity">Autoref_Gen_Algo.decl_setup</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Autoref_Chapter">
<div class="head">
<h1>Theory Autoref_Chapter</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Automatic Refinement›</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Autoref_Chapter <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Autoref_Tool">
<div class="head">
<h1>Theory Autoref_Tool</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Automatic Refinement Tool›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Autoref_Tool
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="Autoref_Translate.html">Autoref_Translate</a> 
  <a href="Autoref_Gen_Algo.html">Autoref_Gen_Algo</a>
  <a href="Autoref_Relator_Interface.html">Autoref_Relator_Interface</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Standard setup›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Declaration of standard phases›</span></span>

<span class="keyword1"><span class="command">declaration</span></span> <span class="quoted">‹<span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">phi</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword3"><span class="keyword">open</span></span> Autoref_Phases <span class="keyword2"><span class="keyword">in</span></span>
  I
  #&gt; <span class="entity">register_phase</span> <span class="inner_quoted">"id_op"</span> <span class="inner_numeral">10</span> <span class="entity">Autoref_Id_Ops.id_phase</span> <span class="entity">phi</span>
  #&gt; <span class="entity">register_phase</span> <span class="inner_quoted">"rel_inf"</span> <span class="inner_numeral">20</span> 
       <span class="entity">Autoref_Rel_Inf.roi_phase</span> <span class="entity">phi</span>
  #&gt; <span class="entity">register_phase</span> <span class="inner_quoted">"fix_rel"</span> <span class="inner_numeral">22</span>
       <span class="entity">Autoref_Fix_Rel.phase</span> <span class="entity">phi</span>
  #&gt; <span class="entity">register_phase</span> <span class="inner_quoted">"trans"</span> <span class="inner_numeral">30</span>
       <span class="entity">Autoref_Translate.trans_phase</span> <span class="entity">phi</span>
<span class="keyword2"><span class="keyword">end</span></span>
›</span>


<span class="comment1">(*
declaration {* fn phi =&gt; let open Autoref_Phases in
  I
  #&gt; register_phase "id_op" 10 Autoref_Id_Ops.id_ops_phase phi
  #&gt; register_phase "rel_inf" 20 
       Autoref_Rel_Inf.hm_infer_rel_phase phi
  #&gt; register_phase "fix_rel" 21
       Autoref_Fix_Rel.phase phi
  #&gt; register_phase "trans" 30
       Autoref_Translate.trans_phase phi
end
*}
*)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Main method›</span></span>
<span class="keyword1"><span class="command">method_setup</span></span> autoref <span class="main">=</span> <span class="quoted">‹<span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword3"><span class="keyword">open</span></span> Refine_Util
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">autoref_flags</span> <span class="main">=</span> 
          <span class="entity">parse_bool_config</span> <span class="inner_quoted">"trace"</span> <span class="entity">Autoref_Phases.cfg_trace</span>
      ||  <span class="entity">parse_bool_config</span> <span class="inner_quoted">"debug"</span> <span class="entity">Autoref_Phases.cfg_debug</span>
      ||  <span class="entity">parse_bool_config</span> <span class="inner_quoted">"keep_goal"</span> <span class="entity">Autoref_Phases.cfg_keep_goal</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">autoref_phases</span> <span class="main">=</span> 
      Args.$$$ <span class="inner_quoted">"phases"</span> |-- Args.colon |-- Scan.repeat1 Args.name

  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">parse_paren_lists</span> <span class="entity">autoref_flags</span> 
    |-- Scan.option <span class="main">(</span>Scan.lift <span class="main">(</span><span class="entity">autoref_phases</span><span class="main">)</span><span class="main">)</span> &gt;&gt;
    <span class="main">(</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">phases</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span>
      <span class="main">(</span>
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">phases</span> <span class="keyword2"><span class="keyword">of</span></span>
          NONE <span class="main">=&gt;</span> <span class="entity">Autoref_Phases.all_phases_tac</span>
        <span class="main">|</span> SOME <span class="entity">names</span> <span class="main">=&gt;</span> <span class="entity">Autoref_Phases.phases_tacN</span> <span class="entity">names</span>
      <span class="main">)</span> <span class="main">(</span><span class="entity">Autoref_Phases.init_data</span> <span class="entity">ctxt</span><span class="main">)</span> 
      <span class="comment1">(* TODO: If we want more fine-grained initialization here, solvers have
         to depend on phases, or on data that they initialize if necessary *)</span>
    <span class="main">)</span><span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>

›</span> <span class="quoted">"Automatic Refinement"</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Tools›</span></span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">higher_order_rl_of</span> <span class="entity">ctxt</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> Thm.concl_of <span class="entity">thm</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="quoted">"Trueprop <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="var">?t</span><span class="main">)</span><span class="main">∈</span><span class="main">_</span><span class="main">)</span>"</span><span class="antiquote">}</span></span></span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span> <span class="main">=</span> strip_comb <span class="entity">t</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> length <span class="entity">args</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> 
          <span class="entity">thm</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cT</span> <span class="main">=</span> TVar<span class="main">(</span><span class="main">(</span><span class="inner_quoted">"'c"</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">sort</span> <span class="quoted">type</span><span class="antiquote">}</span></span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">c</span> <span class="main">=</span> Var <span class="main">(</span><span class="main">(</span><span class="inner_quoted">"c"</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span><span class="entity">cT</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">R</span> <span class="main">=</span> Var <span class="main">(</span><span class="main">(</span><span class="inner_quoted">"R"</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span> <span class="entity">HOLogic.mk_setT</span> <span class="main">(</span><span class="entity">HOLogic.mk_prodT</span> <span class="main">(</span><span class="entity">cT</span><span class="main">,</span> fastype_of <span class="entity">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">goal</span> <span class="main">=</span> 
            <span class="entity">HOLogic.mk_mem</span> <span class="main">(</span><span class="entity">HOLogic.mk_prod</span> <span class="main">(</span><span class="entity">c</span><span class="main">,</span><span class="entity">f</span><span class="main">)</span><span class="main">,</span> <span class="entity">R</span><span class="main">)</span>
            |&gt; <span class="entity">HOLogic.mk_Trueprop</span>
            |&gt; Thm.cterm_of <span class="entity">ctxt</span>

          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res_thm</span> <span class="main">=</span> Goal.prove_internal <span class="entity">ctxt</span> <span class="main">[</span><span class="main">]</span> <span class="entity">goal</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> 
            REPEAT <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> fun_relI<span class="antiquote">}</span></span></span> <span class="inner_numeral">1</span><span class="main">)</span>
            THEN <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">thm</span><span class="main">]</span> <span class="inner_numeral">1</span><span class="main">)</span>
            THEN <span class="main">(</span>ALLGOALS <span class="main">(</span>assume_tac <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
          <span class="main">)</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="entity">res_thm</span>
        <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> THM<span class="main">(</span><span class="inner_quoted">"Expected autoref rule"</span><span class="main">,</span><span class="inner_numeral">~1</span><span class="main">,</span><span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">higher_order_rl_attr</span> <span class="main">=</span> 
      Thm.rule_attribute <span class="main">[</span><span class="main">]</span> <span class="main">(</span><span class="entity">higher_order_rl_of</span> o Context.proof_of<span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">Attrib.setup</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_higher_order_rule<span class="antiquote">}</span></span></span> 
      <span class="main">(</span>Scan.succeed <span class="entity">higher_order_rl_attr</span><span class="main">)</span> <span class="inner_quoted">"Autoref: Convert rule to higher-order form"</span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Advanced Debugging›</span></span>
<span class="keyword1"><span class="command">method_setup</span></span> autoref_trans_step_keep <span class="main">=</span> <span class="quoted">‹
  Scan.succeed <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span>
    <span class="entity">Autoref_Translate.trans_dbg_step_tac</span> <span class="main">(</span><span class="entity">Autoref_Phases.init_data</span> <span class="entity">ctxt</span><span class="main">)</span>
  <span class="main">)</span><span class="main">)</span>
›</span> <span class="quoted">"Single translation step, leaving unsolved side-coditions"</span>

<span class="keyword1"><span class="command">method_setup</span></span> autoref_trans_step <span class="main">=</span> <span class="quoted">‹
  Scan.succeed <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span>
    <span class="entity">Autoref_Translate.trans_step_tac</span> <span class="main">(</span><span class="entity">Autoref_Phases.init_data</span> <span class="entity">ctxt</span><span class="main">)</span>
  <span class="main">)</span><span class="main">)</span>
›</span> <span class="quoted">"Single translation step"</span>

<span class="keyword1"><span class="command">method_setup</span></span> autoref_trans_step_only <span class="main">=</span> <span class="quoted">‹
  Scan.succeed <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span>
    <span class="entity">Autoref_Translate.trans_step_only_tac</span> <span class="main">(</span><span class="entity">Autoref_Phases.init_data</span> <span class="entity">ctxt</span><span class="main">)</span>
  <span class="main">)</span><span class="main">)</span>
›</span> <span class="quoted">"Single translation step, not attempting to solve side-coditions"</span>

<span class="keyword1"><span class="command">method_setup</span></span> autoref_side <span class="main">=</span> <span class="quoted">‹
  Scan.succeed <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span>
    <span class="entity">Autoref_Translate.side_dbg_tac</span> <span class="main">(</span><span class="entity">Autoref_Phases.init_data</span> <span class="entity">ctxt</span><span class="main">)</span>
  <span class="main">)</span><span class="main">)</span>
›</span> <span class="quoted">"Solve side condition, leave unsolved subgoals"</span>

<span class="keyword1"><span class="command">method_setup</span></span> autoref_try_solve <span class="main">=</span> <span class="quoted">‹
  Scan.succeed <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span>
    <span class="entity">Autoref_Fix_Rel.try_solve_tac</span> <span class="main">(</span><span class="entity">Autoref_Phases.init_data</span> <span class="entity">ctxt</span><span class="main">)</span>
  <span class="main">)</span><span class="main">)</span>
›</span> <span class="quoted">"Try to solve constraint and trace debug information"</span>

<span class="keyword1"><span class="command">method_setup</span></span> autoref_solve_step <span class="main">=</span> <span class="quoted">‹
  Scan.succeed <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span>
    <span class="entity">Autoref_Fix_Rel.solve_step_tac</span> <span class="main">(</span><span class="entity">Autoref_Phases.init_data</span> <span class="entity">ctxt</span><span class="main">)</span>
  <span class="main">)</span><span class="main">)</span>
›</span> <span class="quoted">"Single-step of constraint solver"</span>

<span class="keyword1"><span class="command">method_setup</span></span> autoref_id_op <span class="main">=</span> <span class="quoted">‹
  Scan.succeed <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span>
    <span class="entity">Autoref_Id_Ops.id_tac</span> <span class="entity">ctxt</span>
  <span class="main">)</span><span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">method_setup</span></span> autoref_solve_id_op <span class="main">=</span> <span class="quoted">‹
  Scan.succeed <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span>
    <span class="entity">Autoref_Id_Ops.id_tac</span> <span class="main">(</span>Config.put <span class="entity">Autoref_Id_Ops.cfg_ss_id_op</span> false <span class="entity">ctxt</span><span class="main">)</span>
  <span class="main">)</span><span class="main">)</span>
›</span>



<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Autoref_Debug</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_thm_pairs</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">Autoref_Phases.init_data</span> <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p</span> <span class="main">=</span> <span class="entity">Autoref_Fix_Rel.thm_pairsD_get</span> <span class="entity">ctxt</span>
        |&gt; <span class="entity">Autoref_Fix_Rel.pretty_thm_pairs</span> <span class="entity">ctxt</span>
        |&gt; Pretty.string_of
    <span class="keyword2"><span class="keyword">in</span></span>
      warning <span class="entity">p</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_thm_pairs_matching</span> <span class="entity">ctxt</span> <span class="entity">cpat</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pat</span> <span class="main">=</span> Thm.term_of <span class="entity">cpat</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">Autoref_Phases.init_data</span> <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thy</span> <span class="main">=</span> Proof_Context.theory_of <span class="entity">ctxt</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">matches</span> NONE <span class="main">=</span> false
        <span class="main">|</span> <span class="entity">matches</span> <span class="main">(</span>SOME <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Pattern.matches <span class="entity">thy</span> <span class="main">(</span><span class="entity">pat</span><span class="main">,</span><span class="entity">f</span><span class="main">)</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p</span> <span class="main">=</span> <span class="entity">Autoref_Fix_Rel.thm_pairsD_get</span> <span class="entity">ctxt</span>
        |&gt; filter <span class="main">(</span><span class="entity">matches</span> o <span class="main">#</span><span class="inner_numeral">1</span><span class="main">)</span>
        |&gt; <span class="entity">Autoref_Fix_Rel.pretty_thm_pairs</span> <span class="entity">ctxt</span>
        |&gt; Pretty.string_of
    <span class="keyword2"><span class="keyword">in</span></span>
      warning <span class="entity">p</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹General casting-tag, that allows type-casting on concrete level, while 
  being identity on abstract level.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CAST</span> <span class="main">≡</span> id"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"CAST <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* TODO: This idea does currently not work, b/c a homogeneity rule
  will be created from the (λx. x, CAST)∈R → R rule, which will always
  be applied first! As a workaround, we make the cast mandatory!
*)</span>
<span class="comment1">(*lemma [autoref_rules]: 
  assumes "PRIO_TAG_GEN_ALGO"
  shows "(λx. x,CAST) ∈ R → R"
  by auto
*)</span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Hide internal stuff›</span></span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>input<span class="main">)</span> rel_ANNOT <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">:::<span class="hidden">⇩</span><sub>r</sub></span>"</span> 10<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>input<span class="main">)</span> ind_ANNOT <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">::#<span class="hidden">⇩</span><sub>r</sub></span>"</span> 10<span class="main">)</span>


<span class="keyword1"><span class="command">locale</span></span> autoref_syn <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>input<span class="main">)</span> APP <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">$</span>"</span> 900<span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>input<span class="main">)</span> rel_ANNOT <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">:::</span>"</span> 10<span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>input<span class="main">)</span> ind_ANNOT <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">::#</span>"</span> 10<span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> OP <span class="main">(</span><span class="quoted">"<span class="keyword1">OP</span>"</span><span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>input<span class="main">)</span> ABS <span class="main">(</span><span class="keyword2"><span class="keyword">binder</span></span> <span class="quoted">"<span class="keyword1">λ''</span>"</span> 10<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> <span class="main">(</span>input<span class="main">)</span> APP <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">$</span>"</span> 900<span class="main">)</span>
<span class="keyword1"><span class="command">no_notation</span></span> <span class="main">(</span>input<span class="main">)</span> ABS <span class="main">(</span><span class="keyword2"><span class="keyword">binder</span></span> <span class="quoted">"<span class="keyword1">λ''</span>"</span> 10<span class="main">)</span>

<span class="keyword1"><span class="command">no_notation</span></span> <span class="main">(</span>input<span class="main">)</span> rel_ANNOT <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">:::</span>"</span> 10<span class="main">)</span>
<span class="keyword1"><span class="command">no_notation</span></span> <span class="main">(</span>input<span class="main">)</span> ind_ANNOT <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">::#</span>"</span> 10<span class="main">)</span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> PROTECT ANNOT OP APP ABS ID_FAIL rel_annot ind_annot

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Autoref_Bindings_HOL">
<div class="head">
<h1>Theory Autoref_Bindings_HOL</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Standard HOL Bindings›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Autoref_Bindings_HOL
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Autoref_Tool.html">Tool/Autoref_Tool</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>


  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Structural Expansion"</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    In some situations, autoref imitates the operations on typeclasses and
    the typeclass hierarchy. This may result in structural mismatches, e.g.,
    a hashcode side-condition may look like:
      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> [display] <span class="raw_text"><span class="raw_text">"is_hashcode (prod_eq (=) (=)) hashcode"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

    This cannot be discharged by the rule
      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> [display] <span class="raw_text"><span class="raw_text">"is_hashcode (=) hashcode"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
    
    In order to handle such cases, we introduce a set of simplification lemmas
    that expand the structure of an operator as far as possible.
    These lemmas are integrated into a tagged solver, that can prove equality
    between operators modulo structural expansion.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">STRUCT_EQ_tag</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="keyword1" id="Autoref_Bindings_HOL-STRUCT_EQ_tagI"><span class="command">lemma</span></span> STRUCT_EQ_tagI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span><span class="free">y</span> <span class="main">⟹</span> STRUCT_EQ_tag <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Autoref_Struct_Expand</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">autoref_struct_expand</span> <span class="main">=</span> <span class="entity">Named_Thms</span> <span class="main">(</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> autoref_struct_expand<span class="antiquote">}</span></span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Autoref: Structural expansion lemmas"</span>
    <span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">expand_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ss</span> <span class="main">=</span> put_simpset <span class="entity">HOL_basic_ss</span> <span class="entity">ctxt</span> addsimps <span class="entity">autoref_struct_expand.get</span> <span class="entity">ctxt</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      SOLVED' <span class="main">(</span><span class="entity">asm_simp_tac</span> <span class="entity">ss</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>


    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">setup</span> <span class="main">=</span> <span class="entity">autoref_struct_expand.setup</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">decl_setup</span> <span class="main">=</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">phi</span> <span class="main">=&gt;</span>
      <span class="entity">Tagged_Solver.declare_solver</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> STRUCT_EQ_tagI<span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> STRUCT_EQ<span class="antiquote">}</span></span></span> 
        <span class="inner_quoted">"Autoref: Equality modulo structural expansion"</span> 
        <span class="main">(</span><span class="entity">expand_tac</span><span class="main">)</span> <span class="entity">phi</span>

  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="entity">Autoref_Struct_Expand.setup</span>
<span class="keyword1"><span class="command">declaration</span></span> <span class="entity">Autoref_Struct_Expand.decl_setup</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Sometimes, also relators must be expanded. Usually to check them to be the identity relator›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">REL_IS_ID</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">=</span>Id"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">REL_FORCE_ID</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">=</span>Id"</span></span>
<span class="keyword1" id="Autoref_Bindings_HOL-REL_IS_ID_trigger"><span class="command">lemma</span></span> REL_IS_ID_trigger<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">=</span>Id <span class="main">⟹</span> REL_IS_ID <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1" id="Autoref_Bindings_HOL-REL_FORCE_ID_trigger"><span class="command">lemma</span></span> REL_FORCE_ID_trigger<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">=</span>Id <span class="main">⟹</span> REL_FORCE_ID <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">declaration</span></span> <span class="quoted">‹<span class="entity">Tagged_Solver.add_triggers</span> 
  <span class="inner_quoted">"Relators.relator_props_solver"</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> REL_IS_ID_trigger<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">declaration</span></span> <span class="quoted">‹<span class="entity">Tagged_Solver.add_triggers</span> 
  <span class="inner_quoted">"Relators.force_relator_props_solver"</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> REL_FORCE_ID_trigger<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">PREFER_id</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> PREFER REL_IS_ID <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>



  
  <span class="comment1">(* TODO: Most of these are parametricity theorems! *)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">fun_rel</span> <span class="quoted">i_fun</span><span class="main">]</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Booleans"</span></span>
  <span class="keyword1"><span class="command">consts</span></span>
    i_bool <span class="main">::</span> <span class="quoted">interface</span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">bool_rel</span> <span class="quoted">i_bool</span><span class="main">]</span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"True <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> i_bool"</span></span>
    <span class="quoted"><span class="quoted">"False <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> i_bool"</span></span>
    <span class="quoted"><span class="quoted">"conj <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> i_bool <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(⟷)</span> <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> i_bool <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(⟶)</span> <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> i_bool <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool"</span></span>
    <span class="quoted"><span class="quoted">"disj <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> i_bool <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool"</span></span>
    <span class="quoted"><span class="quoted">"Not <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> i_bool <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool"</span></span>
    <span class="quoted"><span class="quoted">"case_bool <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span>"</span></span>
    <span class="quoted"><span class="quoted">"old.rec_bool <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Autoref_Bindings_HOL-autoref_bool"><span class="command">lemma</span></span> autoref_bool<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">∈</span>bool_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>conj<span class="main">,</span>conj<span class="main">)</span><span class="main">∈</span>bool_rel<span class="main">→</span>bool_rel<span class="main">→</span>bool_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>disj<span class="main">,</span>disj<span class="main">)</span><span class="main">∈</span>bool_rel<span class="main">→</span>bool_rel<span class="main">→</span>bool_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>Not<span class="main">,</span>Not<span class="main">)</span><span class="main">∈</span>bool_rel<span class="main">→</span>bool_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>case_bool<span class="main">,</span>case_bool<span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">→</span><span class="free">R</span><span class="main">→</span>bool_rel<span class="main">→</span><span class="free">R</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>old.rec_bool<span class="main">,</span>old.rec_bool<span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">→</span><span class="free">R</span><span class="main">→</span>bool_rel<span class="main">→</span><span class="free">R</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(⟷)</span><span class="main">,</span> <span class="main">(⟷)</span><span class="main">)</span><span class="main">∈</span>bool_rel<span class="main">→</span>bool_rel<span class="main">→</span>bool_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(⟶)</span><span class="main">,</span> <span class="main">(⟶)</span><span class="main">)</span><span class="main">∈</span>bool_rel<span class="main">→</span>bool_rel<span class="main">→</span>bool_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bool.split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rec_bool_is_case<span class="main">)</span>


  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Standard Type Classes"</span></span>


<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    We allow these operators for all interfaces.
›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(&lt;)</span> <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(≤)</span> <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(=)</span> <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(+)</span> <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(-)</span> <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">(div)</span> <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">(mod)</span> <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(*)</span> <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span>"</span></span>
    <span class="quoted"><span class="quoted">"numeral <span class="free">x</span> <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span>"</span></span>
    <span class="quoted"><span class="quoted">"uminus <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Autoref_Bindings_HOL-pat_num_generic"><span class="command">lemma</span></span> pat_num_generic<span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≡</span> <span class="keyword1">OP</span> <span class="main">0</span> <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≡</span> <span class="keyword1">OP</span> <span class="main">1</span> <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span>"</span></span>
    <span class="quoted"><span class="quoted">"numeral <span class="free">x</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">OP</span> <span class="main">(</span>numeral <span class="free">x</span><span class="main">)</span> <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"PRIO_TAG_GEN_ALGO"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(&lt;)</span><span class="main">,</span> <span class="main">(&lt;)</span><span class="main">)</span> <span class="main">∈</span> Id<span class="main">→</span>Id<span class="main">→</span>bool_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(≤)</span><span class="main">,</span> <span class="main">(≤)</span><span class="main">)</span> <span class="main">∈</span> Id<span class="main">→</span>Id<span class="main">→</span>bool_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span><span class="main">,</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">∈</span> Id<span class="main">→</span>Id<span class="main">→</span>bool_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>numeral <span class="free">x</span><span class="main">,</span><span class="keyword1">OP</span> <span class="main">(</span>numeral <span class="free">x</span><span class="main">)</span> <span class="main">:::</span> Id<span class="main">)</span> <span class="main">∈</span> Id"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>uminus<span class="main">,</span>uminus<span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> Id"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> Id"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> Id"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Functional Combinators"</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"id <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="Autoref_Bindings_HOL-autoref_id"><span class="command">lemma</span></span> autoref_id<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>id<span class="main">,</span>id<span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">→</span><span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(o)</span>"</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(∘)</span> <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="free">Ia</span><span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span><span class="free">Ib</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="free">Ic</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">Ia</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">Ic</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">Ib</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="Autoref_Bindings_HOL-autoref_comp"><span class="command">lemma</span></span> autoref_comp<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">(o)</span><span class="main">,</span> <span class="keyword1">(o)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">Ra</span> <span class="main">→</span> <span class="free">Rb</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">Rc</span> <span class="main">→</span> <span class="free">Ra</span><span class="main">)</span> <span class="main">→</span> <span class="free">Rc</span> <span class="main">→</span> <span class="free">Rb</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"If <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> i_bool <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="Autoref_Bindings_HOL-autoref_If"><span class="command">lemma</span></span> autoref_If<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>If<span class="main">,</span>If<span class="main">)</span><span class="main">∈</span>Id<span class="main">→</span><span class="free">R</span><span class="main">→</span><span class="free">R</span><span class="main">→</span><span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Autoref_Bindings_HOL-autoref_If_cong"><span class="command">lemma</span></span> autoref_If_cong<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c'</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">∈</span>Id"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"REMOVE_INTERNAL <span class="free">c</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">t'</span><span class="main">,</span><span class="free">t</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> REMOVE_INTERNAL <span class="free">c</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">e'</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>If <span class="free">c'</span> <span class="free">t'</span> <span class="free">e'</span><span class="main">,</span><span class="main">(</span><span class="keyword1">OP</span> If <span class="main">:::</span> Id<span class="main">→</span><span class="free">R</span><span class="main">→</span><span class="free">R</span><span class="main">→</span><span class="free">R</span><span class="main">)</span><span class="main">$</span><span class="free">c</span><span class="main">$</span><span class="free">t</span><span class="main">$</span><span class="free">e</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Let <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">Ix</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="free">Ix</span><span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span><span class="free">Iy</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">Iy</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Autoref_Bindings_HOL-autoref_Let"><span class="command">lemma</span></span> autoref_Let<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>Let<span class="main">,</span>Let<span class="main">)</span><span class="main">∈</span><span class="free">Ra</span> <span class="main">→</span> <span class="main">(</span><span class="free">Ra</span><span class="main">→</span><span class="free">Rr</span><span class="main">)</span> <span class="main">→</span> <span class="free">Rr</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>

  <span class="keyword1" id="Autoref_Bindings_HOL-autoref_Let_cong"><span class="command">lemma</span></span> autoref_Let_cong<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x'</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">∈</span><span class="free">Ra</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="bound">y'</span><span class="main">.</span> REMOVE_INTERNAL <span class="main">(</span><span class="free">x</span><span class="main">=</span><span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">y'</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free">Ra</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">y'</span><span class="main">,</span> <span class="free">f</span><span class="main">$</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free">Rr</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Let <span class="free">x'</span> <span class="free">f'</span><span class="main">,</span><span class="main">(</span><span class="keyword1">OP</span> Let <span class="main">:::</span> <span class="free">Ra</span> <span class="main">→</span> <span class="main">(</span><span class="free">Ra</span> <span class="main">→</span> <span class="free">Rr</span><span class="main">)</span> <span class="main">→</span> <span class="free">Rr</span><span class="main">)</span><span class="main">$</span><span class="free">x</span><span class="main">$</span><span class="free">f</span><span class="main">)</span><span class="main">∈</span><span class="free">Rr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Unit"</span></span>
  <span class="keyword1"><span class="command">consts</span></span> i_unit <span class="main">::</span> <span class="quoted">interface</span>
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">unit_rel</span> <span class="quoted">i_unit</span><span class="main">]</span>

  <span class="comment1">(*lemma [autoref_itype]: "(a::unit) ::<span class="hidden">⇩</span><sub>i</sub> i_unit" by simp*)</span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">()</span><span class="main">,</span><span class="main">()</span><span class="main">)</span><span class="main">∈</span>unit_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Nat"</span></span>
    <span class="keyword1"><span class="command">consts</span></span> i_nat <span class="main">::</span> <span class="quoted">interface</span>
    <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">nat_rel</span> <span class="quoted">i_nat</span><span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1" id="Autoref_Bindings_HOL-pat_num_nat"><span class="command">lemma</span></span> pat_num_nat<span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">::</span>nat <span class="main">≡</span> <span class="keyword1">OP</span> <span class="main">0</span> <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> i_nat"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">::</span>nat <span class="main">≡</span> <span class="keyword1">OP</span> <span class="main">1</span> <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> i_nat"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>numeral <span class="free">x</span><span class="main">)</span><span class="main">::</span>nat <span class="main">≡</span> <span class="main">(</span><span class="keyword1">OP</span> <span class="main">(</span>numeral <span class="free">x</span><span class="main">)</span> <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> i_nat<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
   
    <span class="keyword1" id="Autoref_Bindings_HOL-autoref_nat"><span class="command">lemma</span></span> autoref_nat<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">∈</span> nat_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc<span class="main">,</span> Suc<span class="main">)</span> <span class="main">∈</span> nat_rel <span class="main">→</span> nat_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">∈</span> nat_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>numeral <span class="free">n</span><span class="main">::</span>nat<span class="main">,</span>numeral <span class="free">n</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">∈</span> nat_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(&lt;)</span><span class="main">,</span> <span class="main">(&lt;)</span> <span class="main">::</span>nat <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> nat_rel <span class="main">→</span> nat_rel <span class="main">→</span> bool_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(≤)</span><span class="main">,</span> <span class="main">(≤)</span> <span class="main">::</span>nat <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> nat_rel <span class="main">→</span> nat_rel <span class="main">→</span> bool_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span><span class="main">,</span> <span class="main">(=)</span> <span class="main">::</span>nat <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> nat_rel <span class="main">→</span> nat_rel <span class="main">→</span> bool_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(+)</span> <span class="main">::</span>nat<span class="main">⇒</span><span class="main">_</span><span class="main">,</span><span class="main">(+)</span><span class="main">)</span><span class="main">∈</span>nat_rel<span class="main">→</span>nat_rel<span class="main">→</span>nat_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(-)</span> <span class="main">::</span>nat<span class="main">⇒</span><span class="main">_</span><span class="main">,</span><span class="main">(-)</span><span class="main">)</span><span class="main">∈</span>nat_rel<span class="main">→</span>nat_rel<span class="main">→</span>nat_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">(div)</span> <span class="main">::</span>nat<span class="main">⇒</span><span class="main">_</span><span class="main">,</span><span class="keyword1">(div)</span><span class="main">)</span><span class="main">∈</span>nat_rel<span class="main">→</span>nat_rel<span class="main">→</span>nat_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(*)</span><span class="main">,</span> <span class="main">(*)</span><span class="main">)</span><span class="main">∈</span>nat_rel<span class="main">→</span>nat_rel<span class="main">→</span>nat_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">(mod)</span><span class="main">,</span> <span class="keyword1">(mod)</span><span class="main">)</span><span class="main">∈</span>nat_rel<span class="main">→</span>nat_rel<span class="main">→</span>nat_rel"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1" id="Autoref_Bindings_HOL-autoref_case_nat"><span class="command">lemma</span></span> autoref_case_nat<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span>case_nat<span class="main">,</span>case_nat<span class="main">)</span><span class="main">∈</span><span class="free">Ra</span> <span class="main">→</span> <span class="main">(</span>Id <span class="main">→</span> <span class="free">Ra</span><span class="main">)</span> <span class="main">→</span> Id <span class="main">→</span> <span class="free">Ra</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1" id="Autoref_Bindings_HOL-autoref_rec_nat"><span class="command">lemma</span></span> autoref_rec_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rec_nat<span class="main">,</span>rec_nat<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">→</span> <span class="main">(</span>Id <span class="main">→</span> <span class="free">R</span> <span class="main">→</span> <span class="free">R</span><span class="main">)</span> <span class="main">→</span> Id <span class="main">→</span> <span class="free">R</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">goal_cases</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">n</span> <span class="skolem">n'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_rel_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Int"</span></span>
    <span class="keyword1"><span class="command">consts</span></span> i_int <span class="main">::</span> <span class="quoted">interface</span>
    <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">int_rel</span> <span class="quoted">i_int</span><span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1" id="Autoref_Bindings_HOL-pat_num_int"><span class="command">lemma</span></span> pat_num_int<span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">::</span>int <span class="main">≡</span> <span class="keyword1">OP</span> <span class="main">0</span> <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> i_int"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">::</span>int <span class="main">≡</span> <span class="keyword1">OP</span> <span class="main">1</span> <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> i_int"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>numeral <span class="free">x</span><span class="main">)</span><span class="main">::</span>int <span class="main">≡</span> <span class="main">(</span><span class="keyword1">OP</span> <span class="main">(</span>numeral <span class="free">x</span><span class="main">)</span> <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> i_int<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

    <span class="comment1">(*lemma [autoref_itype]:
      "((&lt;) :: int ⇒ _) ::<span class="hidden">⇩</span><sub>i</sub> i_int →<span class="hidden">⇩</span><sub>i</sub> i_int →<span class="hidden">⇩</span><sub>i</sub> i_bool"
      "((≤) :: int ⇒ _) ::<span class="hidden">⇩</span><sub>i</sub> i_int →<span class="hidden">⇩</span><sub>i</sub> i_int →<span class="hidden">⇩</span><sub>i</sub> i_bool"
      "((=) :: int ⇒ _) ::<span class="hidden">⇩</span><sub>i</sub> i_int →<span class="hidden">⇩</span><sub>i</sub> i_int →<span class="hidden">⇩</span><sub>i</sub> i_bool"
      "((+) :: int ⇒ _) ::<span class="hidden">⇩</span><sub>i</sub> i_int →<span class="hidden">⇩</span><sub>i</sub> i_int →<span class="hidden">⇩</span><sub>i</sub> i_int"
      "((-) :: int ⇒ _) ::<span class="hidden">⇩</span><sub>i</sub> i_int →<span class="hidden">⇩</span><sub>i</sub> i_int →<span class="hidden">⇩</span><sub>i</sub> i_int"
      "((div) :: int ⇒ _) ::<span class="hidden">⇩</span><sub>i</sub> i_int →<span class="hidden">⇩</span><sub>i</sub> i_int →<span class="hidden">⇩</span><sub>i</sub> i_int"
      "(uminus :: int ⇒ _) ::<span class="hidden">⇩</span><sub>i</sub> i_int →<span class="hidden">⇩</span><sub>i</sub> i_int"
      by auto*)</span>

    <span class="keyword1" id="Autoref_Bindings_HOL-autoref_int"><span class="command">lemma</span></span> autoref_int<span class="main">[</span><span class="operator">autoref_rules</span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">overloaded</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">::</span>int<span class="main">)</span> <span class="main">∈</span> int_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">::</span>int<span class="main">)</span> <span class="main">∈</span> int_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>numeral <span class="free">n</span><span class="main">::</span>int<span class="main">,</span>numeral <span class="free">n</span><span class="main">::</span>int<span class="main">)</span> <span class="main">∈</span> int_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(&lt;)</span><span class="main">,</span> <span class="main">(&lt;)</span> <span class="main">::</span>int <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> int_rel <span class="main">→</span> int_rel <span class="main">→</span> bool_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(≤)</span><span class="main">,</span> <span class="main">(≤)</span> <span class="main">::</span>int <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> int_rel <span class="main">→</span> int_rel <span class="main">→</span> bool_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span><span class="main">,</span> <span class="main">(=)</span> <span class="main">::</span>int <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> int_rel <span class="main">→</span> int_rel <span class="main">→</span> bool_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(+)</span> <span class="main">::</span>int<span class="main">⇒</span><span class="main">_</span><span class="main">,</span><span class="main">(+)</span><span class="main">)</span><span class="main">∈</span>int_rel<span class="main">→</span>int_rel<span class="main">→</span>int_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(-)</span> <span class="main">::</span>int<span class="main">⇒</span><span class="main">_</span><span class="main">,</span><span class="main">(-)</span><span class="main">)</span><span class="main">∈</span>int_rel<span class="main">→</span>int_rel<span class="main">→</span>int_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">(div)</span> <span class="main">::</span>int<span class="main">⇒</span><span class="main">_</span><span class="main">,</span><span class="keyword1">(div)</span><span class="main">)</span><span class="main">∈</span>int_rel<span class="main">→</span>int_rel<span class="main">→</span>int_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>uminus<span class="main">,</span>uminus<span class="main">)</span><span class="main">∈</span>int_rel<span class="main">→</span>int_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(*)</span><span class="main">,</span> <span class="main">(*)</span><span class="main">)</span><span class="main">∈</span>int_rel<span class="main">→</span>int_rel<span class="main">→</span>int_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">(mod)</span><span class="main">,</span> <span class="keyword1">(mod)</span><span class="main">)</span><span class="main">∈</span>int_rel<span class="main">→</span>int_rel<span class="main">→</span>int_rel"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>
  
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Product"</span></span>
    <span class="keyword1"><span class="command">consts</span></span> i_prod <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface <span class="main">⇒</span> interface"</span></span>
    <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">prod_rel</span> <span class="quoted">i_prod</span><span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
    <span class="comment1">(*
    lemma [autoref_itype]:
      "Pair ::<span class="hidden">⇩</span><sub>i</sub> Ia →<span class="hidden">⇩</span><sub>i</sub> Ib →<span class="hidden">⇩</span><sub>i</sub> ⟨Ia,Ib⟩<span class="hidden">⇩</span><sub>i</sub>i_prod"
      "case_prod ::<span class="hidden">⇩</span><sub>i</sub> (Ia →<span class="hidden">⇩</span><sub>i</sub> Ib →<span class="hidden">⇩</span><sub>i</sub> I) →<span class="hidden">⇩</span><sub>i</sub> ⟨Ia,Ib⟩<span class="hidden">⇩</span><sub>i</sub>i_prod →<span class="hidden">⇩</span><sub>i</sub> I"
      "old.rec_prod ::<span class="hidden">⇩</span><sub>i</sub> (Ia →<span class="hidden">⇩</span><sub>i</sub> Ib →<span class="hidden">⇩</span><sub>i</sub> I) →<span class="hidden">⇩</span><sub>i</sub> ⟨Ia,Ib⟩<span class="hidden">⇩</span><sub>i</sub>i_prod →<span class="hidden">⇩</span><sub>i</sub> I"
      "fst ::<span class="hidden">⇩</span><sub>i</sub> ⟨Ia,Ib⟩<span class="hidden">⇩</span><sub>i</sub>i_prod →<span class="hidden">⇩</span><sub>i</sub> Ia"
      "snd ::<span class="hidden">⇩</span><sub>i</sub> ⟨Ia,Ib⟩<span class="hidden">⇩</span><sub>i</sub>i_prod →<span class="hidden">⇩</span><sub>i</sub> Ib"
      "((=) :: _×_ ⇒ _) ::<span class="hidden">⇩</span><sub>i</sub> ⟨Ia,Ib⟩<span class="hidden">⇩</span><sub>i</sub>i_prod →<span class="hidden">⇩</span><sub>i</sub> ⟨Ia,Ib⟩<span class="hidden">⇩</span><sub>i</sub>i_prod →<span class="hidden">⇩</span><sub>i</sub> i_bool"
      by auto
      *)</span>

    <span class="keyword1" id="Autoref_Bindings_HOL-prod_refine"><span class="command">lemma</span></span> prod_refine<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>Pair<span class="main">,</span>Pair<span class="main">)</span><span class="main">∈</span><span class="free">Ra</span> <span class="main">→</span> <span class="free">Rb</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>prod_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>case_prod<span class="main">,</span>case_prod<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">Ra</span> <span class="main">→</span> <span class="free">Rb</span> <span class="main">→</span> <span class="free">Rr</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>prod_rel <span class="main">→</span> <span class="free">Rr</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>old.rec_prod<span class="main">,</span>old.rec_prod<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">Ra</span> <span class="main">→</span> <span class="free">Rb</span> <span class="main">→</span> <span class="free">Rr</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>prod_rel <span class="main">→</span> <span class="free">Rr</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>fst<span class="main">,</span>fst<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>prod_rel <span class="main">→</span> <span class="free">Ra</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>snd<span class="main">,</span>snd<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>prod_rel <span class="main">→</span> <span class="free">Rb</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split 
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_rel_def rec_prod_is_case<span class="main">)</span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">prod_eq</span> <span class="free"><span class="bound"><span class="entity">eqa</span></span></span> <span class="free"><span class="bound"><span class="entity">eqb</span></span></span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="main">≡</span> 
      <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a1</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a2</span><span class="main">,</span><span class="bound">b2</span><span class="main">)</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">eqa</span></span></span> <span class="bound">a1</span> <span class="bound">a2</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">eqb</span></span></span> <span class="bound">b1</span> <span class="bound">b2</span>"</span></span>

    <span class="keyword1" id="Autoref_Bindings_HOL-prod_eq_autoref"><span class="command">lemma</span></span> prod_eq_autoref<span class="main">[</span><span class="operator">autoref_rules</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">overloaded</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⟦</span>GEN_OP <span class="free">eqa</span> <span class="main">(=)</span> <span class="main">(</span><span class="free">Ra</span><span class="main">→</span><span class="free">Ra</span><span class="main">→</span>Id<span class="main">)</span><span class="main">;</span> GEN_OP <span class="free">eqb</span> <span class="main">(=)</span> <span class="main">(</span><span class="free">Rb</span><span class="main">→</span><span class="free">Rb</span><span class="main">→</span>Id<span class="main">)</span><span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="main">(</span>prod_eq <span class="free">eqa</span> <span class="free">eqb</span><span class="main">,</span><span class="main">(=)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>prod_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>prod_rel <span class="main">→</span> Id"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> prod_eq_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>

    <span class="keyword1" id="Autoref_Bindings_HOL-prod_eq_expand"><span class="command">lemma</span></span> prod_eq_expand<span class="main">[</span><span class="operator">autoref_struct_expand</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span> <span class="main">=</span> prod_eq <span class="main">(=)</span> <span class="main">(=)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> prod_eq_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Option"</span></span>
    <span class="keyword1"><span class="command">consts</span></span> i_option <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface"</span></span>
    <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">option_rel</span> <span class="quoted">i_option</span><span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
    <span class="comment1">(*
    lemma [autoref_itype]:
      "None ::<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_option"
      "Some ::<span class="hidden">⇩</span><sub>i</sub> I →<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_option"
      "the ::<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_option →<span class="hidden">⇩</span><sub>i</sub> I"
      "case_option ::<span class="hidden">⇩</span><sub>i</sub> I →<span class="hidden">⇩</span><sub>i</sub> (Iv→<span class="hidden">⇩</span><sub>i</sub>I) →<span class="hidden">⇩</span><sub>i</sub> ⟨Iv⟩<span class="hidden">⇩</span><sub>i</sub>i_option →<span class="hidden">⇩</span><sub>i</sub> I"
      "rec_option ::<span class="hidden">⇩</span><sub>i</sub> I →<span class="hidden">⇩</span><sub>i</sub> (Iv→<span class="hidden">⇩</span><sub>i</sub>I) →<span class="hidden">⇩</span><sub>i</sub> ⟨Iv⟩<span class="hidden">⇩</span><sub>i</sub>i_option →<span class="hidden">⇩</span><sub>i</sub> I"
      "((=) :: _ option ⇒ _) ::<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_option →<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_option →<span class="hidden">⇩</span><sub>i</sub> i_bool"
      by auto
      *)</span>

    <span class="keyword1" id="Autoref_Bindings_HOL-autoref_opt"><span class="command">lemma</span></span> autoref_opt<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>None<span class="main">,</span>None<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>Some<span class="main">,</span>Some<span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>case_option<span class="main">,</span>case_option<span class="main">)</span><span class="main">∈</span><span class="free">Rr</span><span class="main">→</span><span class="main">(</span><span class="free">R</span> <span class="main">→</span> <span class="free">Rr</span><span class="main">)</span><span class="main">→</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel <span class="main">→</span> <span class="free">Rr</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>rec_option<span class="main">,</span>rec_option<span class="main">)</span><span class="main">∈</span><span class="free">Rr</span><span class="main">→</span><span class="main">(</span><span class="free">R</span> <span class="main">→</span> <span class="free">Rr</span><span class="main">)</span><span class="main">→</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel <span class="main">→</span> <span class="free">Rr</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split 
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_rel_def case_option_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>

    <span class="keyword1" id="Autoref_Bindings_HOL-autoref_the"><span class="command">lemma</span></span> autoref_the<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span><span class="free">x</span><span class="main">≠</span>None<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x'</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="free">x'</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">OP</span> the <span class="main">:::</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel <span class="main">→</span> <span class="free">R</span><span class="main">)</span><span class="main">$</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_rel_def<span class="main">)</span>

    <span class="keyword1" id="Autoref_Bindings_HOL-autoref_the_default"><span class="command">lemma</span></span> autoref_the_default<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>the_default<span class="main">,</span> the_default<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel <span class="main">→</span> <span class="free">R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_None</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False"</span></span>
    <span class="keyword1" id="Autoref_Bindings_HOL-pat_isNone"><span class="command">lemma</span></span> pat_isNone<span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">=</span>None <span class="main">≡</span> <span class="main">(</span><span class="keyword1">OP</span> is_None <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_option <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool<span class="main">)</span><span class="main">$</span><span class="free">a</span>"</span></span>
      <span class="quoted"><span class="quoted">"None<span class="main">=</span><span class="free">a</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">OP</span> is_None <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_option <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool<span class="main">)</span><span class="main">$</span><span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_reflection <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1" id="Autoref_Bindings_HOL-autoref_is_None"><span class="command">lemma</span></span> autoref_is_None<span class="main">[</span><span class="operator">param</span><span class="main">,</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span>is_None<span class="main">,</span>is_None<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel <span class="main">→</span> Id"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

    <span class="keyword1" id="Autoref_Bindings_HOL-fold_is_None"><span class="command">lemma</span></span> fold_is_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span>None <span class="main">⟷</span> is_None <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">option_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">≡</span> 
      <span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="keyword1">of</span> 
        <span class="main">(</span>None<span class="main">,</span>None<span class="main">)</span> <span class="main">⇒</span> True
      <span class="main">|</span> <span class="main">(</span>Some <span class="bound">x1</span><span class="main">,</span> Some <span class="bound">x2</span><span class="main">)</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="bound">x1</span> <span class="bound">x2</span>
      <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False"</span></span>

    <span class="keyword1" id="Autoref_Bindings_HOL-option_eq_autoref"><span class="command">lemma</span></span> option_eq_autoref<span class="main">[</span><span class="operator">autoref_rules</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">overloaded</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⟦</span>GEN_OP <span class="free">eq</span> <span class="main">(=)</span> <span class="main">(</span><span class="free">R</span><span class="main">→</span><span class="free">R</span><span class="main">→</span>Id<span class="main">)</span><span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="main">(</span>option_eq <span class="free">eq</span><span class="main">,</span><span class="main">(=)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel <span class="main">→</span> Id"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> option_eq_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option_relE<span class="main">)</span>

    <span class="keyword1" id="Autoref_Bindings_HOL-option_eq_expand"><span class="command">lemma</span></span> option_eq_expand<span class="main">[</span><span class="operator">autoref_struct_expand</span><span class="main">]</span><span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="main">(=)</span> <span class="main">=</span> option_eq <span class="main">(=)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_eq_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Sum-Types"</span></span>
  <span class="keyword1"><span class="command">consts</span></span> i_sum <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface <span class="main">⇒</span> interface"</span></span>
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">sum_rel</span> <span class="quoted">i_sum</span><span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
  <span class="comment1">(*lemma [autoref_itype]:
    "((=) :: _+_ ⇒ _) ::<span class="hidden">⇩</span><sub>i</sub> ⟨Il,Ir⟩<span class="hidden">⇩</span><sub>i</sub>i_sum →<span class="hidden">⇩</span><sub>i</sub> ⟨Il,Ir⟩<span class="hidden">⇩</span><sub>i</sub>i_sum →<span class="hidden">⇩</span><sub>i</sub> i_bool"
    "Inl ::<span class="hidden">⇩</span><sub>i</sub> Il →<span class="hidden">⇩</span><sub>i</sub> ⟨Il,Ir⟩<span class="hidden">⇩</span><sub>i</sub>i_sum"
    "Inr ::<span class="hidden">⇩</span><sub>i</sub> Ir →<span class="hidden">⇩</span><sub>i</sub> ⟨Il,Ir⟩<span class="hidden">⇩</span><sub>i</sub>i_sum"
    "case_sum ::<span class="hidden">⇩</span><sub>i</sub> (Il→<span class="hidden">⇩</span><sub>i</sub>I) →<span class="hidden">⇩</span><sub>i</sub> (Ir →<span class="hidden">⇩</span><sub>i</sub> I) →<span class="hidden">⇩</span><sub>i</sub> ⟨Il,Ir⟩<span class="hidden">⇩</span><sub>i</sub>i_sum →<span class="hidden">⇩</span><sub>i</sub> I"
    "old.rec_sum ::<span class="hidden">⇩</span><sub>i</sub> (Il→<span class="hidden">⇩</span><sub>i</sub>I) →<span class="hidden">⇩</span><sub>i</sub> (Ir →<span class="hidden">⇩</span><sub>i</sub> I) →<span class="hidden">⇩</span><sub>i</sub> ⟨Il,Ir⟩<span class="hidden">⇩</span><sub>i</sub>i_sum →<span class="hidden">⇩</span><sub>i</sub> I"
    by auto*)</span>

  <span class="keyword1" id="Autoref_Bindings_HOL-autoref_sum"><span class="command">lemma</span></span> autoref_sum<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>Inl<span class="main">,</span>Inl<span class="main">)</span> <span class="main">∈</span> <span class="free">Rl</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>Inr<span class="main">,</span>Inr<span class="main">)</span> <span class="main">∈</span> <span class="free">Rr</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>case_sum<span class="main">,</span>case_sum<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">Rl</span> <span class="main">→</span> <span class="free">R</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">Rr</span> <span class="main">→</span> <span class="free">R</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel <span class="main">→</span> <span class="free">R</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>old.rec_sum<span class="main">,</span>old.rec_sum<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">Rl</span> <span class="main">→</span> <span class="free">R</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">Rr</span> <span class="main">→</span> <span class="free">R</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel <span class="main">→</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD 
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rec_sum_is_case<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sum_eq</span> <span class="free"><span class="bound"><span class="entity">eql</span></span></span> <span class="free"><span class="bound"><span class="entity">eqr</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">≡</span> 
    <span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="keyword1">of</span> 
      <span class="main">(</span>Inl <span class="bound">x1</span><span class="main">,</span> Inl <span class="bound">x2</span><span class="main">)</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">eql</span></span></span> <span class="bound">x1</span> <span class="bound">x2</span>
    <span class="main">|</span> <span class="main">(</span>Inr <span class="bound">x1</span><span class="main">,</span> Inr <span class="bound">x2</span><span class="main">)</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">eqr</span></span></span> <span class="bound">x1</span> <span class="bound">x2</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False"</span></span>

  <span class="keyword1" id="Autoref_Bindings_HOL-sum_eq_autoref"><span class="command">lemma</span></span> sum_eq_autoref<span class="main">[</span><span class="operator">autoref_rules</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">overloaded</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span>GEN_OP <span class="free">eql</span> <span class="main">(=)</span> <span class="main">(</span><span class="free">Rl</span><span class="main">→</span><span class="free">Rl</span><span class="main">→</span>Id<span class="main">)</span><span class="main">;</span> GEN_OP <span class="free">eqr</span> <span class="main">(=)</span> <span class="main">(</span><span class="free">Rr</span><span class="main">→</span><span class="free">Rr</span><span class="main">→</span>Id<span class="main">)</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span>sum_eq <span class="free">eql</span> <span class="free">eqr</span><span class="main">,</span><span class="main">(=)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">Rl</span><span class="main">,</span><span class="free">Rr</span><span class="main">⟩</span>sum_rel <span class="main">→</span> Id"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sum_eq_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_relE<span class="main">)</span>

  <span class="keyword1" id="Autoref_Bindings_HOL-sum_eq_expand"><span class="command">lemma</span></span> sum_eq_expand<span class="main">[</span><span class="operator">autoref_struct_expand</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span> <span class="main">=</span> sum_eq <span class="main">(=)</span> <span class="main">(=)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_eq_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> is_Inl_param is_Inr_param

  <span class="keyword1" id="Autoref_Bindings_HOL-autoref_sum_Projl"><span class="command">lemma</span></span> autoref_sum_Projl<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span>SIDE_PRECOND <span class="main">(</span>is_Inl <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>sum_rel<span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span>Sum_Type.sum.projl <span class="free">s'</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">OP</span> Sum_Type.sum.projl <span class="main">:::</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>sum_rel <span class="main">→</span> <span class="free">Ra</span><span class="main">)</span><span class="main">$</span><span class="free">s</span><span class="main">)</span><span class="main">∈</span><span class="free">Ra</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">parametricity</span>

  <span class="keyword1" id="Autoref_Bindings_HOL-autoref_sum_Projr"><span class="command">lemma</span></span> autoref_sum_Projr<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span>SIDE_PRECOND <span class="main">(</span>is_Inr <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>sum_rel<span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span>Sum_Type.sum.projr <span class="free">s'</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">OP</span> Sum_Type.sum.projr <span class="main">:::</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">,</span><span class="free">Rb</span><span class="main">⟩</span>sum_rel <span class="main">→</span> <span class="free">Rb</span><span class="main">)</span><span class="main">$</span><span class="free">s</span><span class="main">)</span><span class="main">∈</span><span class="free">Rb</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">parametricity</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"List"</span></span>
  <span class="keyword1"><span class="command">consts</span></span> i_list <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface"</span></span>
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">list_rel</span> <span class="quoted">i_list</span><span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
  <span class="comment1">(*
  term nth
  lemma [autoref_itype]:
    "((=) :: _ list ⇒ _) ::<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list →<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list →<span class="hidden">⇩</span><sub>i</sub> i_bool"
    "[] ::<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list"
    "(#) ::<span class="hidden">⇩</span><sub>i</sub> I →<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list →<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list"
    "(@) ::<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list →<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list →<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list"
    "case_list ::<span class="hidden">⇩</span><sub>i</sub> Ir →<span class="hidden">⇩</span><sub>i</sub> (I→<span class="hidden">⇩</span><sub>i</sub>⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list→<span class="hidden">⇩</span><sub>i</sub>Ir) →<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list →<span class="hidden">⇩</span><sub>i</sub> Ir"
    "rec_list ::<span class="hidden">⇩</span><sub>i</sub> Ir →<span class="hidden">⇩</span><sub>i</sub> (I→<span class="hidden">⇩</span><sub>i</sub>⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list→<span class="hidden">⇩</span><sub>i</sub>Ir→<span class="hidden">⇩</span><sub>i</sub>Ir) →<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list →<span class="hidden">⇩</span><sub>i</sub> Ir"
    "map ::<span class="hidden">⇩</span><sub>i</sub> (I1→<span class="hidden">⇩</span><sub>i</sub>I2) →<span class="hidden">⇩</span><sub>i</sub> ⟨I1⟩<span class="hidden">⇩</span><sub>i</sub>i_list →<span class="hidden">⇩</span><sub>i</sub> ⟨I2⟩<span class="hidden">⇩</span><sub>i</sub>i_list"
    "foldl ::<span class="hidden">⇩</span><sub>i</sub> (Ia→<span class="hidden">⇩</span><sub>i</sub>Ib→<span class="hidden">⇩</span><sub>i</sub>Ia) →<span class="hidden">⇩</span><sub>i</sub> Ia →<span class="hidden">⇩</span><sub>i</sub> ⟨Ib⟩<span class="hidden">⇩</span><sub>i</sub>i_list →<span class="hidden">⇩</span><sub>i</sub> Ia"
    "foldr ::<span class="hidden">⇩</span><sub>i</sub> (Ia→<span class="hidden">⇩</span><sub>i</sub>Ib→<span class="hidden">⇩</span><sub>i</sub>Ib) →<span class="hidden">⇩</span><sub>i</sub> ⟨Ia⟩<span class="hidden">⇩</span><sub>i</sub>i_list →<span class="hidden">⇩</span><sub>i</sub> Ib →<span class="hidden">⇩</span><sub>i</sub> Ib"
    "fold ::<span class="hidden">⇩</span><sub>i</sub> (Ia→<span class="hidden">⇩</span><sub>i</sub>Ib→<span class="hidden">⇩</span><sub>i</sub>Ib) →<span class="hidden">⇩</span><sub>i</sub> ⟨Ia⟩<span class="hidden">⇩</span><sub>i</sub>i_list →<span class="hidden">⇩</span><sub>i</sub> Ib →<span class="hidden">⇩</span><sub>i</sub> Ib"
    "take ::<span class="hidden">⇩</span><sub>i</sub> i_nat →<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list →<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list"
    "drop ::<span class="hidden">⇩</span><sub>i</sub> i_nat →<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list →<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list"
    "length ::<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list →<span class="hidden">⇩</span><sub>i</sub> i_nat"
    "nth ::<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list →<span class="hidden">⇩</span><sub>i</sub> i_nat →<span class="hidden">⇩</span><sub>i</sub> I"
    "hd ::<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list →<span class="hidden">⇩</span><sub>i</sub> I"
    "tl ::<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list →<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list"
    "last ::<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list →<span class="hidden">⇩</span><sub>i</sub> I"
    "butlast ::<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list →<span class="hidden">⇩</span><sub>i</sub> ⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list"
    by auto
    *)</span>

  <span class="keyword1" id="Autoref_Bindings_HOL-autoref_append"><span class="command">lemma</span></span> autoref_append<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>append<span class="main">,</span> append<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_def list_all2_appendI<span class="main">)</span>

  <span class="keyword1" id="Autoref_Bindings_HOL-refine_list"><span class="command">lemma</span></span> refine_list<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>Nil<span class="main">,</span>Nil<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>Cons<span class="main">,</span>Cons<span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>case_list<span class="main">,</span>case_list<span class="main">)</span><span class="main">∈</span><span class="free">Rr</span><span class="main">→</span><span class="main">(</span><span class="free">R</span><span class="main">→</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel<span class="main">→</span><span class="free">Rr</span><span class="main">)</span><span class="main">→</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel<span class="main">→</span><span class="free">Rr</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Autoref_Bindings_HOL-autoref_rec_list"><span class="command">lemma</span></span> autoref_rec_list<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rec_list<span class="main">,</span>rec_list<span class="main">)</span> 
    <span class="main">∈</span> <span class="free">Ra</span> <span class="main">→</span> <span class="main">(</span><span class="free">Rb</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rb</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="free">Ra</span> <span class="main">→</span> <span class="free">Ra</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rb</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="free">Ra</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">a</span> <span class="skolem">a'</span> <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">l</span> <span class="skolem">l'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">a'</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Autoref_Bindings_HOL-refine_map"><span class="command">lemma</span></span> refine_map<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>map<span class="main">,</span>map<span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">R1</span><span class="main">→</span><span class="free">R2</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R1</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R2</span><span class="main">⟩</span>list_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">autoref_sbias</span> <span class="main"><span class="main">=</span></span> -1<span class="main">]</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_rec<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">autoref</span>

  <span class="keyword1" id="Autoref_Bindings_HOL-refine_fold"><span class="command">lemma</span></span> refine_fold<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>fold<span class="main">,</span>fold<span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">Re</span><span class="main">→</span><span class="free">Rs</span><span class="main">→</span><span class="free">Rs</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="free">Rs</span> <span class="main">→</span> <span class="free">Rs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>foldl<span class="main">,</span>foldl<span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">Rs</span><span class="main">→</span><span class="free">Re</span><span class="main">→</span><span class="free">Rs</span><span class="main">)</span> <span class="main">→</span> <span class="free">Rs</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="free">Rs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>foldr<span class="main">,</span>foldr<span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">Re</span><span class="main">→</span><span class="free">Rs</span><span class="main">→</span><span class="free">Rs</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="free">Rs</span> <span class="main">→</span> <span class="free">Rs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> List.fold_def List.foldr_def List.foldl_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">autoref</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">schematic_goal</span></span> autoref_take<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take<span class="main">,</span>take<span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="var">?R</span><span class="main">::</span><span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="main">_</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> take_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">autoref</span>
  <span class="keyword1"><span class="command">schematic_goal</span></span> autoref_drop<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drop<span class="main">,</span>drop<span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="var">?R</span><span class="main">::</span><span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="main">_</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> drop_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">autoref</span>
  <span class="keyword1"><span class="command">schematic_goal</span></span> autoref_length<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>length<span class="main">,</span>length<span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="var">?R</span><span class="main">::</span><span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="main">_</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> size_list_overloaded_def size_list_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">autoref</span><span class="main">)</span>

  <span class="keyword1" id="Autoref_Bindings_HOL-autoref_nth"><span class="command">lemma</span></span> autoref_nth<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">l'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">i'</span><span class="main">)</span><span class="main">∈</span>Id"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span><span class="free">i'</span> <span class="main">&lt;</span> length <span class="free">l'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nth <span class="free">l</span> <span class="free">i</span><span class="main">,</span><span class="main">(</span><span class="keyword1">OP</span> nth <span class="main">:::</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> Id <span class="main">→</span> <span class="free">R</span><span class="main">)</span><span class="main">$</span><span class="free">l'</span><span class="main">$</span><span class="free">i'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ANNOT_def
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">i'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">i'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">list_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">list_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">⟷</span> True"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">list_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span> 
       <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="keyword1">then</span> <span class="free">list_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="keyword1">else</span> False<span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">list_eq</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> False"</span></span>

  <span class="keyword1" id="Autoref_Bindings_HOL-autoref_list_eq_aux"><span class="command">lemma</span></span> autoref_list_eq_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span>list_eq<span class="main">,</span>list_eq<span class="main">)</span> <span class="main">∈</span> 
      <span class="main">(</span><span class="free">R</span> <span class="main">→</span> <span class="free">R</span> <span class="main">→</span> Id<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> Id"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">eq</span> <span class="skolem">eq'</span> <span class="skolem">l1</span> <span class="skolem">l1'</span> <span class="skolem">l2</span> <span class="skolem">l2'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">eq'</span></span> <span class="quoted"><span class="skolem">l1'</span></span> <span class="quoted"><span class="skolem">l2'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">l2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_eq.induct<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">l1</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">l2</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">l1</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">l2</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Autoref_Bindings_HOL-list_eq_expand"><span class="command">lemma</span></span> list_eq_expand<span class="main">[</span><span class="operator">autoref_struct_expand</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span> <span class="main">=</span> <span class="main">(</span>list_eq <span class="main">(=)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l1</span> <span class="main">=</span> <span class="skolem">l2</span><span class="main">)</span> <span class="main">⟷</span> list_eq <span class="main">(=)</span> <span class="skolem">l1</span> <span class="skolem">l2</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">l2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_eq.induct<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Autoref_Bindings_HOL-autoref_list_eq"><span class="command">lemma</span></span> autoref_list_eq<span class="main">[</span><span class="operator">autoref_rules</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">overloaded</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"GEN_OP <span class="free">eq</span> <span class="main">(=)</span> <span class="main">(</span><span class="free">R</span><span class="main">→</span><span class="free">R</span><span class="main">→</span>Id<span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>list_eq <span class="free">eq</span><span class="main">,</span> <span class="main">(=)</span><span class="main">)</span> 
    <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> Id"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> list_eq_expand<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">parametricity</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> autoref_list_eq_aux<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Autoref_Bindings_HOL-autoref_hd"><span class="command">lemma</span></span> autoref_hd<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> SIDE_PRECOND <span class="main">(</span><span class="free">l'</span><span class="main">≠</span><span class="main">[]</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">l'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">⟧</span> <span class="main">⟹</span>
      <span class="main">(</span>hd <span class="free">l</span><span class="main">,</span><span class="main">(</span><span class="keyword1">OP</span> hd <span class="main">:::</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="free">R</span><span class="main">)</span><span class="main">$</span><span class="free">l'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ANNOT_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Autoref_Bindings_HOL-autoref_tl"><span class="command">lemma</span></span> autoref_tl<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>tl<span class="main">,</span>tl<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tl_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">autoref</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_Nil</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False"</span></span>

  <span class="keyword1" id="Autoref_Bindings_HOL-is_Nil_pat"><span class="command">lemma</span></span> is_Nil_pat<span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">=</span><span class="main">[]</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">OP</span> is_Nil <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_list <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool<span class="main">)</span><span class="main">$</span><span class="free">a</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">=</span><span class="free">a</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">OP</span> is_Nil <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_list <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool<span class="main">)</span><span class="main">$</span><span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_reflection <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

  <span class="keyword1" id="Autoref_Bindings_HOL-autoref_is_Nil"><span class="command">lemma</span></span> autoref_is_Nil<span class="main">[</span><span class="operator">param</span><span class="main">,</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>is_Nil<span class="main">,</span>is_Nil<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

  <span class="keyword1" id="Autoref_Bindings_HOL-conv_to_is_Nil"><span class="command">lemma</span></span> conv_to_is_Nil<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">=</span><span class="main">[]</span> <span class="main">⟷</span> is_Nil <span class="free">l</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">=</span><span class="free">l</span> <span class="main">⟷</span> is_Nil <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_Nil_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split<span class="main">)</span>

  <span class="keyword1" id="Autoref_Bindings_HOL-autoref_butlast"><span class="command">lemma</span></span> autoref_butlast<span class="main">[</span><span class="operator">param</span><span class="main">,</span> <span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>butlast<span class="main">,</span>butlast<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> butlast_def conv_to_is_Nil
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">op_list_singleton</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>
  <span class="keyword1" id="Autoref_Bindings_HOL-op_list_singleton_pat"><span class="command">lemma</span></span> op_list_singleton_pat<span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">OP</span> op_list_singleton <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_list<span class="main">)</span><span class="main">$</span><span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="Autoref_Bindings_HOL-autoref_list_singleton"><span class="command">lemma</span></span> autoref_list_singleton<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">[</span><span class="bound">a</span><span class="main">]</span><span class="main">,</span>op_list_singleton<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">op_list_append_elem</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">@</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>

  <span class="keyword1" id="Autoref_Bindings_HOL-pat_list_append_elem"><span class="command">lemma</span></span> pat_list_append_elem<span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">OP</span> op_list_append_elem <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_list <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_list<span class="main">)</span><span class="main">$</span><span class="free">s</span><span class="main">$</span><span class="free">x</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> relAPP_def<span class="main">)</span>

  <span class="keyword1" id="Autoref_Bindings_HOL-autoref_list_append_elem"><span class="command">lemma</span></span> autoref_list_append_elem<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">s</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">,</span> op_list_append_elem<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> op_list_append_elem_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>


  <span class="keyword1"><span class="command">declare</span></span> param_rev<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span>

  <span class="keyword1"><span class="command">declare</span></span> param_all_interval_nat<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">u</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≡</span> <span class="keyword1">OP</span> List.all_interval_nat <span class="free">P</span> <span class="main">0</span> <span class="free">u</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">≤</span><span class="free">u</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≡</span> <span class="keyword1">OP</span> List.all_interval_nat <span class="free">P</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">u</span><span class="main">.</span> <span class="free">l</span><span class="main">≤</span><span class="bound">i</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≡</span> <span class="keyword1">OP</span> List.all_interval_nat <span class="free">P</span> <span class="free">l</span> <span class="free">u</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">≤</span><span class="free">u</span><span class="main">.</span> <span class="free">l</span><span class="main">≤</span><span class="bound">i</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≡</span> <span class="keyword1">OP</span> List.all_interval_nat <span class="free">P</span> <span class="free">l</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_reflection <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> List.all_interval_nat_def<span class="main">)</span>


  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> param_dropWhile param_takeWhile

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Examples"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Be careful to make the concrete type a schematic type variable.
  The default behaviour of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>schematic_lemma›</span></span></span></span> makes it a fixed variable,
  that will not unify with the infered term!›</span></span>
<span class="keyword1"><span class="command">schematic_goal</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">@</span><span class="main">[</span><span class="numeral">4</span><span class="main">::</span>nat<span class="main">]</span><span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">autoref</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span><span class="main">[</span><span class="main">1</span><span class="main">::</span>nat<span class="main">,</span>
    <span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">6</span><span class="main">,</span><span class="numeral">7</span><span class="main">,</span><span class="numeral">8</span><span class="main">,</span><span class="numeral">9</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="numeral">43</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">435</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">6</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">6</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">63</span><span class="main">,</span><span class="numeral">56</span>
  <span class="main">]</span>
  <span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">autoref</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  When specifying custom refinement rules on the fly, be careful with
  the type-inference between <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>notes›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>shows›</span></span></span></span>. It's
  too easy to ,,decouple'' the type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'a›</span></span></span></span> in the autoref-rule and
  the actual goal, as shown below!
›</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> 
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> IdI<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span> <span class="main">=</span> itypeI<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'t</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>numeral"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">i_std</span></span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> hd <span class="main">[</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">,</span><span class="free">c</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>numeral<span class="main">]</span><span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹The autoref-rule is bound with type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'a::typ›</span></span></span></span>, while
    the goal statement has <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'a::numeral›</span></span></span></span>!›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹We get an unsolved goal, as it finds no rule to translate 
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a›</span></span></span></span>›</span></span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Here comes the correct version. Note the duplicate sort annotation
  of type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'a›</span></span></span></span>:›</span></span>
<span class="keyword1"><span class="command">schematic_goal</span></span> 
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_rules_raw</span><span class="main">]</span> <span class="main">=</span> IdI<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>numeral"</span></span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span> <span class="main">=</span> itypeI<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'t</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>numeral"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">i_std</span></span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> hd <span class="main">[</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">,</span><span class="free">c</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>numeral<span class="main">]</span><span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">autoref</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Special cases of equality: Note that we do not require equality
  on the element type!›</span></span>
<span class="keyword1"><span class="command">schematic_goal</span></span> 
  <span class="comment1">(*notes [autoref_itype] = itypeI[of a "⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_option"]*)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ai</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>option_rel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> <span class="free">a</span> <span class="main">=</span> None<span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">schematic_goal</span></span> 
  <span class="comment1">(*notes [autoref_itype] = itypeI[of a "⟨I⟩<span class="hidden">⇩</span><sub>i</sub>i_list"]*)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ai</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">::</span>nat<span class="main">]</span><span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Automatic_Refinement">
<div class="head">
<h1>Theory Automatic_Refinement</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Entry Point for the Automatic Refinement Tool›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Automatic_Refinement
<span class="keyword2"><span class="keyword">imports</span></span> 
  <span class="quoted">"<a href="Autoref_Tool.html">Tool/Autoref_Tool</a>"</span>
  <a href="Autoref_Bindings_HOL.html">Autoref_Bindings_HOL</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The automatic refinement tool should be used by 
    importing this theory›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Convenience›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemmas can be used to add tags to theorems›</span></span>
<span class="keyword1" id="Automatic_Refinement-PREFER_I"><span class="command">lemma</span></span> PREFER_I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="main">⟹</span> PREFER <span class="free">P</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1" id="Automatic_Refinement-PREFER_D"><span class="command">lemma</span></span> PREFER_D<span class="main">:</span> <span class="quoted"><span class="quoted">"PREFER <span class="free">P</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> PREFER_sv_D <span class="main">=</span> PREFER_D<span class="main">[</span><span class="operator">of</span> <span class="quoted">single_valued</span><span class="main">]</span>
<span class="keyword1" id="Automatic_Refinement-PREFER_id_D"><span class="command">lemma</span></span> PREFER_id_D<span class="main">:</span> <span class="quoted"><span class="quoted">"PREFER_id <span class="free">R</span> <span class="main">⟹</span> <span class="free">R</span><span class="main">=</span>Id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">PREFER_RUNIV</span> <span class="main">≡</span> PREFER <span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> Range <span class="bound">R</span> <span class="main">=</span> UNIV<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> PREFER_RUNIV_D <span class="main">=</span> PREFER_D<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> Range <span class="bound">R</span> <span class="main">=</span> UNIV<span class="main">)</span>"</span></span><span class="main">]</span>

<span class="keyword1" id="Automatic_Refinement-SIDE_GEN_ALGO_D"><span class="command">lemma</span></span> SIDE_GEN_ALGO_D<span class="main">:</span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="free">P</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Automatic_Refinement-GEN_OP_D"><span class="command">lemma</span></span> GEN_OP_D<span class="main">:</span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">c</span> <span class="free">a</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Automatic_Refinement-MINOR_PRIO_TAG_I"><span class="command">lemma</span></span> MINOR_PRIO_TAG_I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⟹</span> <span class="main">(</span>MINOR_PRIO_TAG <span class="free">p</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="Automatic_Refinement-MAJOR_PRIO_TAG_I"><span class="command">lemma</span></span> MAJOR_PRIO_TAG_I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⟹</span> <span class="main">(</span>MAJOR_PRIO_TAG <span class="free">p</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="Automatic_Refinement-PRIO_TAG_I"><span class="command">lemma</span></span> PRIO_TAG_I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⟹</span> <span class="main">(</span>PRIO_TAG <span class="free">ma</span> <span class="free">mi</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>