<div id="Linorder_Relations">
<div class="head">
<h1>Theory Linorder_Relations</h1>
</div>
<pre class="source"><span class="comment1">(*
   File:    Linorder_Relations.thy
   Author:  Manuel Eberl

   Linear orderings represented as relations (i.e. set of pairs). Also contains 
   material connecting such orderings to lists, and insertion sort w.r.t. a 
   given ordering relation.
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Linear orderings as relations›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Linorder_Relations
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a> 
    <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset_Permutations.html">HOL-Library.Multiset_Permutations</a>"</span>
    <span class="quoted">"<a href="../List-Index/List_Index.html">List-Index.List_Index</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary facts›</span></span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1" id="Linorder_Relations-distinct_count_atmost_1'"><span class="command">lemma</span></span> distinct_count_atmost_1'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="bound">a</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟷</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> count_eq_zero_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> count_mset_0_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> distinct_count_atmost_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
        
<span class="keyword1" id="Linorder_Relations-distinct_mset_mono"><span class="command">lemma</span></span> distinct_mset_mono<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">⊆#</span> mset <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> distinct_count_atmost_1'
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">≤</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mset_subset_eq_count<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> distinct_count_atmost_1' <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linorder_Relations-mset_eq_imp_distinct_iff"><span class="command">lemma</span></span> mset_eq_imp_distinct_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">=</span> mset <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">⟷</span> distinct <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_count_atmost_1'<span class="main">)</span>

<span class="keyword1" id="Linorder_Relations-total_on_subset"><span class="command">lemma</span></span> total_on_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"total_on <span class="free">B</span> <span class="free">R</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> total_on <span class="free">A</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> total_on_def<span class="main">)</span>
 

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sortedness w.r.t. a relation›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">sorted_wrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sorted_wrt</span> <span class="free">R</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sorted_wrt</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">sorted_wrt</span> <span class="free">R</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Linorder_Relations-sorted_wrt_Nil"><span class="command">lemma</span></span> sorted_wrt_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_wrt.intros<span class="main">)</span>

<span class="keyword1" id="Linorder_Relations-sorted_wrt_Cons"><span class="command">lemma</span></span> sorted_wrt_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span> <span class="main">∧</span> sorted_wrt <span class="free">R</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sorted_wrt.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sorted_wrt.cases<span class="main">)</span>

<span class="keyword1" id="Linorder_Relations-sorted_wrt_singleton"><span class="command">lemma</span></span> sorted_wrt_singleton <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sorted_wrt.intros<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Linorder_Relations-sorted_wrt_many"><span class="command">lemma</span></span> sorted_wrt_many<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> sorted_wrt <span class="free">R</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sorted_wrt.intros transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sorted_wrt.cases<span class="main">)</span>

<span class="keyword1" id="Linorder_Relations-sorted_wrt_imp_le_last"><span class="command">lemma</span></span> sorted_wrt_imp_le_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> last <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> last <span class="free">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="operator">auto</span>
    
<span class="keyword1" id="Linorder_Relations-sorted_wrt_append"><span class="command">lemma</span></span> sorted_wrt_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="free">ys</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_wrt_Cons<span class="main">)</span>

<span class="keyword1" id="Linorder_Relations-sorted_wrt_snoc"><span class="command">lemma</span></span> sorted_wrt_snoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>last <span class="free">xs</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">xs</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">z</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> last <span class="skolem">xs</span>"</span></span><span class="main">)</span>
                    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> sorted_wrt_imp_le_last<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> 2<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="skolem">xs</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2 False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> 2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sorted_wrt.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> 2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sorted_wrt.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  
<span class="keyword1" id="Linorder_Relations-sorted_wrt_conv_nth"><span class="command">lemma</span></span> sorted_wrt_conv_nth<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="free">xs</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">,</span> <span class="free">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_wrt_Cons nth_Cons set_conv_nth <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Linear orderings›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">linorder_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> bool"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">linorder_on</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⟷</span> refl_on <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span> antisym <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span> trans <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span> total_on <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>
 
<span class="keyword1" id="Linorder_Relations-linorder_on_cases"><span class="command">lemma</span></span> linorder_on_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorder_on_def refl_on_def total_on_def antisym_def<span class="main">)</span>

<span class="keyword1" id="Linorder_Relations-sorted_wrt_linorder_imp_index_le"><span class="command">lemma</span></span> sorted_wrt_linorder_imp_index_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="free">xs</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"index <span class="free">xs</span> <span class="free">x</span> <span class="main">≤</span> index <span class="free">xs</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> index <span class="free">xs</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> index <span class="free">xs</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> i_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="skolem">j</span><span class="main">,</span><span class="free">xs</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_wrt_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorder_on_def antisym_def i_def j_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> i_def j_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linorder_Relations-sorted_wrt_linorder_index_le_imp"><span class="command">lemma</span></span> sorted_wrt_linorder_index_le_imp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="free">xs</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"index <span class="free">xs</span> <span class="free">x</span> <span class="main">≤</span> index <span class="free">xs</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> index <span class="free">xs</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> index <span class="free">xs</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> False <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> i_def j_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹index <span class="free">xs</span> <span class="free">x</span> <span class="main">≤</span> index <span class="free">xs</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> i_def j_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> j_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_wrt_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> i_def j_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorder_on_def refl_on_def<span class="main">)</span>

<span class="keyword1" id="Linorder_Relations-sorted_wrt_linorder_index_le_iff"><span class="command">lemma</span></span> sorted_wrt_linorder_index_le_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="free">xs</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"index <span class="free">xs</span> <span class="free">x</span> <span class="main">≤</span> index <span class="free">xs</span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sorted_wrt_linorder_index_le_imp<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> sorted_wrt_linorder_imp_index_le<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
<span class="keyword1" id="Linorder_Relations-sorted_wrt_linorder_index_less_iff"><span class="command">lemma</span></span> sorted_wrt_linorder_index_less_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="free">xs</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"index <span class="free">xs</span> <span class="free">x</span> <span class="main">&lt;</span> index <span class="free">xs</span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sorted_wrt_linorder_index_le_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1-3<span class="main"><span class="main"><span class="main">)</span></span></span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>5<span class="main"><span class="main"><span class="main">,</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Linorder_Relations-sorted_wrt_distinct_linorder_nth"><span class="command">lemma</span></span> sorted_wrt_distinct_linorder_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="free">i</span><span class="main">,</span> <span class="free">xs</span><span class="main">!</span><span class="free">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟷</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_wrt_conv_nth<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> equal
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹linorder_on <span class="free">A</span> <span class="free">R</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> equal <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linorder_on_def refl_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> greater
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="free">j</span><span class="main">,</span> <span class="free">xs</span><span class="main">!</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_wrt_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> greater <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">≠</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_eq_iff_index_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹linorder_on <span class="free">A</span> <span class="free">R</span>›</span></span> greater
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorder_on_def antisym_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Converting a list into a linear ordering›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">linorder_of_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">linorder_of_list</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> <span class="bound">b</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> index <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="bound">a</span> <span class="main">≤</span> index <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="bound">b</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Linorder_Relations-linorder_linorder_of_list"><span class="command">lemma</span></span> linorder_linorder_of_list <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"linorder_on <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>linorder_of_list <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> linorder_on_def <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refl_on_def antisym_def trans_def total_on_def linorder_of_list_def<span class="main">)</span>

<span class="keyword1" id="Linorder_Relations-sorted_wrt_linorder_of_list"><span class="command">lemma</span></span> sorted_wrt_linorder_of_list <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">⟹</span> sorted_wrt <span class="main">(</span>linorder_of_list <span class="free">xs</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_wrt_conv_nth linorder_of_list_def index_nth_id<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Insertion sort›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">insert_wrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_wrt</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insert_wrt</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free">insert_wrt</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Linorder_Relations-set_insert_wrt"><span class="command">lemma</span></span> set_insert_wrt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>insert_wrt <span class="free">R</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Linorder_Relations-mset_insert_wrt"><span class="command">lemma</span></span> mset_insert_wrt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>insert_wrt <span class="free">R</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> add_mset <span class="free">x</span> <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Linorder_Relations-length_insert_wrt"><span class="command">lemma</span></span> length_insert_wrt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>insert_wrt <span class="free">R</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">insort_wrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insort_wrt</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> foldr <span class="main">(</span>insert_wrt <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span>"</span></span>

<span class="keyword1" id="Linorder_Relations-set_insort_wrt"><span class="command">lemma</span></span> set_insort_wrt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>insort_wrt <span class="free">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insort_wrt_def<span class="main">)</span>

<span class="keyword1" id="Linorder_Relations-mset_insort_wrt"><span class="command">lemma</span></span> mset_insort_wrt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>insort_wrt <span class="free">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insort_wrt_def<span class="main">)</span>
    
<span class="keyword1" id="Linorder_Relations-length_insort_wrt"><span class="command">lemma</span></span> length_insort_wrt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>insort_wrt <span class="free">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insort_wrt_def<span class="main">)</span>

<span class="keyword1" id="Linorder_Relations-sorted_wrt_insert_wrt"><span class="command">lemma</span></span> sorted_wrt_insert_wrt <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="free">R</span> <span class="main">⟹</span> set <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> 
     sorted_wrt <span class="free">R</span> <span class="free">xs</span> <span class="main">⟹</span> sorted_wrt <span class="free">R</span> <span class="main">(</span>insert_wrt <span class="free">R</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorder_on_def refl_on_def total_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_wrt_Cons <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> transD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorder_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Linorder_Relations-sorted_wrt_insort"><span class="command">lemma</span></span> sorted_wrt_insort <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="main">(</span>insort_wrt <span class="free">R</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>insort_wrt <span class="free">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∧</span> sorted_wrt <span class="free">R</span> <span class="main">(</span>insort_wrt <span class="free">R</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insort_wrt_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sorted_wrt_insert_wrt<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linorder_Relations-distinct_insort_wrt"><span class="command">lemma</span></span> distinct_insort_wrt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>insort_wrt <span class="free">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> distinct <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_count_atmost_1<span class="main">)</span>

<span class="keyword1" id="Linorder_Relations-sorted_wrt_linorder_unique"><span class="command">lemma</span></span> sorted_wrt_linorder_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">=</span> mset <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹mset <span class="free">xs</span> <span class="main">=</span> mset <span class="free">ys</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mset_eq_length<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> assms<span class="main">(</span>2-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="main">(</span>mset <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">…</span> <span class="main">=</span> set <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> Cons.prems <span class="keyword2"><span class="keyword">and</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_wrt_Cons<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorder_on_def antisym_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_wrt_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Obtaining a sorted list of a given set›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sorted_wrt_list_of_set</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sorted_wrt_list_of_set</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> finite <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> distinct <span class="bound">xs</span> <span class="main">∧</span> sorted_wrt <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">xs</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  
<span class="keyword1" id="Linorder_Relations-mset_remdups"><span class="command">lemma</span></span> mset_remdups<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>remdups <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset_set <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_absorb<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  
<span class="keyword1" id="Linorder_Relations-sorted_wrt_list_set"><span class="command">lemma</span></span> sorted_wrt_list_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sorted_wrt_list_of_set <span class="free">R</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> insort_wrt <span class="free">R</span> <span class="main">(</span>remdups <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_wrt_list_of_set <span class="free">R</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> 
          <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">xsa</span><span class="main">.</span> set <span class="bound">xsa</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∧</span> distinct <span class="bound">xsa</span> <span class="main">∧</span> sorted_wrt <span class="free">R</span> <span class="bound">xsa</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_wrt_list_of_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> insort_wrt <span class="free">R</span> <span class="main">(</span>remdups <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> the_equality<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xsa</span> <span class="keyword3"><span class="command">assume</span></span> xsa<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xsa</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∧</span> distinct <span class="skolem">xsa</span> <span class="main">∧</span> sorted_wrt <span class="free">R</span> <span class="skolem">xsa</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> xsa <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="skolem">xsa</span> <span class="main">=</span> mset_set <span class="main">(</span>set <span class="skolem">xsa</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mset_set_set<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> xsa <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xsa</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset_set <span class="main">…</span> <span class="main">=</span> mset <span class="main">(</span>remdups <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_remdups<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xsa</span> <span class="main">=</span> insort_wrt <span class="free">R</span> <span class="main">(</span>remdups <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xsa assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sorted_wrt_linorder_unique<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sorted_wrt_insort<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sorted_wrt_insort<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linorder_Relations-linorder_sorted_wrt_exists"><span class="command">lemma</span></span> linorder_sorted_wrt_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">=</span> <span class="free">B</span> <span class="main">∧</span> distinct <span class="bound">xs</span> <span class="main">∧</span> sorted_wrt <span class="free">R</span> <span class="bound">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">B</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_distinct_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>insort_wrt <span class="free">R</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>insort_wrt <span class="free">R</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="main">(</span>insort_wrt <span class="free">R</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹set <span class="skolem">xs</span> <span class="main">=</span> <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sorted_wrt_insort<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linorder_Relations-linorder_sorted_wrt_list_of_set"><span class="command">lemma</span></span> linorder_sorted_wrt_list_of_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"set <span class="main">(</span>sorted_wrt_list_of_set <span class="free">R</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>sorted_wrt_list_of_set <span class="free">R</span> <span class="free">B</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="main">(</span>sorted_wrt_list_of_set <span class="free">R</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">=</span> <span class="free">B</span> <span class="main">∧</span> distinct <span class="bound">xs</span> <span class="main">∧</span> sorted_wrt <span class="free">R</span> <span class="bound">xs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ex_ex1I<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">=</span> <span class="free">B</span> <span class="main">∧</span> distinct <span class="bound">xs</span> <span class="main">∧</span> sorted_wrt <span class="free">R</span> <span class="bound">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> linorder_sorted_wrt_exists assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> <span class="free">B</span> <span class="main">∧</span> distinct <span class="skolem">xs</span> <span class="main">∧</span> sorted_wrt <span class="free">R</span> <span class="skolem">xs</span>"</span></span> 
                     <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">=</span> <span class="free">B</span> <span class="main">∧</span> distinct <span class="skolem">ys</span> <span class="main">∧</span> sorted_wrt <span class="free">R</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sorted_wrt_linorder_unique<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_eq_iff_mset_eq_distinct<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> theI'<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"set <span class="main">(</span>sorted_wrt_list_of_set <span class="free">R</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span>"</span></span> 
    <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>sorted_wrt_list_of_set <span class="free">R</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="main">(</span>sorted_wrt_list_of_set <span class="free">R</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_wrt_list_of_set_def <span class="quoted"><span class="quoted">‹finite <span class="free">B</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linorder_Relations-sorted_wrt_list_of_set_eqI"><span class="command">lemma</span></span> sorted_wrt_list_of_set_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">B</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sorted_wrt_list_of_set <span class="free">R</span> <span class="free">A</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_wrt_linorder_unique<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">B</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sorted_wrt_list_of_set <span class="free">R</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> fin <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?ys</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?ys</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="var">?ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> linorder_sorted_wrt_list_of_set<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> fin assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mset <span class="var">?ys</span> <span class="main">=</span> mset <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> set_eq_iff_mset_eq_distinct <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="var">?ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Rank of an element in an ordering›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The `rank' of an element in a set w.r.t. an ordering is how many smaller elements exist.
  This is particularly useful in linear orders, where there exists a unique $n$-th element 
  for every $n$.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">linorder_rank</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">linorder_rank</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">-</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">}</span>"</span></span>
  
<span class="keyword1" id="Linorder_Relations-linorder_rank_le"><span class="command">lemma</span></span> linorder_rank_le<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"linorder_rank <span class="free">R</span> <span class="free">A</span> <span class="free">x</span> <span class="main">≤</span> card <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> linorder_rank_def <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_mono<span class="main">)</span> <span class="operator">auto</span>
    
<span class="keyword1" id="Linorder_Relations-linorder_rank_less"><span class="command">lemma</span></span> linorder_rank_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"linorder_rank <span class="free">R</span> <span class="free">A</span> <span class="free">x</span> <span class="main">&lt;</span> card <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linorder_rank <span class="free">R</span> <span class="free">A</span> <span class="free">x</span> <span class="main">≤</span> card <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> linorder_rank_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> card <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> psubset_card_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linorder_Relations-linorder_rank_union"><span class="command">lemma</span></span> linorder_rank_union<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"linorder_rank <span class="free">R</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> linorder_rank <span class="free">R</span> <span class="free">A</span> <span class="free">x</span> <span class="main">+</span> linorder_rank <span class="free">R</span> <span class="free">B</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linorder_rank <span class="free">R</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="main">(</span><span class="free">A</span><span class="main">∪</span><span class="free">B</span><span class="main">)</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linorder_rank_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="main">(</span><span class="free">A</span><span class="main">∪</span><span class="free">B</span><span class="main">)</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free">B</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> linorder_rank <span class="free">R</span> <span class="free">A</span> <span class="free">x</span> <span class="main">+</span> linorder_rank <span class="free">R</span> <span class="free">B</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> linorder_rank_def
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_Un_disjoint<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linorder_Relations-linorder_rank_empty"><span class="command">lemma</span></span> linorder_rank_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"linorder_rank <span class="free">R</span> <span class="main">{}</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linorder_rank_def<span class="main">)</span>

<span class="keyword1" id="Linorder_Relations-linorder_rank_singleton"><span class="command">lemma</span></span> linorder_rank_singleton<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"linorder_rank <span class="free">R</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">∧</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linorder_rank <span class="free">R</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="free">x</span> <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">z</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linorder_rank_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">z</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">∧</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="keyword1">then</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">∧</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linorder_Relations-linorder_rank_insert"><span class="command">lemma</span></span> linorder_rank_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"linorder_rank <span class="free">R</span> <span class="main">(</span>insert <span class="free">y</span> <span class="free">A</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> 
             <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">∧</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">+</span> linorder_rank <span class="free">R</span> <span class="free">A</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> linorder_rank_union<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">y</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorder_rank_singleton<span class="main">)</span>
   
<span class="keyword1" id="Linorder_Relations-linorder_rank_mono"><span class="command">lemma</span></span> linorder_rank_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">B</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"linorder_rank <span class="free">R</span> <span class="free">A</span> <span class="free">x</span> <span class="main">≤</span> linorder_rank <span class="free">R</span> <span class="free">A</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> linorder_rank_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"antisym <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linorder_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms antisym <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound"><span class="bound">ya</span></span> <span class="main">∈</span> <span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">ya</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> trans<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> antisym_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Linorder_Relations-linorder_rank_strict_mono"><span class="command">lemma</span></span> linorder_rank_strict_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">B</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"linorder_rank <span class="free">R</span> <span class="free">A</span> <span class="free">y</span> <span class="main">&lt;</span> linorder_rank <span class="free">R</span> <span class="free">A</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linorder_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorder_on_def antisym_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">z</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> * <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span> <span class="main">⊂</span> <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">z</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> linorder_rank_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> psubset_card_mono<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>      

<span class="keyword1" id="Linorder_Relations-linorder_rank_le_iff"><span class="command">lemma</span></span> linorder_rank_le_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">B</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"linorder_rank <span class="free">R</span> <span class="free">A</span> <span class="free">x</span> <span class="main">≤</span> linorder_rank <span class="free">R</span> <span class="free">A</span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorder_on_def refl_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linorder_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹linorder_on <span class="free">B</span> <span class="free">R</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorder_on_def antisym_def total_on_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> linorder_rank_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> linorder_rank_strict_mono<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> assms False 
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linorder_Relations-linorder_rank_eq_iff"><span class="command">lemma</span></span> linorder_rank_eq_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">B</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"linorder_rank <span class="free">R</span> <span class="free">A</span> <span class="free">x</span> <span class="main">=</span> linorder_rank <span class="free">R</span> <span class="free">A</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"linorder_rank <span class="free">R</span> <span class="free">A</span> <span class="free">x</span> <span class="main">=</span> linorder_rank <span class="free">R</span> <span class="free">A</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> linorder_rank_le_iff<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span><span class="main">]</span> linorder_rank_le_iff<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorder_on_def antisym_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  
<span class="keyword1" id="Linorder_Relations-linorder_rank_set_sorted_wrt"><span class="command">lemma</span></span> linorder_rank_set_sorted_wrt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">B</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"linorder_rank <span class="free">R</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> index <span class="free">xs</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> index <span class="free">xs</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> j_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> linorder_on_cases<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> assms that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span>set <span class="free">xs</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span>set <span class="free">xs</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> index <span class="free">xs</span> <span class="bound">y</span> <span class="main">&lt;</span> index <span class="free">xs</span> <span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_wrt_linorder_index_less_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1-3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> index <span class="free">xs</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="skolem">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> j_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">j</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"index <span class="free">xs</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> index <span class="free">xs</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(!)</span> <span class="free">xs</span> <span class="main">`</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms j<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> index_nth_id<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">j</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_image<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def nth_eq_iff_index_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> j_def linorder_rank_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linorder_Relations-bij_betw_linorder_rank"><span class="command">lemma</span></span> bij_betw_linorder_rank<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">B</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>linorder_rank <span class="free">R</span> <span class="free">A</span><span class="main">)</span> <span class="free">A</span> <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> sorted_wrt_list_of_set <span class="free">R</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> xs <span class="main">=</span> linorder_sorted_wrt_list_of_set<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">folded</span> xs_def<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="skolem">xs</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> len_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> card <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‹set <span class="skolem">xs</span> <span class="main">=</span> <span class="free">A</span>›</span></span> <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_card<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> rank<span class="main">:</span> <span class="quoted"><span class="quoted">"linorder_rank <span class="free">R</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> index <span class="skolem">xs</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> linorder_rank_set_sorted_wrt<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> assms that xs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> xs len_xs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bij_betw_byWitness<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">xs</span></span></span> <span class="main"><span class="main"><span class="main">!</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rank index_nth_id <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nth_mem<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The bijection between linear orderings and lists›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> bij_betw_linorder_of_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"bij_betw linorder_of_list <span class="main">(</span>permutations_of_set <span class="free">A</span><span class="main">)</span> <span class="main">{</span><span class="bound">R</span><span class="main">.</span> linorder_on <span class="free">A</span> <span class="bound">R</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> bij_betw_byWitness<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">R</span></span><span class="main"><span class="main">.</span></span> sorted_wrt_list_of_set <span class="bound"><span class="bound">R</span></span> <span class="free"><span class="free">A</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> ballI subsetI<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sorted_wrt_list_of_set_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutations_of_set_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">R</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> R <span class="keyword1"><span class="command">have</span></span> in_R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword1"><span class="command">using</span></span> that 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorder_on_def refl_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sorted_wrt_list_of_set <span class="skolem">R</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?xs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?xs</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="skolem">R</span> <span class="var">?xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> linorder_sorted_wrt_list_of_set<span class="main"><span class="main">[</span></span><span class="operator">OF</span> R<span class="main"><span class="main">]</span></span> assms order.refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> sorted_wrt_linorder_index_le_iff<span class="main">[</span><span class="operator">OF</span> R<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorder_of_list_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_R<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> sorted_wrt_list_of_set <span class="skolem">R</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sorted_wrt_list_of_set <span class="skolem">R</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?xs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?xs</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="skolem">R</span> <span class="var">?xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> linorder_sorted_wrt_list_of_set<span class="main"><span class="main">[</span></span><span class="operator">OF</span> R<span class="main"><span class="main">]</span></span> assms order.refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutations_of_set_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> card_finite_linorders<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">R</span><span class="main">.</span> linorder_on <span class="free">A</span> <span class="bound">R</span><span class="main">}</span> <span class="main">=</span> fact <span class="main">(</span>card <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">R</span><span class="main">.</span> linorder_on <span class="free">A</span> <span class="bound">R</span><span class="main">}</span> <span class="main">=</span> card <span class="main">(</span>permutations_of_set <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> bij_betw_same_card <span class="main"><span class="main">[</span></span><span class="operator">OF</span> bij_betw_linorder_of_list<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fact <span class="main">(</span>card <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_permutations_of_set<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Comparison_Sort_Lower_Bound">
<div class="head">
<h1>Theory Comparison_Sort_Lower_Bound</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Comparison_Sort_Lower_Bound.thy
  Author:   Manuel Eberl &lt;eberlm@in.tum.de&gt;

  Proof of the lower-bound on worst-case comparisons in a comparison-based sorting algorithm.
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lower bound on costs of comparison-based sorting›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Comparison_Sort_Lower_Bound
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a> 
    <a href="Linorder_Relations.html">Linorder_Relations</a>
    <a href="../Stirling_Formula/Stirling_Formula.html">Stirling_Formula.Stirling_Formula</a>
    <span class="quoted">"<a href="../Landau_Symbols/Landau_More.html">Landau_Symbols.Landau_More</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Abstract description of sorting algorithms›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We have chosen to model a sorting algorithm in the following way: A sorting algorithm takes a 
  list with distinct elements and a linear ordering on these elements, and it returns a list 
  with the same elements that is sorted w.\,r.\,t.\ the given ordering.

  The use of an explicit ordering means that the algorithm must look at the ordering, i.\,e.\ 
  it has to use pair-wise comparison of elements, since all the information that is relevant 
  for producing the correct sorting is in the ordering; the elements themselves are irrelevant.

  Furthermore, we record the number of comparisons that the algorithm makes by not giving it the 
  relation explicitly, but in the form of a comparison oracle that may be queried.

  A sorting algorithm (or `sorter') for a fixed input list (but for arbitrary orderings) can then
  be written as a recursive datatype that is either the result (the sorted list) or a comparison 
  query consisting of two elements and a continuation that maps the result of the comparison
  to the remaining computation.
›</span></span>  

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> sorter <span class="main">=</span> Return <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="main">|</span> Query <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="tfree">'a</span> sorter"</span></span>
    

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Cormen~\emph{et\ al.}~\cite{cormen}\ use a similar `decision tree' model where an sorting 
  algorithm for lists of fixed size $n$ is modelled as a binary tree where each node is a 
  comparison of two elements. They also demand that every leaf in the tree be reachable in 
  order to avoid `dead' subtrees (if the algorithm makes redundant comparisons, there may be 
  branches that can never be taken). Then, the worst-case number of comparisons made is simply 
  the height of the tree.

  We chose a subtly different model that does not have this restriction on the algorithm but 
  instead uses a more semantic way of counting the worst-case number of comparisons: We simply 
  use the maximum number of comparisons that occurs for any of the (finitely many) inputs.

  We therefore first define a function that counts the number of queries for a specific
  ordering and then a function that counts the number of queries in the worst case (ranging 
  over a given set of allowed orderings; typically, this will be the set of all linear orders
  on the list).
›</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">count_queries</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> sorter <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">count_queries</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Return <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>    <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">count_queries</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>Query <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">count_queries</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">count_wc_queries</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> sorter <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">count_wc_queries</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">sorter</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Max <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> count_queries <span class="bound">R</span> <span class="free"><span class="bound"><span class="entity">sorter</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Comparison_Sort_Lower_Bound-count_wc_queries_empty"><span class="command">lemma</span></span> count_wc_queries_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"count_wc_queries <span class="main">{}</span> <span class="free">sorter</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> count_wc_queries_def<span class="main">)</span>

<span class="keyword1" id="Comparison_Sort_Lower_Bound-count_wc_queries_aux"><span class="command">lemma</span></span> count_wc_queries_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">R</span><span class="main">.</span> <span class="bound">R</span> <span class="main">∈</span> <span class="free">Rs</span> <span class="main">⟹</span> <span class="free">sorter</span> <span class="main">=</span> <span class="free">sorter'</span> <span class="bound">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Rs</span> <span class="main">⊆</span> <span class="free">Rs'</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Rs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"count_wc_queries <span class="free">Rs</span> <span class="free">sorter</span> <span class="main">≤</span> Max <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> count_queries <span class="bound">R</span> <span class="main">(</span><span class="free">sorter'</span> <span class="bound">R</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">Rs'</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">Rs</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"count_wc_queries <span class="free">Rs</span> <span class="free">sorter</span> <span class="main">=</span> Max <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> count_queries <span class="bound">R</span> <span class="free">sorter</span><span class="main">)</span> <span class="main">`</span> <span class="free">Rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> count_wc_queries_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> count_queries <span class="bound">R</span> <span class="free">sorter</span><span class="main">)</span> <span class="main">`</span> <span class="free">Rs</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> count_queries <span class="bound">R</span> <span class="main">(</span><span class="free">sorter'</span> <span class="bound">R</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">Rs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> image_cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">…</span> <span class="main">≤</span> Max <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> count_queries <span class="bound">R</span> <span class="main">(</span><span class="free">sorter'</span> <span class="bound">R</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">Rs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Max_mono assms image_mono finite_imageI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">eval_sorter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> sorter <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_sorter</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Return <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>   <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_sorter</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>Query <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">eval_sorter</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now get an obvious bound on the maximum number of different results that a given sorter 
  can produce.
›</span></span>
<span class="keyword1" id="Comparison_Sort_Lower_Bound-card_range_eval_sorter"><span class="command">lemma</span></span> card_range_eval_sorter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> eval_sorter <span class="bound">R</span> <span class="free">e</span><span class="main">)</span> <span class="main">`</span> <span class="free">Rs</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> count_wc_queries <span class="free">Rs</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Rs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Return <span class="skolem">xs</span> <span class="skolem">Rs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> eval_sorter <span class="bound">R</span> <span class="main">(</span>Return <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Rs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">Rs</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="skolem">xs</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> *<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Query <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">Rs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> True <span class="main">∈</span> range <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> False <span class="main">∈</span> range <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this <span class="main">[</span><span class="operator">THEN</span> Query.IH<span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Rs1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">R</span></span><span class="main">∈</span><span class="skolem">Rs</span><span class="main">.</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">R</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?Rs2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">R</span></span><span class="main">∈</span><span class="skolem">Rs</span><span class="main">.</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∉</span> <span class="bound">R</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> eval_sorter <span class="bound">R</span> <span class="main">(</span><span class="skolem">f</span> True<span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="var">?Rs1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> eval_sorter <span class="bound">R</span> <span class="main">(</span><span class="skolem">f</span> False<span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="var">?Rs2</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Query.prems <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?Rs1</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?Rs2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> eval_sorter <span class="bound">R</span> <span class="main">(</span>Query <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Rs</span> <span class="main">⊆</span> <span class="var">?A</span> <span class="main">∪</span> <span class="var">?B</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> imageE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span> <span class="skolem">R</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">R</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">Rs</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> eval_sorter <span class="bound">R</span> <span class="main">(</span>Query <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Rs</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="var">?A</span> <span class="main">∪</span> <span class="var">?B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono finite_UnI finite_imageI fin *<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="var">?A</span> <span class="main">+</span> card <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_Un_le<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> count_wc_queries <span class="var">?Rs1</span> <span class="main">(</span><span class="skolem">f</span> True<span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> count_wc_queries <span class="var">?Rs2</span> <span class="main">(</span><span class="skolem">f</span> False<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono IH fin<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count_wc_queries <span class="var">?Rs1</span> <span class="main">(</span><span class="skolem">f</span> True<span class="main">)</span> <span class="main">≤</span> Max <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> count_queries <span class="bound">R</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span><span class="main">∈</span><span class="bound">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Rs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> count_wc_queries_aux Query.prems<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count_wc_queries <span class="var">?Rs2</span> <span class="main">(</span><span class="skolem">f</span> False<span class="main">)</span> <span class="main">≤</span> Max <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> count_queries <span class="bound">R</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span><span class="main">∈</span><span class="bound">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Rs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> count_wc_queries_aux Query.prems<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="main">…</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> Suc <span class="main">…</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Max <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> count_queries <span class="bound">R</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span><span class="main">∈</span><span class="bound">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Rs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
                 Max <span class="main">(</span>Suc <span class="main">`</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> count_queries <span class="bound">R</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span><span class="main">∈</span><span class="bound">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Rs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mono_Max_commute finite_imageI Query.prems<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> incseq_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">`</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> count_queries <span class="bound">R</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span><span class="main">∈</span><span class="bound">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Rs</span><span class="main">)</span> <span class="main">=</span> 
                 <span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> Suc <span class="main">(</span>count_queries <span class="bound">R</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span><span class="main">∈</span><span class="bound">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_image<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">…</span> <span class="main">=</span> count_wc_queries <span class="skolem">Rs</span> <span class="main">(</span>Query <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> count_wc_queries_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following predicate describes what constitutes a valid sorting result for a given 
  ordering and a given input list. Note that when the ordering is linear, the result is
  actually unique.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_sorting</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_sorting</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⟷</span> <span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> mset <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">∧</span> sorted_wrt <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lower bounds on number of comparisons›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  For a list of $n$ distinct elements, there are $n!$ linear orderings on $n$ elements,
  each of which leads to a different result after sorting the original list. 
  Since a sorter can produce at most $2^k$ different results with $k$ comparisons, we get 
  the bound $2^k \geq n!$:
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sorter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sorter"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sorter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">R</span><span class="main">.</span> linorder_on <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="bound">R</span> <span class="main">⟹</span> is_sorting <span class="bound">R</span> <span class="free">xs</span> <span class="main">(</span>eval_sorter <span class="bound">R</span> <span class="free">sorter</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">Rs</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">R</span><span class="main">.</span> linorder_on <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="bound">R</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   two_power_count_queries_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"fact <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> count_wc_queries <span class="free">Rs</span> <span class="free">sorter</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   count_queries_ge<span class="main">:</span>           <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>fact <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> real <span class="main">(</span>count_wc_queries <span class="free">Rs</span> <span class="free">sorter</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Rs</span> <span class="main">⊆</span> Pow <span class="main">(</span>set <span class="free">xs</span> <span class="main">×</span> set <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Rs_def linorder_on_def refl_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fact <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>permutations_of_set <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_card<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"permutations_of_set <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> eval_sorter <span class="bound">R</span> <span class="free">sorter</span><span class="main">)</span> <span class="main">`</span> <span class="free">Rs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> linorder_of_list <span class="skolem">ys</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> eval_sorter <span class="skolem">R</span> <span class="free">sorter</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> distinct <span class="keyword1"><span class="command">have</span></span> mset_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="skolem">ys</span> <span class="main">=</span> mset <span class="free">xs</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_eq_iff_mset_eq_distinct permutations_of_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"linorder_on <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> R_def <span class="keyword1"><span class="command">using</span></span> linorder_linorder_of_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutations_of_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> sorter<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">=</span> mset <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="skolem">R</span> <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_sorting_def zs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="skolem">R</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> R_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sorted_wrt_linorder_of_list<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutations_of_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sorted_wrt_linorder_unique<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_ys<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">∈</span> <span class="free">Rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Rs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> zs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>permutations_of_set <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> eval_sorter <span class="bound">R</span> <span class="free">sorter</span><span class="main">)</span> <span class="main">`</span> <span class="free">Rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono finite_imageI fin<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> count_wc_queries <span class="free">Rs</span> <span class="free">sorter</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_range_eval_sorter<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"fact <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> count_wc_queries <span class="free">Rs</span> <span class="free">sorter</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ln <span class="main">(</span>real <span class="main">(</span>fact <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> ln <span class="main">(</span>real <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> count_wc_queries <span class="free">Rs</span> <span class="free">sorter</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> ln_le_cancel_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>fact <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> real <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> count_wc_queries <span class="free">Rs</span> <span class="free">sorter</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> of_nat_le_iff<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> *<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real <span class="main">(</span>count_wc_queries <span class="free">Rs</span> <span class="free">sorter</span><span class="main">)</span> <span class="main">*</span> ln <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ln_realpow<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>count_wc_queries <span class="free">Rs</span> <span class="free">sorter</span><span class="main">)</span> <span class="main">≥</span> ln <span class="main">(</span>fact <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> ln <span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> ln <span class="numeral">2</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="main">(</span>fact <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> log_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>fact <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> real <span class="main">(</span>count_wc_queries <span class="free">Rs</span> <span class="free">sorter</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: Good example for automation. Also, move. *)</span>
<span class="keyword1" id="Comparison_Sort_Lower_Bound-ln_fact_bigo"><span class="command">lemma</span></span> ln_fact_bigo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ln <span class="main">(</span>fact <span class="bound">n</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="bound">n</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span> <span class="main">-</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> asymp_equiv_ln_fact <span class="main">[</span><span class="operator">asymp_equiv_intros</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ln <span class="main">(</span>fact <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">include</span></span> asymp_equiv_notation
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ln <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> real <span class="bound">n</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> real <span class="bound">n</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span> <span class="main">-</span> real <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ln <span class="main">(</span>fact <span class="bound">n</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">/</span><span class="main">(</span><span class="numeral">12</span><span class="main">*</span>real <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eventually_gt_at_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">::</span>nat"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">eventually_elim</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>elim <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ln_fact_bounds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">n</span></span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span>ln <span class="main">(</span>fact <span class="bound">n</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">12</span><span class="main">)</span> <span class="main">*</span> norm <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span><span class="main">)</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eventually_gt_at_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">::</span>nat"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ln <span class="main">(</span>fact <span class="bound">n</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> bigoI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ln <span class="main">(</span>fact <span class="bound">n</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">f</span> <span class="bound">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="numeral">12</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> smallo_real_nat_transfer<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="main">+</span> <span class="main">(</span>ln <span class="main">(</span>fact <span class="bound">n</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">f</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∼</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> asymp_equiv_add_right<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ln <span class="main">(</span>fact <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∼</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∼</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span> <span class="main">+</span> <span class="main">(</span>ln <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>pi<span class="main">*</span><span class="bound">n</span><span class="main">)</span><span class="main">/</span><span class="numeral">2</span> <span class="main">-</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∼</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> asymp_equiv_add_right<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ln <span class="main">(</span>fact <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∼</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This leads to the following well-known Big-Omega bound on the number of comparisons 
  that a general sorting algorithm has to make:
›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> count_queries_bigomega<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sorter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat sorter"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sorter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">R</span><span class="main">.</span> linorder_on <span class="main">{..&lt;</span><span class="bound">n</span><span class="main">}</span> <span class="bound">R</span> <span class="main">⟹</span> 
                         is_sorting <span class="bound">R</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">n</span><span class="main">]</span> <span class="main">(</span>eval_sorter <span class="bound">R</span> <span class="main">(</span><span class="free">sorter</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">Rs</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">{</span><span class="bound">R</span><span class="main">.</span> linorder_on <span class="main">{..&lt;</span><span class="bound">n</span><span class="main">}</span> <span class="bound">R</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> count_wc_queries <span class="main">(</span><span class="free">Rs</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free">sorter</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">Ω(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">Θ(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ln <span class="main">(</span>fact <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bigtheta_sym<span class="main">)</span> <span class="main">(</span><span class="operator">intro</span> asymp_equiv_imp_bigtheta <span class="dynamic"><span class="dynamic">asymp_equiv_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ln <span class="main">(</span>fact <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">Θ(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> log <span class="numeral">2</span> <span class="main">(</span>fact <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> log_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> log <span class="numeral">2</span> <span class="main">(</span>fact <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> count_wc_queries <span class="main">(</span><span class="free">Rs</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free">sorter</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> bigoI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span><span class="main"><span class="main">]</span></span> always_eventually allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>log <span class="numeral">2</span> <span class="main">(</span>fact <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="main">(</span>fact <span class="main">(</span>length <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sorter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> real <span class="main">(</span>count_wc_queries <span class="main">(</span><span class="free">Rs</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">sorter</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> count_queries_ge<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">sorter</span> <span class="skolem">n</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Rs_def atLeast0LessThan<span class="main">)</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">*</span> norm <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bigomega_iff_bigo<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>