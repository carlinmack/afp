<div id="LTL_to_GBA">
<div class="head">
<h1>Theory LTL_to_GBA</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹LTL to GBA translation›</span></span>
<span class="comment1">(*
  Author: Alexander Schimpf
    Modified by Peter Lammich

**)</span>
<span class="keyword1"><span class="command">theory</span></span> LTL_to_GBA
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../CAVA_Base/CAVA_Base.html">CAVA_Base.CAVA_Base</a>
  <a href="../LTL/LTL.html">LTL.LTL</a>
  <a href="../CAVA_Automata/Automata.html">CAVA_Automata.Automata</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Statistics›</span></span>
<span class="keyword1"><span class="command">code_printing</span></span>
  <span class="keyword2"><span class="keyword">code_module</span></span> Gerth_Statistics <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">‹
    structure Gerth_Statistics = struct
      val active = Unsynchronized.ref false
      val data = Unsynchronized.ref (0,0,0)

      fun is_active () = !active
      fun set_data num_states num_init num_acc = (
        active := true;
        data := (num_states, num_init, num_acc)
      )

      fun to_string () = let
        val (num_states, num_init, num_acc) = !data
      in
          "Num states: " ^ IntInf.toString (num_states) ^ "\n"
        ^ "  Num initial: " ^ IntInf.toString num_init ^ "\n"
        ^ "  Num acc-classes: " ^ IntInf.toString num_acc ^ "\n"
      end

      val _ = Statistics.register_stat ("Gerth LTL_to_GBA",is_active,to_string)
    end
›</span>
<span class="keyword1"><span class="command">code_reserved</span></span> SML Gerth_Statistics

<span class="keyword1"><span class="command">consts</span></span>
  stat_set_data_int <span class="main">::</span> <span class="quoted"><span class="quoted">"integer <span class="main">⇒</span> integer <span class="main">⇒</span> integer <span class="main">⇒</span> unit"</span></span>

<span class="keyword1"><span class="command">code_printing</span></span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">stat_set_data_int</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"Gerth'_Statistics.set'_data"</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">stat_set_data</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">ni</span></span></span> <span class="free"><span class="bound"><span class="entity">na</span></span></span>
  <span class="main">≡</span> stat_set_data_int <span class="main">(</span>integer_of_nat <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span> <span class="main">(</span>integer_of_nat <span class="free"><span class="bound"><span class="entity">ni</span></span></span><span class="main">)</span> <span class="main">(</span>integer_of_nat <span class="free"><span class="bound"><span class="entity">na</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>stat_set_data<span class="main">,</span>stat_set_data<span class="main">)</span> <span class="main">∈</span> nat_rel <span class="main">→</span> nat_rel <span class="main">→</span> nat_rel <span class="main">→</span> unit_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">stat_set_data_nres</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">ni</span></span></span> <span class="free"><span class="bound"><span class="entity">na</span></span></span> <span class="main">≡</span> RETURN <span class="main">(</span>stat_set_data <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">ni</span></span></span> <span class="free"><span class="bound"><span class="entity">na</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> discard_stat_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m1</span><span class="main">≤</span><span class="free">m2</span> <span class="main">⟹</span> stat_set_data_nres <span class="free">ns</span> <span class="free">ni</span> <span class="free">na</span> <span class="main">⪢</span> <span class="free">m1</span> <span class="main">≤</span> <span class="free">m2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some very special lemmas for reasoning about the nres-monad›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> SPEC_rule_nested2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">m</span> <span class="main">≤</span> SPEC <span class="free">P</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">r1</span> <span class="bound">r2</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">r1</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">(</span><span class="bound">r1</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="free">P</span><span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">m</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span><span class="main">.</span> <span class="free">g</span> <span class="bound">r'</span> <span class="main">≤</span> SPEC <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff<span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> SPEC_rule_param2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">P</span> <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r1</span> <span class="bound">r2</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">r1</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="free">x'</span><span class="main">)</span> <span class="main">(</span><span class="bound">r1</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">P</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SPEC_rule_weak<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">Q</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">P</span> <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r1</span> <span class="bound">r2</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="free">Q</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">r1</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="free">P</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">r1</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="free">x'</span><span class="main">)</span> <span class="main">(</span><span class="bound">r1</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">P</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SPEC_rule_weak_nested2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">f</span> <span class="main">≤</span> SPEC <span class="free">Q</span><span class="main">;</span> <span class="free">f</span> <span class="main">≤</span> SPEC <span class="free">P</span><span class="main">;</span>
  <span class="main">⋀</span><span class="bound">r1</span> <span class="bound">r2</span><span class="main">.</span> <span class="main">⟦</span><span class="free">Q</span> <span class="main">(</span><span class="bound">r1</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span><span class="main">;</span> <span class="free">P</span> <span class="main">(</span><span class="bound">r1</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">(</span><span class="bound">r1</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="free">P</span><span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">f</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span><span class="main">.</span> <span class="free">g</span> <span class="bound">r'</span> <span class="main">≤</span> SPEC <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff<span class="main">)</span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Creation of States›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section, the first part of the algorithm, which creates the states of the
  automaton, is formalized.
›</span></span>

<span class="comment1">(* FIXME: Abstraktion über node_name *)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> node_name <span class="main">=</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> frml <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltlr"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> interprt <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set word"</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'a</span> node <span class="main">=</span>
  name <span class="main">::</span> <span class="quoted">node_name</span>
  incoming <span class="main">::</span> <span class="quoted"><span class="quoted">"node_name set"</span></span>
  new <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> frml set"</span></span>
  old <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> frml set"</span></span>
  <span class="quoted">"next"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> frml set"</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">new1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">new1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="keyword1">and<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">new1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">new1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">new1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="keyword1">or<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">new1</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">next1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next1</span> <span class="main">(</span><span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">next1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">next1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">next1</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">new2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">new2</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">new2</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">new2</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="keyword1">or<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">new2</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>


<span class="comment1">(* FIXME: Abstraction over concrete definition *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">expand_init</span> <span class="main">≡</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">expand_new_name</span> <span class="main">≡</span> Suc"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> expand_new_name_expand_init<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_init <span class="main">&lt;</span> expand_new_name <span class="free">nm</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>expand_init_def expand_new_name_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> expand_new_name_step<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> node"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"name <span class="free">n</span> <span class="main">&lt;</span> expand_new_name <span class="main">(</span>name <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>expand_new_name_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> expand_new_name__less_zero<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> expand_new_name <span class="free">nm</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> expand_new_name_expand_init <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_init <span class="main">&lt;</span> expand_new_name <span class="free">nm</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gr0I less_zeroE<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">upd_incoming_f</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n'</span><span class="main">.</span>
    <span class="keyword1">if</span> <span class="main">(</span>old <span class="bound">n'</span> <span class="main">=</span> old <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> next <span class="bound">n'</span> <span class="main">=</span> next <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
      <span class="bound">n'</span><span class="main">⦇</span> incoming <span class="main">:=</span> incoming <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∪</span> incoming <span class="bound">n'</span> <span class="main">⦈</span>
    <span class="keyword1">else</span> <span class="bound">n'</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">upd_incoming</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span>upd_incoming_f <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> upd_incoming__elem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">nd</span><span class="main">∈</span>upd_incoming <span class="free">n</span> <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">nd</span><span class="main">∈</span><span class="free">ns</span>
         <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">nd'</span><span class="main">∈</span><span class="free">ns</span><span class="main">.</span> <span class="free">nd</span> <span class="main">=</span> <span class="bound">nd'</span><span class="main">⦇</span> incoming <span class="main">:=</span> incoming <span class="free">n</span> <span class="main">∪</span> incoming <span class="bound">nd'</span> <span class="main">⦈</span> <span class="main">∧</span>
                            old <span class="bound">nd'</span> <span class="main">=</span> old <span class="free">n</span> <span class="main">∧</span>
                            next <span class="bound">nd'</span> <span class="main">=</span> next <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nd'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span><span class="main">∈</span><span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nd_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nd</span> <span class="main">=</span> upd_incoming_f <span class="free">n</span> <span class="skolem">nd'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> upd_incoming_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> upd_incoming__ident_node<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">nd</span><span class="main">∈</span>upd_incoming <span class="free">n</span> <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">nd</span><span class="main">∈</span><span class="free">ns</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"incoming <span class="free">n</span> <span class="main">⊆</span> incoming <span class="free">nd</span> <span class="main">∨</span> <span class="main">¬</span> <span class="main">(</span>old <span class="free">nd</span> <span class="main">=</span> old <span class="free">n</span> <span class="main">∧</span> next <span class="free">nd</span> <span class="main">=</span> next <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nsubset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>incoming <span class="free">n</span> <span class="main">⊆</span> incoming <span class="free">nd</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    old_next_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"old <span class="free">nd</span> <span class="main">=</span> old <span class="free">n</span> <span class="main">∧</span> next <span class="free">nd</span> <span class="main">=</span> next <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nd'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span><span class="main">∈</span><span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nd_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nd</span> <span class="main">=</span> upd_incoming_f <span class="free">n</span> <span class="skolem">nd'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> upd_incoming_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"old <span class="skolem">nd'</span> <span class="main">=</span> old <span class="free">n</span> <span class="main">∧</span> next <span class="skolem">nd'</span> <span class="main">=</span> next <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> nd_eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">nd</span> <span class="main">=</span> <span class="skolem">nd'</span><span class="main">⦇</span>incoming <span class="main">:=</span> incoming <span class="free">n</span> <span class="main">∪</span> incoming <span class="skolem">nd'</span><span class="main">⦈</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> nsubset <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>old <span class="skolem">nd'</span> <span class="main">=</span> old <span class="free">n</span> <span class="main">∧</span> next <span class="skolem">nd'</span> <span class="main">=</span> next <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> nd_eq old_next_eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> upd_incoming__ident<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">∈</span><span class="free">ns</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">n</span><span class="main">∈</span><span class="free">ns</span><span class="main">;</span> <span class="free">P</span> <span class="bound">n</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">n</span><span class="main">⦇</span> incoming <span class="main">:=</span> <span class="bound">v</span> <span class="main">⦈</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">∈</span>upd_incoming <span class="free">n</span> <span class="free">ns</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">nd</span> <span class="skolem">v</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n'</span><span class="main">.</span>
    <span class="keyword1">if</span> <span class="main">(</span>old <span class="bound">n'</span> <span class="main">=</span> old <span class="free">n</span> <span class="main">∧</span> next <span class="bound">n'</span> <span class="main">=</span> next <span class="free">n</span><span class="main">)</span> <span class="keyword1">then</span>
      <span class="bound">n'</span><span class="main">⦇</span> incoming <span class="main">:=</span> incoming <span class="free">n</span> <span class="main">∪</span> incoming <span class="bound">n'</span> <span class="main">⦈</span>
    <span class="keyword1">else</span> <span class="bound">n'</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span><span class="main">∈</span>upd_incoming <span class="free">n</span> <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nd'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span><span class="main">∈</span><span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nd_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">nd'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> upd_incoming_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"old <span class="skolem">nd'</span> <span class="main">=</span> old <span class="free">n</span> <span class="main">∧</span> next <span class="skolem">nd'</span> <span class="main">=</span> next <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span> <span class="main">=</span> <span class="skolem">nd'</span><span class="main">⦇</span> incoming <span class="main">:=</span> <span class="skolem">v</span> <span class="main">⦈</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nd_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">nd'</span><span class="main">∈</span><span class="free">ns</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">nd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">nd</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nd_eq <span class="quoted"><span class="quoted">‹<span class="skolem">nd'</span><span class="main">∈</span><span class="free">ns</span>›</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> name_upd_incoming_f<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"name <span class="main">(</span>upd_incoming_f <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> name <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> name_upd_incoming<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"name <span class="main">`</span> <span class="main">(</span>upd_incoming <span class="free">n</span> <span class="free">ns</span><span class="main">)</span> <span class="main">=</span> name <span class="main">`</span> <span class="free">ns</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> upd_incoming_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"upd_incoming_f <span class="free">n</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n'</span><span class="main">.</span> local.upd_incoming_f <span class="free">n</span> <span class="bound">n'</span><span class="main">)</span> <span class="main">`</span> <span class="free">ns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"name <span class="main">(</span>upd_incoming_f <span class="free">n</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> name <span class="main">`</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n'</span><span class="main">.</span> local.upd_incoming_f <span class="free">n</span> <span class="bound">n'</span><span class="main">)</span> <span class="main">`</span> <span class="free">ns</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">x</span> <span class="main">∈</span> name <span class="main">`</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n'</span><span class="main">.</span> local.upd_incoming_f <span class="free">n</span> <span class="bound">n'</span><span class="main">)</span> <span class="main">`</span> <span class="free">ns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">expand_body</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">expand_body</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">expand</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">ns</span><span class="main">)</span><span class="main">.</span>
      <span class="keyword1">if</span> new <span class="bound">n</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">(</span>
        <span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n'</span><span class="main">∈</span><span class="bound">ns</span><span class="main">.</span> old <span class="bound">n'</span> <span class="main">=</span> old <span class="bound">n</span> <span class="main">∧</span> next <span class="bound">n'</span> <span class="main">=</span> next <span class="bound">n</span><span class="main">)</span> <span class="keyword1">then</span>
          RETURN <span class="main">(</span>name <span class="bound">n</span><span class="main">,</span> upd_incoming <span class="bound">n</span> <span class="bound">ns</span><span class="main">)</span>
        <span class="keyword1">else</span>
          <span class="bound">expand</span> <span class="main">(</span>
            <span class="main">⦇</span>
              name<span class="main">=</span>expand_new_name <span class="main">(</span>name <span class="bound">n</span><span class="main">)</span><span class="main">,</span>
              incoming<span class="main">=</span><span class="main">{</span>name <span class="bound">n</span><span class="main">}</span><span class="main">,</span>
              new<span class="main">=</span>next <span class="bound">n</span><span class="main">,</span>
              old<span class="main">=</span><span class="main">{}</span><span class="main">,</span>
              next<span class="main">=</span><span class="main">{}</span>
            <span class="main">⦈</span><span class="main">,</span>
            <span class="main">{</span><span class="bound">n</span><span class="main">}</span> <span class="main">∪</span> <span class="bound">ns</span><span class="main">)</span>
      <span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">φ</span> <span class="main">←</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="main">(</span>new <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        <span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> <span class="bound">n</span><span class="main">⦇</span> new <span class="main">:=</span> new <span class="bound">n</span> <span class="main">-</span> <span class="main">{</span><span class="bound">φ</span><span class="main">}</span> <span class="main">⦈</span><span class="main">;</span>
        <span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">=</span> <span class="keyword1">prop<span class="hidden">⇩</span><sub>r</sub>(</span><span class="bound">q</span><span class="main">)</span> <span class="main">∨</span> <span class="bound">φ</span> <span class="main">=</span> <span class="keyword1">nprop<span class="hidden">⇩</span><sub>r</sub>(</span><span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
          <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>not<span class="hidden">⇩</span><sub>r</sub> <span class="bound">φ</span><span class="main">)</span> <span class="main">∈</span> old <span class="bound">n</span> <span class="keyword1">then</span> RETURN <span class="main">(</span>name <span class="bound">n</span><span class="main">,</span> <span class="bound">ns</span><span class="main">)</span>
           <span class="keyword1">else</span> <span class="bound">expand</span> <span class="main">(</span><span class="bound">n</span><span class="main">⦇</span> old <span class="main">:=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">}</span> <span class="main">∪</span> old <span class="bound">n</span> <span class="main">⦈</span><span class="main">,</span> <span class="bound">ns</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">φ</span> <span class="main">=</span> <span class="keyword1">true<span class="hidden">⇩</span><sub>r</sub></span> <span class="keyword1">then</span> <span class="bound">expand</span> <span class="main">(</span><span class="bound">n</span><span class="main">⦇</span> old <span class="main">:=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">}</span> <span class="main">∪</span> old <span class="bound">n</span> <span class="main">⦈</span><span class="main">,</span> <span class="bound">ns</span><span class="main">)</span>
        <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">φ</span> <span class="main">=</span> <span class="keyword1">false<span class="hidden">⇩</span><sub>r</sub></span> <span class="keyword1">then</span> RETURN <span class="main">(</span>name <span class="bound">n</span><span class="main">,</span> <span class="bound">ns</span><span class="main">)</span>
        <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ν</span> <span class="bound">μ</span><span class="main">.</span> <span class="main">(</span><span class="bound">φ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">φ</span> <span class="main">=</span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ν</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
          <span class="bound">expand</span> <span class="main">(</span>
            <span class="bound">n</span><span class="main">⦇</span>
              new <span class="main">:=</span> new1 <span class="bound">φ</span> <span class="main">∪</span> new <span class="bound">n</span><span class="main">,</span>
              old <span class="main">:=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">}</span> <span class="main">∪</span> old <span class="bound">n</span><span class="main">,</span>
              next <span class="main">:=</span> next1 <span class="bound">φ</span> <span class="main">∪</span> next <span class="bound">n</span>
            <span class="main">⦈</span><span class="main">,</span>
            <span class="bound">ns</span><span class="main">)</span>
        <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="main">(</span><span class="bound">nm</span><span class="main">,</span> <span class="bound">nds</span><span class="main">)</span> <span class="main">←</span> <span class="bound">expand</span> <span class="main">(</span>
            <span class="bound">n</span><span class="main">⦇</span>
              new <span class="main">:=</span> new1 <span class="bound">φ</span> <span class="main">∪</span> new <span class="bound">n</span><span class="main">,</span>
              old <span class="main">:=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">}</span> <span class="main">∪</span> old <span class="bound">n</span><span class="main">,</span>
              next <span class="main">:=</span> next1 <span class="bound">φ</span> <span class="main">∪</span> next <span class="bound">n</span>
            <span class="main">⦈</span><span class="main">,</span>
            <span class="bound">ns</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">expand</span> <span class="main">(</span><span class="bound">n</span><span class="main">⦇</span> name <span class="main">:=</span> <span class="bound">nm</span><span class="main">,</span> new <span class="main">:=</span> new2 <span class="bound">φ</span> <span class="main">∪</span> new <span class="bound">n</span><span class="main">,</span> old <span class="main">:=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">}</span> <span class="main">∪</span> old <span class="bound">n</span> <span class="main">⦈</span><span class="main">,</span> <span class="bound">nds</span><span class="main">)</span>
        <span class="main">}</span>
      <span class="main">}</span>
     <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> expand_body_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono expand_body"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">refine_mono</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">expand</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> node <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> node set<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>node_name <span class="main">×</span> <span class="tfree">'a</span> node set<span class="main">)</span> nres"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">expand</span> <span class="main">≡</span> REC expand_body"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> REC_rule_old<span class="main">:</span> <span class="comment1">(* TODO: Adapt proofs below, have fun with subgoal 27 ...*)</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"trimono <span class="free">body</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">x</span><span class="main">;</span> <span class="free">Φ</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">f</span> <span class="main">≤</span> REC <span class="free">body</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">body</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"REC <span class="free">body</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> REC_rule_arb<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pre<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">Φ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> expand_rec_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> expand <span class="bound">x</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">x</span><span class="main">;</span> <span class="free">Φ</span> <span class="bound">x</span> <span class="main">⟧</span>
    <span class="main">⟹</span> expand_body <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"expand <span class="free">x</span> <span class="main">≤</span> <span class="free">M</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> expand_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> REC_rule_old<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Φ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">Φ</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> expand_body_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> I0<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> IS<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> expand_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_funD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">expand_assm_incoming</span> <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span>
   <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">nm</span><span class="main">∈</span>incoming <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span><span class="main">.</span> name <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span> <span class="main">&gt;</span> <span class="bound">nm</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> name <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">∈</span>snd <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">.</span>
        name <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span> <span class="main">&gt;</span> name <span class="bound">q</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">nm</span><span class="main">∈</span>incoming <span class="bound">q</span><span class="main">.</span> name <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span> <span class="main">&gt;</span> <span class="bound">nm</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">expand_rslt_incoming</span> <span class="free"><span class="bound"><span class="entity">nm_nds</span></span></span>
   <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">∈</span>snd <span class="free"><span class="bound"><span class="entity">nm_nds</span></span></span><span class="main">.</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">nm_nds</span></span></span> <span class="main">&gt;</span> name <span class="bound">q</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">nm'</span><span class="main">∈</span>incoming <span class="bound">q</span><span class="main">.</span> fst <span class="free"><span class="bound"><span class="entity">nm_nds</span></span></span> <span class="main">&gt;</span> <span class="bound">nm'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">expand_rslt_name</span> <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span> <span class="free"><span class="bound"><span class="entity">nm_nds</span></span></span>
   <span class="main">≡</span> <span class="main">(</span>name <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span> <span class="main">≤</span> fst <span class="free"><span class="bound"><span class="entity">nm_nds</span></span></span> <span class="main">∧</span> name <span class="main">`</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span> <span class="main">⊆</span> name <span class="main">`</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">nm_nds</span></span></span><span class="main">)</span><span class="main">)</span>
     <span class="main">∧</span> name <span class="main">`</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">nm_nds</span></span></span><span class="main">)</span>
       <span class="main">=</span> name <span class="main">`</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span> <span class="main">∪</span> name <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">nd</span></span><span class="main">∈</span>snd <span class="free"><span class="bound"><span class="entity">nm_nds</span></span></span><span class="main">.</span> name <span class="bound">nd</span> <span class="main">≥</span> name <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">expand_name_ident</span> <span class="free"><span class="bound"><span class="entity">nds</span></span></span>
   <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">nds</span></span></span><span class="main">.</span> <span class="main">∃!</span><span class="bound"><span class="bound">q'</span></span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">nds</span></span></span><span class="main">.</span> name <span class="bound">q</span> <span class="main">=</span> name <span class="bound">q'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">expand_assm_exist</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span>
   <span class="main">≡</span> <span class="main">{</span><span class="bound">η</span><span class="main">.</span> <span class="main">∃</span><span class="bound">μ</span><span class="main">.</span> <span class="bound">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">η</span> <span class="main">∈</span> old <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">η</span><span class="main">}</span> <span class="main">⊆</span> new <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span> <span class="main">∪</span> old <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>new <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span><span class="main">)</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>old <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span><span class="main">)</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>next <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">expand_rslt_exist__node_prop</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">nd</span></span></span>
   <span class="main">≡</span> incoming <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⊆</span> incoming <span class="free"><span class="bound"><span class="entity">nd</span></span></span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>old <span class="free"><span class="bound"><span class="entity">nd</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>next <span class="free"><span class="bound"><span class="entity">nd</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span><span class="main">)</span>
      <span class="main">∧</span> <span class="main">{</span><span class="bound">η</span><span class="main">.</span> <span class="main">∃</span><span class="bound">μ</span><span class="main">.</span> <span class="bound">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">η</span> <span class="main">∈</span> old <span class="free"><span class="bound"><span class="entity">nd</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="free"><span class="bound"><span class="entity">nd</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">expand_rslt_exist</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span> <span class="free"><span class="bound"><span class="entity">nm_nds</span></span></span>
  <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">nd</span><span class="main">∈</span>snd <span class="free"><span class="bound"><span class="entity">nm_nds</span></span></span><span class="main">.</span> expand_rslt_exist__node_prop <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span> <span class="bound">nd</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">expand_rslt_exist_eq__node</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">nd</span></span></span>
   <span class="main">≡</span> name <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> name <span class="free"><span class="bound"><span class="entity">nd</span></span></span>
    <span class="main">∧</span> old <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> old <span class="free"><span class="bound"><span class="entity">nd</span></span></span>
    <span class="main">∧</span> next <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> next <span class="free"><span class="bound"><span class="entity">nd</span></span></span>
    <span class="main">∧</span> incoming <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⊆</span> incoming <span class="free"><span class="bound"><span class="entity">nd</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">expand_rslt_exist_eq</span> <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span> <span class="free"><span class="bound"><span class="entity">nm_nds</span></span></span> <span class="main">≡</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">∈</span>snd <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">.</span> <span class="main">∃</span><span class="bound">nd</span><span class="main">∈</span>snd <span class="free"><span class="bound"><span class="entity">nm_nds</span></span></span><span class="main">.</span> expand_rslt_exist_eq__node <span class="bound">n</span> <span class="bound">nd</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> expand_name_propag<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"expand_assm_incoming <span class="free">n_ns</span> <span class="main">∧</span> expand_name_ident <span class="main">(</span>snd <span class="free">n_ns</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">n_ns</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"expand <span class="free">n_ns</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> expand_rslt_incoming <span class="bound">r</span>
                                    <span class="main">∧</span> expand_rslt_name <span class="free">n_ns</span> <span class="bound">r</span>
                                    <span class="main">∧</span> expand_name_ident <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"expand <span class="main">_</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="free">n_ns</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> expand_rec_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Φ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="var">?Q</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 _ _ <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nds</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"upd_incoming <span class="skolem">n</span> <span class="skolem">ns</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">∈</span><span class="var">?nds</span><span class="main">.</span> name <span class="bound">q</span> <span class="main">&lt;</span> name <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> upd_incoming__ident<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">∈</span><span class="var">?nds</span><span class="main">.</span> <span class="main">∀</span><span class="bound">nm'</span><span class="main">∈</span>incoming <span class="bound">q</span><span class="main">.</span> <span class="bound">nm'</span> <span class="main">&lt;</span> name <span class="skolem">n</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">∈</span><span class="main">_</span><span class="main">.</span> <span class="var">?sg</span> <span class="bound">q</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> q_in<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">q</span><span class="main">∈</span><span class="var">?nds</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sg</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> upd_incoming__elem<span class="main">[</span><span class="operator">OF</span> q_in<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nd'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        nd'_def<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">nd'</span><span class="main">∈</span><span class="skolem">ns</span> <span class="main">∧</span> <span class="skolem">q</span> <span class="main">=</span> <span class="skolem">nd'</span><span class="main">⦇</span>incoming <span class="main">:=</span> incoming <span class="skolem">n</span> <span class="main">∪</span> incoming <span class="skolem">nd'</span><span class="main">⦈</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">nm'</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nm'</span><span class="main">∈</span>incoming <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nm'</span><span class="main">∈</span>incoming <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> Q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nm'</span> <span class="main">&lt;</span> name <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nm'</span><span class="main">∈</span>incoming <span class="skolem">nd'</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> Q nd'_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nm'</span> <span class="main">&lt;</span> name <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nm'</span> <span class="main">&lt;</span> name <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nd'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_name_ident <span class="var">?nds</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> upd_incoming__ident<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span>

      <span class="keyword1"><span class="command">with</span></span> Q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound"><span class="bound">q'</span></span><span class="main">∈</span><span class="skolem">ns</span><span class="main">.</span> name <span class="skolem">q</span> <span class="main">=</span> name <span class="bound">q'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">q</span> <span class="main">=</span> name <span class="skolem">q'</span>"</span></span>
                       <span class="keyword2"><span class="keyword">and</span></span> q'_all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q''</span><span class="main">∈</span><span class="skolem">ns</span><span class="main">.</span> name <span class="skolem">q'</span> <span class="main">=</span> name <span class="bound">q''</span> <span class="main">⟶</span> <span class="skolem">q'</span> <span class="main">=</span> <span class="bound">q''</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"upd_incoming_f <span class="skolem">n</span> <span class="skolem">q'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> P_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?q'</span><span class="main">∈</span><span class="var">?nds</span> <span class="main">∧</span> name <span class="skolem">q</span> <span class="main">=</span> name <span class="var">?q'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q'</span><span class="main">∈</span><span class="skolem">ns</span>›</span></span> <span class="quoted"><span class="quoted">‹name <span class="skolem">q</span> <span class="main">=</span> name <span class="skolem">q'</span>›</span></span> q'_all
        <span class="keyword1"><span class="command">unfolding</span></span> upd_incoming_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> P_all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q''</span><span class="main">∈</span><span class="var">?nds</span><span class="main">.</span> name <span class="var">?q'</span> <span class="main">=</span> name <span class="bound">q''</span> <span class="main">⟶</span> <span class="var">?q'</span> <span class="main">=</span> <span class="bound">q''</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q''</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q''</span><span class="main">∈</span><span class="var">?nds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> q''_name_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"name <span class="var">?q'</span> <span class="main">=</span> name <span class="skolem">q''</span>"</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q''</span><span class="main">∉</span><span class="skolem">ns</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> upd_incoming__elem<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">q''</span><span class="main">∈</span><span class="var">?nds</span>›</span></span><span class="main">]</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nd''</span></span> <span class="keyword2"><span class="keyword">where</span></span>
            <span class="quoted"><span class="quoted">"<span class="skolem">nd''</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> q''_is<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q''</span> <span class="main">=</span> <span class="skolem">nd''</span><span class="main">⦇</span>incoming <span class="main">:=</span> incoming <span class="skolem">n</span> <span class="main">∪</span> incoming <span class="skolem">nd''</span><span class="main">⦈</span>
                          <span class="main">∧</span> old <span class="skolem">nd''</span> <span class="main">=</span> old <span class="skolem">n</span> <span class="main">∧</span> next <span class="skolem">nd''</span> <span class="main">=</span> next <span class="skolem">n</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd''</span> <span class="main">=</span> name <span class="skolem">q'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> q''_name_eq
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"old <span class="skolem">q'</span> <span class="main">=</span> old <span class="skolem">n</span> <span class="main">∧</span> next <span class="skolem">q'</span> <span class="main">=</span> next <span class="skolem">n</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">nd''</span><span class="main">∈</span><span class="skolem">ns</span>›</span></span> q'_all <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd''</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?q'</span> <span class="main">=</span> <span class="skolem">q''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q''_is <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q''</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">q'</span> <span class="main">=</span> name <span class="skolem">q''</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> q''_name_eq
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"old <span class="skolem">q'</span> <span class="main">=</span> old <span class="skolem">n</span> <span class="main">∧</span> next <span class="skolem">q'</span> <span class="main">=</span> next <span class="skolem">n</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"incoming <span class="skolem">n</span> <span class="main">⊆</span> incoming <span class="skolem">q''</span>
            <span class="main">⟹</span> incoming <span class="skolem">q''</span> <span class="main">=</span> incoming <span class="skolem">n</span> <span class="main">∪</span> incoming <span class="skolem">q''</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?q'</span> <span class="main">=</span> <span class="skolem">q''</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> upd_incoming__ident_node<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">q''</span><span class="main">∈</span><span class="var">?nds</span>›</span></span><span class="main">]</span> q'_all
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?q'</span> <span class="main">=</span> <span class="skolem">q''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound"><span class="bound">q'</span></span><span class="main">∈</span>upd_incoming <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">.</span> name <span class="skolem">q</span> <span class="main">=</span> name <span class="bound">q'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ex1I<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var">?q'</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> P_a <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> P_all <span class="keyword1"><span class="command">unfolding</span></span> P_a<span class="main">[</span><span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">THEN</span> sym<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">with</span></span> expand_new_name_step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Q
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order_less_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems'<span class="main">:</span> <span class="main">(</span>2 _ <span class="skolem">nds</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"name <span class="main">`</span> <span class="skolem">ns</span> <span class="main">⊆</span> name <span class="main">`</span> <span class="skolem">nds</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> expand_new_name_step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> prems' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>4 <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>5 <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 6
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>7 <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>8 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> goal_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> new <span class="skolem">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ν</span> <span class="bound">μ</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> goal_assms Q
    <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_nested2<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">nm</span> <span class="skolem">nds</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> P_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">nm</span> <span class="main">∧</span> name <span class="main">`</span> <span class="skolem">ns</span> <span class="main">⊆</span> name <span class="main">`</span> <span class="skolem">nds</span><span class="main">)</span>
      <span class="main">∧</span> name <span class="main">`</span> <span class="skolem">nds</span> <span class="main">=</span> name <span class="main">`</span> <span class="skolem">ns</span> <span class="main">∪</span> name <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">nd</span></span><span class="main">∈</span><span class="skolem">nds</span><span class="main">.</span> name <span class="bound">nd</span> <span class="main">≥</span> name <span class="skolem">n</span><span class="main">}</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∧</span> <span class="var">?nodes_eq</span> <span class="skolem">nds</span> <span class="skolem">ns</span> <span class="main">(</span>name <span class="skolem">n</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> prems'<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">nm'</span> <span class="skolem">nds'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">∈</span><span class="skolem">nds'</span><span class="main">.</span> name <span class="bound">q</span> <span class="main">&lt;</span> <span class="skolem">nm'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">nm''</span><span class="main">∈</span>incoming <span class="bound">q</span><span class="main">.</span> <span class="bound">nm''</span> <span class="main">&lt;</span> <span class="skolem">nm'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nodes_eq</span> <span class="skolem">nds</span> <span class="skolem">ns</span> <span class="main">(</span>name <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nodes_eq</span> <span class="skolem">nds'</span> <span class="skolem">nds</span> <span class="skolem">nm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">nm</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prems' P_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nodes_eq</span> <span class="skolem">nds'</span> <span class="skolem">ns</span> <span class="main">(</span>name <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_rslt_name <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nm'</span><span class="main">,</span> <span class="skolem">nds'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prems' P_x subset_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"name <span class="main">`</span> <span class="skolem">ns</span>"</span></span> <span class="quoted"><span class="quoted">"name <span class="main">`</span> <span class="skolem">nds</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> prems' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> expand_name_propag__incoming <span class="main">=</span> SPEC_rule_conjunct1<span class="main">[</span><span class="operator">OF</span> expand_name_propag<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> expand_name_propag__name <span class="main">=</span>
  SPEC_rule_conjunct1<span class="main">[</span><span class="operator">OF</span> SPEC_rule_conjunct2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> expand_name_propag<span class="main"><span class="main">]</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> expand_name_propag__name_ident <span class="main">=</span>
  SPEC_rule_conjunct2<span class="main">[</span><span class="operator">OF</span> SPEC_rule_conjunct2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> expand_name_propag<span class="main"><span class="main">]</span></span><span class="main">]</span>


<span class="keyword1"><span class="command">lemma</span></span> expand_rslt_exist_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"expand <span class="free">n_ns</span> <span class="main">≤</span> SPEC <span class="main">(</span>expand_rslt_exist_eq <span class="free">n_ns</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="free">n_ns</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> expand_rec_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Φ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="skolem">n</span><span class="main">,</span> upd_incoming <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_rslt_exist_eq <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="var">?r</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> snd_conv
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"old <span class="skolem">n'</span> <span class="main">=</span> old <span class="skolem">n</span> <span class="main">∧</span> next <span class="skolem">n'</span> <span class="main">=</span> next <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span><span class="main">∈</span><span class="skolem">ns</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span><span class="main">⦇</span> incoming <span class="main">:=</span> incoming <span class="skolem">n</span> <span class="main">∪</span> incoming <span class="skolem">n'</span> <span class="main">⦈</span> <span class="main">∈</span> upd_incoming <span class="skolem">n</span> <span class="skolem">ns</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> upd_incoming_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>old <span class="skolem">n'</span> <span class="main">=</span> old <span class="skolem">n</span> <span class="main">∧</span> next <span class="skolem">n'</span> <span class="main">=</span> next <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span><span class="main">∈</span><span class="skolem">ns</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">∈</span> upd_incoming <span class="skolem">n</span> <span class="skolem">ns</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> upd_incoming_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">nd</span><span class="main">∈</span>upd_incoming <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">.</span> expand_rslt_exist_eq__node <span class="skolem">n'</span> <span class="bound">nd</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>4 <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>5 <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 6 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>7 <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>8 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_nested2<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">nm</span> <span class="skolem">nds</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span> P_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nm</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> prems'<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">nm'</span> <span class="skolem">nds'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n'</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> P_x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nd</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">nds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n'_split<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_rslt_exist_eq__node <span class="skolem">n'</span> <span class="skolem">nd</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> prems' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nd'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span><span class="main">∈</span><span class="skolem">nds'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"expand_rslt_exist_eq__node <span class="skolem">nd</span> <span class="skolem">nd'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">nd'</span><span class="main">∈</span><span class="skolem">nds'</span><span class="main">.</span> expand_rslt_exist_eq__node <span class="skolem">n'</span> <span class="bound">nd'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> n'_split subset_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"incoming <span class="skolem">n'</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_rslt_exist_eq <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nm'</span><span class="main">,</span> <span class="skolem">nds'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> expand_prop_exist<span class="main">:</span>
  <span class="quoted"><span class="quoted">"expand <span class="free">n_ns</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> expand_assm_exist <span class="free">ξ</span> <span class="free">n_ns</span> <span class="main">⟶</span> expand_rslt_exist <span class="free">ξ</span> <span class="free">n_ns</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="free">n_ns</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> expand_rec_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Φ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nds</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"upd_incoming <span class="skolem">n</span> <span class="skolem">ns</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="skolem">n</span><span class="main">,</span> <span class="var">?nds</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_assm_exist <span class="free">ξ</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">n'</span><span class="main">∈</span><span class="skolem">ns</span><span class="main">.</span> old <span class="bound">n'</span> <span class="main">=</span> old <span class="skolem">n</span> <span class="main">∧</span> next <span class="bound">n'</span> <span class="main">=</span> next <span class="skolem">n</span>›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> assm_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"old <span class="skolem">n'</span> <span class="main">=</span> old <span class="skolem">n</span> <span class="main">∧</span> next <span class="skolem">n'</span> <span class="main">=</span> next <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span><span class="main">⦇</span> incoming <span class="main">:=</span> incoming <span class="skolem">n</span> <span class="main">∪</span> incoming <span class="skolem">n'</span><span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nd</span> <span class="main">∈</span> <span class="var">?nds</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span><span class="main">∈</span><span class="skolem">ns</span>›</span></span> assm_eq <span class="keyword1"><span class="command">unfolding</span></span> upd_incoming_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"incoming <span class="skolem">n</span> <span class="main">⊆</span> incoming <span class="var">?nd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_rslt_exist__node_prop <span class="free">ξ</span> <span class="skolem">n</span> <span class="var">?nd</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Q assm_eq <span class="quoted"><span class="quoted">‹new <span class="skolem">n</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_rslt_exist <span class="free">ξ</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="var">?r</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> fst_conv snd_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> f_sup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> expand <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_weak<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"expand_rslt_exist_eq"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> f_sup<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> expand_rslt_exist_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems'<span class="main">:</span> <span class="main">(</span>3 <span class="skolem">nm</span> <span class="skolem">nds</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"name <span class="main">`</span> <span class="skolem">ns</span> <span class="main">⊆</span> name <span class="main">`</span> <span class="skolem">nds</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> assm_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_assm_exist <span class="free">ξ</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> prems' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nd</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">nds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"expand_rslt_exist_eq__node <span class="skolem">n</span> <span class="skolem">nd</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_rslt_exist__node_prop <span class="free">ξ</span> <span class="skolem">n</span> <span class="skolem">nd</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> assm_ex <span class="quoted"><span class="quoted">‹new <span class="skolem">n</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_rslt_exist <span class="free">ξ</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nm</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">nds</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> expand_new_name_step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> prems' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>3 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"expand_assm_exist <span class="free">ξ</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> not<span class="hidden">⇩</span><sub>r</sub> <span class="skolem">ψ</span>"</span></span>  
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> fstI node.select_convs<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> node.surjective node.update_convs<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>4 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> goal_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> new <span class="skolem">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">prop<span class="hidden">⇩</span><sub>r</sub>(</span><span class="bound">q</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">nprop<span class="hidden">⇩</span><sub>r</sub>(</span><span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> goal_assms <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> prems'<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">nm</span> <span class="skolem">nds</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"expand_assm_exist <span class="free">ξ</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> prems' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_rslt_exist <span class="free">ξ</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nm</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>5 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> goal_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> new <span class="skolem">n</span> <span class="main">∧</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">true<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> goal_assms <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> prems'<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">nm</span> <span class="skolem">nds</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"expand_assm_exist <span class="free">ξ</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> prems' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_rslt_exist <span class="free">ξ</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nm</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>6 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"expand_assm_exist <span class="free">ξ</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="keyword1">false<span class="hidden">⇩</span><sub>r</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>7 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> goal_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> new <span class="skolem">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ν</span> <span class="bound">μ</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ν</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> goal_assms <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> prems'<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">nm</span> <span class="skolem">nds</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"expand_assm_exist <span class="free">ξ</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> prems' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_rslt_exist <span class="free">ξ</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nm</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>8 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> goal_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> new <span class="skolem">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ν</span> <span class="bound">μ</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> f_sup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> expand <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">,</span> new <span class="main">:=</span> new1 <span class="skolem">ψ</span> <span class="main">∪</span> new <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span><span class="main">,</span>
                old <span class="main">:=</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span> <span class="main">∪</span> old <span class="skolem">n</span><span class="main">,</span> next <span class="main">:=</span> next1 <span class="skolem">ψ</span> <span class="main">∪</span> next <span class="skolem">n</span><span class="main">⦈</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?new1_assm_sel</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ψ</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">ψ</span> <span class="keyword1">of</span> <span class="bound">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">η</span> <span class="main">=&gt;</span> <span class="bound">η</span> <span class="main">|</span> <span class="bound">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">η</span> <span class="main">⇒</span> <span class="bound">μ</span> <span class="main">|</span> <span class="bound">μ</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">η</span> <span class="main">⇒</span> <span class="bound">η</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> new1_assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">(</span><span class="var">?new1_assm_sel</span> <span class="skolem">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> goal_assms <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_nested2<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> prems'<span class="main">:</span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> prems''<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">nm</span> <span class="skolem">nds</span><span class="main">)</span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"expand_assm_exist <span class="free">ξ</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> prems'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_assm_exist <span class="free">ξ</span> <span class="var">?x1</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> fst_conv
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> ψ<span class="main">:</span> <span class="main">(</span>8 <span class="skolem">μ</span> <span class="skolem">η</span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">μ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">(</span><span class="skolem">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> ψ ltlr_expand_Until<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ξ</span></span> <span class="quoted"><span class="skolem">μ</span></span> <span class="quoted"><span class="skolem">η</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> ψ <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> ψ<span class="main">:</span> <span class="main">(</span>9 <span class="skolem">μ</span> <span class="skolem">η</span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
            <span class="keyword1"><span class="command">with</span></span> ψ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">(</span><span class="skolem">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> ltlr_expand_Release<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ξ</span></span> <span class="quoted"><span class="skolem">μ</span></span> <span class="quoted"><span class="skolem">η</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> ψ * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> prems'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_rslt_exist <span class="free">ξ</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nm</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">with</span></span> prems'' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> prems'<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">nm</span> <span class="skolem">nds</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> P_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nm</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_weak<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"expand_rslt_exist_eq"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">rule_tac</span> f_sup<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">rule_tac</span> expand_rslt_exist_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> prems''<span class="main">:</span> <span class="main">(</span>3 <span class="skolem">nm'</span> <span class="skolem">nds'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"expand_assm_exist <span class="free">ξ</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> P_x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_rslt_exist <span class="free">ξ</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nm</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nd</span></span> <span class="keyword2"><span class="keyword">where</span></span> nd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">nds</span>"</span></span> <span class="quoted"><span class="quoted">"expand_rslt_exist__node_prop <span class="free">ξ</span> <span class="skolem">n</span> <span class="skolem">nd</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> goal_assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> prems'' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nd'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
            <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span><span class="main">∈</span><span class="skolem">nds'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"expand_rslt_exist_eq__node <span class="skolem">nd</span> <span class="skolem">nd'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">with</span></span> nd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_rslt_exist__node_prop <span class="free">ξ</span> <span class="skolem">n</span> <span class="skolem">nd'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> subset_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"incoming <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"incoming <span class="skolem">nd</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_rslt_exist <span class="free">ξ</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span><span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nm'</span><span class="main">,</span> <span class="skolem">nds'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">nd'</span><span class="main">∈</span><span class="skolem">nds'</span>›</span></span> goal_assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> new1_assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">(</span><span class="var">?new1_assm_sel</span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x2f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">nm</span><span class="main">::</span>node_name<span class="main">,</span> <span class="bound">nds</span><span class="main">::</span><span class="tfree">'a</span> node set<span class="main">)</span><span class="main">.</span> <span class="main">(</span>
        <span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">,</span>
          name <span class="main">:=</span> <span class="bound">nm</span><span class="main">,</span>
          new <span class="main">:=</span> new2 <span class="skolem">ψ</span> <span class="main">∪</span> new <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span><span class="main">,</span>
          old <span class="main">:=</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span> <span class="main">∪</span> old <span class="skolem">n</span><span class="main">⦈</span><span class="main">,</span>
        <span class="bound">nds</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> P_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="var">?x1</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="var">?x1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> step<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"node_name <span class="main">×</span> <span class="tfree">'a</span> node set"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?x2f</span> <span class="skolem">r</span>"</span></span>

      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?P</span> <span class="var">?x1</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="var">?x2</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold fst_conv
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> prems'<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">nm'</span> <span class="skolem">nds'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"expand_assm_exist <span class="free">ξ</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> new1_assm goal_assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_assm_exist <span class="free">ξ</span> <span class="var">?x2</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> prems''<span class="main">:</span> <span class="main">(</span>9 _ _ <span class="skolem">μ</span> <span class="skolem">η</span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fst_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
            <span class="keyword1"><span class="command">with</span></span> ltlr_expand_Release<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ξ</span></span> <span class="quoted"><span class="skolem">μ</span></span> <span class="quoted"><span class="skolem">η</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> prems'' * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> prems' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_rslt_exist <span class="free">ξ</span> <span class="var">?x2</span> <span class="main">(</span><span class="skolem">nm'</span><span class="main">,</span> <span class="skolem">nds'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold fst_conv snd_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_rslt_exist <span class="free">ξ</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nm'</span><span class="main">,</span> <span class="skolem">nds'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SPEC <span class="main">(</span><span class="var">?P</span> <span class="var">?x1</span><span class="main">)</span>
      <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">r</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">nm</span><span class="main">,</span> <span class="bound">nds</span><span class="main">)</span> <span class="main">=&gt;</span>
          <span class="skolem">f</span> <span class="main">(</span><span class="var">?x2f</span> <span class="main">(</span><span class="bound">nm</span><span class="main">,</span> <span class="bound">nds</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> goal_assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule<span class="main">)</span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Termination proof›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">expand<span class="hidden">⇩</span><sub>T</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> node <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> node set<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>node_name <span class="main">×</span> <span class="tfree">'a</span> node set<span class="main">)</span> nres"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">expand<span class="hidden">⇩</span><sub>T</sub></span> <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span> <span class="main">≡</span> <span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span> expand_body <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">old_next_pair</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="main">(</span>old <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> next <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">old_next_limit</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> Pow <span class="main">(</span>subfrmlsr <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">×</span> Pow <span class="main">(</span>subfrmlsr <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> old_next_limit_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>old_next_limit <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> subfrmlsr_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">expand_ord</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span>
     inv_image <span class="main">(</span>finite_psupset <span class="main">(</span>old_next_limit <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="keyword1">&lt;*lex*&gt;</span> less_than<span class="main">)</span>
               <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">ns</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>old_next_pair <span class="main">`</span> <span class="bound">ns</span><span class="main">,</span> size_set <span class="main">(</span>new <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> expand_ord_wf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>expand_ord <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_psupset_wf<span class="main">[</span><span class="operator">OF</span> old_next_limit_finite<span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> expand_ord_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">expand_inv_node</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>
  <span class="main">≡</span> finite <span class="main">(</span>new <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>old <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>next <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span>new <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>old <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>next <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">⊆</span> subfrmlsr <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">expand_inv_result</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">≡</span> finite <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n'</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">.</span> <span class="main">(</span>new <span class="bound">n'</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>old <span class="bound">n'</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>next <span class="bound">n'</span><span class="main">)</span> <span class="main">⊆</span> subfrmlsr <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">expand_inv</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">ns</span><span class="main">)</span> <span class="main">⇒</span> expand_inv_node <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">n</span> <span class="main">∧</span> expand_inv_result <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">ns</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> new1_less_sum<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"size_set <span class="main">(</span>new1 <span class="free">φ</span><span class="main">)</span> <span class="main">&lt;</span> size_set <span class="main">{</span><span class="free">φ</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_ltlr <span class="skolem">ν</span> <span class="skolem">μ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ν</span> <span class="main">=</span> <span class="skolem">μ</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> new2_less_sum<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"size_set <span class="main">(</span>new2 <span class="free">φ</span><span class="main">)</span> <span class="main">&lt;</span> size_set <span class="main">{</span><span class="free">φ</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Release_ltlr <span class="skolem">ν</span> <span class="skolem">μ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ν</span> <span class="main">=</span> <span class="skolem">μ</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> new1_finite<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>new1 <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ψ</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> new1_subset_frmls<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">∈</span> new1 <span class="free">ψ</span> <span class="main">⟹</span> <span class="free">φ</span> <span class="main">∈</span> subfrmlsr <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ψ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> new2_finite<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>new2 <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ψ</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> new2_subset_frmls<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">∈</span> new2 <span class="free">ψ</span> <span class="main">⟹</span> <span class="free">φ</span> <span class="main">∈</span> subfrmlsr <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ψ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> next1_finite<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>next1 <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ψ</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> next1_subset_frmls<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">∈</span> next1 <span class="free">ψ</span> <span class="main">⟹</span> <span class="free">φ</span> <span class="main">∈</span> subfrmlsr <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ψ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> expand_inv_impl<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"expand_inv <span class="free">φ</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">ns</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> newn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> new <span class="free">n</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"old_next_pair <span class="main">`</span> <span class="free">ns</span> <span class="main">⊆</span> old_next_pair <span class="main">`</span> <span class="free">ns'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"expand_inv_result <span class="free">φ</span> <span class="free">ns'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n'</span> <span class="main">=</span> <span class="free">n</span><span class="main">⦇</span> new <span class="main">:=</span> new <span class="free">n</span> <span class="main">-</span> <span class="main">{</span><span class="free">ψ</span><span class="main">}</span><span class="main">,</span> 
                    old <span class="main">:=</span> <span class="main">{</span><span class="free">ψ</span><span class="main">}</span> <span class="main">∪</span> old <span class="free">n</span> <span class="main">⦈</span><span class="main">)</span> <span class="main">∨</span>
           <span class="main">(</span><span class="free">n'</span> <span class="main">=</span> <span class="free">n</span><span class="main">⦇</span> new <span class="main">:=</span> new1 <span class="free">ψ</span> <span class="main">∪</span> <span class="main">(</span>new <span class="free">n</span> <span class="main">-</span> <span class="main">{</span><span class="free">ψ</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>
                    old <span class="main">:=</span> <span class="main">{</span><span class="free">ψ</span><span class="main">}</span> <span class="main">∪</span> old <span class="free">n</span><span class="main">,</span>
                    next <span class="main">:=</span> next1 <span class="free">ψ</span> <span class="main">∪</span> next <span class="free">n</span> <span class="main">⦈</span><span class="main">)</span> <span class="main">∨</span>
           <span class="main">(</span><span class="free">n'</span> <span class="main">=</span> <span class="free">n</span><span class="main">⦇</span> name <span class="main">:=</span> <span class="free">nm</span><span class="main">,</span> 
                    new <span class="main">:=</span> new2 <span class="free">ψ</span> <span class="main">∪</span> <span class="main">(</span>new <span class="free">n</span> <span class="main">-</span> <span class="main">{</span><span class="free">ψ</span><span class="main">}</span><span class="main">)</span><span class="main">,</span> 
                    old <span class="main">:=</span> <span class="main">{</span><span class="free">ψ</span><span class="main">}</span> <span class="main">∪</span> old <span class="free">n</span> <span class="main">⦈</span><span class="main">)</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?case1</span> <span class="main">∨</span> <span class="var">?case2</span> <span class="main">∨</span> <span class="var">?case3</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">n'</span><span class="main">,</span> <span class="free">ns'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">ns</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>expand_ord <span class="free">φ</span> <span class="main">∧</span> expand_inv <span class="free">φ</span> <span class="main">(</span><span class="free">n'</span><span class="main">,</span> <span class="free">ns'</span><span class="main">)</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?concl1</span> <span class="main">∧</span> <span class="var">?concl2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">consider</span></span> <span class="var"><span class="quoted"><span class="var">?case1</span></span></span> <span class="main">|</span> <span class="var"><span class="quoted"><span class="var">?case2</span></span></span> <span class="main">|</span> <span class="var"><span class="quoted"><span class="var">?case3</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?concl1</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> n'def<span class="main">:</span> 1
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> expand_ord_def expand_inv_def finite_psupset_def 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"old_next_pair <span class="main">`</span> <span class="free">ns</span> <span class="main">⊂</span> old_next_pair <span class="main">`</span> <span class="free">ns'</span>"</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add_Suc diff_Suc_less psubsetI sum.remove sum_diff1_nat zero_less_Suc<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> n'def<span class="main">:</span> 2
    <span class="keyword1"><span class="command">have</span></span> ψinnew<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> new <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fin_new<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>new <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> expand_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size_set <span class="main">(</span>new <span class="free">n</span> <span class="main">-</span> <span class="main">{</span><span class="free">ψ</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> size_set <span class="main">(</span>new <span class="free">n</span><span class="main">)</span> <span class="main">-</span> size_set <span class="main">{</span><span class="free">ψ</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> size_set_diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> fin_new sum_Un_nat<span class="main">[</span><span class="operator">OF</span> new1_finite _<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"new <span class="free">n</span> <span class="main">-</span> <span class="main">{</span><span class="free">ψ</span><span class="main">}</span>"</span></span> <span class="quoted">size</span> <span class="quoted"><span class="free">ψ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size_set <span class="main">(</span>new <span class="free">n'</span><span class="main">)</span> <span class="main">≤</span> size_set <span class="main">(</span>new1 <span class="free">ψ</span><span class="main">)</span> <span class="main">+</span> size_set <span class="main">(</span>new <span class="free">n</span> <span class="main">-</span> <span class="main">{</span><span class="free">ψ</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> n'def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new1_finite sum_Un_nat<span class="main">)</span> 
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">have</span></span> sum_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"size_set <span class="main">(</span>new <span class="free">n</span><span class="main">)</span> <span class="main">≥</span> size_set <span class="main">{</span><span class="free">ψ</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ψinnew sum_mono2<span class="main">[</span><span class="operator">OF</span> fin_new<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">ψ</span><span class="main">}</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size_set <span class="main">(</span>new <span class="free">n'</span><span class="main">)</span> <span class="main">&lt;</span> size_set <span class="main">(</span>new <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> new1_less_sum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ψ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> expand_ord_def finite_psupset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> n'def<span class="main">:</span> 3
    <span class="keyword1"><span class="command">have</span></span> ψinnew<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> new <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fin_new<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>new <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> expand_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> ψinnew sum_diff1_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted">size</span> <span class="quoted"><span class="quoted">"new <span class="free">n</span>"</span></span> <span class="quoted"><span class="free">ψ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size_set <span class="main">(</span>new <span class="free">n</span> <span class="main">-</span> <span class="main">{</span><span class="free">ψ</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> size_set <span class="main">(</span>new <span class="free">n</span><span class="main">)</span> <span class="main">-</span> size_set <span class="main">{</span><span class="free">ψ</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> size_set_diff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"new <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">ψ</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> fin_new sum_Un_nat<span class="main">[</span><span class="operator">OF</span> new2_finite _<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"new <span class="free">n</span> <span class="main">-</span> <span class="main">{</span><span class="free">ψ</span><span class="main">}</span>"</span></span> <span class="quoted">size</span> <span class="quoted"><span class="free">ψ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size_set <span class="main">(</span>new <span class="free">n'</span><span class="main">)</span> <span class="main">≤</span> size_set <span class="main">(</span>new2 <span class="free">ψ</span><span class="main">)</span> <span class="main">+</span> size_set <span class="main">(</span>new <span class="free">n</span> <span class="main">-</span> <span class="main">{</span><span class="free">ψ</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> n'def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new2_finite sum_Un_nat<span class="main">)</span> 
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">have</span></span> sum_leq<span class="main">:</span><span class="quoted"><span class="quoted">"size_set <span class="main">(</span>new <span class="free">n</span><span class="main">)</span> <span class="main">≥</span>  size_set <span class="main">{</span><span class="free">ψ</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ψinnew sum_mono2<span class="main">[</span><span class="operator">OF</span> fin_new<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">ψ</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size_set <span class="main">(</span>new <span class="free">n'</span><span class="main">)</span> <span class="main">&lt;</span> size_set <span class="main">(</span>new <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> new2_less_sum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ψ</span></span><span class="main">]</span> sum_leq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> expand_ord_def finite_psupset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"new1 <span class="free">ψ</span> <span class="main">⊆</span> subfrmlsr <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"new2 <span class="free">ψ</span> <span class="main">⊆</span> subfrmlsr <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"next1 <span class="free">ψ</span> <span class="main">⊆</span> subfrmlsr <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms subfrmlsr_subset<span class="main">[</span><span class="operator">OF</span> new1_subset_frmls<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">ψ</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      subfrmlsr_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ψ</span></span> <span class="quoted"><span class="free">φ</span></span><span class="main">,</span> <span class="operator">OF</span> rev_subsetD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"new <span class="free">n</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      subfrmlsr_subset<span class="main">[</span><span class="operator">OF</span> new2_subset_frmls<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">ψ</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      subfrmlsr_subset<span class="main">[</span><span class="operator">OF</span> next1_subset_frmls<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">ψ</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> expand_inv_def
    <span class="comment1">(* This proof is merely a speed optimization. A single force+ does the job,
       but takes very long *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> in_mono new1_subset_frmls<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> new2_subset_frmls rev_subsetD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> in_mono next1_subset_frmls<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?concl2</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> expand_inv_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> expand_term_prop_help<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">n'</span><span class="main">,</span> <span class="free">ns'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">ns</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>expand_ord <span class="free">φ</span> <span class="main">∧</span> expand_inv <span class="free">φ</span> <span class="main">(</span><span class="free">n'</span><span class="main">,</span> <span class="free">ns'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> assm_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>expand_inv <span class="free">φ</span> <span class="main">(</span><span class="free">n'</span><span class="main">,</span> <span class="free">ns'</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="free">n'</span><span class="main">,</span> <span class="free">ns'</span><span class="main">)</span><span class="main">,</span> <span class="free">n</span><span class="main">,</span> <span class="free">ns</span><span class="main">)</span> <span class="main">∈</span> expand_ord <span class="free">φ</span><span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="free">n'</span><span class="main">,</span> <span class="free">ns'</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">n'</span><span class="main">,</span> <span class="free">ns'</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> assm_rule<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> expand_inv_upd_incoming<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"expand_inv <span class="free">φ</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">ns</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"expand_inv_result <span class="free">φ</span> <span class="main">(</span>upd_incoming <span class="free">n</span> <span class="free">ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> expand_inv_def upd_incoming_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>


<span class="keyword1"><span class="command">lemma</span></span> upd_incoming_eq_old_next_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"old_next_pair <span class="main">`</span> <span class="free">ns</span> <span class="main">=</span> old_next_pair <span class="main">`</span> <span class="main">(</span>upd_incoming <span class="free">n</span> <span class="free">ns</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⊆</span> <span class="var">?B</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n'</span><span class="main">.</span> <span class="bound">n'</span><span class="main">⦇</span>incoming <span class="main">:=</span> incoming <span class="free">n</span> <span class="main">∪</span> incoming <span class="bound">n'</span><span class="main">⦈</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">∈</span> <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xeq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span>old <span class="skolem">n'</span><span class="main">,</span> next <span class="skolem">n'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span>old_next_pair <span class="main">`</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n'</span><span class="main">.</span> <span class="bound">n'</span><span class="main">⦇</span>incoming <span class="main">:=</span> incoming <span class="free">n</span> <span class="main">∪</span> incoming <span class="bound">n'</span><span class="main">⦈</span><span class="main">)</span>
             <span class="main">`</span> <span class="main">(</span><span class="free">ns</span> <span class="main">∩</span> <span class="main">{</span><span class="bound"><span class="bound">n'</span></span> <span class="main">∈</span> <span class="free">ns</span><span class="main">.</span> old <span class="bound">n'</span> <span class="main">=</span> old <span class="free">n</span> <span class="main">∧</span> next <span class="bound">n'</span> <span class="main">=</span> next <span class="free">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
          <span class="main">∪</span> <span class="main">(</span>old_next_pair <span class="main">`</span> <span class="main">(</span><span class="free">ns</span> <span class="main">∩</span> <span class="main">{</span><span class="bound"><span class="bound">n'</span></span> <span class="main">∈</span> <span class="free">ns</span><span class="main">.</span> old <span class="bound">n'</span> <span class="main">≠</span> old <span class="free">n</span> <span class="main">∨</span> next <span class="bound">n'</span> <span class="main">≠</span> next <span class="free">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"old <span class="skolem">n'</span> <span class="main">=</span> old <span class="free">n</span> <span class="main">∧</span> next <span class="skolem">n'</span> <span class="main">=</span> next <span class="free">n</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">∈</span> <span class="free">ns</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">n'</span> <span class="main">∈</span> <span class="var">?f</span> <span class="main">`</span> <span class="main">(</span><span class="free">ns</span> <span class="main">∩</span> <span class="main">{</span><span class="bound"><span class="bound">n'</span></span><span class="main">∈</span><span class="free">ns</span><span class="main">.</span> old <span class="bound">n'</span> <span class="main">=</span> old <span class="free">n</span> <span class="main">∧</span> next <span class="bound">n'</span> <span class="main">=</span> next <span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∈</span> <span class="var">?C</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"old_next_pair <span class="main">(</span><span class="var">?f</span> <span class="skolem">n'</span><span class="main">)</span> <span class="main">∈</span> old_next_pair <span class="main">`</span> <span class="var">?C</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> imageI<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> xeq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>old_next_pair <span class="main">`</span> <span class="var">?C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">∈</span> <span class="free">ns</span>›</span></span> xeq
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> old_next_pair <span class="main">`</span> <span class="main">(</span><span class="free">ns</span> <span class="main">∩</span> <span class="main">{</span><span class="bound"><span class="bound">n'</span></span><span class="main">∈</span><span class="free">ns</span><span class="main">.</span> old <span class="bound">n'</span> <span class="main">≠</span> old <span class="free">n</span> <span class="main">∨</span> next <span class="bound">n'</span> <span class="main">≠</span> next <span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> upd_incoming_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">⊆</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> upd_incoming_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>imageI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> expand_term_prop<span class="main">:</span>
  <span class="quoted"><span class="quoted">"expand_inv <span class="free">φ</span> <span class="free">n_ns</span> <span class="main">⟹</span>
    expand<span class="hidden">⇩</span><sub>T</sub> <span class="free">n_ns</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">nds</span><span class="main">)</span><span class="main">.</span> old_next_pair <span class="main">`</span> snd <span class="free">n_ns</span><span class="main">⊆</span>old_next_pair <span class="main">`</span><span class="bound">nds</span>
    <span class="main">∧</span> expand_inv_result <span class="free">φ</span> <span class="bound">nds</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="free">n_ns</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> expand<span class="hidden">⇩</span><sub>T</sub>_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> RECT_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pre<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">ns</span><span class="main">)</span><span class="main">.</span> expand_inv <span class="free">φ</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">ns</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> V<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"expand_ord <span class="free">φ</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_mono</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 _ _ <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"old_next_pair <span class="main">`</span> <span class="skolem">ns</span> <span class="main">⊆</span> old_next_pair <span class="main">`</span> <span class="main">(</span>upd_incoming <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> equalityD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> upd_incoming_eq_old_next_pair<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> expand_inv_upd_incoming<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">ns</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">expand</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⦇</span>
    name <span class="main">=</span> expand_new_name <span class="main">(</span>name <span class="skolem">n</span><span class="main">)</span><span class="main">,</span>
    incoming <span class="main">=</span> <span class="main">{</span>name <span class="skolem">n</span><span class="main">}</span><span class="main">,</span>
    new <span class="main">=</span> next <span class="skolem">n</span><span class="main">,</span>
    old <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
    next <span class="main">=</span> <span class="main">{}</span><span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ns'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">n</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">ns</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> SPEC_sub<span class="main">:</span><span class="quoted"><span class="quoted">"SPEC <span class="main">(</span><span class="var">?P</span> <span class="main">(</span><span class="var">?n'</span><span class="main">,</span> <span class="var">?ns'</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"old_next_pair <span class="skolem">n</span> <span class="main">∉</span> old_next_pair <span class="main">`</span> <span class="skolem">ns</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"old_next_pair <span class="main">`</span> <span class="skolem">ns</span> <span class="main">⊂</span> old_next_pair <span class="main">`</span> <span class="main">(</span>insert <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_inv <span class="free">φ</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?n'</span><span class="main">,</span> <span class="var">?ns'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> expand_ord <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expand_ord_def finite_psupset_def expand_inv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_inv <span class="free">φ</span> <span class="main">(</span><span class="var">?n'</span><span class="main">,</span> <span class="var">?ns'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> expand_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">expand</span> <span class="main">(</span><span class="var">?n'</span><span class="main">,</span> <span class="var">?ns'</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="main">(</span><span class="var">?n'</span><span class="main">,</span> <span class="var">?ns'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> SPEC_sub <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> order_trans<span class="main">)</span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>expand_inv_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> expand_term_prop_help<span class="main"><span class="main">[</span></span><span class="operator">OF</span> expand_inv_impl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expand_inv_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 5
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> expand_term_prop_help<span class="main"><span class="main">[</span></span><span class="operator">OF</span> expand_inv_impl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expand_inv_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 6
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expand_inv_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 7
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> expand_term_prop_help<span class="main"><span class="main">[</span></span><span class="operator">OF</span> expand_inv_impl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expand_inv_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>8 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">xa</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">⦇</span>
    new <span class="main">:=</span> new1 <span class="skolem">xa</span> <span class="main">∪</span> <span class="main">(</span>new <span class="skolem">a</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">xa</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>
    old <span class="main">:=</span> insert <span class="skolem">xa</span> <span class="main">(</span>old <span class="skolem">a</span><span class="main">)</span><span class="main">,</span>
    next <span class="main">:=</span> next1 <span class="skolem">xa</span> <span class="main">∪</span> next <span class="skolem">a</span><span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">nm</span><span class="main">.</span> <span class="skolem">a</span><span class="main">⦇</span>
    name <span class="main">:=</span> <span class="bound">nm</span><span class="main">,</span>
    new <span class="main">:=</span> new2 <span class="skolem">xa</span> <span class="main">∪</span> <span class="main">(</span>new <span class="skolem">a</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">xa</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>
    old <span class="main">:=</span> insert <span class="skolem">xa</span> <span class="main">(</span>old <span class="skolem">a</span><span class="main">)</span><span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?n'</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> expand_ord <span class="free">φ</span> <span class="main">∧</span> expand_inv <span class="free">φ</span> <span class="main">(</span><span class="var">?n'</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> expand_inv_impl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expand_inv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span> assm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span><span class="var">?n'</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">nm</span><span class="main">::</span><span class="quoted">node_name</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">nds</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> node set"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assm1<span class="main">:</span> <span class="quoted"><span class="quoted">"old_next_pair <span class="main">`</span> <span class="skolem">b</span> <span class="main">⊆</span> old_next_pair <span class="main">`</span> <span class="skolem">nds</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> assm2<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_inv_result <span class="free">φ</span> <span class="skolem">nds</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> prems step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?n''</span> <span class="skolem">nm</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> expand_ord <span class="free">φ</span> <span class="main">∧</span> expand_inv <span class="free">φ</span> <span class="main">(</span><span class="var">?n''</span> <span class="skolem">nm</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> expand_inv_impl<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span><span class="var">?n''</span> <span class="skolem">nm</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="main">(</span><span class="var">?n''</span> <span class="skolem">nm</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SPEC <span class="main">(</span><span class="var">?P</span> <span class="main">(</span><span class="var">?n''</span> <span class="skolem">nm</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assm2 subset_trans<span class="main">[</span><span class="operator">OF</span> assm1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span><span class="var">?n''</span> <span class="skolem">nm</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> assm2<span class="main">:</span> <span class="quoted"><span class="quoted">"SPEC <span class="main">(</span><span class="var">?P</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span>
    <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">r</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">nm</span><span class="main">,</span> <span class="bound">nds</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">f</span> <span class="main">(</span><span class="var">?n''</span> <span class="bound">nm</span><span class="main">,</span> <span class="bound">nds</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prems order_trans<span class="main">[</span><span class="operator">OF</span> assm1 assm2<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> expand_eq_expand<span class="hidden">⇩</span><sub>T</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_inv <span class="free">φ</span> <span class="free">n_ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"expand<span class="hidden">⇩</span><sub>T</sub> <span class="free">n_ns</span> <span class="main">=</span> expand <span class="free">n_ns</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> expand<span class="hidden">⇩</span><sub>T</sub>_def expand_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> RECT_eq_REC<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> expand<span class="hidden">⇩</span><sub>T</sub>_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> expand_term_prop<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> expand_nofail<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_inv <span class="free">φ</span> <span class="free">n_ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>expand<span class="hidden">⇩</span><sub>T</sub> <span class="free">n_ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> expand_term_prop<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"expand_inv <span class="free">φ</span> <span class="main">(</span>
  <span class="main">⦇</span>
    name <span class="main">=</span> expand_new_name expand_init<span class="main">,</span>
    incoming <span class="main">=</span> <span class="main">{</span>expand_init<span class="main">}</span><span class="main">,</span>
    new <span class="main">=</span> <span class="main">{</span><span class="free">φ</span><span class="main">}</span><span class="main">,</span>
    old <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
    next <span class="main">=</span> <span class="main">{}</span> <span class="main">⦈</span><span class="main">,</span>
  <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expand_inv_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">create_graph</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> frml <span class="main">⇒</span> <span class="tfree">'a</span> node set nres"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">create_graph</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span>
    <span class="keyword1">do</span> <span class="main">{</span>
      <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">nds</span><span class="main">)</span> <span class="main">←</span> expand <span class="main">(</span>
        <span class="main">⦇</span>
          name <span class="main">=</span> expand_new_name expand_init<span class="main">,</span>
          incoming <span class="main">=</span> <span class="main">{</span>expand_init<span class="main">}</span><span class="main">,</span>
          new <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span><span class="main">,</span>
          old <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
          next <span class="main">=</span> <span class="main">{}</span>
        <span class="main">⦈</span><span class="main">::</span><span class="tfree">'a</span> node<span class="main">,</span>
        <span class="main">{}</span><span class="main">::</span><span class="tfree">'a</span> node set<span class="main">)</span><span class="main">;</span>
      RETURN <span class="bound">nds</span>
    <span class="main">}</span>"</span></span>

<span class="comment1">(* "expand_eq_expand<span class="hidden">⇩</span><sub>T</sub>" *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">create_graph<span class="hidden">⇩</span><sub>T</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> frml <span class="main">⇒</span> <span class="tfree">'a</span> node set nres"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">create_graph<span class="hidden">⇩</span><sub>T</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">nds</span><span class="main">)</span> <span class="main">←</span> expand<span class="hidden">⇩</span><sub>T</sub> <span class="main">(</span>
      <span class="main">⦇</span>
        name <span class="main">=</span> expand_new_name expand_init<span class="main">,</span>
        incoming <span class="main">=</span> <span class="main">{</span>expand_init<span class="main">}</span><span class="main">,</span>
        new <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span><span class="main">,</span>
        old <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
        next <span class="main">=</span> <span class="main">{}</span>
      <span class="main">⦈</span><span class="main">::</span><span class="tfree">'a</span> node<span class="main">,</span>
    <span class="main">{}</span><span class="main">::</span><span class="tfree">'a</span> node set<span class="main">)</span><span class="main">;</span>
    RETURN <span class="bound">nds</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> create_graph_eq_create_graph<span class="hidden">⇩</span><sub>T</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"create_graph <span class="free">φ</span> <span class="main">=</span> create_graph<span class="hidden">⇩</span><sub>T</sub> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_graph<span class="hidden">⇩</span><sub>T</sub>_def create_graph_def
  <span class="keyword1"><span class="command">unfolding</span></span> eq_iff
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">refine_mono</span> <span class="main">(</span><span class="operator">unfold</span> expand_def expand<span class="hidden">⇩</span><sub>T</sub>_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> REC_le_RECT<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_mono</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> expand_eq_expand<span class="hidden">⇩</span><sub>T</sub><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> eq_iff<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct1<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> create_graph_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"create_graph <span class="free">φ</span> <span class="main">≤</span> SPEC finite"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_graph_def expand_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> REC_le_RECT<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> expand<span class="hidden">⇩</span><sub>T</sub>_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> expand_term_prop<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> create_graph_nofail<span class="main">:</span> <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>create_graph <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> pwD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> create_graph_finite<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">create_graph_rslt_exist</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="free"><span class="bound"><span class="entity">nds</span></span></span>
   <span class="main">≡</span> <span class="main">∃</span><span class="bound">nd</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">nds</span></span></span><span class="main">.</span>
        expand_init<span class="main">∈</span>incoming <span class="bound">nd</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>old <span class="bound">nd</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>next <span class="bound">nd</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span><span class="main">)</span>
      <span class="main">∧</span> <span class="main">{</span><span class="bound">η</span><span class="main">.</span> <span class="main">∃</span><span class="bound">μ</span><span class="main">.</span> <span class="bound">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">η</span> <span class="main">∈</span> old <span class="bound">nd</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="bound">nd</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> L4_7<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"create_graph <span class="free">φ</span> <span class="main">≤</span> SPEC <span class="main">(</span>create_graph_rslt_exist <span class="free">ξ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> create_graph_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> expand_prop_exist<span class="main">)</span> <span class="main">(</span>
    <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>expand_new_name_expand_init<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> expand_incoming_name_exist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"name <span class="main">(</span>fst <span class="free">n_ns</span><span class="main">)</span> <span class="main">&gt;</span> expand_init
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">nm</span><span class="main">∈</span>incoming <span class="main">(</span>fst <span class="free">n_ns</span><span class="main">)</span><span class="main">.</span> <span class="bound">nm</span> <span class="main">≠</span> expand_init <span class="main">⟶</span> <span class="bound">nm</span><span class="main">∈</span>name <span class="main">`</span> <span class="main">(</span>snd <span class="free">n_ns</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> expand_assm_incoming <span class="free">n_ns</span> <span class="main">∧</span> expand_name_ident <span class="main">(</span>snd <span class="free">n_ns</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">n_ns</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span>snd <span class="free">n_ns</span><span class="main">.</span>
    name <span class="bound">nd</span> <span class="main">&gt;</span> expand_init
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">nm</span><span class="main">∈</span>incoming <span class="bound">nd</span><span class="main">.</span> <span class="bound">nm</span> <span class="main">≠</span> expand_init <span class="main">⟶</span> <span class="bound">nm</span><span class="main">∈</span>name <span class="main">`</span> <span class="main">(</span>snd <span class="free">n_ns</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>snd <span class="free">n_ns</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"expand <span class="free">n_ns</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">nm_nds</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">nm_nds</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> expand_rec_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Φ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n_ns</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">n_ns</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">n_ns</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">goal_cases</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 _ _ <span class="skolem">nd</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span><span class="main">∉</span><span class="skolem">ns</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> upd_incoming__elem<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">nd</span><span class="main">∈</span>upd_incoming <span class="skolem">n</span> <span class="skolem">ns</span>›</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nd'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span> <span class="main">=</span> <span class="skolem">nd'</span><span class="main">⦇</span>incoming <span class="main">:=</span>
        incoming <span class="skolem">n</span> <span class="main">∪</span> incoming <span class="skolem">nd'</span><span class="main">⦈</span> <span class="main">∧</span>
        old <span class="skolem">nd'</span> <span class="main">=</span> old <span class="skolem">n</span> <span class="main">∧</span>
        next <span class="skolem">nd'</span> <span class="main">=</span> next <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> QP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?P</span> <span class="skolem">ns</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> f_sup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> expand <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> QP expand_new_name_expand_init
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> name_less<span class="main">:</span> <span class="quoted"><span class="quoted">"name <span class="skolem">n</span> <span class="main">&lt;</span> expand_new_name <span class="main">(</span>name <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> prems name_less <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">nm</span><span class="main">∈</span>incoming <span class="skolem">n</span><span class="main">.</span> <span class="bound">nm</span> <span class="main">&lt;</span> expand_new_name <span class="main">(</span>name <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> prems name_less <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">∈</span><span class="skolem">ns</span><span class="main">.</span> name <span class="bound">q</span> <span class="main">&lt;</span> expand_new_name <span class="main">(</span>name <span class="skolem">n</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">nm</span><span class="main">∈</span>incoming <span class="bound">q</span><span class="main">.</span> <span class="bound">nm</span> <span class="main">&lt;</span> expand_new_name <span class="main">(</span>name <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> QP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">q'</span><span class="main">.</span> <span class="main">(</span><span class="bound">q'</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">∨</span> <span class="bound">q'</span> <span class="main">∈</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">∧</span> name <span class="skolem">n</span> <span class="main">=</span> name <span class="bound">q'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">∈</span><span class="skolem">ns</span><span class="main">.</span> <span class="main">∃!</span><span class="bound">q'</span><span class="main">.</span>
      <span class="main">(</span><span class="bound">q'</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">∨</span> <span class="bound">q'</span> <span class="main">∈</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">∧</span>
      name <span class="bound">q</span> <span class="main">=</span> name <span class="bound">q'</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> QP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 5
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 6
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 7
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>8 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> goal_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> new <span class="skolem">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ν</span> <span class="bound">μ</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span> QP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?P</span> <span class="skolem">ns</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> f_sup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> expand <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">,</span> new <span class="main">:=</span> new1 <span class="skolem">ψ</span> <span class="main">∪</span> new <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span><span class="main">,</span>
        old <span class="main">:=</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span> <span class="main">∪</span> old <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span><span class="main">,</span>
        next <span class="main">:=</span> next1 <span class="skolem">ψ</span> <span class="main">∪</span> next <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span><span class="main">⦈</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?props</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">r</span><span class="main">.</span> expand_rslt_incoming <span class="bound">r</span>
    <span class="main">∧</span> expand_rslt_name <span class="bound">x</span> <span class="bound">r</span>
    <span class="main">∧</span> expand_name_ident <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> goal_assms QP <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_weak_nested2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?props</span> <span class="var">?x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> f_sup<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> expand_name_propag<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">r</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span>
        <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">nm</span> <span class="skolem">nds</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_weak<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">r</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">r</span><span class="main">.</span> expand_rslt_exist_eq <span class="bound">x</span> <span class="bound">r</span> <span class="main">∧</span> <span class="var">?props</span> <span class="bound">x</span> <span class="bound">r</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_conjI<span class="main"><span class="keyword3">,</span></span>
               <span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span>
               <span class="operator">rule_tac</span> f_sup<span class="main"><span class="keyword3">,</span></span>
               <span class="operator">rule_tac</span> expand_rslt_exist_eq<span class="main"><span class="keyword3">,</span></span>
               <span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span>
               <span class="operator">rule_tac</span> f_sup<span class="main"><span class="keyword3">,</span></span>
               <span class="operator">rule_tac</span> expand_name_propag<span class="main">)</span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">r</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
          <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">nm'</span> <span class="skolem">nds'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> create_graph__incoming_name_exist<span class="main">:</span>
  <span class="quoted"><span class="quoted">"create_graph <span class="free">φ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">nds</span><span class="main">.</span> <span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span><span class="bound">nds</span><span class="main">.</span> expand_init <span class="main">&lt;</span> name <span class="bound">nd</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">nm</span><span class="main">∈</span>incoming <span class="bound">nd</span><span class="main">.</span> <span class="bound">nm</span> <span class="main">≠</span> expand_init <span class="main">⟶</span> <span class="bound">nm</span><span class="main">∈</span>name <span class="main">`</span> <span class="bound">nds</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_graph_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule_tac</span> expand_incoming_name_exist<span class="main">)</span> <span class="main">(</span>
    <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>expand_new_name_expand_init<span class="main">)</span>


<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">expand_rslt_all__ex_equiv</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="free"><span class="bound"><span class="entity">nd</span></span></span> <span class="free"><span class="bound"><span class="entity">nds</span></span></span> <span class="main">≡</span>
   <span class="main">(</span><span class="main">∃</span><span class="bound">nd'</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">nds</span></span></span><span class="main">.</span>
    name <span class="free"><span class="bound"><span class="entity">nd</span></span></span> <span class="main">∈</span> incoming <span class="bound">nd'</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>old <span class="bound">nd'</span><span class="main">.</span> suffix <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>next <span class="bound">nd'</span><span class="main">.</span> suffix <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">{</span><span class="bound">η</span><span class="main">.</span> <span class="main">∃</span><span class="bound">μ</span><span class="main">.</span> <span class="bound">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">η</span> <span class="main">∈</span> old <span class="bound">nd'</span> <span class="main">∧</span> suffix <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="bound">nd'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">expand_rslt_all</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span> <span class="free"><span class="bound"><span class="entity">nm_nds</span></span></span> <span class="main">≡</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span>snd <span class="free"><span class="bound"><span class="entity">nm_nds</span></span></span><span class="main">.</span> name <span class="bound">nd</span> <span class="main">∉</span> name <span class="main">`</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>old <span class="bound">nd</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>next <span class="bound">nd</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span><span class="main">)</span>
        <span class="main">⟶</span> expand_rslt_all__ex_equiv <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="bound">nd</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">nm_nds</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> expand_prop_all<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"expand_assm_incoming <span class="free">n_ns</span> <span class="main">∧</span> expand_name_ident <span class="main">(</span>snd <span class="free">n_ns</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">n_ns</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"expand <span class="free">n_ns</span> <span class="main">≤</span> SPEC <span class="main">(</span>expand_rslt_all <span class="free">ξ</span> <span class="free">n_ns</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="free">n_ns</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> expand_rec_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Φ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="var">?Q</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">goal_cases</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> upd_incoming__ident<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> f_sup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> expand <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦇</span>name <span class="main">=</span> expand_new_name <span class="main">(</span>name <span class="skolem">n</span><span class="main">)</span><span class="main">,</span>
    incoming <span class="main">=</span> <span class="main">{</span>name <span class="skolem">n</span><span class="main">}</span><span class="main">,</span> new <span class="main">=</span> next <span class="skolem">n</span><span class="main">,</span> old <span class="main">=</span> <span class="main">{}</span><span class="main">,</span> next <span class="main">=</span> <span class="main">{}</span><span class="main">⦈</span><span class="main">,</span> <span class="main">{</span><span class="skolem">n</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Q <span class="keyword1"><span class="command">have</span></span> name_le<span class="main">:</span> <span class="quoted"><span class="quoted">"name <span class="skolem">n</span> <span class="main">&lt;</span> expand_new_name <span class="main">(</span>name <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_weak<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span>
      Q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span> <span class="bound">r</span><span class="main">.</span>
      <span class="main">(</span>expand_assm_exist <span class="main">(</span>suffix <span class="main">1</span> <span class="free">ξ</span><span class="main">)</span> <span class="var">?x</span> <span class="main">⟶</span> expand_rslt_exist <span class="main">(</span>suffix <span class="main">1</span> <span class="free">ξ</span><span class="main">)</span> <span class="var">?x</span> <span class="bound">r</span><span class="main">)</span>
      <span class="main">∧</span> expand_rslt_exist_eq <span class="bound">p</span> <span class="bound">r</span> <span class="main">∧</span> <span class="main">(</span>expand_name_ident <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_conjI<span class="main"><span class="keyword3">,</span></span>
           <span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span>
           <span class="operator">rule_tac</span> f_sup<span class="main"><span class="keyword3">,</span></span>
           <span class="operator">rule_tac</span> expand_prop_exist<span class="main"><span class="keyword3">,</span></span>
           <span class="operator">rule_tac</span> SPEC_rule_conjI<span class="main"><span class="keyword3">,</span></span>
           <span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span>
           <span class="operator">rule_tac</span> f_sup<span class="main"><span class="keyword3">,</span></span>
           <span class="operator">rule_tac</span> expand_rslt_exist_eq<span class="main"><span class="keyword3">,</span></span>
           <span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span>
           <span class="operator">rule_tac</span> f_sup<span class="main"><span class="keyword3">,</span></span>
           <span class="operator">rule_tac</span> expand_name_propag__name_ident<span class="main"><span class="keyword3">,</span></span>
           <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Q name_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Q name_le <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>3 <span class="skolem">nm</span> <span class="skolem">nds</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span><span class="main">∈</span><span class="skolem">nds</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eq_node<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_rslt_exist_eq__node <span class="skolem">n</span> <span class="skolem">n'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span> ex1_name<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound"><span class="bound">q</span></span><span class="main">∈</span><span class="skolem">nds</span><span class="main">.</span> name <span class="skolem">n</span> <span class="main">=</span> name <span class="bound">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nds_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nds</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">n'</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="skolem">nds</span><span class="main">.</span> name <span class="skolem">n</span> <span class="main">≠</span> name <span class="bound">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq_node <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span><span class="main">∈</span><span class="skolem">nds</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> name_notin<span class="main">:</span> <span class="quoted"><span class="quoted">"name <span class="skolem">n</span> <span class="main">∉</span> name <span class="main">`</span> <span class="skolem">ns</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> P_x<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_rslt_all <span class="free">ξ</span> <span class="var">?x</span> <span class="main">(</span><span class="skolem">nm</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> snd_conv
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">nd</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span> <span class="main">∈</span> <span class="skolem">nds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> name_img<span class="main">:</span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span> <span class="main">∉</span> name <span class="main">`</span> <span class="skolem">ns</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> nd_old_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>old <span class="skolem">nd</span><span class="main">.</span> <span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> nd_next_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>next <span class="skolem">nd</span><span class="main">.</span> <span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"expand_rslt_all__ex_equiv <span class="free">ξ</span> <span class="skolem">nd</span> <span class="skolem">nds</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span> <span class="main">=</span> name <span class="skolem">n</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> nds_eq eq_node <span class="quoted"><span class="quoted">‹<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">nds</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span> <span class="main">=</span> <span class="skolem">n'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> prems<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> conjunct1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
          nd_old_equiv nd_next_equiv eq_node
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> name_img <span class="quoted"><span class="quoted">‹<span class="skolem">nd</span> <span class="main">∈</span> <span class="skolem">nds</span>›</span></span> nd_old_equiv nd_next_equiv P_x
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>4 <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>5 <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 6
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>7 <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>8 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> goal_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> new <span class="skolem">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ν</span> <span class="bound">μ</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="var">?P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> f_sup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> expand <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">,</span> new <span class="main">:=</span> new1 <span class="skolem">ψ</span> <span class="main">∪</span> new <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span><span class="main">,</span>
          old <span class="main">:=</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span> <span class="main">∪</span> old <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span><span class="main">,</span>
                            next <span class="main">:=</span> next1 <span class="skolem">ψ</span> <span class="main">∪</span> next <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span>
        <span class="main">⦈</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?props</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">r</span><span class="main">.</span> expand_rslt_incoming <span class="bound">r</span>
    <span class="main">∧</span> expand_rslt_name <span class="bound">x</span> <span class="bound">r</span>
    <span class="main">∧</span> expand_name_ident <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> goal_assms Q
    <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_weak_nested2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?props</span> <span class="var">?x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> f_sup<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> expand_name_propag<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>3 <span class="skolem">nm</span> <span class="skolem">nds</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_weak<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span>
        P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span>
        Q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">r</span><span class="main">.</span> expand_rslt_exist_eq <span class="bound">x</span> <span class="bound">r</span> <span class="main">∧</span> <span class="var">?props</span> <span class="bound">x</span> <span class="bound">r</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_conjI<span class="main"><span class="keyword3">,</span></span>
               <span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span>
               <span class="operator">rule_tac</span> f_sup<span class="main"><span class="keyword3">,</span></span>
               <span class="operator">rule_tac</span> expand_rslt_exist_eq<span class="main"><span class="keyword3">,</span></span>
               <span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span>
               <span class="operator">rule_tac</span> f_sup<span class="main"><span class="keyword3">,</span></span>
               <span class="operator">rule_tac</span> expand_name_propag<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> prems'<span class="main">:</span> <span class="main">(</span>3 <span class="skolem">nm'</span> <span class="skolem">nds'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> P_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nm</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> P_x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nm'</span><span class="main">,</span> <span class="skolem">nds'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> snd_conv
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">nd</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">nds'</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> name_nd_notin<span class="main">:</span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span> <span class="main">∉</span> name <span class="main">`</span> <span class="skolem">ns</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> old_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>old <span class="skolem">nd</span><span class="main">.</span> <span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> next_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>next <span class="skolem">nd</span><span class="main">.</span> <span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"expand_rslt_all__ex_equiv <span class="free">ξ</span> <span class="skolem">nd</span> <span class="skolem">nds'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span> <span class="main">∈</span> name <span class="main">`</span> <span class="skolem">nds</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">∈</span> <span class="skolem">nds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span> <span class="main">=</span> name <span class="skolem">n'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> prems' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nd'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span><span class="main">∈</span><span class="skolem">nds'</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> nd'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_rslt_exist_eq__node <span class="skolem">n'</span> <span class="skolem">nd'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> prems' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">∈</span><span class="skolem">nds'</span><span class="main">.</span> <span class="main">∃!</span><span class="bound"><span class="bound">q'</span></span><span class="main">∈</span><span class="skolem">nds'</span><span class="main">.</span> name <span class="bound">q</span> <span class="main">=</span> name <span class="bound">q'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span> <span class="main">=</span> <span class="skolem">nd</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹name <span class="skolem">nd</span> <span class="main">=</span> name <span class="skolem">n'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">nd</span> <span class="main">∈</span> <span class="skolem">nds'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> nd'_eq <span class="keyword1"><span class="command">have</span></span> n'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_rslt_exist_eq__node <span class="skolem">n'</span> <span class="skolem">nd</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">n'</span><span class="main">∉</span>name <span class="main">`</span> <span class="skolem">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>old <span class="skolem">n'</span><span class="main">.</span> <span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>next <span class="skolem">n'</span><span class="main">.</span> <span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> name_nd_notin old_equiv next_equiv <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">∈</span> <span class="skolem">nds</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_rslt_all__ex_equiv <span class="free">ξ</span> <span class="skolem">n'</span> <span class="skolem">nds</span>"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">nd'</span><span class="main">∈</span><span class="skolem">nds</span><span class="main">.</span> <span class="var">?sthm</span> <span class="skolem">n'</span> <span class="bound">nd'</span>"</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> P_x <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">∈</span> <span class="skolem">nds</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> snd_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sucnd</span></span> <span class="keyword2"><span class="keyword">where</span></span> sucnd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sucnd</span><span class="main">∈</span><span class="skolem">nds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sthm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?sthm</span> <span class="skolem">n'</span> <span class="skolem">sucnd</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">from</span></span> prems' sucnd sthm <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sucnd'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sucnd'</span><span class="main">∈</span><span class="skolem">nds'</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> sucnd'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_rslt_exist_eq__node <span class="skolem">sucnd</span> <span class="skolem">sucnd'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sthm</span> <span class="skolem">n'</span> <span class="skolem">sucnd'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sucnd'</span> <span class="main">∈</span> <span class="skolem">nds'</span>›</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹name <span class="skolem">nd</span> <span class="main">=</span> name <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">nd</span> <span class="main">∈</span> <span class="skolem">nds'</span>›</span></span> P_x' old_equiv next_equiv
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> snd_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">create_graph_rslt_all</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="free"><span class="bound"><span class="entity">nds</span></span></span>
   <span class="main">≡</span> <span class="main">∀</span><span class="bound">q</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">nds</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>old <span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>next <span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span><span class="main">)</span>
    <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q'</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">nds</span></span></span><span class="main">.</span> name <span class="bound">q</span> <span class="main">∈</span> incoming <span class="bound">q'</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>old <span class="bound">q'</span><span class="main">.</span> suffix <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span><span class="main">)</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>next <span class="bound">q'</span><span class="main">.</span> suffix <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span><span class="main">)</span>
         <span class="main">∧</span> <span class="main">{</span><span class="bound">η</span><span class="main">.</span> <span class="main">∃</span><span class="bound">μ</span><span class="main">.</span> <span class="bound">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">η</span> <span class="main">∈</span> old <span class="bound">q'</span> <span class="main">∧</span> suffix <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="bound">q'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> L4_5<span class="main">:</span> <span class="quoted"><span class="quoted">"create_graph <span class="free">φ</span> <span class="main">≤</span> SPEC <span class="main">(</span>create_graph_rslt_all <span class="free">ξ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_graph_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> expand_prop_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>expand_new_name_expand_init<span class="main">)</span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Creation of GBA›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This section formalizes the second part of the algorithm, that creates
  the actual generalized B\"uchi automata from the set of nodes.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">create_gba_from_nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> frml <span class="main">⇒</span> <span class="tfree">'a</span> node set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> node<span class="main">,</span> <span class="tfree">'a</span> set<span class="main">)</span> gba_rec"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">create_gba_from_nodes</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>
  g_V <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">,</span>
  g_E <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">q'</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">∧</span> <span class="bound">q'</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">∧</span> name <span class="bound">q</span><span class="main">∈</span>incoming <span class="bound">q'</span><span class="main">}</span><span class="main">,</span>
  g_V0 <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">q</span></span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">.</span> expand_init<span class="main">∈</span>incoming <span class="bound">q</span><span class="main">}</span><span class="main">,</span>
  gbg_F <span class="main">=</span> <span class="main">{</span><span class="main">{</span><span class="bound"><span class="bound">q</span></span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">.</span> <span class="bound">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">η</span><span class="main">∈</span>old <span class="bound">q</span> <span class="main">⟶</span> <span class="bound">η</span><span class="main">∈</span>old <span class="bound">q</span><span class="main">}</span><span class="main">|</span><span class="bound">μ</span> <span class="bound">η</span><span class="main">.</span> <span class="bound">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">η</span> <span class="main">∈</span> subfrmlsr <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span><span class="main">,</span>
  gba_L <span class="main">=</span> <span class="main">λ</span><span class="bound">q</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">q</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">∧</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">prop<span class="hidden">⇩</span><sub>r</sub>(</span><span class="bound">p</span><span class="main">)</span><span class="main">∈</span>old <span class="bound">q</span><span class="main">}</span><span class="main">⊆</span><span class="bound">l</span> <span class="main">∧</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">nprop<span class="hidden">⇩</span><sub>r</sub>(</span><span class="bound">p</span><span class="main">)</span><span class="main">∈</span>old <span class="bound">q</span><span class="main">}</span> <span class="main">∩</span> <span class="bound">l</span> <span class="main">=</span> <span class="main">{}</span>
<span class="main">⦈</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> create_gba_from_nodes_precond <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltlr"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> node set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"inres <span class="main">(</span>create_graph <span class="free">φ</span><span class="main">)</span> <span class="free">qs</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_qs<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">qs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> res create_graph_finite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> create_gba_from_nodes__invar<span class="main">:</span> <span class="quoted"><span class="quoted">"gba <span class="main">(</span>create_gba_from_nodes <span class="free">φ</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> finite_Collect<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span>
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_vimageI subfrmlsr_finite injI
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> create_gba_from_nodes_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">sublocale</span></span> gba<span class="main">:</span> gba <span class="quoted"><span class="quoted">"create_gba_from_nodes <span class="free">φ</span> <span class="free">qs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> create_gba_from_nodes__invar<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> create_gba_from_nodes__fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>g_V <span class="main">(</span>create_gba_from_nodes <span class="free">φ</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_gba_from_nodes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> create_gba_from_nodes__ipath<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ipath gba.E <span class="free">r</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">r</span> <span class="bound">i</span> <span class="main">∈</span><span class="free">qs</span> <span class="main">∧</span> name <span class="main">(</span><span class="free">r</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>incoming <span class="main">(</span><span class="free">r</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_gba_from_nodes_def ipath_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> create_gba_from_nodes__is_run<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gba.is_run <span class="free">r</span> <span class="main">⟷</span> expand_init <span class="main">∈</span> incoming <span class="main">(</span><span class="free">r</span> <span class="main">0</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">r</span> <span class="bound">i</span><span class="main">∈</span><span class="free">qs</span> <span class="main">∧</span> name <span class="main">(</span><span class="free">r</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>incoming <span class="main">(</span><span class="free">r</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gba.is_run_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> create_gba_from_nodes__ipath<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> create_gba_from_nodes_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">auto_run_j</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>old <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">.</span> suffix <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>next <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">.</span> suffix <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">∧</span>
        <span class="main">{</span><span class="bound">η</span><span class="main">.</span> <span class="main">∃</span><span class="bound">μ</span><span class="main">.</span> <span class="bound">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">η</span> <span class="main">∈</span> old <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∧</span> suffix <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">auto_run</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span> interprt<span class="main">,</span> <span class="tfree">'a</span> node set<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'a</span> node word"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">auto_run</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="free"><span class="bound"><span class="entity">nds</span></span></span> <span class="main">0</span>
   <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">q</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">nds</span></span></span> <span class="main">∧</span> expand_init <span class="main">∈</span> incoming <span class="bound">q</span> <span class="main">∧</span> auto_run_j <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="bound">q</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">auto_run</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="free"><span class="bound"><span class="entity">nds</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>
   <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">q'</span><span class="main">.</span> <span class="bound">q'</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">nds</span></span></span> <span class="main">∧</span> name <span class="main">(</span><span class="free">auto_run</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="free"><span class="bound"><span class="entity">nds</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">∈</span> incoming <span class="bound">q'</span>
        <span class="main">∧</span> auto_run_j <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="bound">q'</span><span class="main">)</span>"</span></span>


<span class="comment1">(* TODO: Remove. Only special instance of more generic principle
lemma create_graph_comb:
  assumes "⋀x. inres (create_graph φ) x ⟹ P x"
    shows "create_graph φ≤SPEC P"
  using create_graph_nofail assms
  by (auto simp add: pw_le_iff refine_pw_simps)
*)</span>

<span class="keyword1"><span class="command">lemma</span></span> run_propag_on_create_graph<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ipath gba.E <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">k</span><span class="main">∈</span><span class="free">qs</span> <span class="main">∧</span> name <span class="main">(</span><span class="free">σ</span> <span class="free">k</span><span class="main">)</span><span class="main">∈</span>incoming <span class="main">(</span><span class="free">σ</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> create_gba_from_nodes__ipath<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> expand_false_propag<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">false<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">∉</span> old <span class="main">(</span>fst <span class="free">n_ns</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span>snd <span class="free">n_ns</span><span class="main">.</span> <span class="keyword1">false<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">∉</span> old <span class="bound">nd</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">n_ns</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"expand <span class="free">n_ns</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">nm_nds</span><span class="main">.</span> <span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span>snd <span class="bound">nm_nds</span><span class="main">.</span> <span class="keyword1">false<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">∉</span> old <span class="bound">nd</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> expand_rec_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Φ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="var">?Q</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> upd_incoming__ident<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 8
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_nested2<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> false_propag_on_create_graph<span class="main">:</span> <span class="quoted"><span class="quoted">"create_graph <span class="free">φ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">nds</span><span class="main">.</span> <span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span><span class="bound">nds</span><span class="main">.</span> <span class="keyword1">false<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">∉</span> old <span class="bound">nd</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_graph_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> expand_false_propag<span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> expand_and_propag<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="main">(</span>fst <span class="free">n_ns</span><span class="main">)</span>
    <span class="main">⟶</span> <span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="main">(</span>fst <span class="free">n_ns</span><span class="main">)</span> <span class="main">∪</span> new <span class="main">(</span>fst <span class="free">n_ns</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">n_ns</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span>snd <span class="free">n_ns</span><span class="main">.</span> <span class="free">μ</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="bound">nd</span> <span class="main">⟶</span> <span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="bound">nd</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>snd <span class="free">n_ns</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"expand <span class="free">n_ns</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">nm_nds</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">nm_nds</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> expand_rec_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Φ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> upd_incoming__ident<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>4 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>5 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>7 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>8 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> goal_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> new <span class="skolem">n</span>
    <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">prop<span class="hidden">⇩</span><sub>r</sub>(</span><span class="bound">q</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">nprop<span class="hidden">⇩</span><sub>r</sub>(</span><span class="bound">q</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> <span class="skolem">ψ</span> <span class="main">≠</span> <span class="keyword1">true<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">∧</span> <span class="skolem">ψ</span> <span class="main">≠</span> <span class="keyword1">false<span class="hidden">⇩</span><sub>r</sub></span>
    <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ν</span> <span class="bound">μ</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ν</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ν</span> <span class="bound">μ</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> QP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?P</span> <span class="skolem">ns</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> goal_assms QP <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_nested2<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> and_propag_on_create_graph<span class="main">:</span>
  <span class="quoted"><span class="quoted">"create_graph <span class="free">φ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">nds</span><span class="main">.</span> <span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span><span class="bound">nds</span><span class="main">.</span> <span class="free">μ</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="bound">nd</span> <span class="main">⟶</span> <span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="bound">nd</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_graph_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> expand_and_propag<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> expand_or_propag<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="main">(</span>fst <span class="free">n_ns</span><span class="main">)</span>
    <span class="main">⟶</span> <span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">η</span><span class="main">}</span> <span class="main">∩</span> <span class="main">(</span>old <span class="main">(</span>fst <span class="free">n_ns</span><span class="main">)</span> <span class="main">∪</span> new <span class="main">(</span>fst <span class="free">n_ns</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">n_ns</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span>snd <span class="free">n_ns</span><span class="main">.</span> <span class="free">μ</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="bound">nd</span> <span class="main">⟶</span> <span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">η</span><span class="main">}</span> <span class="main">∩</span> old <span class="bound">nd</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>snd <span class="free">n_ns</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"expand <span class="free">n_ns</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">nm_nds</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">nm_nds</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> expand_rec_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Φ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> upd_incoming__ident<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>4 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>5 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>7 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>8 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> goal_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> new <span class="skolem">n</span>
    <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">prop<span class="hidden">⇩</span><sub>r</sub>(</span><span class="bound">q</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">nprop<span class="hidden">⇩</span><sub>r</sub>(</span><span class="bound">q</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> <span class="skolem">ψ</span> <span class="main">≠</span> <span class="keyword1">true<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">∧</span> <span class="skolem">ψ</span> <span class="main">≠</span> <span class="keyword1">false<span class="hidden">⇩</span><sub>r</sub></span>
    <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ν</span> <span class="bound">μ</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ν</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ν</span> <span class="bound">μ</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> QP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?P</span> <span class="skolem">ns</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> goal_assms QP
    <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_nested2<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> or_propag_on_create_graph<span class="main">:</span>
  <span class="quoted"><span class="quoted">"create_graph <span class="free">φ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">nds</span><span class="main">.</span> <span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span><span class="bound">nds</span><span class="main">.</span> <span class="free">μ</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="bound">nd</span> <span class="main">⟶</span> <span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">η</span><span class="main">}</span> <span class="main">∩</span> old <span class="bound">nd</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_graph_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> expand_or_propag<span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_propag__assm</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span> <span class="main">≡</span>
     <span class="main">(</span><span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="main">∈</span> old <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="main">∈</span> next <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span><span class="main">)</span>
     <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span>snd <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">.</span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="main">∈</span> old <span class="bound">nd</span> <span class="main">∧</span> name <span class="bound">nd</span> <span class="main">∈</span> incoming <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span>
        <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="main">∈</span> old <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span> <span class="main">∪</span> new <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_propag__rslt</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">≡</span>
     <span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">nd'</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">.</span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="main">∈</span> old <span class="bound">nd</span> <span class="main">∧</span> name <span class="bound">nd</span> <span class="main">∈</span> incoming <span class="bound">nd'</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="main">∈</span> old <span class="bound">nd'</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> expand_next_propag<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n_ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">×</span> <span class="tfree">'a</span> node set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_propag__assm <span class="free">μ</span> <span class="free">n_ns</span>
           <span class="main">∧</span> next_propag__rslt <span class="free">μ</span> <span class="main">(</span>snd <span class="free">n_ns</span><span class="main">)</span>
           <span class="main">∧</span> expand_assm_incoming <span class="free">n_ns</span>
           <span class="main">∧</span> expand_name_ident <span class="main">(</span>snd <span class="free">n_ns</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">n_ns</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"expand <span class="free">n_ns</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> next_propag__rslt <span class="free">μ</span> <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> expand_rec_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Φ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="var">?Q</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> upd_incoming__ident<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> 1
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">nd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> node"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">nd'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> node"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nd'_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span><span class="main">∈</span>upd_incoming <span class="skolem">n</span> <span class="skolem">ns</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">∈</span> old <span class="skolem">nd'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">μ</span> <span class="main">∈</span> old <span class="skolem">nd</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span> <span class="main">∈</span> incoming <span class="skolem">nd'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> prems * ** <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">ns</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> upd_incoming__elem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">nd'</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">ns</span></span><span class="main">]</span> nd'_elem * **
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nd''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd''</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> nd'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span> <span class="main">=</span> <span class="skolem">nd''</span><span class="main">⦇</span>incoming <span class="main">:=</span> incoming <span class="skolem">n</span> <span class="main">∪</span> incoming <span class="skolem">nd''</span><span class="main">⦈</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> old_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"old <span class="skolem">nd''</span> <span class="main">=</span> old <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">∈</span> old <span class="skolem">nd'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span> <span class="main">∈</span> incoming <span class="skolem">n</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">with</span></span> prems * <span class="quoted"><span class="quoted">‹<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">ns</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">∈</span> old <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nd'_eq old_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span> <span class="main">∈</span> incoming <span class="skolem">nd''</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹name <span class="skolem">nd</span> <span class="main">∈</span>incoming <span class="skolem">nd'</span>›</span></span> nd'_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> nd'_eq <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">ns</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">nd''</span><span class="main">∈</span><span class="skolem">ns</span>›</span></span> * prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> f_sup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> expand <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Q <span class="keyword1"><span class="command">have</span></span> name_le<span class="main">:</span> <span class="quoted"><span class="quoted">"name <span class="skolem">n</span> <span class="main">&lt;</span> expand_new_name <span class="main">(</span>name <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦇</span>name <span class="main">=</span> expand_new_name <span class="main">(</span>name <span class="skolem">n</span><span class="main">)</span><span class="main">,</span>
               incoming <span class="main">=</span> <span class="main">{</span>name <span class="skolem">n</span><span class="main">}</span><span class="main">,</span> new <span class="main">=</span> next <span class="skolem">n</span><span class="main">,</span>
               old <span class="main">=</span> <span class="main">{}</span><span class="main">,</span> next <span class="main">=</span> <span class="main">{}</span><span class="main">⦈</span><span class="main">,</span> <span class="main">{</span><span class="skolem">n</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> Q'1<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_assm_incoming <span class="var">?x'</span><span class="main">∧</span> expand_name_ident <span class="main">(</span>snd <span class="var">?x'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹new <span class="skolem">n</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> Q<span class="main">[</span><span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">]</span> name_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> Q'2<span class="main">:</span> <span class="quoted"><span class="quoted">"next_propag__assm <span class="free">μ</span> <span class="var">?x'</span> <span class="main">∧</span> next_propag__rslt <span class="free">μ</span> <span class="main">(</span>snd <span class="var">?x'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Q <span class="quoted"><span class="quoted">‹new <span class="skolem">n</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹new <span class="skolem">n</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_weak<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span>
      Q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="bound">r</span><span class="main">.</span> expand_name_ident <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="var">?P</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Q'1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule_tac</span> f_sup<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule_tac</span> expand_name_propag__name_ident<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Q'1 Q'2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">nm</span> <span class="skolem">nds</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>4 <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>5 <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 6
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>7 <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>8 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> goal_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> new <span class="skolem">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ν</span> <span class="bound">μ</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> f_sup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> expand <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">,</span> new <span class="main">:=</span> new1 <span class="skolem">ψ</span> <span class="main">∪</span> new <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span><span class="main">,</span>
        old <span class="main">:=</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span> <span class="main">∪</span> old <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span><span class="main">,</span>
                            next <span class="main">:=</span> next1 <span class="skolem">ψ</span> <span class="main">∪</span> next <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span>
        <span class="main">⦈</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?props</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">r</span><span class="main">.</span> expand_rslt_exist_eq <span class="bound">x</span> <span class="bound">r</span>
    <span class="main">∧</span> expand_rslt_incoming <span class="bound">r</span> <span class="main">∧</span> expand_rslt_name <span class="bound">x</span> <span class="bound">r</span> <span class="main">∧</span> expand_name_ident <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> goal_assms Q <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_weak_nested2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?props</span> <span class="var">?x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">then</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_conjI<span class="main"><span class="keyword3">,</span></span>
             <span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span>
             <span class="operator">rule_tac</span> f_sup<span class="main"><span class="keyword3">,</span></span>
             <span class="operator">rule_tac</span> expand_rslt_exist_eq<span class="main"><span class="keyword3">,</span></span>
             <span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span>
             <span class="operator">rule_tac</span> f_sup<span class="main"><span class="keyword3">,</span></span>
             <span class="operator">rule_tac</span> expand_name_propag<span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="var">?P</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems'<span class="main">:</span> <span class="main">(</span>3 <span class="skolem">nm</span> <span class="skolem">nds</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">,</span>
       name <span class="main">:=</span> fst <span class="main">(</span><span class="skolem">nm</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span><span class="main">,</span>
       new <span class="main">:=</span> new2 <span class="skolem">ψ</span> <span class="main">∪</span> new <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span><span class="main">,</span>
       old <span class="main">:=</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span> <span class="main">∪</span> old <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span><span class="main">⦈</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> prems' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> prems''<span class="main">:</span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_assm_incoming <span class="var">?x'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> prems'' <span class="keyword1"><span class="command">have</span></span> nds_ident<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_name_ident <span class="main">(</span>snd <span class="var">?x'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">μ</span> <span class="main">∈</span> old <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">μ</span><span class="main">∈</span>next <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Q<span class="main">[</span><span class="operator">THEN</span> conjunct1<span class="main">]</span> goal_assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> prems'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next_propag__rslt <span class="free">μ</span> <span class="main">(</span>snd <span class="var">?x'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> prems'' <span class="keyword1"><span class="command">have</span></span> name_nds_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"name <span class="main">`</span> <span class="skolem">nds</span> <span class="main">=</span> name <span class="main">`</span> <span class="skolem">ns</span> <span class="main">∪</span> name <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">nd</span></span><span class="main">∈</span><span class="skolem">nds</span><span class="main">.</span> name <span class="bound">nd</span> <span class="main">≥</span> name <span class="skolem">n</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span><span class="skolem">nds</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">μ</span> <span class="main">∈</span> old <span class="bound">nd</span> <span class="main">∧</span> name <span class="bound">nd</span> <span class="main">∈</span> incoming <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span><span class="main">)</span>
                       <span class="main">⟶</span> <span class="free">μ</span><span class="main">∈</span>old <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span><span class="main">∪</span>new <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span>"</span></span>
       <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span><span class="skolem">nds</span><span class="main">.</span> <span class="var">?assm</span> <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="bound">nd</span> <span class="main">⟶</span> <span class="var">?concl</span> <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="bound">nd</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">nd</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">nds</span>"</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> loc_assm<span class="main">:</span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span><span class="main">∈</span>name <span class="main">`</span> <span class="skolem">ns</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> n'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">n'</span> <span class="main">=</span> name <span class="skolem">nd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">from</span></span> prems'' n' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nd'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span><span class="main">∈</span><span class="skolem">nds</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> n'_nd'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_rslt_exist_eq__node <span class="skolem">n'</span> <span class="skolem">nd'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span> <span class="main">=</span> <span class="skolem">nd'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> nds_ident <span class="quoted"><span class="quoted">‹<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">nds</span>›</span></span> loc_assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> prems'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?assm</span> <span class="skolem">n</span> <span class="skolem">n'</span> <span class="main">⟶</span> <span class="var">?concl</span> <span class="skolem">n</span> <span class="skolem">n'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span><span class="main">∈</span><span class="skolem">ns</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?assm</span> <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="skolem">nd</span> <span class="main">⟶</span> <span class="var">?concl</span> <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="skolem">nd</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> n'_nd'_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span><span class="main">∉</span>name <span class="main">`</span> <span class="skolem">ns</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> name_nds_eq <span class="quoted"><span class="quoted">‹<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">nds</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span> <span class="main">≥</span> name <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> prems'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="var">?assm</span> <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="skolem">nd</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?assm</span> <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="skolem">nd</span> <span class="main">⟶</span> <span class="var">?concl</span> <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="skolem">nd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_propag_on_create_graph<span class="main">:</span>
  <span class="quoted"><span class="quoted">"create_graph <span class="free">φ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">nds</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n</span><span class="main">∈</span><span class="bound">nds</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n'</span><span class="main">∈</span><span class="bound">nds</span><span class="main">.</span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">μ</span><span class="main">∈</span>old <span class="bound">n</span> <span class="main">∧</span> name <span class="bound">n</span><span class="main">∈</span>incoming <span class="bound">n'</span> <span class="main">⟶</span> <span class="free">μ</span><span class="main">∈</span>old <span class="bound">n'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_graph_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> expand_next_propag<span class="main">)</span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>expand_new_name_expand_init<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">release_propag__assm</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span> <span class="main">≡</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main">∈</span> old <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span>
      <span class="main">⟶</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">η</span></span></span><span class="main">}</span><span class="main">⊆</span>old <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span><span class="main">∪</span>new <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span> <span class="main">∨</span>
         <span class="main">(</span><span class="free"><span class="bound"><span class="entity">η</span></span></span><span class="main">∈</span>old <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span><span class="main">∪</span>new <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main">∈</span> next <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span><span class="main">)</span>
     <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span>snd <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">.</span>
         <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main">∈</span> old <span class="bound">nd</span> <span class="main">∧</span> name <span class="bound">nd</span> <span class="main">∈</span> incoming <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span>
         <span class="main">⟶</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">η</span></span></span><span class="main">}</span><span class="main">⊆</span>old <span class="bound">nd</span> <span class="main">∨</span>
            <span class="main">(</span><span class="free"><span class="bound"><span class="entity">η</span></span></span><span class="main">∈</span>old <span class="bound">nd</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main">∈</span> old <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span><span class="main">∪</span>new <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">release_propag__rslt</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">≡</span>
     <span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">.</span>
       <span class="main">∀</span><span class="bound">nd'</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">.</span>
         <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main">∈</span> old <span class="bound">nd</span> <span class="main">∧</span> name <span class="bound">nd</span> <span class="main">∈</span> incoming <span class="bound">nd'</span>
         <span class="main">⟶</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">η</span></span></span><span class="main">}</span><span class="main">⊆</span>old <span class="bound">nd</span> <span class="main">∨</span>
            <span class="main">(</span><span class="free"><span class="bound"><span class="entity">η</span></span></span><span class="main">∈</span>old <span class="bound">nd</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main">∈</span> old <span class="bound">nd'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> expand_release_propag<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n_ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">×</span> <span class="tfree">'a</span> node set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"release_propag__assm <span class="free">μ</span> <span class="free">η</span> <span class="free">n_ns</span>
           <span class="main">∧</span> release_propag__rslt <span class="free">μ</span> <span class="free">η</span> <span class="main">(</span>snd <span class="free">n_ns</span><span class="main">)</span>
           <span class="main">∧</span> expand_assm_incoming <span class="free">n_ns</span>
           <span class="main">∧</span> expand_name_ident <span class="main">(</span>snd <span class="free">n_ns</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">n_ns</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"expand <span class="free">n_ns</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> release_propag__rslt <span class="free">μ</span> <span class="free">η</span> <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> expand_rec_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Φ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="var">?Q</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> upd_incoming__ident<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> 1
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">nd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> node"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">nd'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> node"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?V_prop</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="skolem">nd</span> <span class="main">∧</span> name <span class="skolem">nd</span> <span class="main">∈</span> incoming <span class="skolem">nd'</span>
        <span class="main">⟶</span> <span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="skolem">nd</span> <span class="main">∨</span> <span class="free">η</span> <span class="main">∈</span> old <span class="skolem">nd</span> <span class="main">∧</span> <span class="free">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="skolem">nd'</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nd'_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span><span class="main">∈</span>upd_incoming <span class="skolem">n</span> <span class="skolem">ns</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?V_prop</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">ns</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span><span class="main">∉</span><span class="skolem">ns</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> V_in_nd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="skolem">nd</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span> <span class="main">∈</span>incoming <span class="skolem">nd'</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> upd_incoming__elem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">nd'</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">ns</span></span><span class="main">]</span> nd'_elem
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nd''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd''</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> nd'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span> <span class="main">=</span> <span class="skolem">nd''</span><span class="main">⦇</span>incoming <span class="main">:=</span> incoming <span class="skolem">n</span> <span class="main">∪</span> incoming <span class="skolem">nd''</span><span class="main">⦈</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> old_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"old <span class="skolem">nd''</span> <span class="main">=</span> old <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span> <span class="main">∈</span> incoming <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> prems V_in_nd <span class="quoted"><span class="quoted">‹<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">ns</span>›</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="skolem">nd</span> <span class="main">∨</span> <span class="free">η</span> <span class="main">∈</span> old <span class="skolem">nd</span> <span class="main">∧</span> <span class="free">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="skolem">n</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="skolem">nd</span> <span class="main">∨</span> <span class="free">η</span> <span class="main">∈</span> old <span class="skolem">nd</span> <span class="main">∧</span> <span class="free">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="skolem">nd'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> nd'_eq old_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span> <span class="main">∉</span> incoming <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span> <span class="main">∈</span> incoming <span class="skolem">nd''</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹name <span class="skolem">nd</span> <span class="main">∈</span>incoming <span class="skolem">nd'</span>›</span></span> nd'_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="skolem">nd</span> <span class="main">∨</span> <span class="free">η</span> <span class="main">∈</span> old <span class="skolem">nd</span> <span class="main">∧</span> <span class="free">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="skolem">nd'</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> nd'_eq
            <span class="keyword1"><span class="command">using</span></span> prems <span class="quoted"><span class="quoted">‹<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">ns</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">nd''</span><span class="main">∈</span><span class="skolem">ns</span>›</span></span> V_in_nd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="skolem">nd</span> <span class="main">∨</span> <span class="free">η</span> <span class="main">∈</span> old <span class="skolem">nd</span> <span class="main">∧</span> <span class="free">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="skolem">nd'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?V_prop</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> f_sup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> expand <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Q <span class="keyword1"><span class="command">have</span></span> name_le<span class="main">:</span> <span class="quoted"><span class="quoted">"name <span class="skolem">n</span> <span class="main">&lt;</span> expand_new_name <span class="main">(</span>name <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦇</span>name <span class="main">=</span> expand_new_name <span class="main">(</span>name <span class="skolem">n</span><span class="main">)</span><span class="main">,</span>
               incoming <span class="main">=</span> <span class="main">{</span>name <span class="skolem">n</span><span class="main">}</span><span class="main">,</span> new <span class="main">=</span> next <span class="skolem">n</span><span class="main">,</span>
               old <span class="main">=</span> <span class="main">{}</span><span class="main">,</span> next <span class="main">=</span> <span class="main">{}</span><span class="main">⦈</span><span class="main">,</span> <span class="main">{</span><span class="skolem">n</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> Q'1<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_assm_incoming <span class="var">?x'</span><span class="main">∧</span> expand_name_ident <span class="main">(</span>snd <span class="var">?x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹new <span class="skolem">n</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> Q<span class="main">[</span><span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">]</span> name_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> Q'2<span class="main">:</span> <span class="quoted"><span class="quoted">"release_propag__assm <span class="free">μ</span> <span class="free">η</span> <span class="var">?x'</span> <span class="main">∧</span> release_propag__rslt <span class="free">μ</span> <span class="free">η</span> <span class="main">(</span>snd <span class="var">?x'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Q <span class="quoted"><span class="quoted">‹new <span class="skolem">n</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹new <span class="skolem">n</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span>

  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_weak<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span>
      Q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="bound">r</span><span class="main">.</span> expand_name_ident <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="var">?P</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Q'1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule_tac</span> f_sup<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule_tac</span> expand_name_propag__name_ident<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Q'1 Q'2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">nm</span> <span class="skolem">nds</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>4 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> goal_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> new <span class="skolem">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">prop<span class="hidden">⇩</span><sub>r</sub>(</span><span class="bound">q</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">nprop<span class="hidden">⇩</span><sub>r</sub>(</span><span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Q goal_assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>5 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> goal_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> new <span class="skolem">n</span> <span class="main">∧</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">true<span class="hidden">⇩</span><sub>r</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Q goal_assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 6
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>7 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> goal_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> new <span class="skolem">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ν</span> <span class="bound">μ</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ν</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Q goal_assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>8 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> goal_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> new <span class="skolem">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ν</span> <span class="bound">μ</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> f_sup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> expand <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">,</span> new <span class="main">:=</span> new1 <span class="skolem">ψ</span> <span class="main">∪</span> new <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span><span class="main">,</span>
        old <span class="main">:=</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span> <span class="main">∪</span> old <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span><span class="main">,</span>
                            next <span class="main">:=</span> next1 <span class="skolem">ψ</span> <span class="main">∪</span> next <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span>
      <span class="main">⦈</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?props</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">r</span><span class="main">.</span> expand_rslt_exist_eq <span class="bound">x</span> <span class="bound">r</span>
    <span class="main">∧</span> expand_rslt_incoming <span class="bound">r</span> <span class="main">∧</span> expand_rslt_name <span class="bound">x</span> <span class="bound">r</span> <span class="main">∧</span> expand_name_ident <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> goal_assms Q <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span>

  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_weak_nested2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?props</span> <span class="var">?x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_conjI<span class="main"><span class="keyword3">,</span></span>
             <span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span>
             <span class="operator">rule_tac</span> f_sup<span class="main"><span class="keyword3">,</span></span>
             <span class="operator">rule_tac</span> expand_rslt_exist_eq<span class="main"><span class="keyword3">,</span></span>
             <span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span>
             <span class="operator">rule_tac</span> f_sup<span class="main"><span class="keyword3">,</span></span>
             <span class="operator">rule_tac</span> expand_name_propag<span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="var">?P</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems'<span class="main">:</span> <span class="main">(</span>3 <span class="skolem">nm</span> <span class="skolem">nds</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">,</span>
       name <span class="main">:=</span> fst <span class="main">(</span><span class="skolem">nm</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span><span class="main">,</span>
       new <span class="main">:=</span> new2 <span class="skolem">ψ</span> <span class="main">∪</span> new <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span><span class="main">,</span>
       old <span class="main">:=</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span> <span class="main">∪</span> old <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span><span class="main">⦈</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> prems' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> prems''<span class="main">:</span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_assm_incoming <span class="var">?x'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> prems'' <span class="keyword1"><span class="command">have</span></span> nds_ident<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_name_ident <span class="main">(</span>snd <span class="var">?x'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span>
             <span class="main">⟶</span> <span class="main">(</span><span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">η</span><span class="main">}</span><span class="main">⊆</span>old <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="main">∪</span> new <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span>
                  <span class="main">∨</span> <span class="main">(</span><span class="free">η</span><span class="main">∈</span>old <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span><span class="main">∪</span>new <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span>
                     <span class="main">∧</span> <span class="free">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> next <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Q<span class="main">[</span><span class="operator">THEN</span> conjunct1<span class="main">]</span> goal_assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> prems'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"release_propag__rslt <span class="free">μ</span> <span class="free">η</span> <span class="main">(</span>snd <span class="var">?x'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> prems'' <span class="keyword1"><span class="command">have</span></span> name_nds_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"name <span class="main">`</span> <span class="skolem">nds</span> <span class="main">=</span> name <span class="main">`</span> <span class="skolem">ns</span> <span class="main">∪</span> name <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">nd</span></span><span class="main">∈</span><span class="skolem">nds</span><span class="main">.</span> name <span class="bound">nd</span> <span class="main">≥</span> name <span class="skolem">n</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span><span class="skolem">nds</span><span class="main">.</span> <span class="main">(</span><span class="free">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="bound">nd</span> <span class="main">∧</span> name <span class="bound">nd</span> <span class="main">∈</span> incoming <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">⟶</span> <span class="main">(</span><span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">η</span><span class="main">}</span><span class="main">⊆</span>old <span class="bound">nd</span>
                      <span class="main">∨</span> <span class="main">(</span><span class="free">η</span><span class="main">∈</span>old <span class="bound">nd</span> <span class="main">∧</span> <span class="free">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span>old <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span><span class="main">∪</span>new <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span><span class="skolem">nds</span><span class="main">.</span> <span class="var">?assm</span> <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="bound">nd</span> <span class="main">⟶</span> <span class="var">?concl</span> <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="bound">nd</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">nd</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">nds</span>"</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> loc_assm<span class="main">:</span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span><span class="main">∈</span>name <span class="main">`</span> <span class="skolem">ns</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> n'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">n'</span> <span class="main">=</span> name <span class="skolem">nd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> prems'' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nd'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span><span class="main">∈</span><span class="skolem">nds</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> n'_nd'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_rslt_exist_eq__node <span class="skolem">n'</span> <span class="skolem">nd'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> n' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span> <span class="main">=</span> <span class="skolem">nd'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nds_ident <span class="quoted"><span class="quoted">‹<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">nds</span>›</span></span> loc_assm
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> prems'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?assm</span> <span class="skolem">n</span> <span class="skolem">n'</span> <span class="main">⟶</span> <span class="var">?concl</span> <span class="skolem">n</span> <span class="skolem">n'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span><span class="main">∈</span><span class="skolem">ns</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?assm</span> <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="skolem">nd</span> <span class="main">⟶</span> <span class="var">?concl</span> <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="skolem">nd</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> n'_nd'_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span><span class="main">∉</span>name <span class="main">`</span> <span class="skolem">ns</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> name_nds_eq <span class="quoted"><span class="quoted">‹<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">nds</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span> <span class="main">≥</span> name <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> prems'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="var">?assm</span> <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="skolem">nd</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?assm</span> <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="skolem">nd</span> <span class="main">⟶</span> <span class="var">?concl</span> <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="skolem">nd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> release_propag_on_create_graph<span class="main">:</span>
  <span class="quoted"><span class="quoted">"create_graph <span class="free">φ</span>
     <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">nds</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n</span><span class="main">∈</span><span class="bound">nds</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n'</span><span class="main">∈</span><span class="bound">nds</span><span class="main">.</span> <span class="free">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span><span class="main">∈</span>old <span class="bound">n</span> <span class="main">∧</span> name <span class="bound">n</span><span class="main">∈</span>incoming <span class="bound">n'</span>
                                      <span class="main">⟶</span> <span class="main">(</span><span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">η</span><span class="main">}</span><span class="main">⊆</span>old <span class="bound">n</span> <span class="main">∨</span> <span class="free">η</span><span class="main">∈</span>old <span class="bound">n</span> <span class="main">∧</span> <span class="free">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span><span class="main">∈</span>old <span class="bound">n'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_graph_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> expand_release_propag<span class="main">)</span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>expand_new_name_expand_init<span class="main">)</span>


<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">until_propag__assm</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span> <span class="main">≡</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∈</span> old <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span>
      <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">∈</span>old <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span><span class="main">∪</span>new <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span>
            <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">∈</span>old <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span><span class="main">∪</span>new <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∈</span> next <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span>snd <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∈</span> old <span class="bound">nd</span> <span class="main">∧</span> name <span class="bound">nd</span> <span class="main">∈</span> incoming <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span>
        <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">∈</span>old <span class="bound">nd</span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">∈</span>old <span class="bound">nd</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∈</span>old <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span><span class="main">∪</span>new <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">n_ns</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">until_propag__rslt</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">≡</span>
     <span class="main">∀</span><span class="bound">n</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∈</span> old <span class="bound">n</span> <span class="main">∧</span> name <span class="bound">n</span> <span class="main">∈</span> incoming <span class="bound">nd</span>
                                  <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∈</span> old <span class="bound">n</span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">∈</span>old <span class="bound">n</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∈</span> old <span class="bound">nd</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> expand_until_propag<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n_ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">×</span> <span class="tfree">'a</span> node set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"until_propag__assm <span class="free">μ</span> <span class="free">η</span> <span class="free">n_ns</span>
           <span class="main">∧</span> until_propag__rslt <span class="free">μ</span> <span class="free">η</span> <span class="main">(</span>snd <span class="free">n_ns</span><span class="main">)</span>
           <span class="main">∧</span> expand_assm_incoming <span class="free">n_ns</span>
           <span class="main">∧</span> expand_name_ident <span class="main">(</span>snd <span class="free">n_ns</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">n_ns</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"expand <span class="free">n_ns</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> until_propag__rslt <span class="free">μ</span> <span class="free">η</span> <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> expand_rec_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Φ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="var">?Q</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> upd_incoming__ident<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> prems'<span class="main">:</span> 1
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">nd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> node"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">nd'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> node"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U_prop</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="skolem">nd</span> <span class="main">∧</span> name <span class="skolem">nd</span> <span class="main">∈</span> incoming <span class="skolem">nd'</span>
                           <span class="main">⟶</span> <span class="free">η</span> <span class="main">∈</span> old <span class="skolem">nd</span> <span class="main">∨</span> <span class="free">μ</span> <span class="main">∈</span> old <span class="skolem">nd</span> <span class="main">∧</span> <span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="skolem">nd'</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nd'_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span><span class="main">∈</span>upd_incoming <span class="skolem">n</span> <span class="skolem">ns</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> prems' <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?U_prop</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">ns</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span><span class="main">∉</span><span class="skolem">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        U_in_nd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="skolem">nd</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span> <span class="main">∈</span>incoming <span class="skolem">nd'</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> upd_incoming__elem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">nd'</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">ns</span></span><span class="main">]</span> nd'_elem
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nd''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd''</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> nd'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span> <span class="main">=</span> <span class="skolem">nd''</span><span class="main">⦇</span>incoming <span class="main">:=</span> incoming <span class="skolem">n</span> <span class="main">∪</span> incoming <span class="skolem">nd''</span><span class="main">⦈</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> old_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"old <span class="skolem">nd''</span> <span class="main">=</span> old <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span> <span class="main">∈</span> incoming <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> prems' U_in_nd <span class="quoted"><span class="quoted">‹<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">ns</span>›</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">η</span> <span class="main">∈</span> old <span class="skolem">nd</span> <span class="main">∨</span> <span class="free">μ</span> <span class="main">∈</span> old <span class="skolem">nd</span> <span class="main">∧</span> <span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">η</span> <span class="main">∈</span> old <span class="skolem">nd</span> <span class="main">∨</span> <span class="free">μ</span> <span class="main">∈</span> old <span class="skolem">nd</span> <span class="main">∧</span> <span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="skolem">nd'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> nd'_eq old_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span> <span class="main">∉</span> incoming <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span> <span class="main">∈</span> incoming <span class="skolem">nd''</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹name <span class="skolem">nd</span> <span class="main">∈</span>incoming <span class="skolem">nd'</span>›</span></span> nd'_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">η</span> <span class="main">∈</span> old <span class="skolem">nd</span> <span class="main">∨</span> <span class="free">μ</span> <span class="main">∈</span> old <span class="skolem">nd</span> <span class="main">∧</span> <span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="skolem">nd'</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> nd'_eq
            <span class="keyword1"><span class="command">using</span></span> prems' <span class="quoted"><span class="quoted">‹<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">ns</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">nd''</span><span class="main">∈</span><span class="skolem">ns</span>›</span></span> U_in_nd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">η</span> <span class="main">∈</span> old <span class="skolem">nd</span> <span class="main">∨</span> <span class="free">μ</span> <span class="main">∈</span> old <span class="skolem">nd</span> <span class="main">∧</span> <span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="skolem">nd'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?U_prop</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f_sup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> expand <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Q <span class="keyword1"><span class="command">have</span></span> name_le<span class="main">:</span> <span class="quoted"><span class="quoted">"name <span class="skolem">n</span> <span class="main">&lt;</span> expand_new_name <span class="main">(</span>name <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦇</span>name <span class="main">=</span> expand_new_name <span class="main">(</span>name <span class="skolem">n</span><span class="main">)</span><span class="main">,</span>
               incoming <span class="main">=</span> <span class="main">{</span>name <span class="skolem">n</span><span class="main">}</span><span class="main">,</span> new <span class="main">=</span> next <span class="skolem">n</span><span class="main">,</span>
               old <span class="main">=</span> <span class="main">{}</span><span class="main">,</span> next <span class="main">=</span> <span class="main">{}</span><span class="main">⦈</span><span class="main">,</span> <span class="main">{</span><span class="skolem">n</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> Q'1<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_assm_incoming <span class="var">?x'</span><span class="main">∧</span> expand_name_ident <span class="main">(</span>snd <span class="var">?x'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹new <span class="skolem">n</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> Q<span class="main">[</span><span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">]</span> name_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> Q'2<span class="main">:</span> <span class="quoted"><span class="quoted">"until_propag__assm <span class="free">μ</span> <span class="free">η</span> <span class="var">?x'</span> <span class="main">∧</span> until_propag__rslt <span class="free">μ</span> <span class="free">η</span> <span class="main">(</span>snd <span class="var">?x'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Q <span class="quoted"><span class="quoted">‹new <span class="skolem">n</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹new <span class="skolem">n</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_weak<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span>
      Q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="bound">r</span><span class="main">.</span> expand_name_ident <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="var">?P</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Q'1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule_tac</span> f_sup<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule_tac</span> expand_name_propag__name_ident<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Q'1 Q'2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">nm</span> <span class="skolem">nds</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>4 <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>5 <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 6
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>7 <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>8 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> goal_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> new <span class="skolem">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ν</span> <span class="bound">μ</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> f_sup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> expand <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">,</span> new <span class="main">:=</span> new1 <span class="skolem">ψ</span> <span class="main">∪</span> new <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span><span class="main">,</span>
        old <span class="main">:=</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span> <span class="main">∪</span> old <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span><span class="main">,</span>
                            next <span class="main">:=</span> next1 <span class="skolem">ψ</span> <span class="main">∪</span> next <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span>
       <span class="main">⦈</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?props</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">r</span><span class="main">.</span> expand_rslt_exist_eq <span class="bound">x</span> <span class="bound">r</span>
    <span class="main">∧</span> expand_rslt_incoming <span class="bound">r</span> <span class="main">∧</span> expand_rslt_name <span class="bound">x</span> <span class="bound">r</span> <span class="main">∧</span> expand_name_ident <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> goal_assms Q <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_weak_nested2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?props</span> <span class="var">?x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_conjI<span class="main"><span class="keyword3">,</span></span>
             <span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span>
             <span class="operator">rule_tac</span> f_sup<span class="main"><span class="keyword3">,</span></span>
             <span class="operator">rule_tac</span> expand_rslt_exist_eq<span class="main"><span class="keyword3">,</span></span>
             <span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span>
             <span class="operator">rule_tac</span> f_sup<span class="main"><span class="keyword3">,</span></span>
             <span class="operator">rule_tac</span> expand_name_propag<span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_param2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="var">?P</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>3 <span class="skolem">nm</span> <span class="skolem">nds</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">,</span>
       name <span class="main">:=</span> fst <span class="main">(</span><span class="skolem">nm</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span><span class="main">,</span>
       new <span class="main">:=</span> new2 <span class="skolem">ψ</span> <span class="main">∪</span> new <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span><span class="main">,</span>
       old <span class="main">:=</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span> <span class="main">∪</span> old <span class="main">(</span><span class="skolem">n</span><span class="main">⦇</span>new <span class="main">:=</span> new <span class="skolem">n</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span><span class="main">⦈</span><span class="main">)</span><span class="main">⦈</span><span class="main">,</span> <span class="skolem">nds</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> prems'<span class="main">:</span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_assm_incoming <span class="var">?x'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> prems' <span class="keyword1"><span class="command">have</span></span> nds_ident<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_name_ident <span class="main">(</span>snd <span class="var">?x'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span>
             <span class="main">⟶</span> <span class="main">(</span><span class="free">η</span><span class="main">∈</span>old <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span><span class="main">∪</span>new <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span>
                  <span class="main">∨</span> <span class="main">(</span><span class="free">μ</span><span class="main">∈</span>old <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span><span class="main">∪</span>new <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span>
                     <span class="main">∧</span> <span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> next <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Q<span class="main">[</span><span class="operator">THEN</span> conjunct1<span class="main">]</span> goal_assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> prems' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"until_propag__rslt <span class="free">μ</span> <span class="free">η</span> <span class="main">(</span>snd <span class="var">?x'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> prems' <span class="keyword1"><span class="command">have</span></span> name_nds_eq<span class="main">:</span>
        <span class="quoted"><span class="quoted">"name <span class="main">`</span> <span class="skolem">nds</span> <span class="main">=</span> name <span class="main">`</span> <span class="skolem">ns</span> <span class="main">∪</span> name <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">nd</span></span><span class="main">∈</span><span class="skolem">nds</span><span class="main">.</span> name <span class="bound">nd</span> <span class="main">≥</span> name <span class="skolem">n</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span><span class="skolem">nds</span><span class="main">.</span> <span class="main">(</span><span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="bound">nd</span> <span class="main">∧</span> name <span class="bound">nd</span> <span class="main">∈</span> incoming <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span><span class="main">)</span>
        <span class="main">⟶</span> <span class="main">(</span><span class="free">η</span><span class="main">∈</span>old <span class="bound">nd</span> <span class="main">∨</span> <span class="main">(</span><span class="free">μ</span><span class="main">∈</span>old <span class="bound">nd</span> <span class="main">∧</span> <span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span>old <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span><span class="main">∪</span>new <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span><span class="skolem">nds</span><span class="main">.</span> <span class="var">?assm</span> <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="bound">nd</span> <span class="main">⟶</span> <span class="var">?concl</span> <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="bound">nd</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">nd</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">nds</span>"</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> loc_assm<span class="main">:</span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span><span class="main">∈</span>name <span class="main">`</span> <span class="skolem">ns</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> n'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">n'</span> <span class="main">=</span> name <span class="skolem">nd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">from</span></span> prems' n' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nd'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span><span class="main">∈</span><span class="skolem">nds</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> n'_nd'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_rslt_exist_eq__node <span class="skolem">n'</span> <span class="skolem">nd'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span> <span class="main">=</span> <span class="skolem">nd'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> nds_ident <span class="quoted"><span class="quoted">‹<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">nds</span>›</span></span> loc_assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> prems' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?assm</span> <span class="skolem">n</span> <span class="skolem">n'</span> <span class="main">⟶</span> <span class="var">?concl</span> <span class="skolem">n</span> <span class="skolem">n'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span><span class="main">∈</span><span class="skolem">ns</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?assm</span> <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="skolem">nd</span> <span class="main">⟶</span> <span class="var">?concl</span> <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="skolem">nd</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> n'_nd'_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span><span class="main">∉</span>name <span class="main">`</span> <span class="skolem">ns</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> name_nds_eq <span class="quoted"><span class="quoted">‹<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">nds</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">nd</span> <span class="main">≥</span> name <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> prems' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="var">?assm</span> <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="skolem">nd</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?assm</span> <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="skolem">nd</span> <span class="main">⟶</span> <span class="var">?concl</span> <span class="main">(</span>fst <span class="var">?x'</span><span class="main">)</span> <span class="skolem">nd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> until_propag_on_create_graph<span class="main">:</span>
  <span class="quoted"><span class="quoted">"create_graph <span class="free">φ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">nds</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n</span><span class="main">∈</span><span class="bound">nds</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n'</span><span class="main">∈</span><span class="bound">nds</span><span class="main">.</span> <span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span><span class="main">∈</span>old <span class="bound">n</span> <span class="main">∧</span> name <span class="bound">n</span><span class="main">∈</span>incoming <span class="bound">n'</span>
    <span class="main">⟶</span> <span class="main">(</span><span class="free">η</span><span class="main">∈</span>old <span class="bound">n</span> <span class="main">∨</span> <span class="free">μ</span><span class="main">∈</span>old <span class="bound">n</span> <span class="main">∧</span> <span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span><span class="main">∈</span>old <span class="bound">n'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_graph_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> expand_until_propag<span class="main">)</span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>expand_new_name_expand_init<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_subfrmls</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> node <span class="main">⇒</span> <span class="tfree">'a</span> frml set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">all_subfrmls</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="main">(</span>subfrmlsr <span class="main">`</span> <span class="main">(</span>new <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∪</span> old <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∪</span> next <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> all_subfrmls__UnionD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> subfrmlsr <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">∈</span>subfrmlsr <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">∈</span><span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> subfrmlsr_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subfrmlsr <span class="free">x</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> subfrmlsr <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> expand_all_subfrmls_propag<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"all_subfrmls <span class="main">(</span>fst <span class="free">n_ns</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span>snd <span class="free">n_ns</span><span class="main">.</span> all_subfrmls <span class="bound">nd</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">n_ns</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"expand <span class="free">n_ns</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span>snd <span class="bound">r</span><span class="main">.</span> all_subfrmls <span class="bound">nd</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> expand_rec_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Φ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="var">?Q</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> upd_incoming__ident<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_subfrmls_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_subfrmls_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_subfrmls_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>4 <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_subfrmls_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>5 <span class="skolem">f</span> _ <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> goal_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> new <span class="skolem">n</span> <span class="main">∧</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">true<span class="hidden">⇩</span><sub>r</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Q goal_assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> all_subfrmls__UnionD <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_subfrmls_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 6
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>7 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> goal_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> new <span class="skolem">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ν</span> <span class="bound">μ</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ν</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Q goal_assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> all_subfrmls__UnionD <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_subfrmls_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>8 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> goal_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> new <span class="skolem">n</span>
    <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">prop<span class="hidden">⇩</span><sub>r</sub>(</span><span class="bound">q</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">nprop<span class="hidden">⇩</span><sub>r</sub>(</span><span class="bound">q</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> <span class="skolem">ψ</span> <span class="main">≠</span> <span class="keyword1">true<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">∧</span> <span class="skolem">ψ</span> <span class="main">≠</span> <span class="keyword1">false<span class="hidden">⇩</span><sub>r</sub></span>
    <span class="main">∧</span>  <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ν</span> <span class="bound">μ</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ν</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ν</span> <span class="bound">μ</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="var">?P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> goal_assms Q <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_nested2<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> all_subfrmls__UnionD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_subfrmls_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> all_subfrmls__UnionD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_subfrmls_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> old_propag_on_create_graph<span class="main">:</span> <span class="quoted"><span class="quoted">"create_graph <span class="free">φ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">nds</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n</span><span class="main">∈</span><span class="bound">nds</span><span class="main">.</span> old <span class="bound">n</span> <span class="main">⊆</span> subfrmlsr <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_graph_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule_tac</span> expand_all_subfrmls_propag<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"subfrmlsr <span class="free">φ</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>all_subfrmls_def expand_new_name_expand_init<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> L4_2__aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"ipath gba.E <span class="free">σ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="free">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> <span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="main">(</span><span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">η</span> <span class="main">∉</span> old <span class="main">(</span><span class="free">σ</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="main">(</span><span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="free">η</span> <span class="main">∉</span> old <span class="main">(</span><span class="free">σ</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> <span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="main">(</span><span class="free">σ</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sbthm</span> <span class="skolem">j</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sbthm</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?sbthm</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> σ_k_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">η</span> <span class="main">∉</span> old <span class="main">(</span><span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>
      <span class="main">∧</span> <span class="free">σ</span> <span class="skolem">k</span><span class="main">∈</span><span class="free">qs</span> <span class="main">∧</span> <span class="free">σ</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">∈</span><span class="free">qs</span>
      <span class="main">∧</span> name <span class="main">(</span><span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> incoming <span class="main">(</span><span class="free">σ</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms run_propag_on_create_graph<span class="main">[</span><span class="operator">OF</span> run<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> inres_SPEC<span class="main">[</span><span class="operator">OF</span> res until_propag_on_create_graph<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> μ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free">μ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> η <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free">η</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="main">(</span><span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?subsetthm</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> assms σ_k_prop
        inres_SPEC<span class="main">[</span><span class="operator">OF</span> res until_propag_on_create_graph<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> μ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free">μ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> η <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free">η</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?subsetthm</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> Suc <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span><span class="main">}</span><span class="main">⊆</span>old <span class="main">(</span><span class="free">σ</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">∧</span> <span class="free">η</span><span class="main">∉</span>old <span class="main">(</span><span class="free">σ</span> <span class="skolem">l</span><span class="main">)</span>
        <span class="main">∧</span> <span class="free">σ</span> <span class="skolem">l</span><span class="main">∈</span><span class="free">qs</span> <span class="main">∧</span> <span class="free">σ</span> <span class="skolem">k</span><span class="main">∈</span><span class="free">qs</span>
        <span class="main">∧</span> name <span class="main">(</span><span class="free">σ</span> <span class="skolem">l</span><span class="main">)</span><span class="main">∈</span>incoming <span class="main">(</span><span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step assms run_propag_on_create_graph<span class="main">[</span><span class="operator">OF</span> run<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> inres_SPEC<span class="main">[</span><span class="operator">OF</span> res until_propag_on_create_graph<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> μ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free">μ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> η <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free">η</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span><span class="main">∈</span>old <span class="main">(</span><span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> σ_k_prop
        inres_SPEC<span class="main">[</span><span class="operator">OF</span> res until_propag_on_create_graph<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> μ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free">μ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> η <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free">η</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?subsetthm</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> step <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sbthm</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_SucE<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> L4_2a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ipath gba.E <span class="free">σ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="free">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="main">(</span><span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="free">η</span> <span class="main">∉</span> old <span class="main">(</span><span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>
         <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> <span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="main">(</span><span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="free">σ</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∨</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjCI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?B</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> L4_2__aux<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> L4_2b<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"ipath gba.E <span class="free">σ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="free">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ACC<span class="main">:</span> <span class="quoted"><span class="quoted">"gba.is_acc <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> <span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="main">(</span><span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="free">σ</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> contr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span><span class="main">}</span><span class="main">⊆</span>old<span class="main">(</span><span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="free">η</span><span class="main">∉</span>old<span class="main">(</span><span class="free">σ</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms L4_2a<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">μ</span></span> <span class="quoted"><span class="free">η</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="free">qs</span><span class="main">.</span> <span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="bound">q</span> <span class="main">⟶</span> <span class="free">η</span> <span class="main">∈</span> old <span class="bound">q</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> assms inres_SPEC<span class="main">[</span><span class="operator">OF</span> res old_propag_on_create_graph<span class="main">]</span> create_gba_from_nodes__ipath
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> subfrmlsr <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subsetD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span><span class="main">∈</span>gbg_F<span class="main">(</span>create_gba_from_nodes <span class="free">φ</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> S_def create_gba_from_nodes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> ACC <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gba.is_acc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> INFM_EX<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="skolem">k</span> <span class="main">∈</span> <span class="free">qs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">μ</span><span class="main">,</span> <span class="free">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span><span class="main">}</span><span class="main">⊆</span>old<span class="main">(</span><span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∧</span> <span class="free">η</span><span class="main">∉</span>old<span class="main">(</span><span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> contr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> L4_2c<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"ipath gba.E <span class="free">σ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="free">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="bound">i</span><span class="main">.</span> <span class="free">μ</span> <span class="main">∈</span> old <span class="main">(</span><span class="free">σ</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">η</span><span class="main">,</span> <span class="free">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="main">(</span><span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">i</span><span class="main">.</span> <span class="free">μ</span> <span class="main">∈</span> old <span class="main">(</span><span class="free">σ</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thm</span> <span class="skolem">i</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">0</span><span class="main">∈</span><span class="free">qs</span> <span class="main">∧</span> <span class="free">σ</span> <span class="main">1</span><span class="main">∈</span><span class="free">qs</span> <span class="main">∧</span> name <span class="main">(</span><span class="free">σ</span> <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> incoming <span class="main">(</span><span class="free">σ</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> create_gba_from_nodes__ipath assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms inres_SPEC<span class="main">[</span><span class="operator">OF</span> res release_propag_on_create_graph<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">μ</span></span> <span class="quoted"><span class="free">η</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?thm</span> <span class="skolem">k</span>›</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">η</span><span class="main">,</span> <span class="free">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="main">(</span><span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="skolem">k</span><span class="main">∈</span><span class="free">qs</span> <span class="main">∧</span> <span class="free">σ</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">∈</span><span class="free">qs</span> <span class="main">∧</span> name <span class="main">(</span><span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> incoming <span class="main">(</span><span class="free">σ</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> create_gba_from_nodes__ipath assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">∈</span> old <span class="main">(</span><span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∨</span> <span class="free">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="free">σ</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms inres_SPEC<span class="main">[</span><span class="operator">OF</span> res release_propag_on_create_graph<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">μ</span></span> <span class="quoted"><span class="free">η</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">∈</span> old <span class="main">(</span><span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="free">σ</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">∈</span><span class="free">qs</span> <span class="main">∧</span> <span class="free">σ</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">qs</span>
          <span class="main">∧</span> name <span class="main">(</span><span class="free">σ</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> incoming <span class="main">(</span><span class="free">σ</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> create_gba_from_nodes__ipath assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> assms
            inres_SPEC<span class="main">[</span><span class="operator">OF</span> res release_propag_on_create_graph<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">μ</span></span> <span class="quoted"><span class="free">η</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">k</span><span class="main">.</span> <span class="free">μ</span> <span class="main">∈</span> old <span class="main">(</span><span class="free">σ</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> L4_8'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ipath gba.E <span class="free">σ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?inf_run</span> <span class="free">σ</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"gba.is_acc <span class="free">σ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?gbarel_accept</span> <span class="free">σ</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> gba.L <span class="main">(</span><span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ξ</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lgbarel_accept</span> <span class="free">ξ</span> <span class="free">σ</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> old <span class="main">(</span><span class="free">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ψ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">ξ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True_ltlr
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False_ltlr
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> inres_SPEC<span class="main">[</span><span class="operator">OF</span> res false_propag_on_create_graph<span class="main">]</span>
      create_gba_from_nodes__ipath
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prop_ltlr <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> create_gba_from_nodes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nprop_ltlr <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> create_gba_from_nodes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_ltlr <span class="skolem">μ</span> <span class="skolem">η</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> inres_SPEC<span class="main">[</span><span class="operator">OF</span> res and_propag_on_create_graph<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">μ</span></span> <span class="quoted"><span class="skolem">η</span></span><span class="main">]</span>
      create_gba_from_nodes__ipath
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_subset semantics_ltlr.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Or_ltlr <span class="skolem">μ</span> <span class="skolem">η</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">μ</span> <span class="main">∈</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="main">0</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inres_SPEC<span class="main">[</span><span class="operator">OF</span> res or_propag_on_create_graph<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">μ</span></span> <span class="quoted"><span class="skolem">η</span></span><span class="main">]</span>
    create_gba_from_nodes__ipath
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Int_empty_left Int_insert_left_if0<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">μ</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">μ</span> <span class="main">∈</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Or_ltlr that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Or_ltlr that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Next_ltlr <span class="skolem">μ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> create_gba_from_nodes__ipath<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">σ</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">qs</span> <span class="main">∧</span> <span class="skolem">σ</span> <span class="main">1</span> <span class="main">∈</span> <span class="free">qs</span> <span class="main">∧</span> name <span class="main">(</span><span class="skolem">σ</span> <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> incoming <span class="main">(</span><span class="skolem">σ</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> inres_SPEC<span class="main">[</span><span class="operator">OF</span> res next_propag_on_create_graph<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">μ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">μ</span><span class="main">∈</span>old <span class="main">(</span>suffix <span class="main">1</span> <span class="skolem">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Next_ltlr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?inf_run</span> <span class="main">(</span>suffix <span class="main">1</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?gbarel_accept</span> <span class="main">(</span>suffix <span class="main">1</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lgbarel_accept</span> <span class="main">(</span>suffix <span class="main">1</span> <span class="skolem">ξ</span><span class="main">)</span> <span class="main">(</span>suffix <span class="main">1</span> <span class="skolem">σ</span> <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Next_ltlr create_gba_from_nodes__ipath
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ipath_suffix<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> suffix_nth<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span> <span class="comment1">(* FIXME:
      "λa. suffix i σ a" is unfolded, but "suffix i σ" is not! *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Next_ltlr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Until_ltlr <span class="skolem">μ</span> <span class="skolem">η</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> <span class="main">{</span><span class="skolem">μ</span><span class="main">,</span> <span class="skolem">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> L4_2b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ_pre<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> <span class="main">{</span><span class="skolem">μ</span><span class="main">,</span> <span class="skolem">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">η</span> <span class="main">∈</span> old <span class="main">(</span>suffix <span class="skolem">j</span> <span class="skolem">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?inf_run</span> <span class="main">(</span>suffix <span class="skolem">j</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?gbarel_accept</span> <span class="main">(</span>suffix <span class="skolem">j</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lgbarel_accept</span> <span class="main">(</span>suffix <span class="skolem">j</span> <span class="skolem">ξ</span><span class="main">)</span> <span class="main">(</span>suffix <span class="skolem">j</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> limit_suffix
    <span class="keyword1"><span class="command">using</span></span> Until_ltlr create_gba_from_nodes__ipath
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ipath_suffix<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> suffix_nth<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span> <span class="comment1">(* FIXME:
      "λa. suffix i σ a" is unfolded, but "suffix i σ" is not! *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">j</span> <span class="skolem">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Until_ltlr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?inf_run</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?gbarel_accept</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lgbarel_accept</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="skolem">ξ</span><span class="main">)</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="skolem">σ</span> <span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> limit_suffix
      <span class="keyword1"><span class="command">using</span></span> Until_ltlr create_gba_from_nodes__ipath
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ipath_suffix<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> suffix_nth<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span> <span class="comment1">(* FIXME:
        "λa. suffix i σ a" is unfolded, but "suffix i σ" is not! *)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">μ</span><span class="main">∈</span>old <span class="main">(</span>suffix <span class="skolem">i</span> <span class="skolem">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> σ_pre <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">&lt;</span><span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">i</span> <span class="skolem">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">μ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Until_ltlr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Release_ltlr <span class="skolem">μ</span> <span class="skolem">η</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">i</span><span class="main">.</span> <span class="skolem">μ</span> <span class="main">∈</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?inf_run</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?gbarel_accept</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lgbarel_accept</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="skolem">ξ</span><span class="main">)</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="skolem">σ</span> <span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> limit_suffix
        <span class="keyword1"><span class="command">using</span></span> Release_ltlr create_gba_from_nodes__ipath
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ipath_suffix<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> suffix_nth<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span> <span class="comment1">(* FIXME:
          "λa. suffix i σ a" is unfolded, but "suffix i σ" is not! *)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">i</span> <span class="skolem">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Release_ltlr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">i</span><span class="main">.</span> <span class="skolem">μ</span> <span class="main">∈</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">&lt;</span><span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">μ</span> <span class="main">∈</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?inf_run</span> <span class="main">(</span>suffix <span class="skolem">j</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?gbarel_accept</span> <span class="main">(</span>suffix <span class="skolem">j</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lgbarel_accept</span> <span class="main">(</span>suffix <span class="skolem">j</span> <span class="skolem">ξ</span><span class="main">)</span> <span class="main">(</span>suffix <span class="skolem">j</span> <span class="skolem">σ</span> <span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> limit_suffix
        <span class="keyword1"><span class="command">using</span></span> Release_ltlr create_gba_from_nodes__ipath
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ipath_suffix<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> suffix_nth<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span> <span class="comment1">(* FIXME:
          "λa. suffix i σ a" is unfolded, but "suffix i σ" is not! *)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">j</span> <span class="skolem">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">μ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Release_ltlr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">i</span><span class="main">.</span> suffix <span class="bound">j</span> <span class="skolem">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">μ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span><span class="main">&lt;</span><span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">i</span> <span class="skolem">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">i</span><span class="main">.</span> suffix <span class="bound">j</span> <span class="skolem">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">μ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Release_ltlr L4_2c <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> L4_8<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gba.is_acc_run <span class="free">σ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> gba.L <span class="main">(</span><span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ξ</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> old <span class="main">(</span><span class="free">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> gba.is_acc_run_def gba.is_run_def
  <span class="keyword1"><span class="command">using</span></span> L4_8' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> expand_expand_init_propag<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">nm</span><span class="main">∈</span>incoming <span class="free">n'</span><span class="main">.</span> <span class="bound">nm</span> <span class="main">&lt;</span> name <span class="free">n'</span><span class="main">)</span>
           <span class="main">∧</span> name <span class="free">n'</span> <span class="main">≤</span> name <span class="main">(</span>fst <span class="free">n_ns</span><span class="main">)</span>
           <span class="main">∧</span> <span class="main">(</span>incoming <span class="free">n'</span> <span class="main">∩</span> incoming <span class="main">(</span>fst <span class="free">n_ns</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>
              <span class="main">⟶</span> new <span class="free">n'</span> <span class="main">⊆</span> old <span class="main">(</span>fst <span class="free">n_ns</span><span class="main">)</span> <span class="main">∪</span> new <span class="main">(</span>fst <span class="free">n_ns</span><span class="main">)</span><span class="main">)</span>
           "</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">n_ns</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span>snd <span class="free">n_ns</span><span class="main">.</span> <span class="main">∀</span><span class="bound">nm</span><span class="main">∈</span>incoming <span class="free">n'</span><span class="main">.</span> <span class="bound">nm</span><span class="main">∈</span>incoming <span class="bound">nd</span> <span class="main">⟶</span> new <span class="free">n'</span> <span class="main">⊆</span> old <span class="bound">nd</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>snd <span class="free">n_ns</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"expand <span class="free">n_ns</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> name <span class="free">n'</span><span class="main">≤</span>fst <span class="bound">r</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> expand_rec_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Φ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> goal_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"new <span class="skolem">n</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?P</span> <span class="skolem">ns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">nd</span> <span class="skolem">nm</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span><span class="main">∈</span>upd_incoming <span class="skolem">n</span> <span class="skolem">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nm</span><span class="main">∈</span>incoming <span class="free">n'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nm</span><span class="main">∈</span>incoming <span class="skolem">nd</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> goal_assms <span class="quoted"><span class="quoted">‹<span class="skolem">nm</span><span class="main">∈</span>incoming <span class="free">n'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">nm</span><span class="main">∈</span>incoming <span class="skolem">nd</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"new <span class="free">n'</span> <span class="main">⊆</span> old <span class="skolem">nd</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span><span class="main">∉</span><span class="skolem">ns</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> upd_incoming__elem<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">nd</span><span class="main">∈</span>upd_incoming <span class="skolem">n</span> <span class="skolem">ns</span>›</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nd'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nd'</span><span class="main">∈</span><span class="skolem">ns</span>"</span></span>
                   <span class="keyword2"><span class="keyword">and</span></span> nd_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nd</span> <span class="main">=</span> <span class="skolem">nd'</span><span class="main">⦇</span>incoming <span class="main">:=</span> incoming <span class="skolem">n</span> <span class="main">∪</span> incoming <span class="skolem">nd'</span><span class="main">⦈</span>"</span></span>
                   <span class="keyword2"><span class="keyword">and</span></span> old_next_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"old <span class="skolem">nd'</span> <span class="main">=</span> old <span class="skolem">n</span> <span class="main">∧</span> next <span class="skolem">nd'</span> <span class="main">=</span> next <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nm</span><span class="main">∈</span>incoming <span class="skolem">nd'</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> goal_assms <span class="quoted"><span class="quoted">‹<span class="skolem">nm</span><span class="main">∈</span>incoming <span class="free">n'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">nd'</span><span class="main">∈</span><span class="skolem">ns</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"new <span class="free">n'</span> <span class="main">⊆</span> old <span class="skolem">nd</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> nd_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nm</span><span class="main">∈</span>incoming <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> nd_eq old_next_eq goal_assms <span class="quoted"><span class="quoted">‹<span class="skolem">nm</span><span class="main">∈</span>incoming <span class="free">n'</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"new <span class="free">n'</span> <span class="main">⊆</span> old <span class="skolem">nd</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"new <span class="free">n'</span> <span class="main">⊆</span> old <span class="skolem">nd</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">nm</span><span class="main">∈</span>incoming <span class="skolem">nd</span>›</span></span> nd_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"new <span class="free">n'</span> <span class="main">⊆</span> old <span class="skolem">nd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> goal_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"new <span class="skolem">n</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?P</span> <span class="skolem">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span>
      <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> name <span class="free">n'</span> <span class="main">≤</span> fst <span class="bound">r</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> prems'<span class="main">:</span> 1
    <span class="keyword1"><span class="command">have</span></span> expand_new_name_less<span class="main">:</span> <span class="quoted"><span class="quoted">"name <span class="skolem">n</span> <span class="main">&lt;</span> expand_new_name <span class="main">(</span>name <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"name <span class="skolem">n</span> <span class="main">∉</span> incoming <span class="free">n'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> goal_assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> prems' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>4 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> name <span class="free">n'</span> <span class="main">≤</span> fst <span class="bound">r</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>5 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> name <span class="free">n'</span> <span class="main">≤</span> fst <span class="bound">r</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 6 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>7 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> name <span class="free">n'</span> <span class="main">≤</span> fst <span class="bound">r</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>8 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> goal_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> new <span class="skolem">n</span>
    <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">prop<span class="hidden">⇩</span><sub>r</sub>(</span><span class="bound">q</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">nprop<span class="hidden">⇩</span><sub>r</sub>(</span><span class="bound">q</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> <span class="skolem">ψ</span> <span class="main">≠</span> <span class="keyword1">true<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">∧</span> <span class="skolem">ψ</span> <span class="main">≠</span> <span class="keyword1">false<span class="hidden">⇩</span><sub>r</sub></span>
    <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ν</span> <span class="bound">μ</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ν</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ν</span> <span class="bound">μ</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="bound">ν</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> QP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?P</span> <span class="skolem">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> name <span class="free">n'</span> <span class="main">≤</span> fst <span class="bound">r</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> goal_assms QP <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule_nested2<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> step<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> expand_init_propag_on_create_graph<span class="main">:</span>
  <span class="quoted"><span class="quoted">"create_graph <span class="free">φ</span> <span class="main">≤</span> SPEC<span class="main">(</span><span class="main">λ</span><span class="bound">nds</span><span class="main">.</span> <span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span><span class="bound">nds</span><span class="main">.</span> expand_init<span class="main">∈</span>incoming <span class="bound">nd</span> <span class="main">⟶</span> <span class="free">φ</span> <span class="main">∈</span> old <span class="bound">nd</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_graph_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> order_trans<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">rule_tac</span> expand_expand_init_propag<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span>
          n' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">⦇</span> name <span class="main">=</span> expand_new_name expand_init<span class="main">,</span>
          incoming <span class="main">=</span> <span class="main">{</span>expand_init<span class="main">}</span><span class="main">,</span>
          new <span class="main">=</span> <span class="main">{</span><span class="free">φ</span><span class="main">}</span><span class="main">,</span>
          old <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
          next <span class="main">=</span> <span class="main">{}</span> <span class="main">⦈</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>expand_new_name_expand_init<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> L4_6<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">∈</span>gba.V0"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span><span class="main">∈</span>old <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms inres_SPEC<span class="main">[</span><span class="operator">OF</span> res expand_init_propag_on_create_graph<span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_gba_from_nodes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> L4_9<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> acc<span class="main">:</span> <span class="quoted"><span class="quoted">"gba.accept <span class="free">ξ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> acc <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> accept<span class="main">:</span> <span class="quoted"><span class="quoted">"gba.is_acc_run <span class="skolem">σ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> gba.L <span class="main">(</span><span class="skolem">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ξ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gba.accept_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">0</span><span class="main">∈</span>gba.V0"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gba.is_acc_run_def gba.is_run_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> L4_6 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span><span class="main">∈</span>old <span class="main">(</span><span class="skolem">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> L4_8 accept <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> L4_10<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gba.accept <span class="free">ξ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">=</span> auto_run <span class="free">ξ</span> <span class="free">qs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"create_graph <span class="free">φ</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> σ_prop_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ</span> <span class="main">0</span><span class="main">)</span><span class="main">∈</span><span class="free">qs</span> <span class="main">∧</span> expand_init<span class="main">∈</span>incoming<span class="main">(</span><span class="skolem">σ</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> auto_run_j <span class="main">0</span> <span class="free">ξ</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sbthm</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> inres_SPEC<span class="main">[</span><span class="operator">OF</span> res L4_7<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">φ</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> σ_def auto_run.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> someI_ex<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> σ_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">σ</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">qs</span> <span class="main">∧</span> auto_run_j <span class="bound">j</span> <span class="free">ξ</span> <span class="main">(</span><span class="skolem">σ</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="var">?σ_valid</span> <span class="bound">j</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?σ_valid</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> σ_prop_0 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?σ_valid</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> goal_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">k</span> <span class="main">∈</span> <span class="free">qs</span> <span class="main">∧</span> auto_run_j <span class="skolem">k</span> <span class="free">ξ</span> <span class="main">(</span><span class="skolem">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> inres_SPEC<span class="main">[</span><span class="operator">OF</span> res L4_5<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">k</span> <span class="free">ξ</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> sbthm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q'</span><span class="main">.</span> <span class="bound">q'</span><span class="main">∈</span><span class="free">qs</span> <span class="main">∧</span> name <span class="main">(</span><span class="skolem">σ</span> <span class="skolem">k</span><span class="main">)</span><span class="main">∈</span>incoming <span class="bound">q'</span> <span class="main">∧</span> auto_run_j <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">ξ</span> <span class="bound">q'</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q'</span><span class="main">.</span> <span class="var">?sbthm</span> <span class="bound">q'</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sbthm</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> sbthm<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> σ_def auto_run.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?σ_valid</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> σ_prop_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="skolem">σ</span> <span class="bound">k</span><span class="main">∈</span> <span class="free">qs</span> <span class="main">∧</span> <span class="skolem">σ</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">∈</span><span class="free">qs</span>
    <span class="main">∧</span> name <span class="main">(</span><span class="skolem">σ</span> <span class="bound">k</span><span class="main">)</span><span class="main">∈</span>incoming <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> auto_run_j <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="free">ξ</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">from</span></span> σ_valid <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">k</span> <span class="main">∈</span> <span class="free">qs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auto_run_j <span class="skolem">k</span> <span class="free">ξ</span> <span class="main">(</span><span class="skolem">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">with</span></span> inres_SPEC<span class="main">[</span><span class="operator">OF</span> res L4_5<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">k</span> <span class="free">ξ</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> sbthm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q'</span><span class="main">.</span> <span class="bound">q'</span><span class="main">∈</span><span class="free">qs</span> <span class="main">∧</span> name <span class="main">(</span><span class="skolem">σ</span> <span class="skolem">k</span><span class="main">)</span><span class="main">∈</span>incoming <span class="bound">q'</span>
      <span class="main">∧</span> auto_run_j <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">ξ</span> <span class="bound">q'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q'</span><span class="main">.</span> <span class="var">?sbthm</span> <span class="bound">q'</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">k</span><span class="main">∈</span> <span class="free">qs</span> <span class="main">∧</span> <span class="var">?sbthm</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">σ</span> <span class="skolem">k</span><span class="main">∈</span><span class="free">qs</span>›</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> sbthm<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> σ_def auto_run.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> σ_vnaccpt<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="bound">μ</span> <span class="bound">η</span><span class="main">.</span> <span class="bound">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span><span class="bound">μ</span><span class="main">,</span> <span class="bound">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">η</span> <span class="main">∉</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">μ</span> <span class="skolem">η</span>
    <span class="keyword3"><span class="command">assume</span></span> U_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cntr_prm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span><span class="skolem">μ</span><span class="main">,</span> <span class="skolem">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">η</span> <span class="main">∉</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">k</span> <span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> U_in σ_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"suffix <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">i</span><span class="main">)</span> <span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">i</span><span class="main">.</span> suffix <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="bound">j</span><span class="main">)</span> <span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">μ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">η</span> <span class="main">∉</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cntr_prm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> σ_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> σ_exec<span class="main">:</span> <span class="quoted"><span class="quoted">"gba.is_run <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> σ_prop_0 σ_prop_Suc σ_valid
    <span class="keyword1"><span class="command">unfolding</span></span> gba.is_run_def ipath_def
    <span class="keyword1"><span class="command">unfolding</span></span> create_gba_from_nodes_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> σ_vaccpt<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="bound">μ</span> <span class="bound">η</span><span class="main">.</span> <span class="bound">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> <span class="main">{</span><span class="bound">μ</span><span class="main">,</span> <span class="bound">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">μ</span> <span class="skolem">η</span>
    <span class="keyword3"><span class="command">assume</span></span> U_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span><span class="skolem">μ</span><span class="main">,</span> <span class="skolem">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="main">(</span>suffix <span class="skolem">k</span> <span class="skolem">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">η</span> <span class="main">∉</span> old <span class="main">(</span>suffix <span class="skolem">k</span> <span class="skolem">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> σ_vnaccpt<span class="main">[</span><span class="operator">THEN</span> allE<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">k</span> <span class="skolem">σ</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">qs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> <span class="main">{</span><span class="skolem">μ</span><span class="main">,</span> <span class="skolem">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span><span class="main">}</span> <span class="main">⊆</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> make_pos_rule'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> L4_2a<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> suffix_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ipath_suffix<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> σ_exec<span class="main">[</span><span class="operator">unfolded</span> gba.is_run_def<span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> U_in <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gba.is_acc <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gba.is_acc_def
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span><span class="main">∈</span>gba.F"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μ</span></span> <span class="skolem"><span class="skolem">η</span></span> <span class="keyword2"><span class="keyword">where</span></span> S_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="free">qs</span><span class="main">.</span> <span class="skolem">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span> <span class="main">∈</span> old <span class="bound">q</span> <span class="main">⟶</span> <span class="skolem">η</span> <span class="main">∈</span> old <span class="bound">q</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span> <span class="main">∈</span> subfrmlsr <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> create_gba_from_nodes_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> range_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="skolem">σ</span> <span class="main">⊆</span> <span class="free">qs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span><span class="main">∈</span>range <span class="skolem">σ</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> full_SetCompr_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">σ</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="free">qs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> limit_nonempty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">σ</span></span><span class="main">]</span>
         limit_in_range<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">σ</span></span><span class="main">]</span>
         finite_subset<span class="main">[</span><span class="operator">OF</span> range_subset<span class="main">]</span>
         inres_SPEC<span class="main">[</span><span class="operator">OF</span> res create_graph_finite<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q_in_limit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> limit <span class="skolem">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> q_is_node<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span><span class="main">∈</span><span class="free">qs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="skolem">σ</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span> <span class="main">∈</span> old <span class="skolem">q</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> S_eq q_in_limit q_is_node
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> limit_iff_frequent <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> INFM_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> q_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q_in_limit
        <span class="keyword1"><span class="command">unfolding</span></span> limit_iff_frequent <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> full_types<span class="main"><span class="main">)</span></span> INFM_nat_le<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">k</span><span class="main">.</span> <span class="skolem">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> INFM_nat
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound">m</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&gt;</span><span class="bound">m</span><span class="main">.</span> <span class="skolem">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&gt;</span><span class="skolem">m</span><span class="main">.</span> <span class="skolem">η</span> <span class="main">∉</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> q_eq q_in_limit limit_iff_frequent<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">σ</span></span><span class="main">]</span> INFM_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">σ</span> <span class="bound">n</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">&lt;</span><span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> σn_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> σ_vaccpt <span class="quoted"><span class="quoted">‹<span class="skolem">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="skolem">η</span> <span class="main">∈</span> old <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> σn_eq<span class="main">)</span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">k</span><span class="main">.</span> <span class="skolem">σ</span> <span class="bound">k</span> <span class="main">∈</span> <span class="free">qs</span> <span class="main">∧</span> <span class="skolem">η</span> <span class="main">∈</span> old <span class="main">(</span><span class="skolem">σ</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> σ_valid <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> INF_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">k</span><span class="main">.</span> <span class="skolem">σ</span> <span class="bound">k</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> S_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> INFM_mono<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gba.L <span class="main">(</span><span class="skolem">σ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ξ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> σ_valid <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="free">qs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span>old <span class="main">(</span><span class="skolem">σ</span> <span class="skolem">i</span><span class="main">)</span><span class="main">.</span> suffix <span class="skolem">i</span> <span class="free">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ψ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> σ_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> create_gba_from_nodes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gba.accept_def gba.is_acc_run_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> create_graph__name_ident<span class="main">:</span> <span class="quoted"><span class="quoted">"create_graph <span class="free">φ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">nds</span><span class="main">.</span> <span class="main">∀</span><span class="bound">q</span><span class="main">∈</span><span class="bound">nds</span><span class="main">.</span> <span class="main">∃!</span><span class="bound"><span class="bound">q'</span></span><span class="main">∈</span><span class="bound">nds</span><span class="main">.</span> name <span class="bound">q</span> <span class="main">=</span> name <span class="bound">q'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_graph_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> expand_name_propag__name_ident<span class="main">)</span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>expand_new_name_expand_init<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> create_graph__name_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"create_graph <span class="free">φ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">nds</span><span class="main">.</span> inj_on name <span class="bound">nds</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> create_graph__name_ident<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_onI<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">create_gba</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>
   <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">nds</span> <span class="main">←</span> create_graph<span class="hidden">⇩</span><sub>T</sub> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span>
          RETURN <span class="main">(</span>create_gba_from_nodes <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">nds</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> create_graph_precond<span class="main">:</span> <span class="quoted"><span class="quoted">"create_graph <span class="free">φ</span>
  <span class="main">≤</span> SPEC <span class="main">(</span>create_gba_from_nodes_precond <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff create_graph_nofail<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> create_gba__invar<span class="main">:</span> <span class="quoted"><span class="quoted">"create_gba <span class="free">φ</span> <span class="main">≤</span> SPEC gba"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_gba_def create_graph_eq_create_graph<span class="hidden">⇩</span><sub>T</sub><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> create_graph_precond<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> create_gba_from_nodes_precond.create_gba_from_nodes__invar<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> create_gba_acc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"create_gba <span class="free">φ</span> <span class="main">≤</span> SPEC<span class="main">(</span><span class="main">λ</span><span class="bound">𝒜</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ξ</span><span class="main">.</span> gba.accept <span class="bound">𝒜</span> <span class="bound">ξ</span> <span class="main">⟷</span> <span class="bound">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_gba_def create_graph_eq_create_graph<span class="hidden">⇩</span><sub>T</sub><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> create_graph_precond<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> create_gba_from_nodes_precond.L4_9
  <span class="keyword1"><span class="command">using</span></span> create_gba_from_nodes_precond.L4_10
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> create_gba__name_inj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"create_gba <span class="free">φ</span> <span class="main">≤</span> SPEC<span class="main">(</span><span class="main">λ</span><span class="bound">𝒜</span><span class="main">.</span> <span class="main">(</span>inj_on name <span class="main">(</span>g_V <span class="bound">𝒜</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_gba_def create_graph_eq_create_graph<span class="hidden">⇩</span><sub>T</sub><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> create_graph__name_inj<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> create_gba_from_nodes_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> create_gba__fin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"create_gba <span class="free">φ</span> <span class="main">≤</span> SPEC<span class="main">(</span><span class="main">λ</span><span class="bound">𝒜</span><span class="main">.</span> <span class="main">(</span>finite <span class="main">(</span>g_V <span class="bound">𝒜</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_gba_def create_graph_eq_create_graph<span class="hidden">⇩</span><sub>T</sub><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> create_graph_finite<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> create_gba_from_nodes_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> create_graph_old_finite<span class="main">:</span>
  <span class="quoted"><span class="quoted">"create_graph <span class="free">φ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">nds</span><span class="main">.</span> <span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span><span class="bound">nds</span><span class="main">.</span> finite <span class="main">(</span>old <span class="bound">nd</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> create_graph_def create_graph_eq_create_graph<span class="hidden">⇩</span><sub>T</sub><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> expand_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> order_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> REC_le_RECT<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> expand<span class="hidden">⇩</span><sub>T</sub>_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> expand_term_prop<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> SPEC_rule<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> infinite_super subfrmlsr_finite<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> create_gba__old_fin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"create_gba <span class="free">φ</span> <span class="main">≤</span> SPEC<span class="main">(</span><span class="main">λ</span><span class="bound">𝒜</span><span class="main">.</span> <span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span>g_V <span class="bound">𝒜</span><span class="main">.</span> finite <span class="main">(</span>old <span class="bound">nd</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_gba_def create_graph_eq_create_graph<span class="hidden">⇩</span><sub>T</sub><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> create_graph_old_finite<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> create_gba_from_nodes_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> create_gba__incoming_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"create_gba <span class="free">φ</span>
  <span class="main">≤</span> SPEC<span class="main">(</span><span class="main">λ</span><span class="bound">𝒜</span><span class="main">.</span> <span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span>g_V <span class="bound">𝒜</span><span class="main">.</span> incoming <span class="bound">nd</span> <span class="main">⊆</span> insert expand_init <span class="main">(</span>name <span class="main">`</span> <span class="main">(</span>g_V <span class="bound">𝒜</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_gba_def create_graph_eq_create_graph<span class="hidden">⇩</span><sub>T</sub><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> create_graph__incoming_name_exist<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> create_gba_from_nodes_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> create_gba__no_init<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"create_gba <span class="free">φ</span> <span class="main">≤</span> SPEC<span class="main">(</span><span class="main">λ</span><span class="bound">𝒜</span><span class="main">.</span> expand_init <span class="main">∉</span> name <span class="main">`</span> <span class="main">(</span>g_V <span class="bound">𝒜</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_gba_def create_graph_eq_create_graph<span class="hidden">⇩</span><sub>T</sub><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> create_graph__incoming_name_exist<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> create_gba_from_nodes_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">nds_invars</span> <span class="free"><span class="bound"><span class="entity">nds</span></span></span> <span class="main">≡</span>
  inj_on name <span class="free"><span class="bound"><span class="entity">nds</span></span></span>
  <span class="main">∧</span> finite <span class="free"><span class="bound"><span class="entity">nds</span></span></span>
  <span class="main">∧</span> expand_init <span class="main">∉</span> name<span class="main">`</span><span class="free"><span class="bound"><span class="entity">nds</span></span></span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">nd</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">nds</span></span></span><span class="main">.</span>
    finite <span class="main">(</span>old <span class="bound">nd</span><span class="main">)</span>
    <span class="main">∧</span> incoming <span class="bound">nd</span> <span class="main">⊆</span> insert expand_init <span class="main">(</span>name <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">nds</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> create_gba_nds_invars<span class="main">:</span> <span class="quoted"><span class="quoted">"create_gba <span class="free">φ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">𝒜</span><span class="main">.</span> nds_invars <span class="main">(</span>g_V <span class="bound">𝒜</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> create_gba__name_inj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span><span class="main">]</span> create_gba__fin<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span><span class="main">]</span>
    create_gba__old_fin<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span><span class="main">]</span> create_gba__incoming_exists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span><span class="main">]</span>
    create_gba__no_init<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> nds_invars_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> T4_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"create_gba <span class="free">φ</span> <span class="main">≤</span> SPEC<span class="main">(</span>
    <span class="main">λ</span><span class="bound">𝒜</span><span class="main">.</span> gba <span class="bound">𝒜</span>
    <span class="main">∧</span> finite <span class="main">(</span>g_V <span class="bound">𝒜</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ξ</span><span class="main">.</span> gba.accept <span class="bound">𝒜</span> <span class="bound">ξ</span> <span class="main">⟷</span> <span class="bound">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">φ</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span>nds_invars <span class="main">(</span>g_V <span class="bound">𝒜</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> create_gba__invar create_gba__fin create_gba_acc create_gba_nds_invars
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">create_name_gba</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">G</span> <span class="main">←</span> create_gba <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span>
  ASSERT <span class="main">(</span>nds_invars <span class="main">(</span>g_V <span class="bound">G</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
  RETURN <span class="main">(</span>gba_rename name <span class="bound">G</span><span class="main">)</span>
<span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">theorem</span></span> create_name_gba_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"create_name_gba <span class="free">φ</span> <span class="main">≤</span> SPEC<span class="main">(</span><span class="main">λ</span><span class="bound">𝒜</span><span class="main">.</span> gba <span class="bound">𝒜</span> <span class="main">∧</span> finite <span class="main">(</span>g_V <span class="bound">𝒜</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ξ</span><span class="main">.</span> gba.accept <span class="bound">𝒜</span> <span class="bound">ξ</span> <span class="main">⟷</span> <span class="bound">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_name_gba_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> T4_1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nds_invars_def gba_rename_correct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">create_name_igba</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder ltlr <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">create_name_igba</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">A</span> <span class="main">←</span> create_name_gba <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span>
  <span class="bound">A'</span> <span class="main">←</span> gba_to_idx <span class="bound">A</span><span class="main">;</span>
  stat_set_data_nres <span class="main">(</span>card <span class="main">(</span>g_V <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>card <span class="main">(</span>g_V0 <span class="bound">A'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>igbg_num_acc <span class="bound">A'</span><span class="main">)</span><span class="main">;</span>
  RETURN <span class="bound">A'</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> create_name_igba_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"create_name_igba <span class="free">φ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">G</span><span class="main">.</span>
  igba <span class="bound">G</span> <span class="main">∧</span> finite <span class="main">(</span>g_V <span class="bound">G</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ξ</span><span class="main">.</span> igba.accept <span class="bound">G</span> <span class="bound">ξ</span> <span class="main">⟷</span> <span class="bound">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_name_igba_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span>
    order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> create_name_gba_correct<span class="main"><span class="main">]</span></span>
    order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gba.gba_to_idx_ext_correct<span class="main"><span class="main">]</span></span>
    <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp_all</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat<span class="main">,</span> <span class="tfree">'a</span> set<span class="main">)</span> gba_rec"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"gba <span class="skolem">G</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>g_V <span class="skolem">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> gbg_F <span class="skolem">G</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> gba <span class="quoted"><span class="skolem">G</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_V_Fe 2 <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* For presentation in paper*)</span>
<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span> <span class="main">=</span> order_trans<span class="main">[</span><span class="operator">OF</span> create_name_gba_correct<span class="main">]</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"create_name_igba <span class="free">φ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">G</span><span class="main">.</span> igba <span class="bound">G</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ξ</span><span class="main">.</span> igba.accept <span class="bound">G</span> <span class="bound">ξ</span> <span class="main">⟷</span> <span class="bound">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_name_igba_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">refine_rcg</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp_all</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat<span class="main">,</span> <span class="tfree">'a</span> set<span class="main">)</span> gba_rec"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"gba <span class="skolem">G</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> gba <span class="quoted"><span class="skolem">G</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span> <span class="main">=</span> order_trans<span class="main">[</span><span class="operator">OF</span> gba_to_idx_ext_correct<span class="main">]</span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ξ</span><span class="main">.</span> gba.accept <span class="skolem">G</span> <span class="bound">ξ</span> <span class="main">=</span> <span class="bound">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>g_V <span class="skolem">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gba_to_idx <span class="skolem">G</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">G'</span><span class="main">.</span> igba <span class="bound">G'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ξ</span><span class="main">.</span> igba.accept <span class="bound">G'</span> <span class="bound">ξ</span> <span class="main">=</span> <span class="bound">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_rcg</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_V_Fe<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LTL_to_GBA_impl">
<div class="head">
<h1>Theory LTL_to_GBA_impl</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Refinement to Efficient Code›</span></span>
<span class="comment1">(*
  Author: Peter Lammich
  Inspired by previous version of Alexander Schimpf.
*)</span>
<span class="keyword1"><span class="command">theory</span></span> LTL_to_GBA_impl
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="LTL_to_GBA.html">LTL_to_GBA</a>
  <a href="../Deriving/Compare_Instances.html">Deriving.Compare_Instances</a>
  <a href="../CAVA_Automata/Automata_Impl.html">CAVA_Automata.Automata_Impl</a>
  <a href="../CAVA_Base/CAVA_Code_Target.html">CAVA_Base.CAVA_Code_Target</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Parametricity Setup Boilerplate›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹LTL Formulas›</span></span>

<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted">ltlr</span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">ltlr_rel</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>True_ltlr<span class="main">,</span> True_ltlr<span class="main">)</span> <span class="main">∈</span> <span class="free">ltlr_rel</span> <span class="free">R</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>False_ltlr<span class="main">,</span> False_ltlr<span class="main">)</span> <span class="main">∈</span> <span class="free">ltlr_rel</span> <span class="free">R</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span>Prop_ltlr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span>Prop_ltlr <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ltlr_rel</span> <span class="free">R</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span>Nprop_ltlr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span>Nprop_ltlr <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ltlr_rel</span> <span class="free">R</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">ltlr_rel</span> <span class="free">R</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b'</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">ltlr_rel</span> <span class="free">R</span><span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span>And_ltlr <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span>And_ltlr <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="free"><span class="bound"><span class="entity">b'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ltlr_rel</span> <span class="free">R</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">ltlr_rel</span> <span class="free">R</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b'</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">ltlr_rel</span> <span class="free">R</span><span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span>Or_ltlr <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span>Or_ltlr <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="free"><span class="bound"><span class="entity">b'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ltlr_rel</span> <span class="free">R</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">ltlr_rel</span> <span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>Next_ltlr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span>Next_ltlr <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ltlr_rel</span> <span class="free">R</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">ltlr_rel</span> <span class="free">R</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b'</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">ltlr_rel</span> <span class="free">R</span><span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span>Until_ltlr <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span>Until_ltlr <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="free"><span class="bound"><span class="entity">b'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ltlr_rel</span> <span class="free">R</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">ltlr_rel</span> <span class="free">R</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b'</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">ltlr_rel</span> <span class="free">R</span><span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span>Release_ltlr <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span>Release_ltlr <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="free"><span class="bound"><span class="entity">b'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ltlr_rel</span> <span class="free">R</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> ltlr_rel_induct<span class="main">[</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main">]</span> 
  <span class="main">=</span> ltlr_rel.induct<span class="main">[</span><span class="operator">simplified</span> relAPP_def<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">ltlr_rel</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> ltlr_rel_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword">set</span><span class="main">]</span> 
  <span class="main">=</span> ltlr_rel.cases<span class="main">[</span><span class="operator">simplified</span> relAPP_def<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">ltlr_rel</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> ltlr_rel_intros 
  <span class="main">=</span> ltlr_rel.intros<span class="main">[</span><span class="operator">simplified</span> relAPP_def<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span></span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator">of</span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">ltlr_rel</span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span></span></span></span></span></span></span> <span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator">symmetric</span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span></span></span></span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">inductive_simps</span></span> ltlr_rel_left_simps<span class="main">[</span><span class="operator">simplified</span> relAPP_def<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator">of</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">ltlr_rel</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator">symmetric</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>True_ltlr<span class="main">,</span><span class="free">z</span><span class="main">)</span> <span class="main">∈</span> ltlr_rel <span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>False_ltlr<span class="main">,</span><span class="free">z</span><span class="main">)</span> <span class="main">∈</span> ltlr_rel <span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Prop_ltlr <span class="free">p</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">∈</span> ltlr_rel <span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Nprop_ltlr <span class="free">p</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">∈</span> ltlr_rel <span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>And_ltlr <span class="free">a</span> <span class="free">b</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">∈</span> ltlr_rel <span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Or_ltlr <span class="free">a</span> <span class="free">b</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">∈</span> ltlr_rel <span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Next_ltlr <span class="free">a</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">∈</span> ltlr_rel <span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Until_ltlr <span class="free">a</span> <span class="free">b</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">∈</span> ltlr_rel <span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Release_ltlr <span class="free">a</span> <span class="free">b</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">∈</span> ltlr_rel <span class="free">R</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ltlr_rel_sv<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> SV<span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="free">R</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> single_valuedI allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">=</span><span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_use</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ltlr_rel_left_simps 
      <span class="main"><span class="keyword3">|</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> single_valuedD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> SV<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ltlr_rel_id<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">R</span> <span class="main">=</span> Id <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">=</span> Id"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp_all</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span>Id<span class="main">⟩</span>ltlr_rel"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span>Id<span class="main">⟩</span>ltlr_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ltlr_rel_intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ltlr_rel_id_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id<span class="main">⟩</span>ltlr_rel <span class="main">=</span> Id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ltlr_rel_id<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">consts</span></span> i_ltlr <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface"</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">ltlr_rel</span> <span class="quoted">i_ltlr</span><span class="main">]</span>

<span class="keyword1"><span class="command">thm</span></span> ltlr_rel_intros<span class="main">[</span><span class="operator">no_vars</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> ltlr_con_param<span class="main">[</span><span class="operator">param</span><span class="main">,</span> <span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>True_ltlr<span class="main">,</span> True_ltlr<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>False_ltlr<span class="main">,</span> False_ltlr<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Prop_ltlr<span class="main">,</span> Prop_ltlr<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Nprop_ltlr<span class="main">,</span> Nprop_ltlr<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>And_ltlr<span class="main">,</span> And_ltlr<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Or_ltlr<span class="main">,</span> Or_ltlr<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Next_ltlr<span class="main">,</span> Next_ltlr<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Until_ltlr<span class="main">,</span> Until_ltlr<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Release_ltlr<span class="main">,</span> Release_ltlr<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ltlr_rel_intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> case_ltlr_param<span class="main">[</span><span class="operator">param</span><span class="main">,</span> <span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>case_ltlr<span class="main">,</span>case_ltlr<span class="main">)</span> <span class="main">∈</span> <span class="free">Rv</span> <span class="main">→</span> <span class="free">Rv</span> <span class="main">→</span> <span class="main">(</span><span class="free">R</span> <span class="main">→</span> <span class="free">Rv</span><span class="main">)</span>
                <span class="main">→</span> <span class="main">(</span><span class="free">R</span> <span class="main">→</span> <span class="free">Rv</span><span class="main">)</span>
                  <span class="main">→</span> <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="free">Rv</span><span class="main">)</span>
                    <span class="main">→</span> <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="free">Rv</span><span class="main">)</span>
                      <span class="main">→</span> <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="free">Rv</span><span class="main">)</span>
                        <span class="main">→</span> <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="free">Rv</span><span class="main">)</span>
                          <span class="main">→</span> <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="free">Rv</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="free">Rv</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">ai</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ltlr_rel_left_simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">parametricity</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> rec_ltlr_param<span class="main">[</span><span class="operator">param</span><span class="main">,</span> <span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rec_ltlr<span class="main">,</span>rec_ltlr<span class="main">)</span> <span class="main">∈</span> <span class="free">Rv</span> <span class="main">→</span> <span class="free">Rv</span> <span class="main">→</span> <span class="main">(</span><span class="free">R</span> <span class="main">→</span> <span class="free">Rv</span><span class="main">)</span>
                <span class="main">→</span> <span class="main">(</span><span class="free">R</span> <span class="main">→</span> <span class="free">Rv</span><span class="main">)</span>
                  <span class="main">→</span> <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="free">Rv</span> <span class="main">→</span> <span class="free">Rv</span> <span class="main">→</span> <span class="free">Rv</span><span class="main">)</span>
                    <span class="main">→</span> <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="free">Rv</span> <span class="main">→</span> <span class="free">Rv</span> <span class="main">→</span> <span class="free">Rv</span><span class="main">)</span>
                      <span class="main">→</span> <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="free">Rv</span> <span class="main">→</span> <span class="free">Rv</span><span class="main">)</span>
                        <span class="main">→</span> <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="free">Rv</span> <span class="main">→</span> <span class="free">Rv</span> <span class="main">→</span> <span class="free">Rv</span><span class="main">)</span>
                          <span class="main">→</span> <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="free">Rv</span> <span class="main">→</span> <span class="free">Rv</span> <span class="main">→</span> <span class="free">Rv</span><span class="main">)</span>
                            <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="free">Rv</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> 1
  <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>10<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>1-9<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">parametricity</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> case_ltlr_mono<span class="main">[</span><span class="operator">refine_mono</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">=</span> True_ltlr <span class="main">⟹</span> <span class="free">a</span><span class="main">≤</span><span class="free">a'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">=</span> False_ltlr <span class="main">⟹</span> <span class="free">b</span><span class="main">≤</span><span class="free">b'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="free">φ</span> <span class="main">=</span> Prop_ltlr <span class="bound">p</span> <span class="main">⟹</span> <span class="free">c</span> <span class="bound">p</span><span class="main">≤</span><span class="free">c'</span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="free">φ</span> <span class="main">=</span> Nprop_ltlr <span class="bound">p</span> <span class="main">⟹</span> <span class="free">d</span> <span class="bound">p</span><span class="main">≤</span><span class="free">d'</span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">μ</span> <span class="bound">ν</span><span class="main">.</span> <span class="free">φ</span> <span class="main">=</span> And_ltlr <span class="bound">μ</span> <span class="bound">ν</span> <span class="main">⟹</span> <span class="free">e</span> <span class="bound">μ</span> <span class="bound">ν</span><span class="main">≤</span><span class="free">e'</span> <span class="bound">μ</span> <span class="bound">ν</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">μ</span> <span class="bound">ν</span><span class="main">.</span> <span class="free">φ</span> <span class="main">=</span> Or_ltlr <span class="bound">μ</span> <span class="bound">ν</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">μ</span> <span class="bound">ν</span><span class="main">≤</span><span class="free">f'</span> <span class="bound">μ</span> <span class="bound">ν</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">μ</span><span class="main">.</span> <span class="free">φ</span> <span class="main">=</span> Next_ltlr <span class="bound">μ</span> <span class="main">⟹</span> <span class="free">g</span> <span class="bound">μ</span><span class="main">≤</span><span class="free">g'</span> <span class="bound">μ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">μ</span> <span class="bound">ν</span><span class="main">.</span> <span class="free">φ</span> <span class="main">=</span> Until_ltlr <span class="bound">μ</span> <span class="bound">ν</span> <span class="main">⟹</span> <span class="free">h</span> <span class="bound">μ</span> <span class="bound">ν</span><span class="main">≤</span><span class="free">h'</span> <span class="bound">μ</span> <span class="bound">ν</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">μ</span> <span class="bound">ν</span><span class="main">.</span> <span class="free">φ</span> <span class="main">=</span> Release_ltlr <span class="bound">μ</span> <span class="bound">ν</span> <span class="main">⟹</span> <span class="free">i</span> <span class="bound">μ</span> <span class="bound">ν</span><span class="main">≤</span><span class="free">i'</span> <span class="bound">μ</span> <span class="bound">ν</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"case_ltlr <span class="free">a</span> <span class="free">b</span> <span class="free">c</span> <span class="free">d</span> <span class="free">e</span> <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">≤</span> case_ltlr <span class="free">a'</span> <span class="free">b'</span> <span class="free">c'</span> <span class="free">d'</span> <span class="free">e'</span> <span class="free">f'</span> <span class="free">g'</span> <span class="free">h'</span> <span class="free">i'</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ltlr_eq</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ltlr_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> True_ltlr <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">of</span> True_ltlr <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltlr_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> False_ltlr <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">of</span> False_ltlr <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltlr_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="main">(</span>Prop_ltlr <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">of</span> Prop_ltlr <span class="bound">p'</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">p'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltlr_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="main">(</span>Nprop_ltlr <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">of</span> Nprop_ltlr <span class="bound">p'</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">p'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltlr_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="main">(</span>And_ltlr <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> 
  <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">of</span> And_ltlr <span class="bound">μ'</span> <span class="bound">ν'</span> <span class="main">⇒</span> <span class="free">ltlr_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="bound">μ'</span> <span class="main">∧</span> <span class="free">ltlr_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="bound">ν'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltlr_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="main">(</span>Or_ltlr <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> 
  <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">of</span> Or_ltlr <span class="bound">μ'</span> <span class="bound">ν'</span> <span class="main">⇒</span> <span class="free">ltlr_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="bound">μ'</span> <span class="main">∧</span> <span class="free">ltlr_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="bound">ν'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltlr_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="main">(</span>Next_ltlr <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> 
  <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">of</span> Next_ltlr <span class="bound">φ'</span> <span class="main">⇒</span> <span class="free">ltlr_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltlr_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="main">(</span>Until_ltlr <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> 
  <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">of</span> Until_ltlr <span class="bound">μ'</span> <span class="bound">ν'</span> <span class="main">⇒</span> <span class="free">ltlr_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="bound">μ'</span> <span class="main">∧</span> <span class="free">ltlr_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="bound">ν'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltlr_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="main">(</span>Release_ltlr <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> 
  <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">of</span> 
    Release_ltlr <span class="bound">μ'</span> <span class="bound">ν'</span> <span class="main">⇒</span> <span class="free">ltlr_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="bound">μ'</span> <span class="main">∧</span> <span class="free">ltlr_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="bound">ν'</span> 
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ltlr_eq_autoref<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> EQP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">eq</span><span class="main">,</span><span class="main">(=)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">→</span> <span class="free">R</span> <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ltlr_eq <span class="free">eq</span><span class="main">,</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> bool_rel"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">μ'</span> <span class="skolem">μ</span> <span class="skolem">ν'</span> <span class="skolem">ν</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">μ'</span><span class="main">,</span><span class="skolem">μ</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ν'</span><span class="main">,</span><span class="skolem">ν</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ltlr_eq <span class="free">eq</span> <span class="skolem">μ'</span> <span class="skolem">ν'</span><span class="main">,</span> <span class="skolem">μ</span><span class="main">=</span><span class="skolem">ν</span><span class="main">)</span><span class="main">∈</span>bool_rel"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">ν'</span></span> <span class="quoted"><span class="skolem">ν</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ltlr_rel_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ltlr_rel_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ltlr_rel_cases<span class="main"><span class="keyword3">,</span></span> 
      <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EQP<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> fun_relD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> fun_relD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> IdD<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ltlr_rel_cases<span class="main"><span class="keyword3">,</span></span> 
      <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EQP<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> fun_relD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> fun_relD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> IdD<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> -1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ltlr_rel_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> -1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ltlr_rel_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> -1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ltlr_rel_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> -1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ltlr_rel_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> -1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ltlr_rel_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ltlr_dflt_cmp<span class="main">[</span><span class="operator">autoref_rules_raw</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"PREFER_id <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>dflt_cmp <span class="main">(≤)</span> <span class="main">(&lt;)</span><span class="main">,</span> dflt_cmp <span class="main">(≤)</span> <span class="main">(&lt;)</span><span class="main">)</span> 
  <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> comp_res_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  node_name_impl <span class="main">=</span> <span class="quoted">node_name</span> 

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">node_name_rel</span> <span class="main">≡</span> Id <span class="main">::</span> <span class="main">(</span>node_name_impl<span class="main">×</span>node_name<span class="main">)</span> set"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> case_ltlr_gtransfer<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="free">ai</span> <span class="main">≤</span> <span class="free">a</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="free">bi</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="free">γ</span> <span class="main">(</span><span class="free">ci</span> <span class="bound">a</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span> <span class="bound">a</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="free">γ</span> <span class="main">(</span><span class="free">di</span> <span class="bound">a</span><span class="main">)</span> <span class="main">≤</span> <span class="free">d</span> <span class="bound">a</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ltlr1</span> <span class="bound">ltlr2</span><span class="main">.</span> <span class="free">γ</span> <span class="main">(</span><span class="free">ei</span> <span class="bound">ltlr1</span> <span class="bound">ltlr2</span><span class="main">)</span> <span class="main">≤</span> <span class="free">e</span> <span class="bound">ltlr1</span> <span class="bound">ltlr2</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ltlr1</span> <span class="bound">ltlr2</span><span class="main">.</span> <span class="free">γ</span> <span class="main">(</span><span class="free">fi</span> <span class="bound">ltlr1</span> <span class="bound">ltlr2</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">ltlr1</span> <span class="bound">ltlr2</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ltlr</span><span class="main">.</span> <span class="free">γ</span> <span class="main">(</span><span class="free">gi</span> <span class="bound">ltlr</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g</span> <span class="bound">ltlr</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ltlr1</span> <span class="bound">ltlr2</span><span class="main">.</span> <span class="free">γ</span> <span class="main">(</span><span class="free">hi</span> <span class="bound">ltlr1</span> <span class="bound">ltlr2</span><span class="main">)</span> <span class="main">≤</span> <span class="free">h</span> <span class="bound">ltlr1</span> <span class="bound">ltlr2</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ltlr1</span> <span class="bound">ltlr2</span><span class="main">.</span> <span class="free">γ</span> <span class="main">(</span><span class="free">iiv</span> <span class="bound">ltlr1</span> <span class="bound">ltlr2</span><span class="main">)</span> <span class="main">≤</span> <span class="free">i</span> <span class="bound">ltlr1</span> <span class="bound">ltlr2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">(</span>case_ltlr <span class="free">ai</span> <span class="free">bi</span> <span class="free">ci</span> <span class="free">di</span> <span class="free">ei</span> <span class="free">fi</span> <span class="free">gi</span> <span class="free">hi</span> <span class="free">iiv</span> <span class="free">φ</span><span class="main">)</span> 
    <span class="main">≤</span> <span class="main">(</span>case_ltlr <span class="free">a</span> <span class="free">b</span> <span class="free">c</span> <span class="free">d</span> <span class="free">e</span> <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="free">i</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span> 
  <span class="main">=</span> case_ltlr_gtransfer<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> γ<span class="main"><span class="main">=</span></span><span class="quoted">nres_of</span><span class="main">]</span> case_ltlr_gtransfer<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> γ<span class="main"><span class="main">=</span></span><span class="quoted">RETURN</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">ai</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bi</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="free">ci</span> <span class="bound">a</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="free">di</span> <span class="bound">a</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ltlr1</span> <span class="bound">ltlr2</span><span class="main">.</span> <span class="free">ei</span> <span class="bound">ltlr1</span> <span class="bound">ltlr2</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ltlr1</span> <span class="bound">ltlr2</span><span class="main">.</span> <span class="free">fi</span> <span class="bound">ltlr1</span> <span class="bound">ltlr2</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ltlr</span><span class="main">.</span> <span class="free">gi</span> <span class="bound">ltlr</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ltlr1</span> <span class="bound">ltlr2</span><span class="main">.</span> <span class="free">hi</span> <span class="bound">ltlr1</span> <span class="bound">ltlr2</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ltlr1</span> <span class="bound">ltlr2</span><span class="main">.</span> <span class="free">iiv</span> <span class="bound">ltlr1</span> <span class="bound">ltlr2</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"case_ltlr <span class="free">ai</span> <span class="free">bi</span> <span class="free">ci</span> <span class="free">di</span> <span class="free">ei</span> <span class="free">fi</span> <span class="free">gi</span> <span class="free">hi</span> <span class="free">iiv</span> <span class="free">φ</span> <span class="main">≠</span> dSUCCEED"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Nodes›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'a</span> node_impl <span class="main">=</span>
  name_impl   <span class="main">::</span> <span class="quoted">node_name_impl</span>
  incoming_impl <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>node_name_impl<span class="main">,</span>unit<span class="main">)</span> RBT_Impl.rbt"</span></span>
  new_impl <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> frml list"</span></span>
  old_impl <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> frml list"</span></span>
  next_impl <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> frml list"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">node_rel</span> <span class="keyword2"><span class="keyword">where</span></span> node_rel_def_internal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">node_rel</span> <span class="free"><span class="bound"><span class="entity">Re</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span> 
  <span class="main">⦇</span> name_impl <span class="main">=</span> <span class="bound">namei</span><span class="main">,</span> 
    incoming_impl <span class="main">=</span> <span class="bound">inci</span><span class="main">,</span> 
    new_impl <span class="main">=</span> <span class="bound">newi</span><span class="main">,</span>
    old_impl <span class="main">=</span> <span class="bound">oldi</span><span class="main">,</span>
    next_impl <span class="main">=</span> <span class="bound">nexti</span><span class="main">,</span>
    <span class="main">…</span> <span class="main">=</span> <span class="bound">morei</span>
  <span class="main">⦈</span><span class="main">,</span> 
  <span class="main">⦇</span> name <span class="main">=</span> <span class="bound">name</span><span class="main">,</span>
    incoming <span class="main">=</span> <span class="bound">inc</span><span class="main">,</span>
    new<span class="main">=</span><span class="bound">new</span><span class="main">,</span>
    old<span class="main">=</span><span class="bound">old</span><span class="main">,</span>
    next <span class="main">=</span> <span class="bound">next</span><span class="main">,</span>
    <span class="main">…</span> <span class="main">=</span> <span class="bound">more</span>
  <span class="main">⦈</span> <span class="main">)</span> <span class="main">|</span> <span class="bound">namei</span> <span class="bound">name</span> <span class="bound">inci</span> <span class="bound">inc</span> <span class="bound">newi</span> <span class="bound">new</span> <span class="bound">oldi</span> <span class="bound">old</span> <span class="bound">nexti</span> <span class="bound">next</span> <span class="bound">morei</span> <span class="bound">more</span><span class="main">.</span> 
    <span class="main">(</span><span class="bound">namei</span><span class="main">,</span><span class="bound">name</span><span class="main">)</span><span class="main">∈</span>node_name_rel 
  <span class="main">∧</span> <span class="main">(</span><span class="bound">inci</span><span class="main">,</span><span class="bound">inc</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span>node_name_rel<span class="main">⟩</span>dflt_rs_rel 
  <span class="main">∧</span> <span class="main">(</span><span class="bound">newi</span><span class="main">,</span><span class="bound">new</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">⟩</span>ltlr_rel<span class="main">⟩</span>lss.rel
  <span class="main">∧</span> <span class="main">(</span><span class="bound">oldi</span><span class="main">,</span><span class="bound">old</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">⟩</span>ltlr_rel<span class="main">⟩</span>lss.rel
  <span class="main">∧</span> <span class="main">(</span><span class="bound">nexti</span><span class="main">,</span><span class="bound">next</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">⟩</span>ltlr_rel<span class="main">⟩</span>lss.rel
  <span class="main">∧</span> <span class="main">(</span><span class="bound">morei</span><span class="main">,</span><span class="bound">more</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Re</span></span></span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> node_rel_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel <span class="main">=</span> <span class="main">{</span><span class="main">(</span> 
  <span class="main">⦇</span> name_impl <span class="main">=</span> <span class="bound">namei</span><span class="main">,</span> 
    incoming_impl <span class="main">=</span> <span class="bound">inci</span><span class="main">,</span> 
    new_impl <span class="main">=</span> <span class="bound">newi</span><span class="main">,</span>
    old_impl <span class="main">=</span> <span class="bound">oldi</span><span class="main">,</span>
    next_impl <span class="main">=</span> <span class="bound">nexti</span><span class="main">,</span>
    <span class="main">…</span> <span class="main">=</span> <span class="bound">morei</span>
  <span class="main">⦈</span><span class="main">,</span> 
  <span class="main">⦇</span> name <span class="main">=</span> <span class="bound">name</span><span class="main">,</span>
    incoming <span class="main">=</span> <span class="bound">inc</span><span class="main">,</span>
    new<span class="main">=</span><span class="bound">new</span><span class="main">,</span>
    old<span class="main">=</span><span class="bound">old</span><span class="main">,</span>
    next <span class="main">=</span> <span class="bound">next</span><span class="main">,</span>
    <span class="main">…</span> <span class="main">=</span> <span class="bound">more</span>
  <span class="main">⦈</span> <span class="main">)</span> <span class="main">|</span> <span class="bound">namei</span> <span class="bound">name</span> <span class="bound">inci</span> <span class="bound">inc</span> <span class="bound">newi</span> <span class="bound">new</span> <span class="bound">oldi</span> <span class="bound">old</span> <span class="bound">nexti</span> <span class="bound">next</span> <span class="bound">morei</span> <span class="bound">more</span><span class="main">.</span> 
    <span class="main">(</span><span class="bound">namei</span><span class="main">,</span><span class="bound">name</span><span class="main">)</span><span class="main">∈</span>node_name_rel 
  <span class="main">∧</span> <span class="main">(</span><span class="bound">inci</span><span class="main">,</span><span class="bound">inc</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span>node_name_rel<span class="main">⟩</span>dflt_rs_rel  
  <span class="main">∧</span> <span class="main">(</span><span class="bound">newi</span><span class="main">,</span><span class="bound">new</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel<span class="main">⟩</span>lss.rel
  <span class="main">∧</span> <span class="main">(</span><span class="bound">oldi</span><span class="main">,</span><span class="bound">old</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel<span class="main">⟩</span>lss.rel
  <span class="main">∧</span> <span class="main">(</span><span class="bound">nexti</span><span class="main">,</span><span class="bound">next</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel<span class="main">⟩</span>lss.rel
  <span class="main">∧</span> <span class="main">(</span><span class="bound">morei</span><span class="main">,</span><span class="bound">more</span><span class="main">)</span><span class="main">∈</span><span class="free">Re</span>
  <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_rel_def_internal relAPP_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> node_rel_sv<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"single_valued <span class="free">Re</span> <span class="main">⟹</span> single_valued <span class="free">R</span> <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD lss.rel_sv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ltlr_rel_sv<span class="main"><span class="main">]</span></span> map2set_rel_sv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ahm_rel_sv<span class="main"><span class="main">]</span></span> 
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD<span class="main"><span class="main">[</span></span>
      <span class="operator">OF</span> map2set_rel_sv<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> rbt_map_rel_sv<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> single_valued_Id single_valued_Id<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>
    <span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">consts</span></span> i_node <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface <span class="main">⇒</span> interface"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">node_rel</span> <span class="quoted">i_node</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>node_impl_ext<span class="main">,</span> node_ext<span class="main">)</span> <span class="main">∈</span> 
  node_name_rel 
  <span class="main">→</span> <span class="main">⟨</span>node_name_rel<span class="main">⟩</span>dflt_rs_rel 
  <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel<span class="main">⟩</span>lss.rel 
  <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel<span class="main">⟩</span>lss.rel 
  <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel<span class="main">⟩</span>lss.rel 
  <span class="main">→</span> <span class="free">Re</span> 
  <span class="main">→</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> node_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>node_impl.name_impl_update<span class="main">,</span>node.name_update<span class="main">)</span> 
  <span class="main">∈</span> <span class="main">(</span>node_name_rel <span class="main">→</span> node_name_rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>node_impl.incoming_impl_update<span class="main">,</span>node.incoming_update<span class="main">)</span> 
  <span class="main">∈</span> <span class="main">(</span><span class="main">⟨</span>node_name_rel<span class="main">⟩</span>dflt_rs_rel <span class="main">→</span> <span class="main">⟨</span>node_name_rel<span class="main">⟩</span>dflt_rs_rel<span class="main">)</span> 
    <span class="main">→</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel 
    <span class="main">→</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>node_impl.new_impl_update<span class="main">,</span>node.new_update<span class="main">)</span> 
  <span class="main">∈</span> <span class="main">(</span><span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel<span class="main">⟩</span>lss.rel <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel<span class="main">⟩</span>lss.rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>node_impl.old_impl_update<span class="main">,</span>node.old_update<span class="main">)</span> 
  <span class="main">∈</span> <span class="main">(</span><span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel<span class="main">⟩</span>lss.rel <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel<span class="main">⟩</span>lss.rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>node_impl.next_impl_update<span class="main">,</span>node.next_update<span class="main">)</span> 
  <span class="main">∈</span> <span class="main">(</span><span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel<span class="main">⟩</span>lss.rel <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel<span class="main">⟩</span>lss.rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>node_impl.more_update<span class="main">,</span>node.more_update<span class="main">)</span> 
  <span class="main">∈</span> <span class="main">(</span><span class="free">Re</span> <span class="main">→</span> <span class="free">Re</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> node_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>

<span class="keyword1"><span class="command">term</span></span> <span class="quoted">name</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>node_impl.name_impl<span class="main">,</span>node.name<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel <span class="main">→</span> node_name_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>node_impl.incoming_impl<span class="main">,</span>node.incoming<span class="main">)</span>
  <span class="main">∈</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel <span class="main">→</span> <span class="main">⟨</span>node_name_rel<span class="main">⟩</span>dflt_rs_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>node_impl.new_impl<span class="main">,</span>node.new<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel<span class="main">⟩</span>lss.rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>node_impl.old_impl<span class="main">,</span>node.old<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel<span class="main">⟩</span>lss.rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>node_impl.next_impl<span class="main">,</span>node.next<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel<span class="main">⟩</span>lss.rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>node_impl.more<span class="main">,</span> node.more<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel <span class="main">→</span> <span class="free">Re</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> node_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Massaging the Abstract Algorithm›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In a first step, we do some refinement steps on the abstract data structures,
  with the goal to make the algorithm more efficient.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Creation of the Nodes›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In the expand-algorithm, we replace nested conditionals by case-distinctions,
  and slightly stratify the code.
›</span></span>



<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">expand2</span> <span class="free"><span class="bound"><span class="entity">exp</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">nx1</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="bound">nm</span><span class="main">,</span> <span class="bound">nds</span><span class="main">)</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">exp</span></span></span> <span class="main">(</span>
      <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">⦇</span> 
        new <span class="main">:=</span> insert <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="main">(</span>new <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">,</span> 
        old <span class="main">:=</span> insert <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>old <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">,</span> 
        next <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">nx1</span></span></span> <span class="main">∪</span> next <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⦈</span><span class="main">,</span> 
      <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">exp</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">⦇</span> name <span class="main">:=</span> <span class="bound">nm</span><span class="main">,</span> new <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="main">∪</span> new <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> old <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span> <span class="main">∪</span> old <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⦈</span><span class="main">,</span> <span class="bound">nds</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>



<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">expand_aimpl</span> <span class="main">≡</span> <span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">expand</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">ns</span><span class="main">)</span><span class="main">.</span> 
      <span class="keyword1">if</span> new <span class="bound">n</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">(</span> 
        <span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n'</span><span class="main">∈</span><span class="bound">ns</span><span class="main">.</span> old <span class="bound">n'</span> <span class="main">=</span> old <span class="bound">n</span> <span class="main">∧</span> next <span class="bound">n'</span> <span class="main">=</span> next <span class="bound">n</span><span class="main">)</span> <span class="keyword1">then</span> 
          RETURN <span class="main">(</span>name <span class="bound">n</span><span class="main">,</span> upd_incoming <span class="bound">n</span> <span class="bound">ns</span><span class="main">)</span>
        <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
          ASSERT <span class="main">(</span><span class="bound">n</span> <span class="main">∉</span> <span class="bound">ns</span><span class="main">)</span><span class="main">;</span>
          ASSERT <span class="main">(</span>name <span class="bound">n</span> <span class="main">∉</span> name<span class="main">`</span><span class="bound">ns</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">expand</span> <span class="main">(</span><span class="main">⦇</span> 
            name<span class="main">=</span>expand_new_name <span class="main">(</span>name <span class="bound">n</span><span class="main">)</span><span class="main">,</span> 
            incoming<span class="main">=</span><span class="main">{</span>name <span class="bound">n</span><span class="main">}</span><span class="main">,</span> 
            new<span class="main">=</span>next <span class="bound">n</span><span class="main">,</span> 
            old<span class="main">=</span><span class="main">{}</span><span class="main">,</span> 
            next<span class="main">=</span><span class="main">{}</span> <span class="main">⦈</span><span class="main">,</span> 
            insert <span class="bound">n</span> <span class="bound">ns</span><span class="main">)</span>
        <span class="main">}</span>
      <span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span> 
        <span class="bound">φ</span> <span class="main">←</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="main">(</span>new <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        <span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> <span class="bound">n</span><span class="main">⦇</span> new <span class="main">:=</span> new <span class="bound">n</span> <span class="main">-</span> <span class="main">{</span><span class="bound">φ</span><span class="main">}</span> <span class="main">⦈</span><span class="main">;</span>
        <span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span>
          <span class="keyword1">prop<span class="hidden">⇩</span><sub>r</sub>(</span><span class="bound">q</span><span class="main">)</span> <span class="main">⇒</span> 
            <span class="keyword1">if</span> <span class="keyword1">nprop<span class="hidden">⇩</span><sub>r</sub>(</span><span class="bound">q</span><span class="main">)</span><span class="main">∈</span>old <span class="bound">n</span> <span class="keyword1">then</span> RETURN <span class="main">(</span>name <span class="bound">n</span><span class="main">,</span> <span class="bound">ns</span><span class="main">)</span>
            <span class="keyword1">else</span> <span class="bound">expand</span> <span class="main">(</span><span class="bound">n</span><span class="main">⦇</span> old <span class="main">:=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">}</span> <span class="main">∪</span> old <span class="bound">n</span> <span class="main">⦈</span><span class="main">,</span> <span class="bound">ns</span><span class="main">)</span>
        <span class="main">|</span> <span class="keyword1">nprop<span class="hidden">⇩</span><sub>r</sub>(</span><span class="bound">q</span><span class="main">)</span> <span class="main">⇒</span> 
            <span class="keyword1">if</span> <span class="keyword1">prop<span class="hidden">⇩</span><sub>r</sub>(</span><span class="bound">q</span><span class="main">)</span><span class="main">∈</span>old <span class="bound">n</span> <span class="keyword1">then</span> RETURN <span class="main">(</span>name <span class="bound">n</span><span class="main">,</span> <span class="bound">ns</span><span class="main">)</span>
            <span class="keyword1">else</span> <span class="bound">expand</span> <span class="main">(</span><span class="bound">n</span><span class="main">⦇</span> old <span class="main">:=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">}</span> <span class="main">∪</span> old <span class="bound">n</span> <span class="main">⦈</span><span class="main">,</span> <span class="bound">ns</span><span class="main">)</span>
        <span class="main">|</span> <span class="keyword1">true<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⇒</span> <span class="bound">expand</span> <span class="main">(</span><span class="bound">n</span><span class="main">⦇</span> old <span class="main">:=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">}</span> <span class="main">∪</span> old <span class="bound">n</span> <span class="main">⦈</span><span class="main">,</span> <span class="bound">ns</span><span class="main">)</span>
        <span class="main">|</span> <span class="keyword1">false<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⇒</span> RETURN <span class="main">(</span>name <span class="bound">n</span><span class="main">,</span> <span class="bound">ns</span><span class="main">)</span>
        <span class="main">|</span> <span class="bound">ν</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">μ</span> <span class="main">⇒</span> <span class="bound">expand</span> <span class="main">(</span><span class="bound">n</span><span class="main">⦇</span> 
            new <span class="main">:=</span> insert <span class="bound">ν</span> <span class="main">(</span>insert <span class="bound">μ</span> <span class="main">(</span>new <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
            old <span class="main">:=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">}</span> <span class="main">∪</span> old <span class="bound">n</span><span class="main">,</span> 
            next <span class="main">:=</span> next <span class="bound">n</span> <span class="main">⦈</span><span class="main">,</span> <span class="bound">ns</span><span class="main">)</span>
        <span class="main">|</span> <span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ν</span> <span class="main">⇒</span> <span class="bound">expand</span> 
            <span class="main">(</span><span class="bound">n</span><span class="main">⦇</span> new <span class="main">:=</span> new <span class="bound">n</span><span class="main">,</span> old <span class="main">:=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">}</span> <span class="main">∪</span> old <span class="bound">n</span><span class="main">,</span> next <span class="main">:=</span> insert <span class="bound">ν</span> <span class="main">(</span>next <span class="bound">n</span><span class="main">)</span> <span class="main">⦈</span><span class="main">,</span> <span class="bound">ns</span><span class="main">)</span>
        <span class="main">|</span> <span class="bound">μ</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ν</span> <span class="main">⇒</span> expand2 <span class="bound">expand</span> <span class="bound">n</span> <span class="bound">ns</span> <span class="bound">φ</span> <span class="bound">μ</span> <span class="main">{}</span> <span class="main">{</span><span class="bound">ν</span><span class="main">}</span>
        <span class="main">|</span> <span class="bound">μ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ν</span> <span class="main">⇒</span> expand2 <span class="bound">expand</span> <span class="bound">n</span> <span class="bound">ns</span> <span class="bound">φ</span> <span class="bound">μ</span> <span class="main">{</span><span class="bound">φ</span><span class="main">}</span> <span class="main">{</span><span class="bound">ν</span><span class="main">}</span>
        <span class="main">|</span> <span class="bound">μ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="bound">ν</span> <span class="main">⇒</span> expand2 <span class="bound">expand</span> <span class="bound">n</span> <span class="bound">ns</span> <span class="bound">φ</span> <span class="bound">ν</span> <span class="main">{</span><span class="bound">φ</span><span class="main">}</span> <span class="main">{</span><span class="bound">μ</span><span class="main">,</span><span class="bound">ν</span><span class="main">}</span>
        <span class="comment1">⌦‹| _ ⇒ do {
          (nm, nds) ← expand (
            n⦇ 
              new := new1 φ ∪ new n, 
              old := {φ} ∪ old n, 
              next := next1 φ ∪ next n ⦈,
            ns);
          expand (n⦇ name := nm, new := new2 φ ∪ new n, old := {φ} ∪ old n ⦈, nds)
        }›</span>
      <span class="main">}</span>
     <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> expand_aimpl_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n_ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> node <span class="main">×</span> <span class="main">_</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≡</span> Id <span class="main">∩</span> <span class="main">{</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">ns</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n'</span><span class="main">∈</span><span class="bound">ns</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&gt;</span> name <span class="bound">n'</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">≡</span> Id <span class="main">∩</span> <span class="main">{</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">ns</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n'</span><span class="main">∈</span><span class="bound">ns</span><span class="main">.</span> name <span class="bound">n</span> <span class="main">&gt;</span> name <span class="bound">n'</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n_ns'</span><span class="main">,</span><span class="free">n_ns</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"expand_aimpl <span class="free">n_ns'</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>expand<span class="hidden">⇩</span><sub>T</sub> <span class="free">n_ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span> <span class="main"><span class="main">=</span></span> 1<span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="free">R</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> single_valuedI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="free">R'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R'_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> single_valuedI<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> node"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ns</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">n'</span> <span class="skolem">ns'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">n'</span><span class="main">,</span> <span class="skolem">ns'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RETURN <span class="main">(</span>name <span class="skolem">n'</span><span class="main">,</span> <span class="skolem">ns'</span><span class="main">)</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="free">R</span> <span class="main">(</span>RETURN <span class="main">(</span>name <span class="skolem">n</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def R'_def pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> aux <span class="main">=</span> this


  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> expand_aimpl_def expand<span class="hidden">⇩</span><sub>T</sub>_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_rcg</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_def R'_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_def R'_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_def R'_def upd_incoming_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_def R'_def upd_incoming_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_def R'_def upd_incoming_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rprems</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R'_def expand_new_name_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R'_def<span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ltlr.split<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def R'_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def R'_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def R'_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def R'_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def R'_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def R'_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def R'_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def R'_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def R'_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def R'_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def R'_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rprems</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def R'_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R'_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rprems</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def R'_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rprems</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def R'_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">thm</span></span> create_graph_def
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">create_graph_aimpl</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">nds</span><span class="main">)</span> <span class="main">←</span>
  expand_aimpl
   <span class="main">(</span><span class="main">⦇</span>name <span class="main">=</span> expand_new_name expand_init<span class="main">,</span> incoming <span class="main">=</span> <span class="main">{</span>expand_init<span class="main">}</span><span class="main">,</span>
       new <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span><span class="main">,</span> old <span class="main">=</span> <span class="main">{}</span><span class="main">,</span> next <span class="main">=</span> <span class="main">{}</span><span class="main">⦈</span><span class="main">,</span>
    <span class="main">{}</span><span class="main">)</span><span class="main">;</span>
  RETURN <span class="bound">nds</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> create_graph_aimpl_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"create_graph_aimpl <span class="free">φ</span> <span class="main">≤</span> <span class="main">⇓</span>Id <span class="main">(</span>create_graph<span class="hidden">⇩</span><sub>T</sub> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_graph_aimpl_def create_graph<span class="hidden">⇩</span><sub>T</sub>_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> expand_aimpl_refine<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Creation of GBA from Nodes›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We summarize creation of the GBA and renaming of the nodes into one step
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> create_name_gba_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"create_name_gba <span class="free">φ</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">nds</span> <span class="main">←</span> create_graph<span class="hidden">⇩</span><sub>T</sub> <span class="free">φ</span><span class="main">;</span>
  ASSERT <span class="main">(</span>nds_invars <span class="bound">nds</span><span class="main">)</span><span class="main">;</span>
  RETURN <span class="main">(</span>gba_rename_ext <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">()</span><span class="main">)</span> name <span class="main">(</span>create_gba_from_nodes <span class="free">φ</span> <span class="bound">nds</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">nds</span><span class="main">.</span> g_V <span class="main">(</span>create_gba_from_nodes <span class="free">φ</span> <span class="bound">nds</span><span class="main">)</span> <span class="main">=</span> <span class="bound">nds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> create_gba_from_nodes_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> create_name_gba_def create_gba_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the following, we implement the componenents of the
  renamed GBA separately.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹\paragraph{Successor Function}›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">build_succ</span> <span class="free"><span class="bound"><span class="entity">nds</span></span></span> <span class="main">=</span> 
  FOREACH 
    <span class="free"><span class="bound"><span class="entity">nds</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">q'</span> <span class="bound">s</span><span class="main">.</span>
    FOREACH
      <span class="main">(</span>incoming <span class="bound">q'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">qn</span> <span class="bound">s</span><span class="main">.</span> 
        <span class="keyword1">if</span> <span class="bound">qn</span><span class="main">=</span>expand_init <span class="keyword1">then</span> 
          RETURN <span class="bound">s</span> 
        <span class="keyword1">else</span> 
          RETURN <span class="main">(</span><span class="bound">s</span><span class="main">(</span><span class="bound">qn</span> <span class="main">↦</span> insert <span class="main">(</span>name <span class="bound">q'</span><span class="main">)</span> <span class="main">(</span>the_default <span class="main">{}</span> <span class="main">(</span><span class="bound">s</span> <span class="bound">qn</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">)</span> <span class="bound">s</span>
  <span class="main">)</span> Map.empty"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> build_succ_aux1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">nds</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span><span class="main">∈</span><span class="free">nds</span> <span class="main">⟹</span> finite <span class="main">(</span>incoming <span class="bound">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"build_succ <span class="free">nds</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">qn</span><span class="main">.</span> 
  dflt_None_set <span class="main">{</span><span class="bound">qn'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q'</span><span class="main">.</span> 
    <span class="bound">q'</span><span class="main">∈</span><span class="free">nds</span> <span class="main">∧</span> <span class="bound">qn'</span> <span class="main">=</span> name <span class="bound">q'</span> <span class="main">∧</span> <span class="bound">qn</span><span class="main">∈</span>incoming <span class="bound">q'</span> <span class="main">∧</span> <span class="bound">qn</span><span class="main">≠</span>expand_init 
  <span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> build_succ_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span> 
    FOREACH_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span>
      I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">it</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">qn</span><span class="main">.</span> dflt_None_set <span class="main">{</span><span class="bound">qn'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q'</span><span class="main">.</span> <span class="bound">q'</span><span class="main">∈</span><span class="free">nds</span><span class="main">-</span><span class="bound">it</span> <span class="main">∧</span> <span class="bound">qn'</span> <span class="main">=</span> name <span class="bound">q'</span> 
    <span class="main">∧</span> <span class="bound">qn</span><span class="main">∈</span>incoming <span class="bound">q'</span> <span class="main">∧</span> <span class="bound">qn</span><span class="main">≠</span>expand_init <span class="main">}</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dflt_None_set_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> q' it s<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">it2</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">λ</span><span class="bound">qn</span><span class="main">.</span> dflt_None_set <span class="main">(</span>
      <span class="main">{</span><span class="bound">qn'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q'</span><span class="main">.</span> <span class="bound">q'</span><span class="main">∈</span><span class="free">nds</span><span class="main">-</span><span class="improper">it</span> <span class="main">∧</span> <span class="bound">qn'</span> <span class="main">=</span> name <span class="bound">q'</span> <span class="main">∧</span> <span class="bound">qn</span><span class="main">∈</span>incoming <span class="bound">q'</span> <span class="main">∧</span> <span class="bound">qn</span><span class="main">≠</span>expand_init <span class="main">}</span> <span class="main">∪</span> 
      <span class="main">{</span><span class="bound">qn'</span> <span class="main">.</span> <span class="bound">qn'</span><span class="main">=</span>name <span class="improper">q'</span> <span class="main">∧</span> <span class="bound">qn</span><span class="main">∈</span>incoming <span class="improper">q'</span> <span class="main">-</span> <span class="bound">it2</span> <span class="main">∧</span> <span class="bound">qn</span><span class="main">≠</span>expand_init<span class="main">}</span> <span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> FOREACH_rule<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dflt_None_set_def<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dflt_None_set_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> build_succ_aux2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> NINIT<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_init <span class="main">∉</span> name<span class="main">`</span><span class="free">nds</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> CL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">nd</span><span class="main">.</span> <span class="bound">nd</span><span class="main">∈</span><span class="free">nds</span> <span class="main">⟹</span> incoming <span class="bound">nd</span> <span class="main">⊆</span> insert expand_init <span class="main">(</span>name<span class="main">`</span><span class="free">nds</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">qn</span><span class="main">.</span> dflt_None_set 
    <span class="main">{</span><span class="bound">qn'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q'</span><span class="main">.</span> <span class="bound">q'</span><span class="main">∈</span><span class="free">nds</span> <span class="main">∧</span> <span class="bound">qn'</span> <span class="main">=</span> name <span class="bound">q'</span> <span class="main">∧</span> <span class="bound">qn</span><span class="main">∈</span>incoming <span class="bound">q'</span> <span class="main">∧</span> <span class="bound">qn</span><span class="main">≠</span>expand_init <span class="main">}</span><span class="main">)</span> 
  <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">qn</span><span class="main">.</span> dflt_None_set <span class="main">(</span>succ_of_E 
       <span class="main">(</span>rename_E name <span class="main">{</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">q'</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">nds</span> <span class="main">∧</span> <span class="bound">q'</span> <span class="main">∈</span> <span class="free">nds</span> <span class="main">∧</span> name <span class="bound">q</span> <span class="main">∈</span> incoming <span class="bound">q'</span><span class="main">}</span><span class="main">)</span> <span class="bound">qn</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">qn</span><span class="main">.</span> dflt_None_set <span class="main">(</span><span class="var">?L</span> <span class="bound">qn</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">qn</span><span class="main">.</span> dflt_None_set <span class="main">(</span><span class="var">?R</span> <span class="bound">qn</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fo_rule</span> arg_cong<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ext equalityI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">qn</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="var">?R</span> <span class="skolem">qn</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="var">?L</span> <span class="skolem">qn</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> NINIT
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> succ_of_E_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">qn</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> XL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="var">?L</span> <span class="skolem">qn</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="var">?R</span> <span class="skolem">qn</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">qn</span> <span class="main">=</span> expand_init"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> XL <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span><span class="main">∈</span><span class="free">nds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qn</span><span class="main">∈</span>incoming <span class="skolem">q'</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span>name <span class="skolem">q'</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> False <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span><span class="main">∈</span><span class="free">nds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qn</span> <span class="main">=</span> name <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> CL A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> A B <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="var">?R</span> <span class="skolem">qn</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> succ_of_E_def image_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> True
    <span class="keyword1"><span class="command">from</span></span> XL <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="var">?R</span> <span class="skolem">qn</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> build_succ_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> NINIT<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_init <span class="main">∉</span> name<span class="main">`</span><span class="free">nds</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FIN<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">nds</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> CL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">nd</span><span class="main">.</span> <span class="bound">nd</span><span class="main">∈</span><span class="free">nds</span> <span class="main">⟹</span> incoming <span class="bound">nd</span> <span class="main">⊆</span> insert expand_init <span class="main">(</span>name<span class="main">`</span><span class="free">nds</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"build_succ <span class="free">nds</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> 
    E_of_succ <span class="main">(</span><span class="main">λ</span><span class="bound">qn</span><span class="main">.</span> the_default <span class="main">{}</span> <span class="main">(</span><span class="bound">r</span> <span class="bound">qn</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">=</span> rename_E <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> name <span class="bound">u</span><span class="main">)</span> <span class="main">{</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">q'</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">nds</span> <span class="main">∧</span> <span class="bound">q'</span> <span class="main">∈</span> <span class="free">nds</span> <span class="main">∧</span> name <span class="bound">q</span> <span class="main">∈</span> incoming <span class="bound">q'</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> FIN CL <span class="keyword1"><span class="command">have</span></span> FIN'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span><span class="main">∈</span><span class="free">nds</span> <span class="main">⟹</span> finite <span class="main">(</span>incoming <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_imageI finite_insert infinite_super<span class="main">)</span>
  
  <span class="keyword1"><span class="command">note</span></span> build_succ_aux1<span class="main">[</span><span class="operator">OF</span> FIN FIN'<span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> build_succ_aux2<span class="main">[</span><span class="operator">OF</span> NINIT CL<span class="main">]</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹\paragraph{ Accepting Sets}›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">until_frmlsr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> frml <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> frml <span class="main">×</span> <span class="tfree">'a</span> frml<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">until_frmlsr</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="keyword1">and<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">until_frmlsr</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">until_frmlsr</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">until_frmlsr</span> <span class="main">(</span><span class="keyword1">X<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">until_frmlsr</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">until_frmlsr</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">until_frmlsr</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">until_frmlsr</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">until_frmlsr</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="keyword1">R<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">until_frmlsr</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">until_frmlsr</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">until_frmlsr</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="keyword1">or<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">until_frmlsr</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">until_frmlsr</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">until_frmlsr</span> <span class="main">(</span><span class="keyword1">true<span class="hidden">⇩</span><sub>r</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">until_frmlsr</span> <span class="main">(</span><span class="keyword1">false<span class="hidden">⇩</span><sub>r</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">until_frmlsr</span> <span class="main">(</span><span class="keyword1">prop<span class="hidden">⇩</span><sub>r</sub>(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">until_frmlsr</span> <span class="main">(</span><span class="keyword1">nprop<span class="hidden">⇩</span><sub>r</sub>(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> until_frmlsr_correct<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"until_frmlsr <span class="free">φ</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">μ</span><span class="main">,</span> <span class="bound">η</span><span class="main">)</span><span class="main">.</span> Until_ltlr <span class="bound">μ</span> <span class="bound">η</span> <span class="main">∈</span> subfrmlsr <span class="free">φ</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">build_F</span> <span class="free"><span class="bound"><span class="entity">nds</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> 
  <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">μ</span><span class="main">,</span><span class="bound">η</span><span class="main">)</span><span class="main">.</span> name <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">nds</span></span></span><span class="main">.</span> <span class="main">(</span>Until_ltlr <span class="bound">μ</span> <span class="bound">η</span> <span class="main">∈</span> old <span class="bound">q</span> <span class="main">⟶</span> <span class="bound">η</span> <span class="main">∈</span> old <span class="bound">q</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span>
    until_frmlsr <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> build_F_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"build_F <span class="free">nds</span> <span class="free">φ</span> <span class="main">=</span> 
  <span class="main">{</span>name <span class="main">`</span> <span class="bound">A</span> <span class="main">|</span><span class="bound">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">μ</span> <span class="bound">η</span><span class="main">.</span> <span class="bound">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="free">nds</span><span class="main">.</span> Until_ltlr <span class="bound">μ</span> <span class="bound">η</span> <span class="main">∈</span> old <span class="bound">q</span> <span class="main">⟶</span> <span class="bound">η</span> <span class="main">∈</span> old <span class="bound">q</span><span class="main">}</span> <span class="main">∧</span>
                     Until_ltlr <span class="bound">μ</span> <span class="bound">η</span> <span class="main">∈</span> subfrmlsr <span class="free">φ</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>name <span class="main">`</span> <span class="bound">A</span> <span class="main">|</span><span class="bound">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">μ</span> <span class="bound">η</span><span class="main">.</span> <span class="bound">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="free">nds</span><span class="main">.</span> Until_ltlr <span class="bound">μ</span> <span class="bound">η</span> <span class="main">∈</span> old <span class="bound">q</span> <span class="main">⟶</span> <span class="bound">η</span> <span class="main">∈</span> old <span class="bound">q</span><span class="main">}</span> <span class="main">∧</span>
                     Until_ltlr <span class="bound">μ</span> <span class="bound">η</span> <span class="main">∈</span> subfrmlsr <span class="free">φ</span><span class="main">}</span>
    <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">μ</span><span class="main">,</span><span class="bound">η</span><span class="main">)</span><span class="main">.</span> name<span class="main">`</span><span class="main">{</span><span class="bound"><span class="bound">q</span></span><span class="main">∈</span><span class="free">nds</span><span class="main">.</span> Until_ltlr <span class="bound">μ</span> <span class="bound">η</span> <span class="main">∈</span> old <span class="bound">q</span> <span class="main">⟶</span> <span class="bound">η</span> <span class="main">∈</span> old <span class="bound">q</span><span class="main">}</span><span class="main">)</span> 
      <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">μ</span><span class="main">,</span> <span class="bound">η</span><span class="main">)</span><span class="main">.</span> Until_ltlr <span class="bound">μ</span> <span class="bound">η</span> <span class="main">∈</span> subfrmlsr <span class="free">φ</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">μ</span><span class="main">,</span><span class="bound">η</span><span class="main">)</span><span class="main">.</span> name<span class="main">`</span><span class="main">{</span><span class="bound"><span class="bound">q</span></span><span class="main">∈</span><span class="free">nds</span><span class="main">.</span> Until_ltlr <span class="bound">μ</span> <span class="bound">η</span> <span class="main">∈</span> old <span class="bound">q</span> <span class="main">⟶</span> <span class="bound">η</span> <span class="main">∈</span> old <span class="bound">q</span><span class="main">}</span><span class="main">)</span> 
      <span class="main">`</span> until_frmlsr <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> until_frmlsr_correct <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> build_F_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹\paragraph{ Labeling Function }›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pn_props</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">≡</span> FOREACHi 
  <span class="main">(</span><span class="main">λ</span><span class="bound">it</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">N</span><span class="main">)</span><span class="main">.</span> <span class="bound">P</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> Prop_ltlr <span class="bound">p</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">-</span> <span class="bound">it</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">N</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> Nprop_ltlr <span class="bound">p</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">-</span> <span class="bound">it</span><span class="main">}</span><span class="main">)</span> 
  <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">N</span><span class="main">)</span><span class="main">.</span> 
    <span class="keyword1">case</span> <span class="bound">p</span> <span class="keyword1">of</span> Prop_ltlr <span class="bound">p</span> <span class="main">⇒</span> RETURN <span class="main">(</span>insert <span class="bound">p</span> <span class="bound">P</span><span class="main">,</span><span class="bound">N</span><span class="main">)</span>
    <span class="main">|</span> Nprop_ltlr <span class="bound">p</span> <span class="main">⇒</span> RETURN <span class="main">(</span><span class="bound">P</span><span class="main">,</span> insert <span class="bound">p</span> <span class="bound">N</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> RETURN <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">N</span><span class="main">)</span>
  <span class="main">)</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pn_props_correct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pn_props <span class="free">ps</span> <span class="main">≤</span> SPEC<span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> Prop_ltlr <span class="bound">p</span> <span class="main">∈</span> <span class="free">ps</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> Nprop_ltlr <span class="bound">p</span> <span class="main">∈</span> <span class="free">ps</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pn_props_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ltlr.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pn_map</span> <span class="free"><span class="bound"><span class="entity">nds</span></span></span> <span class="main">≡</span> FOREACH <span class="free"><span class="bound"><span class="entity">nds</span></span></span> 
  <span class="main">(</span><span class="main">λ</span><span class="bound">nd</span> <span class="bound">m</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">PN</span> <span class="main">←</span> pn_props <span class="main">(</span>old <span class="bound">nd</span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="main">(</span><span class="bound">m</span><span class="main">(</span>name <span class="bound">nd</span> <span class="main">↦</span> <span class="bound">PN</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span><span class="main">)</span> Map.empty"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pn_map_correct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">nds</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FIN'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">nd</span><span class="main">.</span> <span class="bound">nd</span><span class="main">∈</span><span class="free">nds</span> <span class="main">⟹</span> finite <span class="main">(</span>old <span class="bound">nd</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on name <span class="free">nds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pn_map <span class="free">nds</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">∀</span><span class="bound">qn</span><span class="main">.</span> 
    <span class="keyword1">case</span> <span class="bound">r</span> <span class="bound">qn</span> <span class="keyword1">of</span> 
      None <span class="main">⇒</span> <span class="bound">qn</span> <span class="main">∉</span> name<span class="main">`</span><span class="free">nds</span>
    <span class="main">|</span> Some <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">N</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">qn</span> <span class="main">∈</span> name<span class="main">`</span><span class="free">nds</span> 
      <span class="main">∧</span> <span class="bound">P</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> Prop_ltlr <span class="bound">p</span> <span class="main">∈</span> old <span class="main">(</span>the_inv_into <span class="free">nds</span> name <span class="bound">qn</span><span class="main">)</span><span class="main">}</span>
      <span class="main">∧</span> <span class="bound">N</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> Nprop_ltlr <span class="bound">p</span> <span class="main">∈</span> old <span class="main">(</span>the_inv_into <span class="free">nds</span> name <span class="bound">qn</span><span class="main">)</span><span class="main">}</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pn_map_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span>
    FOREACH_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">it</span> <span class="bound">r</span><span class="main">.</span> <span class="main">∀</span><span class="bound">qn</span><span class="main">.</span> 
      <span class="keyword1">case</span> <span class="bound">r</span> <span class="bound">qn</span> <span class="keyword1">of</span> 
        None <span class="main">⇒</span> <span class="bound">qn</span> <span class="main">∉</span> name<span class="main">`</span><span class="main">(</span><span class="free">nds</span> <span class="main">-</span> <span class="bound">it</span><span class="main">)</span>
      <span class="main">|</span> Some <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">N</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">qn</span> <span class="main">∈</span> name<span class="main">`</span><span class="main">(</span><span class="free">nds</span> <span class="main">-</span> <span class="bound">it</span><span class="main">)</span>
        <span class="main">∧</span> <span class="bound">P</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> Prop_ltlr <span class="bound">p</span> <span class="main">∈</span> old <span class="main">(</span>the_inv_into <span class="free">nds</span> name <span class="bound">qn</span><span class="main">)</span><span class="main">}</span>
        <span class="main">∧</span> <span class="bound">N</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> Nprop_ltlr <span class="bound">p</span> <span class="main">∈</span> old <span class="main">(</span>the_inv_into <span class="free">nds</span> name <span class="bound">qn</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span>
    order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pn_props_correct<span class="main"><span class="main">]</span></span>
  <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> FIN'<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> 
    <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits 
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> the_inv_into_f_f<span class="main"><span class="main">[</span></span><span class="operator">OF</span> INJ<span class="main"><span class="main">]</span></span> it_step_insert_iff<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

 
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹\paragraph{ Assembling the Implementation }›</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cr_rename_gba</span> <span class="free"><span class="bound"><span class="entity">nds</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="keyword1">let</span> <span class="bound">V</span> <span class="main">=</span> name <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">nds</span></span></span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">V0</span> <span class="main">=</span> name <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">nds</span></span></span><span class="main">.</span> expand_init <span class="main">∈</span> incoming <span class="bound">q</span><span class="main">}</span><span class="main">;</span>
  <span class="bound">succmap</span> <span class="main">←</span> build_succ <span class="free"><span class="bound"><span class="entity">nds</span></span></span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">E</span> <span class="main">=</span> E_of_succ <span class="main">(</span>the_default <span class="main">{}</span> <span class="keyword1">o</span> <span class="bound">succmap</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">F</span> <span class="main">=</span> build_F <span class="free"><span class="bound"><span class="entity">nds</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span>
  <span class="bound">pnm</span> <span class="main">←</span> pn_map <span class="free"><span class="bound"><span class="entity">nds</span></span></span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">L</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">qn</span> <span class="bound">l</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">pnm</span> <span class="bound">qn</span> <span class="keyword1">of</span> 
      None <span class="main">⇒</span> False 
    <span class="main">|</span> Some <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">N</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> <span class="bound">p</span><span class="main">∈</span><span class="main">(</span><span class="bound">l</span><span class="keyword1">:::<span class="hidden">⇩</span><sub>r</sub></span><span class="main">⟨</span>Id<span class="main">⟩</span>fun_set_rel<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="bound">N</span><span class="main">.</span> <span class="bound">p</span><span class="main">∉</span><span class="bound">l</span><span class="main">)</span>
  <span class="main">)</span><span class="main">;</span>
  RETURN <span class="main">(</span><span class="main">⦇</span> g_V <span class="main">=</span> <span class="bound">V</span><span class="main">,</span> g_E<span class="main">=</span><span class="bound">E</span><span class="main">,</span> g_V0<span class="main">=</span><span class="bound">V0</span><span class="main">,</span> gbg_F <span class="main">=</span> <span class="bound">F</span><span class="main">,</span> gba_L <span class="main">=</span> <span class="bound">L</span> <span class="main">⦈</span><span class="main">)</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cr_rename_gba_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INV<span class="main">:</span> <span class="quoted"><span class="quoted">"nds_invars <span class="free">nds</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REL<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">nds'</span><span class="main">,</span><span class="free">nds</span><span class="main">)</span><span class="main">∈</span>Id"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">φ'</span><span class="main">,</span><span class="free">φ</span><span class="main">)</span><span class="main">∈</span>Id"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cr_rename_gba <span class="free">nds'</span> <span class="free">φ'</span> 
  <span class="main">≤</span> <span class="main">⇓</span>Id <span class="main">(</span>RETURN <span class="main">(</span>gba_rename_ext <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">()</span><span class="main">)</span> name <span class="main">(</span>create_gba_from_nodes <span class="free">φ</span> <span class="free">nds</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RETURN_SPEC_conv
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Id_SPEC_refine<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> INV <span class="keyword1"><span class="command">have</span></span>
    NINIT<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_init <span class="main">∉</span> name<span class="main">`</span><span class="free">nds</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> FIN<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">nds</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> FIN'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">nd</span><span class="main">.</span> <span class="bound">nd</span><span class="main">∈</span><span class="free">nds</span> <span class="main">⟹</span> finite <span class="main">(</span>old <span class="bound">nd</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> CL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">nd</span><span class="main">.</span> <span class="bound">nd</span><span class="main">∈</span><span class="free">nds</span> <span class="main">⟹</span> incoming <span class="bound">nd</span> <span class="main">⊆</span> insert expand_init <span class="main">(</span>name<span class="main">`</span><span class="free">nds</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on name <span class="free">nds</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nds_invars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cr_rename_gba <span class="free">nds'</span> <span class="free">φ'</span>
    <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> gba_rename_ext <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">()</span><span class="main">)</span> name <span class="main">(</span>create_gba_from_nodes <span class="free">φ</span> <span class="free">nds</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> REL
    <span class="keyword1"><span class="command">unfolding</span></span> cr_rename_gba_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span>
      order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> build_succ_correct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> NINIT FIN CL<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span>
      order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pn_map_correct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FIN FIN' INJ<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span>
    <span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> gba_rename_ecnv_def gb_rename_ecnv_def 
      fr_rename_ext_def create_gba_from_nodes_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> build_F_correct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">qn</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> the_inv_into_f_f<span class="main"><span class="main">[</span></span><span class="operator">OF</span> INJ<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">create_name_gba_aimpl</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">nds</span> <span class="main">←</span> create_graph_aimpl <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span>
  ASSERT <span class="main">(</span>nds_invars <span class="bound">nds</span><span class="main">)</span><span class="main">;</span>
  cr_rename_gba <span class="bound">nds</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>
<span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> create_name_gba_aimpl_refine<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"create_name_gba_aimpl <span class="free">φ</span> <span class="main">≤</span> <span class="main">⇓</span>Id <span class="main">(</span>create_name_gba <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_name_gba_aimpl_def create_name_gba_alt
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> create_graph_aimpl_refine cr_rename_gba_refine<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement to Efficient Data Structures›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Creation of GBA from Nodes›</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> until_frmlsr_impl_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">relator_props</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">=</span>Id"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span>until_frmlsr<span class="main">)</span> 
  <span class="main">∈</span> <span class="main">⟨</span><span class="main">(</span><span class="free">R</span><span class="main">::</span><span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="main">_</span><span class="main">::</span>linorder<span class="main">)</span> set<span class="main">)</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel<span class="main">⟩</span>dflt_rs_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> until_frmlsr_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">,</span></span> <span class="quasi_keyword">trace</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">until_frmlsr_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> until_frmlsr_impl_aux
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> until_frmlsr_impl.refine<span class="main">[</span><span class="operator">OF</span> PREFER_id_D<span class="main">]</span>




<span class="keyword1"><span class="command">schematic_goal</span></span> build_succ_impl_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span>build_succ<span class="main">)</span> <span class="main">∈</span> 
    <span class="main">⟨</span><span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel<span class="main">⟩</span>list_set_rel 
    <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span>nat_rel<span class="main">,</span><span class="main">⟨</span>nat_rel<span class="main">⟩</span>list_set_rel<span class="main">⟩</span>iam_map_rel<span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> build_succ_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> expand_init_def
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">autoref_trace_failed_id</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">,</span></span> <span class="quasi_keyword">trace</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">build_succ_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> build_succ_impl_aux
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> build_succ_impl.refine

<span class="comment1">(* TODO: Post-processing should be on by default! *)</span>
<span class="keyword1"><span class="command">schematic_goal</span></span> build_succ_code_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"RETURN <span class="var">?c</span> <span class="main">≤</span> build_succ_impl <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> build_succ_impl_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_transfer</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">post</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">build_succ_code</span> <span class="keyword2"><span class="keyword">uses</span></span> build_succ_code_aux
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span> <span class="main">=</span> build_succ_code.refine




<span class="keyword1"><span class="command">schematic_goal</span></span> build_F_impl_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> Id"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span>build_F<span class="main">)</span> <span class="main">∈</span> 
    <span class="main">⟨</span><span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel<span class="main">⟩</span>list_set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span>nat_rel<span class="main">⟩</span>list_set_rel<span class="main">⟩</span>list_set_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> build_F_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">autoref_trace_failed_id</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">,</span></span> <span class="quasi_keyword">trace</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">build_F_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> build_F_impl_aux
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> build_F_impl.refine<span class="main">[</span><span class="operator">OF</span> PREFER_id_D<span class="main">]</span>




<span class="keyword1"><span class="command">schematic_goal</span></span> pn_map_impl_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span>pn_map<span class="main">)</span> <span class="main">∈</span> 
    <span class="main">⟨</span><span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span>Id<span class="main">⟩</span>node_rel<span class="main">⟩</span>list_set_rel 
    <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span>nat_rel<span class="main">,</span><span class="main">⟨</span>Id<span class="main">⟩</span>list_set_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span>Id<span class="main">⟩</span>list_set_rel<span class="main">⟩</span>iam_map_rel<span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pn_map_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> pn_props_def
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">autoref_trace_failed_id</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">,</span></span> <span class="quasi_keyword">trace</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">pn_map_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> pn_map_impl_aux
<span class="keyword1"><span class="command">lemma</span></span> pn_map_impl_autoref<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"PREFER_id <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pn_map_impl<span class="main">,</span>pn_map<span class="main">)</span> <span class="main">∈</span> 
    <span class="main">⟨</span><span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel<span class="main">⟩</span>list_set_rel 
    <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span>nat_rel<span class="main">,</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_set_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_set_rel<span class="main">⟩</span>iam_map_rel<span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms pn_map_impl.refine <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> pn_map_code_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"RETURN <span class="var">?c</span> <span class="main">≤</span> pn_map_impl <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pn_map_impl_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_transfer</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">post</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">pn_map_code</span> <span class="keyword2"><span class="keyword">uses</span></span> pn_map_code_aux
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span> <span class="main">=</span> pn_map_code.refine 

<span class="keyword1"><span class="command">schematic_goal</span></span> cr_rename_gba_impl_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ID<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">=</span>Id"</span></span>
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_tyrel</span> <span class="quasi_keyword">del</span><span class="main">]</span> <span class="main">=</span> tyrel_dflt_linorder_set
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_tyrel</span><span class="main">]</span> <span class="main">=</span> ty_REL<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>nat_rel<span class="main">⟩</span>list_set_rel"</span></span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span>cr_rename_gba<span class="main">)</span> <span class="main">∈</span> 
    <span class="main">⟨</span><span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel<span class="main">⟩</span>list_set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">(</span><span class="var">?R</span><span class="main">::</span><span class="main">(</span><span class="tvar">?'c</span> <span class="main">×</span> <span class="main">_</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ID
  <span class="keyword1"><span class="command">unfolding</span></span> cr_rename_gba_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> expand_init_def comp_def
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">autoref_trace_failed_id</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">,</span></span> <span class="quasi_keyword">trace</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">cr_rename_gba_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> cr_rename_gba_impl_aux

<span class="keyword1"><span class="command">thm</span></span> cr_rename_gba_impl.refine

<span class="keyword1"><span class="command">lemma</span></span> cr_rename_gba_autoref<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"PREFER_id <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cr_rename_gba_impl<span class="main">,</span> cr_rename_gba<span class="main">)</span> <span class="main">∈</span> 
    <span class="main">⟨</span><span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span> <span class="free">R</span><span class="main">⟩</span>node_rel<span class="main">⟩</span>list_set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span>
    <span class="main">⟨</span>gbav_impl_rel_ext unit_rel nat_rel <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>fun_set_rel<span class="main">)</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms cr_rename_gba_impl.refine<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">Rm</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">schematic_goal</span></span> cr_rename_gba_code_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"RETURN <span class="var">?c</span> <span class="main">≤</span> cr_rename_gba_impl <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cr_rename_gba_impl_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_transfer</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">post</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">cr_rename_gba_code</span> <span class="keyword2"><span class="keyword">uses</span></span> cr_rename_gba_code_aux
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span> <span class="main">=</span> cr_rename_gba_code.refine 


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Creation of Graph›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The implementation of the node-set. The relation enforces that there are no
  different nodes with the same name. This effectively establishes an additional
  invariant, made explicit by an assertion in the refined program. This invariant
  allows for a more efficient implementation.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> ls_nds_rel_def_internal<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">ls_nds_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">⟩</span>list_set_rel <span class="main">∩</span> <span class="main">{</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> inj_on name <span class="bound">s</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> ls_nds_rel_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ls_nds_rel <span class="main">=</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_set_rel <span class="main">∩</span> <span class="main">{</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> inj_on name <span class="bound">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> relAPP_def ls_nds_rel_def_internal<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">ls_nds_rel</span> <span class="quoted">i_set</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> ls_nds_rel_sv<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="free">R</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ls_nds_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> list_set_rel_sv<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> ls_nds_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inf.cobounded1 single_valued_subset<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lemma</span></span> lsnds_empty_autoref<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"PREFER_id <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ls_nds_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ls_nds_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">autoref</span>

<span class="keyword1"><span class="command">lemma</span></span> lsnds_insert_autoref<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span>name <span class="free">n</span> <span class="main">∉</span> name<span class="main">`</span><span class="free">ns</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n'</span><span class="main">,</span><span class="free">n</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ns'</span><span class="main">,</span><span class="free">ns</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ls_nds_rel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n'</span><span class="main">#</span><span class="free">ns'</span><span class="main">,</span><span class="main">(</span><span class="keyword1">OP</span> insert <span class="main">:::</span> <span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ls_nds_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ls_nds_rel<span class="main">)</span><span class="main">$</span><span class="free">n</span><span class="main">$</span><span class="free">ns</span><span class="main">)</span>
   <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ls_nds_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> ls_nds_rel_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n'</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ns'</span><span class="main">,</span> <span class="free">ns</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_set_rel"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"name <span class="free">n</span> <span class="main">∉</span> name <span class="main">`</span> <span class="free">ns</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inj_on name <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> <span class="free">ns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n'</span> <span class="main">#</span> <span class="free">ns'</span><span class="main">,</span> insert <span class="free">n</span> <span class="free">ns</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_set_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">autoref</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ls_nds_image_autoref_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fi</span><span class="main">,</span><span class="free">f</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ra</span> <span class="main">→</span> <span class="free">Rb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span>ls_nds_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> name <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> name <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="free">fi</span> <span class="free">l</span><span class="main">,</span> <span class="free">f</span><span class="main">`</span><span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rb</span><span class="main">⟩</span>ls_nds_rel"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> 
    <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span>list_set_rel"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>inj_on name <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ls_nds_rel_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> INJ assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> inj_on_eq_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="free">fi</span> <span class="free">l</span><span class="main">,</span> <span class="free">f</span><span class="main">`</span><span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rb</span><span class="main">⟩</span>list_set_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on name <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inj_onD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> INJ<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ls_nds_rel_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> ls_nds_image_autoref<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fi</span><span class="main">,</span><span class="free">f</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ra</span> <span class="main">→</span> <span class="free">Rb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> name <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> name <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="free">fi</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">OP</span> <span class="main">(`)</span> <span class="main">:::</span> <span class="main">(</span><span class="free">Ra</span><span class="main">→</span><span class="free">Rb</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span>ls_nds_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">Rb</span><span class="main">⟩</span>ls_nds_rel<span class="main">)</span><span class="main">$</span><span class="free">f</span><span class="main">)</span> 
    <span class="main">∈</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span>ls_nds_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">Rb</span><span class="main">⟩</span>ls_nds_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span>
  <span class="keyword1"><span class="command">using</span></span> ls_nds_image_autoref_aux
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> list_set_autoref_to_list<span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_set_to_sorted_list <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="free">R</span> ls_nds_rel id"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_set_to_list_def is_set_to_sorted_list_def ls_nds_rel_def
    it_to_sorted_list_def list_set_rel_def br_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"upd_incoming 
    <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">Im</span><span class="main">,</span> <span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_node <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">Im'</span><span class="main">,</span> <span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_node<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">Im'</span><span class="main">,</span> <span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_node<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">term</span></span> <span class="quoted">upd_incoming</span>
<span class="keyword1"><span class="command">schematic_goal</span></span> upd_incoming_impl_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"REL_IS_ID <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span> upd_incoming<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Rm1</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel 
  <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">Rm2</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel<span class="main">⟩</span>ls_nds_rel 
  <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">Rm2</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel<span class="main">⟩</span>ls_nds_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">unfolding</span></span> upd_incoming_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">autoref_trace_failed_id</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">upd_incoming_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> upd_incoming_impl_aux
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> upd_incoming_impl.refine<span class="main">[</span><span class="operator">OF</span> PREFER_D<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">REL_IS_ID</span><span class="main"><span class="main">]</span></span><span class="main">]</span>


<span class="keyword1"><span class="command">schematic_goal</span></span> expand_impl_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span> expand_aimpl<span class="main">)</span> <span class="main">∈</span> 
  <span class="main">⟨</span>unit_rel<span class="main">,</span>Id<span class="main">⟩</span>node_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="main">⟨</span>unit_rel<span class="main">,</span>Id<span class="main">⟩</span>node_rel<span class="main">⟩</span>ls_nds_rel 
  <span class="main">→</span> <span class="main">⟨</span>nat_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="main">⟨</span>unit_rel<span class="main">,</span>Id<span class="main">⟩</span>node_rel<span class="main">⟩</span>ls_nds_rel<span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> expand_aimpl_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> expand_new_name_def
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">autoref_trace_failed_id</span><span class="main">,</span> <span class="operator">autoref_trace_intf_unif</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">trace</span><span class="main"><span class="main">,</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">expand_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> expand_impl_aux

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"expand<span class="hidden">⇩</span><sub>T</sub> 
  <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="main">⟨</span>i_unit<span class="main">,</span> <span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_node<span class="main">,</span> <span class="main">⟨</span><span class="main">⟨</span>i_unit<span class="main">,</span> <span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_node<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_prod 
  <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="main">⟨</span>i_nat<span class="main">,</span><span class="main">⟨</span><span class="main">⟨</span>i_unit<span class="main">,</span> <span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_node<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_prod<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_nres"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> expand_autoref<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ID<span class="main">:</span> <span class="quoted"><span class="quoted">"PREFER_id <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n_ns'</span><span class="main">,</span> <span class="free">n_ns</span><span class="main">)</span> 
    <span class="main">∈</span> <span class="main">⟨</span>unit_rel<span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="main">⟨</span>unit_rel<span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel<span class="main">⟩</span>list_set_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">ns</span><span class="main">)</span><span class="main">=</span><span class="free">n_ns</span> <span class="keyword1">in</span> inj_on name <span class="bound">ns</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n'</span><span class="main">∈</span><span class="bound">ns</span><span class="main">.</span> name <span class="bound">n</span> <span class="main">&gt;</span> name <span class="bound">n'</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>expand_impl <span class="free">n_ns'</span><span class="main">,</span> 
    <span class="main">(</span><span class="keyword1">OP</span> expand_aimpl
    <span class="main">:::</span> <span class="main">⟨</span>unit_rel<span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="main">⟨</span>unit_rel<span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel<span class="main">⟩</span>list_set_rel 
    <span class="main">→</span> <span class="main">⟨</span>nat_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="main">⟨</span>unit_rel<span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel<span class="main">⟩</span>list_set_rel<span class="main">⟩</span>nres_rel<span class="main">)</span><span class="main">$</span><span class="free">n_ns</span><span class="main">)</span> 
  <span class="main">∈</span> <span class="main">⟨</span>nat_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="main">⟨</span>unit_rel<span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel<span class="main">⟩</span>list_set_rel<span class="main">⟩</span>nres_rel"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> ID A B <span class="keyword1"><span class="command">have</span></span> 
    1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n_ns</span><span class="main">,</span> <span class="free">n_ns</span><span class="main">)</span> <span class="main">∈</span> Id <span class="main">∩</span> <span class="main">{</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">ns</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n'</span><span class="main">∈</span><span class="bound">ns</span><span class="main">.</span> name <span class="bound">n</span> <span class="main">&gt;</span> name <span class="bound">n'</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n_ns'</span><span class="main">,</span> <span class="free">n_ns</span><span class="main">)</span> 
      <span class="main">∈</span> <span class="main">⟨</span>unit_rel<span class="main">,</span>Id<span class="main">⟩</span>node_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="main">⟨</span>unit_rel<span class="main">,</span>Id<span class="main">⟩</span>node_rel<span class="main">⟩</span>ls_nds_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ls_nds_rel_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n_ns'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span>nat_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="main">⟨</span>unit_rel<span class="main">,</span> Id<span class="main">⟩</span>node_rel<span class="main">⟩</span>list_set_rel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">tagged_solver</span>


  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">R</span><span class="main">.</span> single_valued <span class="main">(</span>Id <span class="main">∩</span> <span class="bound">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntE single_valuedD single_valuedI single_valued_Id<span class="main">)</span>
    
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span><span class="main">(</span>nat_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="main">⟨</span>unit_rel<span class="main">,</span> Id<span class="main">⟩</span>node_rel<span class="main">⟩</span>ls_nds_rel<span class="main">)</span> <span class="keyword1">O</span>
                          <span class="main">(</span>Id <span class="main">∩</span> <span class="main">{</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">n</span><span class="main">,</span> <span class="bound">ns</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n'</span><span class="main">∈</span><span class="bound">ns</span><span class="main">.</span> name <span class="bound">n'</span> <span class="main">&lt;</span> <span class="bound">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">tagged_solver</span><span class="main">)</span>
    
  <span class="keyword1"><span class="command">from</span></span> expand_impl.refine<span class="main">[</span><span class="operator">THEN</span> fun_relD<span class="main">,</span> <span class="operator">OF</span> 2<span class="main">,</span> <span class="operator">THEN</span> nres_relD<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>expand_impl <span class="free">n_ns'</span><span class="main">,</span> expand_aimpl <span class="free">n_ns</span><span class="main">)</span>
    <span class="main">∈</span> <span class="main">⟨</span>nat_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="main">⟨</span>unit_rel<span class="main">,</span> <span class="free">R</span><span class="main">⟩</span>node_rel<span class="main">⟩</span>list_set_rel<span class="main">⟩</span>nres_rel"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nres_relI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ID
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ls_nds_rel_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">schematic_goal</span></span> expand_code_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"RETURN <span class="var">?c</span> <span class="main">≤</span> expand_impl <span class="free">n_ns</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> expand_impl_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_transfer</span> the_resI<span class="main">)</span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">expand_code</span> <span class="keyword2"><span class="keyword">uses</span></span> expand_code_aux
<span class="keyword1"><span class="command">prepare_code_thms</span></span> expand_code_def
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span> <span class="main">=</span> expand_code.refine 


<span class="keyword1"><span class="command">schematic_goal</span></span> create_graph_impl_aux<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> ID<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">=</span>Id"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span> create_graph_aimpl<span class="main">)</span> 
    <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨</span>unit_rel<span class="main">,</span><span class="free">R</span><span class="main">⟩</span>node_rel<span class="main">⟩</span>list_set_rel<span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ID
  <span class="keyword1"><span class="command">unfolding</span></span> create_graph_aimpl_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> expand_init_def expand_new_name_def
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">autoref_trace_failed_id</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">create_graph_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> create_graph_impl_aux

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> create_graph_impl.refine<span class="main">[</span><span class="operator">OF</span> PREFER_id_D<span class="main">]</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> create_graph_code_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"RETURN <span class="var">?c</span> <span class="main">≤</span> create_graph_impl <span class="free">φ</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> create_graph_impl_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">refine_transfer</span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">create_graph_code</span> <span class="keyword2"><span class="keyword">uses</span></span> create_graph_code_aux
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span> <span class="main">=</span> create_graph_code.refine


<span class="keyword1"><span class="command">schematic_goal</span></span> create_name_gba_impl_aux<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span> <span class="main">(</span>create_name_gba_aimpl<span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>linorder ltlr <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">(</span><span class="var">?R</span><span class="main">::</span><span class="main">(</span><span class="tvar">?'c</span><span class="main">×</span><span class="main">_</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> create_name_gba_aimpl_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">autoref_trace_failed_id</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">,</span></span> <span class="quasi_keyword">trace</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">create_name_gba_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> create_name_gba_impl_aux

<span class="keyword1"><span class="command">lemma</span></span> create_name_gba_autoref<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"PREFER_id <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>create_name_gba_impl<span class="main">,</span> create_name_gba<span class="main">)</span>
  <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span>gbav_impl_rel_ext unit_rel nat_rel <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>fun_set_rel<span class="main">)</span><span class="main">⟩</span>nres_rel"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">:</span><span class="main">_</span><span class="main">→</span><span class="main">⟨</span><span class="var">?R</span><span class="main">⟩</span>nres_rel"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI nres_relI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="skolem">φ'</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">φ</span><span class="main">,</span><span class="skolem">φ'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> RID<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">=</span>Id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
  <span class="keyword1"><span class="command">note</span></span> create_name_gba_impl.refine<span class="main">[</span><span class="operator">THEN</span> fun_relD<span class="main">,</span><span class="operator">THEN</span> nres_relD<span class="main">,</span> <span class="operator">OF</span> A<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> RID<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> create_name_gba_aimpl_refine
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"create_name_gba_impl <span class="skolem">φ</span> <span class="main">≤</span> <span class="main">⇓</span> <span class="var">?R</span> <span class="main">(</span>create_name_gba <span class="skolem">φ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1"><span class="command">schematic_goal</span></span> create_name_gba_code_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"RETURN <span class="var">?c</span> <span class="main">≤</span> create_name_gba_impl <span class="free">φ</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> create_name_gba_impl_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_transfer</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">post</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">create_name_gba_code</span> <span class="keyword2"><span class="keyword">uses</span></span> create_name_gba_code_aux
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span> <span class="main">=</span> create_name_gba_code.refine

<span class="keyword1"><span class="command">schematic_goal</span></span> create_name_igba_impl_aux<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> RID<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">=</span>Id"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span>create_name_igba<span class="main">)</span><span class="main">∈</span>
  <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ltlr_rel <span class="main">→</span> <span class="main">⟨</span>igbav_impl_rel_ext unit_rel nat_rel <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>fun_set_rel<span class="main">)</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RID
  <span class="keyword1"><span class="command">unfolding</span></span> create_name_igba_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">autoref_trace_failed_id</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">trace</span><span class="main"><span class="main">,</span></span> <span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">create_name_igba_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> create_name_igba_impl_aux
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> create_name_igba_impl.refine<span class="main">[</span><span class="operator">OF</span> PREFER_id_D<span class="main">]</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> create_name_igba_code_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"RETURN <span class="var">?c</span> <span class="main">≤</span> create_name_igba_impl <span class="free">φ</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> create_name_igba_impl_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_transfer</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">post</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">create_name_igba_code</span> <span class="keyword2"><span class="keyword">uses</span></span> create_name_igba_code_aux
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span> <span class="main">=</span> create_name_igba_code.refine

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">create_name_igba_code</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="All_Of_LTL_to_GBA">
<div class="head">
<h1>Theory All_Of_LTL_to_GBA</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> All_Of_LTL_to_GBA
<span class="keyword2"><span class="keyword">imports</span></span> <a href="LTL_to_GBA.html">LTL_to_GBA</a> <a href="LTL_to_GBA_impl.html">LTL_to_GBA_impl</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div>